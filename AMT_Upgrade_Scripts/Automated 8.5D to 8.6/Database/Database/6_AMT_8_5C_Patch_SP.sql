/******************************************************************************
	File: 	6_AMT_8_5C_Patch_SP.sql

	Description:	Creates the Stored Procedures in the database

**************************************************************************************************************
	Change History
**************************************************************************************************************
Date:		Author:		Description:
--------	--------	----------------------------------------
14 May 12   GD          Mod KIRD_PRICE_UPDATE_P
14 May 12	VV			Mod PROJECTED_TASK_IMPORT_P
11 May 12	KN			Add 4174 TASK_PARTS_READY_STATUS_UPDATE_P
11 May 12   GD			Add E787 PARTS_BY_GROUP_CURRENCY_GET_P,
						Mod USAGE_PROFILE_UOM_IMPORT_P
						Mod E786 ACTUAL_BILLING_IMPORT_P
10 May 12	V Vasylyeva	PROJECTED_TASK_IMPORT_P
10 May 12	V Vasylyeva MB_CHECK_IN_P
09 May 12	V Vasylyeva	WORK_ORDER_UPDATE_INTERNAL_P
						WORK_ORDER_ADD_INTERNAL_P
						usp_Update_WO_Settlement
						usp_Add_WO_Settlement
09 May 12	KN			Mod TASK_OPERATION_DELETE_P
09 May 12	KN			Mod BUDGET_EQUIPMENT_RECALCULATE_P
08 May 12	VV			Mod ACTUAL_USAGE_REVALIDATE_P
08 May 12   SD          Add E810 TASK_AUTOCREATE_EXTERNAL_WORKORDERS_GET_P
08 May 12   JW			Mod 4114 RPT_PARTS_DEMAND_ANALYSIS_P
07 May 12	KN			Mod 3919: STD_JOB_COPY_TO_PROJ_TASK_P
07 May 12   JW			Mod DOWNTIME_IMPORT_P HOLDING_EVENT_UPDATE_NEW_P EVENT_UPDATE_FROM_HOLDING_EVENTS_P HOLDING_EVENT_GET_P
							MODULAR_MINING_EVENT_ADD_TO_EXISTING_EVENT_P MODULAR_MINING_EVENT_ADD_TO_NEW_EVENT_P
07 May 12   TW			Mod [EXPRESS_ADD_BACKLOGS_TO_EVENT_P]; [STRATEGY_TASK_ADD_TO_EVENT_P];[TASK_DEFAULT_ADD_P]
07 May 12	VV			Mod IMPORT_PROJECTION_P
						    PROJECTED_TASK_IMPORT_P
07 May 12	SD			Mod E808 - PROJ_TASK_ADD_P, usp_Update_Task, PROJ_TASK_SUMMARY_GET_P - Add fields AutocreateExternalWorkorders & AutocreatePlannedEvents
07 May 12	SD			Mod E811 - Add fields AutocreateExternalWorkorders & AutocreatePlannedEvents
07 May 12	VV			Mod RPT_FORECAST_ROTABLES_STOCK_P
04 May 12	VV			Mod PRICE_GROUP_ADD_P
04 May 12	VV			Mod PROJ_TASK_AMT_FILTERED_UPDATE_P
05 May 12   SD          E773 Rollback - Re-Add SP's Added for E773 with changes removed
03 May 12   GD          Mod E796 EXPORT_WORKORDER_STATUS_P
03 May 12	VV			Add AUTOCREATE_PLANNED_EVENTS_P
03 May 12	KN			Mod E774 EQS_WORKGROUP_GET_P
03 May 12   GD          Mod 4102 RPT_PROJECTION_SUMMARY_AND_COST_PER_INTERVAL_P
01 May 12	KN			Mod E809 RPT_DAILY_DOWNTIME_LOG_P
01 May 12   JW			Mod 4001 - EVENT_ADD_P
03 APR 12   SD			Mod E773 - Remove MaxPlanning WO check from TASK_CHECK_STRATEGY_DETAILS_P,EVENT_TASKS_DELETE_P, STRATEGY_TASK_ADD_TO_EVENT_P
1  May 12	RJ			Mod 4094 - USAGE_PROFILE_UOM_IMPORT_P	
30 Apr 12   SD			Mod 4059 - RPT_MTBS_MTBF_MTBUPS_P, RPT_MTBS_MTBF_MTBUPS_Line_P Reports Taking too long : missing where criteria in temp table fill so re-code temp table 3 as a subquery
30 Apr 12   JW			Add RPT_REBUILD_CENTRE_FORECAST_WORKLOAD_P
29 Apr 12	KN			Mod: E795 IC_EXTRACT_FACT_WORKORDER_P
27 Apr 12	VV			RPT_FORECAST_ROTABLES_STOCK_P
27 Apr 12	VV			Mod PROJECTED_TASK_IMPORT_P
27 Apr 12	VV			Mod IMPORT_PROJECTION_P
26 Apr 12	VV			Mod PROJECTED_TASK_IMPORT_P
26 Apr 12   GD          Mod #4057 REP_DAILY_PERF_CHECK_SHEET_P
24 Apr 12   GD          Mod E792 RPT_PARTS_DEMAND_ANALYSIS_P,4056 RPT_DAILY_DOWNTIME_LOG_P
23 Apr 12	VV			Add RPT_FORECAST_ROTABLES_STOCK_P
23 Apr 12   SD			Mod 4034 - AMT_DICTIONARY_UPDATE_P - removed code to replace underscores with Space
23 Apr 12   GD          Mod REP_DAILY_PERF_CHECK_SHEET_P
19 Apr 12	VV			Mod INVENTORY_PART_UPDATE_P
19 Apr 12   GD          E785 OVERHEAD_ACTUAL_COST_IMPORT_P
19-Apr-12   SD			E801 - Add Summary Costs With Period
18 Apr 12	KN			3296 usp_Add_WorkOrderExternal,usp_Update_AMTWorkOrderExternal
18 Apr 12	KN			4010 BUDGET_OCC_AND_COST_POPULATE_P
18 Apr 12   GD          E785 OVERHEAD_ACTUAL_BILLING_IMPORT_P
18 Apr 12   SD			E797 & E798 TASK.RebuildPartTypeId now FK to PART_CLASSIFICATION
						COMPONENT_CHANGEOUT_GRID_GET_P, TASK_GET_P, TASK_DEFAULT_ADD_GET_P
18 Apr 12	KN			Mod RPT_TOTAL_COST_ANALYSIS_P
17 Apr 12	VV			Mod WORK_ORDER_MERGE_P
17 Apr 12   SD          Mod E789 SITE_DELETE_P
16 Apr 12	SD			Mod E789 - usp_Update_Task, PROJ_TASK_SUMMARY_GET_P 
16 Apr 12   GD          Mod E782 & E783 RPT_CHANGEOUT_ANALYSIS_P
16 Apr 12   TW			Mod	3738 KIRD_EXPORT_P
13 Apr 12	KN			Mod 3974 RPT_BUDGET_COST_WORKSHEET_P
13 APR 12   SD			E778 - Add new PEX fields - 
									PARTS_MANAGER_GET_P, PARTS_MANAGER_PUT_P, 
						E781 - Add new PEX fields 
						 			PROJECTION_TASK_COPY_MULTIEQP_P,usp_Copy_Proj_Task
						 			MULTI_TASK_EDITOR_TASK_FIELDS_GET_P, PROJ_TASK_MULTI_UPDATE_P, MULTI_TASK_EDITOR_GET


14 Apr 12   GD       Mod E780 RPT_WORK_SCHEDULE_P
12 Apr 12   GD          Add E777 PART_CLASSIFICATION_DELETE_P,
								 PART_CLASSIFICATION_GET_ALL_P,
								 PART_CLASSIFICATION_UPDATE_P,
								 PART_CLASSIFICATION_ADD_P
10 Apr 12   TW			Mod #3908     RPT_DAILY_DOWNTIME_LOG_P
05 Apr 12   TW			Mod #3950 [RPT_PLANNED_BREAKDOWN_HOUR_P] 
11 Apr 12	VV			Mod INVENTORY_PART_UPDATE_P
						    INVENTORY_PART_GET_P
						    PARTS_FILTERED_GET_P
05 Apr 12	VV			Mod RPT_EQUIPMENT_OPERATIONAL_PERFORMANCE_SUMMARY
05 Apr 12   GD          Mod 3912 RPT_EQUIPMENT_KPI_P
05 Apr 12	KN			Mod 3932 BUDGET_EQUIPMENT_RECALCULATE_P
04 Apr 12	KN			Mod 3935 RPT_BUDGET_COST_WORKSHEET_P
05 Apr 12	JW			Mod 3870 RPT_EVENT_ANALYSIS_P
04 Apr 12   GD          Mod 3913 REP_DAILY_PERF_CHECK_SHEET_P
03 Apr 12	KN			Mod	3922,3926 STD_JOB_COPY_TO_PROJ_TASK_P
**END OF HISTORY************************************************************************************************************/
SET QUOTED_IDENTIFIER ON	--should be always ON
GO
SET ANSI_NULLS ON			--should be always ON
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[TASK_PARTS_READY_STATUS_UPDATE_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[TASK_PARTS_READY_STATUS_UPDATE_P]
GO

CREATE Procedure [dbo].[TASK_PARTS_READY_STATUS_UPDATE_P]
/******************************************************************************
	Name: TASK_PARTS_READY_STATUS_UPDATE_P

	Called By: 

	Desc: 

	Auth: Alex Lassauniere
	Date: 06/04/10
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	11 May 2012	KN			4174: Purchase Order query didnt support multiple task_id
	07/04/10	AL			CR8869: change of specs for the auto mode
	
*******************************************************************************/
	/* Param List */
	@TaskID varchar(MAX)=''
    
AS

--1: check in what job ready status we are:
DECLARE @AutoLookupPartsReadyStatus bit, @OpEditionPlanStatus INT

EXEC AMT_TYPED_VARIABLE_GET_P @Value_Name='AutoLookupPartsReadyStatus',  @Varchar_Value=@AutoLookupPartsReadyStatus OUTPUT

--SELECT @AutoLookupPartsReadyStatus,@OpEditionPlanStatus

IF ISNULL(@AutoLookupPartsReadyStatus,0)<>0
BEGIN
	--Auto: we will need to update Header flags
	EXEC AMT_TYPED_VARIABLE_GET_P @Value_Name='OpEditionPlanStatus',  @Varchar_Value=@OpEditionPlanStatus OUTPUT
	
	CREATE TABLE #JRTASK(TaskID Int Primary key, MinPartStatus Int)
	
	IF ISNULL(@OpEditionPlanStatus,1)=1
	BEGIN
		--Use of Purchase Order date
		INSERT INTO #JRTASK(TaskID, MinPartStatus)
		SELECT TOO.Task_ID,A.MinPartStatus
		FROM
			TASK_OPERATION TOO LEFT OUTER JOIN
			(SELECT TOO.Task_ID,MIN(CASE WHEN PO.Delivery_Date IS NOT NULL AND PO.Delivery_Date<GETDATE() THEN 3
						WHEN ISNULL(Purchase_Order_Number,'')<>'' THEN 2
						ELSE 1 END) AS MinPartStatus
			FROM
				TASK_OPERATION TOO LEFT OUTER JOIN
				TASK_OPERATION_PART TOOP ON TOO.Task_Operation_Id=TOOP.Task_Operation_Id LEFT OUTER JOIN
				(SELECT Purchase_Order_Number,Supplier_Id,Delivery_Date,POCounter,Task_Id FROM PURCHASE_ORDER
				WHERE Task_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@TaskID)) ) PO ON PO.Task_Id = TOO.Task_id AND TOOP.Supplier_Id=PO.Supplier_Id AND ISNULL(TOOP.POCounter,0)=ISNULL(PO.POCounter,0)
			WHERE 
				TOO.Task_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@TaskID))
				AND (TOOP.Actual_Qty>0 OR TOOP.Planned_Qty>0)	--AL: 07/04/10
			GROUP BY TOO.Task_ID)A ON TOO.Task_Id=A.Task_Id
		WHERE 
			TOO.Task_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@TaskID))
		GROUP BY TOO.Task_ID,A.MinPartStatus
	END
	ELSE
	BEGIN
		--Use of PartAvailabilityStatusId
		INSERT INTO #JRTASK(TaskID, MinPartStatus)
		SELECT TOO.Task_ID,A.MinPartStatus
		FROM
			TASK_OPERATION TOO LEFT OUTER JOIN
			(SELECT TOO.Task_ID,MIN(TOOP.PartAvailabilityStatusId) AS MinPartStatus
			FROM
				TASK_OPERATION TOO LEFT OUTER JOIN
				TASK_OPERATION_PART TOOP ON TOO.Task_Operation_Id=TOOP.Task_Operation_Id
			WHERE 
				TOO.Task_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@TaskID))
				AND (TOOP.Actual_Qty>0 OR TOOP.Planned_Qty>0)	--AL: 07/04/10
			GROUP BY TOO.Task_ID)A ON TOO.Task_Id=A.Task_Id
		WHERE 
			TOO.Task_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@TaskID))
		GROUP BY TOO.Task_ID,A.MinPartStatus
		
	END
	--SELECT * FROM #JRTASK
		
	--2: Update header flags
	UPDATE T
	SET PartsStatusRequired=CASE WHEN ISNULL(MinPartStatus,0)>0 THEN 1 ELSE 0 END, 
		PartsStatusOrdered=CASE WHEN ISNULL(MinPartStatus,0)>1 THEN 1 ELSE 0 END, 
		PartsStatusReady=CASE WHEN ISNULL(MinPartStatus,0)>2 THEN 1 ELSE 0 END
	FROM 
		TASK T INNER JOIN
		#JRTASK JR ON T.Task_ID=JR.TaskID
		
	DROP TABLE #JRTASK
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[MB_CHECK_IN_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[MB_CHECK_IN_P]

GO

create	Procedure [dbo].[MB_CHECK_IN_P]
/******************************************************************************
	
	Called By: Amt Mobile


	Auth: Veronika Vasylyeva
	Date: 14 Dec 10
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:			Description:
	--------	--------		----------------------------------------
	10 May 12	V Vasylyeva		#4161 handle events for equipment not marked as record
								downtime in mobile
	26 Mar 12	V Vasylyeva		#3838 Can't add a new workorder
	18 Mar 11	V Vasylyeva		#1427 Backlog age
	06 May 11	V Vasylyeva		#1516 changed lenth FileName in ATTACHED_DOCUMENT_TASK 
	 3 Jun 11	V Vasylyeva		#1867 changed order of event update anf workorder update
	24 Jun 11	V Vasylyeva		#2001 Do not update event if MobileDowntime=1 but event
								details are not supplyed 
	21 Jul 11	V Vasylyeva		E602 Serialised Component
	 3 Aug 11	V Vasylyeva		#2177 - encoding problem
	24 Oct 11	V Vasylyeva		#2694 Error in check in
	 9 Dec 11	V Vasylyeva		#3094 Breakdown does not update
*******************************************************************************/
	/* Param List */
@UserId int=0,
@MessageWO varchar(2000)='' OUTPUT,
@UniqueKeyWO varchar(50)='' OUTPUT,
@MessageE varchar(2000)='' OUTPUT,
@UniqueKeyE varchar(50)='' OUTPUT,
@CheckInXM nvarchar(max)=null/*VV 2177*/

AS


DECLARE @hDoc int
DECLARE @CurrentDate datetime
DECLARE @TS_O int
DECLARE @TS_YTS int
DECLARE @TS_IP int
DECLARE @TS_C int
DECLARE @TS_A int
DECLARE @TS_D int
DECLARE @AmtPlanningModeAdv int

DECLARE @MobileDowntime bit,@AMTPlanningModeId int

/*VV 2177*/
declare @CheckInXML xml
set @CheckInXML=CONVERT(XML, @CheckInXM)

--Workorder variables passed from Mobile
DECLARE @TaskId int,@EqpPlanId int,@PrimaryCause bit,@EventId int,@TaskStatusId int,
@WorkorderNumber varchar(50),@Description varchar(500),@ComponentCodeId int,@ModifierId int,
@TaskTypeId int,@ApplicationCodeId int,@PlannedDownTime datetime,@ExpectedDuration float,
@ActualDownTime datetime,@BreakDown bit,@SymptomId int,
@SymptomNotes varchar(8000),@CauseId int,@CauseNotes varchar(8000),@RepairCodeId int,
@RepairNotes varchar(8000),@SIMSCodeId int,@OccurrenceTypeId int,@EmployeeId int,
@WorkGroupId int,@Work_Location varchar(100),@ActualEmployeeId int,@ActualWorkGroupId int,
@CompletedById int,@PartNo varchar(50),@PartDescription varchar(50),@GroupNo varchar(50),
@GroupDescription varchar(50),@FailedGroupListPosition varchar(100),
@FailedGroupPartsListGroup varchar(100),@LastModDate datetime,@PriorityId int,@RaisedById int,
@PartsReturned bit,@TaskModeId int,@OpReplaced bit,@ActualDuration float,
@FailedPartListPosition	varchar(100),@FailedPartListGroup varchar(100),@EventUniqueKey varchar(50),
@Inspection bit

--Event variables passed from Mobile
DECLARE @EventStatusId int,@Planned bit,@BreakDownE bit,@EventPreventionId int,
@PlannedDownTime_E datetime,@PlannedUpTime_E datetime,@ActualDownTime_E datetime,
@ActualUpTime_E datetime,@DescriptionE varchar(500)

/*Event variables */
declare @Event_Id int, @Priority_ID int, @Work_Location_ID int, 
@Expected_Up_Time datetime, @Confirmed bit, @NotesE varchar(2500), @TestTime float,@ReleasedByID int,
@QUOM_ID int,@Planned_Down_Time datetime,@Planned_Up_Time datetime,@Repair_Details varchar(100),
@Event_Status_ID int,@xmlEvent varchar(max)

--Workorder variables which need to be passed from workorders because these values are not updated from Mobile
DECLARE @Source_ID int,@Task_Status_ID int,@Date_Notified datetime,@Component_ID varchar(100),
@EMI_Ref varchar(50),@EMIssueId int,@Redo bit,@Task_Planned_Time_ID int,@Customer_Ref varchar(100), 
@Expected_Labor_Hours float,@Planning_Notes varchar(8000),@Actual_Labor_Hrs float,@Notes varchar(1000),
@PartsStatusRequired bit,@PartsStatusOrdered bit,@PartsStatusReady bit,@Work_Order_ID int,
@Strategy_Proj_Task_Opt_ID int,@Sort_Order int,@WO_Create_Date datetime,@Performed_By_Date datetime,
@Parts_Available_Date datetime,@Parts_Order_Details VARCHAR(1000),@WO_Counter int,
@Work_Order_Number_External varchar(50),@Cost_Bearer_ID int,@Task_Warranty bit,@Redo_Work_Order_ID int,
@ViewWarranty bit,@HealthSafetyId int,@PlannedOffset float,@SiteId int,@CostCentreId int,
@BranchId int,@CustomerId int,@PartEntryDistributionCodeId int,@DefWorkGroupId int,
@PartsCostExpenseId int,@LabourCostExpenseId int,@MiscCostExpenseId int,@SpecificOperationCodes bit,
@WorkOrderDate datetime,@WarrantyClaimable bit,@ReviewedEmployeeId int,@WarrantyNotes varchar(500),
@WarrantyDays float,@WarrantyUsage float,@WarrantyDaysArchived float,@WarrantyUsageAcrhived float,
@WarrantySupplierId int,@ClaimRef varchar(20),@SupplierRef varchar(20),@SummaryDescription varchar(200),
@ClaimStatusId int,@ClaimedByEmployeeId int,@ClaimeDate datetime,@ClaimDescription varchar(1000),
@JobPartsCost float,@JobLabourCost float,@JobMiscCost float,@ClaimedPartsCost float,
@ClaimedLabourCost float,@ClaimedMiscCost float,@RecPartsCost float,@RecLabourCost float,
@RecMiscCost float,@LabourEntryDistributionCodeId int,@MiscEntryDistributionCodeId int,
@SupplierContact varchar(100),@TaskAuthorised bit,@ActualOffset float,@ChangeoutCategoryId int,
@LifeConfirmed bit ,@OriginalPartTypeId int ,/*VV E602*/@SerialNoIn int,@SerialNoOut int,
@IsOverwriteLife bit ,@OverwriteLifeAchieved float,@ConditionMonitoringIntervention bit,	
@FailedPartLifeAchieved	FLOAT,@PartSerialNoRemoved	VARCHAR(MAX),@PartSerialNoInstalled	VARCHAR(MAX),
@LastNotified datetime,@ResourceStatusReady bit,@AuthorisationRequestByID int,@WOClosed bit,
@Work_Order varchar(50),@Task_Id int,@Event_Id_WO int

DECLARE @opAdded varchar(max),@opModified varchar(max),@MeasurementTBL varchar(max)

DECLARE @VarianceCauseId int,@ResponsibilityID int

SET @CurrentDate=GETDATE();
SET @TS_YTS=6
SET @TS_IP=2
SET @TS_C=3
SET @TS_A=5
SET @TS_O=1
SET @TS_D=4

SET @AmtPlanningModeAdv=1


CREATE TABLE #z_DownTimeAllocation_MB(DownTimeAllocationId int,EventId int,PrimaryDTA bit,
TaskTypeId int,ResponsibilityId int,VarianceCauseId int,PlannedHours float,ActualHours float,
DownTimeAllocationIdAmt int DEFAULT 0,UniqueKey varchar(50) COLLATE DATABASE_DEFAULT,
Notes varchar(500) COLLATE DATABASE_DEFAULT
PRIMARY KEY(DownTimeAllocationId))

CREATE TABLE #z_Workorder_MB(
	TaskId int,
	EqpPlanId int,
	AMTPlanningModeId int,
	PrimaryCause bit,
	EventId int,
	TaskStatusId int,
	WorkorderNumber varchar(50) COLLATE DATABASE_DEFAULT,
	[Description] varchar(500) COLLATE DATABASE_DEFAULT,
	ComponentCodeId int,
	ModifierId int,
	TaskTypeId int,
	ApplicationCodeId int,
	PlannedDownTime datetime,
	ExpectedDuration float,
	ActualDownTime datetime,
	ActualDuration float,
	BreakDown bit,
	SymptomId int,
	SymptomNotes varchar(8000) COLLATE DATABASE_DEFAULT,
	CauseId int,
	CauseNotes varchar(8000) COLLATE DATABASE_DEFAULT,
	RepairCodeId int,
	RepairNotes varchar(8000) COLLATE DATABASE_DEFAULT,
	SIMSCodeId int,
	OccurrenceTypeId int,
	EmployeeId int,
	WorkGroupId int,
	Work_Location varchar(100) COLLATE DATABASE_DEFAULT,
	ActualEmployeeId int,
	ActualWorkGroupId int,
	CompletedById int,
	PartNo varchar(50) COLLATE DATABASE_DEFAULT,
	PartDescription varchar(50) COLLATE DATABASE_DEFAULT,
	GroupNo varchar(50) COLLATE DATABASE_DEFAULT,
	GroupDescription varchar(50) COLLATE DATABASE_DEFAULT,
	FailedGroupListPosition varchar(100) COLLATE DATABASE_DEFAULT,
	FailedGroupPartsListGroup varchar(100) COLLATE DATABASE_DEFAULT,
	LastModDate  datetime,
	PriorityId int,
	RaisedById int,
	PartsReturned bit,
	TaskModeId int,
	UniqueKey varchar(50) COLLATE DATABASE_DEFAULT,
	OpReplaced bit,
	FailedPartListPosition varchar(1000) COLLATE DATABASE_DEFAULT,
	FailedPartListGroup varchar(1000) COLLATE DATABASE_DEFAULT,
	EventUniqueKey varchar(50) COLLATE DATABASE_DEFAULT,
	Inspection bit
	PRIMARY KEY(TaskId))
	
CREATE TABLE #z_WOLabour_MB(
	TaskOperationId int,
	TaskOperationLabourId int,
	LabourActivityId int,
	LabourActivityWO varchar(50) COLLATE DATABASE_DEFAULT,
	WorkGroupId int,
	PlannedLabourHrs float,
	EmployeeId int,
	ActualLabourHrs float,
	JSARead bit,
	JSAReadId int,
	TaskOperationLabourIdAmt int DEFAULT 0,
	UniqueKey varchar(50) COLLATE DATABASE_DEFAULT
	PRIMARY KEY (TaskOperationLabourId)
) 

CREATE TABLE #z_Event_MB(
	EventId int,
	EqpPlanId int,
	EventStatusId int,
	Planned bit,
	BreakDown bit,
	EventPreventionId int,
	UniqueKey varchar(50) COLLATE DATABASE_DEFAULT,
	PlannedDownTime datetime,
	PlannedUpTime datetime,
	ActualDownTime datetime,
	ActualUpTime datetime
	/*Description varchar(500) COLLATE DATABASE_DEFAULT*/
	PRIMARY KEY(EventId)
) 


CREATE TABLE #z_AttachedDocumentsEWWorkstep_MB(
	EWWorkstepId int,
	FileName varchar(800) COLLATE DATABASE_DEFAULT/*VV #1516*/
	)
	
CREATE TABLE #z_WOAttachedDocument_MB(
	TaskId int,
	FileName varchar(800) COLLATE DATABASE_DEFAULT/*VV #1516*/
) 

CREATE TABLE #z_WOElectronicWorkscope_MB(
	EWWorkorderId int,
	TaskOperationId int,
	EWTitle varchar(200) COLLATE DATABASE_DEFAULT,
	UniqueKey varchar(50) COLLATE DATABASE_DEFAULT,
	EWWorkorderIdAmt int DEFAULT 0
	PRIMARY KEY(EWWorkorderId)
) 

CREATE TABLE #z_WOMisc_MB(
	TaskOperationId int,
	TaskOperationMiscId int,
	MiscCategoryId int,
	TaskOperationMiscDesc varchar(200) COLLATE DATABASE_DEFAULT
	PRIMARY KEY(TaskOperationMiscId)
) 

CREATE TABLE #z_WOOperation_MB(
	TaskId int,
	TaskOperationId int,
	SortOrder int,
	TaskOperation varchar(200) COLLATE DATABASE_DEFAULT,
	ComponentCodeId int,
	ModifierCodeId int,
	JobCodeId int,
	OperationInstructions varchar(8000) COLLATE DATABASE_DEFAULT,
	OperationOffset float,
	PlannedDuration float,	
	Completed bit,
	PartsReturned bit,
	WorkGroupId int,
	TaskOperationIdAmt int DEFAULT 0,
	UniqueKey varchar(50) COLLATE DATABASE_DEFAULT
	PRIMARY KEY(TaskOperationId)
) 

CREATE TABLE #z_WOPart_MB(
	TaskOperationId int,
	TaskOperationPartId int,
	PartNumber varchar(50) COLLATE DATABASE_DEFAULT,
	PartDescription varchar(50) COLLATE DATABASE_DEFAULT,
	PlannedQty float
	PRIMARY KEY(TaskOperationPartId)
) 

CREATE TABLE #z_WOWorkstep_MB(
	EWWorkstepId int,
	EWWorkorderId int,
	EWStepTemplateId int,
	Sequence int,
	EWWorkstepTitle varchar(200) COLLATE DATABASE_DEFAULT,
	ComponentCodeId int,
	CMCodeId int,
	Instructions varchar(100) COLLATE DATABASE_DEFAULT,
	DocumentGUID varchar(50) COLLATE DATABASE_DEFAULT,
	DocumentExt varchar(50) COLLATE DATABASE_DEFAULT,
	Safety bit,
	Environmental bit,
	/*Reading float,*/
	Reading varchar(50) COLLATE DATABASE_DEFAULT,
	CMRatingId int,
	ResultId int,
	PerformedById int,
	Comments varchar(1000) COLLATE DATABASE_DEFAULT,
	CreateDefectWO bit,
	DefectRepairInstructions varchar(1000) COLLATE DATABASE_DEFAULT,
	Actioned bit,
	ActionedComments varchar(1000) COLLATE DATABASE_DEFAULT,
	ReviewdById int,
	UniqueKey varchar(50) COLLATE DATABASE_DEFAULT,
	EWWorkstepIdAmt int DEFAULT 0
	PRIMARY KEY(EWWorkstepId)
) 

CREATE TABLE #z_MEASUREMENT_MB(ListId int IDENTITY(1,1),CMCodeId int,CMMeasurementId int,  
     NewMeasurementTime datetime,NewReading float,CMRatingID int,  
     NewExtComments varchar(5000) COLLATE database_default PRIMARY KEY(ListId))   

EXEC sp_xml_preparedocument @hDoc OUTPUT, @CheckInXML 


SELECT @TaskId=TaskId, @EqpPlanId=EqpPlanId, 
@PrimaryCause=PrimaryCause, @EventId=NULLIF(EventId,0), @TaskStatusId=TaskStatusId, 
@WorkorderNumber=NULLIF(WorkorderNumber,''), @Description=Description, 
@ComponentCodeId=ComponentCodeId, 
@ModifierId=ModifierId, @TaskTypeId=TaskTypeId, @ApplicationCodeId=ApplicationCodeId, 
@PlannedDownTime=PlannedDownTime, 
@ExpectedDuration=ISNULL(ExpectedDuration,0),
@ActualDownTime=ActualDownTime, 
@BreakDown=BreakDown, @SymptomId=SymptomId, 
@SymptomNotes=NULLIF(SymptomNotes,''), 
@CauseId=CauseId, @CauseNotes=NULLIF(CauseNotes,''), @RepairCodeId=RepairCodeId, 
@RepairNotes=NULLIF(RepairNotes,''), 
@SIMSCodeId=NULLIF(SIMSCodeId,0),@OccurrenceTypeId= OccurrenceTypeId,@EmployeeId= NULLIF(EmployeeId,0),
@WorkGroupId= NULLIF(WorkGroupId,0),@Work_Location=NULLIF(Work_Location,''),
@ActualEmployeeId= NULLIF(ActualEmployeeId,0), 
@ActualWorkGroupId=NULLIF(ActualWorkGroupId,0),@CompletedById= NULLIF(CompletedById,0),
@PartNo= NULLIF(PartNo,''), 
@PartDescription=NULLIF(PartDescription,''), @GroupNo=NULLIF(GroupNo,''),
@GroupDescription= NULLIF(GroupDescription,''), 
@FailedGroupListPosition=NULLIF(FailedGroupListPosition,''),
@FailedGroupPartsListGroup= NULLIF(FailedGroupPartsListGroup,''), 
@LastModDate=LastModDate,@PriorityId= PriorityId,@RaisedById= NULLIF(RaisedById,0),
@PartsReturned= PartsReturned,
@TaskModeId= TaskModeId,@UniqueKeyWO= UniqueKey,@OpReplaced=OpReplaced,
@ActualDuration=ActualDuration,
@FailedPartListPosition=FailedPartListPosition,
@FailedPartListGroup=FailedPartListGroup,
@EventUniqueKey=ISNULL(EventUniqueKey,''),
@Inspection=ISNULL(Inspection,0)

FROM  OPENXML (@hDoc,'/CheckInData/Workorders/WorkorderBase',2) WITH #z_Workorder_MB


insert into #z_WOLabour_MB(TaskOperationId,TaskOperationLabourId,LabourActivityId,LabourActivityWO,
WorkGroupId,PlannedLabourHrs,EmployeeId,ActualLabourHrs,JSARead,JSAReadId,
UniqueKey)
SELECT TaskOperationId,TaskOperationLabourId,LabourActivityId,LabourActivityWO,
WorkGroupId,PlannedLabourHrs,EmployeeId,ActualLabourHrs,JSARead,JSAReadId,
ISNULL(NULLIF(UniqueKey,''),NEWID()) AS UniqueKey
FROM  OPENXML (@hDoc,'/CheckInData/WOLabours/WOLabourBase',2) WITH #z_WOLabour_MB

insert into #z_AttachedDocumentsEWWorkstep_MB(EWWorkstepId,[FileName])
SELECT EWWorkstepId,[FileName] 
FROM  OPENXML (@hDoc,'/CheckInData/AttachedDocumentsEWWorksteps/AttachedDocumentsEWWorkstep',2) WITH #z_AttachedDocumentsEWWorkstep_MB

SELECT @EventStatusId=EventStatusId,@Planned=Planned,/*VV #3094*/@BreakDownE=BreakDown,
@EventPreventionId=EventPreventionId,@UniqueKeyE=UniqueKey,@PlannedDownTime_E=PlannedDownTime,
@PlannedUpTime_E=PlannedUpTime,@ActualDownTime_E=ActualDownTime,@ActualUpTime_E=ActualUpTime
/*@DescriptionE=Description*/
FROM  OPENXML (@hDoc,'/CheckInData/Events/EventBase',2) WITH #z_Event_MB


insert into #z_WOAttachedDocument_MB(TaskId,[FileName])
SELECT TaskId,[FileName]
FROM  OPENXML (@hDoc,'/CheckInData/WOAttachedDocuments/WOAttachedDocument',2) WITH #z_WOAttachedDocument_MB

insert into #z_WOElectronicWorkscope_MB(EWWorkorderId,TaskOperationId,EWTitle,UniqueKey)
SELECT EWWorkorderId,TaskOperationId,EWTitle,ISNULL(NULLIF(UniqueKey,''),NEWID()) AS UniqueKey
FROM  OPENXML (@hDoc,'/CheckInData/WOElectronicWorkscopes/WOElectronicWorkscopeBase',2) WITH #z_WOElectronicWorkscope_MB

insert into #z_WOMisc_MB(TaskOperationId,TaskOperationMiscId,MiscCategoryId,TaskOperationMiscDesc)
SELECT TaskOperationId,TaskOperationMiscId,MiscCategoryId,TaskOperationMiscDesc
FROM  OPENXML (@hDoc,'/CheckInData/WOMiscs/WOMisc',2) WITH #z_WOMisc_MB

insert into #z_WOOperation_MB(TaskId,TaskOperationId,SortOrder,TaskOperation,ComponentCodeId,ModifierCodeId,
JobCodeId,OperationInstructions,OperationOffset,PlannedDuration,Completed,
PartsReturned,WorkGroupId,UniqueKey)
SELECT TaskId,TaskOperationId,SortOrder,TaskOperation,ComponentCodeId,ModifierCodeId,
JobCodeId,OperationInstructions,OperationOffset,PlannedDuration,Completed,
PartsReturned,WorkGroupId,ISNULL(NULLIF(UniqueKey,''),NEWID()) AS UniqueKey
FROM  OPENXML (@hDoc,'/CheckInData/WOOperations/WOOperationBase',2) WITH #z_WOOperation_MB

insert into #z_WOPart_MB(TaskOperationId,TaskOperationPartId,PartNumber,PartDescription,PlannedQty)
SELECT TaskOperationId,TaskOperationPartId,PartNumber,PartDescription,PlannedQty
FROM  OPENXML (@hDoc,'/CheckInData/WOParts/WOPart',2) WITH #z_WOPart_MB

insert into #z_WOWorkstep_MB(EWWorkstepId,EWWorkorderId,EWStepTemplateId,Sequence,EWWorkstepTitle,
ComponentCodeId,CMCodeId,Instructions,DocumentGUID,DocumentExt,Safety,Environmental,Reading,CMRatingId,
ResultId,PerformedById,Comments,CreateDefectWO,DefectRepairInstructions,Actioned,ActionedComments,
ReviewdById,UniqueKey)
SELECT EWWorkstepId,EWWorkorderId,EWStepTemplateId,Sequence,EWWorkstepTitle,
ComponentCodeId,CMCodeId,Instructions,DocumentGUID,DocumentExt,Safety,Environmental,Reading,CMRatingId,
ResultId,PerformedById,Comments,CreateDefectWO,DefectRepairInstructions,Actioned,ActionedComments,
ReviewdById,ISNULL(NULLIF(UniqueKey,''),NEWID()) AS UniqueKey
FROM  OPENXML (@hDoc,'/CheckInData/WOWorksteps/WOWorkstep',2) WITH #z_WOWorkstep_MB

insert into #z_DownTimeAllocation_MB(DownTimeAllocationId,EventId,PrimaryDTA,TaskTypeId,
ResponsibilityId,VarianceCauseId,PlannedHours,ActualHours,UniqueKey,Notes)
SELECT DownTimeAllocationId,EventId,PrimaryDTA,TaskTypeId,ResponsibilityId,VarianceCauseId,
PlannedHours,ActualHours,ISNULL(NULLIF(UniqueKey,''),NEWID()) AS UniqueKey,Notes
FROM OPENXML (@hDoc,'/CheckInData/DowntimeAllocations/DowntimeAllocation',2) WITH #z_DownTimeAllocation_MB

EXEC sp_xml_removedocument @hDoc



--Update ids. Mobile data is not updated from AMT. So Ids can be negative.
UPDATE M
SET TaskOperationIdAmt=O.Task_Operation_Id 
FROM
#z_WOOperation_MB M
	INNER JOIN
TASK_OPERATION O
	ON M.UniqueKey=O.UniqueKey


UPDATE M SET TaskOperationLabourIdAmt=L.Task_Operation_Labour_Id 
FROM
#z_WOLabour_MB M
	INNER JOIN
TASK_OPERATION_LABOUR L
	ON M.UniqueKey=L.UniqueKey
	
UPDATE M SET EWWorkstepIdAmt=S.EWWorkstepId
FROM
#z_WOWorkstep_MB M
	INNER JOIN
EW_WORKSTEP S
	ON M.UniqueKey=S.UniqueKey

UPDATE M SET EWWorkorderIdAmt=E.EWWorkorderId
FROM
#z_WOElectronicWorkscope_MB M
	INNER JOIN
EW_WORKORDER E
	ON M.UniqueKey=E.UniqueKey

SELECT @MobileDowntime =MobileDowntime,@AMTPlanningModeId=Advanced_Planning, @QUOM_ID=Primary_QUOM_ID 
FROM tblEqpPlans WHERE EqpPlanId=@EqpPlanId

--select values which are not passed from mobile for the workorders to update    
select @Task_Id=T.Task_Id,
@Source_ID=Source_ID, 
@Task_Status_ID=Task_Status_ID,
@Date_Notified=Date_Notified, 
@Component_ID=Component_ID, 
@EMI_Ref=EMI_Ref,
@EMIssueId=EM_Issue_Id, 
@Redo=Redo, 
@Task_Planned_Time_ID=Task_Planned_Time_ID, 
@Customer_Ref=Customer_Ref, 
@Expected_Labor_Hours=Expected_Labor_Hours, 
@Planning_Notes=Planning_Notes,
@Actual_Labor_Hrs=Actual_Labor_Hrs,                    
@Notes=Notes,
@PartsStatusRequired=PartsStatusRequired,
@PartsStatusOrdered=PartsStatusOrdered,
@PartsStatusReady=PartsStatusReady,
@Work_Order_ID=Work_Order_ID,
@Work_Order=Work_Order,
@Strategy_Proj_Task_Opt_ID=Strategy_Proj_Task_Opt_ID,
@Sort_Order=Sort_Order,
@WO_Create_Date=WO_Create_Date,
@Performed_By_Date=Performed_By_Date,
@Parts_Available_Date=Parts_Available_Date,
@Parts_Order_Details=Parts_Order_Details,
@WO_Counter=WO_Counter,
@Work_Order_Number_External=T.Work_Order_Number_External,
@Cost_Bearer_ID=Cost_Bearer_ID,
@Task_Warranty=Task_Warranty,
@Redo_Work_Order_ID=Redo_Work_Order_ID,
@ViewWarranty=View_Warranty,
@HealthSafetyId=Health_Safety_Id,
@PlannedOffset=Planned_Offset,
@SiteId=Site_Id,
@CostCentreId=Cost_Centre_Id,
@BranchId=Branch_Id,
@CustomerId=Customer_Id,
@PartEntryDistributionCodeId=Part_Entry_Distribution_Code_Id,
@DefWorkGroupId=Def_Work_Group_Id,
@PartsCostExpenseId=Parts_Cost_Expense_Id,
@LabourCostExpenseId=Labour_Cost_Expense_Id,
@MiscCostExpenseId=Misc_Cost_Expense_Id,
@SpecificOperationCodes=Specific_Operation_Codes,
@WorkOrderDate=Work_Order_Date,
@WarrantyClaimable=Warranty_Claimable,
@ReviewedEmployeeId=Reviewed_Employee_Id,
@WarrantyNotes=Warranty_Notes,
@WarrantyDays=Warranty_Days,
@WarrantyUsage=Warranty_Usage,
@WarrantyDaysArchived=Warranty_Days_Archived,
@WarrantyUsageAcrhived=Warranty_Usage_Acrhived,
@WarrantySupplierId=Warranty_Supplier_Id,
@ClaimRef=Claim_Ref,
@SupplierRef=Supplier_Ref,
@SummaryDescription=Summary_Description,
@ClaimStatusId=Claim_Status_Id,
@ClaimedByEmployeeId=Claimed_By_Employee_Id,
@ClaimeDate=Claime_Date,
@ClaimDescription=Claim_Description,
@JobPartsCost=Job_Parts_Cost,
@JobLabourCost=Job_Labour_Cost,
@JobMiscCost=Job_Misc_Cost,
@ClaimedPartsCost=Claimed_Parts_Cost,
@ClaimedLabourCost=Claimed_Labour_Cost,
@ClaimedMiscCost=Claimed_Misc_Cost,
@RecPartsCost=Rec_Parts_Cost,
@RecLabourCost=Rec_Labour_Cost,
@RecMiscCost=Rec_Misc_Cost,
@LabourEntryDistributionCodeId=Labour_Entry_Distribution_Code_Id,
@MiscEntryDistributionCodeId=Misc_Entry_Distribution_Code_Id,
@SupplierContact=Supplier_Contact,
@TaskAuthorised=Task_Authorised,
@ActualOffset=ActualOffset,
@ChangeoutCategoryId=ChangeoutCategoryId,
@LifeConfirmed=LifeConfirmed,
@OriginalPartTypeId=OriginalPartTypeId,
@SerialNoIn=SerialNoInId,
@SerialNoOut=SerialNoOutId,
@IsOverwriteLife=IsOverwriteLife,
@OverwriteLifeAchieved=OverwriteLifeAchieved,
@ConditionMonitoringIntervention=ConditionMonitoringIntervention,
@FailedPartLifeAchieved=FailedPartLifeAchieved,
@LastNotified=LastNotified,
@ResourceStatusReady=ResourceStatusReady,
@AuthorisationRequestByID=AuthorisationRequestByID,
@WOClosed=CONVERT(BIT,CASE WHEN WOT.AMTStatusId=2 THEN 1 ELSE 0 END),
@PlannedDownTime=Planned_Down_Time, 
@ExpectedDuration=Expected_Duration,
@EmployeeId=Employee_ID,
@WorkGroupId=Work_Group_Id,
@Event_Id_WO=Event_ID
FROM
TASK T 
	LEFT OUTER JOIN  
tblWorkOrders WOT  
	ON T.Work_Order_ID=WOT.WorkOrderId  
WHERE T.UniqueKey=@UniqueKeyWO

IF @Task_Id>0 SET @TaskId=@Task_Id

/*If event details are supplied then @UniqueKeyE is not null*/
/*Unique key shall be the same as @EventUniqueKey in workorder*/
IF ISNULL(@UniqueKeyE,'')<>'' AND @MobileDowntime=1
BEGIN
	SELECT @Event_Id =Event_Id,@Priority_ID=Priority_ID, 
	@Work_Location_ID=Work_Location_ID, @Expected_Up_Time=Expected_Up_Time, 
	@NotesE=Notes, @TestTime=Test_Time,@ReleasedByID=Released_By_ID,@Planned_Down_Time=Planned_Down_Time,
	@Planned_Up_Time=Planned_Up_Time,@Repair_Details=Repair_Details,@Event_Status_ID=Event_Status_ID,
	@DescriptionE=Description
	FROM EVENT WHERE UniqueKey=@UniqueKeyE
	
END
ELSE IF ISNULL(@EventUniqueKey,'')<>''
BEGIN
	/*If workorder is linked to event then @EventUniqueKey is supplied. This works for equipment
	which downtime is not recorded in AMT*/
	SELECT @Event_Id =Event_Id FROM EVENT WHERE UniqueKey=@EventUniqueKey
	
	/*VV #2001 If for some reason workorder is linked to event which does not exists 
	and event details are not supplied*/
	IF @MobileDowntime=1  AND ISNULL(@Event_Id,0)=0
	BEGIN
		SET @MessageWO='Cannot identify Event'
		RETURN
	END

	
END

IF @Event_Id>0 SET @EventId=@Event_Id

IF @TaskStatusId =@TS_O SET @EventId=NULL
IF @TaskStatusId=@TS_D AND @EventId<0 SET @EventId=NULL

IF @AmtPlanningModeId<>@AmtPlanningModeAdv SET @EventId=0

DECLARE @ES_YTS int,@ES_IP int, @ES_C int,@EventIdReplace int
SET @ES_YTS=1
SET @ES_IP=2
SET @ES_C=3


/*VV #4161*/
IF @MobileDowntime=0 AND 
/*new event created in mobile or event cannot be found in AMT*/
ISNULL(@Event_Id,0)=0 AND ISNULL(@EventUniqueKey,'')<>''
BEGIN
	/*Check if AMT Event exists within 1 hour of Mobile Event*/
	IF @EventStatusId=@ES_YTS
	BEGIN
		SET @PlannedDownTime_E=ISNULL(@PlannedDownTime,GETDATE())
		
		SELECT @EventIdReplace=Event_ID
		FROM EVENT 
		WHERE Eqp_Plan_Id=@EqpPlanId AND Event_Status_ID IN(@ES_YTS,@ES_IP) AND 
		(
			(Event_Status_ID=@ES_YTS AND ABS(CAST(@PlannedDownTime_E AS float) - CAST(Planned_Down_Time AS float))*24.00<=1)
			OR
			(Event_Status_ID=@ES_YTS AND ABS(CAST(@PlannedDownTime_E AS float) - CAST(Planned_Up_Time AS float))*24.00<=1)
			OR
			(Event_Status_ID=@ES_IP AND ABS(CAST(@PlannedDownTime_E AS float) - CAST(Actual_Down_Time AS float))*24.00<=1)
			OR
			(Event_Status_ID=@ES_IP AND ABS(CAST(@PlannedDownTime_E AS float) - CAST(Actual_Up_Time AS float))*24.00<=1)
		)
		ORDER BY Event_Status_ID DESC,
		ABS(CAST(@PlannedDownTime_E AS float) - CAST(Actual_Down_Time AS float)) DESC,
		ABS(CAST(@PlannedDownTime_E AS float) - CAST(Actual_Up_Time AS float)) DESC,
		ABS(CAST(@PlannedDownTime_E AS float) - CAST(Planned_Down_Time AS float)) DESC,
		ABS(CAST(@PlannedDownTime_E AS float) - CAST(Planned_Up_Time AS float)) DESC
	
	END
	IF @EventStatusId IN(@ES_IP,@ES_C)
	BEGIN
		SELECT @EventIdReplace=Event_ID 
		FROM EVENT 
		WHERE Eqp_Plan_Id=@EqpPlanId AND Event_Status_ID IN (@ES_IP,@ES_C) AND
		(
			ABS(CAST(@ActualDownTime_E AS float) - CAST(Actual_Down_Time AS float))*24.00<=1
			OR
			ABS(CAST(@ActualDownTime_E AS float) - CAST(Actual_Up_Time AS float))*24.00<=1
		)
		ORDER BY 
		ABS(CAST(@ActualDownTime_E AS float) - CAST(Actual_Down_Time AS float)) DESC,
		ABS(CAST(@ActualDownTime_E AS float) - CAST(Actual_Up_Time AS float)) DESC
	END
	
	IF @EventIdReplace>0 
	BEGIN
		SET @EventId=@EventIdReplace
		/*VV #4161*/
		SET @PrimaryCause=0
	END
	
END

/*Special Rule: Only Update Workorder Status when status "increases"
VV: Discussed with GE, RF, DS - do not update workorder if status decreases.

*/


IF @TaskId>0 AND @TaskStatusId<>@Task_Status_ID AND 

(	(@AmtPlanningModeId<>@AmtPlanningModeAdv AND @TaskStatusId=@TS_D) OR
	(@AmtPlanningModeId=@AmtPlanningModeAdv AND 
		@Task_Status_Id=@TS_O AND @TaskStatusId<>@TS_A AND ISNULL(@EventId,0)=0) OR
	(@Task_Status_Id=@TS_O AND @TaskStatusId=@TS_D) OR
	(@Task_Status_Id=@TS_C AND @TaskStatusId<>@TS_C) OR
	(@Task_Status_Id=@TS_IP AND @TaskStatusId IN(@TS_O,@TS_YTS)) OR
	(@Task_Status_Id=@TS_YTS AND @TaskStatusId =@TS_O) )
BEGIN	
	
	SET @MessageWO='Cannot change workorder status from '+
	(SELECT Description FROM TASK_STATUS WHERE Task_Status_ID=@Task_Status_ID)+' to ' +
	(SELECT Description FROM TASK_STATUS WHERE Task_Status_ID=@TaskStatusId)
	RETURN
END 

/*Requirements for the link are:
1) Workorder is not linked
2) Equipment matches
3) Use the PURE WO NUMBER where one UNLINKED parent settlement exists"
*/
IF @Work_Order_ID IS NULL AND @WorkorderNumber<>''
BEGIN
	SELECT @Work_Order_ID=WO.WorkOrderId,@Work_Order=WO.WorkOrderNumber
	FROM 
	tblWorkOrders WO 
		LEFT JOIN
	TASK T
		ON WO.WorkOrderId=T.Work_Order_ID
	WHERE WO.EqpPlanId=@EqpPlanId AND T.Work_Order_ID IS NULL AND
	PureWONumber=@WorkorderNumber AND WO.WorkOrderId=WO.AMTParentWorkOrderId
	
END


/*if Need to add a new workorder*/
IF @TaskId<0
BEGIN
	
	CREATE TABLE #z_WO_DEFAULTS(
	Task_ID int,
	Description varchar(500) COLLATE DATABASE_DEFAULT,
	Eqp_Plan_ID int,
	Task_Type_ID int,
	Component_Code_ID int,
	Modifier_ID int,
	Application_Code_ID int,
	Occurrence_Type_Id int,
	Priority_ID int,
	Source_ID int,
	Task_Status_ID int,
	Symptom_ID int,
	Cause_ID int,
	Expected_Duration float,
	Expected_Labor_Hours float,
	Planning_Notes varchar(8000) COLLATE DATABASE_DEFAULT,
	Work_Order varchar(50) COLLATE DATABASE_DEFAULT,
	Actual_Duration float,
	Actual_Labor_Hrs float,
	Primary_Cause bit,
	Notes varchar(1000) COLLATE DATABASE_DEFAULT,
	Task_Mode_ID int,
	PartsStatusRequired bit,
	PartsStatusOrdered bit,
	PartsStatusReady bit,
	Strategy_Usage real,
	Strategy_QUOM_ID int,
	Strategy_Proj_Task_Opt_ID int,
	Planned_Proj_Task_Opt_ID int,
	Strategy_Date datetime,
	Strategy_Locked bit,
	Repair_Code_Id int,
	Task_Header_Id int,
	Strategy_Repair_Description varchar(8000)  COLLATE DATABASE_DEFAULT,
	Cost_Bearer_ID int,
	Task_Warranty bit,
	Redo_Work_Order_ID int,
	View_Warranty bit,
	Health_Safety_Id int,
	Break_Down bit,
	Planned_Down_Time datetime,
	Actual_Down_Time datetime,
	Planned_Offset float,
	Final_Change float,
	Risk_Life_Left float,
	Strategy_Frequency float,
	Last_Performed float,
	Last_Scheduled float,
	Last_Performed_Date datetime,
	Last_Scheduled_Date datetime,
	Site_Id int,
	Cost_Centre_Id int,
	Branch_Id int,
	Customer_Id int,
	Part_Entry_Distribution_Code_Id int,
	Part_Cost_Expense_Id int,
	Labour_Cost_Expense_Id int,
	Misc_Cost_Expense_Id int,
	Warranty_Days float,
	Warranty_Usage float,
	Strategy_Part_Num varchar(50)  COLLATE DATABASE_DEFAULT,
	Labour_Entry_Distribution_Code_Id int,
	Misc_Entry_Distribution_Code_Id int,
	AMTPlanningModeId int,
	Specific_Operation_Codes bit,
	ChangeoutCategoryId int,
	Work_Group_Id int,
	Def_Work_Group_Id int,
	WOCreateFromPO bit,
	LastNotified datetime,
	AuthorisationRequestByID int,
	AuthorisationRequestDate datetime,
	ResourceStatusReady bit,
	/*VV #3838*/
	RebuildPartTypeId int,
	RebuildPartId int
	) 

	INSERT INTO #z_WO_DEFAULTS
	EXEC TASK_DEFAULT_ADD_GET_P @eqp_plan_id=@EqpPlanId,@ForWOCreate=1
	
	SELECT @Source_ID=Source_ID,@PartsStatusRequired=PartsStatusRequired,
	@PartsStatusOrdered=PartsStatusOrdered,@PartsStatusReady=PartsStatusReady,
	@HealthSafetyId=Health_Safety_Id,@CostCentreId=Cost_Centre_Id,@BranchId=Branch_Id,
	@CustomerId=Customer_Id,@PartEntryDistributionCodeId=Part_Entry_Distribution_Code_Id,
	@PartsCostExpenseId=Part_Cost_Expense_Id,@LabourCostExpenseId=Labour_Cost_Expense_Id,
	@MiscCostExpenseId=Misc_Cost_Expense_Id,
	@LabourEntryDistributionCodeId=Labour_Entry_Distribution_Code_Id,
	@MiscEntryDistributionCodeId=Misc_Entry_Distribution_Code_Id,
	@SpecificOperationCodes=Specific_Operation_Codes,@ChangeoutCategoryId=ChangeoutCategoryId,
	@Cost_Bearer_ID=Cost_Bearer_ID
	FROM #z_WO_DEFAULTS

	DROP TABLE #z_WO_DEFAULTS
END

set @opAdded=''

IF EXISTS(SELECT TaskOperationId FROM #z_WOOperation_MB WHERE TaskOperationIdAmt=0)
BEGIN
	set @opAdded=@opAdded+( SELECT 
	0 as Task_Id,
	TaskOperationId  as Task_Operation_Id,
	SortOrder,
	TaskOperation as Task_Operation,
	ComponentCodeId as Component_Code_Id,
	ModifierCodeId AS Modifier_Code_Id,
	JobCodeId AS Job_Code_Id,
	OperationInstructions AS Operation_Instructions,
	OperationOffset,
	PlannedDuration AS Planned_Duration,
	Completed,
	PartsReturned,
	WorkGroupId AS Work_Group_Id,
	@HealthSafetyId AS Health_Safety_Id ,	
	@Cost_Bearer_ID AS Cost_Bearer_ID,
	@CostCentreId AS Cost_Centre_Id,
	@PartsCostExpenseId AS Parts_Cost_Expense_Id,
	@LabourCostExpenseId AS Labour_Cost_Expense_Id,
	@MiscCostExpenseId AS Misc_Cost_Expense_Id,
	@PartEntryDistributionCodeId AS Parts_Entry_Distribution_Code_Id,
	@LabourEntryDistributionCodeId AS Labour_Entry_Distribution_Code_Id,
	@MiscEntryDistributionCodeId AS Misc_Entry_Distribution_Code_Id,
	UniqueKey
		
	FROM #z_WOOperation_MB  
	WHERE TaskOperationIdAmt=0 
	FOR XML PATH('TaskOperation'))
END	

/*Parts and misc are only added on Mobile if operation is added or replaced*/
IF EXISTS(SELECT * FROM #z_WOPart_MB P
	INNER JOIN
#z_WOOperation_MB O
	ON P.TaskOperationId=O.TaskOperationId
	WHERE O.TaskOperationIdAmt=0 )
BEGIN
	SET @opAdded=@opAdded+(SELECT
	O.TaskOperationId AS Task_Operation_Id,
	p.TaskOperationPartId as Task_Operation_Part_Id,
	P.PartNumber AS Part_Number,
	P.PartDescription AS Part_Description,
	P.PlannedQty AS Planned_Qty,
	1 AS Include_In_Total,
	1 as IsEditable,
	@Cost_Bearer_ID AS OPCostBearerID,
	@CostCentreId AS OPCostCentreID,
	@PartsCostExpenseId AS OPExpenseElementID,
	@WorkGroupId AS OPWorkGroupID
	FROM
	#z_WOPart_MB P
		INNER JOIN
	#z_WOOperation_MB O
		ON P.TaskOperationId=O.TaskOperationId
		WHERE O.TaskOperationIdAmt=0 /*Parts and misc are only added on Mobile*/
	FOR XML PATH('TaskOpParts'))
END

/*Parts and misc are only added on Mobile if operation is added or replaced*/
IF EXISTS(SELECT * FROM #z_WOMisc_MB P
	INNER JOIN
#z_WOOperation_MB O
	ON P.TaskOperationId=O.TaskOperationId
	WHERE O.TaskOperationIdAmt=0 )
BEGIN
	SET @opAdded=@opAdded+(SELECT
	O.TaskOperationId AS Task_Operation_Id,
	p.TaskOperationMiscId as Task_Operation_Misc_Id,
	p.MiscCategoryId as Misc_Category_Id,
	P.TaskOperationMiscDesc as Task_Operation_Misc_Desc,
	1 as IsEditable,
	@Cost_Bearer_ID AS OPCostBearerID,
	@CostCentreId AS OPCostCentreID,
	@MiscCostExpenseId AS OPExpenseElementID,
	@WorkGroupId AS OPWorkGroupID
	FROM
	#z_WOMisc_MB P
		INNER JOIN
	#z_WOOperation_MB O
		ON P.TaskOperationId=O.TaskOperationId
		WHERE O.TaskOperationIdAmt=0 /*Parts and misc are only added on Mobile*/
	FOR XML PATH('TaskOpMisc'))
END
	
/*Labour can be added or updated*/
IF EXISTS(SELECT * FROM #z_WOLabour_MB P
	INNER JOIN
#z_WOOperation_MB O
	ON P.TaskOperationId=O.TaskOperationId
	WHERE P.TaskOperationLabourIdAmt=0 )
BEGIN
	SET @opAdded=@opAdded+(SELECT
	CASE WHEN O.TaskOperationIdAmt>0 THEN O.TaskOperationIdAmt ELSE O.TaskOperationId END AS Task_Operation_Id,
	P.TaskOperationLabourId AS Task_Operation_Labour_Id,
	P.LabourActivityId AS Labour_Activity_Id,
	P.LabourActivityWO AS Labour_Activity,
	P.PlannedLabourHrs AS Planned_Labour_Hrs,
	P.ActualLabourHrs AS Actual_Labour_Hrs,
	P.WorkGroupId AS Work_Group_Id,
	EmployeeId AS Employee_Id,
	JSARead,
	JSAReadId,
	1 AS Include_In_Total,
	1 as IsEditable,
	@Cost_Bearer_ID AS OPCostBearerID,
	@CostCentreId AS OPCostCentreID,
	@LabourCostExpenseId AS OPExpenseElementID,
	P.UniqueKey
	FROM
	#z_WOLabour_MB P
		INNER JOIN
	#z_WOOperation_MB O
		ON P.TaskOperationId=O.TaskOperationId
		WHERE P.TaskOperationLabourIdAmt=0 
	FOR XML PATH('TaskOpLabour'))
END


IF EXISTS(SELECT EWWorkorderId FROM #z_WOElectronicWorkscope_MB WHERE EWWorkorderIdAmt=0)
BEGIN
	SET @opAdded=@opAdded+(SELECT W.EWWorkorderId,
	CASE WHEN O.TaskOperationIdAmt>0 THEN O.TaskOperationIdAmt ELSE O.TaskOperationId END AS TaskOperationId,	
	W.EWTitle,W.UniqueKey
	FROM
	#z_WOElectronicWorkscope_MB W
		INNER JOIN
	#z_WOOperation_MB O
		ON W.TaskOperationId=O.TaskOperationId
	WHERE W.EWWorkorderIdAmt=0
	FOR XML PATH('WOElectronicWorkscope'))
END


IF EXISTS(SELECT EWWorkstepId FROM #z_WOWorkstep_MB WHERE EWWorkstepIdAmt=0)
BEGIN
	SET @opAdded=@opAdded+(SELECT 
	S.EWWorkstepId,
	CASE WHEN W.EWWorkorderIdAmt>0 THEN W.EWWorkorderIdAmt ELSE W.EWWorkorderId END AS EWWorkorderId,
	S.EWStepTemplateId,
	S.Sequence,
	S.EWWorkstepTitle,
	S.ComponentCodeId,
	S.CMCodeId,
	S.Instructions,
	S.DocumentGUID,
	S.DocumentExt,
	S.Safety ,
	S.Environmental ,
	S.Reading,
	S.CMRatingId,
	S.ResultId,
	S.PerformedById,
	S.Comments,
	S.CreateDefectWO AS CrreateDefectWO,
	S.DefectRepairInstructions,
	S.Actioned ,
	S.ActionedComments,
	S.ReviewdById,
	S.UniqueKey
	FROM
	#z_WOElectronicWorkscope_MB W
		INNER JOIN
	#z_WOWorkstep_MB S
		ON W.EWWorkorderId=S.EWWorkorderId
	WHERE S.EWWorkstepIdAmt=0
	FOR XML PATH('WOWorkstep'))
END

IF @opAdded<>'' 
BEGIN
	SET @opAdded='<DSOp><Params><CreateEWWorkorders>0</CreateEWWorkorders></Params>'+@opAdded+'</DSOp>'
END


/*if Need to add a new workorder*/
IF @TaskId<0
BEGIN
	DECLARE @EventIdAdd int,@TaskStatusIdAdd int
	
	IF @EventId<0 
	BEGIN
		SET @EventIdAdd=0
		SET @TaskStatusIdAdd=@TS_O
	END
	ELSE
	BEGIN
		SET @EventIdAdd=@EventId
		SET @TaskStatusIdAdd=@TaskStatusId 
	END
	
	EXEC TASK_ADD_P
	@Event_ID=@EventIdAdd, 
	@Description=@Description, 
	@Eqp_Plan_ID=@EqpPlanId, 
	@Task_Type_ID =@TaskTypeId, 
	@Component_Code_ID=@ComponentCodeId, 
	@Modifier_ID=@ModifierId, 
	@Application_Code_ID=@ApplicationCodeId, 
	@Occurrence_Type_Id=@OccurrenceTypeId, 
	@Priority_ID=@PriorityId, 
	@Source_ID=@Source_ID, 
	@Task_Status_ID =@TaskStatusIdAdd, 
    @Date_Notified =@ActualDownTime, 
	@Component_ID ='', 
	@Symptom_ID =@SymptomId, 
	@Symptom_Notes=@SymptomNotes,	
	@Cause_ID=@CauseId, 
	@Cause_Notes=@CauseNotes, 
	@Repair_Code_ID=@RepairCodeId, 
	@Repair_Notes=@RepairNotes, 
	@Group_No=@GroupNo,
	@Part_No=@PartNo,
	@Cost_Bearer_ID=@Cost_Bearer_ID,
	@Employee_ID=@EmployeeId, 
	@Expected_Duration=@ExpectedDuration, 
	@Expected_Labor_Hours=0, 
	@Work_Order=@Work_Order, 
	@Actual_Duration=@ActualDuration, 
	@Actual_Labor_Hrs=0,                    
	@Primary_Cause=@PrimaryCause, 
	@Task_Mode_ID=@TaskModeId,
	@PartsStatusRequired=@PartsStatusRequired,
	@PartsStatusOrdered=@PartsStatusOrdered,
	@PartsStatusReady=@PartsStatusReady,
	@RaisedByID=@RaisedById,
	@Work_Order_ID=@Work_Order_ID,
	@Work_Group_ID=@WorkGroupId,
	@Part_Description=@PartDescription,   
	@Group_Description=@GroupDescription,
    @SIMS_Code_Id=@SIMSCodeId,
	@Event_Last_Mod_Date=Null,
    @Create_By_User_ID=@UserId,
    @NewTask_ID =@TaskId OUTPUT,
	@Message =@MessageWO OUTPUT,
	@HealthSafetyId =@HealthSafetyId,
	@BreakDown=@BreakDown,
	@PlannedDownTime =@PlannedDownTime,
	@ActualDownTime =@ActualDownTime,
	@SiteId =@SiteId,
	@WorkLocation =@Work_Location,
	@CostCentreId=@CostCentreId,
	@BranchId =@BranchId,
	@CustomerId=@CustomerId,
	@PartEntryDistributionCodeId=@PartEntryDistributionCodeId,
	@DefWorkGroupId=@WorkGroupId,
	@PartsCostExpenseId=@PartsCostExpenseId,
	@LabourCostExpenseId =@LabourCostExpenseId,
	@MiscCostExpenseId =@MiscCostExpenseId,
	@SpecificOperationCodes=@SpecificOperationCodes,
	@AMTPlanningModeId =@AMTPlanningModeId,
	@LabourEntryDistributionCodeId=@LabourEntryDistributionCodeId,
	@MiscEntryDistributionCodeId=@MiscEntryDistributionCodeId,
	@opAdded =@opAdded,
	@ChangeoutCategoryId =@ChangeoutCategoryId,
	@PartSerialNoRemoved=@FailedGroupListPosition,
	@PartSerialNoInstalled=@FailedGroupPartsListGroup,
	@ActualEmployeeId=@ActualEmployeeId,
	@ActualWorkGroupId=@ActualWorkGroupId,
	@CompletedById=@CompletedById,
	@PartsReturned=@PartsReturned,
	@UniqueKey=@UniqueKeyWO,
	@Inspection=@Inspection
	
END


IF @MobileDowntime=0 AND @Event_Id_WO>0 AND (/*new 0 downtime event shall be created*/ISNULL(@EventId,0)<0 
	OR (/*workorder is moved to another event*/@EventId>0 AND @Event_Id_WO<>@EventId))
BEGIN
	--unlink wo from event
	UPDATE TASK SET Event_ID=NULL,Task_Status_Id=@TS_O WHERE Task_ID=@TaskId
END

/*Add New Event or update the existing event*/
IF @EventId<0
BEGIN
	 
	SELECT @Priority_ID=Priority_ID FROM PRIORITY WHERE Default_Record = 1
	/*VV #4161*/
	SET @PlannedDownTime_E=ISNULL(@PlannedDownTime,GETDATE())
	SET @Expected_Up_Time=ISNULL(ISNULL(ISNULL(DATEADD(second,@ExpectedDuration*3600.00, @PlannedDownTime_E),@ActualUpTime_E),@ActualDownTime_E),GETDATE())
	SET @PlannedUpTime_E=ISNULL(DATEADD(second,@ExpectedDuration*3600.00, @PlannedDownTime_E),GETDATE())
	SET @DescriptionE=@Description
	SET @Work_Location_ID =NULL
	SET @TestTime=0
	SET @ReleasedByID=NULL
	
	/*If downtime is not captured in Mobile Create new ZERO hour Event*/
	IF @MobileDowntime=0
	BEGIN
		SET @PlannedUpTime_E=@PlannedDownTime_E
		/*VV #4161*/
		SET @Expected_Up_Time=@PlannedDownTime_E
		SET @ActualUpTime_E=@ActualDownTime_E
		
		SET @EventStatusId=dbo.EVENT_STATUS_FOR_WORKORDER_F(@TaskStatusId)
	END
	
END


/*VV #1867*/

DECLARE @UpdateEvent bit

SET @UpdateEvent=0

IF (@MobileDowntime=1 AND ISNULL(@EventId,0)<>0 AND /*VV #2001*/ISNULL(@UniqueKeyE,'')<>'') SET @UpdateEvent=1


/*Downtime shall be captured in Mobile for event to be updated
If downtime is not captured in Mobile New event will be created with 0 downtime*/
IF ISNULL(@EventId,0)<0  OR @UpdateEvent=1
BEGIN
	
	SET @xmlEvent=(SELECT @EventId AS Event_ID,@EqpPlanId AS Eqp_Plan_ID,@DescriptionE AS Description,   
	@EventStatusId AS Event_Status_ID,@Priority_ID AS Priority_ID,@Work_Location_ID AS Work_Location_ID ,
	@Planned AS Planned,@BreakDownE AS Break_Down, @Expected_Up_Time AS Expected_Up_Time_D,
	0 AS Confirmed,@EventPreventionId AS Event_Prevention_ID,@PlannedDownTime_E AS Planned_Down_Time_D,  
	@PlannedUpTime_E AS Planned_Up_Time_D,@ActualDownTime_E AS Actual_Down_Time_D,
	@ActualUpTime_E AS Actual_Up_Time_D, @TestTime AS TestTime,@ReleasedByID AS Released_By_ID,
	@UniqueKeyE AS UniqueKey
	FOR XML PATH('TBL_EV'))
	
	
	IF NOT EXISTS(SELECT * FROM #z_DownTimeAllocation_MB)
	BEGIN
		
		EXEC DOWN_TIME_ALLOCATIONS_GET_DEFAULTS_P @VarianceCauseID=@VarianceCauseID OUTPUT,  
		@Task_Type_ID=NULL, @ResponsibilityID=@ResponsibilityID OUTPUT 
		
		INSERT INTO #z_DownTimeAllocation_MB(DownTimeAllocationIdAmt,VarianceCauseId,TaskTypeId,
		ResponsibilityId,PlannedHours,ActualHours,PrimaryDTA,UniqueKey)
		SELECT -1 AS DownTimeAllocationIdAmt,@VarianceCauseID AS VarianceCauseId,
		@TaskTypeId AS TaskTypeId,@ResponsibilityID AS ResponsibilityId,
		0 AS PlannedHours,0 AS ActualHours,1 AS PrimaryDTA,NEWID() AS UniqueKey
	END
	
	SET @xmlEvent=@xmlEvent+(SELECT CASE WHEN D.DownTimeAllocationIdAmt>0 THEN D.DownTimeAllocationIdAmt ELSE D.DownTimeAllocationId END AS Down_Time_Allocation_ID,
	D.VarianceCauseId AS Variance_Cause_ID,D.TaskTypeId AS Task_Type_ID,D.ResponsibilityId AS Responsibility_ID,
	D.PlannedHours AS Planned_Hours,D.ActualHours AS Actual_Hours,D.PrimaryDTA AS Primary_DTA,
	Notes
	FROM #z_DownTimeAllocation_MB D
	FOR XML PATH('TBL_DT'))
	
	SET @xmlEvent='<DS_EV>'+@xmlEvent+'</DS_EV>'
	
	/*VV #1867 If it is a new event to create it needs to be created 
	before workorder is updated with event details */
	IF @UpdateEvent=0 	
	BEGIN	
		EXEC EVENT_ADD_UPDATE_P @xmlEvent=@xmlEvent, @EventId=@EventId OUTPUT,@Message =@MessageE OUTPUT,
			 @PrimaryTaskId=@TaskId
			 
		IF ISNULL(@MessageE,'')<>'' 
		BEGIN
			/*VV #2001*/
			SET @MessageWO=@MessageE
			return
		END

	END
	
END

SET @EventId=NULLIF(@EventId,0)

IF @Task_Id>0
Begin	
	SET @opModified=''

	IF EXISTS(SELECT TaskOperationIdAmt FROM #z_WOOperation_MB WHERE TaskOperationIdAmt>0)
	BEGIN
		set @opModified=@opModified+(SELECT 
					O.Task_Id,
					O.Task_Operation_Id,
					Z.SortOrder ,
					Z.TaskOperation as Task_Operation,
					Z.ComponentCodeId as Component_Code_Id,
					Z.ModifierCodeId AS Modifier_Code_Id,
					Z.JobCodeId AS Job_Code_Id,
					Z.OperationInstructions AS Operation_Instructions,
					Z.OperationOffset,
					Z.PlannedDuration AS Planned_Duration,
					Z.Completed,
					Z.PartsReturned,
					Z.WorkGroupId AS Work_Group_Id,
					O.Health_Safety_Id ,	
					O.Cost_Bearer_ID,
					O.Cost_Centre_Id,
					O.Parts_Cost_Expense_Id,
					O.Labour_Cost_Expense_Id,
					O.Misc_Cost_Expense_Id,
					O.Parts_Entry_Distribution_Code_Id,
					O.Misc_Entry_Distribution_Code_Id,
					O.Actual_Duration,
					O.Proj_Task_Amt_Id, 
					O.Std_Job_Op_Id
					FROM 
					#z_WOOperation_MB Z
						INNER JOIN
					TASK_OPERATION O
						ON Z.TaskOperationIdAmt=O.Task_Operation_Id

					FOR XML PATH('TaskOperation'))
	END

	IF EXISTS(SELECT TaskOperationLabourId FROM #z_WOLabour_MB WHERE TaskOperationLabourIdAmt>0)
	BEGIN
		SET @opModified=@opModified+(SELECT
		O.Task_Operation_Id AS Task_Operation_Id,
		O.Task_Operation_Labour_Id,
		P.LabourActivityId AS Labour_Activity_Id,
		P.LabourActivityWO AS Labour_Activity,
		O.Planned_Labour_Hrs,/*Planned hours are not updated in mobile*/
		P.ActualLabourHrs AS Actual_Labour_Hrs,
		P.WorkGroupId AS Work_Group_Id,
		EmployeeId AS Employee_Id,
		P.JSARead,
		P.JSAReadId,
		O.Include_In_Total AS Include_In_Total,
		O.IsEditable as IsEditable,
		O.CostBearerID AS OPCostBearerID,
		O.CostCentreID AS OPCostCentreID,
		O.ExpenseElementID  AS OPExpenseElementID,
		O.Strategy_Labour_Hrs,
		O.Strategy_Labour_Rate,
		O.Labour_Qty AS Planned_Qty,
		O.Planned_Labour_Rate,
		O.Instructions,
		O.Actual_Labour_Hrs,
		O.Actual_Labour_Rate,
		O.Labour_Offset
		FROM
		#z_WOLabour_MB P
			INNER JOIN
		TASK_OPERATION_LABOUR O
			ON P.TaskOperationLabourIdAmt=O.Task_Operation_Labour_Id
			
		FOR XML PATH('TaskOpLabour'))
	END
	

	IF EXISTS(SELECT EWWorkorderId FROM #z_WOElectronicWorkscope_MB where EWWorkorderIdAmt>0)
	BEGIN
		SET @opModified=@opModified+(SELECT W.EWWorkorderIdAmt AS EWWorkorderId,
		O.TaskOperationIdAmt AS TaskOperationId,W.EWTitle
		FROM
		#z_WOElectronicWorkscope_MB W
			INNER JOIN
		#z_WOOperation_MB O
			ON W.TaskOperationId=O.TaskOperationId
		WHERE W.EWWorkorderIdAmt>0		
		FOR XML PATH('WOElectronicWorkscope'))
	END

	IF EXISTS(SELECT EWWorkstepIdAmt FROM #z_WOWorkstep_MB WHERE EWWorkstepIdAmt>0)
	BEGIN
				
		SET @opModified=@opModified+(SELECT 
		W.EWWorkstepId,
		W.EWWorkorderId,
		S.EWStepTemplateId,
		S.Sequence,
		S.EWWorkstepTitle,
		S.ComponentCodeId,
		S.CMCodeId,
		S.Instructions,
		S.DocumentGUID,
		S.DocumentExt,
		S.Safety ,
		S.Environmental ,
		S.Reading,
		S.CMRatingId,
		S.ResultId,
		S.PerformedById,
		S.Comments,
		S.CreateDefectWO AS CrreateDefectWO,
		S.DefectRepairInstructions,
		S.Actioned ,
		S.ActionedComments,
		S.ReviewdById
		FROM
		EW_WORKSTEP W
			INNER JOIN
		#z_WOWorkstep_MB S
			ON W.EWWorkstepId=S.EWWorkstepIdAmt
		
		FOR XML PATH('WOWorkstep'))
	END

	IF @opModified<>'' 
	BEGIN
		SET @opModified='<DSOp>'+@opModified+'</DSOp>'
		/*AmtMobile sends all operations. The user can replace operations in Mobile and check in.
		In this case  @OpReplaced=1 and there are no operations to modify. Next time when the user 
		checks in the same workorder amt mobile sends @OpReplaced=1, it also sends operations to modify.
		So if there are operations to modify SET @OpReplaced=0*/
		SET @OpReplaced=0
	END
	
	/*VV #2694*/
	DECLARE @EventIdUpdate int
	
	IF @EventId<0 
	BEGIN
		SET @EventIdUpdate=0
	END
	ELSE
	BEGIN
		SET @EventIdUpdate=@EventId
	END
	
	EXEC TASK_UPDATE_P
	@Task_ID =@TaskId,
	@Event_ID =@EventIdUpdate, /*VV #2694*/
	@Description =@Description,
	@Eqp_Plan_ID =@EqpPlanId, 
	@Task_Type_ID =@TaskTypeId, 
	@Component_Code_ID=@ComponentCodeId, 
	@Modifier_ID=@ModifierId, 
	@Application_Code_ID=@ApplicationCodeId, 
	@Occurrence_Type_Id=@OccurrenceTypeId, 
	@Priority_ID=@PriorityId, 
	@Source_ID=@Source_ID, 
	@Task_Status_ID=@TaskStatusId, 
	@Date_Notified=@Date_Notified, 
	@Component_ID=@Component_ID, 
	@Symptom_ID=@SymptomId, 
	@Symptom_Notes=@SymptomNotes, 
	@Cause_ID=@CauseId, 
	@Cause_Notes=@CauseNotes, 
	@Repair_Code_ID=@RepairCodeId, 
	@Repair_Notes=@RepairNotes, 
	@Group_No=@GroupNo,
	@Part_No=@PartNo,
	@EMI_Ref=@EMI_Ref,
	@EMIssueId=@EMIssueId, 
	@Redo=@Redo, 
	@Task_Planned_Time_ID=@Task_Planned_Time_ID, 
	@Customer_Ref=@Customer_Ref, 
	@Employee_ID=@EmployeeId, 
	@Expected_Duration=@ExpectedDuration, 
	@Expected_Labor_Hours=@Expected_Labor_Hours, 
	@Planning_Notes=@Planning_Notes,
	@Work_Order=@Work_Order, 
	@Actual_Duration=@ActualDuration, 
	@Actual_Labor_Hrs=@Actual_Labor_Hrs,                    
	@Primary_Cause=@PrimaryCause, 
	@Notes=@Notes,
	@Task_Mode_ID=@TaskModeId,
	@PartsStatusRequired=@PartsStatusRequired,
	@PartsStatusOrdered=@PartsStatusOrdered,
	@PartsStatusReady=@PartsStatusReady,
	@RaisedByID=@RaisedById,
	@Work_Order_ID=@Work_Order_ID,
	@Work_Group_ID=@WorkGroupId,
	@Strategy_Proj_Task_Opt_ID=0/* VV #1427 @Strategy_Proj_Task_Opt_ID*/,
	@Planned_Proj_Task_Opt_ID=0/* #1427 @Strategy_Proj_Task_Opt_ID*/,
	@Event_Last_Mod_Date=NULL,
	@Task_Last_Mod_Date=NULL,
	@Part_Description =@PartDescription,   
	@Group_Description=@GroupDescription,
	@SIMS_Code_Id=@SIMSCodeId,
	@Last_Mod_By_User_ID=@UserId,
	@Message=@MessageWO OUTPUT,
	@Sort_Order=@Sort_Order,
	@WO_Create_Date=@WO_Create_Date,
	@Performed_By_Date=@Performed_By_Date,
	@Parts_Available_Date=@Parts_Available_Date,
	@Parts_Order_Details=@Parts_Order_Details,
	@WO_Counter=@WO_Counter,
	@Work_Order_Number_External=@Work_Order_Number_External,
	@Cost_Bearer_ID=@Cost_Bearer_ID,
	@Task_Warranty=@Task_Warranty,
	@Redo_Work_Order_ID=@Redo_Work_Order_ID,
	@ViewWarranty=@ViewWarranty,
	@HealthSafetyId=@HealthSafetyId,
	@BreakDown=@BreakDown,
	@PlannedDownTime= @PlannedDownTime,
	@ActualDownTime= @ActualDownTime,
	@PlannedOffset=@PlannedOffset,
	@SiteId=@SiteId,
	@WorkLocation=@Work_Location,
	@CostCentreId=@CostCentreId,
	@BranchId=@BranchId,
	@CustomerId=@CustomerId,
	@PartEntryDistributionCodeId=@PartEntryDistributionCodeId,
	@DefWorkGroupId=@DefWorkGroupId,
	@PartsCostExpenseId=@PartsCostExpenseId,
	@LabourCostExpenseId=@LabourCostExpenseId,
	@MiscCostExpenseId=@MiscCostExpenseId,
	@SpecificOperationCodes=@SpecificOperationCodes,
	@WorkOrderDate=@WorkOrderDate,
	@WarrantyClaimable=@WarrantyClaimable,
	@ReviewedEmployeeId=@ReviewedEmployeeId,
	@WarrantyNotes=@WarrantyNotes,
	@WarrantyDays=@WarrantyDays,
	@WarrantyUsage=@WarrantyUsage,
	@WarrantyDaysArchived=@WarrantyDaysArchived,
	@WarrantyUsageAcrhived=@WarrantyUsageAcrhived,
	@WarrantySupplierId=@WarrantySupplierId,
	@ClaimRef=@ClaimRef,
	@SupplierRef=@SupplierRef,
	@SummaryDescription=@SummaryDescription,
	@ClaimStatusId=@ClaimStatusId,
	@ClaimedByEmployeeId=@ClaimedByEmployeeId,
	@ClaimeDate=@ClaimeDate,
	@ClaimDescription=@ClaimDescription,
	@JobPartsCost=@JobPartsCost,
	@JobLabourCost=@JobLabourCost,
	@JobMiscCost=@JobMiscCost,
	@ClaimedPartsCost=@ClaimedPartsCost,
	@ClaimedLabourCost=@ClaimedLabourCost,
	@ClaimedMiscCost=@ClaimedMiscCost,
	@RecPartsCost=@RecPartsCost,
	@RecLabourCost=@RecLabourCost,
	@RecMiscCost=@RecMiscCost,
	@LabourEntryDistributionCodeId=@LabourEntryDistributionCodeId,
	@MiscEntryDistributionCodeId=@MiscEntryDistributionCodeId,
	@SupplierContact=@SupplierContact,
	@TaskAuthorised=@TaskAuthorised,
	@ActualOffset=@ActualOffset,
	@OpReplaced=@OpReplaced,
	@opAdded=@opAdded,    
	@opModified=@opModified,
	@ChangeoutCategoryId=@ChangeoutCategoryId,
	@LifeConfirmed=@LifeConfirmed,
	@OriginalPartTypeId=@OriginalPartTypeId,
	@SerialNoIn=@SerialNoIn,
	@SerialNoOut=@SerialNoOut,
	@IsOverwriteLife=@IsOverwriteLife,
	@OverwriteLifeAchieved=@OverwriteLifeAchieved,
	@WOClosed=@WOClosed,
	@ConditionMonitoringIntervention=@ConditionMonitoringIntervention,
	@FailedPartListPosition	=@FailedPartListPosition,
	@FailedPartListGroup=@FailedPartListGroup,
	@FailedPartLifeAchieved=@FailedPartLifeAchieved,
	@PartSerialNoRemoved=@FailedGroupListPosition,
	@PartSerialNoInstalled=@FailedGroupPartsListGroup,
	@LastNotified=@LastNotified,
	@ResourceStatusReady=@ResourceStatusReady,
	@AuthorisationRequestByID=@AuthorisationRequestByID,
	@ActualEmployeeId=@ActualEmployeeId,
	@ActualWorkGroupId=@ActualWorkGroupId,
	@CompletedById=@CompletedById,
	@PartsReturned=@PartsReturned,
	@Inspection=@Inspection
END


IF ISNULL(@MessageWO,'')<>'' RETURN


/*VV #1867 Update event after workorder is updated because business rules check status of workorders */
IF @UpdateEvent=1	
BEGIN	
	EXEC EVENT_ADD_UPDATE_P @xmlEvent=@xmlEvent, @EventId=@EventId OUTPUT,@Message =@MessageE OUTPUT,
		 @PrimaryTaskId=@TaskId
		 
	IF ISNULL(@MessageE,'')<>'' 
		BEGIN
			/*VV #2001*/
			SET @MessageWO=@MessageE
			return
		END
END



SELECT Z.[FileName]
INTO #z_WOAttachedDocument_MBToAdd
FROM
#z_WOAttachedDocument_MB Z
	LEFT JOIN
ATTACHED_DOCUMENT_TASK A
	ON @TaskId=A.TaskId
	AND Z.[FileName]=A.[FileName]
WHERE A.TaskId IS NULL

INSERT INTO ATTACHED_DOCUMENT_TASK(TaskId,[FileName])
SELECT @TaskId AS TaskId,[FileName] FROM #z_WOAttachedDocument_MBToAdd
	
	
SELECT Z.EWWorkstepId,Z.[FileName]
INTO #z_AttachedDocumentsEWWorkstep_MBToAdd
FROM
(
	SELECT S.EWWorkstepId,A.FileName
	FROM
	#z_AttachedDocumentsEWWorkstep_MB A
		INNER JOIN
	#z_WOWorkstep_MB W
		ON A.EWWorkstepId=W.EWWorkstepId
		INNER JOIN
	EW_WORKSTEP S
		ON W.UniqueKey=S.UniqueKey
) Z
	LEFT JOIN
ATTACHED_DOCUMENTS_EW_WORKSTEP A
	ON Z.EWWorkstepId=A.EWWorkstepId
	AND Z.[FileName]=A.[FileName]
WHERE A.EWWorkstepId IS NULL

INSERT INTO ATTACHED_DOCUMENTS_EW_WORKSTEP(EWWorkstepId,[FileName])
SELECT EWWorkstepId,[FileName] FROM #z_AttachedDocumentsEWWorkstep_MBToAdd


/*Measurements*/
IF EXISTS(SELECT * FROM #z_WOWorkstep_MB WHERE CMCodeId>0 AND ISNUMERIC(Reading)=1)
BEGIN
	DECLARE @NewMeasurementTime datetime
	
	SELECT @NewMeasurementTime=  
		CASE WHEN T.Task_Status_Id IN(@TS_IP,@TS_C)  
		THEN dbo.WO_DOWN_TIME_F(ISNULL(E.Actual_Down_Time,T.Actual_Down_Time),T.ActualOffset)  
		ELSE dbo.WO_DOWN_TIME_F(ISNULL(E.Planned_Down_Time,T.Planned_Down_Time),T.Planned_Offset)  
		END
	FROM   
	TASK T 
		LEFT JOIN  
	EVENT E 
		ON T.Event_ID=E.Event_ID  
	WHERE T.Task_ID=@TaskId
	
	SET @NewMeasurementTime=ISNULL(@NewMeasurementTime,GETDATE())  
 
	INSERT INTO #z_MEASUREMENT_MB(CMCodeId, NewMeasurementTime ,NewReading,CMRatingID, NewExtComments)
	SELECT CMCodeId,@NewMeasurementTime AS NewMeasurementTime ,Reading AS NewReading,
	CMRatingID,Comments AS NewExtComments
	FROM #z_WOWorkstep_MB
	WHERE CMCodeId>0 AND ISNUMERIC(Reading)=1
	ORDER BY CMCodeId,CMRatingID DESC
	
	/*If there are few readings for the same CMCode take the reading with the highest rating*/
	IF EXISTS(SELECT CMCodeId,COUNT(CMCodeId) FROM #z_MEASUREMENT_MB GROUP BY CMCodeId HAVING COUNT(CMCodeId)>1)
	BEGIN
		DELETE #z_MEASUREMENT_MB
		WHERE ListId NOT IN(SELECT Min(ListId) AS ListId FROM #z_MEASUREMENT_MB GROUP BY CMCodeId)
	END
	
	UPDATE Z SET CMMeasurementId=M.CMMeasurementId
	FROM
	#z_MEASUREMENT_MB Z
		INNER JOIN
	CM_MEASUREMENT M
		ON Z.CMCodeId=M.CMCodeId
		AND @TaskId=m.TaskID
	
	SET @MeasurementTBL='<Measurements>'+
	(SELECT CMCodeId,CMMeasurementId, NewMeasurementTime ,NewReading,CMRatingID, NewExtComments
	FROM #z_MEASUREMENT_MB  
	FOR XML PATH('Measurement'))+'</Measurements>'
	
	declare @MessageMeasurements varchar(max)
	set @MessageMeasurements=''
	
	EXEC TASK_MEASUREMENT_PUT_P @TaskID =@TaskId, @MeasurementTBL=@MeasurementTBL, @Message =@MessageMeasurements OUTPUT  
	/*
		This is for debugging Check in will not roll back the changes if the measurements are not added
		
		select @MessageMeasurements
	*/
	
END

/*Files to download*/
SELECT 3 AS DocumentType,[FileName] FROM #z_WOAttachedDocument_MBToAdd
	UNION ALL
SELECT 5 AS DocumentType,DocumentGUID+'.'+DocumentExt as [FileName] FROM #z_WOWorkstep_MB 
WHERE EWWorkstepIdAmt=0 AND ISNULL(DocumentGUID,'')<>'' AND ISNULL(DocumentExt,'')<>''
	UNION ALL
SELECT 6 AS DocumentType,[FileName] FROM #z_AttachedDocumentsEWWorkstep_MBToAdd

	
	
GO

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[usp_Add_WO_Settlement]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[usp_Add_WO_Settlement]

GO

create Procedure [dbo].[usp_Add_WO_Settlement]
/******************************************************************************
	File: usp_Add_WO_Settlement.sql
	Name: usp_Add_WO_Settlement

	Called By: WOSettlementPut.cls

	Desc: 1. Add Work Order Settlement
	      2. Return Id new Work Order Settlement
             

	Auth: Marilena Tucci
	Date: 01-MAY-2002
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	19 Jun 08	AL		Increased the lenth of @WorkGroupSite to the length of tblSites.Site varchar(50)
	16 Nov 07	V Vasylyeva	Increased the lenth of @ExpenseElement to the lenth of COST_EXPENSE.Cost_Expense_Code varchar(10)
	24 May 07	SI		Added new fields @WorkGroupSite
	02 May 06	SI		Added @EqpCategory
	08 Mar 06	SI		Added @Cost Centre settings
	14 Sep 05	SI		Added @ExpenseElement
	18 Apr 11	GD		changed the length of @WorkGroup,@EqpCategory to 50 as part of interface length changes

*******************************************************************************/
	/* Param List */
	@WorkOrderId int,
	@WBSElement varchar(50),
    @CostCentre varchar(50),
    @CostBearerId int,
	@SettlementRule varchar(50),
	@ReceiverCategory varchar(50),
    @PercentParts float,
	@PercentLabour float,
	@PercentMisc float,
	@NewWOSettlemetId int output,
	@ExpenseElement varchar(10) = NULL,
	@EqpCategory varchar(50) = NULL,
	@WorkGroup varchar(50) = NULL,
	@WorkGroupSite varchar(50) = NULL,
	/*VV #4142*/ 
	@Cost_Centre_ID int =NULL,
	@ExpenseElementId int =NULL
AS
/* Local procedure variables */ 

-- Add Expense Element if it's a new one
/*VV #4142 DECLARE @ExpenseElementId int*/
IF ISNULL(@ExpenseElementId,0)=0
BEGIN
	SET @ExpenseElementId = -1
	SELECT @ExpenseElementId = Cost_Expense_ID FROM COST_EXPENSE WHERE Cost_Expense_Code = @ExpenseElement
	IF (@ExpenseElementId < 0) AND (ISNULL(@ExpenseElement,'')<>'')
	BEGIN
	   INSERT COST_EXPENSE (Cost_Expense_Code, Cost_Expense_Desc)
			VALUES(@ExpenseElement, @ExpenseElement)
	   SET @ExpenseElementId = SCOPE_IDENTITY()
	END
END
-- Add Eqp Category if it's a new one
DECLARE @EqpCategoryId int
SELECT @EqpCategoryId = Eqp_Category_Id FROM EQP_CATEGORY WHERE Eqp_Category_Code = @EqpCategory
IF (@EqpCategoryId IS NULL) AND (ISNULL(@EqpCategory,'')<>'')
BEGIN
   INSERT EQP_CATEGORY (Eqp_Category_Code, Eqp_Category_Desc)
		VALUES(@EqpCategory, @EqpCategory)
   SET @EqpCategoryId = SCOPE_IDENTITY()
END

/*VV #4142 DECLARE @Cost_Centre_ID int*/
IF ISNULL(@Cost_Centre_ID,0)=0
BEGIN
	IF ISNULL(@CostCentre,'')=''
		SELECT @Cost_Centre_ID=epl.Cost_Centre_ID
		FROM tblWorkOrders wo
			LEFT JOIN tblEqpPlans epl ON epl.EqpPlanId=wo.EqpPlanId
		WHERE wo.WorkOrderId=@WorkOrderId
	ELSE
	BEGIN
		SELECT @Cost_Centre_ID=Cost_Centre_ID
		FROM COST_CENTRE
		WHERE Cost_Centre_Code LIKE @CostCentre

		IF @Cost_Centre_ID IS NULL
		BEGIN
			INSERT COST_CENTRE (Cost_Centre_Code, Cost_Centre_Desc)
			VALUES (@CostCentre, @CostCentre)
			SET @Cost_Centre_ID = SCOPE_IDENTITY()
		END
	END
END

DECLARE @Work_Group_Id INT
DECLARE @SiteId INT
SET @Work_Group_Id = NULL
SET @SiteId = NULL

SET @WorkGroup = NULLIF(@WorkGroup, '')
SET @WorkGroupSite = NULLIF(@WorkGroupSite, '')

IF @WorkGroupSite IS NULL AND @WorkGroup IS NOT NULL
BEGIN
	SELECT	@WorkGroupSite = st.Site
	FROM	tblWorkOrders 
			LEFT JOIN   tblEqpPlans ON tblEqpPlans.EqpPlanId = tblWorkOrders.EqpPlanId
			LEFT JOIN   tblFleets ON tblFleets.FleetId = tblEqpPlans.FleetId 
			LEFT JOIN tblSites st ON st.SiteId = tblFleets.SiteId
	WHERE	tblWorkOrders.WorkOrderId = @WorkOrderId
	IF @WorkGroupSite IS NULL
		SET @WorkGroup = NULL
END
IF @WorkGroup IS NOT NULL
BEGIN
	SELECT	@Work_Group_Id = Work_Group_ID
	FROM	WORK_GROUP wg
			LEFT JOIN tblSites st ON st.SiteId = wg.Site_ID
	WHERE	wg.Work_Group_Code = @WorkGroup AND st.Site = @WorkGroupSite
	IF @Work_Group_Id IS NULL
	BEGIN
		SELECT	@SiteId = SiteId
		FROM	tblSites
		WHERE	Site = @WorkGroupSite
		IF @SiteId IS NULL
		BEGIN
			DECLARE @DefaultBranchId INT
			SELECT	TOP 1 @DefaultBranchId = BranchId
			FROM	tblBranches
			WHERE	Default_Record = 1
			IF @DefaultBranchId IS NULL
			BEGIN
				RAISERROR('Default branch is not set.', 16, 1)
				RETURN
			END
			INSERT	tblSites(BranchId, Site)
			VALUES	(@DefaultBranchId, @WorkGroupSite)
			SET @SiteId = SCOPE_IDENTITY()
		END
		INSERT INTO WORK_GROUP ([Description], Work_Group_Code, Site_ID)
		VALUES (@WorkGroup, @WorkGroup, @SiteId)
		SET @Work_Group_Id = SCOPE_IDENTITY()
	END
END

-- 1. INSERT
INSERT INTO 
tblWorkOrderSettlements 
(WorkOrderId,
 WBSElement,
 CostCentre,
 CostBearerId,
 SettlementRule,
 ReceiverCategory,
 PercentParts,
 PercentLabour,
 PercentMisc,
 Cost_Centre_ID,
 Cost_Expense_ID,
 Eqp_Category_Id,
 Work_Group_Id) 
VALUES 
(@WorkOrderId,
 @WBSElement,
 @CostCentre,
 @CostBearerId,
 @SettlementRule,
 @ReceiverCategory,
 @PercentParts,
 @PercentLabour,
 @PercentMisc,
 @Cost_Centre_ID,
 CASE WHEN @ExpenseElementId<0 THEN NULL ELSE @ExpenseElementId END,
 @EqpCategoryId,
 @Work_Group_Id)

--2. Return Id
SET @NewWOSettlemetId = SCOPE_IDENTITY()


RETURN

GO

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[usp_Update_WO_Settlement]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[usp_Update_WO_Settlement]

GO

create Procedure [dbo].[usp_Update_WO_Settlement]
/******************************************************************************
	File: usp_Update_WO_Settlement.sql
	Name: usp_Update_WO_Settlement

	Called By: WOSettlementPut.cls

	Desc: 1. Update Work Order Settlement
             

	Auth: Marilena Tucci
	Date: 01-MAY-2002
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	 9 May 12	V Vasylyeva #4242 @Cost_Centre_ID, @ExpenseElementId
	16 Nov 07	V Vasylyeva	Increased the lenth of @ExpenseElement to the lenth of COST_EXPENSE.Cost_Expense_Code varchar(10)
	24/05/06	AL		Mod for Cost Centre and Expense Element
	03 Oct 06	KN		Commented PRINT Statement
*******************************************************************************/
	/* Param List */
	@WOSettlemetId int,
	@WorkOrderId int,
	@WBSElement varchar(50),
    @CostCentre varchar(50),
    @CostBearerId int,
	@SettlementRule varchar(50),
	@ReceiverCategory varchar(50),
    @PercentParts float,
	@PercentLabour float,
	@PercentMisc float,
	@ExpenseElement varchar(10)=null,
	/*VV #4142*/ 
	@Cost_Centre_ID int =NULL,
	@ExpenseElementId int =NULL

AS
/* Local procedure variables */ 


--#### 
/*VV #4142* DECLARE @ExpenseElementId int,@Cost_Centre_ID int */
IF ISNULL(@ExpenseElementId,0)=0 SELECT @ExpenseElementId = Cost_Expense_ID FROM COST_EXPENSE WHERE Cost_Expense_Code = @ExpenseElement
IF ISNULL(@Cost_Centre_ID,0)=0 SELECT @Cost_Centre_ID=Cost_Centre_ID FROM COST_CENTRE WHERE Cost_Centre_Code LIKE @CostCentre

--print convert(varchar,@Cost_Centre_ID) + ', ' + convert(varchar,@ExpenseElementId)

-- 1. UPDATE
UPDATE 
tblWorkOrderSettlements 
SET
WorkOrderId=@WorkOrderId,
WBSElement=@WBSElement,
CostCentre=@CostCentre,
CostBearerId=@CostBearerId,
SettlementRule=@SettlementRule,
ReceiverCategory=@ReceiverCategory,
PercentParts=@PercentParts,
PercentLabour=@PercentLabour,
PercentMisc=@PercentMisc,
Cost_Centre_ID=@Cost_Centre_ID,
Cost_Expense_ID=@ExpenseElementId
WHERE WorkOrderSettlementId=@WOSettlemetId




GO

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[WORK_ORDER_ADD_INTERNAL_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[WORK_ORDER_ADD_INTERNAL_P]

GO

create  PROCEDURE WORK_ORDER_ADD_INTERNAL_P
/******************************************************************************
	File: 
	Name: WORK_ORDER_ADD_INTERNAL_P

	Called By: AmtData

	Desc: Creates an internal AMT work order and returns the new ID
	      
             

	Auth: Darryl Smith
	Date: 6-Mar-2005
*******************************************************************************
		Change History
*******************************************************************************
Date:		Author:		Description:
--------	--------	----------------------------------------
 8 May 2012	V Vasylyeva	#4142 @Cost_Centre_ID, @ExpenseElementId
15 Dec 2011 V Vasylyeva #3125 Error because of the duplicate workorder numbers  

29 Nov 2006	V Vasylyeva	SET @TypeReal=1
28 Nov 2006	V Vasylyeva	Added error raising if workorder is added to non-real equipment				
19-Sep-2006	ID		Commented the inserting records into tblUnlinkedWO table 
05 Apr 2005	S Babeshko	Add WOJob_Status_ID parameter
27 Apr 2005 S Ivanov	Add a check for existing work order number
17 May 2005	S Babeshko	Add @AMTUsageAmount parameter
07 Jun 2005	D Smith		If customer cannot be found, set ID to NULL
24 May 2006	A Lassauniere	Add Cost Centre and Expense Element
*******************************************************************************/
	/* Param List */
	@pWONumber VARCHAR(50) = 'AMT',
	@pJobDate DATETIME = '3-Mar-2005',
	@pDescription VARCHAR(50) = 'Test description',
	@pEqpPlanID INT = 1000000,
	@pProjTaskId INT = 0,
	@pComponentCodeID INT = 161,
	@pModifierCodeID INT = 0,
	@pTaskCounterID INT = 0,
	@pTaskTypeID INT = 0,
	@pOccurrenceTypeID INT = 0,
	@pJobCodeID INT = 0,
	@pCostBearerID INT = 1,
	@pCostMode INT = 2, --0 = Enter cost, calculate sell; 1 = Enter sell, calculate cost; 2 = Enter cost and sell
	@pPartsCost FLOAT = 1,
	@pLabourCost FLOAT = 2,
	@pMiscCost FLOAT = 3,
	@pPartsSell FLOAT = 5,
	@pLabourSell FLOAT = 6,
	@pMiscSell FLOAT = 7,
	@pLabourHours FLOAT = 8,
	@pDurationHours FLOAT = 9,
	@WOJob_Status_ID INT = 0,
	@AMTUsageAmount FLOAT = 0,
	@pCostCentre varchar(50)='',
	@pCostExpense varchar(50)='',
	/*VV #4142*/ 
	@Cost_Centre_ID int =NULL,
	@ExpenseElementId int =NULL
AS
	DECLARE @Serial_Number VARCHAR(50)
	DECLARE @Branch_Id INT
	DECLARE @Generation_Counter VARCHAR(50)
	DECLARE @WorkOrderId INT
	DECLARE @Op_Id INT
	DECLARE @St_Id INT
	DECLARE @In_Id INT
	DECLARE @PrimaryCurrencyId INT
	DECLARE @CustomerId INT
	DECLARE @FinancialPeriod INT
	DECLARE @TypeReal int

	SET @TypeReal=1

	SET @CustomerId = 0
	

	--look up the serial number and branch...
	SELECT
		@Serial_Number = SerialNumber,
		@Branch_Id = BranchId
	FROM
		tblEquipment INNER JOIN tblEqpPlans ON tblEquipment.EquipmentId = tblEqpPlans.EquipmentId
		INNER JOIN tblFleets ON tblEqpPlans.FleetId = tblFleets.FleetId
		INNER JOIN tblSites ON tblFleets.SiteId = tblSites.SiteId
	WHERE
		tblEqpPlans.EqpPlanId = @pEqpPlanId AND Equipment_Type_Id=@TypeReal


	IF @Serial_Number IS NULL
	BEGIN
		RAISERROR ('Work Order cannot be created for this equipment.', 16, 1)
		RETURN
	END

	IF (@pWONumber = 'AMT')
	BEGIN
		/*VV #3125 Update first then select*/
		
		--Increment counter before generating Workorder Number
		UPDATE AMT_VARIABLE SET Work_Order_Generation_Counter = Work_Order_Generation_Counter + 1
			
		--generate a work order number
		SELECT @Generation_Counter = CAST(Work_Order_Generation_Counter as varchar(50)) 
		FROM AMT_VARIABLE

		SET @pWONumber = 'AMT' + REPLICATE('0', 7 - DATALENGTH(@Generation_Counter))	+ @Generation_Counter
		
	END
	ELSE
		IF (EXISTS(	SELECT WorkOrderId
				FROM dbo.tblWorkOrders
				WHERE WorkOrderNumber = @pWONumber))
		BEGIN
			RAISERROR ('The work order number already exists. Please choose another one.', 16, 1)
			RETURN
		END

	IF (@pProjTaskId <> 0)
	BEGIN
		SELECT
			@pComponentCodeId = ComponentCodeId,
			@pModifierCodeId = ModifierId,
			@pTaskCounterId = ApplicationCodeId,
			@pTaskTypeId = TaskTypeId
		FROM
			tblProjTasks
		WHERE
			ProjTaskId = @pProjTaskId
	END
	SET @AMTUsageAmount = (CASE WHEN @AMTUsageAmount < 0 THEN 0 ELSE @AMTUsageAmount END)
	--add the work order record...
	EXEC usp_Add_WorkOrder @WorkOrderNumber = @pWONumber,
				@AmtStartDate = @pJobDate,
				@EqpPlanId = @pEqpPlanID,
				@SerialNumber = @Serial_Number,
				@ComponentSerialNumber = NULL,
				@CustomerId = 0,
				@Plant = NULL,
				@BranchId = @Branch_Id,
				@CurrencyId = 1,
				@ExchangeRate = 1,
				@MaintenancePlanNumber = NULL,
				@MaintenancePlanItemNumber = NULL,
				@MaintPlanCallNumber = 0,
				@ParentWorkOrderId = 0, --NOTE: set to work order Id (below)
				@ComponentCodeId = @pComponentCodeID,
				@ModifierId = @pModifierCodeID,
				@TaskTypeId = @pTaskTypeID,
				@ApplicationCodeId = @pTaskCounterID,
				@OccurrenceTypeId = @pOccurrenceTypeID,
				@JobCodeId = @pJobCodeID,
				@Changeout = 0,
				@WorkActivityCode = NULL,
				@PMActivityTypeId = NULL,
				@AMTParentWorkOrderId = 0, --NOTE: set to work order Id (below)
				@AMTComponentCodeId = @pComponentCodeID,
				@AMTModifierId = @pModifierCodeID,
				@AMTJobCodeId = @pJobCodeID,
				@AMTTaskTypeId = @pTaskTypeID,
				@AMTApplicationCodeId = @pTaskCounterID,
				@AMTOccurrenceTypeId = @pOccurrenceTypeID,
				@AMTChangeout = 0,
				@PricedJobId = 0,
				@CurrentWorkOrder = 1,
				@ArchivedWorkOrder = 0,
				@CreatedInAMT = 1,
				@AMTWorkOrderStatusId = 2,
				@AMTUsageAmount = @AMTUsageAmount,
				@UserId = 0,
				@NewWorkOrderId = @WorkOrderId output,
				@WOJob_Status_ID = @WOJob_Status_ID
	UPDATE
		tblWorkOrders
	SET
		ParentWorkOrderId = @WorkOrderId,
		AMTParentWorkOrderId = @WorkOrderId,
		WO_Description = @pDescription ---,		AmtStartDate = @pJobDate
	WHERE
		WorkOrderId = @WorkOrderId

	IF @pCostMode = 0 -- calc sell from cost
	BEGIN
		EXEC usp_Add_WO_Operation @WorkOrderId = @WorkOrderId,
						@WorkOrderStatusId = 2,
						@ComponentCodeId = @pComponentCodeID,
						@ModifierCodeId = @pModifierCodeID,
						@TaskTypeId = @pTaskTypeID,
					        @ApplicationCodeId = @pTaskCounterID,
						@JobCodeId = @pJobCodeID,
						@PlannedLabourHours = @pLabourHours,
						@PlannedDurationHours = @pDurationHours,
					        @ActualLabourHours = @pLabourHours,
						@ActualDurationHours = @pDurationHours,
						@PartsCost = @pPartsCost,
						@LabourCost = @pLabourCost,
						@MiscCost = @pMiscCost,
					        @PartsSell = @pPartsSell,
						@LabourSell = @pLabourSell,
						@MiscSell = @pMiscSell,
						@NewWOOperationId = @Op_Id OUTPUT,
						@calcSellVals = 1
	END
	ELSE IF @pCostMode = 1 -- calc cost from sell
	BEGIN
		EXEC usp_Add_WO_Operation @WorkOrderId = @WorkOrderId,
						@WorkOrderStatusId = 2,
						@ComponentCodeId = @pComponentCodeID,
						@ModifierCodeId = @pModifierCodeID,
						@TaskTypeId = @pTaskTypeID,
					        @ApplicationCodeId = @pTaskCounterID,
						@JobCodeId = @pJobCodeID,
						@PlannedLabourHours = @pLabourHours,
						@PlannedDurationHours = @pDurationHours,
					        @ActualLabourHours = @pLabourHours,
						@ActualDurationHours = @pDurationHours,
						@PartsCost = @pPartsCost,
						@LabourCost = @pLabourCost,
						@MiscCost = @pMiscCost,
					        @PartsSell = @pPartsSell,
						@LabourSell = @pLabourSell,
						@MiscSell = @pMiscSell,
						@NewWOOperationId = @Op_Id OUTPUT,
						@calcCostVals = 1
	END
	ELSE IF @pCostMode = 2 -- enter cost and sell
	BEGIN
		EXEC usp_Add_WO_Operation @WorkOrderId = @WorkOrderId,
						@WorkOrderStatusId = 2,
						@ComponentCodeId = @pComponentCodeID,
						@ModifierCodeId = @pModifierCodeID,
						@TaskTypeId = @pTaskTypeID,
					        @ApplicationCodeId = @pTaskCounterID,
						@JobCodeId = @pJobCodeID,
						@PlannedLabourHours = @pLabourHours,
						@PlannedDurationHours = @pDurationHours,
					        @ActualLabourHours = @pLabourHours,
						@ActualDurationHours = @pDurationHours,
						@PartsCost = @pPartsCost,
						@LabourCost = @pLabourCost,
						@MiscCost = @pMiscCost,
					        @PartsSell = @pPartsSell,
						@LabourSell = @pLabourSell,
						@MiscSell = @pMiscSell,
						@NewWOOperationId = @Op_Id OUTPUT
		
	END

	EXEC usp_Add_WO_Settlement @WorkOrderId = @WorkOrderId,
					@WBSElement = '',
					@CostCentre = @pCostCentre,
					@CostBearerId = @pCostBearerId,
					@ExpenseElement=@pCostExpense,
					@SettlementRule = '',
					@ReceiverCategory = '',
					@PercentParts = 100,
					@PercentLabour = 100,
					@PercentMisc = 100,
					@NewWOSettlemetId = @St_Id OUTPUT,
					/*VV #4142*/
					@Cost_Centre_ID =@Cost_Centre_ID,
					@ExpenseElementId =@ExpenseElementId


	SELECT @PrimaryCurrencyId = CurrencyId FROM tblCurrencies WHERE ISNULL(PrimaryCurr, 0) <> 0
	SELECT
		@CustomerId = CustomerId
	FROM
		tblContracts
	INNER JOIN tblEqpPlans ON tblContracts.ContractId = tblEqpPlans.ContractId
	WHERE
		EqpPlanId = @pEqpPlanId

	IF @CustomerId = 0
	BEGIN
		SET @CustomerId = NULL
	END

	EXEC usp_Add_WO_Invoice @WorkOrderId = @WorkOrderId,
					@CostBearerId = @pCostBearerId,
					@CurrencyId = @PrimaryCurrencyId,
					@InvoiceDate = @pJobDate,
				        @PartsSell = @pPartsSell,
					@LabourSell = @pLabourSell,
					@MiscSell = @pMiscSell,
					@ExchangeRate = 1,
					@FinancialPeriod = 200503, --TODO: look up financial period
					@WBSElement = '',
					@CostCentre = '',
					@CustomerId = @CustomerId,	
					@InvoiceNumber = 'AMTINV', --TODO: is this a good invoice number?
					@NewWOInvoiceId = @In_Id OUTPUT,
					@isDebitMemo = 0

GO

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[WORK_ORDER_UPDATE_INTERNAL_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[WORK_ORDER_UPDATE_INTERNAL_P]

GO

create  PROCEDURE [dbo].[WORK_ORDER_UPDATE_INTERNAL_P]
/******************************************************************************
	File: 
	Name: WORK_ORDER_UPDATE_INTERNAL_P

	Called By: AmtData

	Desc: Updates an internal AMT work order
	      
             

	Auth: Darryl Smith
	Date: 6-Mar-2005
*******************************************************************************
		Change History
*******************************************************************************
Date:		Author:		Description:
--------	--------	----------------------------------------
17 May 2005	S Babeshko	Add @AMTUsageAmount parameter
05 Apr 2005	S Babeshko	Add WOJob_Status_ID parameter
24 May 2006	A Lassauniere	Add Cost Centre and Expense Element
21 Aug 2006	V Vasylyeva	Customer can be null
 6 Aug 2007	V Vasylyeva	Do not update workorder if it is linked to EQS task
 6 Sep 2007	V Vasylyeva	Do not raise error
 5 Feb 2007	V Vasylyeva	Update wo if it is linked to EQS task then relink the wo to the task
 9 May 12	V Vasylyeva #4242 @Cost_Centre_ID, @ExpenseElementId
*******************************************************************************/
	/* Param List */
	@pWOId INT = 1060961,
	@pWONumber VARCHAR(50) = 'AMT1234567',
	@pJobDate DATETIME = '3-Mar-2005',
	@pDescription VARCHAR(50) = 'Test description',
	@pEqpPlanID INT = 1000000,
	@pProjTaskId INT = 0,
	@pComponentCodeID INT = 161,
	@pModifierCodeID INT = 0,
	@pTaskCounterID INT = 0,
	@pTaskTypeID INT = 0,
	@pOccurrenceTypeID INT = 0,
	@pJobCodeID INT = 0,
	@pCostBearerID INT = 1,
	@pCostMode INT = 2, --0 = Enter cost, calculate sell; 1 = Enter sell, calculate cost; 2 = Enter cost and sell
	@pPartsCost FLOAT = 1,
	@pLabourCost FLOAT = 2,
	@pMiscCost FLOAT = 3,
	@pPartsSell FLOAT = 5,
	@pLabourSell FLOAT = 6,
	@pMiscSell FLOAT = 7,
	@pLabourHours FLOAT = 8,
	@pDurationHours FLOAT = 9,
	@WOJob_Status_ID INT = 0,
	@AMTUsageAmount FLOAT = 0,
	@pCostCentre varchar(50)='',
	@pCostExpense varchar(50)='',
	/*VV #4142*/ 
	@Cost_Centre_ID int =NULL,
	@ExpenseElementId int =NULL
AS

	DECLARE @Serial_Number VARCHAR(50)
	DECLARE @Branch_Id INT
	DECLARE @Generation_Counter VARCHAR(50)
	DECLARE @Op_Id INT
	DECLARE @St_Id INT
	DECLARE @In_Id INT
	DECLARE @PrimaryCurrencyId INT
	DECLARE @CustomerId INT
	DECLARE @FinancialPeriod INT

--5-Feb-2008 V Vasylyeva
--	IF EXISTS(SELECT Work_Order_Id FROM TASK WHERE Work_Order_Id=@pWOId)
--	BEGIN
--		--RAISERROR ('Workorder is linked to equipment status task.', 16, 1)
--		RETURN
--	END

	SELECT @Op_Id = WorkOrderOpId FROM tblWorkOrderOperations WHERE WorkOrderId = @pWOId
	SELECT @In_Id = WorkOrderInvoiceId FROM tblWorkOrderInvoices WHERE WorkOrderId = @pWOId
	SELECT @St_Id = WorkOrderSettlementId FROM tblWorkOrderSettlements WHERE WorkOrderId = @pWOId

	--21 Aug 2006	V Vasylyeva	
	--SET @CustomerId = 0

	SELECT @PrimaryCurrencyId = CurrencyId FROM tblCurrencies WHERE ISNULL(PrimaryCurr, 0) <> 0
	SELECT
		@CustomerId = CustomerId
	FROM
		tblContracts
	INNER JOIN tblEqpPlans ON tblContracts.ContractId = tblEqpPlans.ContractId
	WHERE
		EqpPlanId = @pEqpPlanId

	--look up the serial number and branch...
	SELECT
		@Serial_Number = SerialNumber,
		@Branch_Id = BranchId
	FROM
		tblEquipment INNER JOIN tblEqpPlans ON tblEquipment.EquipmentId = tblEqpPlans.EquipmentId
		INNER JOIN tblFleets ON tblEqpPlans.FleetId = tblFleets.FleetId
		INNER JOIN tblSites ON tblFleets.SiteId = tblSites.SiteId
	WHERE
		EqpPlanId = @pEqpPlanId

	IF (@pProjTaskId <> 0)
	BEGIN
		SELECT
			@pComponentCodeId = ComponentCodeId,
			@pModifierCodeId = ModifierId,
			@pTaskCounterId = ApplicationCodeId,
			@pTaskTypeId = TaskTypeId
		FROM
			tblProjTasks
		WHERE
			ProjTaskId = @pProjTaskId
	END

	--add the work order record...
	EXEC usp_Update_AMTWorkOrder @WorkOrderId = @pWOId,
				@WorkOrderNumber = @pWONumber,
        		@WorkOrderTypeId = null, --TODO: what is this?
				@WorkOrderStatusId = null,
		        @AmtStartDate = @pJobDate,
    			@EqpPlanId = @pEqpPlanID,
				@SerialNumber = @Serial_Number, 
				@ComponentSerialNumber = '',
				@CustomerId = @CustomerId, 
				@Plant = '', 
				@BranchId = @Branch_Id,
				@CurrencyId = @PrimaryCurrencyId, 
				@ExchangeRate = 1,
				@MaintenancePlanNumber = null,
				@MaintenancePlanItemNumber = null,
				@MaintPlanCallNumber = null,
				@PMActivityTypeId = null,
				@AMTComponentCodeId = @pComponentCodeId,
				@AMTModifierId = @pModifierCodeId,
				@AMTJobCodeId = @pJobCodeId,
				@AMTTaskTypeId = @pTaskTypeId,
				@AMTApplicationCodeId = @pTaskCounterId,
				@AMTOccurrenceTypeId = @pOccurrenceTypeId,
				@PricedJobId = null,
				@AMTWorkOrderStatusId = 2, 
				@AMTUsageAmount = @AMTUsageAmount,
				@WOJob_Status_ID = @WOJob_Status_ID,				
				@CheckEQSLink=0 /*VV 5 Feb 08*/

	UPDATE
		tblWorkOrders
	SET
		WO_Description = @pDescription ---,		AmtStartDate = @pJobDate
	WHERE
		WorkOrderId = @pWOId

	--TODO: get @Op_Id of the existing operation record...

	IF @pCostMode = 0 -- calc sell from cost
	BEGIN
		EXEC usp_Update_WO_Operation @WorkOrderOpId = @Op_Id, @WorkOrderId = @pWOId,
						@WorkOrderStatusId = 2,
						@ComponentCodeId = @pComponentCodeID,
						@ModifierCodeId = @pModifierCodeID,
						@TaskTypeId = @pTaskTypeID,
					        @ApplicationCodeId = @pTaskCounterID,
						@JobCodeId = @pJobCodeID,
						@PlannedLabourHours = @pLabourHours,
						@PlannedDurationHours = @pDurationHours,
					        @ActualLabourHours = @pLabourHours,
						@ActualDurationHours = @pDurationHours,
						@PartsCost = @pPartsCost,
						@LabourCost = @pLabourCost,
						@MiscCost = @pMiscCost,
					        @PartsSell = @pPartsSell,
						@LabourSell = @pLabourSell,
						@MiscSell = @pMiscSell,
						@calcSellVals = 1
	END
	ELSE IF @pCostMode = 1 -- calc cost from sell
	BEGIN
		EXEC usp_Update_WO_Operation @WorkOrderOpId = @Op_Id, @WorkOrderId = @pWOId,
						@WorkOrderStatusId = 2,
						@ComponentCodeId = @pComponentCodeID,
						@ModifierCodeId = @pModifierCodeID,
						@TaskTypeId = @pTaskTypeID,
					        @ApplicationCodeId = @pTaskCounterID,
						@JobCodeId = @pJobCodeID,
						@PlannedLabourHours = @pLabourHours,
						@PlannedDurationHours = @pDurationHours,
					        @ActualLabourHours = @pLabourHours,
						@ActualDurationHours = @pDurationHours,
						@PartsCost = @pPartsCost,
						@LabourCost = @pLabourCost,
						@MiscCost = @pMiscCost,
					        @PartsSell = @pPartsSell,
						@LabourSell = @pLabourSell,
						@MiscSell = @pMiscSell,
						@calcCostVals = 1
	END
	ELSE IF @pCostMode = 2 -- enter cost and sell
	BEGIN
		EXEC usp_Update_WO_Operation @WorkOrderOpId = @Op_Id, @WorkOrderId = @pWOId,
						@WorkOrderStatusId = 2,
						@ComponentCodeId = @pComponentCodeID,
						@ModifierCodeId = @pModifierCodeID,
						@TaskTypeId = @pTaskTypeID,
					        @ApplicationCodeId = @pTaskCounterID,
						@JobCodeId = @pJobCodeID,
						@PlannedLabourHours = @pLabourHours,
						@PlannedDurationHours = @pDurationHours,
					        @ActualLabourHours = @pLabourHours,
						@ActualDurationHours = @pDurationHours,
						@PartsCost = @pPartsCost,
						@LabourCost = @pLabourCost,
						@MiscCost = @pMiscCost,
					        @PartsSell = @pPartsSell,
						@LabourSell = @pLabourSell,
						@MiscSell = @pMiscSell
		
	END

	--TODO: get @St_Id of the existing settlement record...

	EXEC usp_Update_WO_Settlement @WOSettlemetId = @St_Id,
					@WorkOrderId = @pWOId,
					@WBSElement = '',
					@CostCentre = @pCostCentre,
					@CostBearerId = @pCostBearerId,
					@ExpenseElement=@pCostExpense,
					@SettlementRule = '',
					@ReceiverCategory = '',
					@PercentParts = 100,
					@PercentLabour = 100,
					@PercentMisc = 100,
					/*VV #4142*/
					@Cost_Centre_ID =@Cost_Centre_ID,
					@ExpenseElementId =@ExpenseElementId

	--TODO: get @In_Id of the existing invoice record...

	EXEC usp_Update_WO_Invoice @WOInvoiceId = @In_Id,
					@WorkOrderId = @pWOId,
					@CostBearerId = @pCostBearerId,
					@CurrencyId = @PrimaryCurrencyId,
					@InvoiceDate = @pJobDate,
				    @PartsSell = @pPartsSell,
					@LabourSell = @pLabourSell,
					@MiscSell = @pMiscSell,
					@ExchangeRate = 1,
					@FinancialPeriod = 200503, --TODO: look up financial period
					@WBSElement = '',
					@CostCentre = '',
					@CustomerId = @CustomerId,	
					@InvoiceNumber = 'AMTINV', --TODO: is this a good invoice number?
					@DummyInvoice = 0
					

--VV 5-Frb-2008
--Relink workorder to EQS task if required
DECLARE @TaskId varchar(8000)
DECLARE @Message varchar(8000)

SELECT @TaskId=Task_Id FROM TASK WHERE Work_Order_Id=@pWOId

IF ISNULL(@TaskId,'')<>''
BEGIN
	EXEC TASK_WORK_ORDER_LINK_MULTI_P @TasksID =@TaskId,@Message=@Message OUTPUT 
	IF ISNULL(@Message,'')<>''
	BEGIN
		RAISERROR (@Message, 16, 1)
	END
END
	

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TASK_OPERATION_DELETE_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[TASK_OPERATION_DELETE_P]

GO

create Procedure [dbo].[TASK_OPERATION_DELETE_P]
/******************************************************************************
	Name: TASK_OPERATION_DELETE_P

	Called By: 

	Desc: 1. Delete Task Operations

	Auth: Veronika Vasylyeva
	Date: 24-May-2007
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	09 May 12	K Nagarajan	4158: Change Varchar(8000) to Max
	14 Feb 11	V Vasylyeva	AmtMobile added EW_WORKORDER_DELETE_P
	15/05/09	AL			CR7821: revamped to delete related records
	04/04/09	AL			CR7970: workorder renaming
    14/06/07	AL			Added EventID
*******************************************************************************/
	/* Param List */

@idDelete varchar(MAX)='',
@TaskId int=0,
@Message varchar(2000)=Null OUTPUT,
@EventID int=0
    
AS

SET @Message=''

--1: get a list of TOP IDs
CREATE TABLE #TOP (TaskOperationID int PRIMARY KEY)

IF @TaskId>0
BEGIN
	INSERT INTO #TOP(TaskOperationID)
	SELECT	Task_Operation_Id
	FROM	TASK_OPERATION
	WHERE	Task_Id=@TaskId
END
ELSE IF @EventID>0
BEGIN
	INSERT INTO #TOP(TaskOperationID)
	SELECT	TOPR.Task_Operation_Id
	FROM	TASK_OPERATION TOPR INNER JOIN
			TASK T ON TOPR.Task_Id = T.Task_ID
	WHERE	T.Event_ID=@EventID
END
ELSE
BEGIN
	INSERT INTO #TOP(TaskOperationID)
	SELECT	TOPR.Task_Operation_Id
	FROM	TASK_OPERATION TOPR INNER JOIN
			dbo.LIST_TO_TABLE_F(@idDelete) LTT ON TOPR.Task_Operation_Id=LTT.list_item
END

--2: delete records
DELETE TOPRP
FROM	TASK_OPERATION_PART TOPRP INNER JOIN
		#TOP TOPR ON TOPRP.Task_Operation_Id=TOPR.TaskOperationID

DELETE TOPRL
FROM	TASK_OPERATION_LABOUR TOPRL INNER JOIN
		#TOP TOPR ON TOPRL.Task_Operation_Id=TOPR.TaskOperationID

DELETE TOPRM
FROM	TASK_OPERATION_MISC TOPRM INNER JOIN
		#TOP TOPR ON TOPRM.Task_Operation_Id=TOPR.TaskOperationID
		
IF EXISTS(SELECT * FROM EW_WORKORDER WHERE TaskOperationId IN(SELECT TaskOperationID FROM #TOP))
BEGIN
	DECLARE @EWWorkorderId varchar(max)
	
	SET @EWWorkorderId=''

	SELECT @EWWorkorderId = (SELECT CAST(EWWorkorderId AS varchar)+',' FROM
	EW_WORKORDER WHERE TaskOperationId IN(SELECT TaskOperationID FROM #TOP)
		 FOR XML PATH('') )

	SET @EWWorkorderId=ISNULL(@EWWorkorderId,'')
	IF @EWWorkorderId<>''
	BEGIN
		EXEC EW_WORKORDER_DELETE_P @idDelete=@EWWorkorderId,@Message=@Message OUTPUT
		
		If @Message<>'' RETURN
	
	END
END

DELETE TOPR
FROM	TASK_OPERATION TOPR INNER JOIN
		#TOP ON TOPR.Task_Operation_Id=#TOP.TaskOperationID

IF @@ERROR<>0
	SET @Message='Could not delete workorder operation'

DROP TABLE #TOP


GO

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[ACTUAL_USAGE_REVALIDATE_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[ACTUAL_USAGE_REVALIDATE_P]
GO

create Procedure [dbo].[ACTUAL_USAGE_REVALIDATE_P]
/******************************************************************************
	File: ACTUAL_USAGE_REVALIDATE_P.sql
	Name: 

	Called By: usp_Add_ActualUsage, USAGE_READING_ADD_P

	Desc: 

	Auth: Alex Lassauniere
	Date: 12-Feb-2010
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------	
	01/03/10	AL			reset output params
	03/03/10	AL			CR8823: do not delete start usages
    24/01/12    GD          Fixed 3376
    8 May 12	V Vasylyeva	#4134 duplicate actual usages are created if 
							there are duplicate lines inh the import file
*******************************************************************************/
	/* Param List */
	@ActionXML varchar(MAX)

AS
-----------------------------
	--Load temp table
	CREATE TABLE #I_USAGE_REVAL(
		EquipmentId int, 
		QUOMId int,
		RecordingDate varchar(21) COLLATE database_default ,
		PRIMARY KEY (EquipmentId,QUOMId)
	)

	DECLARE @idoc int
	EXEC sp_xml_preparedocument @idoc OUTPUT, @ActionXML

	INSERT #I_USAGE_REVAL(EquipmentId,QUOMId,RecordingDate)
	SELECT EquipmentId,QUOMId,RecordingDate
	FROM OPENXML (@idoc, '/rows/row',1) WITH #I_USAGE_REVAL iur
    --GD 3376
    WHERE  QUOMId IS NOT NULL 
  
	EXEC sp_xml_removedocument @idoc




	--AL: 16/11/09
	DECLARE @InvalidActualUsageId int,@InvalidRecordingDate datetime,@InvalidOffset float,
			@InvalidRecordedUsage float,@IsValid bit,@ExceedsProjectedUsage bit,
			@EquipmentId int, @QUOMId int
			
	/*VV #4134*/
	DECLARE @CreatedInAMT int,@StartUsageEqpPlanId int,@EquipmentNo VARCHAR(50),@System_Source VARCHAR(10)

	--Invalidate all future records
	INSERT INTO tblInvalidActualUsages
		(EquipmentId, QUOMId, RecordedUsage, Offset, ActualUsage, RecordingDate, 
		 CreatedByUserId, CreateDate, LastModByUserId, LastModDate, 
		 CreatedInAMT, ExceedsProjectedUsage, StartUsageEqpPlanId,
		 /*VV #4134*/EquipmentNo,System_Source)
	SELECT AU.EquipmentId,AU.QUOMId,AU.RecordedUsage,AU.Offset,AU.ActualUsage,AU.RecordingDate,
		   AU.CreatedByUserId,AU.CreateDate,AU.LastModByUserId,AU.LastModDate,
		   AU.CreatedInAMT,AU.ExceedsProjectedUsage,AU.StartUsageEqpPlanId,
		   /*VV #4134*/AU.EquipmentNo,AU.System_Source
	FROM 
			tblActualUsages AU INNER JOIN
			#I_USAGE_REVAL UR ON AU.EquipmentId=UR.EquipmentId
								AND AU.QUOMId=UR.QUOMId
								AND AU.RecordingDate>UR.RecordingDate
	 
	DELETE AU
	FROM 
			tblActualUsages AU INNER JOIN
			#I_USAGE_REVAL UR ON AU.EquipmentId=UR.EquipmentId
								AND AU.QUOMId=UR.QUOMId
								AND AU.RecordingDate>UR.RecordingDate
								AND isnull(AU.StartUsageEqpPlanId, 0) = 0	--AL: 03/03/10


	--Check if Invalid Records into Date Range are now valid
	DECLARE cInvalidReading CURSOR READ_ONLY FOR
	SELECT  AU.EquipmentId,AU.QUOMId,
			AU.ActualUsageId, AU.RecordingDate, AU.RecordedUsage, AU.Offset,
			/*VV #4134*/AU.CreatedInAMT,AU.StartUsageEqpPlanId,
			AU.EquipmentNo,AU.System_Source
	FROM         
		tblInvalidActualUsages AU INNER JOIN
		#I_USAGE_REVAL UR ON AU.EquipmentId=UR.EquipmentId
							AND AU.QUOMId=UR.QUOMId
							AND AU.RecordingDate>UR.RecordingDate

	ORDER BY AU.EquipmentId,AU.QUOMId,AU.RecordingDate,AU.ActualUsageId
	

	OPEN cInvalidReading


	FETCH NEXT FROM cInvalidReading
	INTO @EquipmentId, @QUOMId, @InvalidActualUsageId, @InvalidRecordingDate, @InvalidRecordedUsage, 
	@InvalidOffset,/*VV #4134*/@CreatedInAMT,@StartUsageEqpPlanId,@EquipmentNo,@System_Source

	WHILE @@Fetch_Status = 0
	BEGIN
		--AL: 01/03/10
		SET @IsValid=NULL
		SET @ExceedsProjectedUsage=NULL


		EXEC usp_Check_ActualReading
			@EquipmentId=@EquipmentId,
			@QUOMId=@QUOMId,
			@RecordingDate=@InvalidRecordingDate,
			@Offset=@InvalidOffset,
			@RecordedUsage=@InvalidRecordedUsage,
			@ValidReading=@IsValid OUTPUT,
			@ExceedsProjectedUsage=@ExceedsProjectedUsage OUTPUT
	
		IF @IsValid<>0
		BEGIN
			/*VV #4134 replaced with usp_Add_ActualUsage_Valid
			--Make the Invalid Record Valid
			INSERT INTO [tblActualUsages]
				([EquipmentId], [QUOMId], [RecordedUsage], [Offset], [ActualUsage], [RecordingDate], 
				 [CreatedByUserId], [CreateDate], [LastModByUserId], [LastModDate], 
				 [CreatedInAMT], [ExceedsProjectedUsage], [StartUsageEqpPlanId])
			SELECT EquipmentId,QUOMId,RecordedUsage,Offset,ActualUsage,RecordingDate,
				   CreatedByUserId,CreateDate,LastModByUserId,LastModDate,
				   CreatedInAMT,@ExceedsProjectedUsage,StartUsageEqpPlanId
			FROM [tblInvalidActualUsages]
			WHERE ActualUsageId=@InvalidActualUsageId

			DELETE 
			FROM [tblInvalidActualUsages]
			WHERE ActualUsageId=@InvalidActualUsageId
			*/
			
			EXEC usp_Add_ActualUsage_Valid   @EquipmentId =@EquipmentId,   
											 @QUOMId =@QUOMId,  
											 @RecordingDate=@InvalidRecordingDate,   
											 @Offset =@InvalidOffset,   
											 @RecordedUsage =@InvalidRecordedUsage,   
											 @CreatedInAMT =@CreatedInAMT,   
											 @ExceedsProjectedUsage =@ExceedsProjectedUsage, 
											 @NewActualUsageId=NULL, 
											 @EquipmentNo=@EquipmentNo,
											 @System_Source=@System_Source,
											 @StartUsageEqpPlanId =@StartUsageEqpPlanId
											 
		END

		FETCH NEXT FROM cInvalidReading
		INTO @EquipmentId, @QUOMId, @InvalidActualUsageId, @InvalidRecordingDate, 
		@InvalidRecordedUsage, @InvalidOffset,/*VV #4134*/@CreatedInAMT,@StartUsageEqpPlanId,
		@EquipmentNo,@System_Source
	END

	CLOSE cInvalidReading
	DEALLOCATE cInvalidReading

	DROP TABLE #I_USAGE_REVAL

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PRICE_GROUP_ADD_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[PRICE_GROUP_ADD_P]
GO

create    Procedure PRICE_GROUP_ADD_P
/******************************************************************************
	
	Name: PRICE_GROUP_ADD_P

	Called By: 

	Desc: 1. Add Price Group
	      2. Create Parts prices for the Price Group
	         by copying the parts prices for the base price group
	      3. Create Priced Jobs for the new Price group
	      4. Return id of the new Price Group
             

	Auth: Veronika Vasylyeva
	Date: 29-Sep-2003
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
    26 Nov 2003	V Vasylyeva	Added PRICED_JOBS_CREATE_P instead of query
    12 Jun 2009	AL			Added @DefaultValue
     4 May 2012	V Vasylyeva	#4139 speeding up
*******************************************************************************/
	/* Param List */
    @Price_Group varchar(50),   
    @Base_Price_Group_ID int,
    @Create_By_User_ID int=0,
    @New_Price_Group_ID int OUTPUT,
    @DefaultValue bit,	--AL: 12/06/09
    @Message varchar(2000)='' OUTPUT
AS


BEGIN TRANSACTION
--Create a price group
INSERT INTO PRICE_GROUP(
Price_Group, 
Last_Mod_By_User_ID, Last_Mod_Date, 
Create_By_User_ID, Create_Date,DefaultValue)
VALUES(
@Price_Group, 
@Create_By_User_ID, GETDATE(), 
@Create_By_User_ID, GETDATE(),
@DefaultValue)

IF @@ERROR<>0
BEGIN
	ROLLBACK TRANSACTION
	RETURN
END
--Get the new price group ID
SET @New_Price_Group_ID=SCOPE_IDENTITY()

--AL: 12/06/09
IF @DefaultValue<>0
	UPDATE PRICE_GROUP SET DefaultValue=0 WHERE Price_Group_ID<>@New_Price_Group_ID


--Copy the parts prices for all currencies from the 
--parts price group that is set as the basis.
INSERT INTO tblPartPrices(
PartId, CurrencyId, 
Part_Sell, Full_Credit_Sell, Partial_Credit_Sell, 
Price_Group_ID, 
LastModByUserId, LastModDate, CreateByUserId,CreateDate)
SELECT     
PartId, CurrencyId, 
Part_Sell, Full_Credit_Sell, Partial_Credit_Sell, 
@New_Price_Group_ID, 
@Create_By_User_ID, GETDATE(), @Create_By_User_ID,GETDATE()
FROM tblPartPrices
WHERE Price_Group_ID=@Base_Price_Group_ID

IF @@ERROR<>0
BEGIN
	ROLLBACK TRANSACTION
	RETURN
END


EXEC PRICED_JOBS_CREATE_P /* VV #4139 @Price_Group_ID=@New_Price_Group_ID*/

/* VV #4139 The procedure in called from PRICED_JOBS_CREATE_P
--Update costs for the new priced jobs
EXEC PRICED_JOB_HRS_COST_UPDATE_P @Price_Group_ID=@New_Price_Group_ID, @UpdateProjTaskAmts=0 
*/

COMMIT TRANSACTION

GO

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PROJ_TASK_AMT_FILTERED_UPDATE_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[PROJ_TASK_AMT_FILTERED_UPDATE_P]
GO

create    Procedure [dbo].[PROJ_TASK_AMT_FILTERED_UPDATE_P]
/******************************************************************************
	File: 
	Name: PROJ_TASK_AMT_FILTERED_UPDATE_P

	Called By: AMTData.GetProjTaskAmt

	Desc:  updates projected task jobs against filter
	      
 

	Auth: Alex Lassauniere
	Date: 13 dec 2005
*******************************************************************************
		Change History
*******************************************************************************
Date:		Author:		Description:
--------	--------	---------------------------------------
 4 May 12	V Vasylyeva	#4100 Update labour costs with the new rates in budget and estimate projections
19 Mar 12   GD          Fixed 3755

--OLD COMMENTS

 8 Mar 2012	V Vasylyeva	E745: New fields  PartsPricingFactor, LabourPricingFactor, MiscPricingFactor, 
						PreparationTime, LabourHoursFactor, DurationFactor, LabourRate, 
						PartsPricingComments, LabourPricingComments, MiscPricingComments, 
						PreparationTimeComments, LabourHoursComments, DurationComments, LabourRateComments
						Removed dynamic SQL
 2-Sep-2009 V Vasylyeva CR8325 Modelling enhancements
12-Dec-2008	V Vasylyeva	CR7787 Job Code can be empty in proj tasks
*******************************************************************************/
	/* Param List */

    @DealerID int = 0,
    @BranchID varchar(max) = '',
    @SiteID varchar(max) = '',
    @FleetID varchar(max) = '',
    @EqpPlanID varchar(max) = '',
    @ProjHeaderId varchar(max) = '',
    @TaskTypeId varchar(max)='',
    @TaskHeaderId varchar(max)='',
    @JobCodeId varchar(max)='',
    @CostBearerId varchar(max)='',
    @crane varchar(max)='',
    @freight varchar(max)='',
    @split varchar(max)='',
    @avgDaily varchar(max)='',
    @ratePerHr varchar(max)='',
    @avgHrs varchar(max)='',
    @avgPeople varchar(max)='',
    @distance varchar(max)='',
    @ratePerKm varchar(max)='',
    @miscCost varchar(max)='',
    @rowChanged int=0 OUTPUT,
    @FieldLabour int=2,
    @PartsPricingFactor varchar(max)='', 
    @LabourPricingFactor varchar(max)='', 
    @MiscPricingFactor varchar(max)='', 
    @PreparationTime varchar(max)='', 
    @LabourHoursFactor varchar(max)='', 
    @DurationFactor varchar(max)='', 
    @PartsPricingComments varchar(max)='', 
    @LabourPricingComments varchar(max)='', 
    @MiscPricingComments varchar(max)='', 
    @PreparationTimeComments varchar(max)='', 
    @LabourHoursComments varchar(max)='', 
    @DurationComments varchar(max)='',     
    @LabourRateField varchar(max)='',
    @LabourRateShop varchar(max)='',
    @LabourRateCommentsField varchar(max)='',
	@LabourRateCommentsShop varchar(max)='',
	@KeepLabourCost bit=0,
	@UserId int=0,
	@ShopJobCode int=3

AS


--GD 19/03/12 fixed 3577 
SET	@FleetID=REPLACE(@FleetID,'''','') 
SET	@EqpPlanID=REPLACE(@EqpPlanID,'''','') 
SET	@TaskHeaderId=REPLACE(@TaskHeaderId,'''','') 
SET	@TaskTypeId=REPLACE(@TaskTypeId,'''','') 
SET	@JobCodeId=REPLACE(@JobCodeId,'''','') 
SET	@CostBearerId=REPLACE(@CostBearerId,'''','') 

IF ISNULL(@crane+@freight+@split+@avgDaily+@ratePerHr+@avgHrs+@avgPeople+@distance+
@ratePerKm+@miscCost+@PartsPricingFactor+@LabourPricingFactor+@MiscPricingFactor+@PreparationTime+
@LabourHoursFactor+@DurationFactor+@PartsPricingComments+@LabourPricingComments+
@MiscPricingComments+@PreparationTimeComments+@LabourHoursComments+@DurationComments+
@LabourRateCommentsField+@LabourRateCommentsShop+@LabourRateField+@LabourRateShop,'')=''
BEGIN
	SET @rowChanged=0
	RETURN 
END


DECLARE @Crane_Cost float,@Pct_Freight float,@LaborShare float,@Avg_Daily_Work_Hrs float
DECLARE @Travel_Recovery_Rate_L float,@Avg_Travel_Hrs float,@Avg_No_People float
DECLARE @Travel_Distance float, @Travel_Recovery_Rate_V float, @Misc_Trip_Cost float

DECLARE @PartsPricingFactorV float, @LabourPricingFactorV float, @MiscPricingFactorV float
DECLARE @PreparationTimeV float, @LabourHoursFactorV float, @DurationFactorV float
DECLARE @LabourRateV float,@LabourRateFieldV float,@LabourRateShopV float
DECLARE @ShopLabour bit

SET @ShopLabour=CASE @ShopJobCode WHEN 1 THEN 1 ELSE 0 END


IF ISNUMERIC(@crane)=1 SET @Crane_Cost=CAST(@crane AS float)
IF ISNUMERIC(@freight)=1 SET @Pct_Freight=CAST(@freight AS float)
IF ISNUMERIC(@split)=1 SET @LaborShare=CAST(@split AS float)
IF ISNUMERIC(@avgDaily)=1 SET @Avg_Daily_Work_Hrs=CAST(@avgDaily AS float)
IF ISNUMERIC(@ratePerHr)=1 SET @Travel_Recovery_Rate_L=CAST(@ratePerHr AS float)
IF ISNUMERIC(@avgHrs)=1 SET @Avg_Travel_Hrs=CAST(@avgHrs AS float)
IF ISNUMERIC(@avgPeople)=1 SET @Avg_No_People=CAST(@avgPeople AS float)
IF ISNUMERIC(@distance)=1 SET @Travel_Distance=CAST(@distance AS float)
IF ISNUMERIC(@ratePerKm)=1 SET @Travel_Recovery_Rate_V=CAST(@ratePerKm AS float)
IF ISNUMERIC(@miscCost)=1 SET @Misc_Trip_Cost=CAST(@miscCost AS float)
IF @FieldLabour NOT IN(0,1) SET @FieldLabour=NULL

IF ISNUMERIC(@PartsPricingFactor)=1 SET @PartsPricingFactorV=CAST(@PartsPricingFactor AS float)
IF ISNUMERIC(@LabourPricingFactor)=1 SET @LabourPricingFactorV=CAST(@LabourPricingFactor AS float)
IF ISNUMERIC(@MiscPricingFactor)=1 SET @MiscPricingFactorV=CAST(@MiscPricingFactor AS float)
IF ISNUMERIC(@PreparationTime)=1 SET @PreparationTimeV=CAST(@PreparationTime AS float)
IF ISNUMERIC(@LabourHoursFactor)=1 SET @LabourHoursFactorV=CAST(@LabourHoursFactor AS float)
IF ISNUMERIC(@DurationFactor)=1 SET @DurationFactorV=CAST(@DurationFactor AS float)
IF ISNUMERIC(@LabourRateField)=1 SET @LabourRateFieldV=CAST(@LabourRateField AS float)
IF ISNUMERIC(@LabourRateShop)=1 SET @LabourRateShopV=CAST(@LabourRateShop AS float)

IF @PartsPricingFactorV<-100 SET @PartsPricingFactorV=-100
IF @LabourPricingFactorV<-100 SET @LabourPricingFactorV=-100
IF @MiscPricingFactorV<-100 SET @MiscPricingFactorV=-100
IF @LabourHoursFactorV<-100 SET @LabourHoursFactorV=-100
IF @DurationFactorV<-100 SET @DurationFactorV=-100

IF @PreparationTimeV<0 SET @PreparationTimeV=NULL
IF @LabourRateFieldV<0 SET @LabourRateFieldV=NULL
IF @LabourRateShopV<0 SET @LabourRateShopV=NULL

SET @PartsPricingComments=(NULLIF(@PartsPricingComments,''))
SET @LabourPricingComments=(NULLIF(@LabourPricingComments,''))
SET @MiscPricingComments=(NULLIF(@MiscPricingComments,''))
SET @PreparationTimeComments=(NULLIF(@PreparationTimeComments,''))
SET @LabourHoursComments=(NULLIF(@LabourHoursComments,''))
SET @DurationComments=(NULLIF(@DurationComments,''))
SET @LabourRateCommentsField=(NULLIF(@LabourRateCommentsField,''))
SET @LabourRateCommentsShop=(NULLIF(@LabourRateCommentsShop,''))


SET @UserId=ISNULL(@UserId,0)
/*
0 -ALL
1-Branch,
2-Site
	*/
DECLARE @Level int
SELECT @Level=User_Access_Level_Id From USER_LEVEL_PERMISSION where AMT_User_Id = @UserId
SET @Level=ISNULL(@Level,0)


UPDATE PTA SET
Crane_Cost=ISNULL(@Crane_Cost,Crane_Cost),
Pct_Freight=ISNULL(@Pct_Freight,Pct_Freight),
LaborShare=ISNULL(@LaborShare,LaborShare),
Avg_Daily_Work_Hrs=ISNULL(@Avg_Daily_Work_Hrs,Avg_Daily_Work_Hrs),
Travel_Recovery_Rate_L=ISNULL(@Travel_Recovery_Rate_L,Travel_Recovery_Rate_L),
Avg_Travel_Hrs=ISNULL(@Avg_Travel_Hrs,Avg_Travel_Hrs),
Avg_No_People=ISNULL(@Avg_No_People,Avg_No_People),
Travel_Distance=ISNULL(@Travel_Distance,Travel_Distance),
Travel_Recovery_Rate_V=ISNULL(@Travel_Recovery_Rate_V,Travel_Recovery_Rate_V),
Misc_Trip_Cost=ISNULL(@Misc_Trip_Cost,Misc_Trip_Cost),
PartsPricingFactor=ISNULL(@PartsPricingFactorV,PartsPricingFactor),
LabourPricingFactor=ISNULL(@LabourPricingFactorV,LabourPricingFactor),
MiscPricingFactor=ISNULL(@MiscPricingFactorV,MiscPricingFactor),
PreparationTime=ISNULL(@PreparationTimeV,PreparationTime),
LabourHoursFactor=ISNULL(@LabourHoursFactorV,LabourHoursFactor),
DurationFactor=ISNULL(@DurationFactorV,DurationFactor),
LabourRate=CASE PTA.Labour_Hrs_Field
		  WHEN 1 THEN ISNULL(@LabourRateFieldV,LabourRate)
		  ELSE ISNULL(@LabourRateShopV,LabourRate) END,
PartsPricingComments = ISNULL(NULLIF(@PartsPricingComments,''),PartsPricingComments), 
LabourPricingComments = ISNULL(NULLIF(@LabourPricingComments,''),LabourPricingComments), 
MiscPricingComments = ISNULL(NULLIF(@MiscPricingComments,''),MiscPricingComments),  
PreparationTimeComments = ISNULL(NULLIF(@PreparationTimeComments,''),PreparationTimeComments), 
LabourHoursComments = ISNULL(NULLIF(@LabourHoursComments,''), LabourHoursComments),
DurationComments = ISNULL(NULLIF(@DurationComments,''), DurationComments),
LabourRateComments = CASE PTA.Labour_Hrs_Field
		  WHEN 1 THEN ISNULL(NULLIF(@LabourRateCommentsField,''),LabourRateComments)
		  ELSE ISNULL(NULLIF(@LabourRateCommentsShop,''),LabourRateComments) END,
LaborCost= CASE WHEN @KeepLabourCost=1 THEN LaborCost
		   WHEN CA.Cost_Allocation_Id>0 OR PT.AutomaticUpdate=1 THEN LaborCost
		   /*VV #4100*/
		   WHEN PTA.PricedJobId>0 AND EH.Projection_Type_ID NOT IN(2,6,7) THEN LaborCost
		   WHEN PTA.Labour_Hrs_Field=1 THEN ISNULL(@LabourRateFieldV*LaborHours,LaborCost)
		   ELSE ISNULL(@LabourRateShopV*LaborHours,LaborCost) END

FROM    
EQUIPMENT_HIERARCHY_V EH
	INNER JOIN
tblProjTasks PT
	ON EH.EqpProjId=PT.EqpProjId
	INNER JOIN
tblProjTaskOpts PTO
	ON PT.ProjTaskId=PTO.ProjTaskId
	INNER JOIN
tblProjTaskAmts PTA
	ON PTO.ProjTaskOptId=PTA.ProjTaskOptId
	LEFT JOIN
COST_ALLOCATION CA
	ON PTA.ProjTaskAmtId=CA.Proj_Task_Amt_Id
	LEFT JOIN
tblJobCodes JC
	ON ISNULL(PTA.JobCodeId,0)=JC.JobCodeID
WHERE 
(EH.Projection_Type_ID<>4) AND
(@ProjHeaderId='' OR EH.ProjHeaderId IN(SELECT list_item FROM dbo.LIST_TO_TABLE_F(@ProjHeaderId)))	AND
(@FleetID='' OR EH.FleetId IN(SELECT list_item FROM dbo.LIST_TO_TABLE_F(@FleetID)))	AND
(@DealerID=0 OR EH.DealerId=@DealerID)	AND
(@BranchId='' OR EH.BranchId IN(SELECT list_item FROM dbo.LIST_TO_TABLE_F(@BranchId)))	AND
(@SiteID='' OR EH.SiteID IN(SELECT list_item FROM dbo.LIST_TO_TABLE_F(@SiteID)))	AND
(@EqpPlanID='' OR EH.EqpPlanID IN(SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpPlanID)))	AND
(@TaskTypeId='' OR PT.TaskTypeId IN(SELECT list_item FROM dbo.LIST_TO_TABLE_F(@TaskTypeId)))	AND
(@TaskHeaderId='' OR PT.Task_Header_Id IN(SELECT list_item FROM dbo.LIST_TO_TABLE_F(@TaskHeaderId)))	AND
(@JobCodeId='' OR PTA.JobCodeId IN(SELECT list_item FROM dbo.LIST_TO_TABLE_F(@JobCodeId)))	AND
(@ShopJobCode=3 OR JC.ShopLabour=@ShopLabour) AND
(@CostBearerId='' OR PTA.Cost_Bearer_Id IN(SELECT list_item FROM dbo.LIST_TO_TABLE_F(@CostBearerId)))	AND
(@FieldLabour IS NULL OR PTA.Labour_Hrs_Field=CAST(@FieldLabour AS bit)) AND
(@Level<>1 OR EH.BranchId In (SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = @UserId)) AND
(@Level<>2 OR EH.SiteID IN(SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = @UserId))


SET @rowChanged=@@ROWCOUNT

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[AUTOCREATE_PLANNED_EVENTS_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[AUTOCREATE_PLANNED_EVENTS_P]
GO

create Procedure AUTOCREATE_PLANNED_EVENTS_P
/******************************************************************************
	Name: AUTOCREATE_PLANNED_EVENTS_P


	Desc: 
	
	If the planning mode for the equipment = "Advanced Planning" then a YTS event is 
	automatically created for the Workorder on the planned date/time of the Workorder.
	The planned end time = plannned start date/time + duration
	
	If the planning mode for the equipment = "Standard Planning" then the workorder is 
	automatically set to YTS on the planned date/time of the Workorder.
	
	If an event is already created then the event start time is NOT updated.
	
	Where an overdue workorder is created then set the plan start time= current date/time
	- this is possible for a new Strategy task created.

	There needs to be a check that only enables this process to run 
	where the Strategy Task does not have a dirty planning flag set.

	Where multiple workorders are created (ie the variable has been set to enable multiple 
	workorders) 
	Only set the next workorder in status "YTS"
	All other future workorders should have status = "OUT"
	
	The reason is that the performance of the Workroder could impact the date of the 
	next workorder and want the correct YTS date set.

             

	Auth: Veronika Vasylyeva
	Date: 1-May-2012
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
    	
*******************************************************************************/
	/* Param List */
    
AS

DECLARE @TaskStatusOUS int,@TaskStatusYTS int,@EventStatusYTS int,@EventId int,@DTA_Id int
DECLARE @AdvancedPlanning int, @StandardPlanning int,@Expected_Duration float
DECLARE @EqpPlanId int, @Description varchar(500),@Priority_ID int,@PlannedStartTime datetime
DECLARE @PlannedEndTime datetime,@QUOMId int,@TaskId int,@Counter int,@AMTPlanningModeId int
DECLARE @Message varchar(max),@VarianceCauseId int,@ResponsibilityId int,@TaskTypeId int
DECLARE @DefPriority_ID int,@Component_Code_ID int, @Modifier_ID int,  @Application_Code_ID int,  
@Occurrence_Type_Id int, @Source_ID int, @Date_Notified datetime, @Component_ID varchar(8000),  
@Symptom_ID int,@Symptom_Notes varchar(8000),  @Cause_ID int,  @Cause_Notes varchar(8000), 
@Repair_Code_ID int,@Repair_Notes varchar(8000), @Group_No varchar(8000), @Part_No varchar(8000), 
@EMI_Ref varchar(8000), @EMIssueId int,@Redo bit, @Task_Planned_Time_ID int,@Customer_Ref varchar(8000), 
@Employee_ID int, @Expected_Labor_Hours float,@Planning_Notes varchar(8000),@Work_Order varchar(8000)

DECLARE @Actual_Duration float, @Actual_Labor_Hrs float, @Notes varchar(8000), @Task_Mode_ID int,  
@PartsStatusRequired bit,@PartsStatusOrdered bit, @PartsStatusReady bit, @RaisedByID int ,  
@Work_Order_ID int, @Work_Group_ID int, @Strategy_Usage float, @Strategy_QUOM_ID int,  
@Strategy_Proj_Task_Opt_ID int, @Strategy_Date datetime, @Strategy_Locked bit,  
@Part_Description varchar(8000), @Group_Description varchar(8000), @SIMS_Code_Id int,  
@WO_Create_Date datetime, @Performed_By_Date datetime, @Parts_Available_Date datetime,  
@Parts_Order_Details varchar(8000), @WO_Counter int,  @Work_Order_Number_External varchar(8000),  
@Cost_Bearer_ID int, @Task_Warranty bit, @Redo_Work_Order_ID int, @ViewWarranty bit,  
@HealthSafetyId int,@BreakDown bit, @PlannedOffset float, @SiteId int, @WorkLocation varchar(8000)
  
DECLARE @CostCentreId int, @BranchId int,@CustomerId int, @PartEntryDistributionCodeId int,  
@DefWorkGroupId int, @PartsCostExpenseId int, @LabourCostExpenseId int,@MiscCostExpenseId int,  
@SpecificOperationCodes bit, @WorkOrderDate datetime, @WarrantyClaimable bit, @ReviewedEmployeeId int,  
@WarrantyNotes varchar(8000), @WarrantyDays float,@WarrantyUsage float, @WarrantyDaysArchived float,  
@WarrantyUsageAcrhived float, @WarrantySupplierId int,@ClaimRef varchar(8000), @SupplierRef varchar(8000),  
@SummaryDescription varchar(8000), @ClaimStatusId int,@ClaimedByEmployeeId int, @ClaimeDate datetime,  
@ClaimDescription varchar(8000), @JobPartsCost float, @JobLabourCost float, @JobMiscCost float,  
@ClaimedPartsCost float,@ClaimedLabourCost float, @ClaimedMiscCost float, @RecPartsCost float,  
@RecLabourCost float,@RecMiscCost float,@LabourEntryDistributionCodeId int,@MiscEntryDistributionCodeId int
 
DECLARE @SupplierContact varchar(8000),@TaskAuthorised bit, @ActualOffset float,@ChangeoutCategoryId int,  
@LifeConfirmed bit,@OriginalPartTypeId int, @SerialNoIn int,  @SerialNoOut int, @IsOverwriteLife bit,  
@OverwriteLifeAchieved float, @ConditionMonitoringIntervention bit, @FailedPartListPosition varchar(8000),  
@FailedPartListGroup varchar(8000),@FailedPartLifeAchieved float,@PartSerialNoRemoved varchar(8000),  
@PartSerialNoInstalled varchar(8000),@LastNotified datetime, @ResourceStatusReady bit,
@AuthorisationRequestByID int,@Primary_Cause bit

SET @TaskStatusOUS=1
SET @TaskStatusYTS=6
SET @EventStatusYTS=1
SET @AdvancedPlanning=1
SET @StandardPlanning=2

CREATE TABLE #z_CreateEvents(ListId int IDENTITY(1,1),Task_Id int PRIMARY KEY(ListId))

INSERT INTO #z_CreateEvents(Task_Id)
SELECT A.Task_ID
FROM 
(
SELECT T.Task_ID,T.Event_Id,T.Task_Status_Id,
ROW_NUMBER() OVER(PARTITION BY T.Strategy_Proj_Task_Opt_ID ORDER BY T.Task_Status_Id DESC, T.Strategy_Date,T.Task_Id) AS ListNo
FROM
TASK T
	INNER JOIN
tblProjTaskOpts PTO
	ON T.Strategy_Proj_Task_Opt_ID=PTO.ProjTaskOptId
	INNER JOIN
tblProjTasks PT
	ON PTO.ProjTaskId=PT.ProjTaskId
	INNER JOIN
tblEqpPlans EP
	ON T.Eqp_Plan_ID=EP.EqpPlanId
	LEFT JOIN
EVENT E
	ON T.Event_ID=E.Event_ID
WHERE
PT.Planning_Task=1 AND PT.AutocreatePlannedEvents=1 AND PT.Dirty_Next_Occ=0
AND T.Task_Status_ID IN(@TaskStatusOUS,@TaskStatusYTS)
AND EP.Advanced_Planning IN (@AdvancedPlanning,@StandardPlanning)
) A
WHERE A.ListNo=1 AND A.Event_ID IS NULL AND A.Task_Status_Id= @TaskStatusOUS

SET @Counter=@@ROWCOUNT

IF @Counter=0 RETURN

SELECT @DefPriority_ID=Priority_ID FROM PRIORITY WHERE Default_Record=1
SELECT @VarianceCauseId=Variance_Cause_ID FROM VARIANCE_CAUSE WHERE Default_Record=1
SELECT @ResponsibilityId=Responsibility_ID FROM RESPONSIBILITY WHERE Default_Record=1

WHILE @Counter>0
BEGIN

	SELECT @EqpPlanId=T.Eqp_Plan_ID,@Description= T.Description,@PlannedStartTime=T.Strategy_Date,
	@Expected_Duration=T.Expected_Duration,
	@PlannedEndTime=dbo.WO_DOWN_TIME_F(T.Strategy_Date,T.Expected_Duration),
	@QUOMId=EP.Primary_QUOM_ID,@TaskId=T.Task_ID,@AMTPlanningModeId=T.AMTPlanningModeId,
	@Primary_Cause=T.Primary_Cause,
	@TaskTypeID =T.Task_Type_ID,
	@Component_Code_ID =T.Component_Code_ID, 
	@Modifier_ID =T.Modifier_ID,  
	@Application_Code_ID =T.Application_Code_ID,  
	@Occurrence_Type_Id=T.Occurrence_Type_Id,  
	@Priority_ID =T.Priority_ID,  
	@Source_ID = T.Source_ID,   
	@Date_Notified = T.Date_Notified,  
	@Component_ID =T.Component_ID,  
	@Symptom_ID =T.Symptom_ID,  
	@Symptom_Notes =Symptom_Notes,  
	@Cause_ID = T.Cause_ID,  
	@Cause_Notes =T.Cause_Notes,  
	@Repair_Code_ID =T.Repair_Code_ID,  
	@Repair_Notes =T.Repair_Notes,  
	@Group_No =T.Group_No,  
	@Part_No =T.Part_No,  
	@EMI_Ref =T.EMI_Ref,  
	@EMIssueId =T.EM_Issue_Id,  
	@Redo =T.Redo,  
	@Task_Planned_Time_ID =T.Task_Planned_Time_ID,  
	@Customer_Ref =T.Customer_Ref,  
	@Employee_ID =T.Employee_ID,  		    
	@Expected_Labor_Hours =T.Expected_Labor_Hours,  
	@Planning_Notes =T.Planning_Notes,  
	@Work_Order =T.Work_Order,  
	@Actual_Duration =T.Actual_Duration,  
	@Actual_Labor_Hrs =T.Actual_Labor_Hrs,  
	@Notes =T.Notes,  
	@Task_Mode_ID =T.Task_Mode_ID,  
	@PartsStatusRequired =T.PartsStatusRequired,  
	@PartsStatusOrdered =T.PartsStatusOrdered,  
	@PartsStatusReady =T.PartsStatusReady,  
	@RaisedByID = T.RaisedByID ,  
	@Work_Order_ID =T.Work_Order_ID,  
	@Work_Group_ID =T.Work_Group_ID,  
	@Strategy_Usage =T.Strategy_Usage,  
	@Strategy_QUOM_ID =T.Strategy_QUOM_ID,  
	@Strategy_Proj_Task_Opt_ID =T.Strategy_Proj_Task_Opt_ID,  
	@Strategy_Date =T.Strategy_Date,  
	@Strategy_Locked =T.Strategy_Locked,  
	@Part_Description =T.Part_Description,  
	@Group_Description =T.Group_Description,  
	@SIMS_Code_Id =T.SIMS_Code_Id,  
	@WO_Create_Date =T.WO_Create_Date,  
	@Performed_By_Date = T.Performed_By_Date,  
	@Parts_Available_Date =T.Parts_Available_Date,  
	@Parts_Order_Details =T.Parts_Order_Details,  
	@WO_Counter =T.WO_Counter,  
	@Work_Order_Number_External =T.Work_Order_Number_External,  
	@Cost_Bearer_ID =T.Cost_Bearer_ID,  
	@Task_Warranty =T.Task_Warranty,  
	@Redo_Work_Order_ID =T.Redo_Work_Order_ID,  
	@ViewWarranty =T.View_Warranty,  
	@HealthSafetyId =T.Health_Safety_Id,  
	@BreakDown =T.Break_Down,  		
	@PlannedOffset =T.Planned_Offset,  
	@SiteId =T.Site_Id,  
	@WorkLocation =T.Work_Location,  
	@CostCentreId =T.Cost_Centre_Id,  
	@BranchId =T.Branch_Id,  
	@CustomerId  =T.Customer_Id,  
	@PartEntryDistributionCodeId =T.Part_Entry_Distribution_Code_Id,  
	@DefWorkGroupId  =T.Def_Work_Group_Id,  
	@PartsCostExpenseId  =T.Parts_Cost_Expense_Id,  
	@LabourCostExpenseId  =T.Labour_Cost_Expense_Id,  
	@MiscCostExpenseId  =T.Misc_Cost_Expense_Id,  
	@SpecificOperationCodes  =T.Specific_Operation_Codes,  
	@WorkOrderDate =T.Work_Order_Date,  
	@WarrantyClaimable =T.Warranty_Claimable,  
	@ReviewedEmployeeId=T.Reviewed_Employee_Id,  
	@WarrantyNotes=T.Warranty_Notes,  
	@WarrantyDays=T.Warranty_Days,  
	@WarrantyUsage=T.Warranty_Usage,  
	@WarrantyDaysArchived=T.Warranty_Days_Archived,  
	@WarrantyUsageAcrhived=T.Warranty_Usage_Acrhived,  
	@WarrantySupplierId=T.Warranty_Supplier_Id,  
	@ClaimRef =Claim_Ref,  
	@SupplierRef=T.Supplier_Ref,  
	@SummaryDescription=T.Summary_Description,  
	@ClaimStatusId=T.Claim_Status_Id,  
	@ClaimedByEmployeeId=T.Claimed_By_Employee_Id,  
	@ClaimeDate=T.Claime_Date,  
	@ClaimDescription=T.Claim_Description,  
	@JobPartsCost=T.Job_Parts_Cost,  
	@JobLabourCost=T.Job_Labour_Cost,  
	@JobMiscCost=T.Job_Misc_Cost,  
	@ClaimedPartsCost=T.Claimed_Parts_Cost,  
	@ClaimedLabourCost=T.Claimed_Labour_Cost,  
	@ClaimedMiscCost=T.Claimed_Misc_Cost,  
	@RecPartsCost=T.Rec_Parts_Cost,  
	@RecLabourCost=T.Rec_Labour_Cost,  
	@RecMiscCost=T.Rec_Misc_Cost,  
	@LabourEntryDistributionCodeId=T.Labour_Entry_Distribution_Code_Id,  
	@MiscEntryDistributionCodeId=T.Misc_Entry_Distribution_Code_Id,  
	@SupplierContact=T.Supplier_Contact,  
	@TaskAuthorised=T.Task_Authorised,  
	@ActualOffset=T.ActualOffset,  
	@ChangeoutCategoryId=T.ChangeoutCategoryId,  
	@LifeConfirmed=T.LifeConfirmed,  
	@OriginalPartTypeId=T.OriginalPartTypeId,  
	@SerialNoIn=T.SerialNoInId,  
	@SerialNoOut=T.SerialNoOutId,  
	@IsOverwriteLife=T.IsOverwriteLife,  
	@OverwriteLifeAchieved=T.OverwriteLifeAchieved,  
	@ConditionMonitoringIntervention=T.ConditionMonitoringIntervention,  
	@FailedPartListPosition=T.FailedPartListPosition,  
	@FailedPartListGroup=T.FailedPartListGroup,  
	@FailedPartLifeAchieved=T.FailedPartLifeAchieved,  
	@PartSerialNoRemoved=T.FailedGroupListPosition,  
	@PartSerialNoInstalled=T.FailedGroupPartsListGroup,  
	@LastNotified=T.LastNotified,  
	@ResourceStatusReady=T.ResourceStatusReady,  
	@AuthorisationRequestByID=T.AuthorisationRequestByID,  
	@AmtPlanningModeId=T.AMTPlanningModeId  
	FROM
	#z_CreateEvents Z
		INNER JOIN
	TASK T
		ON Z.ListId=@Counter
		AND Z.Task_Id=T.Task_Id
		INNER JOIN
	tblEqpPlans EP
		ON T.Eqp_Plan_ID=EP.EqpPlanId
	WHERE T.Task_Status_ID =@TaskStatusOUS
	
	IF @PlannedStartTime<GETDATE()
	BEGIN
		SET @PlannedStartTime=GETDATE()
		SET @PlannedEndTime=dbo.WO_DOWN_TIME_F(@PlannedStartTime,@Expected_Duration)
	END
	
	IF @AMTPlanningModeId=@AdvancedPlanning
	BEGIN
		SET @Message=''

		BEGIN TRANSACTION
		
		EXEC EVENT_ADD_P @Eqp_Plan_ID=@EqpPlanId, 
			@Description=@Description, 
			@Event_Status_ID =@EventStatusYTS, 
			@Priority_ID =@DefPriority_ID,
			@Work_Location_ID=NULL, 
			@Planned =1, 
			@Break_Down =0, 
			@Expected_Up_Time =@PlannedEndTime, 
			@Confirmed= 0, 
			@Event_Prevention_ID=NULL,
			@Planned_Down_Time =@PlannedStartTime, 
			@Planned_Up_Time =@PlannedEndTime, 
			@Actual_Down_Time =NULL, 
			@Actual_Up_Time =NULL, 
			@QUOM_ID=@QUOMId,
			@Create_By_User_ID=0,	
			@NewEvent_ID =@EventId OUTPUT,
			@RelesedByID =NULL,
			@Message =@Message OUTPUT,
			@PrimaryTaskId=@TaskId
			
		IF ISNULL(@Message,'')<>''
		BEGIN
			SELECT 'Cannot create Event Task_Id='+CAST(@TaskId AS varchar(50)) +': '+@Message
			ROLLBACK TRANSACTION
		END
		ELSE
		BEGIN
			SET @DTA_Id=0
			
			EXEC DOWN_TIME_ALLOCATION_ADD_P
			@Event_ID =@EventId, 
			@Variance_Cause_ID=@VarianceCauseId, 
			@Task_Type_ID=@TaskTypeId, 
			@Responsibility_ID=@ResponsibilityId, 
			@Planned_Hours=@Expected_Duration, 
			@Actual_Hours=0, 
			@Notes=NULL, 
			@EMI_Ref=NULL,
			@EMIssueId =NULL,
			@Primary_DTA =1,
			@Event_Last_Mod_Date=NULL,
			@New_Down_Time_Allocation_ID=@DTA_Id OUTPUT
			
			IF @DTA_Id>0
				COMMIT TRANSACTION
			ELSE
			BEGIN
				SELECT 'Cannot create Event DTA for Task_Id='+CAST(@TaskId AS varchar(50))
				ROLLBACK TRANSACTION
			END
		END
	END
	ELSE
	BEGIN/*Standard Planning*/
		SET @Message=''
		  
			 BEGIN TRANSACTION  
			    
			 EXEC TASK_UPDATE_P   
			 @Task_ID=@TaskID,  
			 @Event_ID=NULL,  
			 @Description=@Description,  
			 @Eqp_Plan_ID=@EqpPlanId,  
			 @Task_Type_ID=@TaskTypeId,  
			 @Component_Code_ID=@Component_Code_ID,  
			 @Modifier_ID=@Modifier_ID,  
			 @Application_Code_ID=@Application_Code_ID,  
			 @Occurrence_Type_Id=@Occurrence_Type_Id,  
			 @Priority_ID=@Priority_ID,  
			 @Source_ID=@Source_ID,  
			 @Task_Status_ID=@TaskStatusYTS,  
			 @Date_Notified=@Date_Notified,  
			 @Component_ID=@Component_ID,  
			 @Symptom_ID=@Symptom_ID,  
			 @Symptom_Notes=@Symptom_Notes,  
			 @Cause_ID=@Cause_ID,  
			 @Cause_Notes=@Cause_Notes,  
			 @Repair_Code_ID=@Repair_Code_ID,  
			 @Repair_Notes=@Repair_Notes,  
			 @Group_No=@Group_No,  
			 @Part_No=@Part_No,  
			 @EMI_Ref=@EMI_Ref,  
			 @EMIssueId=@EMIssueId,  
			 @Redo=@Redo,  
			 @Task_Planned_Time_ID=@Task_Planned_Time_ID,  
			 @Customer_Ref=@Customer_Ref,  
			 @Employee_ID=@Employee_ID,  
			 @Expected_Duration=@Expected_Duration,  
			 @Expected_Labor_Hours=@Expected_Labor_Hours,  
			 @Planning_Notes  =@Planning_Notes,  
			 @Work_Order=@Work_Order,  
			 @Actual_Duration=@Actual_Duration,  
			 @Actual_Labor_Hrs=@Actual_Labor_Hrs                  ,  
			 @Primary_Cause=@Primary_Cause,  
			 @Notes=@Notes,  
			 @Task_Mode_ID=@Task_Mode_ID,  
			 @PartsStatusRequired=@PartsStatusRequired,  
			 @PartsStatusOrdered=@PartsStatusOrdered,  
			 @PartsStatusReady=@PartsStatusReady,  
			 @RaisedByID=@RaisedByID,  
			 @Work_Order_ID=@Work_Order_ID,  
			 @Work_Group_ID=@Work_Group_ID,  
			 @Strategy_Usage=@Strategy_Usage,  
			 @Strategy_QUOM_ID=@Strategy_QUOM_ID,  
			 @Strategy_Proj_Task_Opt_ID=0,
			 @Planned_Proj_Task_Opt_ID=0, 
			 @Strategy_Date=@Strategy_Date,  
			 @Strategy_Locked=@Strategy_Locked,  
			 @Event_Last_Mod_Date=NULL,  
			 @Task_Last_Mod_Date=NULL,  
			 @Part_Description=@Part_Description ,  
			 @Group_Description=@Group_Description,  
			 @SIMS_Code_Id=@SIMS_Code_Id,  
			 @Last_Mod_By_User_ID=0,  
			 @Message=@Message OUTPUT,  
			 @WO_Create_Date=@WO_Create_Date,  
			 @Performed_By_Date=@Performed_By_Date,  
			 @Parts_Available_Date=@Parts_Available_Date,  
			 @Parts_Order_Details=@Parts_Order_Details,  
			 @WO_Counter=@WO_Counter,  
			 @Work_Order_Number_External=@Work_Order_Number_External,  
			 @Cost_Bearer_ID=@Cost_Bearer_ID,  
			 @Task_Warranty=@Task_Warranty,  
			 @Redo_Work_Order_ID=@Redo_Work_Order_ID,  
			 @ViewWarranty=@ViewWarranty,  
			 @HealthSafetyId=@HealthSafetyId,  
			 @BreakDown=@BreakDown,  
			 @PlannedDownTime=@PlannedStartTime,  
			 @ActualDownTime=NULL,  
			 @PlannedOffset=@PlannedOffset,  
			 @SiteId=@SiteId,  
			 @WorkLocation=@WorkLocation,  
			 @CostCentreId=@CostCentreId,  
			 @BranchId=@BranchId,  
			 @CustomerId=@CustomerId,  
			 @PartEntryDistributionCodeId=@PartEntryDistributionCodeId,  
			 @DefWorkGroupId=@DefWorkGroupId,  
			 @PartsCostExpenseId=@PartsCostExpenseId,  
			 @LabourCostExpenseId=@LabourCostExpenseId,  
			 @MiscCostExpenseId=@MiscCostExpenseId,  
			 @SpecificOperationCodes=@SpecificOperationCodes,  
			 @WorkOrderDate=@WorkOrderDate,  
			 @WarrantyClaimable=@WarrantyClaimable,  
			 @ReviewedEmployeeId=@ReviewedEmployeeId,  
			 @WarrantyNotes=@WarrantyNotes,  
			 @WarrantyDays=@WarrantyDays,  
			 @WarrantyUsage=@WarrantyUsage,  
			 @WarrantyDaysArchived=@WarrantyDaysArchived,  
			 @WarrantyUsageAcrhived=@WarrantyUsageAcrhived,  
			 @WarrantySupplierId=@WarrantySupplierId,  
			 @ClaimRef=@ClaimRef,  
			 @SupplierRef =@SupplierRef,  
			 @SummaryDescription=@SummaryDescription,  
			 @ClaimStatusId=@ClaimStatusId,  
			 @ClaimedByEmployeeId=@ClaimedByEmployeeId,  
			 @ClaimeDate=@ClaimeDate,  
			 @ClaimDescription=@ClaimDescription,  
			 @JobPartsCost=@JobPartsCost,  
			 @JobLabourCost=@JobLabourCost,  
			 @JobMiscCost=@JobMiscCost,  
			 @ClaimedPartsCost=@ClaimedPartsCost,  
			 @ClaimedLabourCost=@ClaimedLabourCost,  
			 @ClaimedMiscCost=@ClaimedMiscCost,  
			 @RecPartsCost=@RecPartsCost,  
			 @RecLabourCost=@RecLabourCost,  
			 @RecMiscCost=@RecMiscCost,  
			 @LabourEntryDistributionCodeId=@LabourEntryDistributionCodeId,  
			 @MiscEntryDistributionCodeId=@MiscEntryDistributionCodeId,  
			 @SupplierContact=@SupplierContact,  
			 @TaskAuthorised=@TaskAuthorised,  
			 @ActualOffset=@ActualOffset,  
			 @ChangeoutCategoryId=@ChangeoutCategoryId,  
			 @LifeConfirmed=@LifeConfirmed,  
			 @OriginalPartTypeId=@OriginalPartTypeId,  
			 @SerialNoIn=@SerialNoIn,  
			 @SerialNoOut=@SerialNoOut,  
			 @IsOverwriteLife=@IsOverwriteLife,  
			 @OverwriteLifeAchieved=@OverwriteLifeAchieved,  
			 @ConditionMonitoringIntervention=@ConditionMonitoringIntervention,  
			 @ShutdownID=-1,  
			 @FailedPartListPosition=@FailedPartListPosition,  
			 @FailedPartListGroup=@FailedPartListGroup,  
			 @FailedPartLifeAchieved=@FailedPartLifeAchieved,  
			 @PartSerialNoRemoved=@PartSerialNoRemoved,  
			 @PartSerialNoInstalled=@PartSerialNoInstalled,  
			 @LastNotified=@LastNotified,  
			 @ResourceStatusReady=@ResourceStatusReady,  
			 @AuthorisationRequestByID=@AuthorisationRequestByID  
			   
			 IF @Message<>''  
			 BEGIN  
				SELECT 'Cannot update workorder Task_Id ='+CAST(@TaskId AS varchar(50))+': '+ @Message  
				ROLLBACK TRANSACTION  
			 END  
			 ELSE  
				COMMIT TRANSACTION
		END

	SET @Counter=@Counter-1
END


GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[EQS_WORKGROUP_GET_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[EQS_WORKGROUP_GET_P]
GO

create        Procedure [dbo].[EQS_WORKGROUP_GET_P]
/******************************************************************************
	File: 
	Name: EQS_WORKGROUP_GET_P

	Called By: 

	Desc: Returns recordset for Scheduling Gantt Chart BDW Workgroup

	Auth: Alex Lassauniere
	Date: 28/08/09
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	12-Apr-2012	K Nagarajan	E774: Show Remaining Hours.
	21-Jul-2010	V Vasylyeva	CR9055: Speeded up
*******************************************************************************/
	/* Param List */   
	@UserID int=0,
	@BranchID varchar(max)='',
	@SiteID varchar(max)='',
	
	@StartDate datetime,
	@Display int=0,	--0: Per Day, 1: Per Hour

	@isGetAnyway bit=1,
	@CheckXML varchar(max)=''

   
AS

--------------------------------------------------------

DECLARE @EndDate Datetime

SET @StartDate=CONVERT(VARCHAR,@StartDate,101)
SET @EndDate=DATEADD(ms,-2,DATEADD(week,2,@StartDate))
SET @StartDate=DATEADD(ms,1,@StartDate)

--SELECT @StartDate,@EndDate

--1: Get Sites
CREATE TABLE #SITE(SiteID int PRIMARY KEY,Site varchar(100) COLLATE database_default)
INSERT INTO #SITE
EXEC EQP_SELECTOR_GET_P	@AnalyseBy='SITE',
						@UserID=@UserID,
						@EquipmentTypeId=1,
						@AllowNullAnalyseBy=1,
						@BranchId=@BranchId,
						@SiteId=@SiteId

--SELECT * FROM #SITE



--2: Get Workgroups
SELECT	WG.Work_Group_ID AS WorkGroupID, S.Site,WG.Description AS Workgroup, WG.Work_Group_Code AS Code,
		WG.Default_Record AS Def, WG.PctTargetAvailability AS Target
INTO #WKG
FROM
		WORK_GROUP WG INNER JOIN
		#SITE S ON WG.Site_ID=S.SiteID
ORDER BY S.Site,WG.Description

SELECT * FROM #WKG



--Time declarations
DECLARE @ShiftLength INT
IF @Display = 0 
	SET @ShiftLength = 24
ELSE
	SET @ShiftLength = 1


SELECT DISTINCT ShiftStartTime,CONVERT(CHAR(5),ShiftStartTime,8) AS STT 
INTO #TT
FROM (
	SELECT @StartDate AS ShiftStartTime UNION ALL
	SELECT DATEADD(hh,@ShiftLength, @StartDate) AS ShiftStartTime UNION ALL
	SELECT DATEADD(hh,@ShiftLength*2, @StartDate) AS ShiftStartTime UNION ALL
	SELECT DATEADD(hh,@ShiftLength*3, @StartDate) AS ShiftStartTime UNION ALL
	SELECT DATEADD(hh,@ShiftLength*4, @StartDate) AS ShiftStartTime UNION ALL
	SELECT DATEADD(hh,@ShiftLength*5, @StartDate) AS ShiftStartTime UNION ALL
	SELECT DATEADD(hh,@ShiftLength*6, @StartDate) AS ShiftStartTime UNION ALL
	SELECT DATEADD(hh,@ShiftLength*7, @StartDate) AS ShiftStartTime UNION ALL
	SELECT DATEADD(hh,@ShiftLength*8, @StartDate) AS ShiftStartTime UNION ALL
	SELECT DATEADD(hh,@ShiftLength*9, @StartDate) AS ShiftStartTime UNION ALL
	SELECT DATEADD(hh,@ShiftLength*10, @StartDate) AS ShiftStartTime UNION ALL
	SELECT DATEADD(hh,@ShiftLength*11, @StartDate) AS ShiftStartTime UNION ALL
	SELECT DATEADD(hh,@ShiftLength*12, @StartDate) AS ShiftStartTime UNION ALL
	SELECT DATEADD(hh,@ShiftLength*13, @StartDate) AS ShiftStartTime UNION ALL
	SELECT DATEADD(hh,@ShiftLength*14, @StartDate) AS ShiftStartTime UNION ALL
	SELECT DATEADD(hh,@ShiftLength*15, @StartDate) AS ShiftStartTime UNION ALL
	SELECT DATEADD(hh,@ShiftLength*16, @StartDate) AS ShiftStartTime UNION ALL
	SELECT DATEADD(hh,@ShiftLength*17, @StartDate) AS ShiftStartTime UNION ALL
	SELECT DATEADD(hh,@ShiftLength*18, @StartDate) AS ShiftStartTime UNION ALL
	SELECT DATEADD(hh,@ShiftLength*19, @StartDate) AS ShiftStartTime UNION ALL
	SELECT DATEADD(hh,@ShiftLength*20, @StartDate) AS ShiftStartTime UNION ALL
	SELECT DATEADD(hh,@ShiftLength*21, @StartDate) AS ShiftStartTime UNION ALL
	SELECT DATEADD(hh,@ShiftLength*22, @StartDate) AS ShiftStartTime UNION ALL
	SELECT DATEADD(hh,@ShiftLength*23, @StartDate) AS ShiftStartTime
	) As Hours
ORDER BY ShiftStartTime



SELECT StartTime,EndTime
INTO #CH
FROM 
	(SELECT DATEADD(mi, DATEPART(mi, TT.STT),(DATEADD(hh, DATEPART(hh, TT.STT), CALENDAR_DATE))) AS StartTime,
			DATEADD(mi, DATEPART(mi, TT.STT),(DATEADD(hh, DATEPART(hh, TT.STT)+@ShiftLength, CALENDAR_DATE))) AS EndTime
	FROM CALENDAR_DATES
		CROSS JOIN #TT TT
	WHERE CALENDAR_DATE	BETWEEN DATEADD(hh, -24, @StartDate) AND @EndDate)H
WHERE StartTime	>= @StartDate AND StartTime<@EndDate
GROUP BY StartTime,EndTime


--3: Date Columns
SELECT StartTime
FROM #CH
ORDER BY StartTime


--select * into z_SITE from #SITE
--select * into z_WKG from #WKG
--select * into z_CH from #CH
--select * into z_TT from #TT

--return

/*VV CR9055*/

DECLARE @StartT datetime
DECLARE @EndT datetime

SELECT @StartT=MIN(StartTime),@EndT=MAX(EndTime) FROM #CH

SELECT	ERA.WorkGroupID, ERA.From_Time,ERA.To_Time,ERA.Labour_Qty
INTO #z_B1
FROM  
WORKGROUP_REPORT_ALLOCATION_V ERA
	INNER JOIN
#WKG WG 
	ON ERA.WorkGroupID=WG.WorkGroupID
WHERE ERA.From_Time<=@EndT AND ERA.To_Time>=@StartT


--select * from #z_B1 return

--4: Get Availability Data
SELECT 	StartTime,WorkGroupID,
		CASE WHEN Alloc=0 AND Avail=0 THEN NULL	--shows as no avail setup
			 WHEN Alloc>0 AND Avail=0 THEN 2	--force it as overallocated
			 ELSE Alloc / Avail END	AS Availability,
			  ROUND(Avail - Alloc,0) AS HoursToDisplay
FROM
	(SELECT
		StartTime,WorkGroupID,
		SUM(CASE WHEN Available=0 THEN Hours ELSE 0 END) AS Alloc,
		SUM(CASE WHEN Available=1 THEN Hours ELSE 0 END) AS Avail 
	FROM
		  (	-- Workgroup availability
			SELECT	WRA.WorkGroupID, 
					SUM(convert(float,Available_Man_Hours)) as Hours,
					1 AS Available,
					CH.StartTime as StartTime
			FROM  
				WORKGROUP_REPORT_AVAILABILITY_V WRA INNER JOIN
				#CH CH ON (WRA.From_Time >= CH.StartTime AND WRA.From_Time<CH.EndTime) INNER JOIN
				#WKG WG ON WRA.WorkGroupID=WG.WorkGroupID
			GROUP BY WRA.WorkGroupID,CH.StartTime

			UNION ALL

			-- WorkGroup allocation
			SELECT	  WorkGroupID,
					  SUM(case 
							when From_Time BETWEEN StartTime AND Shift_End then
								  case when To_Time BETWEEN StartTime AND Shift_End
										then convert(float,datediff(mi,From_Time,To_Time))/60
										else convert(float,datediff(mi,From_Time,Shift_End))/60
								  end
							when To_Time BETWEEN StartTime AND Shift_End then 
								  convert(float,datediff(mi,StartTime,To_Time))/60  --Note only one case here where From_Time before StartTime as other is handled in previous statement
							when To_Time<StartTime OR From_Time>Shift_End then
								  convert(float,0)
							else
								  convert(float,datediff(mi,StartTime,Shift_End))/60	--AL: 23/09/08
							end * Labour_Qty),
					  0,
					  StartTime
			FROM
					/*VV CR9055(SELECT		ERA.WorkGroupID, 
								From_Time,To_Time,
								CH.StartTime as StartTime, CH.EndTime as Shift_End, 
								Labour_Qty
					FROM  
								WORKGROUP_REPORT_ALLOCATION_V ERA INNER JOIN
								#CH CH ON
									(ERA.From_Time BETWEEN CH.StartTime AND CH.EndTime) OR
									(ERA.To_Time BETWEEN CH.StartTime AND CH.EndTime) OR
									(ERA.From_Time<CH.StartTime AND ERA.To_Time>CH.EndTime) INNER JOIN
								#WKG WG ON ERA.WorkGroupID=WG.WorkGroupID
					)B*/
					(SELECT	B1.WorkGroupID, B1.From_Time,B1.To_Time,CH.StartTime as StartTime, 
					CH.EndTime as Shift_End, B1.Labour_Qty
					FROM  
					#z_B1 B1
						INNER JOIN
					#CH CH 
						ON B1.From_Time <= CH.EndTime
						AND B1.To_Time >= CH.StartTime 
					)B
			GROUP BY    WorkGroupID,StartTime,From_Time,To_Time
			)C
	GROUP BY
			StartTime,WorkGroupID
	)D

--Cleanup
DROP TABLE #SITE,#WKG,#TT,#CH

GO



if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[IC_EXTRACT_FACT_WORKORDER_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[IC_EXTRACT_FACT_WORKORDER_P]
GO

create         Procedure [dbo].[IC_EXTRACT_FACT_WORKORDER_P]
/******************************************************************************
	Name: IC_EXTRACT_FACT_WORKORDER_P

	Called By: 

	Desc: 
             
	Auth: Koushik Nagarajan
	Date: 07 Oct 2009
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	-----------	---------------------------------------
	29 Sep 11	V Vasylyeva	E638 added new fields
	13 Jan 12	K Nagarajan 3136: Include Job Ready Status
	29 Apr 12	K Nagarajan	795: As a backfix to 795 (8.5D Enahancement), we are ignoring this field.
*******************************************************************************/
	/* Param List */
	@BranchId varchar(MAX)='',
	@SiteId varchar(MAX)='',
	@FleetId varchar(MAX)='',
	@ModelId varchar(MAX)='',
	@EqpPlanId varchar(MAX)='',
	@ParentEqpPlanId varchar(MAX)='',
	@ContractId	VARCHAR(MAX) = ''  ,
	@DateNotifiedFrom VARCHAR(100) = '01-Jan-1950',
	@DateNotifiedTo	VARCHAR(100) = '31-Dec-2200',
	@ExcludeLabourHours VARCHAR(10) = '0',
	@ExcludeCosts  VARCHAR(10) = '0' 
	
AS
	
SET NOCOUNT ON

SET @DateNotifiedFrom = NULLIF(LTRIM(RTRIM(@DateNotifiedFrom)),'')
SET @DateNotifiedTo = NULLIF(LTRIM(RTRIM(@DateNotifiedTo)),'')
SET @ExcludeLabourHours = NULLIF(LTRIM(RTRIM(@ExcludeLabourHours)),'')
SET @ExcludeCosts = NULLIF(LTRIM(RTRIM(@ExcludeCosts)),'')

DECLARE @DateFrom DATETIME
DECLARE @DateTo DATETIME
SET @DateFrom = ISNULL(@DateNotifiedFrom,'1950-01-01')
SET @DateTo = ISNULL(@DateNotifiedTo,'2200-12-31')

DECLARE @IsExcludeLabour BIT
DECLARE @IsExcludeCost BIT

SET @IsExcludeLabour = ISNULL(@ExcludeLabourHours,0)
SET @IsExcludeCost = ISNULL(@IsExcludeCost,0)



DECLARE @ProjectionTypeId VARCHAR(100)
SET @ProjectionTypeId = '1'
	
DECLARE  @EQP table( 
					EqpPlanID int PRIMARY KEY,
					EqpPlan varchar(100)
					)
					
INSERT INTO @EQP( EqpPlanID , EqpPlan)
EXEC EQP_SELECTOR_GET_P	@AnalyseBy='EQPL ',
						@BranchId=@BranchId,
						@SiteId=@SiteId,
						@FleetId=@FleetId,
						@ModelId=@ModelId,
						@EquipmentId=@EqpPlanId,
						@ParentEqpPlanID=@ParentEqpPlanId,
						@EquipmentTypeId=1,
						@ContractId = @ContractId,
						@ProjectionTypeId = @ProjectionTypeId
	
 
	SELECT 
		DimEqpId,DimTaskHeaderId,DimManufacturerId,DimUOMId,DimWorkorderId,DimPriorityId,DimTaskStatusId,
		DimSourceId,DimRaisedById,DimDateNotifiedId,DimAuthorisedById,DimActualStartDateId,DimActualStartDatetimeId,
		DimTargetDateId,DimPerformAtId,DimWorkgroupId,DimEmployeeId,DimSettlementDateId,DimSymptomId,DimCauseId,
		DimRepairCodeId,DimEMIssueId,DimServiceCodeId,DimOccurrenceTypeId,DimChangeoutCategorisationCodeId,
		DimOriginalPartTypeId,DimWarrantyClaimedById,DimWarrantyClaimedByAMTUserId,DimWarrantyClaimDateId,
		DimWarrantyClaimSystemDateId,DimWarrantyClaimStatusId,WarrantyFromERP,Redo,CMIntervention,
		StrategyPartsSell,StrategyLabourSell,StrategyMiscSell,StrategyLabourHours,PlannedPartsSell,PlannedLabourSell,PlannedMiscSell,PlannedLabourHours,PlannedDuration,
		ActualPartsSell,ActualLabourSell,ActualMiscSell,ActualLabourHours,ActualDuration,Break_Down,LifeAchieved,LifeConfirmed,UsageAmount,
		PotentialWarranty,Warranty_Claimable,OverwriteLife,OverwriteLifeAchieved,
		/*VV E638*/
		ReceiptedIntoStock,
		/*KN 795*/
		NULL AS DimRebuildPartTypeId,DimRebuildPartId,DeliveryToWorkshopHours,
		WaitingForRebuildHours,RebuildHours,DeliveryToWarehouseHours,IsStrategy,IsConfirmed,
		ExpectedLife, DimJobReadyStatusID
	FROM IC_EXTRACT_FACT_WORKORDER_V V
  		INNER JOIN @EQP ET ON ET.EqpPlanID=V.DimEqpId 
  	WHERE 
  	DimDateNotifiedId >= CAST(CONVERT(VARCHAR(8), @DateFrom, 112) AS INT) 
  	AND 
  	DimDateNotifiedId <= CAST(CONVERT(VARCHAR(8), @DateTo, 112) AS INT)
 
SET NOCOUNT OFF

GO


if exists (select * from dbo.sysobjects where id = object_id(N'IMPORT_PROJECTION_P') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure IMPORT_PROJECTION_P
GO

create PROCEDURE [dbo].[IMPORT_PROJECTION_P]
/******************************************************************************
	
	Name: IMPORT_PROJECTION_P

	Called By: 

	Desc: 

	Auth: 	Veronika Vasylyeva
	Date: 	29 Jul 2008
*******************************************************************************
		Change History
*******************************************************************************
Date:		Author:		Description:
--------	--------	----------------------------------------
 7 May 12	VV	#4145 Old_Ext_Id
27 Apr 12	VV	E790 Added Old_External_Identifier
23 Feb 12	RJ	3145 Added @InterfaceSource to not clear Import_Error table if called from a Connector
1 Oct 10	VV	E316 Added Tag_Id, Rating  
26 Nov 08	VV	Added Update_Scheduling_Task_Only  
*******************************************************************************/
	/* Param List */

	@XMLDocument XML,
	@ImportFileName varchar(1000),
	@UserId int=0,
	@InterfaceSource int=0,   --3145
	@NoErrors int=0 OUTPUT
AS

DECLARE @docHandle  int
DECLARE @CurrDate datetime



EXEC sp_xml_preparedocument @docHandle OUTPUT, @xmlDocument

CREATE TABLE #z_Import_Projection(
Line_No int IDENTITY(1,1),Equipment_No varchar(2000) COLLATE DATABASE_DEFAULT, Model varchar(2000) COLLATE DATABASE_DEFAULT, 
Serial_No varchar(2000) COLLATE DATABASE_DEFAULT, Registration_Counter varchar(2000) COLLATE DATABASE_DEFAULT, Equip_Name varchar(2000) COLLATE DATABASE_DEFAULT, Projection_Type varchar(2000) COLLATE DATABASE_DEFAULT, Projection_Name varchar(2000) COLLATE DATABASE_DEFAULT, 
[Description] varchar(2000) COLLATE DATABASE_DEFAULT, Global_Code varchar(2000) COLLATE DATABASE_DEFAULT,
Component_Code varchar(2000) COLLATE DATABASE_DEFAULT, Modifier_Code varchar(2000) COLLATE DATABASE_DEFAULT, Task_Type varchar(2000) COLLATE DATABASE_DEFAULT, Task_Counter varchar(2000) COLLATE DATABASE_DEFAULT, Inactive_Task varchar(2000) COLLATE DATABASE_DEFAULT, Unassigned_Task varchar(2000) COLLATE DATABASE_DEFAULT, Planning_Task varchar(2000) COLLATE DATABASE_DEFAULT, 
Planning_Lead_Days varchar(2000) COLLATE DATABASE_DEFAULT, Operational_Criticality varchar(2000) COLLATE DATABASE_DEFAULT, Task_Manufacturer_Code varchar(2000) COLLATE DATABASE_DEFAULT, Part_SOS varchar(2000) COLLATE DATABASE_DEFAULT, Primary_Part_Number varchar(2000) COLLATE DATABASE_DEFAULT, Group_Number varchar(2000) COLLATE DATABASE_DEFAULT, 
Rotable_Part_Number varchar(2000) COLLATE DATABASE_DEFAULT, Warranty_Days varchar(2000) COLLATE DATABASE_DEFAULT, Warranty_Usage varchar(2000) COLLATE DATABASE_DEFAULT, UOM varchar(2000) COLLATE DATABASE_DEFAULT, Schedule_On_Last_Scheduled varchar(2000) COLLATE DATABASE_DEFAULT, First varchar(2000) COLLATE DATABASE_DEFAULT, Interval varchar(2000) COLLATE DATABASE_DEFAULT, Final varchar(2000) COLLATE DATABASE_DEFAULT, Last_Change_Usage varchar(2000) COLLATE DATABASE_DEFAULT, 
Last_Change_Date varchar(2000) COLLATE DATABASE_DEFAULT, External_Identifier varchar(2000) COLLATE DATABASE_DEFAULT, Suppression_Group varchar(2000) COLLATE DATABASE_DEFAULT, Suppression_Counter varchar(2000) COLLATE DATABASE_DEFAULT, Sibling_Interval varchar(2000) COLLATE DATABASE_DEFAULT, Dependency_Group varchar(2000) COLLATE DATABASE_DEFAULT, Dependency_Counter varchar(2000) COLLATE DATABASE_DEFAULT, 
Inspection_Logic_Task_Type varchar(2000) COLLATE DATABASE_DEFAULT, Inspection_Logic_Offset varchar(2000) COLLATE DATABASE_DEFAULT, Performance_Strategy varchar(2000) COLLATE DATABASE_DEFAULT, Performance_Strategy_Reason varchar(2000) COLLATE DATABASE_DEFAULT, Changeout_Guidelines varchar(2000) COLLATE DATABASE_DEFAULT, 
ERP_Component_Code varchar(2000) COLLATE DATABASE_DEFAULT, ERP_Modifier_Code varchar(2000) COLLATE DATABASE_DEFAULT, ERP_Scheduling_Task varchar(2000) COLLATE DATABASE_DEFAULT, Scheduling_Task varchar(2000) COLLATE DATABASE_DEFAULT, Last_Occurrence varchar(2000) COLLATE DATABASE_DEFAULT, Last_Occ_Date varchar(2000) COLLATE DATABASE_DEFAULT, Last_Scheduled varchar(2000) COLLATE DATABASE_DEFAULT, 
Last_Sched_Date varchar(2000) COLLATE DATABASE_DEFAULT, Next_Occurrence varchar(2000) COLLATE DATABASE_DEFAULT, Next_Occ_Date varchar(2000) COLLATE DATABASE_DEFAULT, Job_Code varchar(2000) COLLATE DATABASE_DEFAULT, Currency varchar(2000) COLLATE DATABASE_DEFAULT, Standard_Job_Reference varchar(2000) COLLATE DATABASE_DEFAULT, Cost_Bearer varchar(2000) COLLATE DATABASE_DEFAULT, Cost_Centre varchar(2000) COLLATE DATABASE_DEFAULT, Work_Group varchar(2000) COLLATE DATABASE_DEFAULT, 
Part_Type varchar(2000) COLLATE DATABASE_DEFAULT, Health_Safety varchar(2000) COLLATE DATABASE_DEFAULT, Pricing_Date varchar(2000) COLLATE DATABASE_DEFAULT, Consumable_Qty varchar(2000) COLLATE DATABASE_DEFAULT, Consumable_Top_Up varchar(2000) COLLATE DATABASE_DEFAULT, Consumable_Price varchar(2000) COLLATE DATABASE_DEFAULT, Parts_Sell varchar(2000) COLLATE DATABASE_DEFAULT, Labour_Sell varchar(2000) COLLATE DATABASE_DEFAULT, Misc_Sell varchar(2000) COLLATE DATABASE_DEFAULT, 
Shop_Labour varchar(2000) COLLATE DATABASE_DEFAULT, Labour_Hours varchar(2000) COLLATE DATABASE_DEFAULT, Labour_Activity varchar(2000) COLLATE DATABASE_DEFAULT, Duration_Hours varchar(2000) COLLATE DATABASE_DEFAULT, Part_Expense varchar(2000) COLLATE DATABASE_DEFAULT, Labour_Expense varchar(2000) COLLATE DATABASE_DEFAULT, Misc_Expense varchar(2000) COLLATE DATABASE_DEFAULT, Part_EDC varchar(2000) COLLATE DATABASE_DEFAULT, Labour_EDC varchar(2000) COLLATE DATABASE_DEFAULT, Misc_EDC varchar(2000) COLLATE DATABASE_DEFAULT, 
Labour_Split varchar(2000) COLLATE DATABASE_DEFAULT, Crane_Cost varchar(2000) COLLATE DATABASE_DEFAULT, Freight_Perc_Parts varchar(2000) COLLATE DATABASE_DEFAULT, Avg_People_Vehicle varchar(2000) COLLATE DATABASE_DEFAULT, Avg_Daily_Work_Hours varchar(2000) COLLATE DATABASE_DEFAULT, Avg_Travel_Hours varchar(2000) COLLATE DATABASE_DEFAULT, Travel_Labour_Rate varchar(2000) COLLATE DATABASE_DEFAULT, 
Travel_Distance varchar(2000) COLLATE DATABASE_DEFAULT, Travel_Rate varchar(2000) COLLATE DATABASE_DEFAULT, Misc_Cost_Per_Trip varchar(2000) COLLATE DATABASE_DEFAULT, System_Source varchar(2000) COLLATE DATABASE_DEFAULT,
/*VV 26 Nov 2008*/
Update_Scheduling_Task_Only  varchar(2000) COLLATE DATABASE_DEFAULT,
/*VV E316*/
Tag_Id varchar(2000) COLLATE DATABASE_DEFAULT, 
Rating varchar(2000) COLLATE DATABASE_DEFAULT,
/*VV E790*/Old_Ext_Id varchar(2000) COLLATE DATABASE_DEFAULT
PRIMARY KEY(Line_No))


INSERT INTO #z_Import_Projection(
Equipment_No, Model, Serial_No, Registration_Counter, Equip_Name, Projection_Type, Projection_Name, 
[Description],Global_Code, Component_Code, Modifier_Code, Task_Type, Task_Counter, Inactive_Task, Unassigned_Task, Planning_Task, 
Planning_Lead_Days, Operational_Criticality, Task_Manufacturer_Code, Part_SOS, Primary_Part_Number, Group_Number,  
Rotable_Part_Number, Warranty_Days, Warranty_Usage, UOM, Schedule_On_Last_Scheduled, First, Interval, Final, Last_Change_Usage, 
Last_Change_Date, External_Identifier, Suppression_Group, Suppression_Counter, Sibling_Interval, Dependency_Group, Dependency_Counter, 
Inspection_Logic_Task_Type, Inspection_Logic_Offset, Performance_Strategy, Performance_Strategy_Reason, Changeout_Guidelines, 
ERP_Component_Code, ERP_Modifier_Code, ERP_Scheduling_Task, Scheduling_Task, Last_Occurrence, Last_Occ_Date, Last_Scheduled, 
Last_Sched_Date, Next_Occurrence, Next_Occ_Date, Job_Code, Currency, Standard_Job_Reference, Cost_Bearer, Cost_Centre, Work_Group, 
Part_Type, Health_Safety, Pricing_Date, Consumable_Qty, Consumable_Top_Up, Consumable_Price, Parts_Sell, Labour_Sell, Misc_Sell, 
Shop_Labour, Labour_Hours, Labour_Activity, Duration_Hours, Part_Expense, Labour_Expense, Misc_Expense, Part_EDC, Labour_EDC, Misc_EDC, 
Labour_Split, Crane_Cost, Freight_Perc_Parts, Avg_People_Vehicle, Avg_Daily_Work_Hours, Avg_Travel_Hours, Travel_Labour_Rate, 
Travel_Distance, Travel_Rate, Misc_Cost_Per_Trip, System_Source,/*VV 26 Nov 2008*/Update_Scheduling_Task_Only,
/*VV E316*/Tag_Id,Rating,/*VV E790*/Old_Ext_Id)
SELECT     
Equipment_No AS Equipment_No, Model, Serial_No, Registration_Counter, Equip_Name, Projection_Type, Projection_Name, 
[Description], Global_Code,Component_Code, Modifier_Code, Task_Type, Task_Counter, Inactive_Task, Unassigned_Task, Planning_Task, 
Planning_Lead_Days, Operational_Criticality, Task_Manufacturer_Code, Part_SOS, Primary_Part_Number, Group_Number,  
Rotable_Part_Number, Warranty_Days, Warranty_Usage, UOM, Schedule_On_Last_Scheduled, [First], Interval, Final, Last_Change_Usage, 
Last_Change_Date, External_Identifier, Suppression_Group, Suppression_Counter, Sibling_Interval, Dependency_Group, Dependency_Counter, 
Inspection_Logic_Task_Type, Inspection_Logic_Offset, Performance_Strategy, Performance_Strategy_Reason, Changeout_Guidelines, 
ERP_Component_Code, ERP_Modifier_Code, ERP_Scheduling_Task, Scheduling_Task, Last_Occurrence, Last_Occ_Date, Last_Scheduled, 
Last_Sched_Date, Next_Occurrence, Next_Occ_Date, Job_Code, Currency, Standard_Job_Reference, Cost_Bearer, Cost_Centre, Work_Group, 
Part_Type, Health_Safety, Pricing_Date, Consumable_Qty, Consumable_Top_Up, Consumable_Price, Parts_Sell, Labour_Sell, Misc_Sell, 
Shop_Labour, Labour_Hours, Labour_Activity, Duration_Hours, Part_Expense, Labour_Expense, Misc_Expense, Part_EDC, Labour_EDC, Misc_EDC, 
Labour_Split, Crane_Cost, Freight_Perc_Parts, Avg_People_Vehicle, Avg_Daily_Work_Hours, Avg_Travel_Hours, Travel_Labour_Rate, 
Travel_Distance, Travel_Rate, Misc_Cost_Per_Trip, System_Source,/*VV 26 Nov 2008*/Update_Scheduling_Task_Only,
/*VV E316*/Tag_Id,Rating,/*VV E790*/Old_Ext_Id
FROM OPENXML(@docHandle, N'/I_PROJECTEDTASKs/I_PROJECTEDTASK',2) WITH #z_Import_Projection

EXEC sp_xml_removedocument @docHandle

--Delete the data
IF EXISTS(SELECT Import_File_Name FROM IMPORT_PROJECTION WHERE Import_File_Name=@ImportFileName)
BEGIN
	DELETE IMPORT_PROJECTION WHERE Import_File_Name=@ImportFileName
END
--3145 Only clear Import_Error table if it is a File Connector (Oracle can return errors earlier in the process)
IF @InterfaceSource=0  AND EXISTS(SELECT ImportFileName FROM IMPORT_ERROR WHERE ImportFileName=@ImportFileName)  
BEGIN  
 DELETE IMPORT_ERROR WHERE ImportFileName=@ImportFileName  
END  

SET @CurrDate=GETDATE()

INSERT INTO IMPORT_PROJECTION(
Line_No,Import_File_Name,
Equipment_No, Model, Serial_No, Registration_Counter, Equip_Name, Projection_Type, Projection_Name, 
Task_Description,Global_Code, Component_Code, Modifier_Code, Task_Type, Task_Counter, Inactive_Task, Unassigned_Task, Planning_Task, 
Planning_Lead_Days, Operational_Criticality, Task_Manufacturer_Code, Part_SOS, Primary_Part_Number, Group_Number,  
Rotable_Part_Number, Warranty_Days, Warranty_Usage, UOM, Schedule_On_Last_Scheduled, [First], Interval, Final, Last_Change_Usage, 
Last_Change_Date, External_Identifier, Suppression_Group, Suppression_Counter, Sibling_Interval, Dependency_Group, Dependency_Counter, 
Inspection_Logic_Task_Type, Inspection_Logic_Offset, Performance_Strategy, Performance_Strategy_Reason, Changeout_Guidelines, 
ERP_Component_Code, ERP_Modifier_Code, ERP_Scheduling_Task, Scheduling_Task, Last_Occurrence, Last_Occ_Date, Last_Scheduled, 
Last_Sched_Date, Next_Occurrence, Next_Occ_Date, Job_Code, Currency, Standard_Job_Reference, Cost_Bearer, Cost_Centre, Work_Group, 
Part_Type, Health_Safety, Pricing_Date, Consumable_Qty, Consumable_Top_Up, Consumable_Price, Parts_Sell, Labour_Sell, Misc_Sell, 
Shop_Labour, Labour_Hours, Labour_Activity, Duration_Hours, Part_Expense, Labour_Expense, Misc_Expense, Part_EDC, Labour_EDC, Misc_EDC, 
Labour_Split, Crane_Cost, Freight_Perc_Parts, Avg_People_Vehicle, Avg_Daily_Work_Hours, Avg_Travel_Hours, Travel_Labour_Rate, 
Travel_Distance, Travel_Rate, Misc_Cost_Per_Trip, System_Source,Last_Mod_By_User_Id,Last_Mod_Date,/*VV 26 Nov 2008*/Update_Scheduling_Task_Only,
/*VV E316*/Tag_Id,Rating,/*VV E790*/Old_Ext_Id)
SELECT
Line_No,@ImportFileName AS Import_File_Name,
Equipment_No, Model, Serial_No, Registration_Counter, Equip_Name, Projection_Type, Projection_Name, 
[Description],Global_Code, Component_Code, Modifier_Code, Task_Type, Task_Counter, Inactive_Task, Unassigned_Task, Planning_Task, 
Planning_Lead_Days, Operational_Criticality, Task_Manufacturer_Code, Part_SOS, Primary_Part_Number, Group_Number,  
Rotable_Part_Number, Warranty_Days, Warranty_Usage, UOM, Schedule_On_Last_Scheduled, [First], Interval, Final, Last_Change_Usage, 
Last_Change_Date, External_Identifier, Suppression_Group, Suppression_Counter, Sibling_Interval, Dependency_Group, Dependency_Counter, 
Inspection_Logic_Task_Type, Inspection_Logic_Offset, Performance_Strategy, Performance_Strategy_Reason, Changeout_Guidelines, 
ERP_Component_Code, ERP_Modifier_Code, ERP_Scheduling_Task, Scheduling_Task, Last_Occurrence, Last_Occ_Date, Last_Scheduled, 
Last_Sched_Date, Next_Occurrence, Next_Occ_Date, Job_Code, Currency, Standard_Job_Reference, Cost_Bearer, Cost_Centre, Work_Group, 
Part_Type, Health_Safety, Pricing_Date, Consumable_Qty, Consumable_Top_Up, Consumable_Price, Parts_Sell, Labour_Sell, Misc_Sell, 
Shop_Labour, Labour_Hours, Labour_Activity, Duration_Hours, Part_Expense, Labour_Expense, Misc_Expense, Part_EDC, Labour_EDC, Misc_EDC, 
Labour_Split, Crane_Cost, Freight_Perc_Parts, Avg_People_Vehicle, Avg_Daily_Work_Hours, Avg_Travel_Hours, Travel_Labour_Rate, 
Travel_Distance, Travel_Rate, Misc_Cost_Per_Trip, System_Source,@UserId AS Last_Mod_By_User_Id,@CurrDate AS Last_Mod_Date,
/*VV 26 Nov 2008*/Update_Scheduling_Task_Only,/*VV E316*/Tag_Id,Rating,/*VV E790*/Old_Ext_Id
FROM #z_Import_Projection


GO


if exists (select * from dbo.sysobjects where id = object_id(N'PROJECTED_TASK_IMPORT_P') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure PROJECTED_TASK_IMPORT_P
GO

create  PROCEDURE [dbo].[PROJECTED_TASK_IMPORT_P]
/******************************************************************************
	File: 
	Name: PROJECTED_TASK_IMPORT_P
	Desc: 1. PROJECTED_TASK_IMPORT_P

	Auth: Koushik Nagarajan
	Date: 16-June-2007
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	09-09-2007	KN			Updated Projected Task if the Next occ is Changed.
	11-09-2007	KN			Updated the FIRST only if it not NULL.
	17-09-2007	KN			Updated the LAST CHANGE/ FIRST Rules.
	14-may-2008	KN			DELETE Linked Cost Allocation while Deleting the Scheduling Task.
	 1-Aug-2008	VV			Changes in import for 8.2
	 5 Sep 2008	VV			If manufacturer is not found, raise error
	15 Sep 2008	KN			Populated Review Status Id while Adding a Projected Task.
	16 Sep 2008	KN			Reset Next Occ if it not a Planning Task.
	16 Sep 2008 AL			Replace SAPQUOM with Short_Desc
	23 Sep 2008	KN			Chose Corrrect Projection Type while selecting the Scheduling Task.
	23 Oct 2008	VV			Took out the check for strategy task in MESSAGE table.
							CR7575 Pricing date must be less or equal current date
	 3 Nov 2008	VV			CR7646 labour share shall be set to 100 if null
							CR7648 Default planning lead time is not being used where this is not supplied (or is ZERO)
							CR7649 Planning_Task flag
	4 Nov 2008	VV/KN		Set planning lead days to 0 if planning flag is set to 0
	7-Nov-2008	VV			CR7687 Relink to scheduling tasks . Also fixed work group.
   13-Nov-2008	VV			Fixed duplicated records
   17-Nov-2008	VV			Do not show component code or equipment missing errors if task is inactive
							Changed Query which identifies projected task groups
	19-Nov-2008	VV			Put Distinct into scheduling task add
	21-Nov-2008	VV			CR7741 Changed equipment_No from 12 to 20
	24-Nov-2008	VV			Added Update_Scheduling_Task_Only
	28-Nov-2008	VV			CR7749 If dates are 0 set them to NULL
							Fixed Last_Occ_Date
	 5-Dec-2008	VV			CR7772 Delete scheduling task details only for the inactive tasks
	 8-Dec-2008	VV			CR7775 Do not set last change usage to 0 if it is empty
	12 Jan 09	V Vasylyeva	CR7825 Repair Reserve task is not deleted if parent task performance strategy is set 
							to blank.
	14-Apr-09	V Vasylyeva	CR7985 Increased Task_Counter from 10 to 50 char
	21-Apr-09	V Vasylyeva	CR8010 If performance strategy is not supplied do not reset the performance strategy and 
							do not delete the task.
	25-May-09	V Vasylyeva	CR8131: Increase UOM to 50 char
	 2-Jul-09	V Vasylyeva	CR8302: added EXEC LABOUR_RATES_MISSING_ADD_P
	20 Aug 2009	V Vasylyeva	CR8375	Increasing Modifier Code to 50 char
	28 Sep 2009	V Vasylyeva	CR8400: Part number shall be 50 char
	26 Nov 2009	AL			CR8457: removed End_Use_Code and AllCompCode
	 2 Jun 2010	V Vasylyeva	CR8888: Do not delete if the plant jornals are linked 
	 28-Aug-10	K Nagarajan	#288: Allow zero counter
	 5 Oct 2010	V Vasylyeva	E316 Added Tag_Id, Rating
	 11-Jan-11	K Nagarajan	Enhancement#395: Interval will no longer be a required field
  	24 Mar 11   G Dhillon   Changed the length of Task_Counter from 50 to 100 
 	07 Apr 11   G Dhillon   Changed the length of External_Identifier from 50 to 100
 							Changed the length of Equipment_No from 20 to 50
 							Changed the length of TAG_ID from 50 to 100
    10 May 11   G Dhillon   Changed the where condition ISNULL(IPT.ProjTaskId,0) to have ISNULL for external identifier check 
    12 May 11	G Dhillon	#Enh:527 to choose external identifier to update strategy task
    10 May 11	V Vasylyeva	#1837: Errors in import
    28 Jul 11   G Dhillon   #2234-Fixed the issue of NULL UOM
    01 Aug 11   G Dhillon   #E610-Write whole record for Connector and just description for File Import
    05 Aug 11   G Dhillon	#E610 Added condition of filename while adding error record into import error
	 5 Sep 11	V Vasylyeva	#2370: Where the last Performed in the interface file> last performed in AMT 
							then update last scheduled to the value from the interface file.
							Note1: On creation then just create with the data that has been provided 
							(ie create with whatever last scheduled has been provided).
							Note 2:  Last Scheduled/performed could be either USAGE or DATE.  
							Always base this off the DATE.
	24 Sep 11   GD          fixed 2481 changed the data type of Import Record to varchar(MAX)
	17 Oct 11   GD          Fixed 2634 
	10 Feb 11	V Vasylyeva	#3469 If Job fields are not supplied - do not change them
							If P/L/M are not supplied - do not change the pricing date
	24 Apr 12	V Vasylyeva	E790 Old_External_Identifier
	26 Apr 12	V Vasylyeva	E799 Enable Advanced Scheduling Logic to be created in AMT
	 7 May 12	V Vasylyeva	#4145  Old_Ext_Id
	10 May 12	V Vasylyeva	#4169 Unlink electronic workscope templates if strategy
							jobs are deleted
	10 May 12	V Vasylyeva	#4135
*******************************************************************************/
	/* Param List */
	@ImportFileName varchar(1000),
	@NoErrors int=0 OUTPUT,
	@EqpProjIdTo int=0,
	@Esc_Desc_Prices bit=0,
	@LeavePricingDate bit=0,
	@NewPricingDate datetime=NULL,
	@InterfaceSource int=0
	
AS


SET NOCOUNT ON
DECLARE @ModelSerialSeparator varchar(5)
DECLARE @TodaysDate datetime
DECLARE @ErrorTypeBusRules int
DECLARE @ErrorTypeParsing int
DECLARE @PlanningDaysDefault INT
DECLARE @ToleranceHours INT
DECLARE @ApplySpecialNextOccToIgnoreRules BIT
DECLARE @PrimaryCurrency int
DECLARE @TypeCur int
DECLARE @TypeBud int
DECLARE @TypeAlt int
DECLARE @TypeArc int
DECLARE @TypeCen int
DECLARE @TypeEC int
DECLARE @TypeED int
DECLARE @SubSystemId INT
DECLARE @DefCB int
DECLARE @DefJobCodeId int
DECLARE @DefOccTypeId int
DECLARE @DefGCC int
DECLARE @DefPartTypeId int
DECLARE @DefGPT int
DECLARE @LastPerfUOM int
DECLARE @LastPerfDate int
DECLARE @UseSchedulingSystemLastOcc bit
DECLARE @ProjTaskId varchar(max)
DECLARE @EscCosts bit
--#Enh 527
DECLARE @UpdateStrategyTaskCodes bit

DECLARE @TypeVarchar int
DECLARE @TypeInt int
DECLARE @TypeFloat int
DECLARE @TypeBit int
DECLARE	@TypeDateInt int
/*VV E799*/
DECLARE @UpdateAdvancedSchedulingLogic bit

SET @TypeVarchar =1
SET @TypeInt =2
SET @TypeFloat =3
SET @TypeBit =4
SET	@TypeDateInt =5

SET @ErrorTypeParsing=1

SET @EscCosts=0

SET @LastPerfUOM =1
SET @LastPerfDate=3

SET @TypeCur =1
SET @TypeBud =2
SET @TypeAlt =3
SET @TypeArc =4
SET @TypeCen =5
SET @TypeEC =6
SET @TypeED =7



--This is used by copy in projection
SET @EqpProjIdTo=ISNULL(@EqpProjIdTo,0)

IF @Esc_Desc_Prices=1 AND @NewPricingDate IS NOT NULL 
BEGIN
	SET @EscCosts=1
END

DECLARE @LineBreak VARCHAR(2)
SET @LineBreak = CHAR(13) + CHAR(10)

SET @ErrorTypeBusRules=3
SET @NoErrors=0

SET @TodaysDate=GETDATE()

SELECT @ModelSerialSeparator = ISNULL(ModelSerialSeparator,''),
@ApplySpecialNextOccToIgnoreRules = ApplySpecialNextOccToIgnoreRules,
@UseSchedulingSystemLastOcc=UseSchedulingSystemLastOcc
FROM AMT_VARIABLE

EXEC AMT_TYPED_VARIABLE_GET_P @Value_Name='UpdateAdvancedSchedulingLogic',@Varchar_Value=@UpdateAdvancedSchedulingLogic OUTPUT

SET @UpdateAdvancedSchedulingLogic=ISNULL(@UpdateAdvancedSchedulingLogic,1)

SELECT @PlanningDaysDefault = Varchar_Value FROM AMT_TYPED_VARIABLE WHERE Value_Name = 'PlanningDaysDefault'
SELECT @ToleranceHours = Varchar_Value FROM AMT_TYPED_VARIABLE WHERE Value_Name = 'DefaultToleranceHours'

SELECT @PrimaryCurrency=CurrencyId FROM tblCurrencies WHERE PrimaryCurr<>0
SELECT @DefCB=CostBearerId FROM tblCostBearers WHERE Default_Value=1
SELECT @DefGCC=AMT_Component_Code_Id FROM GLOBAL_COMPONENT_CODES WHERE Default_Record<>0
SELECT @DefOccTypeId=OccurrenceTypeId FROM tblOccurrenceTypes WHERE Default_Record<>0
SELECT @DefJobCodeId=JobCodeID FROM tblJobCodes WHERE Default_Record<>0
SELECT @DefPartTypeId=PartTypeId FROM tblPartTypes WHERE PartTypeDefault<>0
SELECT @UpdateStrategyTaskCodes= Varchar_Value FROM AMT_TYPED_VARIABLE where Value_Name='ImportStrategyTaskUseExternalIdentifier'

/*VV #4135*/
declare @InterfaceSource1 int
SET @InterfaceSource1=@InterfaceSource
set @InterfaceSource=0

--Parse the data

CREATE TABLE #z_Message(MessageId int IDENTITY(1,1),Line_No int,ErrorDescription varchar(3000) COLLATE DATABASE_DEFAULT,ImportRecord VARCHAR(MAX)
PRIMARY KEY (MessageId))

INSERT INTO #z_Message(Line_No,ErrorDescription,ImportRecord)
SELECT Line_No, dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Equipment_No', /*VV 21-Nov-08*/50,Equipment_No,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Model', 20,Model,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Serial_No', 50,Serial_No,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Registration_Counter', 20,Registration_Counter,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Equip_Name', 50,Equip_Name,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeInt,'Projection_Type', 0,Projection_Type,1)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Projection_Name', 50,Projection_Name,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Description', 100,Task_Description,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeBit,'Global_Code', 0,Global_Code,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Component_Code', 10,Component_Code,0)+
/*VV CR8375*/
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Modifier_Code', 50,Modifier_Code,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Task_Type', 10,Task_Type,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Task_Counter', /*GD 24-Mar-2011 50*/100,Task_Counter,1)+
dbo.CHECK_IMPORT_DATA_F(@TypeBit,'Inactive_Task', 0,Inactive_Task,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeBit,'Unassigned_Task', 0,Unassigned_Task,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeBit,'Planning_Task', 0,Planning_Task,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeInt,'Planning_Lead_Days', 0,Planning_Lead_Days,1)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Operational_Criticality', 50,Operational_Criticality,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Task_Manufacturer_Code', 20,Task_Manufacturer_Code,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Part_SOS', 10,Part_SOS,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Primary_Part_Number', 50,Primary_Part_Number,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Group_Number', 50,Group_Number,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Rotable_Part_Number', 20,Rotable_Part_Number,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Warranty_Days', 0,Warranty_Days,1)+
dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Warranty_Usage', 0,Warranty_Usage,1)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'UOM', 50,UOM,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeBit,'Schedule_On_Last_Scheduled', 0,Schedule_On_Last_Scheduled,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'First', 0,[First],1)+
dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Interval', 0,Interval,1)+
dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Final', 0,Final,1)+
dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Last_Change_Usage', 0,Last_Change_Usage,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeDateInt,'Last_Change_Date', 0,Last_Change_Date,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'External_Identifier', 100,External_Identifier,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Suppression_Group', 20,Suppression_Group,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeInt,'Suppression_Counter', 0,Suppression_Counter,1)+
dbo.CHECK_IMPORT_DATA_F(@TypeInt,'Sibling_Interval', 0,Sibling_Interval,1)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Dependency_Group', 20,Dependency_Group,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeInt,'Dependency_Counter', 0,Dependency_Counter,1)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Inspection_Logic_Task_Type', 10,Inspection_Logic_Task_Type,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Inspection_Logic_Offset', 0,Inspection_Logic_Offset,1)+
dbo.CHECK_IMPORT_DATA_F(@TypeInt,'Performance_Strategy', 0,Performance_Strategy,1)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Performance_Strategy_Reason', 200,Performance_Strategy_Reason,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Changeout_Guidelines', 1000,Changeout_Guidelines,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'ERP_Component_Code', 10,ERP_Component_Code,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'ERP_Modifier_Code', 10,ERP_Modifier_Code,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'ERP_Scheduling_Task', 50,ERP_Scheduling_Task,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Scheduling_Task', 30,Scheduling_Task,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Last_Occurrence', 0,Last_Occurrence,1)+
dbo.CHECK_IMPORT_DATA_F(@TypeDateInt,'Last_Occ_Date', 0,Last_Occ_Date,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Last_Scheduled', 0,Last_Scheduled,1)+
dbo.CHECK_IMPORT_DATA_F(@TypeDateInt,'Last_Sched_Date', 0,Last_Sched_Date,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Next_Occurrence', 0,Next_Occurrence,1)+
dbo.CHECK_IMPORT_DATA_F(@TypeDateInt,'Next_Occ_Date', 0,Next_Occ_Date,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Job_Code', 10,Job_Code,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Currency', 3,Currency,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Standard_Job_Reference', 500,Standard_Job_Reference,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Cost_Bearer', 10,Cost_Bearer,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Cost_Centre', 30,Cost_Centre,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Work_Group', 10,Work_Group,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Part_Type', 10,Part_Type,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Health_Safety', 50,Health_Safety,0)+
dbo.CHECK_IMPORT_DATA_F(@TypedateInt,'Pricing_Date', 0,Pricing_Date,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Consumable_Qty', 0,Consumable_Qty,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Consumable_Top_Up', 0,Consumable_Top_Up,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Consumable_Price', 0,Consumable_Price,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Parts_Sell', 0,Parts_Sell,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Labour_Sell', 0,Labour_Sell,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Misc_Sell', 0,Misc_Sell,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeBit,'Shop_Labour', 0,Shop_Labour,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Labour_Hours', 0,Labour_Hours,1)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Labour_Activity', 50,Labour_Activity,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Duration_Hours', 0,Duration_Hours,1)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Part_Expense', 10,Part_Expense,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Labour_Expense', 10,Labour_Expense,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Misc_Expense', 10,Misc_Expense,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Part_EDC', 50,Part_EDC,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Labour_EDC', 50,Labour_EDC,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Misc_EDC', 50,Misc_EDC,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Labour_Split', 0,Labour_Split,1)+
dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Crane_Cost', 0,Crane_Cost,1)+
dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Freight_Perc_Parts', 0,Freight_Perc_Parts,1)+
dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Avg_People_Vehicle', 0,Avg_People_Vehicle,1)+
dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Avg_Daily_Work_Hours', 0,Avg_Daily_Work_Hours,1)+
dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Avg_Travel_Hours', 0,Avg_Travel_Hours,1)+
dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Travel_Labour_Rate', 0,Travel_Labour_Rate,1)+
dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Travel_Distance', 0,Travel_Distance,1)+
dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Travel_Rate', 0,Travel_Rate,1)+
dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Misc_Cost_Per_Trip', 0,Misc_Cost_Per_Trip,1)+
/*VV 26-Nov 2008*/
dbo.CHECK_IMPORT_DATA_F(@TypeBit,'Update_Scheduling_Task_Only', 0,Update_Scheduling_Task_Only,0)+

dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'System_Source', 20,System_Source,0)+
/*VV E316*/
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Tag_Id', 100,Tag_Id,0)+
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Rating', 50,Rating,0) +

/*VV E790*/
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Old_Ext_Id', 100,Old_Ext_Id,0)

AS ErrorDescription,
CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
 ,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,Suppression_Group,Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
 FROM IMPORT_PROJECTION  IP WHERE IP.Line_No = IMPORT_PROJECTION.Line_No for XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs')) END
  as ImportRecord

FROM IMPORT_PROJECTION WHERE Import_File_Name=@ImportFileName


--E#395
UPDATE IMPORT_PROJECTION 
SET UOM = ''
WHERE Import_File_Name=@ImportFileName AND NULLIF(Interval,'')  IS NULL

CREATE TABLE #z_I_PROJECTED_TASKS	(
		Line_No INT PRIMARY KEY,
		EqpPlanId INT ,
		EqpProjId INT ,
		ProjTaskId INT ,
		Equipment_No VARCHAR(50) COLLATE database_default /*VV 21-Nov-2008*/,
		ModelId  int,
		SerialNumber VARCHAR(50) COLLATE database_default  ,
		Reg_Counter VARCHAR(20) COLLATE database_default  ,
		Equip_Name  VARCHAR(50) COLLATE database_default ,
		Projection_Type_Id INT ,
		Projection_Name varchar(50) COLLATE database_default ,
		Task_Description varchar(100) COLLATE database_default ,
		ComponentCodeId  int ,
		ModifierId int,
		TaskTypeId int ,
		ApplicationCodeId int,
		Inactive_Task BIT ,
		Unscheduled INT ,
		Planning_Task BIT ,
		Planning_Lead_Time INT ,
		Operational_Criticality_Id int ,
		ManufacturerId int ,
		Part_SOS_Id int,
		PartId int,
		Group_Number VARCHAR(50) COLLATE database_default ,
		Rotable_Part_Id int,
		Warranty_Days FLOAT ,
		Warranty_Usage FLOAT ,
		QUOMId int,
		Schedule_On_Last_Scheduled INT ,
		[First] float  ,
		Frequency FLOAT ,
		Final float,
		Last_Change_Usage FLOAT ,
		Last_Change_Date DATETIME ,
		External_Identifier VARCHAR(100) COLLATE database_default ,
		Schedule_Type_Id int,
		Scheduling_Group_Id int,
		Scheduling_Group_Counter int,
		InspectionTaskTypeId int,
		InspectionOffset float,
		Maintenance_Strategy_Id int,
		PerformanceStrategyReason VARCHAR(200) COLLATE database_default ,
		Changeout_Guidelines VARCHAR(1000) COLLATE database_default ,
		ERP_Component_Code varchar(10) COLLATE database_default ,
		ERP_Modifier_Code varchar(10) COLLATE database_default ,
		ERP_Scheduling_Task varchar(50) COLLATE database_default ,
		SchedulingTaskId int ,
		Last_Occurrence FLOAT ,
		Last_Occ_Date DATETIME ,
		Last_Scheduled FLOAT ,
		Last_Sched_Date DATETIME ,
		Next_Occurrence FLOAT ,
		Next_Occ_Date DATETIME ,
		JobCodeId int,
		CurrencyId int,
		Standard_Job_Reference VARCHAR(500) COLLATE database_default ,
		Cost_Bearer_ID int,
		Cost_Centre_Id int,	
		Work_Group_Id int,
		PartTypeId int,
		Health_Safety_Id int,
		Pricing_Date DATETIME ,
		QtyVolume float,
		PercentTopUp float,
		UnitPrice float,
		PartsCost FLOAT ,
		LaborCost FLOAT ,
		MiscCost FLOAT ,
		Labour_Hrs_Field BIT ,
		LaborHours FLOAT ,
		Labour_Activity_Id int,
		Duration FLOAT ,
		Parts_Cost_Expense_ID int,
		Labour_Cost_Expense_ID int,
		Misc_Cost_Expense_ID int,
		Parts_EDC_ID int,
		Labour_EDC_ID int,
		Misc_EDC_ID int,
		LaborShare float,
		Crane_Cost float,
		Pct_Freight float,
		Avg_No_People float,
		Avg_Daily_Work_Hrs float,
		Avg_Travel_Hrs float,
		Travel_Recovery_Rate_L float,
		Travel_Distance float,
		Travel_Recovery_Rate_V float,
		Misc_Trip_Cost float,
		SystemSourceId int,
		Component_Code varchar(10) COLLATE DATABASE_DEFAULT,
		/*VV CR8375*/
		Modifier_Code varchar(50) COLLATE DATABASE_DEFAULT,
		Task_Type varchar(10) COLLATE DATABASE_DEFAULT,
		Task_Counter varchar(/*VV 14-Apr-2009 10,GD 50*/100) COLLATE DATABASE_DEFAULT,
		Job_Code varchar(10) COLLATE DATABASE_DEFAULT,
		Scheduling_Group varchar(20) COLLATE DATABASE_DEFAULT,
		Sibling_Interval int,
		Scheduling_Group_Type int,
		SchedulingGroupSubTypeId int,
		Work_Group varchar(10) COLLATE DATABASE_DEFAULT,
		Operational_Criticality varchar(50) COLLATE DATABASE_DEFAULT,
		Labour_Activity varchar(50) COLLATE DATABASE_DEFAULT,
		Health_Safety varchar(50) COLLATE DATABASE_DEFAULT,
		Cost_Centre varchar(30) COLLATE DATABASE_DEFAULT,
		Part_Expense varchar(10) COLLATE DATABASE_DEFAULT,
		Labour_Expense varchar(10) COLLATE DATABASE_DEFAULT,
		Misc_Expense varchar(10) COLLATE DATABASE_DEFAULT,
		System_Source varchar(20) COLLATE DATABASE_DEFAULT,
		Primary_Part_Number varchar(50) COLLATE DATABASE_DEFAULT,
		Part_Type varchar(10) COLLATE DATABASE_DEFAULT,
		Eqp_Terminated bit,
		UpdateSchedulingTask bit,
		SiteId int,
		Model varchar(20) COLLATE DATABASE_DEFAULT,
		Valid bit DEFAULT 1,
		Cost_Bearer varchar(10) COLLATE DATABASE_DEFAULT,
		Currency varchar(3) COLLATE DATABASE_DEFAULT,
		PTGroupMin int,
		PTGroupMax int,
		Global_Code bit,
		Inspection_Logic_Task_Type varchar(10) COLLATE DATABASE_DEFAULT,
		Part_SOS varchar(10) COLLATE DATABASE_DEFAULT,
		UOM varchar(50) COLLATE DATABASE_DEFAULT,
		Scheduling_Task varchar(30) COLLATE DATABASE_DEFAULT,
		Consumable bit,
		RotableId int,
		Task_Header_Id int,
		NewProjTaskId int,
		UpdateTask bit,
		UpdateOpt bit,
		UpdateJob bit,
		ProjTaskOptId int,
		ProjTaskAmtId int,
		RRTask bit,
		Cost_Allocation_Id int,
		PricedJobId int,
		Task_Manufacturer varchar(20) COLLATE DATABASE_DEFAULT,
		/*VV 26 Nov 2008*/
		Update_Scheduling_Task_Only int,
		/*VV E316*/
		Tag_Id varchar(100) COLLATE DATABASE_DEFAULT,
		Rating varchar(50) COLLATE DATABASE_DEFAULT,
		PartRatingId int,
		--#Enh:527 to choose external identifier to update strategy task
		UpdateStrategyTaskCodes bit,
		/*VV E790*/
		Old_Ext_Id varchar(100) COLLATE DATABASE_DEFAULT,
		UpdateExternalIdentifier bit,
		NewCostAllocationId int
	)

INSERT INTO #z_I_PROJECTED_TASKS
(Line_No,EqpPlanId,EqpProjId,ProjTaskId,Equipment_No,ModelId,
SerialNumber,Reg_Counter,Equip_Name,Projection_Type_Id,Projection_Name,
Task_Description,ComponentCodeId,ModifierId,TaskTypeId,ApplicationCodeId,
Inactive_Task,Unscheduled,Planning_Task,Planning_Lead_Time,Operational_Criticality_Id,
ManufacturerId,Part_SOS_Id,PartId,Group_Number,Rotable_Part_Id,Warranty_Days,
Warranty_Usage,QUOMId,Schedule_On_Last_Scheduled,[First],Frequency,Final,Last_Change_Usage,
Last_Change_Date,External_Identifier,Schedule_Type_Id,Scheduling_Group_Id,Scheduling_Group_Counter,
InspectionTaskTypeId,InspectionOffset,Maintenance_Strategy_Id, PerformanceStrategyReason,
Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,SchedulingTaskId,
Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,
JobCodeId,CurrencyId,Standard_Job_Reference,Cost_Bearer_ID,Cost_Centre_Id,	Work_Group_Id,
PartTypeId,Health_Safety_Id,Pricing_Date,QtyVolume,PercentTopUp,UnitPrice,PartsCost,LaborCost,
MiscCost,Labour_Hrs_Field,LaborHours,Labour_Activity_Id,Duration,Parts_Cost_Expense_ID,
Labour_Cost_Expense_ID,Misc_Cost_Expense_ID,Parts_EDC_ID,Labour_EDC_ID,Misc_EDC_ID,
LaborShare,Crane_Cost,Pct_Freight,Avg_No_People,Avg_Daily_Work_Hrs,Avg_Travel_Hrs,
Travel_Recovery_Rate_L,Travel_Distance,Travel_Recovery_Rate_V,Misc_Trip_Cost,
SystemSourceId,Component_Code,Modifier_Code,Task_Type,Task_Counter,
Job_Code,Scheduling_Group,Sibling_Interval,Scheduling_Group_Type,
SchedulingGroupSubTypeId,Work_Group,Operational_Criticality,Labour_Activity,Health_Safety,
Cost_Centre,Part_Expense,Labour_Expense,Misc_Expense,System_Source,Primary_Part_Number,
Part_Type,Eqp_Terminated,Model,Cost_Bearer,Currency,Global_Code,Inspection_Logic_Task_Type,
Part_SOS,UpdateSchedulingTask,UOM,Scheduling_Task,Task_Manufacturer,
/*VV 26 Nov 2008*/Update_Scheduling_Task_Only,/*VV E316*/Tag_Id,Rating,UpdateStrategyTaskCodes,
/*VV E790*/Old_Ext_Id)
SELECT
IP.Line_No,EQP.EqpPlanId,NULL AS EqpProjId,NULL AS ProjTaskId,NULLIF(IP.Equipment_No,'') AS Equipment_No,
M.ModelId,IP.Serial_No AS SerialNumber,IP.Registration_Counter AS Reg_Counter,
IP.Equip_Name,dbo.EXPORT_PROJECTION_TYPE_F(ISNULL(CAST(IP.Projection_Type AS int),1), 0) AS Projection_Type_Id,
IP.Projection_Name,NULLIF(IP.Task_Description,'') AS Task_Description,NULL AS ComponentCodeId,NULL AS ModifierId,
NULL AS TaskTypeId,NULL AS ApplicationCodeId,
ISNULL(NULLIF(IP.Inactive_Task,''),0) AS Inactive_Task,
ISNULL(NULLIF(IP.Unassigned_Task,''),0) AS Unscheduled,
ISNULL(NULLIF(IP.Planning_Task,''),0) AS Planning_Task,
CAST(ISNULL(/*VV 3-Nov-08*/NULLIF(IP.Planning_Lead_Days,''),0) AS int) AS Planning_Lead_Time,
NULL AS Operational_Criticality_Id,MA.ManufacturerId,
NULL AS Part_SOS_Id,NULL AS PartId,
NULLIF(IP.Group_Number,''),RP.Rotable_Part_Id,
CAST(ISNULL(NULLIF(Warranty_Days,''),0) AS float) AS Warranty_Days,
CAST(ISNULL(NULLIF(Warranty_Usage,''),0) AS float) AS Warranty_Usage,
QUOM.QUOMId,
CAST(ISNULL(NULLIF(Schedule_On_Last_Scheduled,''),0) AS bit) AS Schedule_On_Last_Scheduled,
CAST(NULLIF(IP.[First],'') AS float) AS [First],
--E#395
CAST(ISNULL(NULLIF(IP.Interval,''),99999) AS float) AS Frequency,
CAST(ISNULL(NULLIF(IP.Final,''),0) AS float) AS Final,
--VV 8-Dec-2008
--CAST(ISNULL(NULLIF(IP.Last_Change_Usage,''),0) AS float) AS Last_Change_Usage,
CAST(NULLIF(IP.Last_Change_Usage,'') AS float) AS Last_Change_Usage,
/*VV 28-Nov-2008*/
CASE 
WHEN IP.Last_Change_Date ='' THEN NULL 
WHEN CAST(IP.Last_Change_Date AS float)=0 THEN NULL
ELSE CAST(IP.Last_Change_Date AS datetime) END AS Last_Change_Date,

CASE ISNULL(NULLIF(IP.Unassigned_Task,''),0) WHEN 1 THEN NULL ELSE NULLIF(IP.External_Identifier,'') END AS External_Identifier,
CASE 
WHEN IP.Schedule_On_Last_Scheduled='1' AND ISNULL(IP.UOM,'')<>'' THEN 2
WHEN IP.Schedule_On_Last_Scheduled='1' AND ISNULL(IP.UOM,'')='' THEN 4
WHEN ISNULL(IP.UOM,'')<>'' THEN 1
WHEN ISNULL(IP.UOM,'')='' THEN 3
END AS Schedule_Type_Id,
NULL AS Scheduling_Group_Id,
CASE /*there shall be either suppression or dependency group*/
WHEN NULLIF(Suppression_Group,'') IS NOT NULL THEN CAST(NULLIF(IP.Suppression_Counter,'') AS int)
WHEN NULLIF(Dependency_Group,'') IS NOT NULL THEN CAST(NULLIF(IP.Dependency_Counter,'') AS int)
ELSE NULL END AS Scheduling_Group_Counter,
NULL AS InspectionTaskTypeId,CAST(ISNULL(NULLIF(IP.Inspection_Logic_Offset,''),0) AS float) AS InspectionOffset,
CAST(NULLIF(NULLIF(IP.Performance_Strategy,''),0) AS int) AS Maintenance_Strategy_Id, 
NULLIF(IP.Performance_Strategy_Reason,'') AS PerformanceStrategyReason,
NULLIF(IP.Changeout_Guidelines,'') AS Changeout_Guidelines,
NULLIF(IP.ERP_Component_Code,'') AS ERP_Component_Code,NULLIF(IP.ERP_Modifier_Code,'') AS ERP_Modifier_Code,
NULLIF(IP.ERP_Scheduling_Task,'') AS ERP_Scheduling_Task,
CASE ISNULL(NULLIF(IP.Unassigned_Task,''),0) WHEN 1 THEN NULL ELSE SCT.SchedulingTaskId END AS SchedulingTaskId,
CAST(NULLIF(IP.Last_Occurrence,'') AS float) AS Last_Occurrence,
/*VV 28-Nov-2008*/
CASE 
WHEN IP.Last_Occ_Date = '' THEN NULL
WHEN CAST(IP.Last_Occ_Date AS float) = 0 THEN NULL  
ELSE CAST(IP.Last_Occ_Date AS datetime) END AS Last_Occ_Date,

CAST(NULLIF(IP.Last_Scheduled,'') AS float) AS Last_Scheduled,
/*VV 28-Nov-2008*/
CASE 
WHEN IP.Last_Sched_Date = '' THEN NULL 
WHEN CAST(IP.Last_Sched_Date AS float) = 0 THEN NULL
ELSE CAST(IP.Last_Sched_Date AS datetime) END AS Last_Sched_Date,

CAST(NULLIF(IP.Next_Occurrence,'') AS float) AS Next_Occurrence,
/*VV 28-Nov-2008*/
CASE 
WHEN IP.Next_Occ_Date = '' THEN NULL 
WHEN CAST(IP.Next_Occ_Date AS float) = 0 THEN NULL
ELSE CAST(IP.Next_Occ_Date AS datetime) END AS Next_Occ_Date,

NULL AS JobCodeId,CUR.CurrencyId,NULLIF(Standard_Job_Reference,'') AS Standard_Job_Reference,
CB.CostBearerId AS Cost_Bearer_ID,NULL AS Cost_Centre_Id,NULL AS Work_Group_Id,
NULL AS PartTypeId,NULL AS Health_Safety_Id,


CASE 
WHEN IP.Pricing_Date = '' THEN @TodaysDate 

WHEN CAST(IP.Pricing_Date AS float) = 0 THEN @TodaysDate


WHEN CAST(IP.Pricing_Date AS datetime)>@TodaysDate THEN @TodaysDate
ELSE CAST(IP.Pricing_Date AS datetime) END AS Pricing_Date,		
 

CAST(ISNULL(NULLIF(IP.Consumable_Qty,''),0) AS float) AS QtyVolume,
CAST(ISNULL(NULLIF(IP.Consumable_Top_Up,''),0) AS float) AS PercentTopUp,
CAST(ISNULL(NULLIF(IP.Consumable_Price,''),0) AS float) AS UnitPrice,

/*VV #3469
CAST(ISNULL(NULLIF(IP.Parts_Sell,''),0) AS float) AS PartsCost,
CAST(ISNULL(NULLIF(IP.Labour_Sell,''),0) AS float) AS LaborCost,
CAST(ISNULL(NULLIF(IP.Misc_Sell,''),0) AS float) AS MiscCost,
CASE CAST(ISNULL(NULLIF(IP.Shop_Labour,''),0) AS bit) WHEN 0 THEN 1 ELSE 0 END AS Labour_Hrs_Field,
CAST(ISNULL(NULLIF(IP.Labour_Hours,''),0) AS float) AS LaborHours,*/

CAST(NULLIF(IP.Parts_Sell,'') AS float) AS PartsCost,
CAST(NULLIF(IP.Labour_Sell,'') AS float) AS LaborCost,
CAST(NULLIF(IP.Misc_Sell,'') AS float) AS MiscCost,
CASE CAST(NULLIF(IP.Shop_Labour,'') AS bit) WHEN 0 THEN 1 WHEN 1 THEN 0 ELSE NULL END AS Labour_Hrs_Field,
CAST(NULLIF(IP.Labour_Hours,'') AS float) AS LaborHours,

NULL AS Labour_Activity_Id,
/*VV #3469
CAST(ISNULL(NULLIF(IP.Duration_Hours,''),0) AS float) AS Duration,*/
CAST(NULLIF(IP.Duration_Hours,'') AS float) AS Duration,

NULL AS Parts_Cost_Expense_ID,
NULL AS Labour_Cost_Expense_ID,
NULL AS Misc_Cost_Expense_ID,

PEDC.Id AS Parts_EDC_ID,
LEDC.Id AS Labour_EDC_ID,
MEDC.Id AS Misc_EDC_ID,



CAST(ISNULL(NULLIF(IP.Labour_Split,''),/*VV 3-Nov-08 Set the default labour share to 100*/100) AS float) AS LaborShare,
CAST(ISNULL(NULLIF(IP.Crane_Cost,''),0) AS float) AS Crane_Cost,
CAST(ISNULL(NULLIF(IP.Freight_Perc_Parts,''),0) AS float) AS Pct_Freight,
CAST(ISNULL(NULLIF(IP.Avg_People_Vehicle,''),0) AS float) AS Avg_No_People,
CAST(ISNULL(NULLIF(IP.Avg_Daily_Work_Hours,''),0) AS float) AS Avg_Daily_Work_Hrs,
CAST(ISNULL(NULLIF(IP.Avg_Travel_Hours,''),0) AS float) AS Avg_Travel_Hrs,
CAST(ISNULL(NULLIF(IP.Travel_Labour_Rate,''),0) AS float) AS Travel_Recovery_Rate_L,
CAST(ISNULL(NULLIF(IP.Travel_Distance,''),0) AS float) AS Travel_Distance,
CAST(ISNULL(NULLIF(IP.Travel_Rate,''),0) AS float) AS Travel_Recovery_Rate_V,
CAST(ISNULL(NULLIF(IP.Misc_Cost_Per_Trip,''),0) AS float) AS Misc_Trip_Cost,
NULL AS SystemSourceId,NULLIF(IP.Component_Code,'') AS Component_Code,
NULLIF(IP.Modifier_Code,'') AS Modifier_Code,NULLIF(IP.Task_Type,'') AS Task_Type,
NULLIF(IP.Task_Counter,'') AS Task_Counter,

NULLIF(IP.Job_Code,'') AS Job_Code,

ISNULL(NULLIF(IP.Suppression_Group,''),NULLIF(IP.Dependency_Group,'')) AS Scheduling_Group,
NULLIF(IP.Sibling_Interval,'') AS Sibling_Interval,
CASE 
WHEN ISNULL(IP.Suppression_Group,'')<>'' THEN 1
WHEN ISNULL(IP.Dependency_Group,'')<>'' THEN 2
ELSE NULL END
AS Scheduling_Group_Type,
CASE 
WHEN ISNULL(IP.Suppression_Group,'')<>'' AND ISNULL(IP.Sibling_Interval,'')<>'' THEN 1
ELSE 0 END AS SchedulingGroupSubTypeId,


NULLIF(IP.Work_Group,'') AS Work_Group,

NULLIF(IP.Operational_Criticality,'') AS Operational_Criticality,


NULLIF(IP.Labour_Activity,'') AS Labour_Activity,NULLIF(IP.Health_Safety,'') AS Health_Safety,
NULLIF(IP.Cost_Centre,'') AS Cost_Centre, NULLIF(IP.Part_Expense,'') AS Part_Expense,
NULLIF(IP.Labour_Expense,'') AS Labour_Expense,NULLIF(IP.Misc_Expense,'') AS Misc_Expense,


NULLIF(IP.System_Source,'') AS System_Source,NULLIF(IP.Primary_Part_Number,'') AS Primary_Part_Number,


NULLIF(IP.Part_Type,'') AS Part_Type,EQP.Eqp_Terminated,NULLIF(IP.Model,'') AS Model,
NULLIF(IP.Cost_Bearer,'') AS Cost_Bearer,
NULLIF(IP.Currency,'') AS Currency,


CAST(ISNULL(NULLIF(IP.Global_Code,''),0) AS bit) AS Global_Code,
NULLIF(Inspection_Logic_Task_Type,'') AS Inspection_Logic_Task_Type,
NULLIF(Part_SOS,'') AS Part_SOS,
CAST(SIGN(SCT.SchedulingTaskId) AS bit) AS UpdateSchedulingTask,
NULLIF(UOM,'') AS UOM,NULLIF(Scheduling_Task,'') AS Scheduling_Task,
NULLIF(Task_Manufacturer_Code,'') AS Task_Manufacturer,

ISNULL(NULLIF(IP.Update_Scheduling_Task_Only,''),0) AS Update_Scheduling_Task_Only,
/*VV E316*/NULLIF(Tag_Id,'') AS Tag_Id,
NULLIF(Rating,'') AS Rating,
0 as UpdateStrategyTaskCodes,
/*VV E790*/
NULLIF(Old_Ext_Id,'')
FROM
IMPORT_PROJECTION IP
	LEFT JOIN
(SELECT EP.EqpPlanId,EP.EqpPlan,
CASE @ModelSerialSeparator 
WHEN '' THEN E.SerialNumber ELSE REPLACE(E.SerialNumber,M.Model+@ModelSerialSeparator,'') END AS SerialNumber,
M.Model,EP.Reg_Counter,EP.Eqp_Terminated
FROM
tblEqpPlans EP
	INNER JOIN
tblEquipment E
	ON EP.EquipmentId=E.EquipmentId
	INNER JOIN
tblModels M 
	ON E.ModelId=M.ModelId) EQP

	ON IP.Model=EQP.Model AND 
	(
	   (CAST(IP.Projection_Type AS int) IN(1,2,5,6/*Import Type Current,Budget,Alternate,Archived*/) AND 
		IP.Serial_No=EQP.SerialNumber AND 
		IP.Registration_Counter=EQP.Reg_Counter)
	OR
		(CAST(IP.Projection_Type AS int) IN(3,4,7/*Import Type Estimate Current,Centreline,Estimate-Draft*/) AND
		 IP.Equip_Name=EQP.EqpPlan)
	)
	LEFT JOIN
tblModels M 
	ON IP.Model=M.Model
	LEFT JOIN
tblManufacturers MA
	ON IP.Task_Manufacturer_Code=MA.Manufacturer
	LEFT JOIN
tblQUOMs QUOM
	ON IP.UOM=QUOM.Short_Desc
	LEFT JOIN
tblCurrencies CUR
	ON IP.Currency=CUR.Currency
	LEFT JOIN
tblCostBearers CB
	ON IP.Cost_Bearer=CB.WO_Code
	LEFT JOIN
ENTRY_DISTRIBUTION_CODE PEDC
	ON IP.Part_EDC=PEDC.EDC_Id
	LEFT JOIN
ENTRY_DISTRIBUTION_CODE LEDC
	ON IP.Labour_EDC=LEDC.EDC_Id
	LEFT JOIN
ENTRY_DISTRIBUTION_CODE MEDC
	ON IP.Misc_EDC=MEDC.EDC_Id
	LEFT JOIN 
SCHEDULING_TASK SCT 
	ON dbo.EXPORT_PROJECTION_TYPE_F(ISNULL(CAST(IP.Projection_Type AS int),1), 0) = 1 AND -- MOD BY KN 23092008 (IP.Projection_Type = 1 AND )
	   IP.External_Identifier = SCT.ExternalIdentifier 
	LEFT JOIN
ROTABLE_PART RP
	ON IP.Rotable_Part_Number=RP.Part_Number
WHERE IP.Import_File_Name=@ImportFileName AND Line_No NOT IN(SELECT Line_No FROM #z_Message WHERE ErrorDescription<>'')


IF EXISTS(SELECT Line_No FROM #z_Message WHERE ErrorDescription<>'')
BEGIN
	
	INSERT INTO IMPORT_ERROR(ImportFileName,Line_No,ErrorDescription,ImportErrorTypeId,LastModDate,ImportRecord,ImportSourceId)
	SELECT @ImportFileName AS ImportFileName,CASE WHEN @InterfaceSource = 0 THEN Line_No END,ErrorDescription, @ErrorTypeParsing AS ImportErrorTypeId,
	GETDate() AS LastModDate,CONVERT(VARCHAR(MAX),ImportRecord),@InterfaceSource as ImportSourceId
	FROM #z_Message WHERE ErrorDescription<>''

	DELETE IPT FROM
	#z_I_PROJECTED_TASKS IPT
		INNER JOIN
	#z_Message M
		ON IPT.Line_No=M.Line_No
	WHERE M.ErrorDescription<>''

	TRUNCATE TABLE #z_Message

	IF NOT EXISTS(SELECT * FROM #z_I_PROJECTED_TASKS)
	BEGIN
		GOTO END_IMPORT
	END
END


IF @EqpProjIdTo>0
BEGIN
	UPDATE IPT SET
	IPT.EqpPlanId =EQP.EqpPlanId ,
	IPT.EqpProjId=EQP.EqpProjId,
	IPT.ModelId  =EQP.ModelId,
	IPT.Projection_Type_Id =EQP.Projection_Type_Id ,
	IPT.Projection_Name=EQP.EqpProjName,
	IPT.SiteId=EQP.SiteId
	FROM
	#z_I_PROJECTED_TASKS IPT
		CROSS JOIN
	(SELECT EPR.EqpProjId,EPR.EqpPlanId,E.ModelId,EPR.Projection_Type_Id,
	EPR.EqpProjName,F.SiteId
	FROM
	tblEqpProjs EPR
		INNER JOIN
	tblEqpPlans EP
		ON EPR.EqpPlanId=EP.EqpPlanId
		INNER JOIN
	tblEquipment E
		ON EP.EquipmentId=E.EquipmentId
		INNER JOIN
	tblFleets F
		ON EP.FleetId=F.FleetId
	WHERE EPR.EqpProjId=@EqpProjIdTo) EQP
END


--Set equipment if registration counter did not match
If ISNULL(@EqpProjIdTo,0)=0 AND EXISTS(SELECT EqpPlanId FROM #z_I_PROJECTED_TASKS WHERE EqpPlanId IS NULL AND 
			Projection_Type_Id IN(@TypeCur,@TypeBud,@TypeAlt))
BEGIN
	UPDATE IPT SET
	IPT.EqpPlanId =EQP.EqpPlanId
	FROM
	#z_I_PROJECTED_TASKS IPT
		INNER JOIN
	(SELECT EP.EqpPlanId,EP.EqpPlan,
	CASE @ModelSerialSeparator 
	WHEN '' THEN E.SerialNumber ELSE REPLACE(E.SerialNumber,M.Model+@ModelSerialSeparator,'') END AS SerialNumber,
	M.Model
	FROM
	tblEqpPlans EP
		INNER JOIN
	tblEquipment E
		ON EP.EquipmentId=E.EquipmentId
		INNER JOIN
	tblModels M 
		ON E.ModelId=M.ModelId
	WHERE EP.Equipment_Type_Id=1/*Real equipment*/ AND EP.Eqp_Terminated=0) EQP
		ON IPT.Model=EQP.Model AND IPT.SerialNumber=EQP.SerialNumber
	WHERE IPT.EqpPlanId IS NULL AND IPT.Projection_Type_Id IN(@TypeCur,@TypeBud,@TypeAlt)
	
END



/***************************************************/
	-- ADD NEW CODES
/***************************************************/

-- Component Codes
IF EXISTS(
		SELECT IPT.Component_Code FROM 
		#z_I_PROJECTED_TASKS IPT
			LEFT JOIN 
		tblComponentCodes CC 
			ON CC.Code = IPT.Component_Code	
		WHERE IPT.Unscheduled=0 AND IPT.Inactive_Task=0 AND IPT.Global_Code=0 AND IPT.Component_Code IS NOT NULL AND CC.ComponentCodeId IS NULL
)
BEGIN

	SELECT TOP 1 @SubSystemId = SubSystemID FROM tblSubSystems WHERE Unassigned <> 0

	INSERT INTO tblComponentCodes (Code, SubSystemId, [Description], BudgetCode, LastModByUserId, LastModDate, CreateByUserId, CreateDate)
	SELECT DISTINCT IPT.Component_Code,	@SubSystemId, IPT.Component_Code, 1, 0, @TodaysDate, 0, @TodaysDate
	FROM 
	#z_I_PROJECTED_TASKS IPT
	LEFT JOIN 
	tblComponentCodes CC 
		ON CC.Code = IPT.Component_Code	
	WHERE IPT.Unscheduled=0 AND IPT.Inactive_Task=0 AND IPT.Global_Code=0 AND IPT.Component_Code IS NOT NULL AND CC.ComponentCodeId IS NULL
END

-- Modifier Codes
INSERT INTO tblModifierCodes
(Code, [Description], BudgetCode,LastModByUserId, LastModDate, CreateByUserId, CreateDate)
SELECT DISTINCT IPT.Modifier_Code,	IPT.Modifier_Code, 1, 0, @TodaysDate, 0, @TodaysDate
FROM
#z_I_PROJECTED_TASKS IPT
	LEFT JOIN tblModifierCodes MC ON MC.Code = IPT.Modifier_Code	
WHERE IPT.Inactive_Task=0 AND IPT.Modifier_Code IS NOT NULL AND MC.ModifierId IS NULL

-- Task Types
INSERT INTO tblTaskTypes
(Code, [Description], LastModByUserId, LastModDate, CreateByUserId, CreateDate)

SELECT DISTINCT IPT.Task_Type, 0, 0, @TodaysDate, 0, @TodaysDate
FROM
	#z_I_PROJECTED_TASKS IPT
	LEFT JOIN tblTaskTypes TT ON TT.Code = IPT.Task_Type	
WHERE IPT.Unscheduled=0 AND IPT.Inactive_Task=0 AND IPT.Task_Type IS NOT NULL AND TT.TaskTypeId IS NULL
UNION
SELECT DISTINCT IPT.Inspection_Logic_Task_Type, 0, 0, @TodaysDate, 0, @TodaysDate
FROM
	#z_I_PROJECTED_TASKS IPT
	LEFT JOIN tblTaskTypes TT ON TT.Code = IPT.Inspection_Logic_Task_Type	
WHERE IPT.Unscheduled=0 AND IPT.Inactive_Task=0 AND IPT.Inspection_Logic_Task_Type IS NOT NULL AND TT.TaskTypeId IS NULL

-- Task Counter
INSERT INTO tblApplicationCodes
(Code, [Description], BudgetCode, LastModByUserId, LastModDate, CreateByUserId, CreateDate)
SELECT DISTINCT IPT.Task_Counter,	IPT.Task_Counter, 1, 0, @TodaysDate, 0, @TodaysDate
FROM
	#z_I_PROJECTED_TASKS IPT
	LEFT JOIN tblApplicationCodes AC ON AC.Code = IPT.Task_Counter	
WHERE IPT.Inactive_Task=0 AND IPT.Task_Counter IS NOT NULL AND AC.ApplicationCodeId IS NULL

-- Add JobCode if it's a new one
DECLARE @GlobalJobCodeId int
SET @GlobalJobCodeId = 0
SELECT TOP 1 @GlobalJobCodeId=Global_Job_Id FROM GLOBAL_JOB_CODES WHERE Default_Record<>0
IF @GlobalJobCodeId>0
BEGIN
	INSERT tblJobCodes (Code, Description, LastModByUserId, LastModDate, CreateByUserId, CreateDate, Global_Job_Code_Id)
	SELECT DISTINCT IPT.Job_Code, IPT.Job_Code, 0, GETDATE(), 0, GETDATE(), @GlobalJobCodeId
	FROM 
	#z_I_PROJECTED_TASKS  IPT
		LEFT JOIN 
	tblJobCodes JC 
		ON JC.Code =  IPT.Job_Code
	WHERE IPT.Inactive_Task=0 AND IPT.Global_Code=0 AND IPT.Job_Code IS NOT NULL AND JC.JobCodeId IS NULL

END

-- Work Group
INSERT INTO WORK_GROUP
(Description, Site_ID, Work_Group_Code)
SELECT DISTINCT IPT.Work_Group,F.SiteId, IPT.Work_Group
FROM
#z_I_PROJECTED_TASKS IPT
	INNER JOIN
tblEqpPlans EP
	ON IPT.EqpPlanId=EP.EqpPlanId
	INNER JOIN
tblFleets F
	ON EP.FleetId=F.FleetId
	LEFT JOIN 
WORK_GROUP WG 
	ON WG.Work_Group_Code = IPT.Work_Group AND WG.Site_Id = F.SiteId
WHERE  IPT.Inactive_Task=0 AND IPT.Work_Group IS NOT NULL AND WG.Work_Group_Id IS NULL

-- Opeartional Criticality
INSERT INTO OPERATIONAL_CRITICALITY(Operational_Criticality)
SELECT DISTINCT IPT.Operational_Criticality
FROM
	#z_I_PROJECTED_TASKS IPT
	LEFT JOIN OPERATIONAL_CRITICALITY OC ON OC.Operational_Criticality = IPT.Operational_Criticality
WHERE  IPT.Inactive_Task=0 AND IPT.Operational_Criticality IS NOT NULL AND OC.Operational_Criticality_Id IS NULL


-- Labour Activity
IF EXISTS(SELECT IPT.Labour_Activity FROM
	#z_I_PROJECTED_TASKS IPT
	LEFT JOIN tblLabourActivities LA ON LA.ActivityCode = IPT.Labour_Activity
WHERE  IPT.Inactive_Task=0 AND IPT.Labour_Activity IS NOT NULL AND LA.LabourActivityId IS NULL)
BEGIN
	INSERT INTO tblLabourActivities(ActivityCode, LabourActivity, LastModByUserId, LastModDate, 
	CreateByUserId, CreateDate)
	SELECT DISTINCT IPT.Labour_Activity, IPT.Labour_Activity,0,@TodaysDate,0,@TodaysDate
	FROM
	#z_I_PROJECTED_TASKS IPT
		LEFT JOIN 
	tblLabourActivities LA ON 
		LA.ActivityCode = IPT.Labour_Activity
	WHERE  IPT.Inactive_Task=0 AND IPT.Labour_Activity IS NOT NULL AND LA.LabourActivityId IS NULL

	EXEC LABOUR_RATES_MISSING_ADD_P
END

-- VV E316 Part Rating
INSERT INTO PART_RATING(PartRating)
SELECT DISTINCT IPT.Rating
FROM
#z_I_PROJECTED_TASKS IPT
	LEFT JOIN 
PART_RATING PR 
	ON IPT.Rating=PR.PartRating
WHERE  IPT.Inactive_Task=0 AND IPT.Rating IS NOT NULL AND PR.PartRatingId IS NULL

-- Health Safety
INSERT INTO HEALTH_SAFETY(Health_Safety)
SELECT DISTINCT IPT.Health_Safety
FROM
	#z_I_PROJECTED_TASKS IPT
	LEFT JOIN HEALTH_SAFETY HS ON HS.Health_Safety = IPT.Health_Safety
WHERE  IPT.Inactive_Task=0 AND IPT.Health_Safety IS NOT NULL AND HS.Health_Safety_Id IS NULL

-- Cost Centre,
INSERT INTO COST_CENTRE(Cost_Centre_Code, Cost_Centre_Desc)
SELECT DISTINCT IPT.Cost_Centre,IPT.Cost_Centre
FROM
	#z_I_PROJECTED_TASKS IPT
	LEFT JOIN COST_CENTRE CC ON CC.Cost_Centre_Code = IPT.Cost_Centre
WHERE  IPT.Inactive_Task=0 AND IPT.Cost_Centre IS NOT NULL AND CC.Cost_Centre_Id IS NULL

-- Cost Expense (P,L,M)
INSERT INTO COST_EXPENSE(Cost_Expense_Code, Cost_Expense_Desc)
SELECT DISTINCT IPT.Part_Expense,IPT.Part_Expense
FROM
	#z_I_PROJECTED_TASKS IPT
	LEFT JOIN COST_EXPENSE CE ON CE.Cost_Expense_Code = IPT.Part_Expense 
WHERE IPT.Inactive_Task=0 AND IPT.Part_Expense IS NOT NULL AND CE.Cost_Expense_Id IS NULL
UNION
SELECT DISTINCT IPT.Misc_Expense,IPT.Misc_Expense
FROM
	#z_I_PROJECTED_TASKS IPT
	LEFT JOIN COST_EXPENSE CE ON CE.Cost_Expense_Code = IPT.Misc_Expense 
WHERE IPT.Inactive_Task=0 AND IPT.Misc_Expense IS NOT NULL AND CE.Cost_Expense_Id IS NULL
UNION 
SELECT DISTINCT IPT.Labour_Expense,IPT.Labour_Expense
FROM
	#z_I_PROJECTED_TASKS IPT
	LEFT JOIN COST_EXPENSE CE ON CE.Cost_Expense_Code = IPT.Labour_Expense 
WHERE IPT.Inactive_Task=0 AND IPT.Labour_Expense IS NOT NULL AND CE.Cost_Expense_Id IS NULL


-- System Source
INSERT INTO SYSTEM_SOURCE(System_Source_Code)
SELECT DISTINCT IPT.System_Source
FROM
	#z_I_PROJECTED_TASKS IPT
	LEFT JOIN SYSTEM_SOURCE SS ON SS.System_Source_Code = IPT.System_Source 
WHERE IPT.Inactive_Task=0 AND IPT.System_Source IS NOT NULL AND SS.System_Source_Id IS NULL


-- Add Scheduling Groups 
INSERT INTO PROJ_TASK_SCHEDULING_GROUP
(Scheduling_Group, Scheduling_Group_Type, Suppression_Tolerance_Hours,SchedulingGroupSubtypeId, ExternalSource)
SELECT IPT.Scheduling_Group, IPT.Scheduling_Group_Type,
CASE IPT.Scheduling_Group_Type 
WHEN 1/*Suppression*/ THEN ISNULL(NULLIF(MAX(IPT.Sibling_Interval),0),@ToleranceHours) ELSE 0 END AS Suppression_Tolerance_Hours,
CASE WHEN MAX(IPT.Sibling_Interval) IS NULL THEN 0 ELSE 1 END AS SchedulingGroupSubtypeId, 
1 AS ExternalSource
FROM #z_I_PROJECTED_TASKS IPT
	LEFT JOIN 
PROJ_TASK_SCHEDULING_GROUP PTSG 
	ON IPT.Scheduling_Group=PTSG.Scheduling_Group 
	AND IPT.Scheduling_Group_Type=PTSG.Scheduling_Group_Type
WHERE IPT.Inactive_Task=0 AND IPT.Scheduling_Group_Type IS NOT NULL AND PTSG.Scheduling_Group_Id IS NULL
GROUP BY IPT.Scheduling_Group, IPT.Scheduling_Group_Type


SELECT @DefGPT=Global_Part_Type_Id FROM GLOBAL_PART_TYPES WHERE Default_Record=1
IF @DefGPT>0
BEGIN
	INSERT INTO tblPartTypes
	(PartType,PartTypeDesc,LastModByUserId,LastModDate,CreateByUserId,CreateDate,Global_Part_Type_Id,
	Fluid_Part_Type,PartTypeDefault)
	SELECT DISTINCT IPT.Part_Type AS PartType,IPT.Part_Type AS PartTypeDesc,
	0 AS LastModByUserId,GETDATE() AS LastModDate,0 AS CreateByUserId,GETDATE() AS CreateDate,
	@DefGPT AS Global_Part_Type_Id,0 AS Fluid_Part_Type,0 AS PartTypeDefault
	FROM 
	#z_I_PROJECTED_TASKS IPT
		LEFT JOIN 
	tblPartTypes PT
		ON IPT.Part_Type=PT.PartType
	WHERE IPT.Inactive_Task=0 AND IPT.Global_Code=0 AND IPT.Part_Type IS NOT NULL AND PT.PartType IS NULL
END

INSERT INTO SOURCE_OF_SUPPLY
(Sos_Code, Sos_Description, Last_Mod_By_User_ID, Last_Mod_Date,	Create_By_User_ID, Create_Date)
SELECT DISTINCT IPT.Part_SOS AS Sos_Code, IPT.Part_SOS AS Sos_Description, 0, GETDATE(), 0, GETDATE()
FROM 
#z_I_PROJECTED_TASKS IPT
	LEFT JOIN 
SOURCE_OF_SUPPLY SOS
	ON IPT.Part_SOS=SOS.Sos_Code
WHERE IPT.Inactive_Task=0 AND IPT.Part_SOS IS NOT NULL AND SOS.Sos_Code IS NULL


CREATE TABLE #z_tblParts(Part varchar(50) COLLATE DATABASE_DEFAULT,Source_Of_Supply_Id int
PRIMARY KEY(Part,Source_Of_Supply_Id))

INSERT INTO #z_tblParts(Part,Source_Of_Supply_Id)
SELECT DISTINCT IPT.Primary_Part_Number AS Part,SOS.Source_Of_Supply_Id
FROM
#z_I_PROJECTED_TASKS IPT
	INNER JOIN
SOURCE_OF_SUPPLY SOS
	ON IPT.Part_SOS=SOS.Sos_Code
	LEFT JOIN
tblParts P
	ON IPT.Primary_Part_Number=P.Part AND SOS.Source_Of_Supply_Id=P.Source_Of_Supply_Id
WHERE IPT.Inactive_Task=0 AND IPT.Primary_Part_Number IS NOT NULL AND P.Part IS NULL


IF @@ROWCOUNT>0
BEGIN
	SET XACT_ABORT ON
	BEGIN TRANSACTION

	INSERT INTO tblParts
	(Part,PartDescription,Part_Type_Id,Source_Of_Supply_Id)
	SELECT Part,Part AS PartDescription,@DefPartTypeId AS Part_Type_Id,Source_Of_Supply_Id
	FROM #z_tblParts
	
	INSERT INTO tblPartPrices
	(PartId,CurrencyId,Part_Sell,Full_Credit_Sell,Partial_Credit_Sell,Price_Group_ID,
	LastModByUserId,LastModDate,CreateByUserId,CreateDate,Part_Cost,Full_Credit_Cost,
	Partial_Credit_Cost)
	SELECT P.PartId,C.CurrencyId,0 AS Part_Sell,0 AS Full_Credit_Sell,0 AS Partial_Credit_Sell,
	PG.Price_Group_ID,	0 AS LastModByUserId,GETDATE() AS LastModDate,0 AS CreateByUserId,
	GETDATE() AS CreateDate,0 AS Part_Cost,0 AS Full_Credit_Cost,
	0 AS Partial_Credit_Cost
	FROM
	tblParts P
		INNER JOIN
	#z_tblParts Z
		ON P.Part=Z.Part AND P.Source_Of_Supply_Id=Z.Source_Of_Supply_Id
		CROSS JOIN
	tblCurrencies C
		CROSS JOIN
	PRICE_GROUP PG
	
	COMMIT TRANSACTION
END

DROP TABLE #z_tblParts

UPDATE IPT SET
IPT.SiteId=F.SiteId,
IPT.EqpProjId = EPR.EqpProjId,
IPT.ManufacturerId= CASE 
					WHEN IPT.Task_Manufacturer IS NULL THEN ISNULL(IPT.ManufacturerId,ET.ManufacturerId)
					ELSE IPT.ManufacturerId END,
IPT.ComponentCodeId=CASE IPT.Global_Code 
					WHEN 1 THEN ISNULL(CCG.ComponentCodeId,@DefGCC)
					ELSE CC.ComponentCodeId END,
IPT.ModifierId=ISNULL(MC.ModifierId,0),
IPT.TaskTypeId=TT.TaskTypeId,
IPT.InspectionTaskTypeId=ITT.TaskTypeId,
IPT.ApplicationCodeId=ISNULL(AC.ApplicationCodeId,0),
IPT.JobCodeId=CASE IPT.Global_Code 
			  WHEN 1 THEN ISNULL(JCG.JobCodeId,@DefJobCodeId)
			  ELSE JC.JobCodeId END,
IPT.Work_Group_Id=WG.Work_Group_Id,
IPT.Operational_Criticality_Id=OC.Operational_Criticality_Id,
IPT.Labour_Activity_Id=LA.LabourActivityId,
IPT.Health_Safety_Id=HS.Health_Safety_Id,
IPT.Cost_Centre_Id=COC.Cost_Centre_Id,
IPT.Parts_Cost_Expense_ID=PCE.Cost_Expense_Id,
IPT.Labour_Cost_Expense_ID=LCE.Cost_Expense_Id,
IPT.Misc_Cost_Expense_ID=MCE.Cost_Expense_Id,
IPT.SystemSourceId=SSO.System_Source_Id,
IPT.Scheduling_Group_Id=PTSG.Scheduling_Group_Id,
IPT.Scheduling_Group_Type=PTSG.Scheduling_Group_Type,
IPT.SchedulingGroupSubtypeId=PTSG.SchedulingGroupSubtypeId,
IPT.PartTypeId=CASE IPT.Global_Code 
			  WHEN 1 THEN ISNULL(PTYG.PartTypeId,@DefPartTypeId)
			  ELSE PTY.PartTypeId END,
IPT.Part_SOS_Id=PSOS.Source_Of_Supply_Id,
IPT.PartId=P.PartId,
IPT.Last_Occurrence=ISNULL(CASE WHEN IPT.Last_Occurrence IS NULL AND IPT.Last_Occ_Date IS NOT NULL AND EPR.EqpProjId>0 THEN  dbo.GET_USAGE_FROM_DATE_NO_CHECK_TERM_F(/*VV 28-Nov-2008*/EPR.EqpProjId, IPT.QUOMId, IPT.Last_Occ_Date) ELSE IPT.Last_Occurrence END,0),
IPT.Last_Occ_Date=CASE WHEN IPT.Last_Occurrence IS NOT NULL AND IPT.Last_Occ_Date IS NULL AND EPR.EqpProjId>0 THEN  dbo.GET_DATE_FROM_USAGE_EQP_F(/*VV 28-Nov-2008*/EPR.EqpProjId, IPT.QUOMId, IPT.Last_Occurrence, 0, NULL, NULL, NULL, NULL) ELSE IPT.Last_Occ_Date END,
/*VV E316*/
IPT.PartRatingId=PAR.PartRatingId
FROM
#z_I_PROJECTED_TASKS IPT
	INNER JOIN
tblEqpPlans E
	ON IPT.EqpPlanId=E.EqpPlanId
	INNER JOIN
tblEquipment ET
	ON E.EquipmentId=ET.EquipmentId
	INNER JOIN
tblFleets F
	ON E.FleetId=F.FleetId
	LEFT JOIN
tblEqpProjs EPR 
	ON IPT.EqpPlanId=EPR.EqpPlanId AND
	   IPT.Projection_Type_Id=EPR.Projection_Type_Id AND
	   (IPT.Projection_Type_Id IN(@TypeCur,@TypeBud,@TypeCen,@TypeEC)
		OR (IPT.Projection_Type_Id IN(@TypeAlt,@TypeArc,@TypeED) AND IPT.Projection_Name=EPR.EqpProjName))
	LEFT JOIN
tblComponentCodes CC
	ON IPT.Global_Code=0 AND IPT.Component_Code=CC.Code
	LEFT JOIN 
tblTaskTypes TT 
	ON IPT.Task_Type=TT.Code 
	LEFT JOIN 
tblModifierCodes MC 
	ON IPT.Modifier_Code=MC.Code
	LEFT JOIN 
tblApplicationCodes AC 
	ON IPT.Task_Counter=AC.Code
	LEFT JOIN
OPERATIONAL_CRITICALITY OC
	ON IPT.Operational_Criticality=OC.Operational_Criticality
	LEFT JOIN
SOURCE_OF_SUPPLY PSOS
	ON IPT.Part_SOS=PSOS.Sos_Code
	LEFT JOIN
tblParts P
	ON PSOS.Source_Of_Supply_Id=P.Source_Of_Supply_Id AND IPT.Primary_Part_Number=P.Part
	LEFT JOIN
PROJ_TASK_SCHEDULING_GROUP PTSG
	ON IPT.Scheduling_Group=PTSG.Scheduling_Group AND IPT.Scheduling_Group_Type=PTSG.Scheduling_Group_Type
	LEFT JOIN 
tblTaskTypes ITT 
	ON IPT.Inspection_Logic_Task_Type=ITT.Code 
	LEFT JOIN
tblJobCodes JC
	ON IPT.Global_Code=0 AND IPT.Job_Code=JC.Code
	LEFT JOIN
tblCurrencies CUR
	ON IPT.Currency=CUR.Currency
	LEFT JOIN
COST_CENTRE COC
	ON IPT.Cost_Centre=COC.Cost_Centre_Code
	LEFT JOIN
WORK_GROUP WG
	ON IPT.Work_Group=WG.Work_Group_Code AND F.SiteId=WG.Site_Id
	LEFT JOIN
tblPartTypes PTY
	ON IPT.Global_Code=0 AND IPT.Part_Type=PTY.PartType
	LEFT JOIN
HEALTH_SAFETY HS
	ON IPT.Health_Safety=HS.Health_Safety
	LEFT JOIN
tblLabourActivities LA
	ON IPT.Labour_Activity=LA.ActivityCode
	LEFT JOIN
COST_EXPENSE PCE
	ON IPT.Part_Expense=PCE.Cost_Expense_Code
	LEFT JOIN
COST_EXPENSE LCE
	ON IPT.Labour_Expense=LCE.Cost_Expense_Code
	LEFT JOIN
COST_EXPENSE MCE
	ON IPT.Misc_Expense=MCE.Cost_Expense_Code
	LEFT JOIN
SYSTEM_SOURCE SSO
	ON IPT.System_Source=SSO.System_Source_Code
	LEFT JOIN 
GLOBAL_COMPONENT_CODES GCC 
	ON IPT.Global_Code=1 AND IPT.Component_Code=GCC.Global_Component_Code
	LEFT JOIN 
GLOBAL_COMPONENT_CODE_LINK GCCL 
	ON GCC.Global_Id=GCCL.Global_Component_Code_Id
	LEFT JOIN
tblComponentCodes CCG
	ON GCCL.AMT_Component_Code_Id=CCG.ComponentCodeID
	LEFT JOIN 
GLOBAL_PART_TYPES GPT 
	ON IPT.Global_Code=1 AND IPT.Part_Type=GPT.Global_Part_Type
	LEFT JOIN
tblPartTypes PTYG
	ON GPT.Global_Part_Type_Id=PTYG.Global_Part_Type_Id
	LEFT JOIN 
GLOBAL_JOB_CODES GJC 
	ON IPT.Global_Code=1 AND IPT.Job_Code=GJC.Global_Job_Code
	LEFT JOIN
tblJobCodes JCG
	ON GJC.Global_Job_Id=JCG.Global_Job_Code_Id
	/*VV E316*/
	LEFT JOIN
PART_RATING PAR
	ON IPT.Rating=PAR.PartRating



--E#395 - Update For an UPDATE:
--Do NOT update the frequency in AMT. 
--Do not update the UOM either if the Interval = NULL.  ie the user can set the UOM for the task in AMT and this is not updated with the interface file. 

UPDATE IPT
SET
	/*VV #1837*/
	IPT.ProjTaskId=PT.ProjTaskId,
	IPT.Frequency = CASE WHEN IPT.Frequency = 99999 AND PT.ProjTaskId IS NOT NULL THEN PT.Frequency ELSE IPT.Frequency END ,
	IPT.UOM = CASE WHEN IPT.Frequency = 99999 AND PT.ProjTaskId IS NOT NULL THEN Q.Short_Desc ELSE IPT.UOM END ,
	IPT.QuomId = CASE WHEN IPT.Frequency = 99999 AND PT.ProjTaskId IS NOT NULL THEN PT.UsageQUomId ELSE IPT.QuomId END 
FROM
#z_I_PROJECTED_TASKS IPT
	INNER JOIN
tblEqpPlans E
	ON IPT.EqpPlanId=E.EqpPlanId
	INNER JOIN
tblEqpProjs EPR
	ON IPT.EqpProjId=EPR.EqpProjId
	LEFT JOIN
tblProjTasks PT
	ON IPT.EqpProjId=PT.EqpProjId AND 
	   IPT.ComponentCodeId=PT.ComponentCodeId AND
	   IPT.ModifierId =PT.ModifierId AND
	   IPT.TaskTypeId=PT.TaskTypeId AND
	   IPT.ApplicationCodeId=PT.ApplicationCodeId
	  LEFT JOIN
tblQuoms Q ON Q.QuomId = PT.UsageQuomId
--Enhancement 527
--WHERE PT.ProjTaskId IS NOT NULL


--#Enh:527 to choose external identifier to update strategy task
If(@UpdateStrategyTaskCodes=1)
BEGIN
	UPDATE IPT
	SET
		IPT.ProjTaskId=PT.ProjTaskId,
		IPT.Frequency = CASE WHEN IPT.Frequency = 99999 AND PT.ProjTaskId IS NOT NULL THEN PT.Frequency ELSE IPT.Frequency END ,
		IPT.UOM = CASE WHEN IPT.Frequency = 99999 AND PT.ProjTaskId IS NOT NULL THEN Q.Short_Desc ELSE IPT.UOM END ,
		IPT.QuomId = CASE WHEN IPT.Frequency = 99999 AND PT.ProjTaskId IS NOT NULL THEN PT.UsageQUomId ELSE IPT.QuomId END ,
		IPT.ProjTaskOptId=PTO.ProjTaskOptId
	FROM
	#z_I_PROJECTED_TASKS IPT
	INNER JOIN
	tblEqpPlans E
	ON IPT.EqpPlanId=E.EqpPlanId
	INNER JOIN
	tblEqpProjs EPR
	ON IPT.EqpProjId=EPR.EqpProjId
	INNER JOIN
	tblProjTasks PT
	ON IPT.EqpProjId=PT.EqpProjId AND
	IPT.External_Identifier=PT.ExternalIdentifier
	LEFT JOIN
	tblQuoms Q ON Q.QuomId = PT.UsageQuomId
	LEFT JOIN
	tblProjTaskOpts PTO
	ON PT.ProjTaskId=PTO.ProjTaskId
	WHERE ISNULL(IPT.External_Identifier,'')<>''
END

UPDATE IPT SET
--Enhancement 527
--IPT.ProjTaskId=PT.ProjTaskId,
IPT.ProjTaskOptId=PTO.ProjTaskOptId,
IPT.RRTask=CASE WHEN ISNULL(PT.ParentTaskId,0)>0 THEN 1 ELSE 0 END,
IPT.First = CASE 
			WHEN IPT.Unscheduled<>0 THEN 0
			WHEN IPT.First IS NOT NULL THEN IPT.First 
			WHEN PT.First IS NOT NULL THEN PT.First -- KN 20070911 -- UPDATE FIRST IF NOT NULL
			WHEN IPT.QuomId IS NULL THEN IPT.Frequency 
			ELSE/*QUOMId>0*/
				CASE WHEN 
						(CASE	
						WHEN IPT.Last_Change_Usage IS NOT NULL THEN IPT.Last_Change_Usage
						WHEN IPT.QUOMId=PT.UsageQUOMId AND PT.Last_Change_Usage IS NOT NULL THEN PT.Last_Change_Usage
						WHEN (IPT.Last_Occurrence IS NOT NULL OR IPT.Last_Occ_Date IS NOT NULL) THEN ISNULL(IPT.Last_Occurrence,0)
						ELSE 0
						END) < ISNULL(EPSU.StartUsage,0)
					THEN
						(CASE	
						WHEN IPT.Last_Change_Usage IS NOT NULL THEN IPT.Last_Change_Usage
						WHEN IPT.QUOMId=PT.UsageQUOMId AND PT.Last_Change_Usage IS NOT NULL THEN PT.Last_Change_Usage
						WHEN (IPT.Last_Occurrence IS NOT NULL OR IPT.Last_Occ_Date IS NOT NULL) THEN ISNULL(IPT.Last_Occurrence,0)
						ELSE 0
						END)
							
					ELSE 0
				END  + IPT.Frequency
			END ,
IPT.Last_Change_Usage = CASE	WHEN
									(CASE	
										WHEN IPT.Unscheduled=1 OR IPT.Projection_Type_Id=@TypeCen OR PT.ParentTaskId>0 THEN 0
										WHEN IPT.QUOMId IS NULL THEN 0
										WHEN IPT.Last_Change_Usage IS NOT NULL THEN IPT.Last_Change_Usage 
										WHEN IPT.QUOMId=PT.UsageQUOMId AND PT.Last_Change_Usage IS NOT NULL THEN PT.Last_Change_Usage
										WHEN (IPT.Last_Occurrence IS NOT NULL OR IPT.Last_Occ_Date IS NOT NULL) THEN ISNULL(IPT.Last_Occurrence,0)
										ELSE 0
									 END)<ISNULL(EPSU.StartUsage,0)
								THEN
									(CASE	
										WHEN IPT.Unscheduled=1 OR IPT.Projection_Type_Id=@TypeCen OR PT.ParentTaskId>0 THEN 0
										WHEN IPT.QUOMId IS NULL THEN 0
										WHEN IPT.Last_Change_Usage IS NOT NULL THEN IPT.Last_Change_Usage 
										WHEN IPT.QUOMId=PT.UsageQUOMId AND PT.Last_Change_Usage IS NOT NULL THEN PT.Last_Change_Usage
										WHEN (IPT.Last_Occurrence IS NOT NULL OR IPT.Last_Occ_Date IS NOT NULL) THEN ISNULL(IPT.Last_Occurrence,0)
										ELSE 0
									 END)
								ELSE 0 END,

IPT.Last_Change_Date =  CASE WHEN
								(CASE 
									WHEN IPT.Unscheduled=1 OR IPT.Projection_Type_Id=@TypeCen OR PT.ParentTaskId>0 THEN E.StartDate
									WHEN IPT.Last_Change_Date IS NOT NULL THEN IPT.Last_Change_Date 
									WHEN PT.Last_Change_Date IS NOT NULL THEN PT.Last_Change_Date
									WHEN IPT.Last_Occurrence IS NOT NULL OR IPT.Last_Occ_Date IS NOT NULL THEN ISNULL(IPT.Last_Occ_Date,E.StartDate)
									ELSE E.StartDate 
								 END)<E.StartDate
							THEN 
								(CASE 
									WHEN IPT.Unscheduled=1 OR IPT.Projection_Type_Id=@TypeCen OR PT.ParentTaskId>0 THEN E.StartDate
									WHEN IPT.Last_Change_Date IS NOT NULL THEN IPT.Last_Change_Date 
									WHEN PT.Last_Change_Date IS NOT NULL THEN PT.Last_Change_Date
									WHEN IPT.Last_Occurrence IS NOT NULL OR IPT.Last_Occ_Date IS NOT NULL THEN ISNULL(IPT.Last_Occ_Date,E.StartDate)
									ELSE E.StartDate 
								 END)
							ELSE E.StartDate END,
IPT.Planning_Task=CASE WHEN IPT.Unscheduled=1 OR PT.ParentTaskId>0 THEN 0
					   WHEN IPT.Projection_Type_Id=@TypeCur AND /* VV 3-Nov-08 IPT.External_Identifier*/ IPT.Scheduling_Task IS NOT NULL THEN 1
				  ELSE IPT.Planning_Task END,
IPT.Planning_Lead_Time=CASE WHEN IPT.Unscheduled=1 OR PT.ParentTaskId>0 THEN 0
						    WHEN (IPT.Projection_Type_Id=@TypeCur AND /* VV 3-Nov-08 IPT.External_Identifier*/ IPT.Scheduling_Task IS NOT NULL) 
									THEN ISNULL(NULLIF(IPT.Planning_Lead_Time,0),@PlanningDaysDefault)
							WHEN IPT.Planning_Task=1 THEN ISNULL(NULLIF(IPT.Planning_Lead_Time,0),@PlanningDaysDefault)
							WHEN IPT.Planning_Task=0 THEN 0 /*VV/KN 4-Nov-2008*/
					   ELSE IPT.Planning_Lead_Time END,
IPT.Task_Description =ISNULL(IPT.Task_Description,PT.Task_Description), -- DO NOT UPDATE IF NULL FROM THE INTERFACE
/*VV E316*/
IPT.Tag_Id=ISNULL(IPT.Tag_Id,PT.TagId), -- DO NOT UPDATE IF NULL FROM THE INTERFACE
IPT.PartId=CASE WHEN IPT.Unscheduled=1 OR PT.ParentTaskId>0 THEN NULL ELSE IPT.PartId END,
IPT.Standard_Job_Reference=CASE WHEN IPT.Unscheduled=1 OR PT.ParentTaskId>0 THEN NULL ELSE IPT.Standard_Job_Reference END,
IPT.Warranty_Usage=CASE WHEN IPT.Unscheduled=1 OR PT.ParentTaskId>0 THEN 0 ELSE IPT.Warranty_Usage END,
IPT.Warranty_Days=CASE WHEN IPT.Unscheduled=1 OR PT.ParentTaskId>0 THEN 0 ELSE IPT.Warranty_Days END,
IPT.RotableId=CASE WHEN IPT.Unscheduled=1 OR PT.ParentTaskId>0 OR IPT.Projection_Type_Id<>@TypeCur THEN NULL ELSE RPM.Rotable_Part_Id END,
IPT.Consumable=CASE 
			WHEN IPT.Unscheduled=1 OR PT.ParentTaskId>0 THEN 0
			WHEN IPT.Standard_Job_Reference IS NOT NULL THEN 0
			WHEN IPT.QtyVolume<>0 OR IPT.PercentTopUp<>0 OR IPT.UnitPrice<>0 THEN 1
			ELSE 0 END,
IPT.Pricing_date=CASE WHEN @LeavePricingDate=0 AND @NewPricingDate IS NOT NULL THEN @NewPricingDate
				 WHEN IPT.Projection_Type_Id IN(@TypeBud,@TypeEC,@TypeED) THEN EPR.Pricing_Date
				 ELSE IPT.Pricing_Date END,

LaborCost=CASE @EscCosts WHEN 1 THEN ceCur.CumLaborEscalation/ceNew.CumLaborEscalation ELSE 1.00 END *IPT.LaborCost,
PartsCost=CASE	
			/* Do not escalate parts cost if consumable, just copy it across.
			We don't change unit price, qty, top up pct.*/
			WHEN (CASE 
					WHEN IPT.Unscheduled=1 OR PT.ParentTaskId>0 THEN 0
					WHEN IPT.Standard_Job_Reference IS NOT NULL THEN 0
					WHEN IPT.QtyVolume<>0 OR IPT.PercentTopUp<>0 OR IPT.UnitPrice<>0 THEN 1
					ELSE 0 END)=1 THEN 1.00
			WHEN @EscCosts =1 THEN cpeCur.CumPartsEscalation/cpeNew.CumPartsEscalation ELSE 1.00 END *IPT.PartsCost,
MiscCost=CASE @EscCosts WHEN 1 THEN ceCur.CumMiscEscalation/ceNew.CumMiscEscalation ELSE 1.00 END *IPT.MiscCost,
/*VV 21-Apr-2009*/
Maintenance_Strategy_Id=ISNULL(IPT.Maintenance_Strategy_Id,PT.Maintenance_Strategy_Id)
FROM
#z_I_PROJECTED_TASKS IPT
	INNER JOIN
tblEqpPlans E
	ON IPT.EqpPlanId=E.EqpPlanId
	INNER JOIN
tblEqpProjs EPR
	ON IPT.EqpProjId=EPR.EqpProjId
	LEFT JOIN
tblProjTasks PT
	ON IPT.ProjTaskId=PT.ProjTaskId  	   
	   /* --Enhancement 527
	   IPT.ComponentCodeId=PT.ComponentCodeId AND
	   IPT.ModifierId =PT.ModifierId AND
	   IPT.TaskTypeId=PT.TaskTypeId AND
	   IPT.ApplicationCodeId=PT.ApplicationCodeId*/
	LEFT JOIN
tblProjTaskOpts PTO
	ON PT.ProjTaskId=PTO.ProjTaskId
	LEFT JOIN 
tblEqpPlanStartUsages EPSU 
	ON IPT.EqpPlanId = EPSU.EqpPlanId AND IPT.QuomId=EPSU.StartUsageQuomId
	LEFT JOIN
ROTABLE_PART_MODEL RPM
	ON IPT.ModelId=RPM.Model_Id AND IPT.Rotable_Part_Id=RPM.Rotable_Part_Id
	LEFT JOIN 
tblCostEscalations ceCur 
	ON ceCur.EscalationDate <= IPT.Pricing_Date -- @oldTaskPricingDate
	   AND ceCur.EndDate > IPT.Pricing_Date -- @oldTaskPricingDate
	LEFT JOIN 
tblCostPartsEscalations cpeCur 
	ON ceCur.CostEscalationId =cpeCur.CostEscalationId
	AND cpeCur.ManufacturerId= IPT.ManufacturerId
	LEFT JOIN 
tblCostEscalations ceNew 
	ON ceNew.EscalationDate <= @NewPricingDate
	AND ceNew.EndDate > @NewPricingDate
	LEFT JOIN 
tblCostPartsEscalations cpeNew 
	ON ceNew.CostEscalationId =cpeNew.CostEscalationId
		AND cpeNew.ManufacturerId= IPT.ManufacturerId



--proj task import file can have multiple records for proj tasks
--Identify the groups	
UPDATE IPT SET PTGroupMin=A.PTGroupMin,PTGroupMax=A.PTGroupMax
FROM
#z_I_PROJECTED_TASKS IPT
	INNER JOIN
(SELECT EqpProjId,ComponentCodeId,ModifierId,TaskTypeId,ApplicationCodeId,
Inactive_Task,Unscheduled,Planning_Task,Planning_Lead_Time,Operational_Criticality_Id,
ManufacturerId,Part_SOS_Id,PartId,Group_Number,Rotable_Part_Id,Warranty_Days,
Warranty_Usage,QUOMId,Schedule_On_Last_Scheduled,[First],Frequency,Final,Last_Change_Usage,
Last_Change_Date,External_Identifier,Schedule_Type_Id,Scheduling_Group_Id,Scheduling_Group_Counter,
InspectionTaskTypeId,InspectionOffset,Maintenance_Strategy_Id, PerformanceStrategyReason,
Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,SchedulingTaskId,
Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,
Task_Description,
MIN(Line_No) AS PTGroupMin,MAX(Line_No) AS PTGroupMax,
Update_Scheduling_Task_Only,
/*VV E316*/Tag_Id,PartRatingId
FROM #z_I_PROJECTED_TASKS
GROUP BY
EqpProjId,ComponentCodeId,ModifierId,TaskTypeId,ApplicationCodeId,
Inactive_Task,Unscheduled,Planning_Task,Planning_Lead_Time,Operational_Criticality_Id,
ManufacturerId,Part_SOS_Id,PartId,Group_Number,Rotable_Part_Id,Warranty_Days,
Warranty_Usage,QUOMId,Schedule_On_Last_Scheduled,[First],Frequency,Final,Last_Change_Usage,
Last_Change_Date,External_Identifier,Schedule_Type_Id,Scheduling_Group_Id,Scheduling_Group_Counter,
InspectionTaskTypeId,InspectionOffset,Maintenance_Strategy_Id, PerformanceStrategyReason,
Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,SchedulingTaskId,
Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,
Task_Description,Update_Scheduling_Task_Only,
/*VV E316*/Tag_Id,PartRatingId) A
	ON IPT.EqpProjId = A.EqpProjId AND 
		ISNULL(IPT.ComponentCodeId,0)=ISNULL(A.ComponentCodeId,0) AND
		ISNULL(IPT.ModifierId,0)=ISNULL(A.ModifierId,0) AND
		ISNULL(IPT.TaskTypeId,0)=ISNULL(A.TaskTypeId,0) AND
		ISNULL(IPT.ApplicationCodeId,0)=ISNULL(A.ApplicationCodeId,0) AND
		ISNULL(IPT.Inactive_Task,0)=ISNULL(A.Inactive_Task,0) AND
		ISNULL(IPT.Unscheduled,0)=ISNULL(A.Unscheduled,0) AND
		ISNULL(IPT.Planning_Task,0)=ISNULL(A.Planning_Task,0) AND
		ISNULL(IPT.Planning_Lead_Time,0)=ISNULL(A.Planning_Lead_Time,0) AND
		ISNULL(IPT.Operational_Criticality_Id,0)=ISNULL(A.Operational_Criticality_Id,0) AND
		ISNULL(IPT.ManufacturerId,0)=ISNULL(A.ManufacturerId,0) AND
		ISNULL(IPT.Part_SOS_Id,0)=ISNULL(A.Part_SOS_Id,0) AND
		ISNULL(IPT.PartId,0)=ISNULL(A.PartId,0) AND
		ISNULL(IPT.Group_Number,'')=ISNULL(A.Group_Number,'') AND
		ISNULL(IPT.Rotable_Part_Id,0)=ISNULL(A.Rotable_Part_Id,0) AND
		ISNULL(IPT.Warranty_Days,0)=ISNULL(A.Warranty_Days,0) AND
		ISNULL(IPT.Warranty_Usage,0)=ISNULL(A.Warranty_Usage,0) AND
		ISNULL(IPT.QUOMId,0)=ISNULL(A.QUOMId,0) AND
		ISNULL(IPT.Schedule_On_Last_Scheduled,0)=ISNULL(A.Schedule_On_Last_Scheduled,0) AND
		ISNULL(IPT.[First],0)=ISNULL(A.[First],0) AND
		ISNULL(IPT.Frequency,0)=ISNULL(A.Frequency,0) AND
		ISNULL(IPT.Final,0)=ISNULL(A.Final,0) AND
		ISNULL(IPT.Last_Change_Usage,0)=ISNULL(A.Last_Change_Usage,0) AND
		ISNULL(IPT.Last_Change_Date,@TodaysDate)=ISNULL(A.Last_Change_Date,@TodaysDate) AND
		ISNULL(IPT.External_Identifier,'')=ISNULL(A.External_Identifier,'') AND
		ISNULL(IPT.Schedule_Type_Id,0)=ISNULL(A.Schedule_Type_Id,0) AND
		ISNULL(IPT.Scheduling_Group_Id,0)=ISNULL(A.Scheduling_Group_Id,0) AND
		ISNULL(IPT.Scheduling_Group_Counter,-1)=ISNULL(A.Scheduling_Group_Counter,-1) AND
		ISNULL(IPT.InspectionTaskTypeId,0)=ISNULL(A.InspectionTaskTypeId,0) AND
		ISNULL(IPT.InspectionOffset,0)=ISNULL(A.InspectionOffset,0) AND
		ISNULL(IPT.Maintenance_Strategy_Id,0)=ISNULL(A.Maintenance_Strategy_Id,0) AND 
		ISNULL(IPT.PerformanceStrategyReason,'')=ISNULL(A.PerformanceStrategyReason,'') AND
		ISNULL(IPT.Changeout_Guidelines,'')=ISNULL(A.Changeout_Guidelines,'') AND
		ISNULL(IPT.ERP_Component_Code,'')=ISNULL(A.ERP_Component_Code,'') AND
		ISNULL(IPT.ERP_Modifier_Code,'')=ISNULL(A.ERP_Modifier_Code,'') AND
		ISNULL(IPT.ERP_Scheduling_Task,'')=ISNULL(A.ERP_Scheduling_Task,'') AND
		ISNULL(IPT.SchedulingTaskId,0)=ISNULL(A.SchedulingTaskId,0) AND
		ISNULL(IPT.Last_Occurrence,0)=ISNULL(A.Last_Occurrence,0) AND
		ISNULL(IPT.Last_Occ_Date,@TodaysDate)=ISNULL(A.Last_Occ_Date,@TodaysDate) AND
		ISNULL(IPT.Last_Scheduled,0)=ISNULL(A.Last_Scheduled,0) AND
		ISNULL(IPT.Last_Sched_Date,@TodaysDate)=ISNULL(A.Last_Sched_Date,@TodaysDate) AND
		ISNULL(IPT.Next_Occurrence,0)=ISNULL(A.Next_Occurrence,0) AND
		ISNULL(IPT.Next_Occ_Date,@TodaysDate)=ISNULL(A.Next_Occ_Date,@TodaysDate) AND
		ISNULL(IPT.Task_Description,'')=ISNULL(A.Task_Description,'') AND
		ISNULL(IPT.Update_Scheduling_Task_Only,0)=ISNULL(A.Update_Scheduling_Task_Only,0) AND
		/*VV E316*/
		ISNULL(IPT.Tag_Id,'')=ISNULL(A.Tag_Id,'') AND
		ISNULL(IPT.PartRatingId,0)=ISNULL(A.PartRatingId,0)
		


/***************************************************/
	-- LOG AND DELETE INVALID ROWS
/***************************************************/


--strategy task have rotable components linked to them.

INSERT INTO #z_Message(Line_No,ErrorDescription,ImportRecord)
SELECT IPT.Line_No,' Strategy Task cannot be deleted as Rotable Component is linked to it;',CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
 ,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,/*VV E790*/Old_Ext_Id,Suppression_Group,Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
 FROM IMPORT_PROJECTION  IP where IP.Line_No = IPT.Line_No AND IP.Import_File_Name=@ImportFileName FOR XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs')) END  AS ImportRecord

FROM
#z_I_PROJECTED_TASKS IPT
	INNER JOIN
tblProjTasks PT
	ON IPT.ProjTaskId=PT.ProjTaskId
WHERE IPT.Inactive_Task=1 AND PT.Rotable_Part_id>0

INSERT INTO #z_Message(Line_No,ErrorDescription,ImportRecord)
SELECT DISTINCT IPT.Line_No,' Strategy Task cannot be deleted as Rotable Component History is linked to it;',CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
 ,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,/*VV E790*/Old_Ext_Id,Suppression_Group,Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
 FROM IMPORT_PROJECTION  IP where IP.Line_No = IPT.Line_No AND IP.Import_File_Name=@ImportFileName FOR XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs')) END AS ImportRecord
FROM
#z_I_PROJECTED_TASKS IPT
	INNER JOIN
ROTABLE_INUSE RI 
	ON IPT.ProjTaskId =RI.Proj_Task_Id
WHERE IPT.Inactive_Task=1 

INSERT INTO #z_Message(Line_No,ErrorDescription,ImportRecord)
SELECT DISTINCT IPT.Line_No,' Strategy Task cannot be deleted as Plant Asset Jornal records are linked to it;',CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
 ,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,/*VV E790*/Old_Ext_Id,Suppression_Group,Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
 FROM IMPORT_PROJECTION  IP where IP.Line_No = IPT.Line_No AND IP.Import_File_Name=@ImportFileName for XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs')) END AS ImportRecord
FROM
#z_I_PROJECTED_TASKS IPT
	INNER JOIN
CBD_ADJUSTMENT A 
	ON IPT.ProjTaskId =A.ProjTaskId
WHERE IPT.Inactive_Task=1

CREATE TABLE #z_DONOTDELETE(ProjTaskId int PRIMARY KEY(ProjTaskId))

IF EXISTS(SELECT Line_No FROM #z_Message WHERE ErrorDescription<>'')
BEGIN
	
	INSERT INTO IMPORT_ERROR(ImportFileName,Line_No,ErrorDescription,ImportErrorTypeId,LastModDate,ImportRecord,ImportSourceId)
	SELECT @ImportFileName AS ImportFileName,CASE WHEN @InterfaceSource = 0 THEN Line_No END,ErrorDescription, @ErrorTypeBusRules AS ImportErrorTypeId,
	GETDate() AS LastModDate,CONVERT(VARCHAR(MAX),ImportRecord),@InterfaceSource
	FROM #z_Message WHERE ErrorDescription<>''

	--If @EqpProjIdTo is supplied the procedure will delete the tasks which are not in the file
	-- this tasks cannot be deleted because of the business rules.
	IF @EqpProjIdTo>0
	BEGIN
		INSERT INTO #z_DONOTDELETE(ProjTaskId)
		SELECT DISTINCT IPT.ProjTaskId 
		FROM 
		#z_I_PROJECTED_TASKS IPT
			INNER JOIN
		#z_Message M
			ON IPT.Line_No=M.Line_No
			LEFT JOIN
		#z_DONOTDELETE D
			ON IPT.ProjTaskId=D.ProjTaskId
		WHERE IPT.ProjTaskId>0 AND D.ProjTaskId IS NULL
	END

	DELETE IPT FROM
	#z_I_PROJECTED_TASKS IPT
		INNER JOIN
	#z_Message M
		ON IPT.Line_No=M.Line_No
	WHERE M.ErrorDescription<>''

	TRUNCATE TABLE #z_Message

	IF NOT EXISTS(SELECT * FROM #z_I_PROJECTED_TASKS)
	BEGIN
		GOTO END_IMPORT
	END

END


--Other rules

INSERT INTO #z_Message(Line_No,ErrorDescription,ImportRecord)
SELECT Line_No,
CASE WHEN IPT.EqpPlanId IS NULL THEN ' Unable to find the Equipment;' ELSE '' END+
CASE WHEN IPT.EqpProjId IS NULL THEN ' Unable to find the Projection;' ELSE '' END+
CASE WHEN IPT.ComponentCodeId/* VV 13-Nov-08 Component_Code*/ IS NULL THEN ' Component_Code is not specified;' ELSE '' END+
CASE WHEN IPT.TaskTypeId/*VV 13-Nov-08 Task_Type*/ IS NULL THEN ' Task_Type is not specified;' ELSE '' END+
CASE WHEN IPT.Model IS NULL THEN ' Model is not specified;' ELSE '' END+
CASE WHEN IPT.Inactive_Task = 0 AND ISNULL(IPT.Frequency,0) <=0 THEN ' Interval should be greater than zero;' ELSE '' END+
CASE WHEN IPT.Projection_Type_Id=@TypeArc THEN ' Archived Projection is not updated;' ELSE '' END AS ErrorDescription,
CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
 ,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,/*VV E790*/Old_Ext_Id,Suppression_Group,Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
 FROM IMPORT_PROJECTION  IP where IP.Line_No = IPT.Line_No AND IP.Import_File_Name=@ImportFileName FOR XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs')) END AS ImportRecord
FROM #z_I_PROJECTED_TASKS IPT
WHERE (IPT.Inactive_Task = 0) AND
(
IPT.EqpPlanId IS NULL OR 
IPT.EqpProjId IS NULL OR 
IPT.ComponentCodeId IS NULL OR 
IPT.TaskTypeId IS NULL OR 
IPT.Model IS NULL OR 
ISNULL(IPT.Frequency,0) = 0 OR
IPT.Projection_Type_Id=@TypeArc)


IF EXISTS(SELECT Line_No FROM #z_Message WHERE ErrorDescription<>'')
BEGIN
	
	INSERT INTO IMPORT_ERROR(ImportFileName,Line_No,ErrorDescription,ImportErrorTypeId,LastModDate,ImportRecord,ImportSourceId)
	SELECT @ImportFileName AS ImportFileName,CASE WHEN @InterfaceSource = 0 THEN Line_No END,ErrorDescription, @ErrorTypeBusRules AS ImportErrorTypeId,
	GETDate() AS LastModDate,CONVERT(VARCHAR(MAX),ImportRecord),@InterfaceSource
	FROM #z_Message WHERE ErrorDescription<>''

	DELETE IPT FROM
	#z_I_PROJECTED_TASKS IPT
		INNER JOIN
	#z_Message M
		ON IPT.Line_No=M.Line_No
	WHERE M.ErrorDescription<>''

	TRUNCATE TABLE #z_Message

	IF NOT EXISTS(SELECT * FROM #z_I_PROJECTED_TASKS)
	BEGIN
		GOTO END_IMPORT
	END
END


--RR Task cannot have more than 1 Job
INSERT INTO #z_Message(Line_No,ErrorDescription,ImportRecord)
SELECT
IPT.Line_No,' Repair Reserve Task cannot have more than 1 Job;' AS ErrorDescription,CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
 ,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,/*VV E790*/Old_Ext_Id,Suppression_Group,Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
 FROM IMPORT_PROJECTION  IP where IP.Line_No = IPT.Line_No AND IP.Import_File_Name=@ImportFileName FOR XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs')) END AS ImportRecord
FROM 
#z_I_PROJECTED_TASKS IPT 
	INNER JOIN 
(SELECT IPT.PTGroupMin
FROM 
#z_I_PROJECTED_TASKS IPT 
	INNER JOIN 
tblProjTasks PT 
	ON IPT.ProjTaskId=PT.ProjTaskId
WHERE IPT.Inactive_Task = 0 AND PT.ParentTaskId>0
GROUP BY IPT.PTGroupMin,PT.ParentTaskId
HAVING COUNT(PT.ParentTaskId)>1) A
	ON IPT.PTGroupMin=A.PTGroupMin

-- External identifier exists in some other projected tasks
INSERT INTO #z_Message(Line_No,ErrorDescription,ImportRecord)
SELECT
IPT.Line_No,' External identifier exists in some other projected tasks;' AS ErrorDescription,CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
 ,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,/*VV E790*/Old_Ext_Id,Suppression_Group,Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
 FROM IMPORT_PROJECTION  IP where IP.Line_No = IPT.Line_No AND IP.Import_File_Name=@ImportFileName FOR XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs')) END AS ImportRecord
FROM 
tblProjTasks PT 
	INNER JOIN
tblEqpProjs EPR
	ON PT.EqpProjId=EPR.EqpProjId AND EPR.Projection_Type_Id=@TypeCur AND PT.EqpProjId<>@EqpProjIdTo
	INNER JOIN
#z_I_PROJECTED_TASKS IPT 
	ON 
	   PT.ExternalIdentifier = IPT.External_Identifier AND 
	   PT.ProjTaskId <> ISNULL(IPT.ProjTaskId,0) 
WHERE IPT.Inactive_Task = 0 

-- Duplicate External identifier
INSERT INTO #z_Message(Line_No,ErrorDescription,ImportRecord)
SELECT
IPT.Line_No,' Duplicate External Identifier;' AS ErrorDescription,CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
 ,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,/*VV E790*/Old_Ext_Id,Suppression_Group,Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
 FROM IMPORT_PROJECTION  IP where IP.Line_No = IPT.Line_No AND IP.Import_File_Name=@ImportFileName FOR XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs')) END AS ImportRecord
FROM 
#z_I_PROJECTED_TASKS IPT 
	INNER JOIN
(
	SELECT External_Identifier
	FROM #z_I_PROJECTED_TASKS 
	WHERE Projection_Type_Id=@TypeCur AND Inactive_Task = 0
	GROUP BY External_Identifier
	HAVING COUNT(DISTINCT PTGroupMin)>1
) DUP 
	ON IPT.External_Identifier=DUP.External_Identifier
WHERE IPT.Projection_Type_Id=@TypeCur AND IPT.Inactive_Task = 0

--System_Source for new scheduling tasks is required
INSERT INTO #z_Message(Line_No,ErrorDescription,ImportRecord)
SELECT IPT.Line_No,' Cannot add scheduling task. System Source is required;',CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
 ,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,/*VV E790*/Old_Ext_Id,Suppression_Group,Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
 FROM IMPORT_PROJECTION  IP where IP.Line_No = IPT.Line_No AND IP.Import_File_Name=@ImportFileName FOR XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs')) END AS ImportRecord
FROM
#z_I_PROJECTED_TASKS IPT
WHERE SystemSourceId IS NULL AND IPT.Inactive_Task=0 AND Projection_Type_Id=@TypeCur 
AND External_Identifier IS NOT NULL AND SchedulingTaskId IS NULL

--Duplicate component codes
INSERT INTO #z_Message(Line_No,ErrorDescription,ImportRecord)
SELECT Line_No,' More than one record with same combination of codes;' AS ErrorDescription,CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
 ,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,/*VV E790*/Old_Ext_Id,Suppression_Group,Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
 FROM IMPORT_PROJECTION  IP where IP.Line_No = IPT.Line_No AND IP.Import_File_Name=@ImportFileName FOR XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs')) END AS ImportRecord
FROM 
#z_I_PROJECTED_TASKS IPT  
INNER JOIN
(
	SELECT ComponentCodeId,ModifierId,TaskTypeId,ApplicationCodeId,
	EqpProjId
	FROM #z_I_PROJECTED_TASKS 
	WHERE Inactive_Task = 0
	GROUP BY EqpProjId,ComponentCodeId,ModifierId,TaskTypeId,ApplicationCodeId
	HAVING COUNT(DISTINCT PTGroupMin)>1
) DUP 
	ON IPT.EqpProjId=DUP.EqpProjId
	   AND IPT.ComponentCodeId=DUP.ComponentCodeId 
	   AND IPT.ModifierId=DUP.ModifierId
	   AND IPT.TaskTypeId=DUP.TaskTypeId
	   AND IPT.ApplicationCodeId=DUP.ApplicationCodeId
	
--raise error if manufacturer does not exist
INSERT INTO #z_Message(Line_No,ErrorDescription,ImportRecord)
SELECT Line_No,' Manufacturer not found;' AS ErrorDescription,
CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,/*VV E790*/Old_Ext_Id,Suppression_Group,Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
FROM IMPORT_PROJECTION  IP where IP.Line_No = IPT.Line_No AND IP.Import_File_Name=@ImportFileName FOR XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs')) END AS ImportRecord
FROM #z_I_PROJECTED_TASKS IPT WHERE IPT.Inactive_Task = 0 AND ManufacturerId IS NULL

--QUOM is not found
INSERT INTO #z_Message(Line_No,ErrorDescription,ImportRecord)
SELECT Line_No,' UOM not found;' AS ErrorDescription,
CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,/*VV E790*/Old_Ext_Id,Suppression_Group,Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
FROM IMPORT_PROJECTION  IP where IP.Line_No = IPT.Line_No AND IP.Import_File_Name=@ImportFileName FOR XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs')) END AS ImportRecord
FROM #z_I_PROJECTED_TASKS IPT 
WHERE IPT.Inactive_Task = 0 
AND QUOMId IS NULL 
AND ISNULL(UOM,'')<>''

-- Currency is not in AMT
INSERT INTO #z_Message(Line_No,ErrorDescription,ImportRecord)
SELECT Line_No,' Currency not found;' AS ErrorDescription,
CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,/*VV E790*/Old_Ext_Id,Suppression_Group,Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
FROM IMPORT_PROJECTION  IP where IP.Line_No = IPT.Line_No AND IP.Import_File_Name=@ImportFileName FOR XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs')) END AS ImportRecord
FROM  #z_I_PROJECTED_TASKS IPT WHERE IPT.Inactive_Task = 0 AND CurrencyId IS NULL AND ISNULL(Currency,'')<>''

--Cost Bearer is not found
INSERT INTO #z_Message(Line_No,ErrorDescription,ImportRecord)
SELECT Line_No,' Cost Bearer not found;' AS ErrorDescription,
CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,/*VV E790*/Old_Ext_Id,Suppression_Group,Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
FROM IMPORT_PROJECTION  IP where IP.Line_No = IPT.Line_No AND IP.Import_File_Name=@ImportFileName FOR XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs')) END AS ImportRecord
FROM  #z_I_PROJECTED_TASKS IPT WHERE IPT.Inactive_Task = 0 AND Cost_Bearer_Id IS NULL AND ISNULL(Cost_Bearer,'')<>''

--Check unassigned task rules
INSERT INTO #z_Message(Line_No,ErrorDescription,ImportRecord)
SELECT Line_No,
CASE
WHEN (IPT.Unscheduled=1 AND IPT.ComponentCodeId IS NULL)
	THEN ' Unassigned Component Code not found;' 
WHEN (SS.UnsCompCodeID>0 AND IPT.Unscheduled=0) OR (IPT.Task_Type='UN' AND IPT.Unscheduled=0)
	THEN ' Task shall be marked as Unassigned;'
END AS ErrorDescription, 
CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,/*VV E790*/Old_Ext_Id,Suppression_Group,Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
FROM IMPORT_PROJECTION  IP where IP.Line_No = IPT.Line_No AND IP.Import_File_Name=@ImportFileName FOR XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs')) END AS ImportRecord
FROM 
#z_I_PROJECTED_TASKS IPT 
	LEFT JOIN
tblSubSystems SS
	ON IPT.ComponentCodeId=SS.UnsCompCodeID
WHERE (IPT.Inactive_Task = 0) AND
((IPT.Unscheduled=1 AND IPT.ComponentCodeId IS NULL) OR
(SS.UnsCompCodeID>0 AND IPT.Unscheduled=0) OR 
(IPT.Task_Type='UN' AND IPT.Unscheduled=0))

--Check duplicate job codes and currency
INSERT INTO #z_Message(Line_No,ErrorDescription,ImportRecord)
SELECT DISTINCT Line_No,' More than one record with same combination of Currency and Job Code in the task;' AS ErrorDescription,
CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,/*VV E790*/Old_Ext_Id,Suppression_Group,Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
FROM IMPORT_PROJECTION  IP where IP.Line_No = IPT.Line_No AND IP.Import_File_Name=@ImportFileName FOR XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs')) END AS ImportRecord
FROM  
#z_I_PROJECTED_TASKS IPT  
INNER JOIN
(
	SELECT EqpProjId, PTGroupMin
	FROM #z_I_PROJECTED_TASKS
	WHERE Inactive_Task = 0
	GROUP BY EqpProjId,PTGroupMin,JobCodeId,Currency
	HAVING COUNT(*) > 1
) DUP 
	ON IPT.EqpProjId=DUP.EqpProjId
	AND IPT.PTGroupMin=DUP.PTGroupMin


--duplicate Standard Jobs
INSERT INTO #z_Message(Line_No,ErrorDescription,ImportRecord)
SELECT DISTINCT Line_No,' There are duplicate Standard Jobs in the task;' AS ErrorDescription,
CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,/*VV E790*/Old_Ext_Id,Suppression_Group,Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
FROM IMPORT_PROJECTION  IP where IP.Line_No = IPT.Line_No AND IP.Import_File_Name=@ImportFileName FOR XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs')) END AS ImportRecord
FROM  
#z_I_PROJECTED_TASKS IPT  
INNER JOIN
(
	SELECT EqpProjId, PTGroupMin
	FROM #z_I_PROJECTED_TASKS
	WHERE Inactive_Task = 0 AND ISNULL(Standard_Job_Reference,'')<>''
	GROUP BY EqpProjId,PTGroupMin,Standard_Job_Reference
	HAVING COUNT(*) > 1
) DUP 
	ON IPT.EqpProjId=DUP.EqpProjId
	AND IPT.PTGroupMin=DUP.PTGroupMin


--UOM does not exist in projection
INSERT INTO #z_Message(Line_No,ErrorDescription,ImportRecord)
SELECT IPT.Line_No,' UOM does not exist in projection;', 
CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,/*VV E790*/Old_Ext_Id,Suppression_Group,Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
FROM IMPORT_PROJECTION  IP where IP.Line_No = IPT.Line_No AND IP.Import_File_Name=@ImportFileName FOR XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs')) END AS ImportRecord
FROM
#z_I_PROJECTED_TASKS IPT 
	LEFT JOIN 
(SELECT DISTINCT EPR.EqpProjId,ISNULL(USR.ChildQUOMId,EPR.EndQUOMId) AS QUOMId
FROM         
tblUsageSteps US INNER JOIN
tblUsageStepRels USR ON US.UsageStepId = USR.UsageStepId INNER JOIN
tblUsageProfiles UP ON US.UsageProfileId = UP.UsageProfileId RIGHT OUTER JOIN
tblEqpProjs EPR ON UP.UsageProfileId = EPR.ProjUsageProfileId
WHERE EPR.EqpProjId IN(SELECT EqpProjId FROM #z_I_PROJECTED_TASKS WHERE EqpProjId>0 AND Inactive_Task=0)) A
	ON IPT.EqpProjId=A.EqpProjId AND ISNULL(IPT.QUOMId,0)=ISNULL(A.QUOMId,0)
WHERE IPT.Inactive_Task=0 AND ISNULL(IPT.QUOMId,0)<>0 AND A.EqpProjId IS NULL


IF EXISTS(SELECT Line_No FROM #z_Message WHERE ErrorDescription<>'')
BEGIN
	

	INSERT INTO IMPORT_ERROR(ImportFileName,Line_No,ErrorDescription,ImportErrorTypeId,LastModDate,ImportRecord,ImportSourceId)
	SELECT @ImportFileName AS ImportFileName,CASE WHEN @InterfaceSource = 0 THEN Line_No END,ErrorDescription, @ErrorTypeBusRules AS ImportErrorTypeId,
	GETDate() AS LastModDate,CONVERT(VARCHAR(MAX),ImportRecord),@InterfaceSource
	FROM #z_Message WHERE ErrorDescription<>''

	DELETE IPT FROM
	#z_I_PROJECTED_TASKS IPT
		INNER JOIN
	#z_Message M
		ON IPT.Line_No=M.Line_No
	WHERE M.ErrorDescription<>''

	TRUNCATE TABLE #z_Message

	IF NOT EXISTS(SELECT * FROM #z_I_PROJECTED_TASKS)
	BEGIN
		GOTO END_IMPORT
	END
END



INSERT INTO TASK_HEADER (Description, Component_code, Modifier_code, task_type, application_code)
SELECT     cc1.Code + '.' + mc1.Code + '.' + tt1.Code + '.' + ac1.Code + ' ' + cc1.Description, cc1.Code, mc1.Code, tt1.Code, ac1.Code
FROM         dbo.TASK_HEADER th INNER JOIN
                      dbo.tblComponentCodes cc ON th.Component_Code = cc.Code INNER JOIN
                      dbo.tblApplicationCodes ac ON th.Application_Code = ac.Code INNER JOIN
                      dbo.tblTaskTypes tt ON th.Task_Type = tt.Code INNER JOIN
                      dbo.tblModifierCodes mc ON th.Modifier_Code = mc.Code RIGHT OUTER JOIN
                      #z_I_PROJECTED_TASKS t ON cc.ComponentCodeID = t.ComponentCodeID AND ac.ApplicationCodeID = t.ApplicationCodeID AND 
                      tt.TaskTypeID = t.TaskTypeID AND mc.ModifierID = t.ModifierID INNER JOIN
                      dbo.tblComponentCodes cc1 ON t.ComponentCodeID = cc1.ComponentCodeID INNER JOIN
                      dbo.tblModifierCodes mc1 ON t.ModifierID = mc1.ModifierID INNER JOIN
                      dbo.tblTaskTypes tt1 ON t.TaskTypeID = tt1.TaskTypeID INNER JOIN
                      dbo.tblApplicationCodes ac1 ON t.ApplicationCodeID = ac1.ApplicationCodeID
WHERE     (th.Task_Header_Id IS NULL)
GROUP BY cc1.Code + '.' + mc1.Code + '.' + tt1.Code + '.' + ac1.Code + ' ' + cc1.Description, cc1.Code, mc1.Code, tt1.Code, ac1.Code


--Apply business rules
UPDATE IPT SET
/* VV #3469
IPT.CurrencyId=ISNULL(IPT.CurrencyId,@PrimaryCurrency),*/
IPT.Pricing_Date=ISNULL(IPT.Pricing_Date,GETDATE()),

/*VV E799
If Amt setting UpdateAdvancedSchedulingLogic=1 strategy task import updates advanced scheduling logic
If Amt Setting UpdateAdvancedSchedulingLogic=0 the import checks if strategy task is linked to the scheduling task.
 If it is linked to a scheduling task then import updates the scheduling logic
If strategy task is not linked to the scheduling task then import does not update Advanced Scheduling Logic and Scheduling Details.

*/
/*Planning task was set earlier in the first update statement*/
IPT.Schedule_Type_Id=CASE IPT.Planning_Task 
			WHEN 1 THEN 
				CASE WHEN IPT.SchedulingTaskId>0 THEN IPT.Schedule_Type_Id
				WHEN @UpdateAdvancedSchedulingLogic=0 AND (PT.InspectionTaskTypeId>0 OR PT.Scheduling_Group_Id>0) THEN PT.Schedule_Type_Id
				ELSE IPT.Schedule_Type_Id END
			ELSE
				CASE WHEN IPT.QUOMId>0 THEN @LastPerfUOM ELSE @LastPerfDate END
			END,
/*null for non-planning task*/
IPT.InspectionTaskTypeId=CASE IPT.Planning_Task 
	WHEN 0 THEN NULL
	ELSE
		CASE WHEN IPT.SchedulingTaskId>0 THEN IPT.InspectionTaskTypeId
		WHEN @UpdateAdvancedSchedulingLogic=0 AND (PT.InspectionTaskTypeId>0 OR PT.Scheduling_Group_Id>0) THEN PT.InspectionTaskTypeId
		ELSE IPT.InspectionTaskTypeId END
	END,
/*0 for non-planning task*/	
IPT.InspectionOffset=CASE IPT.Planning_Task 
	WHEN 0 THEN 0
	ELSE
		CASE WHEN IPT.SchedulingTaskId>0 THEN IPT.InspectionOffset
		WHEN @UpdateAdvancedSchedulingLogic=0 AND (PT.InspectionTaskTypeId>0 OR PT.Scheduling_Group_Id>0) THEN PT.InspectionOffset
		ELSE IPT.InspectionOffset END
	END,

/*null for non-planning task*/
IPT.Scheduling_Group_Id=CASE IPT.Planning_Task 
	WHEN 0 THEN NULL
	ELSE
		CASE WHEN IPT.SchedulingTaskId>0 THEN IPT.Scheduling_Group_Id
		WHEN @UpdateAdvancedSchedulingLogic=0 AND (PT.InspectionTaskTypeId>0 OR PT.Scheduling_Group_Id>0) THEN PT.Scheduling_Group_Id
		ELSE IPT.Scheduling_Group_Id END
	END,

/*null for non-planning task*/
IPT.Scheduling_Group_Counter=CASE IPT.Planning_Task 
	WHEN 0 THEN NULL
	ELSE
		CASE WHEN IPT.SchedulingTaskId>0 THEN IPT.Scheduling_Group_Counter
		WHEN @UpdateAdvancedSchedulingLogic=0 AND (PT.InspectionTaskTypeId>0 OR PT.Scheduling_Group_Id>0) THEN PT.Scheduling_Group_Counter
		ELSE IPT.Scheduling_Group_Counter END
	END,
IPT.QUOMId=CASE WHEN IPT.SchedulingTaskId>0 THEN IPT.QUOMId
		WHEN @UpdateAdvancedSchedulingLogic=0 AND (PT.InspectionTaskTypeId>0 OR PT.Scheduling_Group_Id>0) THEN PT.UsageQUOMId
		ELSE IPT.QUOMId END,
IPT.[First]=CASE WHEN IPT.SchedulingTaskId>0 THEN IPT.[First]
		WHEN @UpdateAdvancedSchedulingLogic=0 AND (PT.InspectionTaskTypeId>0 OR PT.Scheduling_Group_Id>0) THEN PT.[First]
		ELSE IPT.[First] END,
IPT.Frequency=CASE WHEN IPT.SchedulingTaskId>0 THEN IPT.Frequency
		WHEN @UpdateAdvancedSchedulingLogic=0 AND (PT.InspectionTaskTypeId>0 OR PT.Scheduling_Group_Id>0) THEN PT.Frequency
		ELSE IPT.Frequency END,	
IPT.Final=CASE WHEN IPT.SchedulingTaskId>0 THEN IPT.Final
		WHEN @UpdateAdvancedSchedulingLogic=0 AND (PT.InspectionTaskTypeId>0 OR PT.Scheduling_Group_Id>0) THEN PT.Final
		ELSE IPT.Final END,
		
/*null for non-planning task*/
IPT.SchedulingTaskId=NULLIF(CAST(IPT.Planning_Task AS int),0)*IPT.SchedulingTaskId,

IPT.QtyVolume=CASE WHEN IPT.Consumable=1 THEN IPT.QtyVolume ELSE 0 END,
IPT.PercentTopUp=CASE WHEN IPT.Consumable=1 THEN IPT.PercentTopUp ELSE 0 END,
IPT.UnitPrice=CASE WHEN IPT.Consumable=1 THEN IPT.UnitPrice ELSE 0 END,
IPT.PartsCost=CASE WHEN IPT.Consumable=1 THEN dbo.CONSUMABLE_PART_PRICE_F(QtyVolume,UnitPrice,PercentTopUp) ELSE IPT.PartsCost END,
IPT.Task_Header_Id=TH.Task_Header_Id,
IPT.Last_Change_Usage =CASE WHEN IPT.QUOMId IS NULL /*If QUOMId is null Last_Change_Usage was set to 0*/
							THEN CAST(IPT.Last_Change_Date AS float) - CAST(EP.StartDate as float)
							ELSE IPT.Last_Change_Usage END,
IPT.PartId=CASE WHEN IPT.RotableId>0 THEN NULL ELSE PartId END
FROM
TASK_HEADER th 
	INNER JOIN
tblComponentCodes cc 
	ON th.Component_Code = cc.Code 
	INNER JOIN
tblApplicationCodes ac 
	ON th.Application_Code = ac.Code 
	INNER JOIN
tblTaskTypes tt 
	ON th.Task_Type = tt.Code 
	INNER JOIN
tblModifierCodes mc 
	ON th.Modifier_Code = mc.Code 
	INNER JOIN
#z_I_PROJECTED_TASKS IPT 
	ON cc.ComponentCodeID = IPT.ComponentCodeID AND AC.ApplicationCodeID = IPT.ApplicationCodeID AND 
	tt.TaskTypeID = IPT.TaskTypeID AND mc.ModifierID = IPT.ModifierID 
	INNER JOIN 
tblEqpPlans EP 
	ON IPT.EqpPlanId = EP.EqpPlanId
	LEFT JOIN
(SELECT EqpPlanId,StartUsageQUOMId,StartUsage FROM tblEqpPlanStartUsages 
WHERE EqpPlanId IN(SELECT EqpPlanId FROM #z_I_PROJECTED_TASKS WHERE EqpPlanId>0) ) EPSU
	ON IPT.EqpPlanId=EPSU.EqpPlanId AND IPT.QUOMId=EPSU.StartUsageQUOMId
	/*VV E799*/
	LEFT JOIN
tblProjTasks PT
	ON IPT.ProjTaskId=PT.ProjTaskId

/*VV E799 Moved this checks to check the data after scheduling groups are re-set*/
CREATE TABLE #z_ProjTasks(ProjTaskId int,EqpProjId int,Scheduling_Group_Id int,
QUOMId int,Schedule_Type_Id int,Scheduling_Group_Counter int,InspectionTaskTypeId int,
TaskTypeId int,Scheduling_Group_Type int PRIMARY KEY(ProjTaskId,EqpProjId))

INSERT INTO #z_ProjTasks(ProjTaskId,EqpProjId,Scheduling_Group_Id,
QUOMId,Schedule_Type_Id,Scheduling_Group_Counter,InspectionTaskTypeId,TaskTypeId,Scheduling_Group_Type)

SELECT PT.ProjTaskId,PT.EqpProjId,PT.Scheduling_Group_Id,PT.UsageQUOMId AS QUOMId,
PT.Schedule_Type_Id,PT.Scheduling_Group_Counter,PT.InspectionTaskTypeId,PT.TaskTypeId,
PTSG.Scheduling_Group_Type
FROM
tblProjTasks PT
	INNER JOIN
(SELECT DISTINCT EqpProjId FROM #z_I_PROJECTED_TASKS WHERE EqpProjId>0 AND EqpProjId<>@EqpProjIdTo
AND Inactive_Task=0) EPR
	ON PT.EqpProjId=EPR.EqpProjId
	LEFT JOIN
PROJ_TASK_SCHEDULING_GROUP PTSG
	ON PT.Scheduling_Group_Id=PTSG.Scheduling_Group_Id
	LEFT JOIN
#z_I_PROJECTED_TASKS IPT
	ON PT.ProjTaskId=IPT.ProjTaskId
WHERE (IPT.ProjTaskId IS NULL) 
AND (PT.Scheduling_Group_Id>0 OR PT.InspectionTaskTypeId>0)

--All tasks in the sibiling group shall have the same UOM.
INSERT INTO #z_Message(Line_No,ErrorDescription,ImportRecord)
SELECT IPT.Line_No,' All tasks in Sibiling Group shall have the same UOM;',
CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,/*VV E790*/Old_Ext_Id,Suppression_Group,Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
FROM IMPORT_PROJECTION  IP where IP.Line_No = IPT.Line_No AND IP.Import_File_Name=@ImportFileName FOR XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs')) END AS ImportRecord
FROM
#z_I_PROJECTED_TASKS IPT
	INNER JOIN
(SELECT EqpProjId,Scheduling_Group_Id 
FROM
	(SELECT IPT.EqpProjId,IPT.Scheduling_Group_Id,QUOMId
	FROM 
	#z_I_PROJECTED_TASKS IPT 
	WHERE IPT.Inactive_Task=0 AND 
	IPT.Scheduling_Group_Id>0 AND 
	IPT.Scheduling_Group_Type=1 AND 
	SchedulingGroupSubtypeId=1
		UNION ALL
	SELECT PT.EqpProjId,PT.Scheduling_Group_Id,QUOMId
	FROM 
	#z_ProjTasks PT
		INNER JOIN
	PROJ_TASK_SCHEDULING_GROUP PTSG 
		ON PT.Scheduling_Group_Id=PTSG.Scheduling_Group_Id
	WHERE PTSG.SchedulingGroupSubtypeId=1 AND PTSG.Scheduling_Group_Type=1) A
GROUP BY EqpProjId,Scheduling_Group_Id
HAVING COUNT(DISTINCT ISNULL(QUOMId,0))>1) B
	ON IPT.EqpProjId=B.EqpProjId AND IPT.Scheduling_Group_Id=B.Scheduling_Group_Id
WHERE IPT.Inactive_Task=0

--All tasks in the group shall have the same schedule type
INSERT INTO #z_Message(Line_No,ErrorDescription,ImportRecord)
SELECT IPT.Line_No,' All tasks in Scheduling Group shall have the same Schedule Type;',
CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,/*VV E790*/Old_Ext_Id,Suppression_Group,Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
FROM IMPORT_PROJECTION  IP where IP.Line_No = IPT.Line_No AND IP.Import_File_Name=@ImportFileName FOR XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs')) END AS ImportRecord

FROM
#z_I_PROJECTED_TASKS IPT
	INNER JOIN
(SELECT EqpProjId,Scheduling_Group_Id 
FROM
	(SELECT IPT.EqpProjId,IPT.Scheduling_Group_Id,
	CASE WHEN IPT.Schedule_Type_Id IN(1,3) THEN 1 ELSE 2 END AS Schedule_Type
	FROM 
	#z_I_PROJECTED_TASKS IPT 
	WHERE IPT.Inactive_Task=0 AND IPT.Scheduling_Group_Id>0
		UNION ALL
	SELECT PT.EqpProjId,PT.Scheduling_Group_Id,
	CASE WHEN PT.Schedule_Type_Id IN(1,3) THEN 1 ELSE 2 END AS Schedule_Type
	FROM 
	#z_ProjTasks PT
	WHERE PT.Scheduling_Group_Id>0
) A
GROUP BY EqpProjId,Scheduling_Group_Id
HAVING COUNT(DISTINCT Schedule_Type)>1) B
	ON IPT.EqpProjId=B.EqpProjId AND IPT.Scheduling_Group_Id=B.Scheduling_Group_Id
WHERE IPT.Inactive_Task=0

--Task priority is not set
INSERT INTO #z_Message(Line_No,ErrorDescription,ImportRecord)
SELECT IPT.Line_No,' Task priority is not set;',
CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,/*VV E790*/Old_Ext_Id,Suppression_Group,Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
FROM IMPORT_PROJECTION  IP where IP.Line_No = IPT.Line_No AND IP.Import_File_Name=@ImportFileName FOR XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs')) END AS ImportRecord

FROM
#z_I_PROJECTED_TASKS IPT
WHERE IPT.Inactive_Task=0 AND IPT.Scheduling_Group_Id>0 AND ISNULL(IPT.Scheduling_Group_Counter, -1 ) < 0

--There are duplicate Task Priority in Depnedency Group 
INSERT INTO #z_Message(Line_No,ErrorDescription,ImportRecord)
SELECT IPT.Line_No,' There are duplicate Task Priority in Depenedency Group;',
CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,/*VV E790*/Old_Ext_Id,Suppression_Group,Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
FROM IMPORT_PROJECTION  IP where IP.Line_No = IPT.Line_No AND IP.Import_File_Name=@ImportFileName FOR XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs')) END AS ImportRecord

FROM
#z_I_PROJECTED_TASKS IPT
	INNER JOIN
(SELECT EqpProjId,Scheduling_Group_Id,Scheduling_Group_Counter
FROM
	(SELECT IPT.EqpProjId,IPT.Scheduling_Group_Id,IPT.Scheduling_Group_Counter
	FROM 
	#z_I_PROJECTED_TASKS IPT 
	WHERE IPT.Inactive_Task=0 AND IPT.Scheduling_Group_Id>0 AND IPT.Scheduling_Group_Type=2
	GROUP BY IPT.EqpProjId,IPT.Scheduling_Group_Id,IPT.Scheduling_Group_Counter,IPT.PTGroupMin
		UNION ALL
	SELECT PT.EqpProjId,PT.Scheduling_Group_Id,PT.Scheduling_Group_Counter
	FROM 
	#z_ProjTasks PT
	WHERE PT.Scheduling_Group_Id>0 AND PT.Scheduling_Group_Type=2
) A
GROUP BY EqpProjId,Scheduling_Group_Id,Scheduling_Group_Counter
HAVING COUNT(Scheduling_Group_Id)>1) B
	ON IPT.EqpProjId=B.EqpProjId AND IPT.Scheduling_Group_Id=B.Scheduling_Group_Id AND IPT.Scheduling_Group_Counter=B.Scheduling_Group_Counter
WHERE IPT.Inactive_Task=0

--Inspection Logic

--The Task Type selected for inspection cannot be the Task Type of another "Inspection Logic Task"

INSERT INTO #z_Message(Line_No,ErrorDescription,ImportRecord)
SELECT IPT.Line_No,' The Task Type selected for Inspection cannot be the Task Type of another "Inspection Logic Task";',
CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,/*VV E790*/Old_Ext_Id,Suppression_Group,Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
FROM IMPORT_PROJECTION  IP where IP.Line_No = IPT.Line_No AND IP.Import_File_Name=@ImportFileName FOR XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs')) END AS ImportRecord

FROM
#z_I_PROJECTED_TASKS IPT
	INNER JOIN
(SELECT EqpProjId,TaskTypeId FROM #z_ProjTasks WHERE InspectionTaskTypeId>0) PT
	ON IPT.EqpProjId=PT.EqpProjId AND IPT.InspectionTaskTypeId=PT.TaskTypeId
WHERE IPT.Inactive_Task=0

DROP TABLE #z_ProjTasks

INSERT INTO #z_Message(Line_No,ErrorDescription,ImportRecord)
SELECT DISTINCT IPT.Line_No,' The Task Type selected for Inspection cannot be the Task Type of another "Inspection Logic Task";',
CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,/*VV E790*/Old_Ext_Id,Suppression_Group,Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
FROM IMPORT_PROJECTION  IP where IP.Line_No = IPT.Line_No AND IP.Import_File_Name=@ImportFileName FOR XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs')) END AS ImportRecord

FROM
#z_I_PROJECTED_TASKS IPT
	INNER JOIN
#z_I_PROJECTED_TASKS PT
	ON IPT.Inactive_Task=0 AND PT.Inactive_Task=0 AND
	   IPT.EqpProjId=PT.EqpProjId AND 
	   IPT.InspectionTaskTypeId=PT.TaskTypeId AND
	   IPT.PTGroupMin<>PT.PTGroupMin
WHERE PT.InspectionTaskTypeId>0

--The Task Type selected for inspection cannot be the same as the Task type of the task
INSERT INTO #z_Message(Line_No,ErrorDescription,ImportRecord)
SELECT IPT.Line_No,' The Task Type selected for Inspection cannot be the same as the Task Type of the task;',
CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,/*VV E790*/Old_Ext_Id,Suppression_Group,Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
FROM IMPORT_PROJECTION  IP where IP.Line_No = IPT.Line_No AND IP.Import_File_Name=@ImportFileName FOR XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs')) END AS ImportRecord

FROM #z_I_PROJECTED_TASKS IPT WHERE IPT.Inactive_Task=0 AND IPT.InspectionTaskTypeId=IPT.TaskTypeId   

--The Task Type selected for inspection cannot be Unassigned
INSERT INTO #z_Message(Line_No,ErrorDescription,ImportRecord)
SELECT IPT.Line_No,' The Task Type selected for Inspection cannot be Unassigned;',
CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,/*VV E790*/Old_Ext_Id,Suppression_Group,Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
FROM IMPORT_PROJECTION  IP where IP.Line_No = IPT.Line_No AND IP.Import_File_Name=@ImportFileName FOR XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs')) END AS ImportRecord

FROM #z_I_PROJECTED_TASKS IPT WHERE IPT.Inactive_Task=0 AND IPT.Inspection_Logic_Task_Type='UN'  

--The scheduling type must always be LAST PERFORMED for Inspection Logic
INSERT INTO #z_Message(Line_No,ErrorDescription,ImportRecord)
SELECT IPT.Line_No,' The Scheduling Type must always be LAST PERFORMED for Inspection Logic;',
CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,/*VV E790*/Old_Ext_Id,Suppression_Group,Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
FROM IMPORT_PROJECTION  IP where IP.Line_No = IPT.Line_No AND IP.Import_File_Name=@ImportFileName FOR XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs')) END AS ImportRecord

FROM #z_I_PROJECTED_TASKS IPT WHERE 
IPT.Inactive_Task=0 AND IPT.InspectionTaskTypeId>0 AND IPT.Schedule_Type_Id IN(2,4)  

--Check the other business rules
INSERT INTO #z_Message(Line_No,ErrorDescription,ImportRecord)
SELECT IPT.Line_No,
[dbo].[PROJ_TASK_BUSINESS_RULES_F]
(IPT.EqpProjId,
NULL,/*@ComponentCodeId int, DO NOT CHECK*/
IPT.ModifierId,
IPT.TaskTypeId,
IPT.ApplicationCodeId,	
IPT.Schedule_Type_Id, 
IPT.Scheduling_Group_Id, 
IPT.Scheduling_Group_Counter, 
IPT.QUOMId,/*@usageQUOMId int,*/
-1, /*@ProjTaskId int, DO NOT CHECK*/
IPT.Last_Change_Date,
IPT.Last_Change_Usage,
NULL ,/*InspectionTaskTypeId int, DO NOT CHECK*/
0,/*@InspectionOffset float,* DO NOT CHECK*/
Planning_Task,
NULL,/*@ParentTaskId int, DO NOT CHECK*/
Frequency,
EP.StartDate,
0/*@CheckGroup bit DO NOT CHECK*/,
''/*@ExternalIdentifier do not check*/) AS ErrorDescription,
CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,/*VV E790*/Old_Ext_Id,Suppression_Group,Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
FROM IMPORT_PROJECTION  IP where IP.Line_No = IPT.Line_No AND IP.Import_File_Name=@ImportFileName FOR XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs')) END AS ImportRecord

FROM
#z_I_PROJECTED_TASKS IPT
	INNER JOIN
(SELECT PTGroupMin FROM #z_I_PROJECTED_TASKS GROUP BY PTGroupMin) A
	ON IPT.Line_No=A.PTGroupMin
	INNER JOIN
tblEqpPlans EP
	ON IPT.EqpPlanId=EP.EqpPlanId


IF EXISTS(SELECT Line_No FROM #z_Message WHERE ErrorDescription<>'')
BEGIN

	INSERT INTO IMPORT_ERROR(ImportFileName,Line_No,ErrorDescription,ImportErrorTypeId,LastModDate,ImportRecord,ImportSourceId)
	SELECT @ImportFileName AS ImportFileName,CASE WHEN @InterfaceSource = 0 THEN Line_No END,ErrorDescription, @ErrorTypeBusRules AS ImportErrorTypeId,
	GETDate() AS LastModDate,CONVERT(VARCHAR(MAX),ImportRecord),@InterfaceSource
	FROM #z_Message WHERE ErrorDescription<>''

	DELETE IPT FROM
	#z_I_PROJECTED_TASKS IPT
		INNER JOIN
	#z_Message M
		ON IPT.PTGroupMin=M.Line_No
	WHERE M.ErrorDescription<>''

	IF NOT EXISTS(SELECT * FROM #z_I_PROJECTED_TASKS)
	BEGIN
		GOTO END_IMPORT
	END

END

DROP TABLE #z_Message

IF NOT EXISTS(SELECT * FROM #z_I_PROJECTED_TASKS)
BEGIN
	GOTO END_IMPORT
END


--Delete projected tasks

SET @ProjTaskId=''

IF EXISTS(SELECT ProjTaskId FROM #z_I_PROJECTED_TASKS WHERE Inactive_Task=1 AND ProjTaskId>0)
BEGIN

	SELECT @ProjTaskId = (SELECT CAST(ProjTaskId as varchar)+','
	FROM #z_I_PROJECTED_TASKS WHERE Inactive_Task=1 AND ProjTaskId>0
	GROUP BY ProjTaskId
		 FOR XML PATH('') )

	SET @ProjTaskId=ISNULL(@ProjTaskId,'')

	SET XACT_ABORT ON
	BEGIN TRANSACTION
	
	EXEC TASK_DELETE_MULTI_EQP @eqpPlanID='',@EqpProjHeaderId =NULL,@ProjTaskHeaderId =NULL, @forceDelete=1,@ProjTaskId=@ProjTaskId,@CheckRules=0

	-- DELETE SCHEDULING TASK
	IF EXISTS(SELECT ProjTaskId FROM #z_I_PROJECTED_TASKS WHERE Inactive_Task=1 AND SchedulingTaskId>0)
	BEGIN

		SET XACT_ABORT ON

		DELETE CAD FROM 
		COST_ALLOCATION_DETAIL CAD 
			INNER JOIN 
		COST_ALLOCATION CA 
			ON CA.Cost_Allocation_id = CAD.Cost_Allocation_id
			INNER JOIN
		#z_I_PROJECTED_TASKS IPT
			ON CA.Scheduling_Task_Id=IPT.SchedulingTaskId
		WHERE IPT.Inactive_Task=1
		
		DELETE CA FROM
		COST_ALLOCATION CA
			INNER JOIN
		#z_I_PROJECTED_TASKS IPT
			ON CA.Scheduling_Task_Id=IPT.SchedulingTaskId
		WHERE IPT.Inactive_Task=1

		DELETE ST FROM
		SCHEDULING_TASK ST
			INNER JOIN
		#z_I_PROJECTED_TASKS IPT
			ON ST.SchedulingTaskId=IPT.SchedulingTaskId
		WHERE IPT.Inactive_Task=1

	END

	COMMIT TRANSACTION
END

DELETE #z_I_PROJECTED_TASKS WHERE Inactive_Task=1

--Delete the tasks which are not in the file
IF @EqpProjIdTo>0 AND EXISTS(SELECT PT.ProjTaskId FROM 
				tblProjTasks PT
					LEFT JOIN
				#z_I_PROJECTED_TASKS IPT
					ON PT.ProjTaskId=IPT.ProjTaskId
					LEFT JOIN
				#z_DONOTDELETE D
					ON PT.ProjTaskId=D.ProjTaskId
				WHERE PT.EqpProjId=@EqpProjIdTo 
				AND IPT.ProjTaskId IS NULL AND D.ProjTaskId IS NULL)
BEGIN
	SET @ProjTaskId=''

	SELECT @ProjTaskId = (SELECT CAST(PT.ProjTaskId as varchar)+',' FROM
	tblProjTasks PT
		LEFT JOIN
	#z_I_PROJECTED_TASKS IPT
		ON PT.ProjTaskId=IPT.ProjTaskId
		LEFT JOIN
	#z_DONOTDELETE D
		ON PT.ProjTaskId=D.ProjTaskId
	WHERE PT.EqpProjId=@EqpProjIdTo 
	AND IPT.ProjTaskId IS NULL AND D.ProjTaskId IS NULL
	GROUP BY PT.ProjTaskId
		 FOR XML PATH('') )

	SET @ProjTaskId=ISNULL(@ProjTaskId,'')

	EXEC TASK_DELETE_MULTI_EQP @eqpPlanID='',@EqpProjHeaderId =NULL,@ProjTaskHeaderId =NULL,@forceDelete=1,@ProjTaskId=@ProjTaskId

END



IF (SELECT COUNT(*) FROM #z_I_PROJECTED_TASKS)=0 
BEGIN
	GOTO END_IMPORT
	RETURN
END

--Add/Update Scheduling tasks
IF EXISTS(SELECT SchedulingTaskId FROM #z_I_PROJECTED_TASKS WHERE Inactive_Task=0 AND SchedulingTaskId>0)
BEGIN
	UPDATE SCHEDULING_TASK SET  
	QUOMId = IPT.QUOMId,            
	Interval = IPT.Frequency, 	
	NextOccurrence = 
	CASE 
	WHEN @ApplySpecialNextOccToIgnoreRules = 1 THEN
		CASE 
		WHEN ISNULL(IPT.Last_Occurrence,0) > /*@PrevSTLastOccurrence*/
				ISNULL(ISNULL(CASE 
							  WHEN NULLIF(ST.LastOccurrence,0) IS NULL AND ST.LastOccurrenceDate IS NOT NULL 
							  THEN  dbo.GET_USAGE_FROM_DATE_NO_CHECK_TERM_F(IPT.EqpProjId,ST.QuomId, ST.LastOccurrenceDate) 
							  ELSE ST.LastOccurrence 
							  END,0),0) 
		THEN NULL 
		ELSE IPT.Next_Occurrence END
	ELSE IPT.Next_Occurrence 
	END, 
	NextOccDate = 
		CASE 
		WHEN @ApplySpecialNextOccToIgnoreRules = 1 THEN 
			CASE 
			WHEN ISNULL(IPT.Last_Occurrence,0) > /*@PrevSTLastOccurrence*/
				 ISNULL(ISNULL(CASE 
							   WHEN NULLIF(ST.LastOccurrence,0) IS NULL AND ST.LastOccurrenceDate IS NOT NULL 
							   THEN  dbo.GET_USAGE_FROM_DATE_NO_CHECK_TERM_F(IPT.EqpProjId,ST.QuomId, ST.LastOccurrenceDate) 
							   ELSE ST.LastOccurrence 
							   END,0),0) 
			THEN NULL 
			ELSE IPT.Next_Occ_Date END
		ELSE IPT.Next_Occ_Date
		END, 
	
	NextOccurrenceToIgnore = 
		CASE 
		WHEN @ApplySpecialNextOccToIgnoreRules = 1 THEN 
			CASE 
			WHEN ISNULL(IPT.Last_Occurrence,0) > /*@PrevSTLastOccurrence*/
				ISNULL(ISNULL(CASE 
							  WHEN NULLIF(ST.LastOccurrence,0) IS NULL AND ST.LastOccurrenceDate IS NOT NULL 
							  THEN  dbo.GET_USAGE_FROM_DATE_NO_CHECK_TERM_F(IPT.EqpProjId,ST.QuomId, ST.LastOccurrenceDate) 
							  ELSE ST.LastOccurrence 
							  END,0),0) 
			THEN IPT.Next_Occurrence 
			ELSE NULL END
		ELSE NULL 
		END, 
	NextOccDateToIgnore = 
		CASE 
		WHEN @ApplySpecialNextOccToIgnoreRules = 1 THEN
			CASE 
			WHEN ISNULL(IPT.Last_Occurrence,0) > /*@PrevSTLastOccurrence*/
				ISNULL(ISNULL(CASE 
							  WHEN NULLIF(ST.LastOccurrence,0) IS NULL AND ST.LastOccurrenceDate IS NOT NULL 
							  THEN  dbo.GET_USAGE_FROM_DATE_NO_CHECK_TERM_F(IPT.EqpProjId,ST.QuomId, ST.LastOccurrenceDate) 
							  ELSE ST.LastOccurrence 
							  END,0),0) 
			THEN IPT.Next_Occ_Date 
			ELSE NULL END 
		ELSE NULL
	END,
	ERPComponentCode = IPT.ERP_Component_Code, 
	ERPModifierCode = IPT.ERP_Modifier_Code, 
	ERPSchedulingTask = IPT.ERP_Scheduling_Task,
	/*VV #2370*/
	LastScheduled = CASE WHEN IPT.Last_Occ_Date IS NULL THEN ST.LastScheduled 
						 WHEN ISNULL(ST.LastOccurrenceDate,CAST(0 AS datetime)) < IPT.Last_Occ_Date THEN IPT.Last_Scheduled
						 ELSE ST.LastScheduled END, 
						 
	LastScheduledDate =CASE WHEN IPT.Last_Occ_Date IS NULL THEN ST.LastScheduledDate 
						 WHEN ISNULL(ST.LastOccurrenceDate,CAST(0 AS datetime)) < IPT.Last_Occ_Date THEN IPT.Last_Sched_Date
						 ELSE ST.LastScheduledDate END,
	
	LastOccurrence =IPT.Last_Occurrence, 
	LastOccurrenceDate =IPT.Last_Occ_Date,
	LastModDate = @TodaysDate
	FROM
	#z_I_PROJECTED_TASKS IPT
		INNER JOIN
	SCHEDULING_TASK ST
		ON IPT.SchedulingTaskId=ST.SchedulingTaskId
	WHERE IPT.Inactive_Task=0
END

IF EXISTS(SELECT External_Identifier FROM #z_I_PROJECTED_TASKS IPT 
			WHERE IPT.Inactive_Task=0 AND ISNULL(External_Identifier,'') IS NOT NULL
			AND IPT.Scheduling_Task IS NOT NULL
			AND IPT.Projection_Type_Id=@TypeCur
			AND IPT.SchedulingTaskId IS NULL)
BEGIN
	INSERT INTO SCHEDULING_TASK
	  ( 
		EquipmentNo, 
		ComponentCodeId, 
		ModifierCodeId, 
		SchedulingTask, 
		EqpPlanId, 
		Model, 
		SerialNo, 
		QUOMId, 
		Interval, 
		LastOccurrence, 
		LastOccurrenceDate, 
		LastScheduled, 
		LastScheduledDate,
		NextOccurrence,
		NextOccDate, 
		NextOccurrenceToIgnore, 
		NextOccDateToIgnore,
		System_Source_ID,
		ExternalIdentifier,
		ERPComponentCode,
		ERPModifierCode,
		ERPSchedulingTask
	)
	SELECT DISTINCT   
	IPT.Equipment_No, 
	IPT.ComponentCodeId, 
	IPT.ModifierId, 
	IPT.Scheduling_Task, 
	IPT.EqpPlanId, 
	IPT.Model, 
	IPT.SerialNumber, 
	IPT.QUOMId, 
	IPT.Frequency, 
	IPT.Last_Occurrence, 
	Last_Occ_Date, 
	IPT.Last_Scheduled, 
	IPT.Last_Sched_Date,
	IPT.Next_Occurrence,
	IPT.Next_Occ_Date, 
	NULL,--@NextOccurrenceToIgnore, 
	NULL,--@NextOccDateToIgnore,
	IPT.SystemSourceID,
	IPT.External_Identifier,
	IPT.ERP_Component_Code, 
	IPT.ERP_Modifier_Code, 
	IPT.ERP_Scheduling_Task
	FROM #z_I_PROJECTED_TASKS IPT 
	WHERE IPT.Inactive_Task=0 
	AND ISNULL(External_Identifier,'') IS NOT NULL
	AND IPT.Scheduling_Task IS NOT NULL
	AND IPT.Projection_Type_Id=@TypeCur
	AND IPT.SchedulingTaskId IS NULL

	UPDATE IPT SET IPT.SchedulingTaskId=ST.SchedulingTaskId
	FROM 
	SCHEDULING_TASK ST
		INNER JOIN
	#z_I_PROJECTED_TASKS IPT
		ON ST.ExternalIdentifier=IPT.External_Identifier
	WHERE IPT.Inactive_Task=0 AND IPT.SchedulingTaskId IS NULL
	AND IPT.Projection_Type_Id=@TypeCur
	
END

/*

Update the values from the linked SCHEDULING_TASK for the tasks where only the
scheduling task details need to be updated
*/ 
IF EXISTS(SELECT ProjTaskId FROM #z_I_PROJECTED_TASKS 
WHERE ProjTaskId>0 AND SchedulingTaskId>0 AND Update_Scheduling_Task_Only=1) 
BEGIN
	SET @ProjTaskId=''

	SELECT @ProjTaskId = (SELECT CAST(ProjTaskId AS varchar)+',' FROM
	#z_I_PROJECTED_TASKS WHERE ProjTaskId>0 AND SchedulingTaskId>0 AND Update_Scheduling_Task_Only=1
	GROUP BY ProjTaskId
		 FOR XML PATH('') )

	SET @ProjTaskId=ISNULL(@ProjTaskId,'')

	SET XACT_ABORT ON
	BEGIN TRANSACTION
		EXEC SCHEDULING_TASK_TO_PROJ_TASK_P @ProjTaskIdMany=@ProjTaskId
	COMMIT TRANSACTION

	DELETE #z_I_PROJECTED_TASKS WHERE Update_Scheduling_Task_Only=1

	IF (SELECT COUNT(*) FROM #z_I_PROJECTED_TASKS)=0 
	BEGIN
		GOTO END_IMPORT
		RETURN
	END
END

/*VV E799
If Amt setting UpdateAdvancedSchedulingLogic=1 strategy task import updates advanced scheduling logic
If Amt Setting UpdateAdvancedSchedulingLogic=0 the import checks if strategy task is linked to the scheduling task.
 If it is linked to a scheduling task then import updates the scheduling logic
If strategy task is not linked to the scheduling task then import does not update Advanced Scheduling Logic and Scheduling Details.

*/

-- Check if we need to update projected tasks

UPDATE IPT SET IPT.UpdateTask= CASE WHEN

				PT.ManufacturerId <>IPT.ManufacturerId OR 
				--#Enh:527 to choose external identifier to update strategy task codes or not
				PT.ModifierId<>IPT.ModifierId OR
				PT.ComponentCodeId<>IPT.ComponentCodeId OR
				PT.TaskTypeId<>IPT.TaskTypeId OR
				PT.ApplicationCodeId<>IPT.ApplicationCodeId OR
				
				PT.UsageQUOMId <> CASE WHEN PT.AutomaticUpdate=1 THEN PT.UsageQUOMId ELSE IPT.QUOMId END OR
				PT.Final <> IPT.Final OR
				PT.Last_Change_Usage <> IPT.Last_Change_Usage OR 
				PT.Last_Change_Date <> IPT.Last_Change_Date OR
				ISNULL(PT.Rotable_Part_Id,0) <> ISNULL(IPT.RotableId,0) OR
				ISNULL(PT.Group_Number,'') <> ISNULL(IPT.Group_Number,'') OR
				ISNULL(PT.Part_Id,0) <> ISNULL(IPT.PartId,0) OR
				PT.Planning_Task <> IPT.Planning_Task OR
				PT.Planning_Lead_Time <> IPT.Planning_Lead_Time OR	
				ISNULL(PT.SchedulingTaskId,0)<> ISNULL(IPT.SchedulingTaskId,0) OR
				ISNULL(PT.LastOcc,0)<>ISNULL(CASE WHEN PT.Schedule_Type_Id=IPT.Schedule_Type_Id THEN PT.LastOcc
						ELSE
							CASE WHEN @UseSchedulingSystemLastOcc = 1 AND IPT.SchedulingTaskId > 0 THEN
								CASE WHEN IPT.Schedule_Type_Id IN (@LastPerfUOM,@LastPerfDate) THEN PT.Ext_Last_Occ ELSE PT.Ext_Last_Sched_Occ END
							ELSE
								CASE WHEN IPT.Schedule_Type_Id IN (@LastPerfUOM,@LastPerfDate) THEN PT.AMT_WO_Last_Occ ELSE PT.AMT_Last_Sched_Occ END	
							END
						END,0) OR

				ISNULL(LastOccDate,0)<>ISNULL(CASE WHEN PT.Schedule_Type_Id=IPT.Schedule_Type_Id THEN PT.LastOccDate
							ELSE
								CASE WHEN @UseSchedulingSystemLastOcc = 1 AND IPT.SchedulingTaskId > 0 THEN
									CASE WHEN IPT.Schedule_Type_Id IN (@LastPerfUOM,@LastPerfDate) THEN PT.Ext_Last_Occ_Date ELSE PT.Ext_Last_Sched_Date END
								ELSE
									CASE WHEN IPT.Schedule_Type_Id IN (@LastPerfUOM,@LastPerfDate) THEN PT.AMT_WO_Last_Occ_Date ELSE PT.AMT_Last_Sched_Date END
								END
							END,0) OR
				PT.Schedule_Type_Id<>IPT.Schedule_Type_Id OR
				ISNULL(PT.Scheduling_Group_Id,0)<>ISNULL(IPT.Scheduling_Group_Id,0) OR
				ISNULL(PT.Scheduling_Group_Counter,-1)<>ISNULL(IPT.Scheduling_Group_Counter,-1) OR
				ISNULL(PT.Operational_Criticality_Id,0)<>ISNULL(IPT.Operational_Criticality_Id,0) OR 
				PT.Warranty_Period_Usage<>IPT.Warranty_Usage OR
				PT.Warranty_Period_Days<>IPT.Warranty_Days OR
				ISNULL(PT.Changeout_Guidelines,'')<>ISNULL(IPT.Changeout_Guidelines, '') OR
				ISNULL(PT.Task_Description,'')<>ISNULL(IPT.Task_Description, '') OR
				ISNULL(PT.InspectionTaskTypeId,0)<>ISNULL(IPT.InspectionTaskTypeId,0) OR 
				ISNULL(PT.InspectionOffset,0)<>ISNULL(IPT.InspectionOffset, 0) OR
				ISNULL(PT.ExternalIdentifier,'')<>ISNULL(IPT.External_Identifier,'') OR
				ISNULL(PT.PerformanceStrategyReason,'')<>ISNULL(IPT.PerformanceStrategyReason,'') OR
				ISNULL(PT.RCMComponentStructureId,0)<>ISNULL( CASE WHEN PT.Maintenance_Strategy_Id=IPT.Maintenance_Strategy_Id 
												 THEN PT.RCMComponentStructureId ELSE NULL END,0) OR
				ISNULL(PT.Maintenance_Strategy_Id,0)<>ISNULL(IPT.Maintenance_Strategy_Id, 0) OR
				/*VV E316*/	ISNULL(PT.PartRatingId,0)<>ISNULL(IPT.PartRatingId,0) OR
				ISNULL(PT.TagId,'')<>ISNULL(IPT.Tag_Id,'')
		THEN 1 ELSE 0 END,

IPT.UpdateOpt=CASE WHEN 
					PTO.Frequency<>CASE WHEN PT.AutomaticUpdate=0 THEN IPT.Frequency ELSE PT.Frequency END OR
					PTO.[First]<>IPT.[First]
				THEN 1 ELSE 0 END,
				
--#Enh:527 to choose external identifier to update strategy task codes or not
IPT.UpdateStrategyTaskCodes=CASE WHEN @UpdateStrategyTaskCodes =0 THEN 0 
								 WHEN PT.ModifierId<>IPT.ModifierId OR PT.ComponentCodeId<>IPT.ComponentCodeId OR PT.TaskTypeId<>IPT.TaskTypeId OR PT.ApplicationCodeId<>IPT.ApplicationCodeId THEN 1
								 ELSE 0 END,
/*VV E790*/	
IPT.UpdateExternalIdentifier=CASE WHEN ISNULL(@UpdateStrategyTaskCodes,0)=0 THEN 0
								  WHEN ISNULL(IPT.External_Identifier,'')='' THEN 0
								  WHEN ISNULL(PT.ExternalIdentifier,'')='' THEN 0
								  WHEN ISNULL(IPT.Old_Ext_Id,'')='' THEN 0
								  WHEN ISNULL(IPT.Old_Ext_Id,'')=ISNULL(IPT.External_Identifier,'') THEN 0
								  WHEN PT.ExternalIdentifier=IPT.Old_Ext_Id THEN 1
								  ELSE 0 END
FROM 
#z_I_PROJECTED_TASKS IPT
	INNER JOIN
tblProjTasks PT 
	ON IPT.ProjTaskId=PT.ProjTaskId
	INNER JOIN
tblProjTaskOpts PTO
	ON IPT.ProjTaskOptId=PTO.ProjTaskOptId
WHERE IPT.Inactive_Task=0 



--Identify proj Jobs to update

/*VV #3469 If there are is single job in AMT and in file set missing currency and 
job code from the strategy job*/
CREATE TABLE #z_JobCodeCurrency(ProjTaskOptId int,ProjTaskAmtId int,JobCodeId int,CurrencyId int 
PRIMARY KEY (ProjTaskOptId))

INSERT INTO #z_JobCodeCurrency(ProjTaskOptId,ProjTaskAmtId,JobCodeId,CurrencyId)
SELECT PTA.ProjTaskOptId,MIN(PTA.ProjTaskAmtId) AS ProjTaskAmtId,
MIN(PTA.JobCodeId) AS JobCodeId,MIN(PTA.CurrencyId) AS CurrencyId
FROM
#z_I_PROJECTED_TASKS IPT
	INNER JOIN
tblProjTaskAmts PTA
	ON IPT.ProjTaskOptId=PTA.ProjTaskOptId
GROUP BY PTA.ProjTaskOptId
HAVING (COUNT(PTA.ProjTaskAmtId)=1) AND
(MIN(IPT.JobCodeId) IS NULL OR MIN(IPT.CurrencyId) IS NULL)

IF(@@ROWCOUNT>0)
BEGIN
	UPDATE IPT SET IPT.JobCodeId=ISNULL(IPT.JobCodeId,J.JobCodeId),
	IPT.CurrencyId=ISNULL(IPT.CurrencyId,J.CurrencyId)
	FROM 
	#z_I_PROJECTED_TASKS IPT
		INNER JOIN
	#z_JobCodeCurrency J
		ON IPT.ProjTaskOptId=J.ProjTaskOptId
END

DROP TABLE #z_JobCodeCurrency

UPDATE IPT SET 
IPT.ProjTaskAmtId=PTA.ProjTaskAmtId,
/*VV #3469*/
IPT.Cost_Centre_Id =ISNULL(IPT.Cost_Centre_Id,PTA.Cost_Centre_Id),	
IPT.Work_Group_Id =ISNULL(IPT.Work_Group_Id,PTA.Work_Group_Id),
IPT.PartTypeId =ISNULL(IPT.PartTypeId,PTA.PartTypeId),
IPT.Health_Safety_Id =ISNULL(IPT.Health_Safety_Id,PTA.Health_Safety_Id),
IPT.Pricing_Date = CASE WHEN 
						IPT.PartsCost IS NULL 
                        AND IPT.LaborCost IS NULL 
                        AND IPT.MiscCost IS NULL 
                   THEN PTA.Pricing_Date ELSE IPT.Pricing_Date END,
IPT.PartsCost =ISNULL(IPT.PartsCost,PTA.PartsCost),
IPT.LaborCost =ISNULL(IPT.LaborCost,PTA.LaborCost),
IPT.MiscCost =ISNULL(IPT.MiscCost,PTA.MiscCost) ,
IPT.Labour_Hrs_Field =ISNULL(IPT.Labour_Hrs_Field,PTA.Labour_Hrs_Field) ,
IPT.LaborHours =ISNULL(IPT.LaborHours,PTA.LaborHours) ,
IPT.Labour_Activity_Id =ISNULL(IPT.Labour_Activity_Id,PTA.Labour_Activity_Id),
IPT.Duration =ISNULL(IPT.Duration,PTA.Duration) ,
IPT.Parts_Cost_Expense_ID =ISNULL(IPT.Parts_Cost_Expense_ID,PTA.Parts_Cost_Expense_ID),
IPT.Labour_Cost_Expense_ID =ISNULL(IPT.Labour_Cost_Expense_ID,PTA.Labour_Cost_Expense_ID),
IPT.Misc_Cost_Expense_ID =ISNULL(IPT.Misc_Cost_Expense_ID,PTA.Misc_Cost_Expense_ID),
IPT.Parts_EDC_ID =ISNULL(IPT.Parts_EDC_ID,PTA.Parts_EDC_ID),
IPT.Labour_EDC_ID =ISNULL(IPT.Labour_EDC_ID,PTA.Labour_EDC_ID),
IPT.Misc_EDC_ID =ISNULL(IPT.Misc_EDC_ID,PTA.Misc_EDC_ID),
IPT.Cost_Bearer_ID =ISNULL(IPT.Cost_Bearer_ID,PTA.Cost_Bearer_ID)

FROM 
#z_I_PROJECTED_TASKS IPT
	INNER JOIN
tblProjTaskAmts PTA
	ON IPT.ProjTaskOptId=PTA.ProjTaskOptId AND
	   ISNULL(IPT.JobCodeId,0)=ISNULL(PTA.JobCodeId,0) AND
	   IPT.CurrencyId=PTA.CurrencyId
	   


/*VV #3469*/	   
UPDATE IPT SET
IPT.PartsCost =ISNULL(IPT.PartsCost,0),
IPT.LaborCost =ISNULL(IPT.LaborCost,0),
IPT.MiscCost =ISNULL(IPT.MiscCost,0),
IPT.Labour_Hrs_Field =ISNULL(IPT.Labour_Hrs_Field,0),
IPT.LaborHours =ISNULL(IPT.LaborHours,0) ,
IPT.Duration =ISNULL(IPT.Duration,0),
IPT.CurrencyId=ISNULL(IPT.CurrencyId,@PrimaryCurrency),
/*VV E790*/
NewCostAllocationId= CASE 
					 WHEN(ISNULL(IPT.Standard_Job_Reference,'')<>'' OR IPT.Consumable=1) THEN NULL
					 WHEN ISNULL(IPT.UpdateExternalIdentifier,0)=0 THEN CA_Old.Cost_Allocation_Id
					 WHEN CA_Old.Cost_Allocation_Id>0 THEN ISNULL(CA.Cost_Allocation_Id,CA_Old.Cost_Allocation_Id)
					 ELSE NULL END
FROM 
#z_I_PROJECTED_TASKS IPT
	/*VV E790*/
	LEFT JOIN
COST_ALLOCATION CA
	ON IPT.External_Identifier=CA.Cost_Allocation_Ref
	AND IPT.UpdateExternalIdentifier=1
	AND CA.Proj_Task_Amt_Id IS NULL
	LEFT JOIN
tblProjTaskAmts PTA
	ON IPT.ProjTaskAmtId=PTA.ProjTaskAmtId
	LEFT JOIN
COST_ALLOCATION CA_Old
	ON PTA.ProjTaskAmtId=CA_Old.Proj_Task_Amt_Id
	

--Check if projTaskAmts need to be updated
UPDATE IPT SET IPT.UpdateJob=CASE WHEN
	ISNULL(SJ.Std_Job_Ref,'')<>ISNULL(IPT.Standard_Job_Reference,'') OR 
	ISNULL(PTA.JobCodeId,0)<> ISNULL(CASE
							  /*If it is updated to be consumable, cost allocations will be deleted*/
							  /*Linked to Std Job*/
							  WHEN IPT.Standard_Job_Reference=SJ.Std_Job_Ref THEN PTA.JobCodeId
							  /*Linked to external cost allocation and this field is not updated by AMT*/
							  WHEN CA.Proj_Task_Amt_Id>0 AND SS.AMTSystemSource=0 AND CAC.JobCode=0 THEN PTA.JobCodeId
							  ELSE IPT.JobCodeId END,0) OR


	ISNULL(IPT.SiteId,0) <>ISNULL(PTA.PerformedAtSiteId, 0) OR
	ISNULL(IPT.PartTypeId,0)<>ISNULL(PTA.PartTypeId,0) OR
	ISNULL(IPT.LaborShare,0)<>ISNULL(PTA.LaborShare,0) OR
	PTA.CurrencyId <> CASE WHEN PT.AutomaticUpdate=1 THEN PTA.CurrencyId ELSE IPT.CurrencyId END OR
	

	PTA.PartsCost<>CASE WHEN PT.AutomaticUpdate=1 THEN PTA.PartsCost
					WHEN IPT.Projection_Type_Id IN(@TypeCur,@TypeAlt,@TypeCen) AND SJ.Std_Job_Ref=IPT.Standard_Job_Reference THEN PTA.PartsCost
					WHEN IPT.Consumable=1 THEN IPT.PartsCost
					WHEN CA.Proj_Task_Amt_Id>0 AND ISNULL(IPT.Standard_Job_Reference,'')='' THEN PTA.PartsCost
					ELSE IPT.PartsCost END OR
	PTA.LaborCost<>CASE WHEN PT.AutomaticUpdate=1 THEN PTA.LaborCost
					WHEN IPT.Projection_Type_Id IN(@TypeCur,@TypeAlt,@TypeCen) AND SJ.Std_Job_Ref=IPT.Standard_Job_Reference THEN PTA.LaborCost
					WHEN IPT.Consumable=1 THEN IPT.LaborCost /*If it is updated to be consumable, cost allocations will be deleted*/
					WHEN CA.Proj_Task_Amt_Id>0 AND ISNULL(IPT.Standard_Job_Reference,'')='' THEN PTA.LaborCost
					ELSE IPT.LaborCost END OR 
	PTA.MiscCost<>CASE WHEN PT.AutomaticUpdate=1 THEN PTA.MiscCost
					WHEN IPT.Projection_Type_Id IN(@TypeCur,@TypeAlt,@TypeCen) AND SJ.Std_Job_Ref=IPT.Standard_Job_Reference THEN PTA.MiscCost
					WHEN IPT.Consumable=1 THEN IPT.MiscCost /*If it is updated to be consumable, cost allocations will be deleted*/
					WHEN CA.Proj_Task_Amt_Id>0 AND ISNULL(IPT.Standard_Job_Reference,'')='' THEN PTA.MiscCost
					ELSE IPT.MiscCost END OR 
	PTA.LaborHours<>CASE WHEN PT.AutomaticUpdate=1 THEN PTA.LaborHours
					WHEN IPT.Projection_Type_Id IN(@TypeCur,@TypeAlt,@TypeCen) AND SJ.Std_Job_Ref=IPT.Standard_Job_Reference THEN PTA.LaborHours
					WHEN IPT.Consumable=1 THEN IPT.LaborHours /*If it is updated to be consumable, cost allocations will be deleted*/
					WHEN CA.Proj_Task_Amt_Id>0 AND ISNULL(IPT.Standard_Job_Reference,'')='' THEN PTA.LaborHours
					ELSE IPT.LaborHours END OR 
	PTA.Duration<>CASE WHEN PT.AutomaticUpdate=1 THEN PTA.Duration
					WHEN IPT.Projection_Type_Id IN(@TypeCur,@TypeAlt,@TypeCen) AND SJ.Std_Job_Ref=IPT.Standard_Job_Reference THEN PTA.Duration
					WHEN IPT.Consumable=1 THEN IPT.Duration /*If it is updated to be consumable, cost allocations will be deleted*/
					WHEN CA.Proj_Task_Amt_Id>0 AND ISNULL(IPT.Standard_Job_Reference,'')='' THEN PTA.Duration
					ELSE IPT.Duration END OR 

	
					
	ISNULL(PTA.Labour_Cost_Expense_Id,0)<>ISNULL(CASE
								/*If it is updated to be consumable, cost allocations will be deleted*/
							  /*Linked to external cost allocation and this field is not updated by AMT*/
							  WHEN CA.Proj_Task_Amt_Id>0 AND SS.AMTSystemSource=0 AND CAC.LabourCostExpense=0 THEN PTA.Labour_Cost_Expense_Id
							  ELSE IPT.Labour_Cost_Expense_Id END,0) OR

	ISNULL(PTA.Misc_Cost_Expense_Id,0)<>ISNULL(CASE
								/*If it is updated to be consumable, cost allocations will be deleted*/
							  /*Linked to external cost allocation and this field is not updated by AMT*/
							  WHEN CA.Proj_Task_Amt_Id>0 AND SS.AMTSystemSource=0 AND CAC.MiscCostExpense=0 THEN PTA.Misc_Cost_Expense_Id
							  ELSE IPT.Misc_Cost_Expense_Id END,0) OR

	ISNULL(PTA.Parts_Cost_Expense_Id,0)<>ISNULL(CASE
								/*If it is updated to be consumable, cost allocations will be deleted*/
							  /*Linked to external cost allocation and this field is not updated by AMT*/
							  WHEN CA.Proj_Task_Amt_Id>0 AND SS.AMTSystemSource=0 AND CAC.PartsCostExpense=0 THEN PTA.Parts_Cost_Expense_Id
							  ELSE IPT.Parts_Cost_Expense_Id END,0) OR


	PTA.Pricing_Date<> CASE WHEN PT.AutomaticUpdate=1 THEN PTA.Pricing_Date ELSE IPT.Pricing_Date END OR

	ISNULL(PTA.Cost_Bearer_ID,0)<>ISNULL(CASE
								/*If it is updated to be consumable, cost allocations will be deleted*/
							  /*Linked to external cost allocation and this field is not updated by AMT*/
							  WHEN CA.Proj_Task_Amt_Id>0 AND SS.AMTSystemSource=0 AND CAC.CostBearer=0 THEN PTA.Cost_Bearer_ID
							  ELSE IPT.Cost_Bearer_ID END,0) OR

	ISNULL(PTA.labour_Activity_Id,0)<>ISNULL(CASE
								/*If it is updated to be consumable, cost allocations will be deleted*/
							  /*Linked to external cost allocation and this field is not updated by AMT*/
							  WHEN CA.Proj_Task_Amt_Id>0 AND SS.AMTSystemSource=0 AND CAC.LabourActivity=0 THEN PTA.labour_Activity_Id
							  ELSE IPT.labour_Activity_Id END,0) OR

	IPT.Crane_Cost<>PTA.Crane_Cost OR
	IPT.Pct_Freight<>PTA.Pct_Freight OR
	IPT.Avg_Daily_Work_Hrs<>PTA.Avg_Daily_Work_Hrs OR
	IPT.Avg_No_People<>PTA.Avg_No_People OR
	IPT.Avg_Travel_Hrs<>PTA.Avg_Travel_Hrs OR
	IPT.Travel_Distance<>PTA.Travel_Distance OR
	IPT.Travel_Recovery_Rate_L<>PTA.Travel_Recovery_Rate_L OR
	IPT.Travel_Recovery_Rate_V<>PTA.Travel_Recovery_Rate_V OR
	IPT.Misc_Trip_Cost<>PTA.Misc_Trip_Cost OR
	IPT.Labour_Hrs_Field<>PTA.Labour_Hrs_Field OR
	ISNULL(IPT.Parts_EDC_ID,0)<>ISNULL(PTA.Parts_EDC_ID,0) OR 
	ISNULL(IPT.Labour_EDC_ID,0)<> ISNULL(PTA.Labour_EDC_ID,0) OR
	ISNULL(IPT.Misc_EDC_ID,0)<> ISNULL(PTA.Misc_EDC_ID,0) OR
	ISNULL(PTA.Cost_Centre_Id,0)<>ISNULL(CASE
								/*If it is updated to be consumable, cost allocations will be deleted*/
							  /*Linked to external cost allocation and this field is not updated by AMT*/
							  WHEN CA.Proj_Task_Amt_Id>0 AND SS.AMTSystemSource=0 AND CAC.CostCentre=0 THEN PTA.Cost_Centre_Id
							  ELSE IPT.Cost_Centre_Id END,0) OR

	ISNULL(PTA.Work_Group_Id,0)<>ISNULL(CASE
								/*If it is updated to be consumable, cost allocations will be deleted*/
							  /*Linked to external cost allocation and this field is not updated by AMT*/
							  WHEN CA.Proj_Task_Amt_Id>0 AND SS.AMTSystemSource=0 AND CAC.WorkGroup=0 THEN PTA.Work_Group_Id
							  ELSE IPT.Work_Group_Id END,0) OR

	ISNULL(IPT.Health_Safety_Id,0)<>ISNULL(PTA.Health_Safety_Id,0) OR	
	IPT.Consumable<>PTA.Consumable OR 
	IPT.QtyVolume<>PTA.QtyVolume OR
	IPT.PercentTopUp<>PTA.PercentTopUp OR
	IPT.UnitPrice<>PTA.UnitPrice OR
	/*VV E790*/
	IPT.UpdateExternalIdentifier=1
	THEN 1 ELSE 0 END,
	IPT.PricedJobId=CASE WHEN IPT.Standard_Job_Reference=PTA.StdJobReference THEN PTA.PricedJobId ELSE NULL END, 
	IPT.JobCodeId= CASE WHEN IPT.Standard_Job_Reference=PTA.StdJobReference THEN PTA.JobCodeId
				WHEN CA.Proj_Task_Amt_Id>0 AND SS.AMTSystemSource=0 AND CAC.JobCode=0 THEN PTA.JobCodeId
				ELSE IPT.JobCodeId END,
	IPT.CurrencyId = CASE WHEN PT.AutomaticUpdate=1 THEN PTA.CurrencyId ELSE IPT.CurrencyId END,
	IPT.PartsCost=CASE WHEN PT.AutomaticUpdate=1 THEN PTA.PartsCost
					WHEN IPT.Projection_Type_Id IN(@TypeCur,@TypeAlt,@TypeCen) AND SJ.Std_Job_Ref=IPT.Standard_Job_Reference THEN PTA.PartsCost
					WHEN IPT.Consumable=1 THEN IPT.PartsCost
					WHEN CA.Proj_Task_Amt_Id>0 AND ISNULL(IPT.Standard_Job_Reference,'')='' THEN PTA.PartsCost
					ELSE IPT.PartsCost END,
	IPT.LaborCost=CASE WHEN PT.AutomaticUpdate=1 THEN PTA.LaborCost
					WHEN IPT.Projection_Type_Id IN(@TypeCur,@TypeAlt,@TypeCen) AND SJ.Std_Job_Ref=IPT.Standard_Job_Reference THEN PTA.LaborCost
					WHEN IPT.Consumable=1 THEN IPT.LaborCost
					WHEN CA.Proj_Task_Amt_Id>0 AND ISNULL(IPT.Standard_Job_Reference,'')='' THEN PTA.LaborCost
					ELSE IPT.LaborCost END, 
	IPT.MiscCost=CASE WHEN PT.AutomaticUpdate=1 THEN PTA.MiscCost
					WHEN IPT.Projection_Type_Id IN(@TypeCur,@TypeAlt,@TypeCen) AND SJ.Std_Job_Ref=IPT.Standard_Job_Reference THEN PTA.MiscCost
					WHEN IPT.Consumable=1 THEN IPT.MiscCost
					WHEN CA.Proj_Task_Amt_Id>0 AND ISNULL(IPT.Standard_Job_Reference,'')='' THEN PTA.MiscCost
					ELSE IPT.MiscCost END,

	IPT.LaborHours=CASE WHEN PT.AutomaticUpdate=1 THEN PTA.LaborHours
					WHEN IPT.Projection_Type_Id IN(@TypeCur,@TypeAlt,@TypeCen) AND SJ.Std_Job_Ref=IPT.Standard_Job_Reference THEN PTA.LaborHours
					WHEN IPT.Consumable=1 THEN IPT.LaborHours
					WHEN CA.Proj_Task_Amt_Id>0 AND ISNULL(IPT.Standard_Job_Reference,'')='' THEN PTA.LaborHours
					ELSE IPT.LaborHours END,
	IPT.Duration=CASE WHEN PT.AutomaticUpdate=1 THEN PTA.Duration
					WHEN IPT.Projection_Type_Id IN(@TypeCur,@TypeAlt,@TypeCen) AND SJ.Std_Job_Ref=IPT.Standard_Job_Reference THEN PTA.Duration
					WHEN IPT.Consumable=1 THEN IPT.Duration
					WHEN CA.Proj_Task_Amt_Id>0 AND ISNULL(IPT.Standard_Job_Reference,'')='' THEN PTA.Duration
					ELSE IPT.Duration END,

	IPT.Labour_Cost_Expense_Id=CASE
								/*If it is updated to be consumable, cost allocations will be deleted*/
							  /*Linked to external cost allocation and this field is not updated by AMT*/
							  WHEN CA.Proj_Task_Amt_Id>0 AND SS.AMTSystemSource=0 AND CAC.LabourCostExpense=0 THEN PTA.Labour_Cost_Expense_Id
							  ELSE IPT.Labour_Cost_Expense_Id END,

	IPT.Misc_Cost_Expense_Id=CASE
								/*If it is updated to be consumable, cost allocations will be deleted*/
							  /*Linked to external cost allocation and this field is not updated by AMT*/
							  WHEN CA.Proj_Task_Amt_Id>0 AND SS.AMTSystemSource=0 AND CAC.MiscCostExpense=0 THEN PTA.Misc_Cost_Expense_Id
							  ELSE IPT.Misc_Cost_Expense_Id END,

	IPT.Parts_Cost_Expense_Id=CASE
								/*If it is updated to be consumable, cost allocations will be deleted*/
							  /*Linked to external cost allocation and this field is not updated by AMT*/
							  WHEN CA.Proj_Task_Amt_Id>0 AND SS.AMTSystemSource=0 AND CAC.PartsCostExpense=0 THEN PTA.Parts_Cost_Expense_Id
							  ELSE IPT.Parts_Cost_Expense_Id END,


	IPT.Pricing_Date= CASE WHEN PT.AutomaticUpdate=1 THEN PTA.Pricing_Date ELSE IPT.Pricing_Date END,

	IPT.Cost_Bearer_ID=CASE
								/*If it is updated to be consumable, cost allocations will be deleted*/
							  /*Linked to external cost allocation and this field is not updated by AMT*/
							  WHEN CA.Proj_Task_Amt_Id>0 AND SS.AMTSystemSource=0 AND CAC.CostBearer=0 THEN PTA.Cost_Bearer_ID
							  ELSE ISNULL(IPT.Cost_Bearer_ID,@DefCB) END,

	IPT.labour_Activity_Id=CASE
								/*If it is updated to be consumable, cost allocations will be deleted*/
							  /*Linked to external cost allocation and this field is not updated by AMT*/
							  WHEN CA.Proj_Task_Amt_Id>0 AND SS.AMTSystemSource=0 AND CAC.LabourActivity=0 THEN PTA.labour_Activity_Id
							  ELSE IPT.labour_Activity_Id END,
	IPT.Cost_Centre_Id=CASE
						/*If it is updated to be consumable, cost allocations will be deleted*/
					  /*Linked to external cost allocation and this field is not updated by AMT*/
					  WHEN CA.Proj_Task_Amt_Id>0 AND SS.AMTSystemSource=0 AND CAC.CostCentre=0 THEN PTA.Cost_Centre_Id
					  ELSE IPT.Cost_Centre_Id END,

	IPT.Work_Group_Id=CASE
						/*If it is updated to be consumable, cost allocations will be deleted*/
					  /*Linked to external cost allocation and this field is not updated by AMT*/
					  WHEN CA.Proj_Task_Amt_Id>0 AND SS.AMTSystemSource=0 AND CAC.WorkGroup=0 THEN PTA.Work_Group_Id
					  ELSE IPT.Work_Group_Id END,
	/*VV E790 IPT.Cost_Allocation_Id=CA.Cost_Allocation_Id*/
	IPT.Cost_Allocation_Id=CA_Old.Cost_Allocation_Id

FROM 
#z_I_PROJECTED_TASKS IPT
	INNER JOIN
tblProjTaskAmts PTA
	ON IPT.ProjTaskAmtId=PTA.ProjTaskAmtId 
	INNER JOIN
tblProjTaskOpts PTO
	ON PTA.ProjTaskOptId=PTO.ProjTaskOptId
	INNER JOIN
tblProjTasks PT
	ON PT.ProjTaskId=PTO.ProjTaskId
	LEFT JOIN
COST_ALLOCATION CA
	/*VV E790 ON PTA.ProjTaskAmtId=CA.Proj_Task_Amt_Id*/
	ON IPT.NewCostAllocationId=CA.Cost_Allocation_Id
	LEFT JOIN
SYSTEM_SOURCE SS
	ON CA.System_Source_Id=SS.System_Source_Id
	LEFT JOIN
tblPricedJobs PJ
	ON PTA.PricedJobId=PJ.PricedJobId
	LEFT JOIN
tblStdJobs SJ
	ON PJ.StdJobId=SJ.StdJobId
	/*VV E790*/
	LEFT JOIN
COST_ALLOCATION CA_Old
	ON PTA.ProjTaskAmtId=CA_Old.Proj_Task_Amt_Id
	CROSS JOIN
COST_ALLOCATION_CONFIGURATION CAC



--Delete ProjtaskAmts which are missing in the file
CREATE TABLE #z_PTADelete(ProjTaskAmtId int PRIMARY KEY(ProjTaskAmtId))

IF EXISTS(SELECT PTA.ProjTaskAmtId
	FROM
	#z_I_PROJECTED_TASKS IPT
		INNER JOIN
	tblProjTasks PT
		ON IPT.ProjTaskId=PT.ProjTaskId
		INNER JOIN
	tblProjTaskOpts PTO
		ON PT.ProjTaskId=PTO.ProjTaskId
		INNER JOIN
	tblProjTaskAmts PTA
		ON PTO.ProjTaskOptId=PTA.ProjTaskOptId
		LEFT JOIN
	#z_I_PROJECTED_TASKS I
		ON PTA.ProjTaskAmtId=I.ProjTaskAmtId
	WHERE I.ProjTaskAmtId IS NULL )
BEGIN
	INSERT INTO #z_PTADelete(ProjTaskAmtId)
	SELECT DISTINCT PTA.ProjTaskAmtId
	FROM
	#z_I_PROJECTED_TASKS IPT
		INNER JOIN
	tblProjTasks PT
		ON IPT.ProjTaskId=PT.ProjTaskId
		INNER JOIN
	tblProjTaskOpts PTO
		ON PT.ProjTaskId=PTO.ProjTaskId
		INNER JOIN
	tblProjTaskAmts PTA
		ON PTO.ProjTaskOptId=PTA.ProjTaskOptId
		LEFT JOIN
	#z_I_PROJECTED_TASKS I
		ON PTA.ProjTaskAmtId=I.ProjTaskAmtId
	WHERE I.ProjTaskAmtId IS NULL 
END

--Cost Allocations shall be deleted if proj job need to be linked to Std Job or if it is consumable


CREATE TABLE #z_CADelete(ProjTaskAmtId int PRIMARY KEY(ProjTaskAmtId))

/*VV E790 IF EXISTS(SELECT IPT.ProjTaskAmtId FROM #z_I_PROJECTED_TASKS IPT
		 WHERE Cost_Allocation_Id>0 AND (ISNULL(IPT.Standard_Job_Reference,'')<>'' OR IPT.Consumable=1))*/
IF EXISTS(SELECT IPT.ProjTaskAmtId FROM #z_I_PROJECTED_TASKS IPT
		 WHERE Cost_Allocation_Id>0 AND Cost_Allocation_Id<>NewCostAllocationId)
BEGIN
	INSERT INTO #z_CADelete(ProjTaskAmtId)
	SELECT IPT.ProjTaskAmtId FROM #z_I_PROJECTED_TASKS IPT
	WHERE Cost_Allocation_Id>0 
	/*VV E790 AND (ISNULL(IPT.Standard_Job_Reference,'')<>'' OR IPT.Consumable=1)*/ 
	AND Cost_Allocation_Id<>NewCostAllocationId
END


SET XACT_ABORT ON
BEGIN TRANSACTION

--Delete RR tasks if Component Structure is unlinked from the parent task

IF EXISTS(SELECT RR.ParentTaskId FROM
			tblProjTasks RR
				INNER JOIN
			#z_I_PROJECTED_TASKS IPT
				ON RR.ParentTaskId=IPT.ProjTaskId
				INNER JOIN
			tblProjTasks PT
				ON IPT.ProjTaskId=PT.ProjTaskId
			WHERE /*12-Jan-2009 VV*/ ISNULL(PT.Maintenance_Strategy_Id,0)<>ISNULL(IPT.Maintenance_Strategy_Id,0))
BEGIN
	SET @ProjTaskId=''

	SELECT @ProjTaskId = (select CAST(RR.ParentTaskId AS varchar)+',' FROM
		tblProjTasks RR
			INNER JOIN
		#z_I_PROJECTED_TASKS IPT
			ON RR.ParentTaskId=IPT.ProjTaskId
			INNER JOIN
		tblProjTasks PT
			ON IPT.ProjTaskId=PT.ProjTaskId
		WHERE /*12-Jan-2009 VV*/ ISNULL(PT.Maintenance_Strategy_Id,0)<>ISNULL(IPT.Maintenance_Strategy_Id,0) 
		GROUP BY RR.ParentTaskId
	 FOR XML PATH('') )

	SET @ProjTaskId=ISNULL(@ProjTaskId,'')

	EXEC TASK_DELETE_MULTI_EQP @eqpPlanID='',@EqpProjHeaderId =NULL,@ProjTaskHeaderId =NULL,@forceDelete=1,@DeleteRRTasksOnly=1,@ProjTaskId=@ProjTaskId,@CheckRules=1
 
END



IF EXISTS(SELECT UpdateTask FROM #z_I_PROJECTED_TASKS WHERE UpdateTask=1 OR UpdateOpt=1)
BEGIN

	UPDATE PT SET

	--#Enh:527 compare 4 codes
	PT.ModifierId=IPT.ModifierId,
	PT.ComponentCodeId=IPT.ComponentCodeId,
	PT.ApplicationCodeId=IPT.ApplicationCodeId,	
	PT.TaskTypeId=IPT.TaskTypeId,
	PT.Task_Header_Id=IPT.Task_Header_Id,
	
	PT.PlanTaskOptId =CASE IPT.Planning_Task WHEN 0 THEN NULL ELSE PT.PlanTaskOptId END,
	PT.PlanStatus = CASE IPT.Planning_Task WHEN 0 THEN 0 ELSE PT.PlanStatus END, 
	PT.PlanUseCalc=CASE IPT.Planning_Task WHEN 0 THEN 1 ELSE PT.PlanUseCalc END,
	PT.ManufacturerId =IPT.ManufacturerId, 
	PT.UsageMethod=CASE WHEN (CASE WHEN AutomaticUpdate=1 THEN PT.UsageQUOMId ELSE IPT.QUOMId END)>0 THEN 'U' ELSE 'D' END,
	PT.UsageQUOMId = CASE WHEN AutomaticUpdate=1 THEN PT.UsageQUOMId ELSE IPT.QUOMId END, 
	PT.Final = IPT.Final, 
	PT.AddNotComplete = 0, 
	PT.Last_Change_Usage = IPT.Last_Change_Usage, 
	PT.Last_Change_Date = IPT.Last_Change_Date, 
	PT.Rotable_Part_Id = IPT.RotableId,
	PT.Group_Number = IPT.Group_Number,
	PT.Part_Id = IPT.PartId,
	PT.Planning_Task = IPT.Planning_Task, 
	PT.Planning_Lead_Time = IPT.Planning_Lead_Time,	
	PT.SchedulingTaskId=IPT.SchedulingTaskId,
	PT.LastOcc=CASE WHEN PT.Schedule_Type_Id=IPT.Schedule_Type_Id THEN PT.LastOcc
			ELSE
				CASE WHEN @UseSchedulingSystemLastOcc = 1 AND IPT.SchedulingTaskId > 0 THEN
					CASE WHEN IPT.Schedule_Type_Id IN (@LastPerfUOM,@LastPerfDate) THEN PT.Ext_Last_Occ ELSE PT.Ext_Last_Sched_Occ END
				ELSE
					CASE WHEN IPT.Schedule_Type_Id IN (@LastPerfUOM,@LastPerfDate) THEN PT.AMT_WO_Last_Occ ELSE PT.AMT_Last_Sched_Occ END	
				END
			END,

	PT.LastOccDate=CASE WHEN PT.Schedule_Type_Id=IPT.Schedule_Type_Id THEN PT.LastOccDate
				ELSE
					CASE WHEN @UseSchedulingSystemLastOcc = 1 AND IPT.SchedulingTaskId > 0 THEN
						CASE WHEN IPT.Schedule_Type_Id IN (@LastPerfUOM,@LastPerfDate) THEN PT.Ext_Last_Occ_Date ELSE PT.Ext_Last_Sched_Date END
					ELSE
						CASE WHEN IPT.Schedule_Type_Id IN (@LastPerfUOM,@LastPerfDate) THEN PT.AMT_WO_Last_Occ_Date ELSE PT.AMT_Last_Sched_Date END
					END
				END,
	PT.Schedule_Type_Id=IPT.Schedule_Type_Id, 
	PT.Scheduling_Group_Id=IPT.Scheduling_Group_Id,
	PT.Scheduling_Group_Counter=IPT.Scheduling_Group_Counter, 
	PT.Operational_Criticality_Id=IPT.Operational_Criticality_Id, 
	PT.Warranty_Period_Usage=IPT.Warranty_Usage, 
	PT.Warranty_Period_Days=IPT.Warranty_Days, 
	PT.Changeout_Guidelines=IPT.Changeout_Guidelines, 
	PT.Task_Description=IPT.Task_Description, 
	PT.InspectionTaskTypeId=IPT.InspectionTaskTypeId, 
	PT.InspectionOffset=IPT.InspectionOffset, 
	PT.ExternalIdentifier= IPT.External_Identifier,
	PT.PerformanceStrategyReason=IPT.PerformanceStrategyReason,
	PT.RCMComponentStructureId= CASE WHEN PT.Maintenance_Strategy_Id=IPT.Maintenance_Strategy_Id 
									 THEN PT.RCMComponentStructureId ELSE NULL END,
	PT.Maintenance_Strategy_Id=IPT.Maintenance_Strategy_Id, 
	PT.Last_Mod_Date= @TodaysDate,
	PT.ReviewStatusID=CASE IPT.Planning_Task WHEN 0 THEN 1 ELSE PT.ReviewStatusID END,
	PT.ReviewUserID=CASE IPT.Planning_Task WHEN 0 THEN NULL ELSE PT.ReviewUserID END,
	PT.ReviewDate=CASE IPT.Planning_Task WHEN 0 THEN NULL ELSE PT.ReviewDate END,
	PT.Frequency=CASE WHEN PT.AutomaticUpdate=0 THEN IPT.Frequency ELSE PT.Frequency END,
	PT.[First]=IPT.[First],
	-- 15 Sep 08	KN Reset Next Occ if it not a Planning Task.
	PT.NextOcc = CASE IPT.Planning_Task WHEN 0 THEN NULL ELSE PT.NextOcc END,
	PT.NextOccDate = CASE IPT.Planning_Task WHEN 0 THEN NULL ELSE PT.NextOccDate END,
	/*VV E316*/
	PT.TagId=IPT.Tag_Id,
	PT.PartRatingId=IPT.PartRatingId	
	FROM
	tblProjTasks PT
		INNER JOIN
	(SELECT /*VV E316*/DISTINCT ProjTaskId,ManufacturerId, QUOMId,Final, Last_Change_Usage, Last_Change_Date,RotableId,
	Group_Number,PartId,Planning_Task, Planning_Lead_Time,SchedulingTaskId,
	Schedule_Type_Id, Scheduling_Group_Id,Scheduling_Group_Counter, Operational_Criticality_Id, 
	Warranty_Usage, Warranty_Days, Maintenance_Strategy_Id, 
	Changeout_Guidelines, Task_Description, InspectionTaskTypeId, InspectionOffset, 
	External_Identifier,PerformanceStrategyReason,Frequency,[First],
	/*VV E316*/Tag_Id,PartRatingId,ModifierId,ComponentCodeId,ApplicationCodeId,TaskTypeId,Task_Header_Id
	FROM #z_I_PROJECTED_TASKS WHERE ProjTaskId>0 AND (UpdateTask=1 OR UpdateOpt=1)
	) IPT
		ON PT.ProjTaskId=IPT.ProjTaskId
END

IF EXISTS(SELECT UpdateOpt FROM #z_I_PROJECTED_TASKS WHERE UpdateOpt=1)
BEGIN
	UPDATE PTO SET
	PTO.Frequency=CASE WHEN PT.AutomaticUpdate=0 THEN IPT.Frequency ELSE PTO.Frequency END,
	PTO.[First]=IPT.[First]
	FROM
	tblProjTasks PT
		INNER JOIN
	tblProjTaskOpts PTO
		ON PT.ProjTaskId=PTO.ProjTaskId
		INNER JOIN
	#z_I_PROJECTED_TASKS IPT
		ON PTO.ProjTaskOptId=IPT.ProjTaskOptId
	WHERE IPT.UpdateOpt=1
	
END


--Delete cost allocations
IF EXISTS(SELECT ProjTaskAmtId FROM #z_CADelete) OR
EXISTS(SELECT ProjTaskAmtId FROM #z_PTADelete)
BEGIN
	DELETE CAD FROM 
	(SELECT ProjTaskAmtId FROM #z_CADelete UNION SELECT ProjTaskAmtId FROM #z_PTADelete) PTA
	 INNER JOIN
	COST_ALLOCATION CA 
		ON PTA.ProjTaskAmtId = CA.Proj_Task_Amt_Id 
		INNER JOIN
	COST_ALLOCATION_DETAIL CAD 
		ON CA.Cost_Allocation_Id=CAD.Cost_Allocation_Id 
	

	DELETE CA FROM 
	(SELECT ProjTaskAmtId FROM #z_CADelete UNION SELECT ProjTaskAmtId FROM #z_PTADelete) PTA 
		INNER JOIN
	COST_ALLOCATION CA 
		ON PTA.ProjTaskAmtId = CA.Proj_Task_Amt_Id 
END

DROP TABLE #z_CADelete

IF EXISTS(SELECT ProjTaskAmtId FROM #z_PTADelete)
BEGIN
	
	/*VV #4169*/
	DELETE  S  
	FROM   
	STRATEGY_TASK_JOB_EW_TEMPLATE S  
	 INNER JOIN  
	#z_PTADelete PTA  
	 ON S.ProjTaskAmtId=PTA.ProjTaskAmtId  
	
	DELETE PTA FROM 
	tblProjTaskAmts PTA
		INNER JOIN 
	#z_PTADelete A
		ON PTA.ProjTaskAmtId=A.ProjTaskAmtId
END

DROP TABLE #z_PTADelete
		
IF EXISTS(SELECT UpdateJob FROM #z_I_PROJECTED_TASKS WHERE UpdateJob=1)
BEGIN
	
	UPDATE PTA SET
	PTA.PricedJobId=IPT.PricedJobId, 
	PTA.JobCodeId= IPT.JobCodeId,
	PTA.PerformedAtSiteId=IPT.SiteId,
	PTA.PartTypeId=IPT.PartTypeId, 
	PTA.LaborShare=IPT.LaborShare, 
	PTA.CurrencyId = IPT.CurrencyId,
	PTA.PartsCost=IPT.PartsCost,
	PTA.LaborCost=IPT.LaborCost, 
	PTA.MiscCost=IPT.MiscCost,

	PTA.LaborHours=IPT.LaborHours,
	PTA.Duration=IPT.Duration,

	PTA.Labour_Cost_Expense_Id=IPT.Labour_Cost_Expense_Id,

	PTA.Misc_Cost_Expense_Id=IPT.Misc_Cost_Expense_Id,

	PTA.Parts_Cost_Expense_Id=IPT.Parts_Cost_Expense_Id,

	PTA.Pricing_Date= IPT.Pricing_Date,

	PTA.Cost_Bearer_ID=IPT.Cost_Bearer_ID,

	PTA.labour_Activity_Id=IPT.labour_Activity_Id,
	PTA.Crane_Cost=IPT.Crane_Cost,
	PTA.Pct_Freight=IPT.Pct_Freight,
	PTA.Avg_Daily_Work_Hrs=IPT.Avg_Daily_Work_Hrs,
	PTA.Avg_No_People=IPT.Avg_No_People,
	PTA.Avg_Travel_Hrs=IPT.Avg_Travel_Hrs,
	PTA.Travel_Distance=IPT.Travel_Distance,
	PTA.Travel_Recovery_Rate_L=IPT.Travel_Recovery_Rate_L,
	PTA.Travel_Recovery_Rate_V=IPT.Travel_Recovery_Rate_V,
	PTA.Misc_Trip_Cost=IPT.Misc_Trip_Cost,
	PTA.Labour_Hrs_Field=IPT.Labour_Hrs_Field,
	PTA.Parts_EDC_ID=IPT.Parts_EDC_ID, 
	PTA.Labour_EDC_ID=IPT.Labour_EDC_ID,
	PTA.Misc_EDC_ID=IPT.Misc_EDC_ID,
	PTA.Cost_Centre_Id=IPT.Cost_Centre_Id,
	PTA.Work_Group_Id=IPT.Work_Group_Id,
	PTA.Health_Safety_Id=IPT.Health_Safety_Id,
	PTA.Consumable=IPT.Consumable, 
	PTA.QtyVolume=IPT.QtyVolume,
	PTA.PercentTopUp=IPT.PercentTopUp,
	PTA.UnitPrice=IPT.UnitPrice,
	PTA.StdJobReference= CASE WHEN IPT.PricedJobId>0 THEN NULL ELSE IPT.Standard_Job_Reference END
	
	FROM
	#z_I_PROJECTED_TASKS IPT
		INNER JOIN
	tblProjTaskAmts PTA
		ON IPT.ProjTaskAmtId=PTA.ProjTaskAmtId
	WHERE IPT.UpdateJob=1
	
	/*VV E790*/
	UPDATE CA SET Proj_Task_Amt_Id=PTA.ProjTaskAmtId
	FROM
	COST_ALLOCATION CA
		INNER JOIN
	#z_I_PROJECTED_TASKS IPT
		ON CA.Cost_Allocation_Id=IPT.NewCostAllocationId
		INNER JOIN
	tblProjTaskAmts PTA
		ON IPT.ProjTaskAmtId=PTA.ProjTaskAmtId
	WHERE IPT.UpdateJob=1 AND CA.Proj_Task_Amt_Id IS NULL

	--Update AMT cost allocations
	UPDATE CAD SET
	CAD.Job_Code_Id=ISNULL(PTA.JobCodeId,CAD.Job_Code_Id),	
	CAD.Labour_Activity_Id=ISNULL(PTA.Labour_Activity_Id,CAD.Labour_Activity_Id),	
	CAD.Labour_Cost_Expense_ID=ISNULL(PTA.Labour_Cost_Expense_ID,CAD.Labour_Cost_Expense_ID),	
	CAD.Parts_Cost_Expense_ID=ISNULL(PTA.Parts_Cost_Expense_ID,CAD.Parts_Cost_Expense_ID),
	CAD.Misc_Cost_Expense_ID=ISNULL(PTA.Misc_Cost_Expense_ID,CAD.Misc_Cost_Expense_ID),	
	CAD.Cost_Bearer_ID=ISNULL(PTA.Cost_Bearer_ID,CAD.Cost_Bearer_ID),	
	CAD.Cost_Centre_ID=ISNULL(PTA.Cost_Centre_ID,CAD.Cost_Centre_ID),	
	CAD.Work_Group_Id=ISNULL(PTA.Work_Group_Id,CAD.Work_Group_Id)
	FROM
	#z_I_PROJECTED_TASKS IPT
		INNER JOIN
	tblProjTaskAmts PTA
		ON IPT.ProjTaskAmtId=PTA.ProjTaskAmtId
		INNER JOIN
	COST_ALLOCATION CA
		ON PTA.ProjTaskAmtId=CA.Proj_Task_Amt_Id
		INNER JOIN
	COST_ALLOCATION_DETAIL CAD
		ON CA.Cost_Allocation_Id=CAD.Cost_Allocation_Id
		INNER JOIN
	SYSTEM_SOURCE SS
		ON CA.System_Source_Id=SS.System_Source_Id
	WHERE IPT.UpdateJob=1 AND SS.AmtSystemSource=1
	
	/*VV E790 Update the existing cost allocations to the new external identifier*/
	UPDATE CA SET CA.Cost_Allocation_Ref=IPT.External_Identifier
	FROM
	#z_I_PROJECTED_TASKS IPT
		INNER JOIN
	tblProjTaskAmts PTA
		ON IPT.ProjTaskAmtId=PTA.ProjTaskAmtId
		INNER JOIN
	COST_ALLOCATION CA
		ON PTA.ProjTaskAmtId=CA.Proj_Task_Amt_Id
	WHERE IPT.UpdateJob=1 AND IPT.UpdateExternalIdentifier=1 AND 
	CA.Cost_Allocation_Ref<>IPT.External_Identifier

END


--Add projected tasks
IF EXISTS(SELECT EqpProjID FROM #z_I_PROJECTED_TASKS WHERE ProjTaskId IS NULL)
BEGIN

	INSERT INTO tblProjTasks(
	EqpPlanID,EqpProjID,ComponentCodeId,ModifierId,TaskTypeId,ApplicationCodeId,ManufacturerId,
	UsageMethod,UsageQUOMId,[First],Frequency,Final,Unscheduled,LastModifiedDate,
	Last_Change_Usage,Last_Change_Date,Task_Header_Id,Planning_Task,Planning_Lead_Time,Rotable_Part_Id,
	Group_Number,Part_Id,SchedulingTaskId,Schedule_Type_Id, Scheduling_Group_Id, Scheduling_Group_Counter, 
	Operational_Criticality_Id,Warranty_Period_Usage,Warranty_Period_Days, 	Maintenance_Strategy_Id, 
	Changeout_Guidelines, Task_Description, InspectionTaskTypeId,InspectionOffset,
	ExternalIdentifier,PerformanceStrategyReason,RCMComponentStructureId,ParentTaskId,AutomaticUpdate, 
	ReviewStatusId,/*VV E316*/TagId,PartRatingId)
	SELECT /*VV E316*/DISTINCT EqpPlanID,EqpProjID,ComponentCodeId,ModifierId,TaskTypeId,ApplicationCodeId,ManufacturerId,
	CASE  WHEN QUOMId>0 THEN 'U' ELSE 'D' END AS UsageMethod,
	QUOMId AS UsageQUOMId,[First],Frequency,Final,Unscheduled,@TodaysDate AS LastModifiedDate,
	Last_Change_Usage,Last_Change_Date,Task_Header_Id,Planning_Task,Planning_Lead_Time,RotableId AS Rotable_Part_Id,
	Group_Number,PartId AS Part_Id,SchedulingTaskId,Schedule_Type_Id, Scheduling_Group_Id, Scheduling_Group_Counter, 
	Operational_Criticality_Id,Warranty_Usage AS  Warranty_Period_Usage,Warranty_Days AS Warranty_Period_Days, 
	Maintenance_Strategy_Id, Changeout_Guidelines, Task_Description, InspectionTaskTypeId,InspectionOffset,
	External_Identifier AS ExternalIdentifier,PerformanceStrategyReason,NULL AS RCMComponentStructureId, 
	NULL AS ParentTaskId, 0 AS AutomaticUpdate, 1 AS ReviewStatusId,		-- KN 15-Sep-09	Added ReviewStatusId
	/*VV E316*/Tag_Id,PartRatingId
	FROM #z_I_PROJECTED_TASKS WHERE ProjTaskId IS NULL

	UPDATE IPT SET IPT.ProjTaskId=PT.ProjTaskId,NewProjTaskId=PT.ProjTaskId FROM
	#z_I_PROJECTED_TASKS IPT
		INNER JOIN
	tblProjTasks PT
		ON IPT.EqpProjId=PT.EqpProjId AND IPT.Task_Header_Id=PT.Task_Header_Id
	WHERE IPT.ProjTaskId IS NULL


	INSERT INTO tblProjTaskOpts(ProjTaskId, OccurrenceTypeId, Probability, PlannedOption, [First], Frequency)
	SELECT NewProjTaskId, @DefOccTypeId AS OccurrenceTypeId, 100 AS Probability, 1 AS PlannedOption, [First], 
	Frequency
	FROM #z_I_PROJECTED_TASKS IPT WHERE NewProjTaskId>0
	GROUP BY NewProjTaskId,[First], Frequency

END




--Add ProjTaskAmts
IF EXISTS(SELECT ProjTaskId FROM #z_I_PROJECTED_TASKS WHERE ProjTaskId>0 AND ProjTaskAmtId IS NULL)
BEGIN
	INSERT INTO tblProjTaskAmts
	(PricedJobId, JobCodeId, PerformedAtSiteId, 
	PartTypeId, LaborShare, ProjTaskOptId, 
	CurrencyId, LaborCost, PartsCost, 
	MiscCost, LaborHours, Duration,
	Labour_Cost_Expense_Id, Misc_Cost_Expense_Id, Parts_Cost_Expense_Id,
	Pricing_Date, Cost_Bearer_ID, labour_Activity_Id,
	Crane_Cost, Pct_Freight, Avg_Daily_Work_Hrs, Avg_No_People, 
	Avg_Travel_Hrs, Travel_Distance, Travel_Recovery_Rate_L, Travel_Recovery_Rate_V,
	Misc_Trip_Cost, Labour_Hrs_Field,Parts_EDC_ID,Labour_EDC_ID,Misc_EDC_ID,Cost_Centre_Id,
	Rotable_Repair_Strategy, Action_Required_Id, Rebuild_Location_Id,
	Work_Group_Id, Health_Safety_Id,Consumable,QtyVolume,PercentTopUp,UnitPrice,StdJobPartsMargin,
	StdJobReference
	)
	SELECT
	NULL AS PricedJobId, IPT.JobCodeId, IPT.SiteId AS PerformedAtSiteId, 
	IPT.PartTypeId, IPT.LaborShare, PTO.ProjTaskOptId, 
	IPT.CurrencyId, IPT.LaborCost, IPT.PartsCost, 
	IPT.MiscCost, IPT.LaborHours, IPT.Duration, 
	IPT.Labour_Cost_Expense_Id, IPT.Misc_Cost_Expense_Id, IPT.Parts_Cost_Expense_Id,
	IPT.Pricing_Date, /*VV 26-Nov-2008*/ISNULL(IPT.Cost_Bearer_ID,@DefCB) AS Cost_Bearer_ID, IPT.labour_Activity_Id,
	IPT.Crane_Cost, IPT.Pct_Freight, IPT.Avg_Daily_Work_Hrs, IPT.Avg_No_People, 
	IPT.Avg_Travel_Hrs, IPT.Travel_Distance, IPT.Travel_Recovery_Rate_L, IPT.Travel_Recovery_Rate_V,
	IPT.Misc_Trip_Cost, IPT.Labour_Hrs_Field,IPT.Parts_EDC_ID,IPT.Labour_EDC_ID,IPT.Misc_EDC_ID,IPT.Cost_Centre_Id,
	/*set rotable details for the tasks with 1 job*/
	CASE WHEN IPT.RotableId>0 AND IPT.PTGroupMax=IPT.PTGroupMin THEN 1 ELSE 0 END AS Rotable_Repair_Strategy, 
	CASE WHEN IPT.RotableId>0 AND IPT.PTGroupMax=IPT.PTGroupMin THEN 1 ELSE NULL END AS Action_Required_Id, 
	CASE WHEN IPT.RotableId>0 AND IPT.PTGroupMax=IPT.PTGroupMin THEN IPT.SiteId ELSE NULL END AS Rebuild_Location_Id,
	IPT.Work_Group_Id, IPT.Health_Safety_Id,IPT.Consumable,IPT.QtyVolume,IPT.PercentTopUp,IPT.UnitPrice,
	NULL AS StdJobPartsMargin,IPT.Standard_Job_Reference AS StdJobReference
	FROM 
	tblProjTaskOpts PTO 
		INNER JOIN 
	tblProjTasks PT
		ON PTO.ProjTaskId=PT.ProjTaskId
		INNER JOIN
	#z_I_PROJECTED_TASKS IPT 
		ON PT.ProjTaskId = IPT.ProjTaskId
	WHERE IPT.ProjTaskAmtId IS NULL
END

 
--#Enh:527 update related wororders and workorders settlements
IF(@UpdateStrategyTaskCodes =1)
BEGIN
	SET @ProjTaskId=''
	SELECT @ProjTaskId = (SELECT CAST(IPT.ProjTaskId AS varchar)+',' FROM	
	#z_I_PROJECTED_TASKS IPT
	WHERE  IPT.UpdateStrategyTaskCodes=1
	GROUP BY IPT.ProjTaskId
	FOR XML PATH('') )

	SET @ProjTaskId=ISNULL(@ProjTaskId,'') 

	EXEC UPDATE_STRATEGY_TASK_HISTORY_P @projTaskId=@ProjTaskId
END

--Update Rotable job
IF EXISTS(SELECT IPT.ProjTaskId FROM #z_I_PROJECTED_TASKS IPT WHERE RotableId>0)
BEGIN
	SET @ProjTaskId=''

	SELECT @ProjTaskId = (SELECT CAST(ProjTaskId AS varchar)+',' 
	FROM #z_I_PROJECTED_TASKS WHERE RotableId>0
	GROUP BY ProjTaskId
		 FOR XML PATH('') )

	SET @ProjTaskId=ISNULL(@ProjTaskId,'')

	EXEC UPDATE_ROTABLE_JOB_P @projTasks=@ProjTaskId
END



--Relink EQS tasks
IF EXISTS(SELECT T.Task_Id FROM 
TASK T
	INNER JOIN
#z_I_PROJECTED_TASKS IPT
	ON IPT.Projection_Type_Id=@TypeCur AND T.Eqp_Plan_Id=IPT.EqpPlanId AND T.Task_Header_Id=IPT.Task_Header_Id
WHERE T.Strategy_Proj_Task_Opt_ID IS NULL)
BEGIN
	SET @ProjTaskId=''

	SELECT @ProjTaskId = (SELECT CAST(IPT.ProjTaskId AS varchar)+',' FROM
	TASK T
		INNER JOIN
	#z_I_PROJECTED_TASKS IPT
		ON IPT.Projection_Type_Id=@TypeCur AND T.Eqp_Plan_Id=IPT.EqpPlanId AND T.Task_Header_Id=IPT.Task_Header_Id
	WHERE IPT.ProjTaskId>0 AND T.Strategy_Proj_Task_Opt_ID IS NULL
	GROUP BY IPT.ProjTaskId
		 FOR XML PATH('') )

	SET @ProjTaskId=ISNULL(@ProjTaskId,'')

	EXEC STRATEGY_TASK_LINK_TO_EQS_TASK_P @ProjTaskIdMany=@projTaskId
END


-- update the values from the linked SCHEDULING_TASK
IF EXISTS(SELECT ProjTaskId FROM #z_I_PROJECTED_TASKS WHERE ProjTaskId>0 AND SchedulingTaskId>0) /* VV 7-Nov-2008 AND (UpdateTask=1 OR NewProjTaskId>1))*/
BEGIN
	SET @ProjTaskId=''

	SELECT @ProjTaskId = (SELECT CAST(ProjTaskId AS varchar)+',' FROM
	#z_I_PROJECTED_TASKS WHERE ProjTaskId>0 AND SchedulingTaskId>0 GROUP BY ProjTaskId
		 FOR XML PATH('') )

	SET @ProjTaskId=ISNULL(@ProjTaskId,'')

	--print @projTaskId

	EXEC SCHEDULING_TASK_TO_PROJ_TASK_P @ProjTaskIdMany=@ProjTaskId
END

COMMIT TRANSACTION




IF EXISTS(SELECT Standard_Job_Reference FROM #z_I_PROJECTED_TASKS 
	WHERE PricedJobId IS NULL AND Standard_Job_Reference IS NOT NULL)
BEGIN
	DECLARE @StdJobRef XML
	
	SET @StdJobRef=(SELECT Standard_Job_Reference AS List_Item FROM #z_I_PROJECTED_TASKS 
			WHERE PricedJobId IS NULL AND Standard_Job_Reference IS NOT NULL
			GROUP BY Standard_Job_Reference
			FOR XML RAW('Row'),ROOT('Rows'),ELEMENTS)
END


END_IMPORT:

DROP TABLE #z_I_PROJECTED_TASKS

IF @StdJobRef IS NOT NULL
BEGIN
	EXEC STD_JOB_LINK_P @StdJobRef=@StdJobRef
END



SELECT @NoErrors=COUNT(*) FROM IMPORT_ERROR WHERE ImportFileName=@ImportFileName


IF @NoErrors=0
BEGIN
	DELETE IMPORT_PROJECTION WHERE Import_File_Name=@ImportFileName
END
ELSE
BEGIN
	UPDATE IMPORT_PROJECTION SET Processed=1 WHERE Import_File_Name=@ImportFileName
	
	IF ISNULL(@InterfaceSource1,0)<>0
	BEGIN

		UPDATE E SET ImportRecord=
			(SELECT Model,Equipment_No,Serial_No, Registration_Counter,Equip_Name,Projection_Type,
			Projection_Name,Task_Description,Global_Code,Component_Code,Modifier_Code
			 ,Task_Type,Task_Counter,Inactive_Task,Unassigned_Task,Planning_Task,Planning_Lead_Days,
			 Operational_Criticality,Task_Manufacturer_Code,Part_SOS,Primary_Part_Number,Group_Number,
			 Rotable_Part_Number,Warranty_Days,Warranty_Usage,UOM,Schedule_On_Last_Scheduled,[First] ,
			 Interval ,Final ,Last_Change_Usage,Last_Change_Date,External_Identifier,Suppression_Group,
			 Suppression_Counter,Sibling_Interval ,Dependency_Group ,Dependency_Counter,
			 Inspection_Logic_Task_Type,Inspection_Logic_Offset,Performance_Strategy,
			 Performance_Strategy_Reason,Changeout_Guidelines,ERP_Component_Code,ERP_Modifier_Code,
			 ERP_Scheduling_Task,Scheduling_Task,Last_Occurrence,Last_Occ_Date,Last_Scheduled,
			 Last_Sched_Date,Next_Occurrence,Next_Occ_Date,Job_Code,Currency,Standard_Job_Reference,
			 Cost_Bearer,Cost_Centre,Work_Group,Part_Type,Health_Safety,Pricing_Date,
			 Consumable_Qty,Consumable_Top_Up,Consumable_Price,Parts_Sell,Labour_Sell,Misc_Sell,
			 Shop_Labour,Labour_Hours,Labour_Activity ,Duration_Hours,Part_Expense,Labour_Expense,
			 Misc_Expense,Part_EDC,Labour_EDC ,Misc_EDC,Labour_Split ,Crane_Cost,Freight_Perc_Parts,
			 Avg_People_Vehicle,Avg_Daily_Work_Hours,Avg_Travel_Hours,Travel_Labour_Rate,Travel_Distance,
			 Travel_Rate,Misc_Cost_Per_Trip,Update_Scheduling_Task_Only,System_Source ,Tag_Id,Rating 
		FROM
		IMPORT_PROJECTION P
		WHERE P.Import_File_Name=@ImportFileName
			AND P.Line_No=E.Line_No
		for XML PATH('I_PROJECTEDTASK'),ROOT('I_PROJECTEDTASKs'))
		FROM
		IMPORT_ERROR E
		WHERE E.ImportFileName=@ImportFileName

	END
END


RETURN


GO


if exists (select * from dbo.sysobjects where id = object_id(N'RPT_FORECAST_ROTABLES_STOCK_P') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure RPT_FORECAST_ROTABLES_STOCK_P
GO

create     PROCEDURE RPT_FORECAST_ROTABLES_STOCK_P

/******************************************************************************
	Name: RPT_FORECAST_ROTABLES_STOCK_P 

	Author: Veronika Vasylyeva
	12 Apr 2012

	
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	4 May 12	V Vasylyeva	#4128 Added sort by part rating
*******************************************************************************/
@EndDate datetime=NULL,
@BranchID varchar(MAX) = '',
@ComponentCodeId varchar(max)='',
@PartRatingId varchar(max)='',
@PartTypeId varchar(max)='',
@PartId varchar(max)='',
@SalesStatusId varchar(max)='',
@MinStockLevelS varchar(max)='',
@TotalPeriodDemandS varchar(max)='',
@AverageStockLevelS varchar(max)='',
@AnnualisedStockTurnLessS varchar(max)='',
@AnnualisedStockTurnGreaterS varchar(max)='',
@ApplyMinStockLevel bit=0,
@ApplyTotalPeriodDemand bit=0,
@ApplyAverageStockLevel bit=0,
@ApplyAnnualisedStockTurnLess bit=0,
@ApplyAnnualisedStockTurnGreater bit=0,
@AnalyseBy varchar(max)='',
@SortBy varchar(max)='',
@UserId int=0

AS

DECLARE @StartDay int,@EndDay int,@NumberOfDays float,@Interval int,@IntervalNumber int
DECLARE @StartInterval datetime,@AnalyseBy1 int, @AnalyseBy2 int
DECLARE @MinStockLevel float,@TotalPeriodDemand float, @AverageStockLevel float
DECLARE @AnnualisedStockTurnLess float,@AnnualisedStockTurnGreater float

IF ISNUMERIC(@MinStockLevelS)=1 SET @MinStockLevel=CAST(@MinStockLevelS AS float) ELSE SET @ApplyMinStockLevel=0
IF ISNUMERIC(@TotalPeriodDemandS)=1 SET @TotalPeriodDemand=CAST(@TotalPeriodDemandS AS float) ELSE SET @ApplyTotalPeriodDemand=0
IF ISNUMERIC(@AverageStockLevelS)=1 SET @AverageStockLevel=CAST(@AverageStockLevelS AS float) ELSE SET @ApplyAverageStockLevel=0
IF ISNUMERIC(@AnnualisedStockTurnLessS)=1 SET @AnnualisedStockTurnLess=CAST(@AnnualisedStockTurnLessS AS float) ELSE SET @ApplyAnnualisedStockTurnLess=0
IF ISNUMERIC(@AnnualisedStockTurnGreaterS)=1 SET @AnnualisedStockTurnGreater=CAST(@AnnualisedStockTurnGreaterS AS float) ELSE SET @ApplyAnnualisedStockTurnGreater=0


SET @StartDay=YEAR(GETDATE())*10000+MONTH(GETDATE())*100+DAY(GETDATE())
SET @EndDay=YEAR(@EndDate)*10000+MONTH(@EndDate)*100+DAY(@EndDate)
SET @NumberOfDays=DATEDIFF(day,CAST(@StartDay AS varchar(50)),CAST(@EndDate AS varchar(50)))
SET @Interval=7 /*a week*/

SET @UserId = ISNULL(@UserId,0)
Declare @Level int
SELECT TOP 1 @Level=User_Access_Level_Id From USER_LEVEL_PERMISSION where AMT_User_Id = @UserId
SET @Level = ISNULL(@Level,0)


CREATE TABLE #z_Intervals(Interval int,StartInterval int, EndInterval int,
IntervalDesc varchar(100) COLLATE DATABASE_DEFAULT PRIMARY KEY(Interval))

SET @IntervalNumber=1
SET @StartInterval=CAST(CAST(@StartDay AS VARCHAR(50)) AS datetime)

WHILE @IntervalNumber<=CEILING(@NumberOfDays/@Interval)
BEGIN
	
	INSERT INTO #z_Intervals(Interval,StartInterval, EndInterval,IntervalDesc)
	SELECT @IntervalNumber AS Interval, 
	dbo.DATE_TO_INT_F(@StartInterval, 0) AS StartInterval, 
	dbo.DATE_TO_INT_F(DATEADD(day,@Interval,@StartInterval), 0) AS EndInterval,
	CAST(dbo.DATE_TO_INT_F(@StartInterval, 0) AS varchar(50)) AS IntervalDesc
	
	SET @StartInterval=DATEADD(day,@Interval,@StartInterval)
	
	SET @IntervalNumber=@IntervalNumber+1
END 

SET @IntervalNumber=@IntervalNumber-1

INSERT INTO #z_Intervals(Interval,IntervalDesc)
SELECT -4 AS Interval,'Total Period Demand' AS IntervalDesc
	UNION ALL
SELECT -3 AS Interval,'Average Stock Level' AS IntervalDesc
	UNION ALL
SELECT -2 AS Interval,'Minimum Stock Level' AS IntervalDesc
	UNION ALL
SELECT -1 AS Interval,'Annualised Stock Turn' AS IntervalDesc


DECLARE @Branch TABLE (list_item int)
DECLARE @Site TABLE (list_item int)
DECLARE @ComponentCode TABLE (list_item int)
DECLARE @PartRating TABLE (list_item int)
DECLARE @PartType TABLE (list_item int)
DECLARE @Part TABLE (list_item int)
DECLARE @SalesStatus TABLE (list_item int)

IF @BranchID<>'' 
BEGIN
	INSERT INTO @Branch(list_item) SELECT list_item FROM dbo.LIST_TO_TABLE_F(@BranchID) 
	INSERT INTO @Site(list_item) SELECT SiteId FROM tblSites WHERE BranchId IN (SELECT list_item FROM @Branch)
END

IF @ComponentCodeId<>'' INSERT INTO @ComponentCode(list_item) SELECT list_item FROM dbo.LIST_TO_TABLE_F(@ComponentCodeId) 
IF @PartRatingId<>'' INSERT INTO @PartRating(list_item) SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PartRatingId)  
IF @PartTypeId<>'' INSERT INTO @PartType(list_item) SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PartTypeId)  
IF @PartId<>'' INSERT INTO @Part(list_item) SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PartId)  
IF @SalesStatusId<>'' INSERT INTO @SalesStatus(list_item) SELECT list_item FROM dbo.LIST_TO_TABLE_F(@SalesStatusId)   

If @AnalyseBy<>'' /*Only 2 analyse by*/
BEGIN
	SELECT @AnalyseBy1=list_item FROM LIST_TO_TABLE_AND_ID_F(@AnalyseBy) ORDER BY ID DESC
	
	IF @@ROWCOUNT>1 SELECT @AnalyseBy2=list_item FROM LIST_TO_TABLE_AND_ID_F(@AnalyseBy) ORDER BY ID
END


/* Sort By
1,Minimum stock level
2,Total Period Demand
3,Average Stock Level
4,Annualised Stock Turn

*/

CREATE TABLE #z_Forecast(PartId int,Qty float,RepDay int,AnalyseById1 int,AnalyseById2 int)

/* Analyse By

1 Branch
2 Default Component Code
3 Part Rating
4 Part Type

*/



/*Quantity on Hand*/
INSERT INTO #z_Forecast(PartId,Qty,RepDay,AnalyseById1,AnalyseById2)
SELECT I.PartId, SUM(I.QtyOnHand) AS Qty,@StartDay AS RepDay,
ISNULL(CASE @AnalyseBy1 WHEN 1 THEN I.BranchId
WHEN 2 THEN P.DefaultComponentCodeId 
WHEN 3 THEN P.DefaultPartRatingId
WHEN 4 THEN P.Part_Type_ID
ELSE -1 END,-1) AS AnalyseById1,
ISNULL(CASE @AnalyseBy2 WHEN 1 THEN I.BranchId
WHEN 2 THEN P.DefaultComponentCodeId 
WHEN 3 THEN P.DefaultPartRatingId
WHEN 4 THEN P.Part_Type_ID
ELSE -1 END,-1) AS AnalyseById2
FROM 
INVENTORY_PART I 
	INNER JOIN
tblParts P
	ON I.PartId=P.PartId
WHERE 
(@PartId='' OR I.PartId IN (SELECT list_item FROM @Part)) AND
(@BranchID='' OR I.BranchId IN (SELECT list_item FROM @Branch)) AND
(@ComponentCodeId='' OR P.DefaultComponentCodeId IN (SELECT list_item FROM @ComponentCode)) AND
(@PartRatingId='' OR P.DefaultPartRatingId IN (SELECT list_item FROM @PartRating)) AND
(@PartTypeId='' OR P.Part_Type_ID IN (SELECT list_item FROM @PartType)) AND
(@Level<>1 OR I.BranchId In (SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = @UserId)) AND
(@Level<>2 OR I.RebuildSiteId IS NULL OR I.RebuildSiteId IN(SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = @UserId))

GROUP BY
I.PartId, 
CASE @AnalyseBy1 WHEN 1 THEN I.BranchId
WHEN 2 THEN P.DefaultComponentCodeId 
WHEN 3 THEN P.DefaultPartRatingId
WHEN 4 THEN P.Part_Type_ID
ELSE -1 END,
CASE @AnalyseBy2 WHEN 1 THEN I.BranchId
WHEN 2 THEN P.DefaultComponentCodeId 
WHEN 3 THEN P.DefaultPartRatingId
WHEN 4 THEN P.Part_Type_ID
ELSE -1 END



/*Quantity Being Delivered*/
INSERT INTO #z_Forecast(PartId,Qty,RepDay,AnalyseById1,AnalyseById2)
SELECT I.PartId, SUM(I.QtyOnOrder) AS Qty ,
YEAR(I.ExpectedDeliveryDate)*10000+MONTH(I.ExpectedDeliveryDate)*100+DAY(I.ExpectedDeliveryDate) AS RepDay,
ISNULL(CASE @AnalyseBy1 WHEN 1 THEN I.BranchId
WHEN 2 THEN P.DefaultComponentCodeId 
WHEN 3 THEN P.DefaultPartRatingId
WHEN 4 THEN P.Part_Type_ID
ELSE -1 END,-1) AS AnalyseBy1,
ISNULL(CASE @AnalyseBy2 WHEN 1 THEN I.BranchId
WHEN 2 THEN P.DefaultComponentCodeId 
WHEN 3 THEN P.DefaultPartRatingId
WHEN 4 THEN P.Part_Type_ID
ELSE -1 END,-1) AS AnalyseBy2
FROM 
INVENTORY_PART I 
	INNER JOIN
tblParts P
	ON I.PartId=P.PartId
WHERE 
(@PartId='' OR I.PartId IN (SELECT list_item FROM @Part)) AND
(@BranchID='' OR I.BranchId IN (SELECT list_item FROM @Branch)) AND
(@ComponentCodeId='' OR P.DefaultComponentCodeId IN (SELECT list_item FROM @ComponentCode)) AND
(@PartRatingId='' OR P.DefaultPartRatingId IN (SELECT list_item FROM @PartRating)) AND
(@PartTypeId='' OR P.Part_Type_ID IN (SELECT list_item FROM @PartType)) AND
(@Level<>1 OR I.BranchId In (SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = @UserId)) AND
(@Level<>2 OR I.RebuildSiteId IS NULL OR I.RebuildSiteId IN(SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = @UserId))

GROUP BY
I.PartId, YEAR(I.ExpectedDeliveryDate)*10000+MONTH(I.ExpectedDeliveryDate)*100+DAY(I.ExpectedDeliveryDate),
CASE @AnalyseBy1 WHEN 1 THEN I.BranchId
WHEN 2 THEN P.DefaultComponentCodeId 
WHEN 3 THEN P.DefaultPartRatingId
WHEN 4 THEN P.Part_Type_ID
ELSE -1 END,
CASE @AnalyseBy2 WHEN 1 THEN I.BranchId
WHEN 2 THEN P.DefaultComponentCodeId 
WHEN 3 THEN P.DefaultPartRatingId
WHEN 4 THEN P.Part_Type_ID
ELSE -1 END
HAVING SUM(I.QtyOnOrder)<>0


/*Quantity Completed Rebuild*/
INSERT INTO #z_Forecast(PartId,Qty,RepDay,AnalyseById1,AnalyseById2)
SELECT I.PartId, SUM(I.QtyBeingRebuilt) AS Qty ,
YEAR(I.ExpectedDeliveryDate)*10000+MONTH(I.ExpectedDeliveryDate)*100+DAY(I.ExpectedDeliveryDate) AS RepDay,
ISNULL(CASE @AnalyseBy1 WHEN 1 THEN I.BranchId
WHEN 2 THEN P.DefaultComponentCodeId 
WHEN 3 THEN P.DefaultPartRatingId
WHEN 4 THEN P.Part_Type_ID
ELSE -1 END,-1) AS AnalyseBy1,
ISNULL(CASE @AnalyseBy2 WHEN 1 THEN I.BranchId
WHEN 2 THEN P.DefaultComponentCodeId 
WHEN 3 THEN P.DefaultPartRatingId
WHEN 4 THEN P.Part_Type_ID
ELSE -1 END,-1) AS AnalyseBy2
FROM 
INVENTORY_PART I 
	INNER JOIN
tblParts P
	ON I.PartId=P.PartId
WHERE 
(@PartId='' OR I.PartId IN (SELECT list_item FROM @Part)) AND
(@BranchID='' OR I.BranchId IN (SELECT list_item FROM @Branch)) AND
(@ComponentCodeId='' OR P.DefaultComponentCodeId IN (SELECT list_item FROM @ComponentCode)) AND
(@PartRatingId='' OR P.DefaultPartRatingId IN (SELECT list_item FROM @PartRating)) AND
(@PartTypeId='' OR P.Part_Type_ID IN (SELECT list_item FROM @PartType)) AND
(@Level<>1 OR I.BranchId In (SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = @UserId)) AND
(@Level<>2 OR I.RebuildSiteId IS NULL OR I.RebuildSiteId IN(SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = @UserId))

GROUP BY
I.PartId, YEAR(I.ExpectedDeliveryDate)*10000+MONTH(I.ExpectedDeliveryDate)*100+DAY(I.ExpectedDeliveryDate),
CASE @AnalyseBy1 WHEN 1 THEN I.BranchId
WHEN 2 THEN P.DefaultComponentCodeId 
WHEN 3 THEN P.DefaultPartRatingId
WHEN 4 THEN P.Part_Type_ID
ELSE -1 END,
CASE @AnalyseBy2 WHEN 1 THEN I.BranchId
WHEN 2 THEN P.DefaultComponentCodeId 
WHEN 3 THEN P.DefaultPartRatingId
WHEN 4 THEN P.Part_Type_ID
ELSE -1 END
HAVING SUM(I.QtyBeingRebuilt)<>0

/*Component Changeouts Forecast*/

/*Changeout - installed on equipment*/
/*Look at "Next due" for the next occurrence*/
INSERT INTO #z_Forecast(PartId,Qty,RepDay,AnalyseById1,AnalyseById2)
SELECT ISNULL(N.PEXPartId,PT.Part_Id) AS PartId,-1 AS Qty,
YEAR(MIN(PTO.OccDate))*10000+MONTH(MIN(PTO.OccDate))*100+DAY(MIN(PTO.OccDate)) AS RepDay,
ISNULL(CASE @AnalyseBy1 WHEN 1 THEN ISNULL(SI.BranchId,S.BranchId)
WHEN 2 THEN ISNULL(PA.DefaultComponentCodeId,P.DefaultComponentCodeId) 
WHEN 3 THEN ISNULL(PT.PartRatingId,ISNULL(PA.DefaultPartRatingId,P.DefaultPartRatingId))
WHEN 4 THEN ISNULL(PA.Part_Type_ID,P.Part_Type_ID)
ELSE -1 END,-1) AS AnalyseBuId1,
ISNULL(CASE @AnalyseBy2 WHEN 1 THEN ISNULL(SI.BranchId,S.BranchId)
WHEN 2 THEN ISNULL(PA.DefaultComponentCodeId,P.DefaultComponentCodeId) 
WHEN 3 THEN ISNULL(PT.PartRatingId,ISNULL(PA.DefaultPartRatingId,P.DefaultPartRatingId))
WHEN 4 THEN ISNULL(PA.Part_Type_ID,P.Part_Type_ID)
ELSE -1 END,-1) AS AnalyseBuId2
FROM
tblProjTasks PT
	INNER JOIN
tblProjTaskOccs PTO
	ON PT.ProjTaskId=PTO.ProjTaskId
	LEFT JOIN
tblParts P
	ON PT.Part_Id=P.PartId
	INNER JOIN
tblEqpProjs EPR
	ON PT.EqpProjId=EPR.EqpProjId
	LEFT JOIN
NEXT_OCC_STRATEGY N
	ON PT.ProjTaskId=N.Proj_Task_Id
	LEFT JOIN
tblParts PA
	ON N.PEXPartId=PA.PartId
	LEFT JOIN
tblSites S
	ON PT.DefaultLocationForRebuild=S.SiteId
	LEFT JOIN
tblSites SI
	ON N.PEXRebuildLocationId=SI.SiteId
WHERE
EPR.Projection_Type_ID=1 AND
(@Level<>1 OR ISNULL(SI.BranchId,S.BranchId) IS NULL OR ISNULL(SI.BranchId,S.BranchId) IN (SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = @UserId)) AND
(@Level<>2 OR ISNULL(N.PEXRebuildLocationId,PT.DefaultLocationForRebuild) IS NULL OR ISNULL(N.PEXRebuildLocationId,PT.DefaultLocationForRebuild) IN(SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = @UserId)) AND
ISNULL(N.PEXPartId ,PT.Part_Id)>0 AND
(@PartId='' OR ISNULL(N.PEXPartId ,PT.Part_Id) IN (SELECT list_item FROM @Part)) AND
(@BranchID='' OR ISNULL(N.PEXRebuildLocationId,PT.DefaultLocationForRebuild) IN (SELECT list_item FROM @Site)) AND
(@ComponentCodeId='' OR ISNULL(PA.DefaultComponentCodeId,P.DefaultComponentCodeId) IN (SELECT list_item FROM @ComponentCode)) AND
(@PartRatingId='' OR ISNULL(PT.PartRatingId,ISNULL(PA.DefaultPartRatingId,P.DefaultPartRatingId)) IN (SELECT list_item FROM @PartRating)) AND
(@PartTypeId='' OR ISNULL(PA.Part_Type_ID,P.Part_Type_ID) IN (SELECT list_item FROM @PartType)) AND
(@SalesStatusId='' OR N.SalesStatusId IN (SELECT list_item FROM @SalesStatus))
GROUP BY PT.ProjTaskId,
ISNULL(N.PEXPartId,PT.Part_Id),
CASE @AnalyseBy1 WHEN 1 THEN ISNULL(SI.BranchId,S.BranchId)
WHEN 2 THEN ISNULL(PA.DefaultComponentCodeId,P.DefaultComponentCodeId) 
WHEN 3 THEN ISNULL(PT.PartRatingId,ISNULL(PA.DefaultPartRatingId,P.DefaultPartRatingId))
WHEN 4 THEN ISNULL(PA.Part_Type_ID,P.Part_Type_ID)
ELSE -1 END,
CASE @AnalyseBy2 WHEN 1 THEN ISNULL(SI.BranchId,S.BranchId)
WHEN 2 THEN ISNULL(PA.DefaultComponentCodeId,P.DefaultComponentCodeId) 
WHEN 3 THEN ISNULL(PT.PartRatingId,ISNULL(PA.DefaultPartRatingId,P.DefaultPartRatingId))
WHEN 4 THEN ISNULL(PA.Part_Type_ID,P.Part_Type_ID)
ELSE -1 END
HAVING YEAR(MIN(PTO.OccDate))*10000+MONTH(MIN(PTO.OccDate))*100+DAY(MIN(PTO.OccDate))>=@StartDay AND
YEAR(MIN(PTO.OccDate))*10000+MONTH(MIN(PTO.OccDate))*100+DAY(MIN(PTO.OccDate))<@EndDay


/*Look at Base details for all occurrences thereafter*/
INSERT INTO #z_Forecast(PartId,Qty,RepDay,AnalyseById1,AnalyseById2)
SELECT A.PartId,-COUNT(PTO.ProjTaskId) AS Qty,
YEAR(PTO.OccDate)*10000+MONTH(PTO.OccDate)*100+DAY(PTO.OccDate) AS RepDay,
A.AnalyseBuId1,A.AnalyseBuId2
FROM
(SELECT PT.Part_Id AS PartId,O.ProjTaskId,MIN(O.OccDate) AS NextOccDate,
ISNULL(CASE @AnalyseBy1 WHEN 1 THEN S.BranchId
WHEN 2 THEN P.DefaultComponentCodeId 
WHEN 3 THEN ISNULL(PT.PartRatingId,P.DefaultPartRatingId)
WHEN 4 THEN P.Part_Type_ID
ELSE -1 END,-1) AS AnalyseBuId1,
ISNULL(CASE @AnalyseBy2 WHEN 1 THEN S.BranchId
WHEN 2 THEN P.DefaultComponentCodeId 
WHEN 3 THEN ISNULL(PT.PartRatingId,P.DefaultPartRatingId)
WHEN 4 THEN P.Part_Type_ID
ELSE -1 END,-1) AS AnalyseBuId2
FROM
tblProjTaskOccs O
	INNER JOIN
tblProjTasks PT
	ON O.ProjTaskId=PT.ProjTaskId
	LEFT JOIN
tblParts P
	ON  PT.Part_Id=P.PartId
	INNER JOIN
tblEqpProjs EPR
	ON PT.EqpProjId=EPR.EqpProjId
	LEFT JOIN
tblSites S
	ON PT.DefaultLocationForRebuild=S.SiteId
	LEFT JOIN
NEXT_OCC_STRATEGY N
	ON PT.ProjTaskId=N.Proj_Task_Id
WHERE
EPR.Projection_Type_ID=1 AND
(@Level<>1 OR S.BranchId IS NULL OR S.BranchId IN (SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = @UserId)) AND
(@Level<>2 OR PT.DefaultLocationForRebuild IS NULL OR PT.DefaultLocationForRebuild IN (SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = @UserId)) AND

PT.Part_Id>0 AND
(@PartId='' OR PT.Part_Id IN (SELECT list_item FROM @Part)) AND
(@BranchID='' OR PT.DefaultLocationForRebuild IN (SELECT list_item FROM @Site)) AND
(@ComponentCodeId='' OR P.DefaultComponentCodeId IN (SELECT list_item FROM @ComponentCode)) AND
(@PartRatingId='' OR ISNULL(PT.PartRatingId,P.DefaultPartRatingId) IN (SELECT list_item FROM @PartRating)) AND
(@PartTypeId='' OR P.Part_Type_ID IN (SELECT list_item FROM @PartType)) AND
(@SalesStatusId='' OR N.SalesStatusId IN (SELECT list_item FROM @SalesStatus))

GROUP BY O.ProjTaskId,
PT.Part_Id,
CASE @AnalyseBy1 WHEN 1 THEN S.BranchId
WHEN 2 THEN P.DefaultComponentCodeId 
WHEN 3 THEN ISNULL(PT.PartRatingId,P.DefaultPartRatingId)
WHEN 4 THEN P.Part_Type_ID
ELSE -1 END,
CASE @AnalyseBy2 WHEN 1 THEN S.BranchId
WHEN 2 THEN P.DefaultComponentCodeId 
WHEN 3 THEN ISNULL(PT.PartRatingId,P.DefaultPartRatingId)
WHEN 4 THEN P.Part_Type_ID
ELSE -1 END) A
	INNER JOIN
tblProjTaskOccs PTO
	ON A.ProjTaskId=PTO.ProjTaskId
WHERE PTO.OccDate>A.NextOccDate AND
YEAR(PTO.OccDate)*10000+MONTH(PTO.OccDate)*100+DAY(PTO.OccDate)>=@StartDay AND
YEAR(PTO.OccDate)*10000+MONTH(PTO.OccDate)*100+DAY(PTO.OccDate)<@EndDay
GROUP BY  A.PartId,
YEAR(PTO.OccDate)*10000+MONTH(PTO.OccDate)*100+DAY(PTO.OccDate),
A.AnalyseBuId1,A.AnalyseBuId2




/*Changeouts rebuilt and returned to stock*/
/*Look at "Next due" for the next occurrence*/

INSERT INTO #z_Forecast(PartId,Qty,RepDay,AnalyseById1,AnalyseById2)

SELECT ISNULL(N.PEXPartId,PT.Part_Id) AS PartId,1 AS Qty,
dbo.ADD_DAYS_F(MIN(O.OccDate),ISNULL(ISNULL(PA.BudgetTotalTurnTime,P.BudgetTotalTurnTime),0)) AS RepDay,
ISNULL(CASE @AnalyseBy1 WHEN 1 THEN ISNULL(SI.BranchId,S.BranchId)
WHEN 2 THEN ISNULL(PA.DefaultComponentCodeId,P.DefaultComponentCodeId) 
WHEN 3 THEN ISNULL(PT.PartRatingId,ISNULL(PA.DefaultPartRatingId,P.DefaultPartRatingId))
WHEN 4 THEN ISNULL(PA.Part_Type_ID,P.Part_Type_ID)
ELSE -1 END,-1) AS AnalyseBuId1,
ISNULL(CASE @AnalyseBy2 WHEN 1 THEN ISNULL(SI.BranchId,S.BranchId)
WHEN 2 THEN ISNULL(PA.DefaultComponentCodeId,P.DefaultComponentCodeId) 
WHEN 3 THEN ISNULL(PT.PartRatingId,ISNULL(PA.DefaultPartRatingId,P.DefaultPartRatingId))
WHEN 4 THEN ISNULL(PA.Part_Type_ID,P.Part_Type_ID)
ELSE -1 END,-1) AS AnalyseBuId2
FROM
tblProjTasks PT
	INNER JOIN
tblProjTaskOccs O
	ON PT.ProjTaskId=O.ProjTaskId
	LEFT JOIN
tblParts P
	ON  PT.Part_Id=P.PartId
	INNER JOIN
tblEqpProjs EPR
	ON PT.EqpProjId=EPR.EqpProjId
	LEFT JOIN
NEXT_OCC_STRATEGY N
	ON PT.ProjTaskId=N.Proj_Task_Id
	LEFT JOIN
tblParts PA
	ON N.PEXPartId=PA.PartId
	LEFT JOIN
PART_CLASSIFICATION PC
	ON PT.PartClassificationId=PC.PartClassificationId
	LEFT JOIN
PART_CLASSIFICATION PC2
	ON N.PEXPartTypeId=PC2.PartClassificationId
	LEFT JOIN
tblSites S
	ON PT.DefaultLocationForRebuild=S.SiteId
	LEFT JOIN
tblSites SI
	ON N.PEXRebuildLocationId=SI.SiteId
WHERE
EPR.Projection_Type_ID=1 AND
(@Level<>1 OR ISNULL(SI.BranchId,S.BranchId) IS NULL OR ISNULL(SI.BranchId,S.BranchId) IN (SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = @UserId)) AND
(@Level<>2 OR ISNULL(N.PEXRebuildLocationId,PT.DefaultLocationForRebuild) IS NULL OR ISNULL(N.PEXRebuildLocationId,PT.DefaultLocationForRebuild) IN(SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = @UserId)) AND
ISNULL(ISNULL(PC2.CoreRetained,PC.CoreRetained),0)=1 AND
ISNULL(N.PEXPartId ,PT.Part_Id)>0 AND
(@PartId='' OR ISNULL(N.PEXPartId ,PT.Part_Id) IN (SELECT list_item FROM @Part)) AND
(@BranchID='' OR ISNULL(N.PEXRebuildLocationId,PT.DefaultLocationForRebuild) IN (SELECT list_item FROM @Site)) AND
(@ComponentCodeId='' OR ISNULL(PA.DefaultComponentCodeId,P.DefaultComponentCodeId) IN (SELECT list_item FROM @ComponentCode)) AND
(@PartRatingId='' OR ISNULL(PT.PartRatingId,ISNULL(PA.DefaultPartRatingId,P.DefaultPartRatingId)) IN (SELECT list_item FROM @PartRating)) AND
(@PartTypeId='' OR ISNULL(PA.Part_Type_ID,P.Part_Type_ID) IN (SELECT list_item FROM @PartType))
GROUP BY PT.ProjTaskId,ISNULL(PA.BudgetTotalTurnTime,P.BudgetTotalTurnTime),
ISNULL(N.PEXPartId,PT.Part_Id),
CASE @AnalyseBy1 WHEN 1 THEN ISNULL(SI.BranchId,S.BranchId)
WHEN 2 THEN ISNULL(PA.DefaultComponentCodeId,P.DefaultComponentCodeId) 
WHEN 3 THEN ISNULL(PT.PartRatingId,ISNULL(PA.DefaultPartRatingId,P.DefaultPartRatingId))
WHEN 4 THEN ISNULL(PA.Part_Type_ID,P.Part_Type_ID)
ELSE -1 END,
CASE @AnalyseBy2 WHEN 1 THEN ISNULL(SI.BranchId,S.BranchId)
WHEN 2 THEN ISNULL(PA.DefaultComponentCodeId,P.DefaultComponentCodeId) 
WHEN 3 THEN ISNULL(PT.PartRatingId,ISNULL(PA.DefaultPartRatingId,P.DefaultPartRatingId))
WHEN 4 THEN ISNULL(PA.Part_Type_ID,P.Part_Type_ID)
ELSE -1 END
HAVING dbo.ADD_DAYS_F(MIN(O.OccDate),ISNULL(ISNULL(PA.BudgetTotalTurnTime,P.BudgetTotalTurnTime),0)) >=@StartDay AND
dbo.ADD_DAYS_F(MIN(O.OccDate),ISNULL(ISNULL(PA.BudgetTotalTurnTime,P.BudgetTotalTurnTime),0)) <@EndDay


/*Look at Base details for all occurrences thereafter*/
INSERT INTO #z_Forecast(PartId,Qty,RepDay,AnalyseById1,AnalyseById2)

SELECT A.PartId,COUNT(PTO.ProjTaskId) AS Qty,
dbo.ADD_DAYS_F(PTO.OccDate,ISNULL(A.BudgetTotalTurnTime,0)) AS RepDay,
A.AnalyseBuId1,A.AnalyseBuId2
FROM
(SELECT PT.Part_Id AS PartId,PT.ProjTaskId,
ISNULL(CASE @AnalyseBy1 WHEN 1 THEN S.BranchId
WHEN 2 THEN P.DefaultComponentCodeId 
WHEN 3 THEN ISNULL(PT.PartRatingId,P.DefaultPartRatingId)
WHEN 4 THEN P.Part_Type_ID
ELSE -1 END,-1) AS AnalyseBuId1,
ISNULL(CASE @AnalyseBy2 WHEN 1 THEN S.BranchId
WHEN 2 THEN P.DefaultComponentCodeId 
WHEN 3 THEN ISNULL(PT.PartRatingId,P.DefaultPartRatingId)
WHEN 4 THEN P.Part_Type_ID
ELSE -1 END,-1) AS AnalyseBuId2,
MIN(O.OccDate) AS NextOccDate,P.BudgetTotalTurnTime
FROM
tblProjTaskOccs O
	INNER JOIN
tblProjTasks PT
	ON O.ProjTaskId=PT.ProjTaskId
	LEFT JOIN
tblParts P
	ON  PT.Part_Id=P.PartId
	INNER JOIN
tblEqpProjs EPR
	ON PT.EqpProjId=EPR.EqpProjId
	LEFT JOIN
PART_CLASSIFICATION PC
	ON PT.PartClassificationId=PC.PartClassificationId
	LEFT JOIN
tblSites S
	ON PT.DefaultLocationForRebuild=S.SiteId
WHERE
EPR.Projection_Type_ID=1 AND
(@Level<>1 OR S.BranchId IS NULL OR S.BranchId IN (SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = @UserId)) AND
(@Level<>2 OR PT.DefaultLocationForRebuild IS NULL OR PT.DefaultLocationForRebuild IN (SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = @UserId)) AND
ISNULL(PC.CoreRetained,0)=1 AND
PT.Part_Id>0 AND
(@PartId='' OR PT.Part_Id IN (SELECT list_item FROM @Part)) AND
(@BranchID='' OR PT.DefaultLocationForRebuild IN (SELECT list_item FROM @Site)) AND
(@ComponentCodeId='' OR P.DefaultComponentCodeId IN (SELECT list_item FROM @ComponentCode)) AND
(@PartRatingId='' OR ISNULL(PT.PartRatingId,P.DefaultPartRatingId) IN (SELECT list_item FROM @PartRating)) AND
(@PartTypeId='' OR P.Part_Type_ID IN (SELECT list_item FROM @PartType))
GROUP BY
PT.Part_Id,PT.ProjTaskId,P.BudgetTotalTurnTime,
CASE @AnalyseBy1 WHEN 1 THEN S.BranchId
WHEN 2 THEN P.DefaultComponentCodeId 
WHEN 3 THEN ISNULL(PT.PartRatingId,P.DefaultPartRatingId)
WHEN 4 THEN P.Part_Type_ID
ELSE -1 END,
CASE @AnalyseBy2 WHEN 1 THEN S.BranchId
WHEN 2 THEN P.DefaultComponentCodeId 
WHEN 3 THEN ISNULL(PT.PartRatingId,P.DefaultPartRatingId)
WHEN 4 THEN P.Part_Type_ID
ELSE -1 END) A
	INNER JOIN
tblProjTaskOccs PTO
	ON A.ProjTaskId=PTO.ProjTaskId
WHERE A.NextOccDate<PTO.OccDate AND
dbo.ADD_DAYS_F(PTO.OccDate,ISNULL(A.BudgetTotalTurnTime,0)) >=@StartDay AND
dbo.ADD_DAYS_F(PTO.OccDate,ISNULL(A.BudgetTotalTurnTime,0)) <@EndDay
GROUP BY A.PartId,
dbo.ADD_DAYS_F(PTO.OccDate,ISNULL(A.BudgetTotalTurnTime,0)),
A.AnalyseBuId1,A.AnalyseBuId2


CREATE TABLE #z_Stock(PartId int,AnalyseById1 int,AnalyseById2 int,Interval int,Qty float)

INSERT INTO #z_Stock(PartId,AnalyseById1,AnalyseById2,Interval,Qty)
SELECT Z.PartId,Z.AnalyseById1,Z.AnalyseById2,I.Interval,SUM(Z.Qty) AS Qty
FROM 
#z_Forecast Z
	INNER JOIN
#z_Intervals I
	ON Z.RepDay>=I.StartInterval
	AND Z.RepDay<I.EndInterval
GROUP BY Z.PartId,Z.AnalyseById1,Z.AnalyseById2,I.Interval
	
	
--select * into z_Forecast from #z_Forecast
--select * into z_Intervals from #z_Intervals
--return


/*Analyse By*/
CREATE TABLE #z_AnalyseBy1(AnalyseById int, AnalyseBy varchar(200) COLLATE DATABASE_DEFAULT
PRIMARY KEY(AnalyseById))
CREATE TABLE #z_AnalyseBy2(AnalyseById int, AnalyseBy varchar(200) COLLATE DATABASE_DEFAULT
PRIMARY KEY(AnalyseById))

IF @AnalyseBy1>0
BEGIN
	INSERT INTO #z_AnalyseBy1(AnalyseById, AnalyseBy) 
	SELECT B.BranchId AS AnalyseById,B.Branch AS AnalyseBy
	FROM tblBranches B
	WHERE @AnalyseBy1=1 AND BranchId IN (SELECT AnalyseById1 FROM #z_Stock)
	
	UNION ALL
	
	SELECT B.ComponentCodeID AS AnalyseById,B.Code+' - '+B.Description AS AnalyseBy
	FROM tblComponentCodes B
	WHERE @AnalyseBy1=2 AND b.ComponentCodeID IN (SELECT AnalyseById1 FROM #z_Stock)
	
	UNION ALL
	
	SELECT B.PartRatingId AS AnalyseById,B.PartRating AS AnalyseBy
	FROM PART_RATING B
	WHERE @AnalyseBy1=3 AND PartRatingId IN (SELECT AnalyseById1 FROM #z_Stock)
	
	UNION ALL
	
	SELECT B.PartTypeId AS AnalyseById,B.PartType+' - '+B.PartTypeDesc AS AnalyseBy
	FROM tblPartTypes B
	WHERE @AnalyseBy1=4 AND B.PartTypeId IN (SELECT AnalyseById1 FROM #z_Stock)
	
END


IF @AnalyseBy2>0
BEGIN
	INSERT INTO #z_AnalyseBy2(AnalyseById, AnalyseBy) 
	SELECT B.BranchId AS AnalyseById,B.Branch AS AnalyseBy
	FROM tblBranches B
	WHERE @AnalyseBy2=1 AND BranchId IN (SELECT AnalyseById2 FROM #z_Stock)
	
	UNION ALL
	
	SELECT B.ComponentCodeID AS AnalyseById,B.Code+' - '+B.Description AS AnalyseBy
	FROM tblComponentCodes B
	WHERE @AnalyseBy2=2 AND b.ComponentCodeID IN (SELECT AnalyseById2 FROM #z_Stock)
	
	UNION ALL
	
	SELECT B.PartRatingId AS AnalyseById,B.PartRating AS AnalyseBy
	FROM PART_RATING B
	WHERE @AnalyseBy2=3 AND PartRatingId IN (SELECT AnalyseById2 FROM #z_Stock)
	
	UNION ALL
	
	SELECT B.PartTypeId AS AnalyseById,B.PartType+' - '+B.PartTypeDesc AS AnalyseBy
	FROM tblPartTypes B
	WHERE @AnalyseBy2=4 AND B.PartTypeId IN (SELECT AnalyseById2 FROM #z_Stock)
	
END


/*All Combinations*/
SELECT A.PartId,A.AnalyseById1,A.AnalyseById2,I.Interval
INTO #z_AllCombinations
FROM
(SELECT DISTINCT PartId,AnalyseById1,AnalyseById2 FROM #z_Stock) A
	CROSS JOIN
#z_Intervals I

/*VV need this table because of the bug in SQL server*/
SELECT A.PartId,A.AnalyseById1,A.AnalyseById2,A.Interval
INTO #z_MissingIntervals
FROM
#z_AllCombinations A
	LEFT JOIN
#z_Stock S
	ON A.PartId=S.PartId
	AND A.AnalyseById1=S.AnalyseById1
	AND A.AnalyseById2=S.AnalyseById2
	AND A.Interval=S.Interval
WHERE A.Interval>0 AND S.PartId IS NULL

INSERT INTO #z_Stock(PartId,AnalyseById1,AnalyseById2,Interval,Qty)
SELECT PartId,AnalyseById1,AnalyseById2,Interval,0 AS Qty FROM #z_MissingIntervals

DROP TABLE #z_MissingIntervals


UPDATE Z SET Z.Qty=B.Qty
FROM
#z_Stock Z
	INNER JOIN
(SELECT S.PartId,S.AnalyseById1,S.AnalyseById2,S.Interval,SUM(A.Qty) AS Qty
FROM
#z_Stock A
	INNER JOIN
#z_Stock S
	ON A.PartId=S.PartId
	AND A.AnalyseById1=S.AnalyseById1
	AND A.AnalyseById2=S.AnalyseById2
	AND A.Interval<=S.Interval
GROUP BY S.PartId,S.AnalyseById1,S.AnalyseById2,S.Interval) B
	ON Z.PartId=B.PartId
	AND Z.AnalyseById1=B.AnalyseById1
	AND Z.AnalyseById2=B.AnalyseById2
	AND Z.Interval=B.Interval


/*All Data*/
CREATE TABLE #z_AllData(PartId int,AnalyseById1 int,AnalyseById2 int,Interval int,Qty float)

/*Total Period Demand*/	
INSERT INTO #z_AllData(PartId,AnalyseById1,AnalyseById2,Interval,Qty)
SELECT B.PartId,B.AnalyseById1,B.AnalyseById2,B.Interval,ISNULL(A.Qty,0) AS Qty
FROM
#z_AllCombinations B
	LEFT JOIN
(SELECT Z.PartId,Z.AnalyseById1,Z.AnalyseById2,ABS(SUM(Z.Qty)) AS Qty,-4 AS Interval
FROM #z_Forecast Z WHERE Z.Qty<0
GROUP BY Z.PartId,Z.AnalyseById1,Z.AnalyseById2) A
	ON B.PartId=A.PartId
	AND B.AnalyseById1=A.AnalyseById1
	AND B.AnalyseById2=A.AnalyseById2
	AND B.Interval=A.Interval
WHERE B.Interval=-4

/*Average Stock Level*/
INSERT INTO #z_AllData(PartId,AnalyseById1,AnalyseById2,Interval,Qty)
SELECT B.PartId,B.AnalyseById1,B.AnalyseById2,B.Interval,ISNULL(A.Qty,0) AS Qty
FROM
#z_AllCombinations B
	LEFT JOIN
(SELECT Z.PartId,Z.AnalyseById1,Z.AnalyseById2,SUM(Z.Qty)/CAST(@IntervalNumber AS float) AS Qty,
-3 AS Interval
FROM #z_Stock Z
GROUP BY Z.PartId,Z.AnalyseById1,Z.AnalyseById2) A
	ON B.PartId=A.PartId
	AND B.AnalyseById1=A.AnalyseById1
	AND B.AnalyseById2=A.AnalyseById2
	AND B.Interval=A.Interval
WHERE B.Interval=-3
	
/*Minimum Stock Level*/
INSERT INTO #z_AllData(PartId,AnalyseById1,AnalyseById2,Interval,Qty)
SELECT B.PartId,B.AnalyseById1,B.AnalyseById2,B.Interval,ISNULL(A.Qty,0) AS Qty
FROM
#z_AllCombinations B
	LEFT JOIN
(SELECT Z.PartId,Z.AnalyseById1,Z.AnalyseById2,MIN(Z.Qty) AS Qty,-2 AS Interval
FROM #z_Stock Z
GROUP BY Z.PartId,Z.AnalyseById1,Z.AnalyseById2) A
	ON B.PartId=A.PartId
	AND B.AnalyseById1=A.AnalyseById1
	AND B.AnalyseById2=A.AnalyseById2
	AND B.Interval=A.Interval
WHERE B.Interval=-2


/*Annualised Stock Turn*/
INSERT INTO #z_AllData(PartId,AnalyseById1,AnalyseById2,Interval,Qty)
SELECT C.PartId,C.AnalyseById1,C.AnalyseById2, -1 AS Interval,
365.35*ISNULL(B.Qty/NULLIF(A.Qty,0)/NULLIF(@NumberOfDays,0),0) AS Qty
FROM
#z_AllCombinations C
	LEFT JOIN
(SELECT Z.PartId,Z.AnalyseById1,Z.AnalyseById2,ABS(SUM(Z.Qty)) AS Qty,-4 AS Interval
FROM #z_Forecast Z WHERE Z.Qty<0
GROUP BY Z.PartId,Z.AnalyseById1,Z.AnalyseById2) B
	ON C.PartId=B.PartId
	AND C.AnalyseById1=B.AnalyseById1
	AND C.AnalyseById2=B.AnalyseById2
	
	LEFT JOIN
(SELECT Z.PartId,Z.AnalyseById1,Z.AnalyseById2,SUM(Z.Qty)/CAST(@IntervalNumber AS float) AS Qty,
-3 AS Interval
FROM #z_Stock Z
GROUP BY Z.PartId,Z.AnalyseById1,Z.AnalyseById2) A
	ON C.PartId=A.PartId
	AND C.AnalyseById1=A.AnalyseById1
	AND C.AnalyseById2=A.AnalyseById2
WHERE C.Interval=-1

	
/*Qty on Hand*/
INSERT INTO #z_AllData(PartId,AnalyseById1,AnalyseById2,Interval,Qty)
SELECT B.PartId,B.AnalyseById1,B.AnalyseById2,B.Interval,ISNULL(A.Qty,0) AS Qty
FROM
#z_AllCombinations B
	LEFT JOIN
#z_Stock A
	ON B.PartId=A.PartId
	AND B.AnalyseById1=A.AnalyseById1
	AND B.AnalyseById2=A.AnalyseById2
	AND B.Interval=A.Interval
WHERE B.Interval>0

DROP TABLE #z_AllCombinations, #z_Forecast,#z_Stock


CREATE TABLE #z_MinStockLevel(PartId int,AnalyseById1 int,AnalyseById2 int PRIMARY KEY(PartId,AnalyseById1,AnalyseById2))
CREATE TABLE #z_TotalPeriodDemand(PartId int,AnalyseById1 int,AnalyseById2 int PRIMARY KEY(PartId,AnalyseById1,AnalyseById2))
CREATE TABLE #z_AverageStockLevel(PartId int,AnalyseById1 int,AnalyseById2 int PRIMARY KEY(PartId,AnalyseById1,AnalyseById2))
CREATE TABLE #z_AnnualisedStockTurnLess(PartId int,AnalyseById1 int,AnalyseById2 int PRIMARY KEY(PartId,AnalyseById1,AnalyseById2))
CREATE TABLE #z_AnnualisedStockTurnGreater(PartId int,AnalyseById1 int,AnalyseById2 int PRIMARY KEY(PartId,AnalyseById1,AnalyseById2))

IF @ApplyMinStockLevel=1 INSERT INTO #z_MinStockLevel(PartId,AnalyseById1,AnalyseById2) SELECT DISTINCT PartId,AnalyseById1,AnalyseById2 FROM #z_AllData WHERE Interval=-2 AND Qty<=@MinStockLevel
IF @ApplyTotalPeriodDemand=1 INSERT INTO #z_TotalPeriodDemand(PartId,AnalyseById1,AnalyseById2) SELECT DISTINCT PartId,AnalyseById1,AnalyseById2 FROM #z_AllData WHERE Interval=-4 AND Qty<=@TotalPeriodDemand
IF @ApplyAverageStockLevel=1 INSERT INTO #z_AverageStockLevel(PartId,AnalyseById1,AnalyseById2) SELECT DISTINCT PartId,AnalyseById1,AnalyseById2 FROM #z_AllData WHERE Interval=-3 AND Qty<=@AverageStockLevel
IF @ApplyAnnualisedStockTurnLess=1 INSERT INTO #z_AnnualisedStockTurnLess(PartId,AnalyseById1,AnalyseById2) SELECT DISTINCT PartId,AnalyseById1,AnalyseById2 FROM #z_AllData WHERE Interval=-1 AND Qty<=@AnnualisedStockTurnLess
IF @ApplyAnnualisedStockTurnGreater=1 INSERT INTO #z_AnnualisedStockTurnGreater(PartId,AnalyseById1,AnalyseById2) SELECT DISTINCT PartId,AnalyseById1,AnalyseById2 FROM #z_AllData WHERE Interval=-1 AND Qty>=@AnnualisedStockTurnGreater

/*<Item>6,Minimum Stock Level</Item>
<Item>7,Total Period Demand</Item>
<Item>8,Average Stock Level</Item>
<Item>9,Annualised Stock Turn</Item>*/

CREATE TABLE #z_SortBy(ListId int IDENTITY(1,1),PartId int,AnalyseById1 int,AnalyseById2 int PRIMARY KEY(ListId))
/*Minimum Stock Level*/
IF @SortBy='6' INSERT INTO #z_SortBy(PartId,AnalyseById1,AnalyseById2) SELECT PartId,AnalyseById1,AnalyseById2 FROM #z_AllData WHERE Interval=-2 ORDER BY Qty

/*Total Period Demand*/
IF @SortBy='7' INSERT INTO #z_SortBy(PartId,AnalyseById1,AnalyseById2) SELECT PartId,AnalyseById1,AnalyseById2 FROM #z_AllData WHERE Interval=-4 ORDER BY Qty

/*Average Stock Level*/
IF @SortBy='8' INSERT INTO #z_SortBy(PartId,AnalyseById1,AnalyseById2) SELECT PartId,AnalyseById1,AnalyseById2 FROM #z_AllData WHERE Interval=-3 ORDER BY Qty

/*Annualised Stock Turn*/
IF @SortBy='9' INSERT INTO #z_SortBy(PartId,AnalyseById1,AnalyseById2) SELECT PartId,AnalyseById1,AnalyseById2 FROM #z_AllData WHERE Interval=-1 ORDER BY Qty


SELECT P.Part,P.PartDescription, A1.AnalyseBy AS AnalyseBy1,
A2.AnalyseBy AS AnalyseBy2,I.Interval,
CASE WHEN I.Interval<0 THEN NULL ELSE 
CAST(CAST(CASE WHEN @EndDay<I.EndInterval THEN @EndDay ELSE I.EndInterval END AS varchar(50)) AS datetime)
END AS IntervalDesc,
B.Qty,@AnalyseBy1 AS AnalyseById1,@AnalyseBy2 AS AnalyseById2
FROM 
#z_AllData B
	INNER JOIN
#z_Intervals I
	ON B.Interval=I.Interval
	INNER JOIN
tblParts P
	ON B.PartId=P.PartId
	LEFT JOIN
#z_AnalyseBy1 A1
	ON B.AnalyseById1=A1.AnalyseById
	LEFT JOIN
#z_AnalyseBy2 A2
	ON B.AnalyseById2=A2.AnalyseById
	LEFT JOIN
#z_MinStockLevel
	ON B.PartId=#z_MinStockLevel.PartId
	AND B.AnalyseById1=#z_MinStockLevel.AnalyseById1
	AND B.AnalyseById2=#z_MinStockLevel.AnalyseById2
	LEFT JOIN
#z_TotalPeriodDemand
	ON B.PartId=#z_TotalPeriodDemand.PartId
	AND B.AnalyseById1=#z_TotalPeriodDemand.AnalyseById1
	AND B.AnalyseById2=#z_TotalPeriodDemand.AnalyseById2
	LEFT JOIN
#z_AverageStockLevel
	ON B.PartId=#z_AverageStockLevel.PartId
	AND B.AnalyseById1=#z_AverageStockLevel.AnalyseById1
	AND B.AnalyseById2=#z_AverageStockLevel.AnalyseById2
	LEFT JOIN
#z_AnnualisedStockTurnLess
	ON B.PartId=#z_AnnualisedStockTurnLess.PartId
	AND B.AnalyseById1=#z_AnnualisedStockTurnLess.AnalyseById1
	AND B.AnalyseById2=#z_AnnualisedStockTurnLess.AnalyseById2
	LEFT JOIN
#z_AnnualisedStockTurnGreater
	ON B.PartId=#z_AnnualisedStockTurnGreater.PartId
	AND B.AnalyseById1=#z_AnnualisedStockTurnGreater.AnalyseById1
	AND B.AnalyseById2=#z_AnnualisedStockTurnGreater.AnalyseById2
	LEFT JOIN
#z_SortBy
	ON B.PartId=#z_SortBy.PartId
	AND B.AnalyseById1=#z_SortBy.AnalyseById1
	AND B.AnalyseById2=#z_SortBy.AnalyseById2
WHERE (@ApplyMinStockLevel=0 OR #z_MinStockLevel.PartId>0)
AND (@ApplyTotalPeriodDemand=0 OR #z_TotalPeriodDemand.PartId>0)
AND (@ApplyAverageStockLevel=0 OR #z_AverageStockLevel.PartId>0)
AND (@ApplyAnnualisedStockTurnLess=0 OR #z_AnnualisedStockTurnLess.PartId>0)
AND (@ApplyAnnualisedStockTurnGreater=0 OR #z_AnnualisedStockTurnGreater.PartId>0)
ORDER BY 
CASE @SortBy 
/*Part Number*/
WHEN '1' THEN CAST(P.Part AS sql_variant)

/*Part Description*/
WHEN '2' THEN CAST(P.PartDescription AS sql_variant)

/*Branch*/
WHEN '3' THEN CASE WHEN @AnalyseBy1=1 THEN CAST(A1.AnalyseBy AS sql_variant)
				   WHEN @AnalyseBy2=1 THEN CAST(A2.AnalyseBy AS sql_variant)
				   ELSE CAST('' AS sql_variant) END
				   
/*Default Component Code*/
WHEN '4' THEN CASE WHEN @AnalyseBy1=2 THEN CAST(A1.AnalyseBy AS sql_variant)
				   WHEN @AnalyseBy2=2 THEN CAST(A2.AnalyseBy AS sql_variant)
				   ELSE CAST('' AS sql_variant) END
				   
/*Part Type*/
WHEN '5' THEN CASE WHEN @AnalyseBy1=4 THEN CAST(A1.AnalyseBy AS sql_variant)
				   WHEN @AnalyseBy2=4 THEN CAST(A2.AnalyseBy AS sql_variant)
				   ELSE CAST('' AS sql_variant) END
/*VV #4128 Part Rating*/
WHEN '10' THEN CASE WHEN @AnalyseBy1=3 THEN CAST(A1.AnalyseBy AS sql_variant)
				   WHEN @AnalyseBy2=3 THEN CAST(A2.AnalyseBy AS sql_variant)
				   ELSE CAST('' AS sql_variant) END
				   
/*Minimum Stock Level*/
WHEN '6' THEN CAST(#z_SortBy.ListId AS sql_variant)

/*Total Period Demand*/
WHEN '7' THEN CAST(#z_SortBy.ListId AS sql_variant)

/*Average Stock Level*/
WHEN '8' THEN CAST(#z_SortBy.ListId AS sql_variant)

/*Annualised Stock Turn*/
WHEN '9' THEN CAST(#z_SortBy.ListId AS sql_variant)
				   				   
ELSE CAST('' AS sql_variant) END,
P.Part,P.PartDescription,A1.AnalyseBy,A2.AnalyseBy

	

	
GO


if exists (select * from dbo.sysobjects where id = object_id(N'usp_Update_AMTWorkOrderExternal') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure usp_Update_AMTWorkOrderExternal
GO

create Procedure [dbo].[usp_Update_AMTWorkOrderExternal]
/******************************************************************************
	File: usp_Update_AMTWorkOrderExternal.sql
	Name: usp_Update_AMTWorkOrderExternal

	Called By: WorkOrderPut.cls (UpdateExternal  method)

	Desc: Update Work Order (called from the IMPORT PROCESS ONLY)

	Auth:  Harpreet Singh	
	Date: 30 May 2002
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	18 Apr 12	K Nagarajan	3296: Fixed the Job Status Rules for Transaction based Workorder.
	____________________________________________OLD HIS--------------
	07 Aug 07	K Nagarajan	Changed the length of SchedulingTask field to 30
	 3 Aug 07	V Vasylyeva	If workorder is linked to EQS task do not reset application
							code(CR6397)
	24 Jul 06	SI		Removed usp_DuplicateWorkOrder
	9 Jun 02		H Singh		new parameter MaintPlanId NULL

	7 Jun 02		H Singh		AMT parentworkorder and AMT Comp Code Combination is set as default 0

	20 Jun 02		R Feyder		Include Start Date and End Date
							** TO DO ** Bring this data in from the VB Code

	10 Jul 02		R Feyder		Include Maintenance Plan logic
							- update AMT Start Date (and Maintenance Plan)
								- STATUS <> CRTD
								- Start Date > Current Date (ie GetDate())
								- Linked Maintenance Plan
							- update AMT Start Date for workorders done in the past
							- update Proj Task Next Occ Date for REleased WO in the FUture

	16 Jul 02	HS,RF		new parameters startDate and Enddate	
	22 Jul 02	HS		    logic to update 6 code combinations is added						

	25 NOV 02	RF	Fix for updating workorders based on:
					- linked tasks
					- new dates coming through not updating the workorder.

	24 FEB 03		RF		Update START DATE calculation for WO no longer in CRTD status.
						Also include logic for INVOICED WO (ie does not have SAP "CRTD" state

	27 FEB 03		RF		Always call DUPLICATE Workorder before running update.	
						Do NOT update the Current/Archived flags.

	28 FEB 03		RF		Do NOT update AMTParentWorkorderID

	3 MARCH 03	RF		Fix up correct WO Start Date.
						Fix up MP WO that may have the incorrect start date.

	06 MARCH 03	RF		Make the NEWWorkorderID optional
    	18 Jul 03	HS			call to add Task Header id
	20 Jan 04	VV	New fields Ext_Source_ID, Ext_Segment_ID,WO_Description, Parts_In_Stock
	15-Mar-2004		DS		Fix for multiple serial numbers
	22-Mar-2004	VV	Changed @ExtSourceID varchar(20)=NULL,
				        @ExtSegmentID varchar(20)=NULL,
	22 Oct 2004	VV	Unlink workorder from the task if equipment plan number has been changed
	10 May 2005 	SB	Removed code which doesn't use any more with tblMntPlans table
	16 May 2005	SB	Changed to new business logic for reimport WOs
	12 Sep 2005	SI	Changed to support Ellipse interface
	17 Oct 2005	SI	Changed the way of AMTJobStatus_ID and @AmtStartDate processing
	09 Feb 2006	SI	Now AMTJobStatus_ID is always updated for Ellipse regardless to WorkOrderStatus
				and AMTStartDate is used instead of StartDate
	27 Oct 2006	KN	Added REgCounter and Model
	24 May 07	SI			Added new fields @OverheadGroup, @OccurrenceType, @Symptom, @Cause
	11 Mar 08	DS	For external work orders job code is always set externally (ie. NOT from the EQS task)
	15 Apr 08	DS	If WO Description is not provided, then do not update it
	22 Sep 08	AL			CR7216: Reallocate to correct equipment against registration counter
	03 Jul 2009	KN		Changed the Length of WODescription to 5000
	17 Jul 2009	KN		Make sure AMTStartDate is not in FUTURE
	 7 Jun 2010	VV	CR8959 New parameters
	12 Oct 2010	VV	#682 Error in import
	24 Mar 2011	GD	changed the length of EquipmentNo from 12 to 50
	18 Apr 2011 GD	Changed the length of @WorkgroupResponsible from 12 to 50

*******************************************************************************/
	/* Param List */
	@WorkOrderId int,
	@WorkOrderNumber varchar(50)=null,
	@WorkOrderTypeId int,  
	@WorkOrderStatusId int,
	@StartDate datetime,
	@AmtStartDate datetime,
	@EndDate datetime, 	        
	@EqpPlanId int=null,
	@SerialNumber varchar(50)=null, 
	@ComponentSerialNumber varchar(50)=null, 
	@CustomerId int=null, 
	@Plant varchar(50)=null, 
	@BranchId int=null, 
	@CurrencyId int, 
	@ExchangeRate float, 
	@MaintenancePlanNumber varchar(50)=null,
	@MaintenancePlanItemNumber varchar(50)=null, 
	@MaintPlanCallNumber int=null,
	@ParentWorkOrderNumber varchar(50)=null, 
	@ComponentCodeId int=null,
	@ModifierId int=null,
	@TaskTypeId int=null,
	@ApplicationCodeId int=null,
	@OccurrenceTypeId int=null,
	@JobCodeId int=null,
	@Changeout int=null,
	@WorkActivityCode varchar(50)=null,
	@DutyFreeWorkOrderNumber varchar(50)=null,
	@NotificationNumber varchar(50) = null,
	@PMActivityTypeId varchar(50)=null, 
	@AMTParentWorkOrderId int,
	@AMTComponentCodeId int, 
	@AMTModifierId int, 
	@AMTJobCodeId int, 
	@AMTTaskTypeId int,

	@AMTApplicationCodeId int, 
	@AMTOccurrenceTypeId int=null,
	@AMTChangeout int=null,
	@PricedJobId int=null,
	@CurrentWorkOrder int=null,
	@ArchivedWorkOrder int=null,
	@CreatedInAMT int=null,
	@AMTWorkOrderStatusId int=null, 
	@UserId int,
	@MaintPlanId int=null,
	-- RF 6 MAR 03
	--	@NewWorkorderID int OUTPUT
	@NewWorkorderID int = NULL OUTPUT,

	@ExtSourceID varchar(20)=NULL,
	@ExtSegmentID varchar(20)=NULL,
	@WODescr varchar(5000)=NULL,
	@PartsInStock bit=0,
	-- new fields for the Ellipse interface
	@EquipmentNo varchar(50)=NULL,
	@SchedulingTask varchar(30)=NULL,
	@System_Source varchar(10)=NULL,
	@AMTJobStatus_ID int=NULL,
	@Model	varchar(50)=NULL,
	@Reg_Counter	varchar(20)=NULL,

	@OverheadGroup varchar(50) = NULL, 
	@OccurrenceType varchar(10) = NULL, 
	@Symptom varchar(100) = NULL, 
	@Cause varchar(100) = NULL,
	/*VV CR8959*/
	@PlanningStatus varchar(10)=NULL,
	@PlannedStartTime datetime=NULL,
	@PlannedEndTime datetime=NULL,
	@JobReady bit=0,
	@WeeklyPlan varchar(50)=NULL,
	@TargetDate datetime=NULL,
	@Priority varchar(10)=NULL,
	@PlannedDuration float=0,
	@PlannedLabourHours float=0,
	@Employee varchar(50)=NULL,
	@Source varchar(50)=NULL,
	@RaisedBy varchar(50)=NULL,
	@DateNotified datetime=NULL,
	@SIMSCode varchar(10)=NULL,
	@RepairDescription varchar(8000)=NULL,
	@WorkgroupResponsible varchar(50)=NULL,
	@WorkgroupResponsibleSite varchar(50)=NULL,
	@CheckForTransactionbasedStatus bit = 0

AS
/* Local procedure variables */ 
	DECLARE @Error_Number int 
	DECLARE @Message varchar(2000)

	IF @CheckForTransactionbasedStatus = 1 AND 	EXISTS (SELECT Use_Transaction_WO_Costs FROM AMT_VARIABLE WHERE Use_Transaction_WO_Costs= 1)
		BEGIN
			SET @AMTJobStatus_ID = 3 
		END 
		

/* 22 Jul 2002 H Singh------*/
	DECLARE	@CCID int
	DECLARE	@OldAmtCCID int

	DECLARE	@MCID int
	DECLARE	@OldAmtMCID int

	DECLARE @ACID int
	DECLARE	@OldAmtACID int

	DECLARE	@TTID int
	DECLARE	@OldAmtTTID int

	DECLARE	@OTID int
	DECLARE	@OldAmtOTID int

	DECLARE	@JCID int
	DECLARE	@OldAmtJCID int

	DECLARE @OldAMTStartDate datetime
	DECLARE @OldReviewed int

	DECLARE @Task_ID int

	DECLARE @OldAMTJobStatusID int
	DECLARE @AMTJobStatusID int
	DECLARE @OldWorkOrderStatusId int
	DECLARE @Today datetime
	DECLARE @oldEqpPlanId INTEGER
	
	/*VV8959*/
DECLARE @PlanningStatusId int,@WorkgroupResponsibleSiteId int,@WorkgroupResponsibleId int
DECLARE @PriorityId int,@EmployeeId int,@SourceId int,@RaisedById int,@SIMSCodeId int

IF ISNULL(@PlanningStatus,'')<>'' SELECT @PlanningStatusId=PlanningStatusId FROM PLANNING_STATUS WHERE PlanningStatus=@PlanningStatus

SET @JobReady=ISNULL(@JobReady,0)
SET @WeeklyPlan=NULLIF(@WeeklyPlan,'')

IF ISNULL(@Priority,'')<>'' SELECT @PriorityId=Priority_ID FROM PRIORITY WHERE Short_Description=@Priority

SET @PlannedDuration =ISNULL(@PlannedDuration,0)
SET @PlannedLabourHours =ISNULL(@PlannedLabourHours,0)
IF ISNULL(@Employee,'')<>'' SELECT @EmployeeId=Employee_ID FROM EMPLOYEE WHERE EmployeeNumber=@Employee
IF ISNULL(@Source,'')<>'' SELECT @SourceId=Source_ID FROM SOURCE WHERE Description=@Source
IF ISNULL(@RaisedBy,'')<>'' SELECT @RaisedById=Employee_ID FROM EMPLOYEE WHERE EmployeeNumber=@RaisedBy
IF ISNULL(@SIMSCode,'')<>'' SELECT @SIMSCodeId=SIMS_Code_Id FROM SIMS_CODE WHERE SIMS_Code=@SIMSCode


SET @RepairDescription= NULLIF(@RepairDescription,'')

/******************************************************/

--	SET @WODescr =NULLIF(@WODescr,'')
	IF @WODescr = '' SET @WODescr = NULL

	SET @PartsInStock =ISNULL(@PartsInStock,0)

	SET	@OverheadGroup = ISNULL(NULLIF(@OverheadGroup,''),'Default')
	SET	@OccurrenceType = NULLIF(@OccurrenceType,'')
	SET	@Symptom = NULLIF(@Symptom,'')
	SET	@Cause = NULLIF(@Cause,'')

-- 15-Mar-2004 DS
	DECLARE @oldSerialNumber VARCHAR(50)

----RF 27 Feb 03
-- 	EXEC usp_DuplicateWorkOrder
-- 		@piWorkOrderId = @WorkOrderId,
-- 		@piNewWorkOrderId = @NewWorkOrderId OUTPUT
	SET @NewWorkOrderId = @WorkOrderId

	SET @Today = convert(datetime, convert(varchar, day(GETDATE()+1))+'/'+convert(varchar,month(GETDATE()+1))+'/'+convert(varchar, year(GETDATE()+1)),103)
	SELECT 
		@OldAmtCCID = AMTComponentCodeId, 
		@OldAmtMCID = AMTModifierId, 
		@OldAmtACID = AMTApplicationCodeId,
		@OldAmtTTID = AMTTaskTypeId, 
		@OldAmtOTID = AMTOccurrenceTypeId,
		@OldAmtJCID = AMTJobCodeId,
		-- RF 20 Nov 02 ---------------------------------------
		@OldAMTStartDate = AMTStartDate,
		@OldReviewed = ISNULL(Reviewed,0),
		--- SB 16 May 05-----------------------------------------
		@OldAMTJobStatusID = AMTJobStatus_ID,
		@OldWorkOrderStatusId = WorkOrderStatusId
	FROM tblWorkorders 
	WHERE WorkOrderId = @NewWorkorderId	

	SELECT @oldEqpPlanId = ISNULL(EqpPlanId, 0)
	FROM
		tblWorkOrders
	WHERE
		WorkOrderId = @WorkOrderId
	
	SET @Task_ID=(SELECT Task_ID FROM TASK WHERE (Work_Order_ID = @NewWorkorderId) AND (Eqp_Plan_ID = @oldEqpPlanId))

	IF @oldEqpPlanId <> @EqpPlanId
	BEGIN
		IF @Task_ID>0
		--Unlink WorkOrder from the task
			EXEC TASK_WORK_ORDER_LINK_P
				@Task_ID=@Task_ID,
				@Event_ID=NULL,
				@Eqp_Plan_ID=NULL,
				@Task_Type_ID=NULL,
				@Component_Code_ID=NULL,
				@Modifier_ID=NULL,
				@Application_Code_ID=NULL,
				@Occurrence_Type_Id=NULL,
				@Work_Order_ID=NULL,
				@Delete_Work_Order_Id=0,
				@Error_Number=@Error_Number OUTPUT,
				@Message=@Message OUTPUT
		SET @OldReviewed = 0
		SET @Task_ID = 0
	END

	IF (@Task_ID>0) OR (@OldReviewed <> 0)
	BEGIN
		SET @CCID = @OldAmtCCID			
		SET @MCID = @OldAmtMCID	
		SET @ACID = @OldAmtACID -- VV 03-Aug-2007 @AMTApplicationCodeId
		SET @TTID = @OldAmtTTID
		SET @AmtStartDate = @OldAMTStartDate
		IF @EndDate < @OldAMTStartDate
			SET @EndDate = @OldAMTStartDate
		--SET @OTID = @AMTOccurrenceTypeId
		--SET @JCID = @AMTJobCodeId
		SET @OTID = @AMTOccurrenceTypeId
		SET @JCID = @JobCodeId --DS 2008-03-11: For external WOs, Job Code is always set externally
		SET @AMTJobStatusID = @OldAMTJobStatusID
	END
	ELSE
	BEGIN
		SET @CCID = ISNULL(@ComponentCodeId,0)
		SET @MCID = ISNULL(@ModifierId,0)
		SET @ACID = ISNULL(@ApplicationCodeId,0)
		SET @TTID = ISNULL(@TaskTypeId,0)
		--SET @AmtStartDate = @StartDate
		IF @EndDate < @StartDate
			SET @EndDate = @StartDate
		SET @OTID = @OccurrenceTypeId
		SET @JCID = @JobCodeId
		
		IF @AMTJobStatus_ID IS NOT NULL --Ellipse 
			SET @AMTJobStatusID = @AMTJobStatus_ID
		ELSE 
			SET @AMTJobStatusID = (CASE WHEN @AMTStartDate < @Today AND @AMTWorkOrderStatusId = 2 THEN 2 ELSE 3 END)
			
			
	
			--IF @OldWorkOrderStatusId = 4 
			--	SET @AMTJobStatusID = @OldAMTJobStatusID
			--ELSE
			--IF @AMTJobStatus_ID IS NOT NULL --Ellipse 
			--	SET @AMTJobStatusID = @AMTJobStatus_ID
			--ELSE 
				--SET @AMTJobStatusID = (CASE WHEN @StartDate < @Today AND @AMTWorkOrderStatusId = 2 THEN 2 ELSE 3 END)
				--SET @AMTJobStatusID = (CASE WHEN @StartDate < @Today AND @WorkOrderStatusId = 4 THEN 2 ELSE 3 END)
	END

--HS 18 Jul 03 add task_header_id
	DECLARE  @Task_Header_Id as int
	EXEC TASK_HEADER_MANAGER_P   @CCID,  @MCID,  @TTID,  @ACID, @Task_Header_Id output

--AL: 22/09/08 CR7216
/*
--************************************************************
-- DS 18-Jul-2003, 15-Mar-2004 (fix was missing from Sourcesafe!)
-- ...fix for 'multiple serial numbers' (CR2990)
--
SELECT
	@oldSerialNumber = SerialNumber,
	@oldEqpPlanId = EqpPlanId
FROM
	tblWorkOrders
WHERE
	WorkOrderId = @WorkOrderId

IF (@oldSerialNumber = @SerialNumber) AND (@oldEqpPlanId > 0) BEGIN
	SET @EqpPlanId = @oldEqpPlanId
END
--************************************************************
*/


DECLARE @System_Source_Id int
SET @System_Source_Id=NULL
SELECT @System_Source_Id=System_Source_ID FROM SYSTEM_SOURCE WHERE System_Source_Code=@System_Source
-- Add System_Source if it's a new one
IF (@System_Source_Id IS NULL) AND (ISNULL(@System_Source,'')<>'') BEGIN 
   INSERT SYSTEM_SOURCE
	(System_Source_Code, Last_Mod_By_User_ID, Last_Mod_Date, 
	Create_By_User_ID, Create_Date)
   VALUES (@System_Source, 0, GETDATE(), 0, GETDATE())
   SET @System_Source_Id = SCOPE_IDENTITY() END

DECLARE @SymptomId INT
SET @SymptomId = NULL
DECLARE @CauseId INT
SET @CauseId =NULL

IF @OccurrenceType IS NOT NULL
BEGIN
	SELECT	@OccurrenceTypeId = OccurrenceTypeId
	FROM	tblOccurrenceTypes
	WHERE	OccurrenceType = @OccurrenceType
	IF @OccurrenceTypeId IS NULL
	BEGIN
		INSERT tblOccurrenceTypes(OccurrenceType, OccurrenceTypeDesc)
		VALUES (@OccurrenceType, @OccurrenceType)
		SET @OccurrenceTypeId = SCOPE_IDENTITY()
	END
END
IF @Symptom IS NOT NULL
BEGIN
	SELECT	@SymptomId = Symptom_ID
	FROM	SYMPTOM
	WHERE	Description = @Symptom
	IF @SymptomId IS NULL
	BEGIN
		INSERT SYMPTOM(Description)
		VALUES (@Symptom)
		SET @SymptomId = SCOPE_IDENTITY()
	END
END
IF @Cause IS NOT NULL
BEGIN
	SELECT	@CauseId = Cause_ID
	FROM	CAUSE
	WHERE	Description = @Cause
	IF @CauseId IS NULL
	BEGIN
		DECLARE @Global_Cause_Code_Id INT
		SELECT TOP 1 @Global_Cause_Code_Id = Global_Cause_Code_Id 
		FROM GLOBAL_CAUSE_CODES
		WHERE Default_Record = 1
		INSERT CAUSE(Description, Global_Cause_Code_Id)
		VALUES (@Cause, @Global_Cause_Code_Id)
		SET @CauseId = SCOPE_IDENTITY()
	END
END

/*VV CR8959*/
IF ISNULL(@WorkgroupResponsibleSite,'')<>'' SELECT @WorkgroupResponsibleSiteId=SiteId FROM tblSites WHERE Site=@WorkgroupResponsibleSite
IF @WorkgroupResponsibleSiteId IS NULL AND @EqpPlanId>0
BEGIN

	SELECT @WorkgroupResponsibleSiteId= F.SiteId FROM
	tblEqpPlans EP
		INNER JOIN
	tblFleets F
		ON EP.FleetId=F.FleetId
	WHERE EP.EqpPlanId=@EqpPlanId

END


IF ISNULL(@WorkgroupResponsible,'')<>'' AND @WorkgroupResponsibleSiteId>0
BEGIN
	SELECT @WorkgroupResponsibleId=Work_Group_ID FROM WORK_GROUP 
	WHERE Work_Group_Code=@WorkgroupResponsible AND Site_ID=@WorkgroupResponsibleSiteId

	IF @WorkgroupResponsibleId IS NULL
	BEGIN
		INSERT INTO WORK_GROUP(Description, Site_ID, Work_Group_Code,Create_By_User_ID,Last_Mod_By_User_ID)
		VALUES(@WorkgroupResponsible,@WorkgroupResponsibleSiteId,@WorkgroupResponsible,0,0)
		
		SET @WorkgroupResponsibleId=SCOPE_IDENTITY()
	END
END


-- updates LastOcc when WO status is changed from YTS(AMTJobStatus_ID=3) to IP,C(1,2) or vice versa
CREATE TABLE #StatusChangedAndEffectLastOccProjTask(ProjTaskId INT NOT NULL PRIMARY KEY CLUSTERED)
INSERT	#StatusChangedAndEffectLastOccProjTask
SELECT	wopr.ProjTaskId
FROM	tblWorkOrders wo
		INNER JOIN tblWorkOrderProjs wopr ON wo.WorkOrderId = wopr.WorkOrderId
WHERE	wo.WorkOrderId=@NewWorkorderId
		AND wo.AMTJobStatus_ID <> @AMTJobStatusID
		AND (wo.AMTJobStatus_ID IN (3) OR (wo.AMTJobStatus_ID IN (1,2) AND @AMTJobStatusID = 3))


-- 1. UPDATE
UPDATE
	tblWorkOrders
SET 
	 WorkOrderNumber = @WorkOrderNumber,
	 WorkOrderTypeId = @WorkOrderTypeId,
	 WorkOrderStatusId = @WorkOrderStatusId,
	 StartDate = @StartDate,
	 AMTStartDate = CASE WHEN @AmtStartDate > GETDATE() THEN GETDATE() ELSE @AmtStartDate END,
	 EndDate = @EndDate,
	 EqpPlanId = @EqpPlanId,
	 SerialNumber = @SerialNumber,
	 ComponentSerialNumber = @ComponentSerialNumber,
	 CustomerId = @CustomerId,
	 Plant = @Plant,
	 BranchId = @BranchId,
	 CurrencyId = @CurrencyId,
	 ExchangeRate = @ExchangeRate,
	 MaintenancePlanNumber = @MaintenancePlanNumber,
	 MaintenancePlanItemNumber = @MaintenancePlanItemNumber,
	 MaintPlanCallNumber = @MaintPlanCallNumber,
	 ParentWorkOrderNumber = @ParentWorkOrderNumber,
	 ComponentCodeId = @ComponentCodeId,
	 ModifierId = @ModifierId,
	 TaskTypeId = @TaskTypeId,
	 ApplicationCodeId = @ApplicationCodeId,
	 OccurrenceTypeId = @OccurrenceTypeId,
	 JobCodeId = @JobCodeId,
	 Changeout = @Changeout,
	 WorkActivityCode = @WorkActivityCode,
	 DutyFreeWorkOrderNumber = @DutyFreeWorkOrderNumber,
	 NotificationNumber = @NotificationNumber,
	 PMActivityTypeId = @PMActivityTypeId,
--	RF 28 FEb 03 DO NOT UPDATE, gets from WOrkorder or Duplicated WO
--	 AMTParentWorkOrderId = ISNULL(@AMTParentWorkOrderId,0),
	 AMTComponentCodeId = ISNULL(@CCID,0),
	 AMTModifierId = ISNULL(@MCID,0),
	 AMTTaskTypeId = ISNULL(@TTID,0),
	 AMTApplicationCodeId = ISNULL(@ACID,0),
	 AMTOccurrenceTypeId = ISNULL(@OTID,0),
	 AMTJobCodeId = ISNULL(@JCID,0),
	 AMTChangeout = @AMTChangeout,
	 PricedJobId = @PricedJobId,
-- 	RF 27 Feb 03 REMOVED
--	 CurrentWorkOrder = @CurrentWorkOrder,
--	 ArchivedWorkOrder = @ArchivedWorkOrder ,
	 CreatedInAMT = @CreatedInAMT,
	 AMTStatusId = @AMTWorkOrderStatusId,
	 CreateByUserId = @UserId,
	 MntPlanId = @MaintPlanId,
	-- RF 10 Jul 02 REMOVED
	-- CreateDate =  getdate(),
	-- RF 25 NOV 02 ADDED
	Reviewed = @OldReviewed ,
	--------------------------------
	 LastModByUserId = @UserId,
	 LastModDate = getdate(),
	Task_Header_Id = @Task_Header_Id,
	--VV 20 Jan 04 - new fields
	Ext_Source_ID=@ExtSourceID ,
	Ext_Segment_ID=@ExtSegmentID ,
--	WO_Description=@WODescr ,
	WO_Description=ISNULL(@WODescr,WO_Description) ,
	Parts_In_Stock=@PartsInStock,
	--JobStatus_ID = ISNULL(@AMTJobStatus_ID,(CASE WHEN @StartDate < @Today AND AMTStatusId = 2 THEN 2 ELSE 3 END)),
	JobStatus_ID = ISNULL(@AMTJobStatus_ID,(CASE WHEN @AMTStartDate < @Today AND AMTStatusId = 2 THEN 2 ELSE 3 END)),
	AMTJobStatus_ID = @AMTJobStatusID,
	-- new fields for the Ellipse interface
	EquipmentNo=@EquipmentNo,
	SchedulingTask=@SchedulingTask,
	System_Source_ID=@System_Source_Id,
	--KN 26 Oct 06
	Model = @Model,
	Reg_Counter = NULLIF(@Reg_Counter,''),
	SymptomId  = @SymptomId,
	CauseId = @CauseId,
	/*VV CR8959*/
	OverheadGroup = @OverheadGroup,
	PlanningStatusId=@PlanningStatusId,
	PlannedStartTime=@PlannedStartTime,
	PlannedEndTime=@PlannedEndTime,
	JobReady=@JobReady,
	WeeklyPlan=@WeeklyPlan,
	TargetDate=@TargetDate,
	PriorityId=@PriorityId,
	PlannedDuration=@PlannedDuration,
	PlannedLabourHours=@PlannedLabourHours,
	EmployeeId=@EmployeeId,
	SourceId=@SourceId,
	RaisedById=@RaisedById,
	DateNotified=@DateNotified,
	SIMSCodeId=@SIMSCodeId,
	RepairDescription=@RepairDescription,
	WorkgroupResponsibleId=@WorkgroupResponsibleId,
	WorkgroupResponsibleSiteId=@WorkgroupResponsibleSiteId

WHERE 
	WorkOrderId=@NewWorkorderId

/*VV CR8966*/
/*VV #682 IF @Task_ID>0 EXEC JOB_READY_SET_P @TaskId=@Task_ID*/

DECLARE @ProjTaskId INT
DECLARE Cur CURSOR FAST_FORWARD FOR
	SELECT	ProjTaskId
	FROM	#StatusChangedAndEffectLastOccProjTask
OPEN Cur
FETCH NEXT FROM Cur INTO @ProjTaskId
WHILE @@FETCH_STATUS = 0
BEGIN
	EXEC usp_Update_ProjTask_Last_Occ @piProjTaskID = @ProjTaskId
	FETCH NEXT FROM Cur INTO @ProjTaskId
END
CLOSE Cur
DEALLOCATE Cur



GO

if exists (select * from dbo.sysobjects where id = object_id(N'usp_Add_WorkOrderExternal') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure usp_Add_WorkOrderExternal
GO

create Procedure usp_Add_WorkOrderExternal
/******************************************************************************
	File: usp_Add_WorkOrderExternal.sql
	Name: usp_Add_WorkOrderExternal

	Called By: WorkOrderPut.cls (Add method)

	Desc: 1. Add Work Order
	      2. Return Id new Work Order
              3. Update Parent Work Order
             

	Auth: Harpreet Singh
	Date: 31-May-2002
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	18 Apr 12	K Nagarajan	3296: Fixed the Job Status Rules for Transaction based Workorder.
	____________________________________________OLD HIS--------------
	9 Jun 02	H Singh		new parameter MaintPlanId  null	
	7 Jun 02	H Singh		AMT parentworkorder and AMT Comp Code Combination is set as default 0    	
	20 Jun 02	R Feyder	Add Start and End Date to ADD
					** NEED TO GET THIS FROM THE VB CODE **
	26 Jun 02       M Tucci         Set ForcedChild=1
	16 Jul 02	HS,RF		new parameters startDate and Enddate	
	22 Jul 02		HS			AMTStartDate is updated with @StartDate, code to update EqpPlanId in workorder table	
    	18 Jul 03	HS			call to add Task Header id
	20 Jan 04	V Vasylyeva	New fields Ext_Source_ID, Ext_Segment_ID,WO_Description, Parts_In_Stock
	22 Mar 04	V Vasylyeva	Changed @ExtSourceID varchar(20)=NULL,
				        	@ExtSegmentID varchar(20)=NULL,
	05 Apr 2005	S Babeshko	Update WOJob_Status_ID field
	16 May 2005	S Babeshko	Changed WOJob_Status_ID field to JobStatus_ID field and add updating AMTJobStatus_ID field
	12 Sep 2005	SI		Changed to support Ellipse interface
	30 SEP 2005	R Feyder	Fixed AMTJobStatus_ID
	13 Oct 2005	SI		Put the changes of 12 Sep 05 again
	17 Oct 2005	SI		Changed the way of AMTJobStatus_ID and @AmtStartDate processing
	09 Feb 2006	SI		AMTStartDate is used instead of StartDate 
	26 Oct 06	A Lassauniere	Commented anything linked to archived WO
	27 Oct 06	K Nagarajan	Added RegCounter and Model
	17 Jan 07	K Nagarajan	Selected EqpPlanId according to Model, SerialNumber and RegCounter
	06 Feb 07	K Nagarajan	Support Interface type 2 where the model comes as ''
	24 May 07	SI			Added new fields @OverheadGroup, @OccurrenceType, @Symptom, @Cause
	07 Aug 07	K Nagarajan	Changed the length of SchedulingTask field to 30
	30 Oct 2008	KN & DS		Set CurrentWONumber to 1
	03 Jul 2009	KN		Changed the Length of WODescription to 5000
	17 Jul 2009	KN		Make sure AMTStartDate is not in FUTURE
	 7 Jun 2010	VV	CR8959 New parameters
	24 Mar 2011 GD	Changed the length of EquipmentNo from 12 to 50
	18 Apr 2011 GD	Changed the length of @WorkgroupResponsible from 12 to 50

*******************************************************************************/
	/* Param List */
	@WorkOrderNumber varchar(50)=null,
	@WorkOrderTypeId int,  
	@WorkOrderStatusId int,
	@StartDate datetime,
	@AmtStartDate datetime,
	@EndDate datetime, 	        
    @EqpPlanId int=null,
	@SerialNumber varchar(50)=null, 
	@ComponentSerialNumber varchar(50)=null, 
	@CustomerId int=null, 
	@Plant varchar(50)=null, 
	@BranchId int=null, 
	@CurrencyId int, 
	@ExchangeRate float, 
	@MaintenancePlanNumber varchar(50)=null,
	@MaintenancePlanItemNumber varchar(50)=null, 
	@MaintPlanCallNumber int=null,
	@ParentWorkOrderNumber varchar(50)=null, 
	@ComponentCodeId int=null,
	@ModifierId int=null,
	@TaskTypeId int=null,
	@ApplicationCodeId int=null,
	@OccurrenceTypeId int=null,
	@JobCodeId int=null,
	@Changeout int=null,
	@WorkActivityCode varchar(50)=null,
	@DutyFreeWorkOrderNumber varchar(50)=null,
	@NotificationNumber varchar(50) = null,
	@PMActivityTypeId varchar(50)=null, 
	@AMTParentWorkOrderId int,
	@AMTComponentCodeId int, 
	@AMTModifierId int, 
	@AMTJobCodeId int, 
	@AMTTaskTypeId int,
	@AMTApplicationCodeId int, 
	@AMTOccurrenceTypeId int=null,
	@AMTChangeout int=null,
	@PricedJobId int=null,
	@CurrentWorkOrder int=null,
	@ArchivedWorkOrder int=null,
	@CreatedInAMT int=null,
	@AMTWorkOrderStatusId int=null, 
	@UserId int,
	@MaintPlanId int = null,
	@NewWorkOrderId int output,

	@ExtSourceID varchar(20)=NULL,
	@ExtSegmentID varchar(20)=NULL,
	@WODescr varchar(5000)=NULL,
	@PartsInStock bit=0,
	-- new fields for the Ellipse interface
	@EquipmentNo varchar(50)=NULL,
	@SchedulingTask varchar(30)=NULL,
	@System_Source varchar(10)=NULL,
	@AMTJobStatus_ID int=NULL,
	@Model	varchar(50) =NULL,
	@Reg_Counter	varchar(20) = NULL,

	@OverheadGroup varchar(50) = NULL, 
	@OccurrenceType varchar(10) = NULL, 
	@Symptom varchar(100) = NULL, 
	@Cause varchar(100) = NULL,
	/*VV CR8959*/
	@PlanningStatus varchar(10)=NULL,
	@PlannedStartTime datetime=NULL,
	@PlannedEndTime datetime=NULL,
	@JobReady bit=0,
	@WeeklyPlan varchar(50)=NULL,
	@TargetDate datetime=NULL,
	@Priority varchar(10)=NULL,
	@PlannedDuration float=0,
	@PlannedLabourHours float=0,
	@Employee varchar(50)=NULL,
	@Source varchar(50)=NULL,
	@RaisedBy varchar(50)=NULL,
	@DateNotified datetime=NULL,
	@SIMSCode varchar(10)=NULL,
	@RepairDescription varchar(8000)=NULL,
	@WorkgroupResponsible varchar(50)=NULL,
	@WorkgroupResponsibleSite varchar(50)=NULL,
	@CheckForTransactionbasedStatus BIT = 0


AS
/* Local procedure variables */ 
	DECLARE @Today datetime

IF 
	@CheckForTransactionbasedStatus = 1 
	AND 
	EXISTS (SELECT Use_Transaction_WO_Costs FROM AMT_VARIABLE WHERE Use_Transaction_WO_Costs= 1)
BEGIN
	SET @AMTJobStatus_ID = 3 
END 

-- SET @ExtSourceID =NULLIF(@ExtSourceID,0)
-- SET @ExtSegmentID =NULLIF(@ExtSegmentID,0)
SET @WODescr =NULLIF(@WODescr,'')
SET @PartsInStock =ISNULL(@PartsInStock,0)
SET @Reg_Counter = NULLIF(@Reg_Counter,'')
SET @Model = NULLIF(@Model,'')
SET	@OverheadGroup = ISNULL(NULLIF(@OverheadGroup,''),'Default')
SET	@OccurrenceType = NULLIF(@OccurrenceType,'')
SET	@Symptom = NULLIF(@Symptom,'')
SET	@Cause = NULLIF(@Cause,'')

/*VV CR8959*/
DECLARE @PlanningStatusId int,@WorkgroupResponsibleSiteId int,@WorkgroupResponsibleId int
DECLARE @PriorityId int,@EmployeeId int,@SourceId int,@RaisedById int,@SIMSCodeId int

IF ISNULL(@PlanningStatus,'')<>'' SELECT @PlanningStatusId=PlanningStatusId FROM PLANNING_STATUS WHERE PlanningStatus=@PlanningStatus

SET @JobReady=ISNULL(@JobReady,0)
SET @WeeklyPlan=NULLIF(@WeeklyPlan,'')

IF ISNULL(@Priority,'')<>'' SELECT @PriorityId=Priority_ID FROM PRIORITY WHERE Short_Description=@Priority

SET @PlannedDuration =ISNULL(@PlannedDuration,0)
SET @PlannedLabourHours =ISNULL(@PlannedLabourHours,0)
IF ISNULL(@Employee,'')<>'' SELECT @EmployeeId=Employee_ID FROM EMPLOYEE WHERE EmployeeNumber=@Employee
IF ISNULL(@Source,'')<>'' SELECT @SourceId=Source_ID FROM SOURCE WHERE Description=@Source
IF ISNULL(@RaisedBy,'')<>'' SELECT @RaisedById=Employee_ID FROM EMPLOYEE WHERE EmployeeNumber=@RaisedBy
IF ISNULL(@SIMSCode,'')<>'' SELECT @SIMSCodeId=SIMS_Code_Id FROM SIMS_CODE WHERE SIMS_Code=@SIMSCode

SET @RepairDescription= NULLIF(@RepairDescription,'')

	
DECLARE @GetEqpPlanId as int


/*SELECT @GetEqpPlanId = EP.EqpPlanId
FROM dbo.tblEqpPlans EP INNER JOIN
dbo.tblEquipment EQ ON EP.EquipmentId = EQ.EquipmentId
WHERE EQ.SerialNumber = @SerialNumber*/
-- KN 17 Jan 07
SELECT     TOP 1 
		@GetEqpPlanId = tblEqpPlans.EqpPlanId 
FROM         tblEqpPlans INNER JOIN
             tblEquipment ON tblEqpPlans.EquipmentId = tblEquipment.EquipmentId INNER JOIN
             tblEqpProjs ON tblEqpPlans.EqpPlanId = tblEqpProjs.EqpPlanId INNER JOIN
	tblModels ON tblModels.ModelId = tblEquipment.ModelId
WHERE     
	(tblEquipment.SerialNumber =  @SerialNumber) AND 
	(tblEqpPlans.Reg_Counter = ISNULL(@Reg_Counter,tblEqpPlans.Reg_Counter)) AND
	(tblModels.Model = ISNULL(@Model, tblModels.Model)) AND	
	(tblEqpPlans.StartDate <= @StartDate) AND 
	(tblEqpProjs.Projection_Type_ID = 1)
ORDER BY tblEqpProjs.EndDate DESC
--HS 18 Jul 03 add task_header_id
DECLARE  @Task_Header_Id as int
EXEC TASK_HEADER_MANAGER_P   @AMTComponentCodeId,  @AMTModifierId,  @AMTTaskTypeId,  @AMTApplicationCodeId, @Task_Header_Id output


DECLARE @System_Source_Id int
SET @System_Source_Id=NULL
SELECT @System_Source_Id=System_Source_ID FROM SYSTEM_SOURCE WHERE System_Source_Code=@System_Source
-- Add System_Source if it's a new one
IF (@System_Source_Id IS NULL) AND (ISNULL(@System_Source,'')<>'')
BEGIN 
   INSERT SYSTEM_SOURCE
	(System_Source_Code, Last_Mod_By_User_ID, Last_Mod_Date, 
	Create_By_User_ID, Create_Date)
   VALUES (@System_Source, 0, GETDATE(), 0, GETDATE())
   SET @System_Source_Id = SCOPE_IDENTITY()
END

DECLARE @SymptomId INT
SET @SymptomId = NULL
DECLARE @CauseId INT
SET @CauseId =NULL

IF @OccurrenceType IS NOT NULL
BEGIN
	SELECT	@OccurrenceTypeId = OccurrenceTypeId
	FROM	tblOccurrenceTypes
	WHERE	OccurrenceType = @OccurrenceType
	IF @OccurrenceTypeId IS NULL
	BEGIN
		INSERT tblOccurrenceTypes(OccurrenceType, OccurrenceTypeDesc)
		VALUES (@OccurrenceType, @OccurrenceType)
		SET @OccurrenceTypeId = SCOPE_IDENTITY()
	END
END
IF @Symptom IS NOT NULL
BEGIN
	SELECT	@SymptomId = Symptom_ID
	FROM	SYMPTOM
	WHERE	Description = @Symptom
	IF @SymptomId IS NULL
	BEGIN
		INSERT SYMPTOM(Description)
		VALUES (@Symptom)
		SET @SymptomId = SCOPE_IDENTITY()
	END
END
IF @Cause IS NOT NULL
BEGIN
	SELECT	@CauseId = Cause_ID
	FROM	CAUSE
	WHERE	Description = @Cause
	IF @CauseId IS NULL
	BEGIN
		DECLARE @Global_Cause_Code_Id INT
		SELECT TOP 1 @Global_Cause_Code_Id = Global_Cause_Code_Id 
		FROM GLOBAL_CAUSE_CODES
		WHERE Default_Record = 1
		INSERT CAUSE(Description, Global_Cause_Code_Id)
		VALUES (@Cause, @Global_Cause_Code_Id)
		SET @CauseId = SCOPE_IDENTITY()
	END
END

/*VV CR8959*/
IF ISNULL(@WorkgroupResponsibleSite,'')<>'' SELECT @WorkgroupResponsibleSiteId=SiteId FROM tblSites WHERE Site=@WorkgroupResponsibleSite

IF @WorkgroupResponsibleSiteId IS NULL AND @EqpPlanId>0 
BEGIN

	SELECT @WorkgroupResponsibleSiteId= F.SiteId FROM
	tblEqpPlans EP
		INNER JOIN
	tblFleets F
		ON EP.FleetId=F.FleetId
	WHERE EP.EqpPlanId=@EqpPlanId

END


IF ISNULL(@WorkgroupResponsible,'')<>'' AND @WorkgroupResponsibleSiteId>0
BEGIN


	SELECT @WorkgroupResponsibleId=Work_Group_ID FROM WORK_GROUP 
	WHERE Work_Group_Code=@WorkgroupResponsible AND Site_ID=@WorkgroupResponsibleSiteId
	

	IF @WorkgroupResponsibleId IS NULL
	BEGIN
		INSERT INTO WORK_GROUP(Description, Site_ID, Work_Group_Code,Create_By_User_ID,Last_Mod_By_User_ID)
		VALUES(@WorkgroupResponsible,@WorkgroupResponsibleSiteId,@WorkgroupResponsible,0,0)
		
		SET @WorkgroupResponsibleId=SCOPE_IDENTITY()
	END
	
END

-- 1. INSERT
INSERT INTO tblWorkOrders 
(WorkOrderNumber,
 WorkOrderTypeId,
 WorkOrderStatusId,
 StartDate,
 AMTStartDate,
 EndDate,
 EqpPlanId,
 SerialNumber,
 ComponentSerialNumber,
 CustomerId,
 Plant,
 BranchId,
 CurrencyId,
 ExchangeRate,
 MaintenancePlanNumber,
 MaintenancePlanItemNumber,
 MaintPlanCallNumber,
 ParentWorkOrderNumber,
 ComponentCodeId,
 ModifierId,
 TaskTypeId,
 ApplicationCodeId,
 OccurrenceTypeId,
 JobCodeId,
 Changeout,
 WorkActivityCode,
 DutyFreeWorkOrderNumber,
 NotificationNumber,
 PMActivityTypeId,
 ForcedChild,
 AMTParentWorkOrderId,
 AMTComponentCodeId,
 AMTModifierId,
 AMTJobCodeId,
 AMTTaskTypeId,
 AMTApplicationCodeId,
 AMTOccurrenceTypeId,
/*
 ISNULL(@AMTParentWorkOrderId, 0),
 ISNULL(@AMTComponentCodeId, @ComponentCodeId),
 ISNULL(@AMTModifierId, @ModifierId),
 ISNULL(@AMTJobCodeId, @JobCodeId),
 ISNULL(@AMTTaskTypeId, @TaskTypeId),
 ISNULL(@AMTApplicationCodeId, @ApplicationCodeId),
 ISNULL(@AMTOccurrenceTypeId, @OccurrenceTypeId),
*/
 AMTChangeout,
 PricedJobId,
 CurrentWorkOrder,
-- ArchivedWorkOrder,
 CreatedInAMT,
 AMTStatusId,
 CreateByUserId,
 MntPlanId,
 CreateDate,
 LastModByUserId,
 LastModDate,
Task_Header_Id,
Ext_Source_ID ,
Ext_Segment_ID ,
WO_Description,
Parts_In_Stock,
EquipmentNo,
SchedulingTask,
System_Source_ID,
Model,
Reg_Counter,
SymptomId,
CauseId,
OverheadGroup,
/*VV CR8959*/
PlanningStatusId,
PlannedStartTime,
PlannedEndTime,
JobReady,
WeeklyPlan,
TargetDate,
PriorityId,
PlannedDuration,
PlannedLabourHours,
EmployeeId,
SourceId,
RaisedById,
DateNotified,
SIMSCodeId,
RepairDescription,
WorkgroupResponsibleId,
WorkgroupResponsibleSiteId
)

VALUES 
(@WorkOrderNumber,
 @WorkOrderTypeId, 	
 @WorkOrderStatusId,
 @StartDate,
 CASE WHEN @AmtStartDate > GETDATE() THEN GETDATE() ELSE @AmtStartDate END,
 @EndDate, 	        
 ISNULL(@GetEqpPlanId,-1),
 @SerialNumber, 
 @ComponentSerialNumber, 
 @CustomerId, 
 @Plant, 
 @BranchId, 
 @CurrencyId, 
 @ExchangeRate, 
 @MaintenancePlanNumber,
 @MaintenancePlanItemNumber, 
 @MaintPlanCallNumber,
 @ParentWorkOrderNumber,
 @ComponentCodeId,
 @ModifierId,
 @TaskTypeId,
 @ApplicationCodeId,
 @OccurrenceTypeId,
 @JobCodeId,
 @Changeout,
 @WorkActivityCode,
 @DutyFreeWorkOrderNumber,
 @NotificationNumber,
 @PMActivityTypeId, 
 1,
 ISNULL(@AMTParentWorkOrderId,0),
 ISNULL(@AMTComponentCodeId, 0),
 ISNULL(@AMTModifierId, 0),
 ISNULL(@AMTJobCodeId, 0),
 ISNULL(@AMTTaskTypeId,0),
 ISNULL(@AMTApplicationCodeId, 0),
 ISNULL(@AMTOccurrenceTypeId,0),
 @AMTChangeout,
 @PricedJobId,
 1, -- KN & DS 30-Oct-2008
-- @ArchivedWorkOrder,
 @CreatedInAMT,
 @AMTWorkOrderStatusId, 
 @UserId,
 @MaintPlanId,
 getdate(),
 @UserId,
 getdate(),
@Task_Header_Id,
@ExtSourceID,
@ExtSegmentID ,
@WODescr,
@PartsInStock,
@EquipmentNo,
@SchedulingTask,
@System_Source_Id,
@Model,
@Reg_Counter,
@SymptomId,
@CauseId,
@OverheadGroup,
/*CR8959*/
@PlanningStatusId,
@PlannedStartTime,
@PlannedEndTime,
@JobReady,
@WeeklyPlan,
@TargetDate,
@PriorityId,
@PlannedDuration,
@PlannedLabourHours,
@EmployeeId,
@SourceId,
@RaisedById,
@DateNotified,
@SIMSCodeId,
@RepairDescription,
@WorkgroupResponsibleId,
@WorkgroupResponsibleSiteId)

--2. Return Id
SET @NewWorkOrderId = SCOPE_IDENTITY()

--3. Update Parent Work Order
SET @Today = convert(datetime, convert(varchar, day(GETDATE()+1))+'/'+convert(varchar, month(GETDATE()+1))+'/'+convert(varchar, year(GETDATE()+1)),103)
UPDATE 
tblWorkOrders 
SET 
ParentWorkOrderId = @NewWorkOrderId, 
AMTParentWorkOrderId = @NewWorkOrderId,
JobStatus_ID = ISNULL(@AMTJobStatus_ID,(CASE WHEN @AMTStartDate < @Today AND AMTStatusId = 2 THEN 2 ELSE 3 END)),
AMTJobStatus_ID = ISNULL(@AMTJobStatus_ID,(CASE WHEN @AMTStartDate < @Today AND AMTStatusId = 2 THEN 2 ELSE 3 END))
--JobStatus_ID = ISNULL(@AMTJobStatus_ID,(CASE WHEN @StartDate < @Today AND AMTStatusId = 2 THEN 2 ELSE 3 END)),
--AMTJobStatus_ID = ISNULL(@AMTJobStatus_ID,(CASE WHEN @StartDate < @Today AND AMTStatusId = 2 THEN 2 ELSE 3 END))
-- JobStatus_ID = (CASE WHEN @StartDate < @Today AND WorkOrderStatusId = 4 THEN 2 ELSE 3 END),
-- AMTJobStatus_ID = (CASE WHEN @StartDate < @Today AND AMTStatusId = 4 THEN 2 ELSE 3 END)
WHERE WorkOrderID = @NewWorkOrderId


RETURN


GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[BUDGET_OCC_AND_COST_POPULATE_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[BUDGET_OCC_AND_COST_POPULATE_P]
GO

create PROCEDURE BUDGET_OCC_AND_COST_POPULATE_P
/******************************************************************************
	File: 
	Name: BUDGET_OCC_AND_COST_POPULATE_P

	Called By: 

	Desc: 

	Auth: 	Sergey Ivanov
	Date: 	24 Oct 2006
*******************************************************************************
		Change History
*******************************************************************************
Date:		Author:		Description:
--------	--------	----------------------------------------
18 Apr 12	K Nagarajan #4010 Do not Exclude UsagePerCalYear <>0
26 Mar 12	V Vasylyeva	#3798 include unassigned date-based tasks
19 Mar 12	KN		E752: Add WorkGroupID AS Cost Filter
14 Feb 11	K Nagarajan	1233: Fixed Varchar(8000) to Varchar(Max)
18 Jun 08	V Vasylyeva	Added calculation of costs using StdJobPartsMargin
							Cost@Cost changes
21 Sep 07	SI			Limited Unassigned tasks Occs query by new equipments
05 Sep 07	SI			Fixed the cost calculation of unassigned date based tasks
02 Jul 07	SI			Changed "LEFT JOIN #EQPPROJ_OCC' to 'INNER JOIN #EQPPROJ_OCC' for unassigned occs
18 Jun 07	SI			Speeded up  queries that used 'CAST(CONVERT(VARCHAR(6),...'
15 Jun 07	ID			Added Work_Group_Id
*******************************************************************************/
	/* Param List */
@Budget_Equipment_Id varchar(MAX) = '',
@StartPeriod INT,
@EndPeriod INT,
@WorkGroupID VARCHAR(MAX) = ''

AS

IF ISNULL(@WorkGroupId,'') = ''
	SET @WorkGroupId =',,'

DECLARE @MonthsToAdd INT
SET @MonthsToAdd = 12
DECLARE @BudStartDate DATETIME
DECLARE @BudEndDate DATETIME
DECLARE @BudEndDateExtraOcc DATETIME
SET @BudStartDate = CAST(CAST(@StartPeriod AS VARCHAR) + '01' AS DATETIME)
SET @BudEndDate = DATEADD(Month, 1, CAST(CAST(@EndPeriod AS VARCHAR) + '01' AS DATETIME))
SET @BudEndDateExtraOcc = DATEADD(Month, @MonthsToAdd, @BudEndDate)

DECLARE @UseStdJobPartsMargin bit
DECLARE @CalcBudCostFromStdJobMargin bit

SELECT @UseStdJobPartsMargin =UseStdJobPartsMargin,@CalcBudCostFromStdJobMargin=CalcBudCostFromStdJobMargin
FROM AMT_VARIABLE

IF @UseStdJobPartsMargin=0 SET @CalcBudCostFromStdJobMargin=0

CREATE TABLE #z_BudgetEqpToBeUpdated0(Budget_Equipment_Id INT NOT NULL PRIMARY KEY CLUSTERED, Eqp_Proj_Id INT NOT NULL)
CREATE INDEX #z_BudgetEqpToBeUpdated0_ind ON #z_BudgetEqpToBeUpdated0(Eqp_Proj_Id)

INSERT INTO #z_BudgetEqpToBeUpdated0
SELECT	eqp.Budget_Equipment_Id,  
	eqp.Eqp_Proj_Id
FROM	BUDGET_EQUIPMENT eqp
	INNER JOIN dbo.LIST_TO_TABLE_F(@Budget_Equipment_Id) eqpi ON eqpi.list_item = eqp.Budget_Equipment_Id

--PRINT @Budget_Equipment_Id

/* 2) Add Projected Occs */

	INSERT INTO BUDGET_OCC (
		Budget_Task_ID, 
		Proj_Task_Opt_ID,
		is_Actual_Cost, 
		Cost_Date, 
		Occ_Usage, 
		Occ_Qty, 
		Downtime_Hours, 
		Manual_Edited
		)
	SELECT     
		BPT.Budget_Task_Id, 
		occ.ProjTaskOptId,
		0 AS is_Actual_Cost, 
		occ.OccDate AS Cost_Date, 
		occ.OccUsage AS Occ_Usage, 
		1 AS Occ_Qty, 
	    0 AS Downtime_Hours, 
		0 AS Manual_Edited
	FROM	dbo.BUDGET_TASK BPT 
			INNER JOIN #z_BudgetEqpToBeUpdated0 zBE ON zBE.Budget_Equipment_Id = BPT.Budget_Equipment_Id
			INNER JOIN dbo.tblProjTaskOccs occ ON BPT.Proj_Task_ID = occ.ProjTaskId
	WHERE --CAST(CONVERT(VARCHAR(6),  occ.OccDate, 112) AS INT) BETWEEN @StartPeriod AND @EndPeriod
		occ.OccDate BETWEEN @BudStartDate AND @BudEndDateExtraOcc
		--AND EXISTS (SELECT Budget_Equipment_Id  FROM #z_BudgetEqpToBeUpdated0  WHERE Budget_Equipment_Id = BPT.Budget_Equipment_Id )
	--GROUP BY occ.OccDate, occ.OccUsage, BPT.Budget_Task_Id, occ.ProjTaskOptId


/* 3) Update Downtime Hours */

-- 	CREATE TABLE [#z_Budget_Proj_Occs_DT] (
-- 		[Budget_Task_Id] [int] NOT NULL ,
-- 		[Occ_Date] [datetime] NOT NULL ,
-- 		[Occ_Usage] [float] NOT NULL ,
-- 		[Downtime_Hours] [float] NOT NULL ,
-- 	) ON [PRIMARY]
-- 
-- 	INSERT INTO  #z_Budget_Proj_Occs_DT (Budget_Task_Id, Occ_Date,Occ_Usage, Downtime_Hours)
-- 	SELECT     BPT.Budget_Task_Id, occ.OccDate AS Occ_Date, occ.OccUsage AS Occ_Usage, SUM(pto.Probability / 100 * pta.Duration) AS Downtime_Hours
-- 	FROM         dbo.BUDGET_TASK BPT INNER JOIN
-- 	                      dbo.tblProjTaskOccs occ ON BPT.Proj_Task_ID = occ.ProjTaskId INNER JOIN
-- 	                      dbo.tblProjTaskOpts pto INNER JOIN
-- 	                      dbo.PROJ_TASK_AMT_COST_V pta ON pto.ProjTaskOptId = pta.ProjTaskOptId ON BPT.Proj_Task_ID = pto.ProjTaskId INNER JOIN
-- 	                      dbo.tblEqpPlans ON occ.EqpPlanId = dbo.tblEqpPlans.EqpPlanId INNER JOIN
-- 	                      dbo.tblFleets ON dbo.tblEqpPlans.FleetId = dbo.tblFleets.FleetId INNER JOIN
-- 	                      dbo.TASK_SPECIFIC_DOWNTIME ON dbo.tblFleets.FleetId = dbo.TASK_SPECIFIC_DOWNTIME.Fleet_Id INNER JOIN
-- 	                      dbo.tblProjTasks ON pto.ProjTaskId = dbo.tblProjTasks.ProjTaskId AND dbo.tblEqpPlans.EqpPlanId = dbo.tblProjTasks.EqpPlanId AND 
-- 	                      dbo.TASK_SPECIFIC_DOWNTIME.TaskTypeId = dbo.tblProjTasks.TaskTypeId
-- 	WHERE     (occ.ProjTaskOptId IS NULL)  AND  CAST(CONVERT(VARCHAR(6),  occ.OccDate, 112) AS INT)  BETWEEN @StartPeriod AND @EndPeriod
-- 	AND EXISTS (SELECT Budget_Equipment_Id  FROM #z_BudgetEqpToBeUpdated0  WHERE Budget_Equipment_Id = BPT.Budget_Equipment_Id )	
-- 	GROUP BY occ.OccDate, occ.OccUsage, BPT.Budget_Task_Id
-- 
-- 
-- 	INSERT INTO  #z_Budget_Proj_Occs_DT (Budget_Task_Id, Occ_Date,Occ_Usage, Downtime_Hours)
-- 	SELECT     BPT.Budget_Task_Id, occ.OccDate AS Occ_Date, occ.OccUsage AS Occ_Usage, SUM(pta.Duration) AS Downtime_Hours
-- 	FROM         dbo.BUDGET_TASK BPT INNER JOIN
-- 	                      dbo.tblProjTaskOccs occ ON BPT.Proj_Task_ID = occ.ProjTaskId INNER JOIN
-- 
-- 	                      dbo.tblProjTaskOpts pto INNER JOIN
-- 	                      dbo.PROJ_TASK_AMT_COST_V pta ON pto.ProjTaskOptId = pta.ProjTaskOptId ON BPT.Proj_Task_ID = pto.ProjTaskId AND 
-- 	                      occ.ProjTaskOptId = pto.ProjTaskOptId INNER JOIN
-- 	                      dbo.tblEqpPlans ON occ.EqpPlanId = dbo.tblEqpPlans.EqpPlanId INNER JOIN
-- 	                      dbo.tblFleets ON dbo.tblEqpPlans.FleetId = dbo.tblFleets.FleetId INNER JOIN
-- 	                      dbo.TASK_SPECIFIC_DOWNTIME ON dbo.tblFleets.FleetId = dbo.TASK_SPECIFIC_DOWNTIME.Fleet_Id INNER JOIN
-- 	                      dbo.tblProjTasks ON pto.ProjTaskId = dbo.tblProjTasks.ProjTaskId AND dbo.tblEqpPlans.EqpPlanId = dbo.tblProjTasks.EqpPlanId AND 
-- 	                      dbo.TASK_SPECIFIC_DOWNTIME.TaskTypeId = dbo.tblProjTasks.TaskTypeId
-- 	WHERE  CAST(CONVERT(VARCHAR(6),  occ.OccDate, 112) AS INT)  BETWEEN @StartPeriod AND @EndPeriod
-- 	AND EXISTS (SELECT Budget_Equipment_Id  FROM #z_BudgetEqpToBeUpdated0  WHERE Budget_Equipment_Id = BPT.Budget_Equipment_Id )	
-- 	GROUP BY occ.OccDate, occ.OccUsage, BPT.Budget_Task_Id
-- 	
-- 	UPDATE dbo.BUDGET_OCC
-- 	SET     dbo.BUDGET_OCC.Downtime_Hours = BPODT.Downtime_Hours
-- 	FROM  #z_Budget_Proj_Occs_DT BPODT INNER JOIN
-- 	                      dbo.BUDGET_OCC ON BPODT.Budget_Task_Id = dbo.BUDGET_OCC.Budget_Task_ID AND 
-- 	                      BPODT.Occ_Date = dbo.BUDGET_OCC.Cost_Date AND 
-- 	                      ROUND(BPODT.Occ_Usage,2) = ROUND(dbo.BUDGET_OCC.Occ_Usage,2)
-- 
-- 
-- 	DROP TABLE  #z_Budget_Proj_Occs_DT


--BUDGET_OCC_ADD_P
	/* ADD EXTRA OCCURENCES*/

	
	IF @Budget_Equipment_Id <> ''
		BEGIN		
			EXEC BUDGET_OCC_ADD_P  @Budget_Equipment_Id = @Budget_Equipment_Id
		END

/* 3) Update Downtime Hours */

	UPDATE	bocc
	SET	Downtime_Hours = dur.Duration
	FROM	BUDGET_OCC bocc
		INNER JOIN (
			SELECT	bocc.Budget_Occ_Id,
				ISNULL(
					SUM(	CASE	WHEN bocc.Proj_Task_Opt_ID IS NULL 
							THEN pto.Probability
							WHEN bocc.Proj_Task_Opt_ID = pto.ProjTaskOptId
							THEN 100
							ELSE 0 
						END / 100
						* pta.Duration),
					0) AS Duration
			FROM	BUDGET_TASK btsk
				INNER JOIN #z_BudgetEqpToBeUpdated0 zBE ON zBE.Budget_Equipment_Id = btsk.Budget_Equipment_Id
				LEFT JOIN BUDGET_OCC bocc ON bocc.Budget_Task_Id = btsk.Budget_Task_Id
				LEFT JOIN tblProjTaskOpts pto ON btsk.Proj_Task_ID = pto.ProjTaskId
				LEFT JOIN PROJ_TASK_AMT_COST_1_V pta ON pto.ProjTaskOptId = pta.ProjTaskOptId
			WHERE	btsk.Is_Downtime_Task = 1
			GROUP BY bocc.Budget_Occ_Id
		) dur ON dur.Budget_Occ_Id = bocc.Budget_Occ_Id

/* 4) Add Projected Costs */

	DECLARE @LabourCategory INT
	DECLARE @PartsCategory INT
	DECLARE @MiscCategory INT
	SET @PartsCategory = 1
	SET @LabourCategory = 2
	SET @MiscCategory = 3

	INSERT INTO BUDGET_COST
		(Budget_Occ_ID, Cost_Bearer_ID, Cost, Sell, Cost_Centre_ID, Cost_Expense_ID, Cost_Category_Id,Eqp_Category_Id, Work_Group_Id) --Added ID
	SELECT 
		occ.Budget_Occ_Id, 
		ISNULL(pta.Cost_Bearer_ID, ep.Default_Cost_Bearer_ID) AS Cost_Bearer_ID,
		ROUND(
		  SUM(	
			CASE WHEN ccat.Cost_Category_Id = @PartsCategory THEN
				(pta.PartsCost * occ.Probability * cpe.CumPartsEscalation / cpe1.CumPartsEscalation) * 
				(100 - CASE WHEN p.Projection_Type_ID IN (1,3) THEN 
							--VV 17 Jun 08
							CASE WHEN pta.pricedJobId>0 AND @UseStdJobPartsMargin=1 THEN 
							ISNULL(pta.StdJobPartsMargin,FSM.SystemMargin) ELSE FSM.SystemMargin END 
						ELSE 
							--VV 17 Jun 08
							CASE WHEN @CalcBudCostFromStdJobMargin=1 AND pta.PricedJobId>0 THEN 
							ISNULL(pta.StdJobPartsMargin,ep.Budget_Margin_Parts) ELSE ep.Budget_Margin_Parts END

						END) 
				/ 10000 / erc.ExRate
			WHEN ccat.Cost_Category_Id = @LabourCategory THEN
				(pta.TotalLabourCost * occ.Probability * ce.CumLaborEscalation / ce1.CumLaborEscalation) * 
				(100 - CASE WHEN p.Projection_Type_ID IN (1,3) THEN f.LabMargin ELSE ep.Budget_Margin_Labour END) 
				/ 10000 / erc.ExRate
			ELSE 
				(pta.TotalMiscCost * occ.Probability * ce.CumMiscEscalation / ce1.CumMiscEscalation) * 
				(100 - CASE WHEN p.Projection_Type_ID IN (1,3) THEN f.MiscMargin ELSE ep.Budget_Margin_Misc END) 
				/ 10000 / erc.ExRate
			END
		  ), 2) AS Cost,
		ROUND(
		  SUM(	CASE WHEN ccat.Cost_Category_Id = @PartsCategory THEN
				pta.PartsCost * occ.Probability * cpe.CumPartsEscalation / cpe1.CumPartsEscalation / 100 / erc.ExRate
			WHEN ccat.Cost_Category_Id = @LabourCategory THEN
				pta.TotalLabourCost * occ.Probability * ce.CumLaborEscalation / ce1.CumLaborEscalation / 100 / erc.ExRate
			ELSE 
				pta.TotalMiscCost * occ.Probability * ce.CumMiscEscalation / ce1.CumMiscEscalation / 100 / erc.ExRate
			END
		  ), 2) AS Sell,
		ISNULL(pta.Cost_Centre_ID, ep.Cost_Centre_ID) AS Cost_Centre_ID, 
		CASE ccat.Cost_Category_Id 
			WHEN @PartsCategory THEN ISNULL(pta.Parts_Cost_Expense_ID, ss.Cost_Expense_ID) 
			WHEN @LabourCategory THEN ISNULL(pta.Labour_Cost_Expense_ID, ss.Cost_Expense_ID) 
			WHEN @MiscCategory THEN ISNULL(pta.Misc_Cost_Expense_ID, ss.Cost_Expense_ID) 
		END AS Cost_Expense_ID,
		ccat.Cost_Category_Id AS Cost_Category_Id,
		ep.Eqp_Category_Id,		--Added ID
		pta.Work_Group_Id		--Added ID
	FROM	
		tblFleets f
		LEFT JOIN tblEqpPlans ep ON ep.FleetId = f.FleetId
		LEFT JOIN tblEqpProjs p ON p.EqpPlanId = ep.EqpPlanId
		LEFT JOIN tblProjTasks pt ON p.EqpProjId = pt.EqpProjId
		--INNER JOIN #TASK1 pt2 ON pt2.ProjTaskId = pt.ProjTaskId
		LEFT JOIN BUDGET_TASK btsk ON btsk.Proj_Task_Id = pt.ProjTaskId
		INNER JOIN #z_BudgetEqpToBeUpdated0 zBE ON zBE.Budget_Equipment_Id = btsk.Budget_Equipment_Id
		INNER JOIN (
			SELECT 	bocc.Budget_Task_Id, pto.ProjTaskOptId, bocc.Budget_Occ_Id, bocc.Cost_Date as OccDate,
				CASE	WHEN bocc.Proj_Task_Opt_ID IS NULL 
					THEN pto.Probability
					WHEN bocc.Proj_Task_Opt_ID = pto.ProjTaskOptId
					THEN 100
					ELSE 0 
				END as Probability
			FROM	BUDGET_OCC bocc 
				LEFT JOIN BUDGET_TASK btsk ON bocc.Budget_Task_Id = btsk.Budget_Task_Id
				INNER JOIN #z_BudgetEqpToBeUpdated0 zBE ON zBE.Budget_Equipment_Id = btsk.Budget_Equipment_Id
				LEFT JOIN tblProjTaskOpts pto ON btsk.Proj_Task_Id = pto.ProjTaskId
		) occ ON occ.Budget_Task_Id = btsk.Budget_Task_Id
		LEFT JOIN PROJ_TASK_AMT_COST_1_V pta ON occ.ProjTaskOptId = pta.ProjTaskOptId
	 	LEFT JOIN tblComponentCodes cc ON pt.ComponentCodeId = cc.ComponentCodeID
	 	LEFT JOIN tblSubSystems ss ON cc.SubSystemID = ss.SubSystemID
	 	--LEFT JOIN tblTaskTypes tt ON pt.TaskTypeId = tt.TaskTypeID
	 	LEFT JOIN tblFleetSystemMargins FSM ON FSM.SystemID = ss.SystemID AND f.FleetId = FSM.FleetID 
		LEFT JOIN tblExRateCurrencies erc ON pta.CurrencyId = erc.CurrencyID AND p.ExchangeRateId = erc.ExRateID
		LEFT JOIN tblCostEscalations ce ON ce.EndDate > pta.Pricing_Date AND ce.EscalationDate <= pta.Pricing_Date 
		LEFT JOIN tblCostPartsEscalations cpe ON ce.CostEscalationId = cpe.CostEscalationId AND cpe.ManufacturerId = pt.ManufacturerId
		LEFT JOIN tblCostEscalations ce1 ON occ.OccDate >= ce1.EscalationDate AND occ.OccDate < ce1.EndDate
		LEFT JOIN tblCostPartsEscalations cpe1 ON ce1.CostEscalationId = cpe1.CostEscalationId AND pt.ManufacturerId = cpe1.ManufacturerId
		CROSS JOIN COST_CATEGORY ccat
	WHERE	--p.Projection_Type_ID IN (1, 3)
		
		occ.Probability <> 0
		AND (
			(ccat.Cost_Category_Id = 1 AND pta.PartsCost <> 0 )
			OR (ccat.Cost_Category_Id = 2 AND pta.TotalLabourCost <> 0 )
			OR (ccat.Cost_Category_Id = 3 AND pta.TotalMiscCost <> 0 )
		)
		AND pt.Unscheduled = 0
		AND ( @WorkGroupId=',,' OR CHARINDEX(','+CAST(pta.Work_Group_ID as varchar(16))+',', @WorkGroupId)>0 )  --E752
	GROUP BY 
		occ.Budget_Occ_Id, 
		ISNULL(pta.Cost_Bearer_ID, ep.Default_Cost_Bearer_ID),
		ISNULL(pta.Cost_Centre_ID, ep.Cost_Centre_ID), 
		CASE ccat.Cost_Category_Id 
			WHEN @PartsCategory THEN ISNULL(pta.Parts_Cost_Expense_ID, ss.Cost_Expense_ID) 
			WHEN @LabourCategory THEN ISNULL(pta.Labour_Cost_Expense_ID, ss.Cost_Expense_ID) 
			WHEN @MiscCategory THEN ISNULL(pta.Misc_Cost_Expense_ID, ss.Cost_Expense_ID) 
		END,
		ccat.Cost_Category_Id,
		ep.Eqp_Category_Id,		--Added ID
		pta.Work_Group_Id		--Added ID


--=====================================================================================================

-- Unassigned tasks Occs

CREATE TABLE #EQPPROJ_PERIOD(EqpProjId INT NOT NULL, CalenderPeriod INT NOT NULL, StartPeriodDate DATETIME NOT NULL, EndPeriodDate DATETIME NOT NULL, OccDate DATETIME NOT NULL)
CREATE INDEX #EQPPROJ_PERIOD_ind ON #EQPPROJ_PERIOD(EqpProjId, CalenderPeriod)
CREATE INDEX #EQPPROJ_PERIOD_ind2 ON #EQPPROJ_PERIOD(EqpProjId, OccDate)
--DROP TABLE #EQPPROJ_PERIOD
--SELECT * FROM #EQPPROJ_PERIOD

DECLARE @TodaysDate datetime
SET @TodaysDate = getdate()
DECLARE @CurrentPeriod INT
SET @CurrentPeriod = YEAR(@TodaysDate)*100+MONTH(@TodaysDate)

INSERT #EQPPROJ_PERIOD
SELECT	per.*,
	CASE	WHEN per.CalenderPeriod = @CurrentPeriod AND per.StartPeriodDate < @TodaysDate AND per.EndPeriodDate > @TodaysDate
		THEN DATEADD(Hour, DATEDIFF(Hour, @TodaysDate, per.EndPeriodDate) / 2, @TodaysDate)
		ELSE DATEADD(Hour, DATEDIFF(Hour, per.StartPeriodDate, per.EndPeriodDate) / 2, per.StartPeriodDate)
	END as OccDate
FROM (
	SELECT	p.EqpProjId, fper.CalenderPeriod,
		CASE 	WHEN ep.StartDate > CAST(CAST(fper.CalenderPeriod as varchar)+'01' as datetime)
			THEN ep.StartDate
			ELSE CAST(CAST(fper.CalenderPeriod as varchar)+'01' as datetime)
		END as StartPeriodDate,
		CASE 	WHEN fper.CalenderPeriod = YEAR(p.EndDate)*100+MONTH(p.EndDate)
			THEN p.EndDate
			WHEN DATEADD(Month, @MonthsToAdd, p.EndDate) < DATEADD(Month, 1, CAST(CAST(fper.CalenderPeriod as varchar)+'01' as datetime))
			THEN DATEADD(Month, @MonthsToAdd, p.EndDate)
			ELSE DATEADD(Month, 1, CAST(CAST(fper.CalenderPeriod as varchar)+'01' as datetime))
		END as EndPeriodDate
	FROM	tblEqpPlans ep
		LEFT JOIN tblEqpProjs p ON p.EqpPlanId = ep.EqpPlanId
		INNER JOIN tblFinancialPeriods fper ON fper.CalenderPeriod >= YEAR(ep.StartDate)*100+MONTH(ep.StartDate) AND fper.CalenderPeriod <= YEAR(DATEADD(Month, @MonthsToAdd, p.EndDate))*100+MONTH(DATEADD(Month, @MonthsToAdd, p.EndDate))
	WHERE	( (fper.CalenderPeriod >= @CurrentPeriod AND p.Projection_Type_Id IN (1,3)) 
			OR p.Projection_Type_Id NOT IN (1,3) )
		AND DATEADD(Month, @MonthsToAdd, p.EndDate) >=@TodaysDate
		AND p.EqpProjId IN (	SELECT DISTINCT prtsk.EqpProjId
					FROM	tblProjTasks prtsk
						INNER JOIN BUDGET_TASK btsk ON btsk.Proj_Task_ID = prtsk.ProjTaskId
						INNER JOIN #z_BudgetEqpToBeUpdated0 zBE ON zBE.Budget_Equipment_Id = btsk.Budget_Equipment_Id
		)
) per
WHERE
	CASE WHEN per.CalenderPeriod = @CurrentPeriod AND per.StartPeriodDate < @TodaysDate AND per.EndPeriodDate > @TodaysDate
		THEN DATEADD(Hour, DATEDIFF(Hour, @TodaysDate, per.EndPeriodDate) / 2, @TodaysDate)
		ELSE DATEADD(Hour, DATEDIFF(Hour, per.StartPeriodDate, per.EndPeriodDate) / 2, per.StartPeriodDate)
	END BETWEEN @BudStartDate AND @BudEndDateExtraOcc
UNION -- Add additional 1 occurence between EqpEndDate and the end of this period
SELECT 	p.EqpProjId, fper.CalenderPeriod, 
	p.EndDate as StartPeriodDate,
	DATEADD(Month, 1, CAST(CAST(fper.CalenderPeriod as varchar)+'01' as datetime)) as EndPeriodDate,
	DATEADD(Hour, DATEDIFF(Hour, p.EndDate, DATEADD(Month, 1, CAST(CAST(fper.CalenderPeriod as varchar)+'01' as datetime))) / 2, p.EndDate) as OccDate
FROM	tblEqpPlans ep
	LEFT JOIN tblEqpProjs p ON p.EqpPlanId = ep.EqpPlanId
	INNER JOIN tblFinancialPeriods fper ON fper.CalenderPeriod >= YEAR(ep.StartDate)*100+MONTH(ep.StartDate) AND fper.CalenderPeriod <= YEAR(DATEADD(Month, @MonthsToAdd, p.EndDate))*100+MONTH(DATEADD(Month, @MonthsToAdd, p.EndDate))
WHERE	( (fper.CalenderPeriod >= @CurrentPeriod AND p.Projection_Type_Id IN (1,3)) 
		OR p.Projection_Type_Id NOT IN (1,3) )
	AND DATEADD(Month, @MonthsToAdd, p.EndDate) >=@TodaysDate
	AND p.EqpProjId IN (	SELECT DISTINCT prtsk.EqpProjId
				FROM	tblProjTasks prtsk
					INNER JOIN BUDGET_TASK btsk ON btsk.Proj_Task_ID = prtsk.ProjTaskId
					INNER JOIN #z_BudgetEqpToBeUpdated0 zBE ON zBE.Budget_Equipment_Id = btsk.Budget_Equipment_Id
	)
	AND fper.CalenderPeriod = YEAR(p.EndDate)*100+MONTH(p.EndDate)
	AND DATEADD(Hour, DATEDIFF(Hour, p.EndDate, DATEADD(Month, 1, CAST(CAST(fper.CalenderPeriod as varchar)+'01' as datetime))) / 2, p.EndDate) BETWEEN @BudStartDate AND @BudEndDateExtraOcc


CREATE TABLE #EQPPROJ_OCC(EqpProjId INT NOT NULL, QUOMId INT NULL, OccDate DATETIME NOT NULL, OccUsage FLOAT NULL)
CREATE INDEX #EQPPROJ_OCC_ind ON #EQPPROJ_OCC(EqpProjId, QUOMId)

INSERT	INTO #EQPPROJ_OCC
SELECT	epr.EqpProjId, eplSU.StartUsageQUOMId, 
	us.OccDate,
	/*VV #3798
	CASE epl.Utilisation_Method_Id 
		WHEN 1 THEN
			paus.PreviousUsage
			+ (usta2.CumStartUsage + 
				(CONVERT(FLOAT, us.OccDate) - CONVERT(FLOAT, ust2.StartDate))
				 / (CONVERT(FLOAT, ust2.EndDate) - CONVERT(FLOAT, ust2.StartDate))
				 * (usta2.CumEndUsage - usta2.CumStartUsage)
			  )
			- (usta1.CumStartUsage + 
				(CONVERT(FLOAT, paus.PreviousUsageDate) - CONVERT(FLOAT, ust1.StartDate))
				/ (CONVERT(FLOAT, ust1.EndDate) - CONVERT(FLOAT, ust1.StartDate))
			 	* (usta1.CumEndUsage - usta1.CumStartUsage)
			  )
		WHEN 2 THEN
			ISNULL(paus.PreviousUsage, eplSU.StartUsage)
				+ dbo.SIMPLE_UTILISATION_USAGE_F (ISNULL(paus.PreviousUsageDate, epl.StartDate), us.OccDate, epr.Annual_Utilisation)
		ELSE CAST(us.OccDate as FLOAT) - CAST(epl.StartDate as FLOAT)
	END as OccUsage*/
	CASE 
	WHEN ISNULL(ptQUOM.UsageQUOMId,0)=0 OR epl.Utilisation_Method_Id=3 THEN 
		CAST(us.OccDate as FLOAT) - CAST(epl.StartDate as FLOAT)
	
	WHEN epl.Utilisation_Method_Id=1 THEN
		paus.PreviousUsage
		+ (usta2.CumStartUsage + 
			(CONVERT(FLOAT, us.OccDate) - CONVERT(FLOAT, ust2.StartDate))
			 / (CONVERT(FLOAT, ust2.EndDate) - CONVERT(FLOAT, ust2.StartDate))
			 * (usta2.CumEndUsage - usta2.CumStartUsage)
		  )
		- (usta1.CumStartUsage + 
			(CONVERT(FLOAT, paus.PreviousUsageDate) - CONVERT(FLOAT, ust1.StartDate))
			/ (CONVERT(FLOAT, ust1.EndDate) - CONVERT(FLOAT, ust1.StartDate))
		 	* (usta1.CumEndUsage - usta1.CumStartUsage)
		  )
	/*WHEN epl.Utilisation_Method_Id=2 THEN*/
	ELSE
		ISNULL(paus.PreviousUsage, eplSU.StartUsage)
			+ dbo.SIMPLE_UTILISATION_USAGE_F (ISNULL(paus.PreviousUsageDate, epl.StartDate), us.OccDate, epr.Annual_Utilisation)
	END as OccUsage
FROM	tblEqpProjs epr
	LEFT JOIN tblEqpPlans epl ON epl.EqpPlanId = epr.EqpPlanId
	INNER JOIN #EQPPROJ_PERIOD us ON us.EqpProjId = epr.EqpProjId
	LEFT JOIN (	SELECT DISTINCT prtsk.EqpProjId, prtsk.UsageQUOMId
				FROM	tblProjTasks prtsk
						INNER JOIN BUDGET_TASK btsk ON btsk.Proj_Task_ID = prtsk.ProjTaskId
						INNER JOIN #z_BudgetEqpToBeUpdated0 zBE ON zBE.Budget_Equipment_Id = btsk.Budget_Equipment_Id
	) ptQUOM ON ptQUOM.EqpProjId = epr.EqpProjId
	LEFT JOIN tblEqpPlanStartUsages eplSU ON eplSU.EqpPlanId = epr.EqpPlanId AND ISNULL(ptQUOM.UsageQUOMId,0) = ISNULL(eplSU.StartUsageQUOMId,0)
	LEFT JOIN (	SELECT	aus.EquipmentId, aus.QUOMId, MAX(ActualUsage) as PreviousUsage, MAX(RecordingDate) as PreviousUsageDate
			FROM	tblActualUsages aus
				LEFT JOIN tblEqpPlans epl ON epl.EquipmentId = aus.EquipmentId
			WHERE	aus.RecordingDate <= @TodaysDate OR aus.RecordingDate <=epl.StartDate
			GROUP BY aus.EquipmentId, aus.QUOMId
	) paus ON paus.EquipmentId = epl.EquipmentId AND paus.QUOMId=eplSU.StartUsageQUOMId
	LEFT JOIN tblUsageSteps ust1 ON ust1.UsageProfileId = epr.ProjUsageProfileId
				AND ust1.StartDate <= ISNULL(paus.PreviousUsageDate, epl.StartDate)
				AND ust1.EndDate > ISNULL(paus.PreviousUsageDate, epl.StartDate)
	LEFT JOIN tblUsageStepAmts usta1 ON ust1.UsageStepId = usta1.UsageStepId 
				AND usta1.UsageQUOMId = eplSU.StartUsageQUOMId
				AND usta1.UsagePerCalYear <> 0
	LEFT JOIN tblUsageSteps ust2 ON ust2.UsageProfileId = epr.ProjUsageProfileId
				AND ust2.StartDate <= us.OccDate
				AND ust2.EndDate > us.OccDate
	LEFT JOIN tblUsageStepAmts usta2 ON ust2.UsageStepId = usta2.UsageStepId 
				AND usta2.UsageQUOMId = eplSU.StartUsageQUOMId
				AND usta2.UsagePerCalYear <> 0
/* VV #3798
WHERE ((usta2.UsageStepId IS NOT NULL AND usta1.UsageStepId IS NOT NULL) OR epl.Utilisation_Method_Id <> 1)
*/
--ORDER BY epr.EqpProjId




INSERT INTO BUDGET_OCC (
	Budget_Task_ID, 
	Proj_Task_Opt_ID,
	is_Actual_Cost, 
	Cost_Date, 
	Occ_Usage, 
	Downtime_Hours)
SELECT	btsk.Budget_Task_Id, 
	NULL as ProjTaskOptId,
	0 AS is_Actual_Cost, 
	occ.OccDate as Cost_Date,
	ROUND(CASE WHEN prtsk.UsageQUOMId IS NOT NULL THEN occ.OccUsage ELSE CAST(occ.OccDate as FLOAT)-CAST(epl.StartDate as FLOAT) END, 2) as OccUsage,
	0 AS Downtime_Hours
FROM	tblProjTasks prtsk
	LEFT JOIN tblEqpProjs epr ON epr.EqpProjId = prtsk.EqpProjId
	LEFT JOIN tblEqpPlans epl ON epl.EqpPlanId = epr.EqpPlanId
	INNER JOIN #EQPPROJ_OCC occ ON occ.EqpProjId = prtsk.EqpProjId AND ISNULL(occ.QUOMId,0) = ISNULL(prtsk.UsageQUOMId,0)
 	INNER JOIN BUDGET_TASK btsk ON btsk.Proj_Task_ID = prtsk.ProjTaskId
	INNER JOIN #z_BudgetEqpToBeUpdated0 zBE ON zBE.Budget_Equipment_Id = btsk.Budget_Equipment_Id
WHERE	prtsk.Unscheduled <> 0
	AND prtsk.ProjTaskId IN (	SELECT	DISTINCT prtsk.ProjTaskId
					FROM	tblProjTasks prtsk
						LEFT JOIN tblProjTaskOpts pto ON prtsk.ProjTaskId = pto.ProjTaskId
						LEFT JOIN PROJ_TASK_AMT_COST_1_V pta ON pto.ProjTaskOptId = pta.ProjTaskOptId
					 	INNER JOIN BUDGET_TASK btsk ON btsk.Proj_Task_ID = prtsk.ProjTaskId
						INNER JOIN #z_BudgetEqpToBeUpdated0 zBE ON zBE.Budget_Equipment_Id = btsk.Budget_Equipment_Id
					WHERE	prtsk.Unscheduled <> 0
						AND prtsk.Frequency > 0
						AND pto.Probability <> 0
						AND (
							pta.PartsCost <> 0
							OR (pta.Duration <> 0 AND btsk.Is_Downtime_Task = 1)
							OR pta.TotalLabourCost <> 0
							--OR pta.LaborHours <> 0
							OR pta.TotalMiscCost <> 0
						)
	)
--ORDER BY prtsk.ProjTaskId, occ.OccDate



--=====================================================================================================
-- Unassigned tasks cost calculation


CREATE TABLE #EQPPROJ_OCC_COST(EqpProjId INT NOT NULL, QUOMId INT NULL, StartPeriodDate DATETIME NOT NULL, StartPeriodUsage FLOAT NOT NULL, EndPeriodUsage FLOAT NOT NULL)
CREATE INDEX #EQPPROJ_OCC_COST_ind ON #EQPPROJ_OCC_COST(EqpProjId, QUOMId, StartPeriodDate)
-- DROP TABLE #EQPPROJ_OCC
 
				
INSERT	INTO #EQPPROJ_OCC_COST
SELECT	epr.EqpProjId, eplSU.StartUsageQUOMId, 
	us.StartPeriodDate,
	CASE WHEN epl.Utilisation_Method_Id = 1 AND ptQUOM.UsageQUOMId IS NOT NULL
			THEN 
			paus.PreviousUsage
			+ (usta2.CumStartUsage + 
				(CONVERT(FLOAT, us.StartPeriodDate) - CONVERT(FLOAT, ust2.StartDate))
				 / (CONVERT(FLOAT, ust2.EndDate) - CONVERT(FLOAT, ust2.StartDate))
				 * (usta2.CumEndUsage - usta2.CumStartUsage)
			  )
			- (usta1.CumStartUsage + 
				(CONVERT(FLOAT, paus.PreviousUsageDate) - CONVERT(FLOAT, ust1.StartDate))
				/ (CONVERT(FLOAT, ust1.EndDate) - CONVERT(FLOAT, ust1.StartDate))
			 	* (usta1.CumEndUsage - usta1.CumStartUsage)
			  )
		WHEN epl.Utilisation_Method_Id = 2 AND ptQUOM.UsageQUOMId IS NOT NULL
			THEN 
			ISNULL(paus.PreviousUsage, eplSU.StartUsage)
				+ dbo.SIMPLE_UTILISATION_USAGE_F (ISNULL(paus.PreviousUsageDate, epl.StartDate), us.StartPeriodDate, epr.Annual_Utilisation)
		ELSE CAST(us.StartPeriodDate as FLOAT) - CAST(epl.StartDate as FLOAT)
	END as StartUsage,
	CASE WHEN epl.Utilisation_Method_Id = 1 AND ptQUOM.UsageQUOMId IS NOT NULL
			THEN 
			paus.PreviousUsage
			+ (usta3.CumStartUsage + 
				(CONVERT(FLOAT, us.EndPeriodDate) - CONVERT(FLOAT, ust3.StartDate))
				 / (CONVERT(FLOAT, ust3.EndDate) - CONVERT(FLOAT, ust3.StartDate))
				 * (usta3.CumEndUsage - usta3.CumStartUsage)
			  )
			- (usta1.CumStartUsage + 
				(CONVERT(FLOAT, paus.PreviousUsageDate) - CONVERT(FLOAT, ust1.StartDate))
				/ (CONVERT(FLOAT, ust1.EndDate) - CONVERT(FLOAT, ust1.StartDate))
			 	* (usta1.CumEndUsage - usta1.CumStartUsage)
			  )
		WHEN epl.Utilisation_Method_Id = 2 AND ptQUOM.UsageQUOMId IS NOT NULL 
			THEN 
			ISNULL(paus.PreviousUsage, eplSU.StartUsage)
				+ dbo.SIMPLE_UTILISATION_USAGE_F (ISNULL(paus.PreviousUsageDate, epl.StartDate), us.EndPeriodDate, epr.Annual_Utilisation)
		ELSE CAST(us.EndPeriodDate as FLOAT) - CAST(epl.StartDate as FLOAT)
	END as EndUsage
FROM	tblEqpProjs epr
	LEFT JOIN tblEqpPlans epl ON epl.EqpPlanId = epr.EqpPlanId
	INNER JOIN #EQPPROJ_PERIOD us ON us.EqpProjId = epr.EqpProjId
	LEFT JOIN (	SELECT DISTINCT prtsk.EqpProjId, prtsk.UsageQUOMId
				FROM	tblProjTasks prtsk
						INNER JOIN BUDGET_TASK btsk ON btsk.Proj_Task_ID = prtsk.ProjTaskId
						INNER JOIN #z_BudgetEqpToBeUpdated0 zBE ON zBE.Budget_Equipment_Id = btsk.Budget_Equipment_Id
	) ptQUOM ON ptQUOM.EqpProjId = epr.EqpProjId
	LEFT JOIN tblEqpPlanStartUsages eplSU ON eplSU.EqpPlanId = epr.EqpPlanId AND ISNULL(ptQUOM.UsageQUOMId,0) = ISNULL(eplSU.StartUsageQUOMId,0)
	LEFT JOIN (	SELECT	aus.EquipmentId, aus.QUOMId, MAX(ActualUsage) as PreviousUsage, MAX(RecordingDate) as PreviousUsageDate
			FROM	tblActualUsages aus
				LEFT JOIN tblEqpPlans epl ON epl.EquipmentId = aus.EquipmentId
			WHERE	aus.RecordingDate <= @TodaysDate OR aus.RecordingDate <=epl.StartDate
			GROUP BY aus.EquipmentId, aus.QUOMId
	) paus ON paus.EquipmentId = epl.EquipmentId AND paus.QUOMId=eplSU.StartUsageQUOMId
	LEFT JOIN tblUsageSteps ust1 ON ust1.UsageProfileId = epr.ProjUsageProfileId
				AND ust1.StartDate <= ISNULL(paus.PreviousUsageDate, epl.StartDate)
				AND ust1.EndDate > ISNULL(paus.PreviousUsageDate, epl.StartDate)
	LEFT JOIN tblUsageStepAmts usta1 ON ust1.UsageStepId = usta1.UsageStepId 
				AND usta1.UsageQUOMId = eplSU.StartUsageQUOMId
				--AND usta1.UsagePerCalYear <> 0
	LEFT JOIN tblUsageSteps ust2 ON ust2.UsageProfileId = epr.ProjUsageProfileId
				AND ust2.StartDate <= us.StartPeriodDate
				AND ust2.EndDate > us.StartPeriodDate
	LEFT JOIN tblUsageStepAmts usta2 ON ust2.UsageStepId = usta2.UsageStepId 
				AND usta2.UsageQUOMId = eplSU.StartUsageQUOMId
				--AND usta2.UsagePerCalYear <> 0
	LEFT JOIN tblUsageSteps ust3 ON ust3.UsageProfileId = epr.ProjUsageProfileId
				AND ust3.StartDate <= us.EndPeriodDate
				AND ust3.EndDate > us.EndPeriodDate
	LEFT JOIN tblUsageStepAmts usta3 ON ust3.UsageStepId = usta3.UsageStepId 
				AND usta3.UsageQUOMId = eplSU.StartUsageQUOMId
				--AND usta3.UsagePerCalYear <> 0
/* VV #3798 WHERE ((usta2.UsageStepId IS NOT NULL AND usta3.UsageStepId IS NOT NULL AND usta1.UsageStepId IS NOT NULL) 
	OR epl.Utilisation_Method_Id <> 1)
*/
--ORDER BY epr.EqpProjId





CREATE TABLE #EQPPROJ_ENDUSAGE(EqpProjId INT NOT NULL, QUOMId FLOAT NULL, EndUsage FLOAT NULL)
CREATE INDEX #EQPPROJ_ENDUSAGE_ind ON #EQPPROJ_ENDUSAGE(EqpProjId, QUOMId)

INSERT #EQPPROJ_ENDUSAGE
SELECT eqppr.EqpProjId, eqpquom.QUOMId, dbo.GET_USAGE_FROM_DATE_F(eqppr.EqpProjId, eqpquom.QUOMId, eqppr.EndDate) as EndUsage
FROM	tblEqpProjs eqppr
	INNER JOIN ( -- get all possible QUOM
		SELECT DISTINCT eqppr.EqpProjId, prtsk.UsageQUOMId as QUOMId
		FROM	tblEqpProjs eqppr
			INNER JOIN tblProjTasks prtsk ON eqppr.EqpProjId = prtsk.EqpProjId
			LEFT JOIN BUDGET_TASK btsk ON btsk.Proj_Task_Id = prtsk.ProjTaskId
			INNER JOIN #z_BudgetEqpToBeUpdated0 zBE ON zBE.Budget_Equipment_Id = btsk.Budget_Equipment_Id
	) eqpquom ON eqpquom.EqpProjId = eqppr.EqpProjId


	INSERT INTO BUDGET_COST
		(Budget_Occ_ID, Cost_Bearer_ID, Cost, Sell, Cost_Centre_ID, Cost_Expense_ID, Cost_Category_Id,Eqp_Category_Id, Work_Group_Id) --Added ID
	SELECT 
		bocc.Budget_Occ_Id, 
		ISNULL(pta.Cost_Bearer_ID, ep.Default_Cost_Bearer_ID) AS Cost_Bearer_ID,
		ROUND(
		  SUM(	CASE WHEN ccat.Cost_Category_Id = @PartsCategory THEN
				dbo.COST_PERIOD_RATIO_F(ISNULL(eqpplSU.StartUsage,0), epEU.EndUsage, p.Cost_Ratio, eocc.StartPeriodUsage, eocc.EndPeriodUsage, pt.Frequency) *
				(pta.PartsCost * pto.Probability * cpe.CumPartsEscalation / cpe1.CumPartsEscalation) * 
				(100 - CASE WHEN p.Projection_Type_ID IN (1,3) THEN FSM.SystemMargin ELSE ep.Budget_Margin_Parts END) 
				/ 10000 / erc.ExRate
			WHEN ccat.Cost_Category_Id = @LabourCategory THEN
				dbo.COST_PERIOD_RATIO_F(ISNULL(eqpplSU.StartUsage,0), epEU.EndUsage, p.Cost_Ratio, eocc.StartPeriodUsage, eocc.EndPeriodUsage, pt.Frequency) *
				(pta.TotalLabourCost * pto.Probability * ce.CumLaborEscalation / ce1.CumLaborEscalation) * 
				(100 - CASE WHEN p.Projection_Type_ID IN (1,3) THEN f.LabMargin ELSE ep.Budget_Margin_Labour END) 
				/ 10000 / erc.ExRate
			ELSE 
				dbo.COST_PERIOD_RATIO_F(ISNULL(eqpplSU.StartUsage,0), epEU.EndUsage, p.Cost_Ratio, eocc.StartPeriodUsage, eocc.EndPeriodUsage, pt.Frequency) *
				(pta.TotalMiscCost * pto.Probability * ce.CumMiscEscalation / ce1.CumMiscEscalation) * 
				(100 - CASE WHEN p.Projection_Type_ID IN (1,3) THEN f.MiscMargin ELSE ep.Budget_Margin_Misc END) 
				/ 10000 / erc.ExRate
			END
		  ), 2) AS Cost,
		ROUND(
		  SUM(	CASE WHEN ccat.Cost_Category_Id = @PartsCategory THEN
				dbo.COST_PERIOD_RATIO_F(ISNULL(eqpplSU.StartUsage,0), epEU.EndUsage, p.Cost_Ratio, eocc.StartPeriodUsage, eocc.EndPeriodUsage, pt.Frequency) *
				pta.PartsCost * pto.Probability * cpe.CumPartsEscalation / cpe1.CumPartsEscalation / 100 / erc.ExRate
			WHEN ccat.Cost_Category_Id = @LabourCategory THEN
				dbo.COST_PERIOD_RATIO_F(ISNULL(eqpplSU.StartUsage,0), epEU.EndUsage, p.Cost_Ratio, eocc.StartPeriodUsage, eocc.EndPeriodUsage, pt.Frequency) *
				pta.TotalLabourCost * pto.Probability * ce.CumLaborEscalation / ce1.CumLaborEscalation / 100 / erc.ExRate
			ELSE 
				dbo.COST_PERIOD_RATIO_F(ISNULL(eqpplSU.StartUsage,0), epEU.EndUsage, p.Cost_Ratio, eocc.StartPeriodUsage, eocc.EndPeriodUsage, pt.Frequency) *
				pta.TotalMiscCost * pto.Probability * ce.CumMiscEscalation / ce1.CumMiscEscalation / 100 / erc.ExRate
			END
		  ), 2) AS Sell,
		ISNULL(pta.Cost_Centre_ID, ep.Cost_Centre_ID) AS Cost_Centre_ID, 
		CASE ccat.Cost_Category_Id 
			WHEN @PartsCategory THEN ISNULL(pta.Parts_Cost_Expense_ID, ss.Cost_Expense_ID) 
			WHEN @LabourCategory THEN ISNULL(pta.Labour_Cost_Expense_ID, ss.Cost_Expense_ID) 
			WHEN @MiscCategory THEN ISNULL(pta.Misc_Cost_Expense_ID, ss.Cost_Expense_ID) 
		END AS Cost_Expense_ID,
		ccat.Cost_Category_Id AS Cost_Category_Id,
		ep.Eqp_Category_Id,		--Added ID
		pta.Work_Group_Id		--Added ID
	FROM	
		tblFleets f
		LEFT JOIN tblEqpPlans ep ON ep.FleetId = f.FleetId
		LEFT JOIN tblEqpProjs p ON p.EqpPlanId = ep.EqpPlanId
		LEFT JOIN tblProjTasks pt ON p.EqpProjId = pt.EqpProjId
		INNER JOIN BUDGET_TASK btsk ON btsk.Proj_Task_Id = pt.ProjTaskId
		LEFT JOIN BUDGET_OCC bocc ON bocc.Budget_Task_Id = btsk.Budget_Task_Id
		INNER JOIN #z_BudgetEqpToBeUpdated0 zBE ON zBE.Budget_Equipment_Id = btsk.Budget_Equipment_Id
		LEFT JOIN tblEqpPlanStartUsages eqpplSU ON eqpplSU.EqpPlanId = ep.EqpPlanId AND eqpplSU.StartUsageQUOMId = pt.UsageQUOMId
		INNER JOIN #EQPPROJ_ENDUSAGE epEU ON epEU.EqpProjId = pt.EqpProjId AND ISNULL(epEU.QUOMId,0) = ISNULL(pt.UsageQUOMId,0)
		LEFT JOIN tblProjTaskOpts pto ON pt.ProjTaskId = pto.ProjTaskId
		INNER JOIN #EQPPROJ_PERIOD eper ON eper.EqpProjId = p.EqpProjId
				AND eper.OccDate = bocc.Cost_Date
		INNER JOIN #EQPPROJ_OCC_COST eocc ON eocc.EqpProjId = p.EqpProjId 
				AND ISNULL(eocc.QUOMId,0) = ISNULL(pt.UsageQUOMId,0)
				AND eocc.StartPeriodDate = eper.StartPeriodDate
		LEFT JOIN PROJ_TASK_AMT_COST_1_V pta ON pto.ProjTaskOptId = pta.ProjTaskOptId
	 	LEFT JOIN tblComponentCodes cc ON pt.ComponentCodeId = cc.ComponentCodeID
	 	LEFT JOIN tblSubSystems ss ON cc.SubSystemID = ss.SubSystemID
	 	--LEFT JOIN tblTaskTypes tt ON pt.TaskTypeId = tt.TaskTypeID
	 	LEFT JOIN tblFleetSystemMargins FSM ON FSM.SystemID = ss.SystemID AND f.FleetId = FSM.FleetID 
		LEFT JOIN tblExRateCurrencies erc ON pta.CurrencyId = erc.CurrencyID AND p.ExchangeRateId = erc.ExRateID
		LEFT JOIN tblCostEscalations ce ON ce.EndDate > pta.Pricing_Date AND ce.EscalationDate <= pta.Pricing_Date 
		LEFT JOIN tblCostPartsEscalations cpe ON ce.CostEscalationId = cpe.CostEscalationId AND cpe.ManufacturerId = pt.ManufacturerId
		LEFT JOIN tblCostEscalations ce1 ON bocc.Cost_Date >= ce1.EscalationDate AND bocc.Cost_Date < ce1.EndDate
		LEFT JOIN tblCostPartsEscalations cpe1 ON ce1.CostEscalationId = cpe1.CostEscalationId AND pt.ManufacturerId = cpe1.ManufacturerId
		CROSS JOIN COST_CATEGORY ccat
	WHERE	--p.Projection_Type_ID IN (1, 3)
		--AND 
		pto.Probability <> 0
		AND (
			(ccat.Cost_Category_Id = 1 AND pta.PartsCost <> 0 )
			OR (ccat.Cost_Category_Id = 2 AND pta.TotalLabourCost <> 0 )
			OR (ccat.Cost_Category_Id = 3 AND pta.TotalMiscCost <> 0 )
		)
		AND pt.Unscheduled <> 0
		AND ( @WorkGroupId=',,' OR CHARINDEX(','+CAST(pta.Work_Group_ID as varchar(16))+',', @WorkGroupId)>0 )  --E752
		--AND btsk.Budget_Equipment_Id = 904
	GROUP BY 
		bocc.Budget_Occ_Id, 
		ISNULL(pta.Cost_Bearer_ID, ep.Default_Cost_Bearer_ID),
		ISNULL(pta.Cost_Centre_ID, ep.Cost_Centre_ID), 
		CASE ccat.Cost_Category_Id 
			WHEN @PartsCategory THEN ISNULL(pta.Parts_Cost_Expense_ID, ss.Cost_Expense_ID) 
			WHEN @LabourCategory THEN ISNULL(pta.Labour_Cost_Expense_ID, ss.Cost_Expense_ID) 
			WHEN @MiscCategory THEN ISNULL(pta.Misc_Cost_Expense_ID, ss.Cost_Expense_ID) 
		END,
		ccat.Cost_Category_Id,
		ep.Eqp_Category_Id,		--Added ID
		pta.Work_Group_Id		--Added ID



DROP TABLE #EQPPROJ_PERIOD
DROP TABLE #EQPPROJ_OCC
DROP TABLE #EQPPROJ_OCC_COST
DROP TABLE #EQPPROJ_ENDUSAGE


-- 	-- Labour PTO = NULL
-- 	INSERT INTO BUDGET_COST
-- 	                      (Budget_Occ_ID, Cost_Bearer_ID, Cost, Sell, Cost_Centre_ID, Cost_Expense_ID, Cost_Category_Id,Eqp_Category_Id)
-- 	SELECT 
-- 		BPO.Budget_Occ_ID, 
-- 		pta.Cost_Bearer_ID AS Cost_Bearer_ID, 
-- 		ROUND(SUM((pta.TotalLabourCost * pto.Probability * ce.CumLaborEscalation / ce1.CumLaborEscalation) * (100 - f.LabMargin) / 10000 / erc.ExRate),2) as Cost, 
-- 		ROUND(SUM(pta.TotalLabourCost * pto.Probability * ce.CumLaborEscalation / ce1.CumLaborEscalation / 100 / erc.ExRate),2) AS Sell, 
-- 		ISNULL(pta.CostCentreID, ep.Cost_Centre_ID) AS Cost_Centre_ID, pta.Labour_Cost_Expense_ID AS Cost_Expense_ID, 
-- 	             @LabourCategory AS Cost_Category_Id, ep.Eqp_Category_Id
-- 	FROM         dbo.tblCostPartsEscalations cpe1 INNER JOIN
-- 	                      dbo.tblCostEscalations ce1 ON cpe1.CostEscalationId = ce1.CostEscalationId INNER JOIN
-- 	                      dbo.tblCostEscalations ce INNER JOIN
-- 	                      dbo.tblCostPartsEscalations cpe ON ce.CostEscalationId = cpe.CostEscalationId INNER JOIN
-- 	                      dbo.tblEqpProjs p INNER JOIN
-- 	                      dbo.tblEqpPlans ep ON p.EqpPlanId = ep.EqpPlanId INNER JOIN
-- 	                      dbo.tblFleets f ON ep.FleetId = f.FleetId INNER JOIN
-- 	                      dbo.tblProjTasks pt ON p.EqpProjId = pt.EqpProjId INNER JOIN
-- 	                      dbo.tblComponentCodes cc ON pt.ComponentCodeId = cc.ComponentCodeID INNER JOIN
-- 	                      dbo.tblProjTaskOpts pto ON pt.ProjTaskId = pto.ProjTaskId INNER JOIN
-- 	                      dbo.PROJ_TASK_AMT_COST_V pta ON pto.ProjTaskOptId = pta.ProjTaskOptId INNER JOIN
-- 	                      dbo.tblExRateCurrencies erc ON pta.CurrencyId = erc.CurrencyID AND p.ExchangeRateId = erc.ExRateID ON cpe.ManufacturerId = pt.ManufacturerId AND
-- 	                       ce.EndDate > pta.Pricing_Date AND ce.EscalationDate <= pta.Pricing_Date INNER JOIN
-- 	                      dbo.tblFleetSystemMargins FSM ON f.FleetId = FSM.FleetID INNER JOIN
-- 	                      dbo.tblSubSystems ss ON FSM.SystemID = ss.SystemID AND cc.SubSystemID = ss.SubSystemID ON 
-- 
-- 	                      cpe1.ManufacturerId = pt.ManufacturerId INNER JOIN
-- 	                      dbo.tblTaskTypes tt ON pt.TaskTypeId = tt.TaskTypeID INNER JOIN
-- 		        dbo.BUDGET_TASK BPT ON BPT.Proj_Task_Id = pt.ProjTaskId INNER JOIN
-- 	                      dbo.BUDGET_OCC BPO ON BPT.Budget_Task_ID = BPO.Budget_Task_ID AND ce1.EscalationDate <= BPO.Cost_Date AND ce1.EndDate > BPO.Cost_Date INNER JOIN
-- 		         #z_BudgetEqpToBeUpdated0 TempBE ON  BPT.Budget_Equipment_Id = TempBE.Budget_Equipment_Id
-- 	WHERE     (ABS(pta.TotalLabourCost) * pto.Probability <> 0) AND (BPO.Proj_Task_Opt_ID IS NULL) 
-- 	GROUP BY  BPO.Budget_Occ_ID,pta.Cost_Bearer_ID,  ISNULL(pta.CostCentreID, ep.Cost_Centre_ID),pta.Labour_Cost_Expense_ID,ep.Eqp_Category_Id
-- 	
-- 	-- Labour PTO <> NULL
-- 
-- 	INSERT INTO BUDGET_COST
-- 	                      (Budget_Occ_ID, Cost_Bearer_ID, Cost, Sell, Cost_Centre_ID, Cost_Expense_ID,  Cost_Category_Id,Eqp_Category_Id)
-- 	SELECT     
-- 		BPO.Budget_Occ_ID, pta.Cost_Bearer_ID AS Cost_Bearer_ID, 
-- 		ROUND(SUM((pta.TotalLabourCost * ce.CumLaborEscalation / ce1.CumLaborEscalation) * (100 - f.LabMargin) / 100 / erc.ExRate),2) AS Cost, 
-- 		ROUND(SUM(pta.TotalLabourCost * ce.CumLaborEscalation / ce1.CumLaborEscalation / erc.ExRate),2) AS Sell, 
-- 		ISNULL(pta.CostCentreID, ep.Cost_Centre_ID) AS Cost_Centre_ID, pta.Labour_Cost_Expense_ID AS Cost_Expense_ID,  
-- 		@LabourCategory AS Cost_Category_Id,ep.Eqp_Category_Id
-- 	FROM         dbo.tblCostPartsEscalations cpe1 INNER JOIN
-- 	                      dbo.tblCostEscalations ce1 ON cpe1.CostEscalationId = ce1.CostEscalationId INNER JOIN
-- 	                      dbo.tblCostEscalations ce INNER JOIN
-- 	                      dbo.tblCostPartsEscalations cpe ON ce.CostEscalationId = cpe.CostEscalationId INNER JOIN
-- 	                      dbo.tblEqpProjs p INNER JOIN
-- 	                      dbo.tblEqpPlans ep ON p.EqpPlanId = ep.EqpPlanId INNER JOIN
-- 	                      dbo.tblFleets f ON ep.FleetId = f.FleetId INNER JOIN
-- 	                      dbo.tblProjTasks pt ON p.EqpProjId = pt.EqpProjId INNER JOIN
-- 	                      dbo.tblComponentCodes cc ON pt.ComponentCodeId = cc.ComponentCodeID INNER JOIN
-- 	                      dbo.tblProjTaskOpts pto ON pt.ProjTaskId = pto.ProjTaskId INNER JOIN
-- 	                      dbo.PROJ_TASK_AMT_COST_V pta ON pto.ProjTaskOptId = pta.ProjTaskOptId INNER JOIN
-- 	                      dbo.tblExRateCurrencies erc ON pta.CurrencyId = erc.CurrencyID AND p.ExchangeRateId = erc.ExRateID ON cpe.ManufacturerId = pt.ManufacturerId AND
-- 	                       ce.EndDate > pta.Pricing_Date AND ce.EscalationDate <= pta.Pricing_Date INNER JOIN
-- 	                      dbo.tblFleetSystemMargins FSM ON f.FleetId = FSM.FleetID INNER JOIN
-- 	                      dbo.tblSubSystems ss ON FSM.SystemID = ss.SystemID AND cc.SubSystemID = ss.SubSystemID ON 
-- 	                      cpe1.ManufacturerId = pt.ManufacturerId INNER JOIN
-- 	                      dbo.tblTaskTypes tt ON pt.TaskTypeId = tt.TaskTypeID INNER JOIN
-- 		        dbo.BUDGET_TASK BPT ON BPT.Proj_Task_Id = pt.ProjTaskId INNER JOIN
-- 	                      dbo.BUDGET_OCC BPO ON BPT.Budget_Task_ID = BPO.Budget_Task_ID AND ce1.EscalationDate <= BPO.Cost_Date AND ce1.EndDate > BPO.Cost_Date INNER JOIN
-- 		         #z_BudgetEqpToBeUpdated0 TempBE ON  BPT.Budget_Equipment_Id = TempBE.Budget_Equipment_Id
-- 	WHERE     (BPO.Proj_Task_Opt_ID IS NOT NULL) AND (ABS(pta.TotalLabourCost) <> 0) 
-- 	GROUP BY  BPO.Budget_Occ_ID,pta.Cost_Bearer_ID,  ISNULL(pta.CostCentreID, ep.Cost_Centre_ID),pta.Labour_Cost_Expense_ID,ep.Eqp_Category_Id
-- 
-- 	-- PARTS PTO = NULL
-- 
-- 	INSERT INTO BUDGET_COST
-- 	                      (Budget_Occ_ID, Cost_Bearer_ID, Cost, Sell, Cost_Centre_ID, Cost_Expense_ID,  Cost_Category_Id,Eqp_Category_Id)
-- 	SELECT     
-- 		BPO.Budget_Occ_ID, pta.Cost_Bearer_ID AS Cost_Bearer_ID, 
-- 		ROUND(SUM((pta.PartsCost * cpe.CumPartsEscalation * pto.Probability / cpe1.CumPartsEscalation) * (100 - f.LabMargin) / 10000 / erc.ExRate),2) AS Cost, 
-- 		ROUND(SUM(pta.PartsCost * cpe.CumPartsEscalation * pto.Probability / cpe1.CumPartsEscalation / erc.ExRate / 100),2) AS Sell, 
-- 		ISNULL(pta.CostCentreID, ep.Cost_Centre_ID) AS Cost_Centre_ID, pta.Parts_Cost_Expense_ID AS Cost_Expense_ID,  
-- 		@PartsCategory AS Cost_Category_Id,ep.Eqp_Category_Id
-- 	FROM         dbo.tblCostPartsEscalations cpe1 INNER JOIN
-- 	                      dbo.tblCostEscalations ce1 ON cpe1.CostEscalationId = ce1.CostEscalationId INNER JOIN
-- 	                      dbo.tblCostEscalations ce INNER JOIN
-- 	                      dbo.tblCostPartsEscalations cpe ON ce.CostEscalationId = cpe.CostEscalationId INNER JOIN
-- 	                      dbo.tblEqpProjs p INNER JOIN
-- 	                      dbo.tblEqpPlans ep ON p.EqpPlanId = ep.EqpPlanId INNER JOIN
-- 	                      dbo.tblFleets f ON ep.FleetId = f.FleetId INNER JOIN
-- 	                      dbo.tblProjTasks pt ON p.EqpProjId = pt.EqpProjId INNER JOIN
-- 	                      dbo.tblComponentCodes cc ON pt.ComponentCodeId = cc.ComponentCodeID INNER JOIN
-- 	                      dbo.tblProjTaskOpts pto ON pt.ProjTaskId = pto.ProjTaskId INNER JOIN
-- 	                      dbo.PROJ_TASK_AMT_COST_V pta ON pto.ProjTaskOptId = pta.ProjTaskOptId INNER JOIN
-- 	                      dbo.tblExRateCurrencies erc ON pta.CurrencyId = erc.CurrencyID AND p.ExchangeRateId = erc.ExRateID ON cpe.ManufacturerId = pt.ManufacturerId AND
-- 
-- 	                       ce.EndDate > pta.Pricing_Date AND ce.EscalationDate <= pta.Pricing_Date INNER JOIN
-- 	                      dbo.tblFleetSystemMargins FSM ON f.FleetId = FSM.FleetID INNER JOIN
-- 	                      dbo.tblSubSystems ss ON FSM.SystemID = ss.SystemID AND cc.SubSystemID = ss.SubSystemID ON 
-- 	                      cpe1.ManufacturerId = pt.ManufacturerId INNER JOIN
-- 	                       dbo.tblTaskTypes tt ON pt.TaskTypeId = tt.TaskTypeID INNER JOIN
-- 		        dbo.BUDGET_TASK BPT ON BPT.Proj_Task_Id = pt.ProjTaskId INNER JOIN
-- 	                      dbo.BUDGET_OCC BPO ON BPT.Budget_Task_ID = BPO.Budget_Task_ID AND ce1.EscalationDate <= BPO.Cost_Date AND ce1.EndDate > BPO.Cost_Date INNER JOIN
-- 		         #z_BudgetEqpToBeUpdated0 TempBE ON  BPT.Budget_Equipment_Id = TempBE.Budget_Equipment_Id
-- 	WHERE     (BPO.Proj_Task_Opt_ID IS NULL) AND (ABS(pta.PartsCost) * pto.Probability <> 0) 
-- 	GROUP BY pta.Cost_Bearer_ID, pta.Parts_Cost_Expense_ID, ISNULL(pta.CostCentreID, ep.Cost_Centre_ID),  BPO.Budget_Occ_ID,ep.Eqp_Category_Id
-- 
-- 	-- PARTS PTO <> NULL
-- 
-- 	INSERT INTO BUDGET_COST
-- 	                      (Budget_Occ_ID, Cost_Bearer_ID, Cost, Sell, Cost_Centre_ID, Cost_Expense_ID,  Cost_Category_Id,Eqp_Category_Id)
-- 	SELECT     
-- 		BPO.Budget_Occ_ID, pta.Cost_Bearer_ID AS Cost_Bearer_ID, 
-- 		ROUND(SUM((pta.PartsCost * cpe.CumPartsEscalation / cpe1.CumPartsEscalation) * (100 - f.LabMargin) / 100 / erc.ExRate),2) AS Cost, 
-- 		ROUND(SUM(pta.PartsCost * cpe.CumPartsEscalation / cpe1.CumPartsEscalation / erc.ExRate),2) AS Sell,
-- 		ISNULL(pta.CostCentreID, ep.Cost_Centre_ID) AS Cost_Centre_ID, pta.Parts_Cost_Expense_ID AS Cost_Expense_ID, 
-- 	             @PartsCategory AS Cost_Category_Id,ep.Eqp_Category_Id
-- 	FROM         dbo.tblCostPartsEscalations cpe1 INNER JOIN
-- 	                      dbo.tblCostEscalations ce1 ON cpe1.CostEscalationId = ce1.CostEscalationId INNER JOIN
-- 	                      dbo.tblCostEscalations ce INNER JOIN
-- 	                      dbo.tblCostPartsEscalations cpe ON ce.CostEscalationId = cpe.CostEscalationId INNER JOIN
-- 	                      dbo.tblEqpProjs p INNER JOIN
-- 	                      dbo.tblEqpPlans ep ON p.EqpPlanId = ep.EqpPlanId INNER JOIN
-- 	                      dbo.tblFleets f ON ep.FleetId = f.FleetId INNER JOIN
-- 	                      dbo.tblProjTasks pt ON p.EqpProjId = pt.EqpProjId INNER JOIN
-- 	                      dbo.tblComponentCodes cc ON pt.ComponentCodeId = cc.ComponentCodeID INNER JOIN
-- 	                      dbo.tblProjTaskOpts pto ON pt.ProjTaskId = pto.ProjTaskId INNER JOIN
-- 	                      dbo.PROJ_TASK_AMT_COST_V pta ON pto.ProjTaskOptId = pta.ProjTaskOptId INNER JOIN
-- 	                      dbo.tblExRateCurrencies erc ON pta.CurrencyId = erc.CurrencyID AND p.ExchangeRateId = erc.ExRateID ON cpe.ManufacturerId = pt.ManufacturerId AND
-- 	                       ce.EndDate > pta.Pricing_Date AND ce.EscalationDate <= pta.Pricing_Date INNER JOIN
-- 	                      dbo.tblFleetSystemMargins FSM ON f.FleetId = FSM.FleetID INNER JOIN
-- 	                      dbo.tblSubSystems ss ON FSM.SystemID = ss.SystemID AND cc.SubSystemID = ss.SubSystemID ON 
-- 	                      cpe1.ManufacturerId = pt.ManufacturerId INNER JOIN
-- 	                      dbo.tblTaskTypes tt ON pt.TaskTypeId = tt.TaskTypeID INNER JOIN
-- 		        dbo.BUDGET_TASK BPT ON BPT.Proj_Task_Id = pt.ProjTaskId INNER JOIN
-- 	                      dbo.BUDGET_OCC BPO ON BPT.Budget_Task_ID = BPO.Budget_Task_ID AND ce1.EscalationDate <= BPO.Cost_Date AND ce1.EndDate > BPO.Cost_Date INNER JOIN
-- 		         #z_BudgetEqpToBeUpdated0 TempBE ON  BPT.Budget_Equipment_Id = TempBE.Budget_Equipment_Id
-- 	WHERE     (BPO.Proj_Task_Opt_ID IS NOT NULL) AND (ABS(pta.PartsCost) <> 0) 
-- 	GROUP BY pta.Cost_Bearer_ID, pta.Parts_Cost_Expense_ID, ISNULL(pta.CostCentreID, ep.Cost_Centre_ID),  BPO.Budget_Occ_ID,ep.Eqp_Category_Id
-- 
-- 	-- MISC PTO = NULL	
-- 
-- 	INSERT INTO BUDGET_COST
-- 	                      (Budget_Occ_ID, Cost_Bearer_ID, Cost, Sell, Cost_Centre_ID, Cost_Expense_ID, Cost_Category_Id,Eqp_Category_Id)
-- 	SELECT     
-- 		BPO.Budget_Occ_ID, pta.Cost_Bearer_ID AS Cost_Bearer_ID, 
-- 		ROUND(SUM((pta.TotalMiscCost * ce.CumMiscEscalation * pto.Probability / ce1.CumMiscEscalation) * (100 - f.LabMargin) / 10000 / erc.ExRate),2) AS Cost, 
-- 		ROUND(SUM(pta.TotalMiscCost * ce.CumMiscEscalation * pto.Probability / ce1.CumMiscEscalation / erc.ExRate / 100),2) AS Sell, 
-- 		ISNULL(pta.CostCentreID, 
-- 	             ep.Cost_Centre_ID) AS Cost_Centre_ID, pta.Misc_Cost_Expense_ID AS Cost_Expense_ID, 
-- 		@MiscCategory AS Cost_Category_Id,ep.Eqp_Category_Id
-- 	FROM         dbo.tblCostPartsEscalations cpe1 INNER JOIN
-- 	                      dbo.tblCostEscalations ce1 ON cpe1.CostEscalationId = ce1.CostEscalationId INNER JOIN
-- 	                      dbo.tblCostEscalations ce INNER JOIN
-- 	                      dbo.tblCostPartsEscalations cpe ON ce.CostEscalationId = cpe.CostEscalationId INNER JOIN
-- 	                      dbo.tblEqpProjs p INNER JOIN
-- 	                      dbo.tblEqpPlans ep ON p.EqpPlanId = ep.EqpPlanId INNER JOIN
-- 	                      dbo.tblFleets f ON ep.FleetId = f.FleetId INNER JOIN
-- 	                      dbo.tblProjTasks pt ON p.EqpProjId = pt.EqpProjId INNER JOIN
-- 	                      dbo.tblComponentCodes cc ON pt.ComponentCodeId = cc.ComponentCodeID INNER JOIN
-- 	                      dbo.tblProjTaskOpts pto ON pt.ProjTaskId = pto.ProjTaskId INNER JOIN
-- 	                      dbo.PROJ_TASK_AMT_COST_V pta ON pto.ProjTaskOptId = pta.ProjTaskOptId INNER JOIN
-- 	                      dbo.tblExRateCurrencies erc ON pta.CurrencyId = erc.CurrencyID AND p.ExchangeRateId = erc.ExRateID ON cpe.ManufacturerId = pt.ManufacturerId AND
-- 	                       ce.EndDate > pta.Pricing_Date AND ce.EscalationDate <= pta.Pricing_Date INNER JOIN
-- 	                      dbo.tblFleetSystemMargins FSM ON f.FleetId = FSM.FleetID INNER JOIN
-- 	                      dbo.tblSubSystems ss ON FSM.SystemID = ss.SystemID AND cc.SubSystemID = ss.SubSystemID ON 
-- 	                      cpe1.ManufacturerId = pt.ManufacturerId INNER JOIN
-- 	                           dbo.tblTaskTypes tt ON pt.TaskTypeId = tt.TaskTypeID INNER JOIN
-- 
-- 		        dbo.BUDGET_TASK BPT ON BPT.Proj_Task_Id = pt.ProjTaskId INNER JOIN
-- 	                      dbo.BUDGET_OCC BPO ON BPT.Budget_Task_ID = BPO.Budget_Task_ID AND ce1.EscalationDate <= BPO.Cost_Date AND ce1.EndDate > BPO.Cost_Date INNER JOIN
-- 		         #z_BudgetEqpToBeUpdated0 TempBE ON  BPT.Budget_Equipment_Id = TempBE.Budget_Equipment_Id
-- 	WHERE     (BPO.Proj_Task_Opt_ID IS NULL) AND (ABS(pta.TotalMiscCost) * pto.Probability <> 0) 
-- 	GROUP BY pta.Cost_Bearer_ID, pta.Misc_Cost_Expense_ID, ISNULL(pta.CostCentreID, ep.Cost_Centre_ID), BPO.Budget_Occ_ID,ep.Eqp_Category_Id
-- 
-- 
-- 
-- 	-- MISC PTO <> NULL
-- 	INSERT INTO BUDGET_COST
-- 	                      (Budget_Occ_ID, Cost_Bearer_ID, Cost, Sell, Cost_Centre_ID, Cost_Expense_ID,  Cost_Category_Id,Eqp_Category_Id)	
-- 	SELECT     
-- 		BPO.Budget_Occ_ID, pta.Cost_Bearer_ID AS Cost_Bearer_ID, 
-- 		ROUND(SUM((pta.TotalMiscCost * ce.CumMiscEscalation / ce1.CumMiscEscalation) * (100 - f.LabMargin) / 100 / erc.ExRate),2) AS Cost, 
-- 		ROUND(SUM(pta.TotalMiscCost * ce.CumMiscEscalation / ce1.CumMiscEscalation / erc.ExRate),2) AS Sell, 
-- 		ISNULL(pta.CostCentreID, ep.Cost_Centre_ID) AS Cost_Centre_ID, pta.Misc_Cost_Expense_ID AS Cost_Expense_ID, 
-- 	             @MiscCategory AS Cost_Category_Id,ep.Eqp_Category_Id
-- 	FROM         dbo.tblCostPartsEscalations cpe1 INNER JOIN
-- 	                      dbo.tblCostEscalations ce1 ON cpe1.CostEscalationId = ce1.CostEscalationId INNER JOIN
-- 	                      dbo.tblCostEscalations ce INNER JOIN
-- 	                      dbo.tblCostPartsEscalations cpe ON ce.CostEscalationId = cpe.CostEscalationId INNER JOIN
-- 	                      dbo.tblEqpProjs p INNER JOIN
-- 	                      dbo.tblEqpPlans ep ON p.EqpPlanId = ep.EqpPlanId INNER JOIN
-- 	                      dbo.tblFleets f ON ep.FleetId = f.FleetId INNER JOIN
-- 	                      dbo.tblProjTasks pt ON p.EqpProjId = pt.EqpProjId INNER JOIN
-- 
-- 	                      dbo.tblComponentCodes cc ON pt.ComponentCodeId = cc.ComponentCodeID INNER JOIN
-- 	                      dbo.tblProjTaskOpts pto ON pt.ProjTaskId = pto.ProjTaskId INNER JOIN
-- 	                      dbo.PROJ_TASK_AMT_COST_V pta ON pto.ProjTaskOptId = pta.ProjTaskOptId INNER JOIN
-- 	                      dbo.tblExRateCurrencies erc ON pta.CurrencyId = erc.CurrencyID AND p.ExchangeRateId = erc.ExRateID ON cpe.ManufacturerId = pt.ManufacturerId AND
-- 	                       ce.EndDate > pta.Pricing_Date AND ce.EscalationDate <= pta.Pricing_Date INNER JOIN
-- 	                      dbo.tblFleetSystemMargins FSM ON f.FleetId = FSM.FleetID INNER JOIN
-- 	                      dbo.tblSubSystems ss ON FSM.SystemID = ss.SystemID AND cc.SubSystemID = ss.SubSystemID ON 
-- 	                      cpe1.ManufacturerId = pt.ManufacturerId INNER JOIN
-- 	                  dbo.tblTaskTypes tt ON pt.TaskTypeId = tt.TaskTypeID INNER JOIN
-- 		        dbo.BUDGET_TASK BPT ON BPT.Proj_Task_Id = pt.ProjTaskId INNER JOIN
-- 	                      dbo.BUDGET_OCC BPO ON BPT.Budget_Task_ID = BPO.Budget_Task_ID AND ce1.EscalationDate <= BPO.Cost_Date AND ce1.EndDate > BPO.Cost_Date INNER JOIN
-- 		         #z_BudgetEqpToBeUpdated0 TempBE ON  BPT.Budget_Equipment_Id = TempBE.Budget_Equipment_Id
-- 	WHERE     (BPO.Proj_Task_Opt_ID IS NOT NULL) AND (ABS(pta.TotalMiscCost) <> 0)  
-- 	GROUP BY pta.Cost_Bearer_ID, pta.Misc_Cost_Expense_ID, ISNULL(pta.CostCentreID, ep.Cost_Centre_ID),  BPO.Budget_Occ_ID,ep.Eqp_Category_Id

	


/* 5) Add Actual Occs */

	CREATE TABLE [#z_Actual_Occs] (
		[Proj_Task_ID] [int] NOT NULL ,
		[Occ_Date] [datetime] NOT NULL ,
		[Occ_Qty] [float] NOT NULL 
	) ON [PRIMARY]

	INSERT INTO #z_Actual_Occs
	                      (Proj_Task_ID, Occ_Date,  Occ_Qty)
	SELECT     TOP 100 PERCENT BT.Budget_Task_Id, 
			      CONVERT(datetime, CONVERT(varchar, YEAR(CASE WHEN PWO.AMTStartDate < EP.StartDate THEN EP.StartDate ELSE PWO.AMTStartDate END) 
	                      * 10000 + MONTH(CASE WHEN PWO.AMTStartDate < EP.StartDate THEN EP.StartDate ELSE PWO.AMTStartDate END) * 100 + 1), 112) AS Occ_Date, 
	                      COUNT(WOP.WorkOrderProjId) AS Occ_Qty
	FROM         dbo.tblWorkOrderProjs WOP INNER JOIN
	                      dbo.tblProjTasks PT ON WOP.ProjTaskId = PT.ProjTaskId INNER JOIN
	                      dbo.tblWorkOrders PWO ON WOP.WorkOrderId = PWO.WorkOrderId AND WOP.WorkOrderId = PWO.AMTParentWorkOrderId INNER JOIN
	                      dbo.tblEqpPlans EP ON PT.EqpPlanId = EP.EqpPlanId INNER JOIN
		         dbo.BUDGET_TASK BT ON BT.Proj_Task_Id = PT.ProjTaskId
	WHERE    CAST(CONVERT(VARCHAR(6),  CASE WHEN PWO.AMTStartDate < EP.StartDate THEN EP.StartDate ELSE PWO.AMTStartDate END, 112) AS INT) BETWEEN @StartPeriod AND @EndPeriod
	 AND EXISTS (SELECT Budget_Equipment_Id  FROM #z_BudgetEqpToBeUpdated0  WHERE Budget_Equipment_Id = BT.Budget_Equipment_Id )	
	GROUP BY BT.Budget_Task_Id, CONVERT(datetime, CONVERT(varchar, 
	                      YEAR(CASE WHEN PWO.AMTStartDate < EP.StartDate THEN EP.StartDate ELSE PWO.AMTStartDate END) 
	                      * 10000 + MONTH(CASE WHEN PWO.AMTStartDate < EP.StartDate THEN EP.StartDate ELSE PWO.AMTStartDate END) * 100 + 1), 112)

	IF EXISTS(SELECT Use_Transaction_WO_Costs FROM AMT_VARIABLE WHERE Use_Transaction_WO_Costs=1)
	BEGIN
		INSERT INTO #z_Actual_Occs
		                      (Proj_Task_ID, Occ_Date,  Occ_Qty)
		SELECT     TOP 100 PERCENT  BT.Budget_Task_Id, CONVERT(datetime, CONVERT(varchar, 
		                      YEAR(CASE WHEN WO.StartDate < EP.StartDate THEN EP.StartDate ELSE WO.StartDate END) 
		                      * 10000 + MONTH(CASE WHEN WO.StartDate < EP.StartDate THEN EP.StartDate ELSE WO.StartDate END) * 100 + 1), 112) AS Occ_Date,
				      0 AS Occ_Qty
		FROM         dbo.tblWorkOrders WO INNER JOIN
		                      dbo.tblWorkOrderProjs WOP ON WO.AMTParentWorkOrderId = WOP.WorkOrderId INNER JOIN
		                      dbo.tblProjTasks PT ON WOP.ProjTaskId = PT.ProjTaskId INNER JOIN
		                      dbo.tblEqpPlans EP ON PT.EqpPlanId = EP.EqpPlanId  INNER JOIN
		        	     dbo.BUDGET_TASK BT ON BT.Proj_Task_Id = PT.ProjTaskId
		WHERE     CAST(CONVERT(VARCHAR(6),  CASE WHEN WO.StartDate < EP.StartDate THEN EP.StartDate ELSE WO.StartDate END, 112) AS INT) BETWEEN @StartPeriod AND @EndPeriod			
		 AND EXISTS (SELECT Budget_Equipment_Id  FROM #z_BudgetEqpToBeUpdated0  WHERE Budget_Equipment_Id = BT.Budget_Equipment_Id )	
		GROUP BY BT.Budget_Task_Id, CONVERT(datetime, CONVERT(varchar, YEAR(CASE WHEN WO.StartDate < EP.StartDate THEN EP.StartDate ELSE WO.StartDate END) 
		                       * 10000 + MONTH(CASE WHEN WO.StartDate < EP.StartDate THEN EP.StartDate ELSE WO.StartDate END) * 100 + 1), 112)
	END

	INSERT INTO BUDGET_OCC
	                      (Budget_Task_ID, is_Actual_Cost, Cost_Date, Occ_Qty, Manual_Edited)
	SELECT     Proj_Task_ID, 1 AS is_Actual_Cost, Occ_Date, SUM(Occ_Qty) AS Occ_Qty, 0 AS Manual_Edited
	FROM         #z_Actual_Occs
	GROUP BY Proj_Task_ID, Occ_Date

	DROP TABLE #z_Actual_Occs

	

/* 6) Add Actual Costs */	

	CREATE TABLE [#z_ACTUAL_OCC_COST] (
		[Budget_Task_Id] [int] NOT NULL ,
		[Occ_Date] [datetime] NOT NULL ,
		[PrimePartsCost] [float] NOT NULL ,
		[PrimeLabourCost] [float] NOT NULL ,
		[PrimeMiscCost] [float] NOT NULL ,
		[PrimePartsSell] [float] NOT NULL ,
		[PrimeLabourSell] [float] NOT NULL ,
		[PrimeMiscSell] [float] NOT NULL ,
		[CostBearerId] [int] NULL,
		[Cost_Centre_ID] [INT] NULL, 
		[Cost_Expense_ID] [INT] NULL,
		[Eqp_Category_ID] [INT] NULL,	--Added ID
		[Work_Group_ID] [INT] NULL		--Added ID
	) ON [PRIMARY]

	IF EXISTS(SELECT Use_Transaction_WO_Costs FROM AMT_VARIABLE WHERE Use_Transaction_WO_Costs=1)
	BEGIN
		INSERT INTO #z_ACTUAL_OCC_COST (Budget_Task_Id, Occ_Date, PrimePartsCost, PrimeLabourCost, PrimeMiscCost,PrimePartsSell,PrimeLabourSell,PrimeMiscSell,CostBearerId,Cost_Centre_ID,Cost_Expense_ID,Eqp_Category_ID,Work_Group_ID)	--Added ID
		SELECT     TOP 100 PERCENT BT.Budget_Task_Id, CONVERT(datetime, CONVERT(varchar, 
		                      YEAR(CASE WHEN WO.StartDate < EP.StartDate THEN EP.StartDate ELSE WO.StartDate END) 
		                      * 10000 + MONTH(CASE WHEN WO.StartDate < EP.StartDate THEN EP.StartDate ELSE WO.StartDate END) * 100 + 1), 112) AS Occ_Date, 
		                      SUM(WOS.PercentParts / 100 * WOO.PartsCost / WO.ExchangeRate) AS PrimePartsCost, 
		                      SUM(WOS.PercentLabour / 100 * WOO.LabourCost / WO.ExchangeRate) AS PrimeLabourCost, 
		                      SUM(WOS.PercentMisc / 100 * WOO.MiscCost / WO.ExchangeRate) AS PrimeMiscCost, 
		                      SUM(WOS.PercentParts / 100 * WOO.PartsSell / WO.ExchangeRate) AS PrimePartsSell, 
		                      SUM(WOS.PercentLabour / 100 * WOO.LabourSell / WO.ExchangeRate) AS PrimeLabourSell, 
		                      SUM(WOS.PercentMisc / 100 * WOO.MiscSell / WO.ExchangeRate) AS PrimeMiscSell, WOS.CostBearerId, WOS.Cost_Centre_ID, 
		                      WOS.Cost_Expense_ID, ISNULL(WOS.Eqp_Category_ID,EP.Eqp_Category_ID), WOS.Work_Group_Id	--Added ID
		FROM         dbo.tblWorkOrders WO INNER JOIN
		                      dbo.tblWorkOrderOperations WOO ON WO.WorkOrderId = WOO.WorkOrderId INNER JOIN
		                      dbo.tblWorkOrderSettlements WOS ON WO.WorkOrderId = WOS.WorkOrderId INNER JOIN
		                      dbo.tblWorkOrderProjs WOP ON WO.AMTParentWorkOrderId = WOP.WorkOrderId INNER JOIN
		                      dbo.tblProjTasks PT ON WOP.ProjTaskId = PT.ProjTaskId INNER JOIN
		                      dbo.tblEqpPlans EP ON PT.EqpPlanId = EP.EqpPlanId INNER JOIN
		                      dbo.tblWorkOrders PWO ON WOP.WorkOrderId = PWO.WorkOrderId AND WOP.WorkOrderId = PWO.AMTParentWorkOrderId INNER JOIN
			         dbo.BUDGET_TASK BT ON BT.Proj_Task_Id = WOP.ProjTaskId INNER JOIN
			         #z_BudgetEqpToBeUpdated0 BE ON BE.Budget_Equipment_Id =  BT.Budget_Equipment_Id
		WHERE   CAST(CONVERT(VARCHAR(6), CASE WHEN WO.StartDate < EP.StartDate THEN EP.StartDate ELSE WO.StartDate END, 112) AS INT) BETWEEN @StartPeriod AND @EndPeriod
		 AND  BT.Budget_Equipment_Id IN (SELECT Budget_Equipment_Id  FROM #z_BudgetEqpToBeUpdated0  )	
		 AND ( @WorkGroupId=',,' OR CHARINDEX(','+CAST(WOS.Work_Group_ID as varchar(16))+',', @WorkGroupId)>0 )  --E752
		GROUP BY  BT.Budget_Task_Id,WOP.ProjTaskId, CONVERT(datetime, CONVERT(varchar, YEAR(CASE WHEN WO.StartDate < EP.StartDate THEN EP.StartDate ELSE WO.StartDate END)
		                       * 10000 + MONTH(CASE WHEN WO.StartDate < EP.StartDate THEN EP.StartDate ELSE WO.StartDate END) * 100 + 1), 112), WOS.CostBearerId, 
		                      WOS.Cost_Centre_ID, WOS.Cost_Expense_ID,  ISNULL(WOS.Eqp_Category_ID,EP.Eqp_Category_ID), WOS.Work_Group_ID	--Added ID

	END
	ELSE
	BEGIN
		INSERT INTO #z_ACTUAL_OCC_COST (Budget_Task_Id, Occ_Date, PrimePartsCost, PrimeLabourCost, PrimeMiscCost,PrimePartsSell,PrimeLabourSell,PrimeMiscSell,CostBearerId,Cost_Centre_ID,Cost_Expense_ID, Eqp_Category_ID, Work_Group_ID)	--Added ID
		SELECT     TOP 100 PERCENT  BT.Budget_Task_Id, CONVERT(datetime, CONVERT(varchar, 
		                      YEAR(CASE WHEN PWO.AMTStartDate < EP.StartDate THEN EP.StartDate ELSE PWO.AMTStartDate END) 
		                      * 10000 + MONTH(CASE WHEN PWO.AMTStartDate < EP.StartDate THEN EP.StartDate ELSE PWO.AMTStartDate END) * 100 + 1), 112) AS Occ_Date, 
		                      SUM(WOS.PercentParts / 100 * WOO.PartsCost / WO.ExchangeRate) AS PrimePartsCost, 
		                      SUM(WOS.PercentLabour / 100 * WOO.LabourCost / WO.ExchangeRate) AS PrimeLabourCost, 
		                      SUM(WOS.PercentMisc / 100 * WOO.MiscCost / WO.ExchangeRate) AS PrimeMiscCost, 
		                      SUM(WOS.PercentParts / 100 * WOO.PartsSell / WO.ExchangeRate) AS PrimePartsSell, 
		                      SUM(WOS.PercentLabour / 100 * WOO.LabourSell / WO.ExchangeRate) AS PrimeLabourSell, 
		                      SUM(WOS.PercentMisc / 100 * WOO.MiscSell / WO.ExchangeRate) AS PrimeMiscSell, WOS.CostBearerId, WOS.Cost_Centre_ID, 
		                      WOS.Cost_Expense_ID, ISNULL(WOS.Eqp_Category_ID,EP.Eqp_Category_ID), WOS.Work_Group_ID	--Added ID
		FROM         dbo.tblWorkOrders WO INNER JOIN
		                      dbo.tblWorkOrderOperations WOO ON WO.WorkOrderId = WOO.WorkOrderId INNER JOIN
		                      dbo.tblWorkOrderSettlements WOS ON WO.WorkOrderId = WOS.WorkOrderId INNER JOIN
		                      dbo.tblWorkOrderProjs WOP ON WO.AMTParentWorkOrderId = WOP.WorkOrderId INNER JOIN
		                      dbo.tblProjTasks PT ON WOP.ProjTaskId = PT.ProjTaskId INNER JOIN
		                      dbo.tblEqpPlans EP ON PT.EqpPlanId = EP.EqpPlanId INNER JOIN
		                      dbo.tblWorkOrders PWO ON WOP.WorkOrderId = PWO.WorkOrderId AND WOP.WorkOrderId = PWO.AMTParentWorkOrderId  INNER JOIN
			         dbo.BUDGET_TASK BT ON BT.Proj_Task_Id = WOP.ProjTaskId INNER JOIN
			         #z_BudgetEqpToBeUpdated0 BE ON BE.Budget_Equipment_Id =  BT.Budget_Equipment_Id
		WHERE  CAST(CONVERT(VARCHAR(6), CASE WHEN PWO.AMTStartDate < EP.StartDate THEN EP.StartDate ELSE PWO.AMTStartDate END , 112) AS INT) BETWEEN @StartPeriod AND @EndPeriod
		 AND ( @WorkGroupId=',,' OR CHARINDEX(','+CAST(WOS.Work_Group_ID as varchar(16))+',', @WorkGroupId)>0 ) --E752
		GROUP BY  BT.Budget_Task_Id,WOP.ProjTaskId, CONVERT(datetime, CONVERT(varchar, 
		                      YEAR(CASE WHEN PWO.AMTStartDate < EP.StartDate THEN EP.StartDate ELSE PWO.AMTStartDate END) 
		                      * 10000 + MONTH(CASE WHEN PWO.AMTStartDate < EP.StartDate THEN EP.StartDate ELSE PWO.AMTStartDate END) * 100 + 1), 112), 
		                      WOS.CostBearerId, WOS.Cost_Centre_ID, WOS.Cost_Expense_ID, ISNULL(WOS.Eqp_Category_ID,EP.Eqp_Category_ID), WOS.Work_Group_ID	--Added ID
	END



	INSERT INTO BUDGET_COST
	                      (Budget_Occ_ID, Cost_Bearer_ID, Cost, Sell, Cost_Centre_ID, Cost_Expense_ID, Cost_Category_Id, Eqp_Category_ID, Work_Group_ID)	--Added ID
	SELECT     
		dbo.BUDGET_OCC.Budget_Occ_ID, AOC.CostBearerId, 
		ROUND(SUM(AOC.PrimePartsCost) ,2) AS Cost, 
	             ROUND(SUM(AOC.PrimePartsSell) ,2) AS Sell, 
		AOC.Cost_Centre_ID, 
	             AOC.Cost_Expense_ID, 
		@PartsCategory AS Cost_Category_Id,
		AOC.Eqp_Category_Id,	--Added ID
		AOC.Work_Group_ID		--Added ID
	FROM         #z_ACTUAL_OCC_COST AOC INNER JOIN

	                      dbo.BUDGET_OCC ON AOC.Budget_Task_Id = dbo.BUDGET_OCC.Budget_Task_Id AND 
	                      AOC.Occ_Date = dbo.BUDGET_OCC.Cost_Date INNER JOIN 
		        dbo.BUDGET_TASK BT ON BT.Budget_Task_Id = dbo.BUDGET_OCC.Budget_Task_Id
	WHERE     (dbo.BUDGET_OCC.is_Actual_Cost = 1) AND (ABS(AOC.PrimePartsCost) 
	                      + ABS(AOC.PrimePartsSell) <> 0)  AND  BT.Budget_Equipment_Id IN (SELECT Budget_Equipment_Id  FROM #z_BudgetEqpToBeUpdated0  )	
	GROUP BY BT.Budget_Equipment_Id ,dbo.BUDGET_OCC.Budget_Occ_ID, AOC.CostBearerId, AOC.Cost_Centre_ID, 
	                     AOC.Cost_Expense_ID,AOC.Eqp_Category_Id, AOC.Work_Group_ID	--Added ID




	INSERT INTO BUDGET_COST
	                      (Budget_Occ_ID, Cost_Bearer_ID, Cost, Sell, Cost_Centre_ID, Cost_Expense_ID, Cost_Category_Id,Eqp_Category_Id, Work_Group_ID)	--Added ID
	SELECT     
		dbo.BUDGET_OCC.Budget_Occ_ID, AOC.CostBearerId, 
		ROUND(SUM(AOC.PrimeLabourCost) ,2) AS Cost, 
		ROUND(SUM(AOC.PrimeLabourSell) ,2) AS Sell, 
		AOC.Cost_Centre_ID, 
	             AOC.Cost_Expense_ID,
		@LabourCategory AS Cost_Category_Id, 
		AOC.Eqp_Category_Id,	--Added ID
		AOC.Work_Group_ID		--Added ID
	FROM         #z_ACTUAL_OCC_COST AOC INNER JOIN
	                      dbo.BUDGET_OCC ON AOC.Budget_Task_Id = dbo.BUDGET_OCC.Budget_Task_Id AND 
	                      AOC.Occ_Date = dbo.BUDGET_OCC.Cost_Date INNER JOIN 
		        dbo.BUDGET_TASK BT ON BT.Budget_Task_Id = dbo.BUDGET_OCC.Budget_Task_Id
	WHERE     (dbo.BUDGET_OCC.is_Actual_Cost = 1) AND (ABS(AOC.PrimeLabourCost) 
	                      + ABS(AOC.PrimeLabourSell) <> 0) 	 AND BT.Budget_Equipment_Id IN (SELECT Budget_Equipment_Id  FROM #z_BudgetEqpToBeUpdated0  )	
	GROUP BY BT.Budget_Equipment_Id, dbo.BUDGET_OCC.Budget_Occ_ID, AOC.CostBearerId, AOC.Cost_Centre_ID, 
	                      AOC.Cost_Expense_ID,AOC.Eqp_Category_Id, AOC.Work_Group_ID	--Added ID


	INSERT INTO BUDGET_COST
	                      (Budget_Occ_ID, Cost_Bearer_ID, Cost, Sell, Cost_Centre_ID, Cost_Expense_ID, Cost_Category_Id,Eqp_Category_Id, Work_Group_ID)	--Added ID
	SELECT     
		dbo.BUDGET_OCC.Budget_Occ_ID, AOC.CostBearerId, 
		ROUND(SUM(AOC.PrimeMiscCost) ,2) AS Cost, 
		ROUND(SUM(AOC.PrimeMiscSell) ,2) AS Sell, 
		AOC.Cost_Centre_ID, AOC.Cost_Expense_ID,
	        @MiscCategory AS Cost_Category_Id,
		AOC.Eqp_Category_Id,	--Added ID
		AOC.Work_Group_ID		--Added ID
	FROM         #z_ACTUAL_OCC_COST AOC INNER JOIN
	                      dbo.BUDGET_OCC ON AOC.Budget_Task_Id = dbo.BUDGET_OCC.Budget_Task_Id AND 
	                      AOC.Occ_Date = dbo.BUDGET_OCC.Cost_Date  INNER JOIN 
		        dbo.BUDGET_TASK BT ON BT.Budget_Task_Id = dbo.BUDGET_OCC.Budget_Task_Id
	WHERE     (dbo.BUDGET_OCC.is_Actual_Cost = 1) AND (ABS(AOC.PrimeMiscCost) 
	                      + ABS(AOC.PrimeMiscSell) <> 0)  AND  BT.Budget_Equipment_Id IN (SELECT Budget_Equipment_Id  FROM #z_BudgetEqpToBeUpdated0  )	
	GROUP BY BT.Budget_Equipment_Id,dbo.BUDGET_OCC.Budget_Occ_ID, AOC.CostBearerId, AOC.Cost_Centre_ID, 
	                      AOC.Cost_Expense_ID,AOC.Eqp_Category_Id, AOC.Work_Group_ID	--Added ID

	
	DROP TABLE #z_ACTUAL_OCC_COST

GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[RPT_TOTAL_COST_ANALYSIS_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[RPT_TOTAL_COST_ANALYSIS_P]
GO

create      Procedure [dbo].[RPT_TOTAL_COST_ANALYSIS_P]
/******************************************************************************
	File: 
	Name: RPT_TOTAL_COST_ANALYSIS_P

	Called By: 

	Desc: Get data for Cost Per UOM Comparison Report
             

	Auth: Veronika Vasylyeva
	Date: 10-Feb-2003
*******************************************************************************
		Change History
*******************************************************************************
Date:		Author:		Description:
--------	--------	----------------------------------------
09 Mar 12	KN		3694: Error when running Cost Analysis - Life-Cycle report
08 Mar 12	KN		3699 - Strategy Task Description Issues
04 Mar 12	KN		E#732& E#751 enhancements
22 Sep 11	VV		#2398: Incorrect when analyse by Proj Task
26 Oct 09	AL		CR8421: fixed cost trending order
22 Oct 09	AL		CR8421: Cost Trending, added UserID, ManufacturerID, Display, EqpCCActivity, EqpCCLocation, EqpCCResponsibility
01 Nov 08	KN		Correct to Return only top 15 for the Pie Chart including 'Others'
13 May 08	YS		Fixed Analyse By PEQP
02 May 08   YS		Added Analyse By PEQP
08 Apr 08   YS      Added Cost Category to Analyse By
03 Apr 08	AL		Now uses EQP_SIBLINGS_F 
02 Apr 2008 YS      Set all SQL varchar lenghts to MAX
26 Mar 2008 YS      Added @CostCategoryId
06 Mar 2008 KN& YS	Fixed with the Bitwise operator
06 Mar 2008	KN		Support Drilldown
06 Feb 2008 YS		Added @ParentEquipmentID
30 Jan 2008 YS		Added @EqpCostCentre
					Transition of RadioButtonCollection to CheckBoxCollection
21-Jul-07	KN		Fixed - Collation and tempDB Conflicts
19 Jun 07	ID		Added Work Group
13-Oct-06	ID		Added @ActualProjected
18-Oct-06	ID		Fixed incorrect references to RPT_COST_COMPARISON_ACTUAL_V instead of RPT_COST_COMPARISON_PROJ_V
03-Oct-06	AL		Set all SQL varchar lengths to 8000 + tried to keep those strings as short as possible
24-Aug 06	KN		Added Output Parameter Datebased (Report Launcher)
08 Feb 06	SI		New filters/group by/analyse Region, Division, Criticality, Equipment Classification, Equipment Group
20 Sep 05	V Vasylyeva	Additional Analyse By 1,  Analyse By 2
28 Oct 03	M Lam		Added Additonal Params + Analyse By 2
08 Oct 03	V Vasylyeva	Changed aa_CostComparison+@RandNum to be a temporary table
12 Jun 03	HS		future Cost for current prj is fixed
15 May 03	HS		New parameter as ShowSellAmt is added
12 Mar 2003	V Vasylyeva	Changed the query for missing calender periods,
				Set #z_CostComparison.AnalyseBy varchar(350) 
13 Feb 2003	V Vasylyeva	Added filtering by Parts/Labour/Misc
14 Feb 2003	V Vasylyeva	Include all calendar periods even if we do not costs for the period
12 Oct 2011 G Dhillon E646 add Task Counter as Filter and Group By	
13 Oct 11	V Vasylyeva	E643: Added workorder settlement number
18 Oct 11	DA: Format the Cost Analysis Text report
19 Oct 11	V Vasylyeva	E650: strategy task description
*******************************************************************************/
	/* Param List */
	@UserID int=0,
    @branchId varchar(MAX)='',
    @site_ID varchar(MAX)='',
    @fleet_ID varchar(MAX)='',
    @modelId varchar(MAX) = '',
    @business_Group_Id varchar(MAX)='',
    @contract_Type_ID varchar(MAX)='',
    @contract_ID varchar(MAX)='',
    @eqp_Plan_ID varchar(MAX)='',
    @RegionId varchar(MAX)='',
    @DivisionId varchar(MAX)='',
    @CriticalityId varchar(MAX)='',
    @EqpClassId varchar(MAX)='',
    @EqpGroupId varchar(MAX)='',
    @EqpLocationId varchar(MAX)='',
    @EqpCategoryId varchar(MAX)='',
	@EqpCostCentre varchar(MAX)='',
	@ParentEquipmentID varchar(MAX)='',
	@ManufacturerID varchar(MAX)='', 
	@EqpCCActivity varchar(MAX)='', 
	@EqpCCLocation varchar(MAX)='', 
	@EqpCCResponsibility varchar(MAX)='',
	@EquipmentTypeId int=1,
    @projection_Header_Id varchar(MAX)='1',

    @CostBearerID varchar(MAX)='1',
    @costResponsibilityID varchar(MAX)='',
    @costCentreID varchar(MAX)='',
    @costActivityID varchar(MAX)='',
    @costExpenseID varchar(MAX)='',   
    @costTypeID varchar(MAX) = '',
    @systemID varchar(MAX) = '',
    @subSystemID varchar(MAX) = '',
    @taskTypeID varchar(MAX) = '',
    @componentCodeID varchar(MAX) = '',
    @modifierID varchar(MAX) = '',
    @projTaskId varchar(MAX) = '',--ComponentCode.ModifierCode.TaskType.ApplicationCode
	@WorkGroupId varchar(MAX)='',	--Added ID	

    @entire_Term bit = 1, 
    @plan_To_month bit = 0,
    @start_Date int = 0,
    @end_Date int = 0,
    @Parts_Labour_Misc int=0,
    @AnalyseBy varchar(10) = 'FLEE',
    @AnalyseBy2 varchar(10) = 'FLEE',
    @IncludeMissingPeriods bit = 0,
    @ShowSellAmt bit = 1,
	@ActualProjected int=3,			--Added ID
	@CostCategoryId varchar(MAX)='',

    @DateBased varchar(10) = 'False' OUTPUT,
	@PieChart bit = 0,
	@Display int=0,	--1: cost, 2: % total cost
	--GD E646
	@TaskCounterID VARCHAR(MAX)='',
	@IsCostAnalysisLifeCycleReport bit = 0,	--DA E652
	@TaskMode VARCHAR(MAX) = '',
	@ProjTaskDescId VARCHAR(MAX) = ''
AS

------------------------------------------------------------------------

SET NOCOUNT ON

SET  @DateBased= 'False' 

-- Parts/Labour/Misc: ALL=0,PART=1,LABOUR=2,MISC=3
DECLARE @Where_Clause as varchar(MAX)
DECLARE @Eqp_Where_Clause as varchar(MAX)
DECLARE @AnalyseBy_Clause as varchar(MAX)
DECLARE @AnalyseBy_Clause_2 as varchar(MAX)
DECLARE @SQL as varchar(MAX)
DECLARE @GroupBy as varchar(MAX)

DECLARE @All int
DECLARE @Parts int
DECLARE @Labour int
DECLARE @Misc int


SET @All=7
SET @Parts=1
SET @Labour=2
SET @Misc=4


SET @AnalyseBy=UPPER(@AnalyseBy)
IF @AnalyseBy = 'MONH' OR @AnalyseBy = 'QRTR' OR @AnalyseBy = 'YEAR'  
BEGIN
	SET @IncludeMissingPeriods = 1
	SET @DateBased = 'True'
END

--AL: 21/10/09
CREATE TABLE #aa_Eqp(EqpPlanId int PRIMARY KEY,EqpPlan varchar(100) COLLATE database_default)
INSERT INTO #aa_Eqp(EqpPlanID,EqpPlan)
EXEC EQP_SELECTOR_GET_P	@AnalyseBy='EQPL',
	@UserID=@UserID,
	@EquipmentTypeId=@EquipmentTypeId,
	@AllowNullAnalyseBy=1,
	@BranchId=@BranchId,
	@SiteId=@site_ID,
	@FleetId=@fleet_ID,
	@ModelId=@ModelId,
	@BusinessGroupId=@business_Group_Id,
	@ContractTypeId=@contract_Type_ID,
	@ContractId=@contract_ID,
	@EquipmentId=@eqp_Plan_ID,
	@RegionID=@RegionID,
	@DivisionID=@DivisionID,
	@EquipmentCriticalityID=@CriticalityId,
	@EquipmentClassId=@EqpClassId,
	@EquipmentGroupId=@EqpGroupId,
	@EquipmentLocationID=@EqpLocationID,
	@EquipmentCategoryID=@EqpCategoryID,
	@EquipmentCostCentreID=@EqpCostCentre,
	@ParentEqpPlanID=@ParentEquipmentID,
	@ManufacturerID=@ManufacturerID,
	@CCActivity=@EqpCCActivity,
	@CCLocation=@EqpCCLocation,
	@CCResponsibility=@EqpCCResponsibility,
	@ShowEqpDescription = 1

	IF @entire_Term = 1 or @plan_To_month = 1
		SET @Where_Clause = ' WHERE 1=1 '
	ELSE
		SET @Where_Clause = ' WHERE (CalenderPeriod BETWEEN ' + Convert(varchar(6),@start_Date) + ' AND ' + Convert(varchar(6),@end_Date) + ')'

	If @projection_Header_Id <> '' SET @Where_Clause = @Where_Clause + ' AND Projection_Header_Id IN (' + @projection_Header_Id + ')'
	
	--????????????????????
	If @projTaskId <> ''
		BEGIN

			SET @Where_Clause = @Where_Clause + ' AND ProjTaskID IN '
			SET @Where_Clause = @Where_Clause + ' (SELECT projtaskid FROM tblprojtasks '
			SET @Where_Clause = @Where_Clause + ' WHERE componentcodeid in (SELECT componentcodeid FROM tblprojtasks WHERE projtaskid IN (' + @projTaskId + ')) '
			SET @Where_Clause = @Where_Clause + ' AND modifierid in (SELECT modifierid FROM tblprojtasks WHERE projtaskid IN  (' + @projTaskId + ')) '
			SET @Where_Clause = @Where_Clause + ' AND tasktypeid in (SELECT tasktypeid FROM tblprojtasks WHERE projtaskid IN (' + @projTaskId + ')) '
			SET @Where_Clause = @Where_Clause + ' AND applicationcodeid in (SELECT applicationcodeid FROM tblprojtasks WHERE projtaskid IN  (' + @projTaskId + '))) '--	ProjTask= @projTaskId 
		END
		
	IF @ProjTaskDescId <>''
	BEGIN
			SET @Where_Clause = @Where_Clause + ' AND Task_Description IN ( '
			SET @Where_Clause = @Where_Clause + ' SELECT DISTINCT dbo.TASK_DESCRIPTION_F(PT.Task_Description,TH.Component_Code,TH.Modifier_Code,TH.Task_Type,TH.Application_Code,TH.Description) as Task_Description '
			SET @Where_Clause = @Where_Clause + ' FROM tblProjTasks PT '
			SET @Where_Clause = @Where_Clause + ' INNER JOIN TASK_HEADER TH ON TH.Task_Header_Id = PT.Task_Header_Id '
			SET @Where_Clause = @Where_Clause + ' WHERE PT.ProjTaskId IN (' + @ProjTaskDescId + ') ) '

	END


	If @costTypeID <> '' SET @Where_Clause = @Where_Clause + ' AND CostTypeID IN (' + @costTypeID + ')'
	If @systemID <> '' SET @Where_Clause = @Where_Clause + ' AND SystemID IN (' + @systemID + ')'
	If @subSystemID <> '' SET @Where_Clause = @Where_Clause + ' AND SubSystemID IN (' + @subSystemID + ')'
	If @componentCodeID <> '' SET @Where_Clause = @Where_Clause + ' AND ComponentCodeID IN (' + @componentCodeID + ')'
	If @modifierID <> '' SET @Where_Clause = @Where_Clause + ' AND ModifierID IN (' + @modifierID + ')'
	If @CostBearerID <> '' SET @Where_Clause = @Where_Clause + ' AND CostBearerID IN (' + @CostBearerID + ')'
	If @taskTypeID <> '' SET @Where_Clause = @Where_Clause + ' AND TaskTypeID IN (' + @taskTypeID + ')'
	
	IF @costResponsibilityID <>'' SET @where_Clause = @where_Clause + ' AND Cost_Responsibility_ID IN (' + @costResponsibilityID + ')'		
	IF @costCentreID <>'' SET @where_Clause = @where_Clause + ' AND Cost_Centre_ID IN (' + @costCentreID + ')'		    
	IF @costActivityID <>'' SET @where_Clause = @where_Clause + ' AND Cost_Activity_ID IN (' + @costActivityID + ')'		    
	IF @costExpenseID <>'' SET @where_Clause = @where_Clause + ' AND Cost_Expense_ID IN (' + @costExpenseID + ')'		    
	IF @WorkGroupId <>'' SET @Where_Clause = @Where_Clause +  ' AND Work_Group_ID IN (SELECT Work_Group_Id					
																					FROM WORK_GROUP									
																					WHERE Work_Group_Code					
																					IN (SELECT Work_Group_Code				
																						FROM WORK_GROUP						
																						WHERE Work_Group_Id IN (' + @WorkGroupId + '))) '	--Added ID
	IF @CostCategoryId <>'' SET @Where_Clause = @Where_Clause + ' AND Cost_Category_Id IN (' + @CostCategoryId + ')'	
	IF @TaskCounterID <>'' SET @Where_Clause = @Where_Clause + ' AND ApplicationCodeID IN (' + @TaskCounterID + ')'
	
	IF @TaskMode <> ''
		SET @Where_Clause = @Where_Clause + ' AND TaskModeId IN (' + @TaskMode + ') '
		
	Declare @AnalyseBySelect as varchar(MAX)	
	Declare @AnalyseBySelect_2 as varchar(MAX)

	SET @AnalyseBy_Clause = '' +
	CASE @AnalyseBy  
		WHEN 'BRAN' THEN ' BranchId, Branch'
		WHEN 'SITE' THEN ' SiteId, Site'
		WHEN 'BUGR' THEN ' BusinessGroupId, BusinessGroup'
		WHEN 'CNTT' THEN ' ContractTypeId, ContractType'
		WHEN 'CONT' THEN ' ContractId, Contract'
		WHEN 'FLEE' THEN ' FleetId, Fleet'
		WHEN 'EQPL' THEN ' #aa_Eqp.EqpPlanId, #aa_Eqp.EqpPlan'
		WHEN 'MODL' THEN ' ModelId, Model'
		WHEN 'CTTY' THEN ' CostTypeId, CostType'
		WHEN 'SUBS' THEN ' SubSystemId, SubSystem'
		WHEN 'SYST' THEN ' SystemId, System'
		WHEN 'EVTT' THEN ' TaskTypeID, TaskType'
		WHEN 'EVCC' THEN ' ComponentCodeId, CompCode'
		/*VV #2398 WHEN 'PRTA' THEN ' ProjTaskId, ProjTask '*/
		WHEN 'PRTA' THEN ' TaskHeaderId, ProjTask '
		
		/*VV E650*/
		WHEN 'PRDE' THEN ' ProjTaskId, Task_Description '
		
		WHEN 'CEXP' THEN ' Cost_Expense_ID, Cost_Expense_Code'
		WHEN 'WGRP' THEN ' Work_Group_ID, Work_Group_Code'		--Added ID
		WHEN 'CCTR' THEN ' Cost_Centre_ID,Cost_Centre_Code'
		WHEN 'CACT' THEN ' Cost_Activity_ID,Cost_Activity_Code'
		WHEN 'CRSP' THEN ' Cost_Responsibility_ID, Cost_Responsibility_Code'
		WHEN 'REGN' THEN ' Region_Id, Region_Desc'
		WHEN 'DEVI' THEN ' Division_Id, Division_Desc'
		WHEN 'LCTN' THEN ' Eqp_Location_Id, Eqp_Location_Desc'
		WHEN 'CRIT' THEN ' Eqp_Criticality_Id, Eqp_Criticality_Desc'
		WHEN 'CTGR' THEN ' Eqp_Category_Id, Eqp_Category_Desc'
		WHEN 'ECLS' THEN ' Eqp_Class_Id, Eqp_Class_Desc'
		WHEN 'EGRP' THEN ' Equipment_Group_Id, Equipment_Group_Desc'
		WHEN 'ECCT' THEN ' EqpCostCentreId, EqpCostCentre'
		WHEN 'CCAT' THEN ' Cost_Category_Id, Cost_Category_Desc'
		WHEN 'CCAC' THEN ' CC_Activity, CC_Activity'
		WHEN 'CCLO' THEN ' CC_Location, CC_Location'
		WHEN 'CCRE' THEN ' CC_Responsibility, CC_Responsibility'
		WHEN 'PLM' THEN ''
		WHEN 'TACO' THEN 'ApplicationCodeID, AppCode'
		/*VV E643*/
		WHEN 'WONO' THEN 'WorkorderId,Workorder'
		WHEN 'TMOD' THEN 'TaskModeId,TaskMode'
		ELSE ' Projection_Header_Id, EqpProjName'
	END

	SET @AnalyseBy_Clause_2 = '' +
	CASE @AnalyseBy2  
		WHEN 'BRAN' THEN ' BranchId, Branch'
		WHEN 'SITE' THEN ' SiteId, Site'
		WHEN 'BUGR' THEN ' BusinessGroupId, BusinessGroup'
		WHEN 'CNTT' THEN ' ContractTypeId, ContractType'
		WHEN 'CONT' THEN ' ContractId, Contract'
		WHEN 'FLEE' THEN ' FleetId, Fleet'
		WHEN 'EQPL' THEN ' #aa_Eqp.EqpPlanId, #aa_Eqp.EqpPlan'
		WHEN 'MODL' THEN ' ModelId, Model'
		WHEN 'CTTY' THEN ' CostTypeId, CostType'
		WHEN 'SUBS' THEN ' SubSystemId, SubSystem'
		WHEN 'SYST' THEN ' SystemId, System'
		WHEN 'EVTT' THEN ' TaskTypeID, TaskType'
		WHEN 'EVCC' THEN ' ComponentCodeId, CompCode'
		/*VV #2398 WHEN 'PRTA' THEN ' ProjTaskId, ProjTask '*/
		WHEN 'PRTA' THEN ' TaskHeaderId, ProjTask '
		
		/*VV E650*/
		WHEN 'PRDE' THEN ' ProjTaskId, Task_Description '
		
		WHEN 'PRTY' THEN ' Projection_Header_Id, EqpProjName'
		WHEN 'CACT' THEN ' Cost_Activity_ID,Cost_Activity_Code'
		WHEN 'WGRP' THEN ' Work_Group_ID, Work_Group_Code'		--Added ID
		WHEN 'CCTR' THEN ' Cost_Centre_ID,Cost_Centre_Code'
		WHEN 'CRSP' THEN ' Cost_Responsibility_ID, Cost_Responsibility_Code'
		WHEN 'CEXP' THEN ' Cost_Expense_ID, Cost_Expense_Code'
		WHEN 'REGN' THEN ' Region_Id, Region_Desc'
		WHEN 'DEVI' THEN ' Division_Id, Division_Desc'
		WHEN 'LCTN' THEN ' Eqp_Location_Id, Eqp_Location_Desc'
		WHEN 'CRIT' THEN ' Eqp_Criticality_Id, Eqp_Criticality_Desc'
		WHEN 'CTGR' THEN ' Eqp_Category_Id, Eqp_Category_Desc'
		WHEN 'ECLS' THEN ' Eqp_Class_Id, Eqp_Class_Desc'
		WHEN 'EGRP' THEN ' Equipment_Group_Id, Equipment_Group_Desc'
		WHEN 'ECCT' THEN ' EqpCostCentreId, EqpCostCentre'
		WHEN 'CCAT' THEN ' Cost_Category_Id, Cost_Category_Desc'
		WHEN 'PLM' THEN ''
		/*VV E643*/
		WHEN 'WONO' THEN 'WorkorderId,Workorder'
		WHEN 'TMOD' THEN 'TaskModeId,TaskMode'
		ELSE ' DealerId,Dealer'
	END
	


	
	--Create a temporary table
	 CREATE TABLE #aa_CostComparison(
		[AnalyseByID] [varchar] (350) COLLATE database_default NULL,	--AL: 21/10/09
		[AnalyseBy] [varchar] (350) COLLATE database_default NULL ,
		[AnalyseByID_2] [int],
		[AnalyseBy_2] [varchar] (350) COLLATE database_default NULL ,
		[CalenderPeriod] int,
		[CalenderMonth] [varchar] (7) COLLATE database_default,
		[CalenderDate] datetime ,
		[Cost] [float] NULL )
	
	--AL: 21/10/09
	CREATE TABLE #aa_TotalMonthCost(CalenderDate datetime PRIMARY KEY,TotalMONTHCost float)

	IF @AnalyseBy='PLM' OR @AnalyseBy2='PLM'
		BEGIN
			IF @ActualProjected & 3 = 3 OR @ActualProjected & 1 = 1 --ID
				BEGIN
					--Insert into temporary table the actual costs 
					-- PARTS
					SET @SQL = ' INSERT INTO #aa_CostComparison(AnalyseByID,AnalyseBy,AnalyseByID_2,AnalyseBy_2,CalenderPeriod,CalenderMonth,CalenderDate, Cost)'
					SET @SQL =  @SQL + ' SELECT '+
						CASE @AnalyseBy_Clause WHEN '' THEN  '1,''PARTS'',' 
						ELSE @AnalyseBy_Clause +', ' END +
		
						CASE @AnalyseBy_Clause_2 WHEN '' THEN  '1,''PARTS'',' 
						ELSE @AnalyseBy_Clause_2+', ' END+
						
						'CalenderPeriod, Convert(varchar(4), Left(CalenderPeriod,4)) + ''-'' + Convert(varchar(2),Right(CalenderPeriod,2)), '
					SET @SQL =  @SQL +  ' Convert(datetime, Convert(varchar(4), Left(CalenderPeriod,4)) + ''-'' + Convert(varchar(2),Right(CalenderPeriod,2)) + ''-01'') CalenderDate,'
					IF @Parts_Labour_Misc & 1 = 1
						BEGIN
							IF @ShowSellAmt = 1
								SET @SQL =  @SQL +  ' SUM(PrimePartsSell)'
							ELSE
								SET @SQL =  @SQL +  ' SUM(PrimePartsCost)'
						END
					ELSE
						SET @SQL =  @SQL +  ' 0'

					SET @GroupBy =   ' GROUP BY CalenderPeriod '  
					+ CASE @AnalyseBy_Clause_2 WHEN '' THEN  '' 
						ELSE ' ,'+@AnalyseBy_Clause_2 END +
					CASE @AnalyseBy_Clause WHEN '' THEN  '' 
						ELSE ' ,'+@AnalyseBy_Clause END
					--print(@SQL) return
					EXEC(@SQL +  ' FROM RPT_COST_COMPARISON_ACTUAL_V INNER JOIN #aa_Eqp ON RPT_COST_COMPARISON_ACTUAL_V.EqpPlanID=#aa_Eqp.EqpPlanID ' +  @Where_Clause + @GroupBy)
				
					--LABOR
					SET @SQL = ' INSERT INTO #aa_CostComparison(AnalyseByID,AnalyseBy,AnalyseByID_2,AnalyseBy_2,CalenderPeriod,CalenderMonth,CalenderDate, Cost)'
					SET @SQL =  @SQL + ' SELECT '+
						CASE @AnalyseBy_Clause WHEN '' THEN  '2,''LABOUR'',' 
						ELSE @AnalyseBy_Clause +', ' END +
		
						CASE @AnalyseBy_Clause_2 WHEN '' THEN  '2,''LABOUR'',' 
						ELSE @AnalyseBy_Clause_2+', ' END+
		 
					'CalenderPeriod, Convert(varchar(4), Left(CalenderPeriod,4)) + ''-'' + Convert(varchar(2),Right(CalenderPeriod,2)), '
					SET @SQL =  @SQL +  ' Convert(datetime, Convert(varchar(4), Left(CalenderPeriod,4)) + ''-'' + Convert(varchar(2),Right(CalenderPeriod,2)) + ''-01'') CalenderDate,'
					IF @Parts_Labour_Misc & 2 = 2
						BEGIN
							IF @ShowSellAmt = 1
								SET @SQL =  @SQL +  ' SUM(PrimeLabourSell)'
							ELSE
								SET @SQL =  @SQL +  ' SUM(PrimeLabourCost)'
						END
					ELSE
						SET @SQL =  @SQL +  ' 0'

					SET @GroupBy =   ' GROUP BY CalenderPeriod '  
						+ CASE @AnalyseBy_Clause_2 WHEN '' THEN  '' 
						ELSE ' ,'+@AnalyseBy_Clause_2 END+
						CASE @AnalyseBy_Clause WHEN '' THEN  '' 
						ELSE ' ,'+@AnalyseBy_Clause END
			
					----print(@SQL)
					EXEC(@SQL +  ' FROM RPT_COST_COMPARISON_ACTUAL_V INNER JOIN #aa_Eqp ON RPT_COST_COMPARISON_ACTUAL_V.EqpPlanID=#aa_Eqp.EqpPlanID ' +  @Where_Clause + @GroupBy)
		
					--MISC
					SET @SQL = ' INSERT INTO #aa_CostComparison(AnalyseByID,AnalyseBy,AnalyseByID_2,AnalyseBy_2,CalenderPeriod,CalenderMonth,CalenderDate, Cost)'
					SET @SQL =  @SQL + ' SELECT '+  
						CASE @AnalyseBy_Clause WHEN '' THEN  '3,''MISC'',' 
						ELSE @AnalyseBy_Clause +', ' END +
		
						CASE @AnalyseBy_Clause_2 WHEN '' THEN  '3,''MISC'',' 
						ELSE @AnalyseBy_Clause_2+', ' END+
		
					'CalenderPeriod,Convert(varchar(4), Left(CalenderPeriod,4)) + ''-'' + Convert(varchar(2),Right(CalenderPeriod,2)), '
					SET @SQL =  @SQL +  ' Convert(datetime, Convert(varchar(4), Left(CalenderPeriod,4)) + ''-'' + Convert(varchar(2),Right(CalenderPeriod,2)) + ''-01'') CalenderDate,'

					IF @Parts_Labour_Misc & 4 = 4
						BEGIN
							IF @ShowSellAmt = 1
								SET @SQL =  @SQL +  ' SUM(PrimeMiscSell)'
							ELSE
								SET @SQL =  @SQL +  ' SUM(PrimeMiscCost)'
						END
					ELSE
						SET @SQL =  @SQL +  ' 0'

					SET @GroupBy =  ' GROUP BY CalenderPeriod '  
						+ CASE @AnalyseBy_Clause_2 WHEN '' THEN  '' 
						ELSE ' ,'+@AnalyseBy_Clause_2 END+
						CASE @AnalyseBy_Clause WHEN '' THEN  '' 
						ELSE ' ,'+@AnalyseBy_Clause END
					----print(@SQL)
					EXEC(@SQL +  ' FROM RPT_COST_COMPARISON_ACTUAL_V INNER JOIN #aa_Eqp ON RPT_COST_COMPARISON_ACTUAL_V.EqpPlanID=#aa_Eqp.EqpPlanID ' +  @Where_Clause + @GroupBy)
				END

			
			--Insert into temporary table the projected costs
			-- PARTS
			SET @SQL = ' INSERT INTO #aa_CostComparison(AnalyseByID,AnalyseBy,AnalyseByID_2,AnalyseBy_2,CalenderPeriod,CalenderMonth,CalenderDate, Cost)'
			SET @SQL =  @SQL +  ' SELECT '+
				CASE @AnalyseBy_Clause WHEN '' THEN  '1,''PARTS'',' 
				ELSE @AnalyseBy_Clause +', ' END +
		
				CASE @AnalyseBy_Clause_2 WHEN '' THEN  '1,''PARTS'',' 
				ELSE @AnalyseBy_Clause_2+', ' END+ 
		
			'CalenderPeriod, Convert(varchar(4), Left(CalenderPeriod,4)) + ''-'' + Convert(varchar(2),Right(CalenderPeriod,2)), '
			SET @SQL =  @SQL +  ' Convert(datetime, Convert(varchar(4), Left(CalenderPeriod,4)) + ''-'' + Convert(varchar(2),Right(CalenderPeriod,2)) + ''-01'') CalenderDate,'
			IF @Parts_Labour_Misc & 1 = 1
				BEGIN
					IF @ShowSellAmt = 1
						SET @SQL =  @SQL +  ' SUM(PrimePartsSell)'
					ELSE
						SET @SQL =  @SQL +  ' SUM(CASE WHEN Projection_Header_Id = 2 THEN PrimePartsCostNoEsc ELSE PrimePartsCost END)'
				END
			ELSE
				SET @SQL =  @SQL +  ' 0'	

			IF @plan_To_month = 1 
				BEGIN						
						IF @ActualProjected = 2 OR @ActualProjected = 0 OR @Parts_Labour_Misc = 0
							SET @Where_Clause =  @Where_Clause +  ' AND 1 = 2 ' 
						ELSE
							SET @Where_Clause =  @Where_Clause +  ' AND BudgetToDate <> 0 '
				
				END
			ELSE
				BEGIN
						IF @ActualProjected = 0 OR @Parts_Labour_Misc = 0
							SET @Where_Clause =  @Where_Clause +  ' AND 1 = 2 ' 
						ELSE IF @ActualProjected = 1
							SET @Where_Clause =  @Where_Clause +  ' AND BudgetToDate <> 0 '
						ELSE IF @ActualProjected = 2
							SET @Where_Clause =  @Where_Clause +  ' AND BudgetToDate = 0 '
				END

			SET @GroupBy = ' GROUP BY CalenderPeriod '  
					+ CASE @AnalyseBy_Clause_2 WHEN '' THEN  '' 
					ELSE ' ,'+@AnalyseBy_Clause_2 END+
					CASE @AnalyseBy_Clause WHEN '' THEN  '' 
					ELSE ' ,'+@AnalyseBy_Clause END
			----print(@SQL)
			EXEC(@SQL +  ' FROM RPT_COST_COMPARISON_PROJ_V INNER JOIN #aa_Eqp ON RPT_COST_COMPARISON_PROJ_V.EqpPlanID=#aa_Eqp.EqpPlanID ' +  @Where_Clause + @GroupBy)
		
			--LABOR
			SET @SQL = ' INSERT INTO #aa_CostComparison(AnalyseByID,AnalyseBy,AnalyseByID_2,AnalyseBy_2,CalenderPeriod,CalenderMonth,CalenderDate, Cost)'
			SET @SQL =  @SQL + ' SELECT '+  
					CASE @AnalyseBy_Clause WHEN '' THEN  '2,''LABOUR'',' 
					ELSE @AnalyseBy_Clause +', ' END +
		
					CASE @AnalyseBy_Clause_2 WHEN '' THEN  '2,''LABOUR'',' 
					ELSE @AnalyseBy_Clause_2+', ' END+
			'CalenderPeriod, Convert(varchar(4), Left(CalenderPeriod,4)) + ''-'' + Convert(varchar(2),Right(CalenderPeriod,2)), '
			SET @SQL =  @SQL +  ' Convert(datetime, Convert(varchar(4), Left(CalenderPeriod,4)) + ''-'' + Convert(varchar(2),Right(CalenderPeriod,2)) + ''-01'') CalenderDate,'
			IF @Parts_Labour_Misc & 2 = 2
				BEGIN
					IF @ShowSellAmt = 1
						SET @SQL =  @SQL +  ' SUM(PrimeLabourSell)'
					ELSE
						SET @SQL =  @SQL +  ' SUM(CASE WHEN Projection_Header_Id = 2 THEN PrimeLabourCostNoEsc ELSE PrimeLabourCost END)'
				END
			ELSE
				SET @SQL =  @SQL +  ' 0'	

				IF @plan_To_month = 1 
				BEGIN						
						IF @ActualProjected = 2 OR @ActualProjected = 0 OR @Parts_Labour_Misc = 0
							SET @Where_Clause =  @Where_Clause +  ' AND 1 = 2 ' 
						ELSE
							SET @Where_Clause =  @Where_Clause +  ' AND BudgetToDate <> 0 '
				
				END
			ELSE
				BEGIN
						IF @ActualProjected = 0 OR @Parts_Labour_Misc = 0
							SET @Where_Clause =  @Where_Clause +  ' AND 1 = 2 ' 
						ELSE IF @ActualProjected = 1
							SET @Where_Clause =  @Where_Clause +  ' AND BudgetToDate <> 0 '
						ELSE IF @ActualProjected = 2
							SET @Where_Clause =  @Where_Clause +  ' AND BudgetToDate = 0 '
				END

			SET @GroupBy = ' GROUP BY CalenderPeriod ' 
					+ CASE @AnalyseBy_Clause_2 WHEN '' THEN  '' 
					ELSE ' ,'+@AnalyseBy_Clause_2 END+
					CASE @AnalyseBy_Clause WHEN '' THEN  '' 
					ELSE ' ,'+@AnalyseBy_Clause END
			----print(@SQL)
			EXEC(@SQL +  ' FROM RPT_COST_COMPARISON_PROJ_V INNER JOIN #aa_Eqp ON RPT_COST_COMPARISON_PROJ_V.EqpPlanID=#aa_Eqp.EqpPlanID ' +  @Where_Clause + @GroupBy)
		
			--MISC
			SET @SQL = ' INSERT INTO #aa_CostComparison(AnalyseByID,AnalyseBy,AnalyseByID_2,AnalyseBy_2,CalenderPeriod,CalenderMonth,CalenderDate, Cost)'
			SET @SQL =  @SQL + ' SELECT '+  
				CASE @AnalyseBy_Clause WHEN '' THEN  '3,''MISC'',' 
				ELSE @AnalyseBy_Clause +', ' END +
		
				CASE @AnalyseBy_Clause_2 WHEN '' THEN  '3,''MISC'',' 
				ELSE @AnalyseBy_Clause_2 +', ' END+
			'CalenderPeriod,Convert(varchar(4), Left(CalenderPeriod,4)) + ''-'' + Convert(varchar(2),Right(CalenderPeriod,2)), '
			SET @SQL =  @SQL +  ' Convert(datetime, Convert(varchar(4), Left(CalenderPeriod,4)) + ''-'' + Convert(varchar(2),Right(CalenderPeriod,2)) + ''-01'') CalenderDate,'
			IF @Parts_Labour_Misc & 4 = 4
				BEGIN
				IF @ShowSellAmt = 1
					SET @SQL =  @SQL +  ' SUM(PrimeMiscSell)'
				ELSE
					SET @SQL =  @SQL +  ' SUM(CASE WHEN Projection_Header_Id = 2 THEN PrimeMiscCostNoEsc ELSE PrimeMiscCost END)'
				END
			ELSE
				SET @SQL =  @SQL +  ' 0'	

			IF @plan_To_month = 1 
				BEGIN						
						IF @ActualProjected = 2 OR @ActualProjected = 0  OR @Parts_Labour_Misc = 0
							SET @Where_Clause =  @Where_Clause +  ' AND 1 = 2 ' 
						ELSE
							SET @Where_Clause =  @Where_Clause +  ' AND BudgetToDate <> 0 '
				
				END
			ELSE
				BEGIN
						IF @ActualProjected = 0  OR @Parts_Labour_Misc = 0
							SET @Where_Clause =  @Where_Clause +  ' AND 1 = 2 ' 
						ELSE IF @ActualProjected = 1
							SET @Where_Clause =  @Where_Clause +  ' AND BudgetToDate <> 0 '
						ELSE IF @ActualProjected = 2
							SET @Where_Clause =  @Where_Clause +  ' AND BudgetToDate = 0 '
				END

			
--		--	IF  @plan_To_month = 1 SET @Where_Clause =  @Where_Clause +  ' AND BudgetToDate <> 0 ' --ID
--			IF (@plan_To_month = 1 AND @ActualProjected  = 1) SET @Where_Clause =  @Where_Clause +  ' AND BudgetToDate <> 0 ' --ID
--			ELSE IF @ActualProjected  = 2 SET @Where_Clause =  @Where_Clause +  ' AND  BudgetToDate = 0 ' --ID
--			ELSE IF (@plan_To_month = 1 AND @ActualProjected  = 0) SET @Where_Clause =  @Where_Clause +  ' AND BudgetToDate <> 0 ' --ID
--			ELSE IF (@ActualProjected  = 0) SET @Where_Clause =  @Where_Clause +  ' AND 1 = 2 ' --ID

			SET @GroupBy =  ' GROUP BY CalenderPeriod '  
				+ CASE @AnalyseBy_Clause_2 WHEN '' THEN  '' 
				ELSE ' ,'+@AnalyseBy_Clause_2 END+
				CASE @AnalyseBy_Clause WHEN '' THEN  '' 
				ELSE ' ,'+@AnalyseBy_Clause END
			--print(@SQL)
			EXEC(@SQL +  ' FROM RPT_COST_COMPARISON_PROJ_V INNER JOIN #aa_Eqp ON RPT_COST_COMPARISON_PROJ_V.EqpPlanID=#aa_Eqp.EqpPlanID ' +  @Where_Clause + @GroupBy)

		END
	ELSE IF @AnalyseBy = 'PEQP'             
		BEGIN
			--Create a temporary table
			 CREATE TABLE #aa_CostComparisonTemp(
				[EqpPlanId] [int],
				[EqpPlan] [varchar] (350) COLLATE database_default NULL ,
				[ParentEqpPlanID] [int],
				[ParentEqpPlan] [varchar] (350) COLLATE database_default NULL ,
				[CalenderPeriod] int,
				[CalenderMonth] [varchar] (7) COLLATE database_default,
				[CalenderDate] datetime ,
				[Cost] [float] NULL )


			IF @ActualProjected & 3 = 3 OR @ActualProjected & 1 = 1 --ID
				--1: get costs per EqpPlans
				BEGIN
					--Insert into temporary table the actual costs 

					SET @SQL =   ' INSERT INTO #aa_CostComparisonTemp(EqpPlanId,EqpPlan,ParentEqpPlanID,ParentEqpPlan,CalenderPeriod,CalenderMonth,CalenderDate, Cost)'
					SET @SQL =  @SQL + ' SELECT RPT_COST_COMPARISON_ACTUAL_V.EqpPlanId,RPT_COST_COMPARISON_ACTUAL_V.EqpPlan,NULL,NULL'
					SET @SQL =  @SQL + ' , CalenderPeriod, Convert(varchar(4), Left(CalenderPeriod,4)) + ''-'' + Convert(varchar(2),Right(CalenderPeriod,2)), '
					SET @SQL =  @SQL +  ' Convert(datetime, Convert(varchar(4), Left(CalenderPeriod,4)) + ''-'' + Convert(varchar(2),Right(CalenderPeriod,2)) + ''-01'') CalenderDate,'
					
					SET @SQL =  @SQL + ' 0 '
					IF @Parts_Labour_Misc & 1 = 1
						IF @ShowSellAmt = 1
							SET @SQL =  @SQL + ' +SUM(PrimePartsSell) '
						ELSE
							SET @SQL =  @SQL + ' +SUM(PrimePartsCost) '
					IF @Parts_Labour_Misc & 2 = 2
						IF @ShowSellAmt = 1
							SET @SQL =  @SQL + ' +SUM(PrimeLabourSell) '
						ELSE
							SET @SQL =  @SQL + ' +SUM(PrimeLabourCost) '
					IF @Parts_Labour_Misc & 4 = 4
						IF @ShowSellAmt = 1
							SET @SQL =  @SQL + ' +SUM(PrimeMiscSell) '
						ELSE
							SET @SQL =  @SQL + ' +SUM(PrimeMiscCost) '

					SET @GroupBy =  ' GROUP BY CalenderPeriod,RPT_COST_COMPARISON_ACTUAL_V.EqpPlanId,RPT_COST_COMPARISON_ACTUAL_V.EqpPlan'
					--print(@SQL)
					
					EXEC(@SQL +  ' FROM RPT_COST_COMPARISON_ACTUAL_V INNER JOIN #aa_Eqp ON RPT_COST_COMPARISON_ACTUAL_V.EqpPlanID=#aa_Eqp.EqpPlanID ' +  @Where_Clause + @GroupBy)

				END

				--Insert into temporary table the projected costs
				SET @SQL =   ' INSERT INTO #aa_CostComparisonTemp(EqpPlanId,EqpPlan,ParentEqpPlanID,ParentEqpPlan,CalenderPeriod,CalenderMonth,CalenderDate, Cost)'
				SET @SQL =  @SQL + ' SELECT RPT_COST_COMPARISON_PROJ_V.EqpPlanId,RPT_COST_COMPARISON_PROJ_V.EqpPlan,NULL,NULL'
				SET @SQL =  @SQL + ' , CalenderPeriod,  Convert(varchar(4), Left(CalenderPeriod,4)) + ''-'' + Convert(varchar(2),Right(CalenderPeriod,2)), '
				SET @SQL =  @SQL +  ' Convert(datetime, Convert(varchar(4), Left(CalenderPeriod,4)) + ''-'' + Convert(varchar(2),Right(CalenderPeriod,2)) + ''-01'') CalenderDate,'
				
				IF @Parts_Labour_Misc & 1 = 1
					IF @ShowSellAmt = 1
						SET @SQL =  @SQL +  ' +SUM(PrimePartsSell)'
					ELSE
						SET @SQL =  @SQL +  ' +SUM(CASE WHEN Projection_Header_Id = 2 THEN PrimePartsCostNoEsc ELSE PrimePartsCost END)'
				IF @Parts_Labour_Misc & 2 = 2 
					IF @ShowSellAmt = 1
						SET @SQL =  @SQL +  ' +SUM(PrimeLabourSell)'
					ELSE
						SET @SQL =  @SQL +  ' +SUM(CASE WHEN Projection_Header_Id = 2 THEN PrimeLabourCostNoEsc ELSE PrimeLabourCost END)'
				IF @Parts_Labour_Misc & 4 = 4
					IF @ShowSellAmt = 1
						SET @SQL =  @SQL +  ' +SUM(PrimeMiscSell)'
					ELSE
						SET @SQL =  @SQL +  ' +SUM(CASE WHEN Projection_Header_Id = 2 THEN PrimeMiscCostNoEsc ELSE PrimeMiscCost END)'
				 
				IF @Parts_Labour_Misc = 0
					SET @SQL =  @SQL +  ' 0'

				IF @plan_To_month = 1 
					BEGIN						
							IF @ActualProjected = 2 OR @ActualProjected = 0 OR @Parts_Labour_Misc = 0
								SET @Where_Clause =  @Where_Clause +  ' AND 1 = 2 ' 
							ELSE
								SET @Where_Clause =  @Where_Clause +  ' AND BudgetToDate <> 0 '
					
					END
				ELSE
					BEGIN
							IF @ActualProjected = 0 OR @Parts_Labour_Misc = 0
								SET @Where_Clause =  @Where_Clause +  ' AND 1 = 2 ' 
							ELSE IF @ActualProjected = 1
								SET @Where_Clause =  @Where_Clause +  ' AND BudgetToDate <> 0 '
							ELSE IF @ActualProjected = 2
								SET @Where_Clause =  @Where_Clause +  ' AND BudgetToDate = 0 '
					END

				SET @GroupBy =  ' GROUP BY CalenderPeriod,RPT_COST_COMPARISON_PROJ_V.EqpPlanId,RPT_COST_COMPARISON_PROJ_V.EqpPlan'
				 --PRINT(@SQL +  ' FROM RPT_COST_COMPARISON_PROJ_V ' +  @Where_Clause + @GroupBy)
				--return
				EXEC(@SQL +  ' FROM RPT_COST_COMPARISON_PROJ_V INNER JOIN #aa_Eqp ON RPT_COST_COMPARISON_PROJ_V.EqpPlanID=#aa_Eqp.EqpPlanID ' +  @Where_Clause + @GroupBy)

				
				--Insert into temporary table dummy records for all equipments

				--Create a temporary table
				CREATE TABLE #aa_EqpTemp(
					[EqpPlanId] [int] PRIMARY KEY,
					[ParentEqpPlanID] [int])

				INSERT INTO #aa_EqpTemp(EqpPlanId,ParentEqpPlanID) SELECT EqpPlanId,NULL FROM #aa_Eqp

				--2: get parent Eqps for each eqp
				--a: get IDs
				DECLARE @selection varchar(max)
				SET @selection= REPLACE(REPLACE((select EqpPlanId from #aa_EqpTemp for xml raw),'<row eqpplanid="',''),'"/>',',')

				UPDATE #aa_EqpTemp 
				SET ParentEqpPlanID = dbo.GET_TOPMOST_PARENT_EQUIPMENT_F(EqpPlanId,@selection)

				UPDATE CCT 
				SET		parenteqpplanid = ET.ParentEqpPlanID,
						parenteqpplan = EP.EqpPlan
				FROM 
						#aa_CostComparisonTemp CCT INNER JOIN
						#aa_EqpTemp ET ON CCT.eqpplanid=ET.EqpPlanID INNER JOIN
						tblEqpPlans EP ON ET.ParentEqpPlanID=EP.EqpPlanID

				--3: insert into #aa_CostComparison
				INSERT INTO #aa_CostComparison (AnalyseByID,AnalyseBy,AnalyseByID_2,AnalyseBy_2,CalenderPeriod,CalenderMonth,CalenderDate, Cost)
				SELECT parenteqpplanid,parenteqpplan,NULL,NULL,CalenderPeriod,CalenderMonth,CalenderDate,SUM(Cost) as Cost
				FROM #aa_CostComparisonTemp CCT
				GROUP BY parenteqpplanid,parenteqpplan,CalenderPeriod,CalenderMonth,CalenderDate

				--SELECT * FROM #aa_CostComparison	
				
				--4: Cleanup
				DROP TABLE #aa_CostComparisonTemp
				DROP TABLE #aa_EqpTemp
		END
	ELSE             
		BEGIN
			IF @ActualProjected & 3 = 3 OR @ActualProjected & 1 = 1 --ID
				BEGIN
					--Insert into temporary table the actual costs 
					SET @SQL =   ' INSERT INTO #aa_CostComparison(AnalyseByID,AnalyseBy,AnalyseByID_2,AnalyseBy_2,CalenderPeriod,CalenderMonth,CalenderDate, Cost)'
					SET @SQL =  @SQL + ' SELECT ' + @AnalyseBy_Clause + ',' + @AnalyseBy_Clause_2
					SET @SQL =  @SQL + ' , CalenderPeriod, Convert(varchar(4), Left(CalenderPeriod,4)) + ''-'' + Convert(varchar(2),Right(CalenderPeriod,2)), '
					SET @SQL =  @SQL +  ' Convert(datetime, Convert(varchar(4), Left(CalenderPeriod,4)) + ''-'' + Convert(varchar(2),Right(CalenderPeriod,2)) + ''-01'') CalenderDate,'
					
					SET @SQL =  @SQL + ' 0 '
					IF @Parts_Labour_Misc & 1 = 1
						IF @ShowSellAmt = 1
							SET @SQL =  @SQL + ' +SUM(PrimePartsSell) '
						ELSE
							SET @SQL =  @SQL + ' +SUM(PrimePartsCost) '
					IF @Parts_Labour_Misc & 2 = 2
						IF @ShowSellAmt = 1
							SET @SQL =  @SQL + ' +SUM(PrimeLabourSell) '
						ELSE
							SET @SQL =  @SQL + ' +SUM(PrimeLabourCost) '
					IF @Parts_Labour_Misc & 4 = 4
						IF @ShowSellAmt = 1
							SET @SQL =  @SQL + ' +SUM(PrimeMiscSell) '
						ELSE
							SET @SQL =  @SQL + ' +SUM(PrimeMiscCost) '

					SET @GroupBy =  ' GROUP BY CalenderPeriod, ' + @AnalyseBy_Clause + ',' + @AnalyseBy_Clause_2
					--print(@SQL +  ' FROM RPT_COST_COMPARISON_ACTUAL_V ' +  @Where_Clause + @GroupBy)
					
					EXEC(@SQL +  ' FROM RPT_COST_COMPARISON_ACTUAL_V INNER JOIN #aa_Eqp ON RPT_COST_COMPARISON_ACTUAL_V.EqpPlanID=#aa_Eqp.EqpPlanID ' +  @Where_Clause + @GroupBy)
				END

				--Insert into temporary table the projected costs
			SET @SQL =   ' INSERT INTO #aa_CostComparison(AnalyseByID,AnalyseBy,AnalyseByID_2,AnalyseBy_2,CalenderPeriod,CalenderMonth,CalenderDate, Cost)'
			SET @SQL =  @SQL + ' SELECT ' + @AnalyseBy_Clause+ ',' + @AnalyseBy_Clause_2
			SET @SQL =  @SQL + ' , CalenderPeriod,  Convert(varchar(4), Left(CalenderPeriod,4)) + ''-'' + Convert(varchar(2),Right(CalenderPeriod,2)), '
			SET @SQL =  @SQL +  ' Convert(datetime, Convert(varchar(4), Left(CalenderPeriod,4)) + ''-'' + Convert(varchar(2),Right(CalenderPeriod,2)) + ''-01'') CalenderDate,'
			
		    IF @Parts_Labour_Misc & 1 = 1
				IF @ShowSellAmt = 1
					SET @SQL =  @SQL +  ' +SUM(PrimePartsSell)'
				ELSE
					SET @SQL =  @SQL +  ' +SUM(CASE WHEN Projection_Header_Id = 2 THEN PrimePartsCostNoEsc ELSE PrimePartsCost END)'
		    IF @Parts_Labour_Misc & 2 = 2 
				IF @ShowSellAmt = 1
					SET @SQL =  @SQL +  ' +SUM(PrimeLabourSell)'
				ELSE
					SET @SQL =  @SQL +  ' +SUM(CASE WHEN Projection_Header_Id = 2 THEN PrimeLabourCostNoEsc ELSE PrimeLabourCost END)'
		    IF @Parts_Labour_Misc & 4 = 4
				IF @ShowSellAmt = 1
					SET @SQL =  @SQL +  ' +SUM(PrimeMiscSell)'
				ELSE
					SET @SQL =  @SQL +  ' +SUM(CASE WHEN Projection_Header_Id = 2 THEN PrimeMiscCostNoEsc ELSE PrimeMiscCost END)'
			 
			IF @Parts_Labour_Misc = 0
				SET @SQL =  @SQL +  ' 0'

--		--	IF  @plan_To_month = 1 SET @Where_Clause =  @Where_Clause +  ' AND  BudgetToDate <> 0 ' --ID
----			IF  (@plan_To_month = 1 OR @ActualProjected & 1 = 1) SET @Where_Clause =  @Where_Clause +  ' AND BudgetToDate <> 0 ' --ID
----			IF  (@ActualProjected & 2 = 2) SET @Where_Clause =  @Where_Clause +  ' AND BudgetToDate = 0 ' --ID
--			IF (@plan_To_month = 1 AND @ActualProjected  = 1) SET @Where_Clause =  @Where_Clause +  ' AND BudgetToDate <> 0 ' --ID
--			ELSE IF @ActualProjected  = 2 SET @Where_Clause =  @Where_Clause +  ' AND  BudgetToDate = 0 ' --ID
--			ELSE IF (@plan_To_month = 1 AND @ActualProjected  = 0) SET @Where_Clause =  @Where_Clause +  ' AND BudgetToDate <> 0 ' --ID
-- 
			IF @plan_To_month = 1 
				BEGIN						
						IF @ActualProjected = 2 OR @ActualProjected = 0 OR @Parts_Labour_Misc = 0
							SET @Where_Clause =  @Where_Clause +  ' AND 1 = 2 ' 
						ELSE
							SET @Where_Clause =  @Where_Clause +  ' AND BudgetToDate <> 0 '
				
				END
			ELSE
				BEGIN
						IF @ActualProjected = 0 OR @Parts_Labour_Misc = 0
							SET @Where_Clause =  @Where_Clause +  ' AND 1 = 2 ' 
						ELSE IF @ActualProjected = 1
							SET @Where_Clause =  @Where_Clause +  ' AND BudgetToDate <> 0 '
						ELSE IF @ActualProjected = 2
							SET @Where_Clause =  @Where_Clause +  ' AND BudgetToDate = 0 '
				END

			SET @GroupBy =  ' GROUP BY CalenderPeriod, ' + @AnalyseBy_Clause+ ',' + @AnalyseBy_Clause_2
			 --PRINT(@SQL +  ' FROM RPT_COST_COMPARISON_PROJ_V ' +  @Where_Clause + @GroupBy)
			--return
			EXEC(@SQL +  ' FROM RPT_COST_COMPARISON_PROJ_V INNER JOIN #aa_Eqp ON RPT_COST_COMPARISON_PROJ_V.EqpPlanID=#aa_Eqp.EqpPlanID ' +  @Where_Clause + @GroupBy)
		END


-- 	--Calculate Totals
-- 	--Find out the date range
	IF @IncludeMissingPeriods = 1
		BEGIN
		
			--Select the missing calender periods into a temporary table
			SET @SQL =  ' INSERT INTO #aa_CostComparison(AnalyseByID,AnalyseBy,AnalyseByID_2,AnalyseBy_2,CalenderPeriod,CalenderMonth,CalenderDate, Cost)'
			SET @SQL = @SQL + ' SELECT 0, '''',(Select top 1 AnalyseByID_2 from #aa_costComparison),(Select top 1 AnalyseBy_2 from #aa_costComparison),  rm.Calendar_Period, Convert(varchar(4), Left(rm.Calendar_Period,4)) + ''-'' + Convert(varchar(2),Right(rm.Calendar_Period,2)), rm.Start_Date, 0'
			SET @SQL = @SQL + ' FROM REPORT_MONTH_V rm INNER JOIN'
			SET @SQL = @SQL + ' tblEqpPlans ep ON DATEADD(m, 1, rm.Start_Date) >= ep.StartDate INNER JOIN'
			SET @SQL = @SQL + ' tblEqpProjs pr ON ep.EqpPlanId = pr.EqpPlanId AND DATEADD(m, - 1, rm.End_Date) <= pr.EndDate'
			SET @SQL = @SQL + ' WHERE (rm.Calendar_Period NOT IN'
			SET @SQL = @SQL + ' (SELECT DISTINCT CalenderPeriod'
			SET @SQL = @SQL + ' FROM          #aa_CostComparison'  + '))'
			IF @entire_Term =1
				BEGIN
					SET @SQL = @SQL + ' AND (rm.Calendar_Period BETWEEN '
					SET @SQL = @SQL + ' (SELECT MIN(CalenderPeriod) FROM #aa_CostComparison'  + ')'
					SET @SQL = @SQL + ' AND (SELECT MAX(CalenderPeriod) FROM #aa_CostComparison'  + '))'
				END
			ELSE IF @plan_To_month = 1
				BEGIN
					SET @SQL = @SQL + ' AND (rm.Calendar_Period BETWEEN '

					SET @SQL = @SQL + ' (SELECT MIN(CalenderPeriod) FROM #aa_CostComparison'  + ')'
					SET @SQL = @SQL + ' AND (YEAR(getdate()) * 100 + MONTH(getdate())))'
				END
			ELSE
				BEGIN
					SET @SQL = @SQL + ' AND (rm.Calendar_Period BETWEEN ' + Convert(varchar(6),@start_Date) + ' AND ' + Convert(varchar(6),@end_Date) + ')'
				END
			SET @SQL = @SQL + ' GROUP BY rm.Calendar_Period, rm.Start_Date'
			--print(@SQL)
			EXEC(@SQL)
		END 	
 	

	IF @AnalyseBy = 'MONH' 
		BEGIN
			SET @SQL =  ' SELECT  Space(255) as AnalyseBy, AnalyseBy_2, CalenderMonth as  CalenderPeriod, CalenderDate as CalenderPeriodDescr ,'
			SET @SQL = @SQL + ' CAST(SUM(Cost) as Decimal(38,3)) AS TotalCost FROM #aa_CostComparison' 
			SET @SQL = @SQL + ' GROUP BY CalenderPeriod, CalenderMonth, CalenderDate,AnalyseBy_2'
			SET @SQL = @SQL + ' ORDER BY CalenderPeriod,AnalyseBy_2 '
		END
	ELSE IF @AnalyseBy = 'QRTR' 
		BEGIN
			SET @SQL =  ' SELECT  Space(255) as AnalyseBy, AnalyseBy_2, Left(CalenderPeriod,4) + ''-Q'' + CONVERT(varchar(1),((Right(CalenderPeriod,2)+2)/3)) as  CalenderPeriod, Getdate() as CalenderPeriodDescr ,'
			SET @SQL = @SQL + ' CAST(SUM(Cost) as Decimal(38,3)) AS TotalCost FROM #aa_CostComparison' 
			SET @SQL = @SQL + ' GROUP BY Left(CalenderPeriod,4) + ''-Q'' + CONVERT(varchar(1),((Right(CalenderPeriod,2)+2)/3)),AnalyseBy_2'
			SET @SQL = @SQL + ' ORDER BY Left(CalenderPeriod,4) + ''-Q'' + CONVERT(varchar(1),((Right(CalenderPeriod,2)+2)/3)),AnalyseBy_2 '
		END
	ELSE IF @AnalyseBy = 'YEAR'  
		BEGIN
			SET @SQL =  ' SELECT  Space(255) as AnalyseBy, AnalyseBy_2, Left(CalenderPeriod,4) as  CalenderPeriod, Getdate() as CalenderPeriodDescr ,'
			SET @SQL = @SQL + ' CAST(SUM(Cost) as Decimal(38,3)) AS TotalCost FROM #aa_CostComparison' 
			SET @SQL = @SQL + ' GROUP BY Left(CalenderPeriod,4), AnalyseBy_2'
			SET @SQL = @SQL + ' ORDER BY Left(CalenderPeriod,4), AnalyseBy_2 '
		END
	ELSE
		BEGIN
			IF @PieChart = 1
			BEGIN
		
					SET @SQL =  'CREATE TABLE #aa_PieChartCosts(Number INT , AnalyseById INT, AnalyseBy VARCHAR(255), TotalCost FLOAT) '
					SET @SQL = @SQL + ' INSERT INTO #aa_PieChartCosts(Number,AnalyseById, AnalyseBy, TotalCost ) SELECT TOP 14 ROW_NUMBER() OVER (ORDER BY SUM(Cost) DESC) AS Number , AnalyseByID,AnalyseBy,CAST(SUM(Cost) as Decimal(38,3)) AS TotalCost '
					SET @SQL = @SQL + ' FROM #aa_CostComparison ' 
					SET @SQL = @SQL + ' WHERE AnalyseBy <> '''''
					SET @SQL = @SQL + ' GROUP BY AnalyseByID,AnalyseBy  '
					SET @SQL = @SQL + ' ORDER BY  TotalCost DESC '
					SET @SQL = @SQL + 'DECLARE @OthersCost FLOAT '
		 			SET @SQL = @SQL + 'SET @OthersCost = (SELECT SUM(Cost) FROM #aa_CostComparison WHERE AnalyseById NOT IN ( SELECT  AnalyseById FROM #aa_PieChartCosts)) '
					SET @SQL = @SQL + '  IF ISNULL(@OthersCost,0) > 0 BEGIN INSERT INTO #aa_PieChartCosts(Number,AnalyseById, AnalyseBy, TotalCost )  VALUES( 16, 0 , ''OTHERS'', @OthersCost) END'
					SET @SQL = @SQL + '  SELECT AnalyseByID, AnalyseBy , TotalCost FROM  #aa_PieChartCosts ORDER BY Number'
					SET @SQL = @SQL + '  DROP TABLE #aa_PieChartCosts '
					
					IF @AnalyseBy = 'PRDE'
					BEGIN			
							SET @SQL =  'CREATE TABLE #aa_PieChartCosts(Number INT , AnalyseById INT, AnalyseBy VARCHAR(255), TotalCost FLOAT) '
							SET @SQL = @SQL + ' INSERT INTO #aa_PieChartCosts(Number,AnalyseById, AnalyseBy, TotalCost ) SELECT TOP 14 ROW_NUMBER() OVER (ORDER BY SUM(Cost) DESC) AS Number , MIN(AnalyseByID) AS AnalyseById ,AnalyseBy,CAST(SUM(Cost) as Decimal(38,3)) AS TotalCost '
							SET @SQL = @SQL + ' FROM #aa_CostComparison ' 
							SET @SQL = @SQL + ' WHERE AnalyseBy <> '''''
							SET @SQL = @SQL + ' GROUP BY AnalyseBy  '
							SET @SQL = @SQL + ' ORDER BY  TotalCost DESC '
							SET @SQL = @SQL + 'DECLARE @OthersCost FLOAT '
		 					SET @SQL = @SQL + 'SET @OthersCost = (SELECT SUM(Cost) FROM #aa_CostComparison WHERE AnalyseBy NOT IN ( SELECT DISTINCT  AnalyseBy FROM #aa_PieChartCosts)) '
							SET @SQL = @SQL + '  IF ISNULL(@OthersCost,0) > 0 BEGIN INSERT INTO #aa_PieChartCosts(Number,AnalyseById, AnalyseBy, TotalCost )  VALUES( 16, 0 , ''OTHERS'', @OthersCost) END'
							SET @SQL = @SQL + '  SELECT AnalyseByID, AnalyseBy , TotalCost FROM  #aa_PieChartCosts ORDER BY Number'
							SET @SQL = @SQL + '  DROP TABLE #aa_PieChartCosts '
							END
					
				--	PRINT @SQL

				END		
			/* DA E652 - Check whether report is CostAnalysisLifeCycleText */
			ELSE IF @IncludeMissingPeriods = 1 AND @IsCostAnalysisLifeCycleReport = 1
				BEGIN		
					IF ISNULL(@Display,0) = 0
					BEGIN
						SET @SQL =  ' SELECT AnalyseByID,AnalyseBy,'
						SET @SQL = @SQL + ' CAST(SUM(Cost) as Decimal(38,3)) AS TotalCost '
						SET @SQL = @SQL + ' FROM #aa_CostComparison' 
						SET @SQL = @SQL + ' WHERE AnalyseBy <> '''''
						SET @SQL = @SQL + ' GROUP BY AnalyseByID,AnalyseBy'
						SET @SQL = @SQL + ' HAVING  CAST(SUM(Cost) as Decimal(38,3)) <> 0'
						SET @SQL = @SQL + ' ORDER BY TotalCost DESC'
						
						IF @AnalyseBy = 'PRDE'
						BEGIN
								SET @SQL =  ' SELECT MIN(AnalyseByID) AS AnalyseByID,AnalyseBy,'
							SET @SQL = @SQL + ' CAST(SUM(Cost) as Decimal(38,3)) AS TotalCost '
							SET @SQL = @SQL + ' FROM #aa_CostComparison' 
							SET @SQL = @SQL + ' WHERE AnalyseBy <> '''''
							SET @SQL = @SQL + ' GROUP BY AnalyseBy'
							SET @SQL = @SQL + ' HAVING  CAST(SUM(Cost) as Decimal(38,3)) <> 0'
							SET @SQL = @SQL + ' ORDER BY TotalCost DESC'
						END
					END
					ELSE IF ISNULL(@Display,0) = 1
					BEGIN
						--Cost Trending total cost 
						SET @SQL =  ' SELECT AnalyseByID,AnalyseBy,'
						SET @SQL = @SQL + ' CAST(SUM(Cost) as Decimal(38,3)) AS TotalCost '
						SET @SQL = @SQL + ' FROM #aa_CostComparison' 
						SET @SQL = @SQL + ' WHERE AnalyseBy <> '''''
						SET @SQL = @SQL + ' GROUP BY AnalyseByID,AnalyseBy'
						SET @SQL = @SQL + ' HAVING  CAST(SUM(Cost) as Decimal(38,3)) <> 0'
						SET @SQL = @SQL + ' ORDER BY TotalCost DESC'
					END
					ELSE 
					BEGIN
						--Cost Trending % total cost (for a given month)
						INSERT INTO #aa_TotalMonthCost(CalenderDate,TotalMONTHCost)
						SELECT CalenderDate,SUM(Cost)
						FROM #aa_CostComparison
						WHERE AnalyseBy <> ''
						GROUP BY CalenderDate

						SET @SQL =  ' SELECT CC.AnalyseByID,CC.AnalyseBy,CC.AnalyseBy_2, Space(7) as CalenderPeriod,'
						SET @SQL = @SQL + ' CC.CalenderDate as CalenderPeriodDescr, CAST(ISNULL(SUM(CC.Cost)/NULLIF(TMC.TotalMONTHCost,0),0)*100 as Decimal(38,3)) AS TotalCost '
						SET @SQL = @SQL + ' FROM #aa_CostComparison CC INNER JOIN #aa_TotalMonthCost TMC ON CC.CalenderDate=TMC.CalenderDate ' 
						SET @SQL = @SQL + ' WHERE CC.AnalyseBy <> '''''
						SET @SQL = @SQL + ' GROUP BY CC.AnalyseByID,CC.AnalyseBy, CC.AnalyseBy_2, CC.CalenderDate, TMC.TotalMONTHCost'
						SET @SQL = @SQL + ' ORDER BY  CC.CalenderDate,CC.AnalyseBy '
					END
				END
			ELSE IF @IncludeMissingPeriods = 1
				BEGIN
					IF ISNULL(@Display,0) = 0
					BEGIN
						
						SET @SQL =  ' SELECT  MIN(AnalyseByID) AS AnalyseByID ,AnalyseBy,AnalyseBy_2, Space(7) as CalenderPeriod,'
						SET @SQL = @SQL + '  Space(7) as CalenderPeriodDescr, CAST(SUM(Cost) as Decimal(38,3)) AS TotalCost '
						SET @SQL = @SQL + ' FROM #aa_CostComparison' 
						SET @SQL = @SQL + ' WHERE AnalyseBy <> '''''
						SET @SQL = @SQL + ' GROUP BY AnalyseBy, AnalyseBy_2'
						SET @SQL = @SQL + ' ORDER BY  AnalyseBy, AnalyseBy_2'
					END
					ELSE IF ISNULL(@Display,0) = 1
					BEGIN
					
				 
						--Cost Trending total cost 
						SET @SQL =  ' SELECT AnalyseByID,AnalyseBy,AnalyseBy_2, Space(7) as CalenderPeriod,'
						SET @SQL = @SQL + ' CalenderDate as CalenderPeriodDescr, CAST(SUM(Cost) as Decimal(38,3)) AS TotalCost '
						SET @SQL = @SQL + ' FROM #aa_CostComparison' 
						SET @SQL = @SQL + ' WHERE AnalyseBy <> '''''
						SET @SQL = @SQL + ' GROUP BY AnalyseByID,AnalyseBy, AnalyseBy_2, CalenderDate'
						SET @SQL = @SQL + ' ORDER BY  CalenderDate,AnalyseBy'
					END
					ELSE 
					BEGIN
						--Cost Trending % total cost (for a given month)
						INSERT INTO #aa_TotalMonthCost(CalenderDate,TotalMONTHCost)
						SELECT CalenderDate,SUM(Cost)
						FROM #aa_CostComparison
						WHERE AnalyseBy <> ''
						GROUP BY CalenderDate

						SET @SQL =  ' SELECT CC.AnalyseByID,CC.AnalyseBy,CC.AnalyseBy_2, Space(7) as CalenderPeriod,'
						SET @SQL = @SQL + ' CC.CalenderDate as CalenderPeriodDescr, CAST(ISNULL(SUM(CC.Cost)/NULLIF(TMC.TotalMONTHCost,0),0)*100 as Decimal(38,3)) AS TotalCost '
						SET @SQL = @SQL + ' FROM #aa_CostComparison CC INNER JOIN #aa_TotalMonthCost TMC ON CC.CalenderDate=TMC.CalenderDate ' 
						SET @SQL = @SQL + ' WHERE CC.AnalyseBy <> '''''
						SET @SQL = @SQL + ' GROUP BY CC.AnalyseByID,CC.AnalyseBy, CC.AnalyseBy_2, CC.CalenderDate, TMC.TotalMONTHCost'
						SET @SQL = @SQL + ' ORDER BY  CC.CalenderDate,CC.AnalyseBy '
					END
				END		
			ELSE
				BEGIN
				
					/* DA E652 - Check whether report is CostAnalysisLifeCycleText */
					IF @IsCostAnalysisLifeCycleReport = 1
					BEGIN
						SET @SQL =  ' SELECT AnalyseByID,AnalyseBy,'
						SET @SQL = @SQL + ' CAST(SUM(Cost) as Decimal(38,3)) AS TotalCost  '
						SET @SQL = @SQL + ' FROM #aa_CostComparison' 
						SET @SQL = @SQL + ' GROUP BY AnalyseByID,AnalyseBy'
						SET @SQL = @SQL + ' HAVING  CAST(SUM(Cost) as Decimal(38,3)) <> 0'
						SET @SQL = @SQL + ' ORDER BY AnalyseBy, TotalCost DESC'
					END
					ELSE
					BEGIN
						SET @SQL =  ' SELECT AnalyseByID,AnalyseBy,AnalyseBy_2, Space(7) as CalenderPeriod,'
						SET @SQL = @SQL + '  Getdate() as CalenderPeriodDescr, CAST(SUM(Cost) as Decimal(38,3)) AS TotalCost  '
						SET @SQL = @SQL + ' FROM #aa_CostComparison' 
						SET @SQL = @SQL + ' GROUP BY AnalyseByID,AnalyseBy,AnalyseBy_2'
						SET @SQL = @SQL + ' ORDER BY AnalyseBy, AnalyseBy_2, TotalCost DESC'
					END
				END		
		END
	 --print(@SQL)
	--return
	EXEC(@SQL)

	--Drop the temporary table

	DROP TABLE #aa_CostComparison,#aa_Eqp,#aa_TotalMonthCost

SET NOCOUNT OFF


GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[WORK_ORDER_MERGE_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[WORK_ORDER_MERGE_P]
GO

create  Procedure [dbo].[WORK_ORDER_MERGE_P]
/******************************************************************************
	File: WORK_ORDER_MERGE_P.sql
	Name: WORK_ORDER_MERGE_P

	Called By: Import Process.
			After Import of data is run, the overnight calculationprocess calls this first

	Desc: After Import of data is run, the overnight calculationprocess calls this first


	Auth: Robbie Feyder
	Date: 22 August 2002
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	16 Apr 12	VV		#3980 Check if SchedulingTask is null
	28 Apr 11	VV		E518: Changes to merging rule (2). Create Amt setting NoOfPeriodsToMerge. By default it is set to 4.  
	23 Mar 09	VV		CR7956 Workorders are merged incorrectly if there are dupliicate
						workorders with max AMT start date
	09 May 07	SI		Do not update anything if the values are not changed
	26 Oct 06	AL		Commented anything linked to archived WO
	16 oct 06	AL		Exclude all workorders where ForcedChild=2 for merging rule=0
	13 Oct 06	SI		Ellipse merging: if any Wo in the group has a parent from another group do not automerge this group
	19-Sep-2006	ID		Commented the inserting records into tblUnlinkedWO table 
	24 Jul 06	SI		Removed usp_DuplicateWorkOrder
	28/1/03		RF			Add in setting grandparent as the parent
							Reset parent when child has codes translated and parent doesn't (and is not Reviewed)	

	31.3.03		RF			Add Maintenance Plan merge based on Equip Plan ID	

	20/2/03		RF			CR 2365  WO Linked to an EQS task.  Also marked as reviewed.  Imported another WO 
							that made this WO the child of the new WO.  Should not be allowed.				

	3 MARCH 03	RF			DUPLICATE WO prior to merging	
							Clean up workorders where more than 1 current WO with the same Workorder Number.

	6 MARCH 03	RF			FIX up merging of NON CURRENT WO
	24 Mar 04	VV			Add TASK_WO_PARENT_RELINK_P
	21 Apr 05	DS			Added special Merchand merging logic
	14 Sep 05	SI			Merchand merging logic now runs when Merging_Rule=1
	31 Oct 05	SI			Parent Workorder Number merging rule should allways work, even when interface update process run
	13 Dec 05	SI			New merging rules for Ellipse
	23 Jan 06	SI			Used new PureWONumber field instead of index view for the Ellipse merging rules
	12 Apr 06	SI			Fixed merging rules for Ellipse that worked incorrect for archived WO
	13 Apr 06	SI			Rules 4,5 are not executed if the Ellipse merging rule is set
*******************************************************************************/
	/* Param List */


AS


DECLARE @cWOID int
DECLARE @pWOID int
DECLARE @cParentWOID int
DECLARE @pParentWOID int
DECLARE @ppReviewed smallint
DECLARE @ppMPID int
DECLARE @cpReviewed smallint
DECLARE @cpMPID int
DECLARE @ppPricedJobID int
DECLARE @cpPricedJobID int

DECLARE @WorkOrderId int
DECLARE @GrandparentWorkOrderID int

DECLARE @WorkOrderNumber varchar(50)
DECLARE @EqpPlanId INT

DECLARE @NewParentWOID int
DECLARE @OldParentWOID int

DECLARE @DupWorkorderID int

DECLARE @MP_WorkOrderId int

DECLARE @Merging_Rule int
SELECT TOP 1 @Merging_Rule=Merging_Rule FROM AMT_VARIABLE


/******************************************************************************
 RULES FOR MERGING
 =================

 MERGING PARAMETER (Merging_Rule)
 --------------------------------
 0 = Normal (ie Trakindo Original)
 1 = Merchand
 2 = Ellipse (Yanacocha)


 MERGING STEPS
 -------------

 0. IF there is more than 1 current workorder with the same workorder number, then set the highest WO ID as the correct one.
	This must be an error in the interface process
 

 2. For GRANDPARENTS, MAke the Parent the Grandparent. 

 1. DEMERGE workorders where the parent is INVALID

 3. Set Parent Workorder ID's based on Duty Free/Duty Paid linkages 
      (It is not executed if the Ellipse merging rule is set)
	 1. Duty Free Workorder identified - Parent is Duty Paid Workorder
	 2. Parent Workorder Number specified
	 3. Manually merged workorders (don't demerge)
 4. Maintenance Plan Number and same Call number Parent is lowest Maint Item Number
      (It is not executed if the Ellipse merging rule is set)
 5. Update Parent where incorrect parent has been stated based on code translation.
      (It is not executed if the Ellipse merging rule is set)
	 If the child WO has Priced Job or Maint Plan set but the parent has not this child WO should be the parent.
	 If the child WO has AMTTaskTypeId set but the parent has not this child WO should be the parent.
	 If Child WO is reviewed and the Parent has not been reviewed then set the child as the parent workorder.
 6. Merging rules for Ellipse (It is executed only if the Ellipse merging rule is set)
	Workorder is split into a workorder for each month (each months transactions)
	The latest workorder is considered the parent workorder (has latest information on job date)
	IF Workorder has an MST then merge the workorder.  
	If earliest start date is within 4 months of job date then merge the workorder.
	If there are 2 workorders with the same transaction date the latest workorder is considered to be a parent.
 7. If there were any tasks linked to work orders which became children, relink the tasks
 8. Merging rules for Merchand (It is executed only if the Merchand merging rule is set)
	This relates to specific job types in the Merchand Interface.
	Specific jobs are treated as component changeout jobs and in this case many periods are merged.

*******************************************************************************/

-------------------------------------------------------------------------------------------

-- RF 3 MARCH 03	Is there more than 1 current workorder with the same workorder number, then set max WOID as the current.
-- 0. IF there is more than 1 current workorder with the same workorder number, then set the highest WO ID as the correct one.
--	This must be an error in the interface process

	--ARE THERE DUPLICATE CURRENT WORKORDERS
	IF EXISTS (SELECT * FROM WORK_ORDER_DUPLICATES_V) 
		-- CLEAN UP THESE DUPLICATES
		-- BEST TO DO THIS FOR ALL WORKORDERS THAT ARE DUPLICATE.
		EXEC WORK_ORDER_CLEAN_DUPLICATES_P

	ELSE IF EXISTS (SELECT * FROM .WORK_ORDER_PARENT_STATUS_DUP_V) 
		-- CLEAN UP THESE DUPLICATES
		-- BEST TO DO THIS FOR ALL WORKORDERS THAT ARE DUPLICATE.
		EXEC WORK_ORDER_CLEAN_DUPLICATES_P
-------------------------------------------------------------------------------------
-- 1. DEMERGE workorders where the parent is INVALID
/*
DECLARE cInvalidParentWO CURSOR READ_ONLY FOR
	
	SELECT     WorkOrderId
	FROM         dbo.tblWorkOrders
	WHERE
	(AMTParentWorkOrderId NOT IN
	                          (SELECT     AMTParentWorkOrderId
	                            FROM          tblWorkOrders
	                            WHERE      (AMTParentWorkOrderId = WorkOrderId))) AND (ISNULL(CurrentWorkOrder, 0) <> 0)
	GROUP BY WorkOrderId

OPEN cInvalidParentWO
FETCH NEXT FROM cInvalidParentWO INTO
@WorkOrderId

WHILE @@Fetch_Status = 0
BEGIN

	-- DUPLICATE WORKORDERS  RF 3 MARCH 03
-- 	EXEC 	usp_DuplicateWorkOrder
-- 			@piWorkOrderId = @WorkOrderId,
-- 			@piNewWorkOrderId = @DupWorkorderID OUTPUT
	
	SET @WorkOrderId = @DupWorkorderID
	---------------------------------------------------------
/*
--ID Commented (19-Sep-2006)
	EXEC	usp_Set_Work_Order_Unlinked
			@WorkOrderId  = @WorkOrderId
*/
	UPDATE    tblWorkOrders
	SET              AMTParentWorkOrderId = WorkOrderId 
	WHERE     (WorkOrderId = @WorkOrderId)
		AND (ForcedChild<>2 OR @Merging_Rule>0)	--AL: 16/10/06
		AND AMTParentWorkOrderId <> WorkOrderId 

	FETCH NEXT FROM cInvalidParentWO INTO
	@WorkOrderId

END
CLOSE cInvalidParentWO
DEALLOCATE cInvalidParentWO
*/

----VV 23-Mar-2009 Moved cursor into update query
--
--UPDATE    tblWorkOrders
--	SET  AMTParentWorkOrderId = WorkOrderId 
--WHERE (ForcedChild<>2 OR @Merging_Rule>0) AND
--(AMTParentWorkOrderId NOT IN
--	                          (SELECT     AMTParentWorkOrderId
--	                            FROM          tblWorkOrders
--	                            WHERE      (AMTParentWorkOrderId = WorkOrderId))) 
--AND (ISNULL(CurrentWorkOrder, 0) <> 0)
--


-------------------------------------------------------------------------------------
-- 2. For GRANDPARENTS, Make the Parent the Grandparent. 

DECLARE cGrandParentWO CURSOR READ_ONLY FOR
	
	SELECT     CWO.WorkOrderId AS CWO, PWO.AMTParentWorkOrderId AS PWO
	FROM         dbo.tblWorkOrders CWO INNER JOIN
	                      dbo.tblWorkOrders PWO ON CWO.AMTParentWorkOrderId = PWO.WorkOrderId
	WHERE     (ISNULL(PWO.CurrentWorkOrder, 0) <> 0) 
			AND (PWO.WorkOrderId <> PWO.AMTParentWorkOrderId) 
			AND (ISNULL(CWO.CurrentWorkOrder, 0) <> 0)


OPEN cGrandParentWO
FETCH NEXT FROM cGrandParentWO INTO
@WorkOrderId, @GrandparentWorkOrderID

WHILE @@Fetch_Status = 0
BEGIN


	-- DUPLICATE WORKORDERS  RF 3 MARCH 03
-- 	EXEC 	usp_DuplicateWorkOrder
-- 			@piWorkOrderId = @WorkOrderId,
-- 			@piNewWorkOrderId = @DupWorkorderID OUTPUT
-- 	
-- 	SET @WorkOrderId = @DupWorkorderID
-- 
-- 
-- 	EXEC 	usp_DuplicateWorkOrder
-- 			@piWorkOrderId = @GrandparentWorkOrderID,
-- 			@piNewWorkOrderId = @DupWorkorderID OUTPUT
-- 	
-- 
-- 	SET @GrandparentWorkOrderID = @DupWorkorderID
	---------------------------------------------------------
/*
--ID Commented (19-Sep-2006)
	EXEC	usp_Set_Work_Order_Unlinked
			@WorkOrderId  = @WorkOrderId
*/
	UPDATE    tblWorkOrders
	SET              AMTParentWorkOrderId = @GrandparentWorkOrderID 
	WHERE     (WorkOrderId = @WorkOrderId)
		--VV 23-Mar-09 Discussed with RF
		--AND (ForcedChild<>2 OR @Merging_Rule>0)	--AL: 16/10/06
		AND AMTParentWorkOrderId <> @GrandparentWorkOrderID 

	FETCH NEXT FROM cGrandParentWO INTO
	@WorkOrderId, @GrandparentWorkOrderID

END
CLOSE cGrandParentWO
DEALLOCATE cGrandParentWO


-- 1. DEMERGE workorders where the parent is INVALID

--VV 23-Mar-2009 Moved cursor into update query and changed the sequence
--1) Make the Parent the Grandparent. 
--2) DEMERGE workorders where the parent is INVALID

UPDATE    tblWorkOrders
	SET  AMTParentWorkOrderId = WorkOrderId,
	/*VV 23-Mar-09 Discussed with RF*/
	ForcedChild=1
WHERE /* VV 23-Mar-09 Discussed with RF (ForcedChild<>2 OR @Merging_Rule>0) AND*/
(AMTParentWorkOrderId NOT IN
	                          (SELECT     AMTParentWorkOrderId
	                            FROM          tblWorkOrders
	                            WHERE      (AMTParentWorkOrderId = WorkOrderId))) 



-------------------------------------------------------------------------------------
-- 3. Set Parent Workorder ID's based on Duty Free/Duty Paid linkages
IF @Merging_Rule<>2
BEGIN

-- 1. Duty Free Workorder identified - Parent is Duty Paid Workorder
DECLARE cDFWorkOrder CURSOR READ_ONLY FOR
	-- USE DF WORKORDER NUMBER AS WELL AS ADDING '00' AS A PREFIX TO THE DF WORKORDER NUMBER.
	SELECT     cwo.WorkOrderId AS cWOID, pwo.WorkOrderId AS pWOID, cwo.AMTParentWorkOrderId AS cParentWOID, pwo.AMTParentWorkOrderId AS pParentWOID,
	                       ISNULL(ppwo.Reviewed, 0) AS ppReviewed, ISNULL(pwo.MntPlanId, 0) AS ppMPID, ISNULL(cpwo.Reviewed, 0) AS cpReviewed, 
				ISNULL(pwo.MntPlanId, 0) AS cpMPID, ISNULL(ppwo.PricedJobId, 0) AS ppPricedJobID, ISNULL(cpwo.PricedJobId, 0) AS cpPricedJobID
	FROM         tblWorkOrders pwo INNER JOIN
	                      tblWorkOrders cwo ON pwo.DutyFreeWorkOrderNumber = cwo.WorkOrderNumber AND pwo.AMTParentWorkOrderId <> cwo.AMTParentWorkOrderId AND
	                       pwo.EqpPlanId = cwo.EqpPlanId INNER JOIN
	                      tblWorkOrders ppwo ON pwo.AMTParentWorkOrderId = ppwo.WorkOrderId AND pwo.EqpPlanId = ppwo.EqpPlanId INNER JOIN
	                      tblWorkOrders cpwo ON cwo.AMTParentWorkOrderId = cpwo.WorkOrderId AND cwo.EqpPlanId = cpwo.EqpPlanId
	WHERE     (ISNULL(pwo.CurrentWorkOrder,0) <> 0) AND (ISNULL(cwo.CurrentWorkOrder,0) <> 0)
	UNION

	SELECT     cwo.WorkOrderId AS cWOID, pwo.WorkOrderId AS pWOID, cwo.AMTParentWorkOrderId AS cParentWOID, pwo.AMTParentWorkOrderId AS pParentWOID,
	                        ISNULL(ppwo.Reviewed, 0) AS ppReviewed, ISNULL(pwo.MntPlanId, 0) AS ppMPID, ISNULL(cpwo.Reviewed, 0) AS cpReviewed, 
				ISNULL(pwo.MntPlanId, 0) AS cpMPID, ISNULL(ppwo.PricedJobId, 0) AS ppPricedJobID, ISNULL(cpwo.PricedJobId, 0) AS cpPricedJobID
	FROM         tblWorkOrders pwo INNER JOIN
	                      tblWorkOrders cwo ON pwo.AMTParentWorkOrderId <> cwo.AMTParentWorkOrderId AND 
	                      cwo.WorkOrderNumber = '00' + pwo.DutyFreeWorkOrderNumber AND pwo.EqpPlanId = cwo.EqpPlanId INNER JOIN
	                      tblWorkOrders ppwo ON pwo.AMTParentWorkOrderId = ppwo.WorkOrderId AND pwo.EqpPlanId = ppwo.EqpPlanId INNER JOIN
	                      tblWorkOrders cpwo ON cwo.AMTParentWorkOrderId = cpwo.WorkOrderId AND cwo.EqpPlanId = cpwo.EqpPlanId
	WHERE     (ISNULL(pwo.CurrentWorkOrder,0) <> 0) AND (ISNULL(cwo.CurrentWorkOrder,0) <> 0)
-- 2. Parent Workorder Number specified
	UNION
	SELECT     cwo.WorkOrderId AS cWOID, pwo.WorkOrderId AS pWOID, cwo.AMTParentWorkOrderId AS cParentWOID, pwo.AMTParentWorkOrderId AS pParentWOID,
	                       ISNULL(ppwo.Reviewed, 0) AS ppReviewed, ISNULL(pwo.MntPlanId, 0) AS ppMPID, ISNULL(cpwo.Reviewed, 0) AS cpReviewed, 
				ISNULL(pwo.MntPlanId, 0) AS cpMPID, ISNULL(ppwo.PricedJobId, 0) AS ppPricedJobID, ISNULL(cpwo.PricedJobId, 0) AS cpPricedJobID
	FROM         tblWorkOrders pwo INNER JOIN
	                      tblWorkOrders cwo ON pwo.AMTParentWorkOrderId <> cwo.AMTParentWorkOrderId AND 
			      pwo.EqpPlanId = cwo.EqpPlanId AND 
	                      pwo.WorkOrderNumber = cwo.ParentWorkorderNumber INNER JOIN
	                      tblWorkOrders ppwo ON pwo.AMTParentWorkOrderId = ppwo.WorkOrderId AND pwo.EqpPlanId = ppwo.EqpPlanId INNER JOIN
	                      tblWorkOrders cpwo ON cwo.AMTParentWorkOrderId = cpwo.WorkOrderId AND cwo.EqpPlanId = cpwo.EqpPlanId
	WHERE     (ISNULL(pwo.CurrentWorkOrder,0) <> 0) AND (ISNULL(cwo.CurrentWorkOrder,0) <> 0)

	OPEN cDFWorkOrder
	FETCH NEXT FROM cDFWorkOrder INTO
	 @cWOID ,
	 @pWOID ,
	 @cParentWOID ,
	 @pParentWOID ,
	 @ppReviewed ,
	 @ppMPID ,
	 @cpReviewed ,
	 @cpMPID,
	 @ppPricedJobID,
	 @cpPricedJobID
	
	WHILE @@Fetch_status = 0
	BEGIN
	/* 	ORDER OF LOGIC OF MERGING. (20 Feb 03)
		
		1.	If WO is reviewed, then this is the parent (Covers WO linked to a TASK)
		2. 	If Maintenance Plan this is the Parent
		3. 	If Std Job, this is the parent
		4. 	if Duty Paid, this is the Parent
	*/
	
		-- DUPLICATE WORKORDERS  RF 3 MARCH 03
	
-- 		EXEC 	usp_DuplicateWorkOrder
-- 				@piWorkOrderId = @cParentWOID,
-- 				@piNewWorkOrderId = @DupWorkorderID OUTPUT
-- 		
-- 		SET @cParentWOID = @DupWorkorderID
-- 	
-- 	
-- 		EXEC 	usp_DuplicateWorkOrder
-- 				@piWorkOrderId = @pParentWOID,
-- 				@piNewWorkOrderId = @DupWorkorderID OUTPUT
-- 		
-- 		SET @pParentWOID = @DupWorkorderID
		---------------------------------------------------------
	
		 IF @ppReviewed <>0
			BEGIN
			-- 1. REVIEWED --  Use the Parent
		
				UPDATE    tblWorkOrders
				SET              AMTParentWorkOrderId = @pParentWOID
				WHERE     (AMTParentWorkOrderId = @cParentWOID)
					AND (ForcedChild<>2 OR @Merging_Rule>0)	--AL: 16/10/06
					AND AMTParentWorkOrderId <> @pParentWOID

		/*	
		--ID Commented (19-Sep-2006)	
				EXEC	usp_Set_Work_Order_Unlinked
					@WorkOrderId  = @pParentWOID
		*/
			END
		ELSE IF @cpReviewed <>0
			BEGIN
			-- 1. REVIEWED --  Use the Child
		
				UPDATE    tblWorkOrders
				SET              AMTParentWorkOrderId = @cParentWOID
				WHERE     (AMTParentWorkOrderId = @pParentWOID)
					AND (ForcedChild<>2 OR @Merging_Rule>0)	--AL: 16/10/06
					AND AMTParentWorkOrderId <> @cParentWOID
		/*
		--ID Commented (19-Sep-2006)		
				EXEC	usp_Set_Work_Order_Unlinked
					@WorkOrderId  = @cParentWOID
		*/
			END
	
		ELSE IF @ppMPID  > 0 
			BEGIN
			-- 2. MAintenance Plan -- Use the parent
			
				UPDATE    tblWorkOrders
				SET              AMTParentWorkOrderId = @pParentWOID
				WHERE     (AMTParentWorkOrderId = @cParentWOID)
					AND (ForcedChild<>2 OR @Merging_Rule>0)	--AL: 16/10/06
					AND AMTParentWorkOrderId <> @pParentWOID
		/*	
		--ID Commented (19-Sep-2006)	
				EXEC	usp_Set_Work_Order_Unlinked
					@WorkOrderId  = @pParentWOID
		*/
			END
		ELSE IF @cpMPID > 0 
			BEGIN
			--  2. MAintenance Plan --  Use the Child
		
				UPDATE    tblWorkOrders
				SET              AMTParentWorkOrderId = @cParentWOID
				WHERE     (AMTParentWorkOrderId = @pParentWOID)
					AND (ForcedChild<>2 OR @Merging_Rule>0)	--AL: 16/10/06
					AND AMTParentWorkOrderId <> @cParentWOID
		/*	
		--ID Commented (19-Sep-2006)	
				EXEC	usp_Set_Work_Order_Unlinked
					@WorkOrderId  = @cParentWOID
		*/
			END
		ELSE IF  @ppPricedJobID > 0
			BEGIN
			-- 3. Standard Job -- Use the parent
			
				UPDATE    tblWorkOrders
				SET              AMTParentWorkOrderId = @pParentWOID
				WHERE     (AMTParentWorkOrderId = @cParentWOID)
					AND (ForcedChild<>2 OR @Merging_Rule>0)	--AL: 16/10/06
					AND AMTParentWorkOrderId <> @pParentWOID
		/*	
		--ID Commented (19-Sep-2006)	
				EXEC	usp_Set_Work_Order_Unlinked
					@WorkOrderId  = @pParentWOID
		*/
			END
		ELSE IF @cpPricedJobID > 0
			BEGIN
			--  3. Standard Job -- Use the Child
		
				UPDATE    tblWorkOrders
				SET              AMTParentWorkOrderId = @cParentWOID
				WHERE     (AMTParentWorkOrderId = @pParentWOID)
					AND (ForcedChild<>2 OR @Merging_Rule>0)	--AL: 16/10/06
					AND AMTParentWorkOrderId <> @cParentWOID
		/*
		--ID Commented (19-Sep-2006)		
				EXEC	usp_Set_Work_Order_Unlinked
					@WorkOrderId  = @cParentWOID
		*/
			END
	
		ELSE
			BEGIN
			--4. Duty Paid WO -- Use the Parent
		
				UPDATE    tblWorkOrders
				SET              AMTParentWorkOrderId = @pParentWOID
				WHERE     (AMTParentWorkOrderId = @cParentWOID)
					AND (ForcedChild<>2 OR @Merging_Rule>0)	--AL: 16/10/06
					AND AMTParentWorkOrderId <> @pParentWOID
		/*
		--ID Commented (19-Sep-2006)		
				EXEC	usp_Set_Work_Order_Unlinked
					@WorkOrderId  = @pParentWOID
		*/
			END
		
		FETCH NEXT FROM cDFWorkOrder INTO
		 @cWOID ,
		 @pWOID ,
		 @cParentWOID ,
		 @pParentWOID ,
		 @ppReviewed ,
		 @ppMPID ,
		 @cpReviewed ,
		 @cpMPID ,
		 @ppPricedJobID,
		 @cpPricedJobID
	END
	
	CLOSE cDFWorkOrder
	DEALLOCATE cDFWorkOrder

	-------------------------------------------------------------------------------------
	-- 4. Maintenance Plan Number and same Call number Parent is lowest Maint Item Number
	
	
	DECLARE cMPWO CURSOR READ_ONLY FOR
		
		SELECT      AMTParentWorkOrderId
		FROM         Work_Order_Maint_Plans_New_Parent_V
	
		OPEN cMPWO
		FETCH NEXT FROM cMPWO INTO
		@WorkOrderId
	
		WHILE @@fetch_status = 0
		BEGIN
			-- DUPLICATE WORKORDERS  RF 3 MARCH 03
	
-- 			EXEC 	usp_DuplicateWorkOrder
-- 					@piWorkOrderId = @WorkOrderId,
-- 					@piNewWorkOrderId = @DupWorkorderID OUTPUT
-- 			
-- 			SET @WorkOrderId = @DupWorkorderID
			----------------------------------------------------------------
		/*
		--ID Commented (19-Sep-2006)
			EXEC	usp_Set_Work_Order_Unlinked
					@WorkOrderId  = @WorkOrderId
		*/
	
			DECLARE cMPWOChild CURSOR READ_ONLY FOR
				
				SELECT       tblWorkOrders.AMTParentWorkOrderId
				FROM         dbo.Work_Order_Maint_Plans_New_Parent_V INNER JOIN
			                      dbo.tblWorkOrders ON dbo.Work_Order_Maint_Plans_New_Parent_V.MaintPlanCallNumber = dbo.tblWorkOrders.MaintPlanCallNumber AND 
			                      dbo.Work_Order_Maint_Plans_New_Parent_V.MaintenancePlanNumber = dbo.tblWorkOrders.MaintenancePlanNumber AND 
			                      dbo.Work_Order_Maint_Plans_New_Parent_V.EqpPlanId = dbo.tblWorkOrders.EqpPlanId
				WHERE  Work_Order_Maint_Plans_New_Parent_V.AMTParentWorkOrderId = @WorkOrderId
						-- RF 6 MARCH 03
						AND (ISNULL(dbo.tblWorkOrders.CurrentWorkOrder, 0) <> 0)
		
				OPEN cMPWOChild
				FETCH NEXT FROM cMPWOChild INTO
				@MP_WorkOrderId
			
				WHILE @@fetch_status = 0
				BEGIN
-- 					EXEC 	usp_DuplicateWorkOrder
-- 							@piWorkOrderId = @MP_WorkOrderId,
-- 							@piNewWorkOrderId = @DupWorkorderID OUTPUT
-- 					
-- 					SET @MP_WorkOrderId = @DupWorkorderID
	
					UPDATE  tblWorkOrders
					SET   AMTParentWorkOrderId = @WorkOrderId
					WHERE  AMTParentWorkOrderId = @MP_WorkOrderId
						AND (ForcedChild<>2 OR @Merging_Rule>0)	--AL: 16/10/06	
						AND AMTParentWorkOrderId <> @WorkOrderId

					FETCH NEXT FROM cMPWOChild INTO
					@MP_WorkOrderId
				END
				CLOSE  cMPWOChild
				DEALLOCATE cMPWOChild
			
			FETCH NEXT FROM cMPWO INTO
			@WorkOrderId
		END
	
		CLOSE cMPWO
		DEALLOCATE cMPWO
	----------------------------------------------------------------------------------------
	-- 5. Update Parent where incorrect parent has been stated based on code translation.
	
	-- Have Priced Job or Maint Plan set
	-- If the child WO has Priced Job or Maint Plan set but the parent has not this child WO should be the parent.
	DECLARE cSetNewParentWO CURSOR READ_ONLY FOR
		SELECT     MIN(cwo.WorkOrderId) AS NewParentWOID, pwo.AMTParentWorkOrderId AS OldParentWOID
		FROM         dbo.tblWorkOrders cwo INNER JOIN
		                      dbo.tblWorkOrders pwo ON cwo.AMTParentWorkOrderId = pwo.WorkOrderId AND cwo.WorkOrderId <> pwo.WorkOrderId
		WHERE     (ISNULL(pwo.AMTTaskTypeId, 0) = 0) 
				AND (ISNULL(pwo.MntPlanId, 0) = 0) 
				AND (ISNULL(pwo.Reviewed, 0) = 0) 
				AND (ISNULL(pwo.PricedJobId, 0) = 0) 
		                 AND (ISNULL(cwo.MntPlanId, 0) + ISNULL(cwo.PricedJobId, 0) <> 0) 
				-- RF 6 MARCH 03
				AND (ISNULL(cwo.CurrentWorkOrder, 0) <> 0) 
				AND (ISNULL(pwo.CurrentWorkOrder, 0) <> 0)
		GROUP BY pwo.AMTParentWorkOrderId
	
		OPEN cSetNewParentWO
		
		FETCH NEXT FROM cSetNewParentWO INTO 
		@NewParentWOID, @OldParentWOID
	
	WHILE @@Fetch_Status = 0
	BEGIN
	
		-- DUPLICATE WORKORDERS  RF 3 MARCH 03
	
-- 		EXEC 	usp_DuplicateWorkOrder
-- 				@piWorkOrderId = @NewParentWOID,
-- 				@piNewWorkOrderId = @DupWorkorderID OUTPUT
-- 		
-- 		SET @NewParentWOID = @DupWorkorderID
-- 	
-- 		EXEC 	usp_DuplicateWorkOrder
-- 				@piWorkOrderId = @OldParentWOID,
-- 				@piNewWorkOrderId = @DupWorkorderID OUTPUT
-- 		
-- 		SET @OldParentWOID = @DupWorkorderID
		----------------------------------------------------------------
	/*
	--ID Commented (19-Sep-2006)
		EXEC	usp_Set_Work_Order_Unlinked
			@WorkOrderId  = @NewParentWOID
	*/
		UPDATE    tblWorkOrders
		SET              AMTParentWorkOrderId = @NewParentWOID 
		WHERE     (AMTParentWorkOrderId = @OldParentWOID)
			AND (ForcedChild<>2 OR @Merging_Rule>0)	--AL: 16/10/06
			AND AMTParentWorkOrderId <> @NewParentWOID 
	
		FETCH NEXT FROM cSetNewParentWO INTO 
		@NewParentWOID, @OldParentWOID
	
	END
	CLOSE cSetNewParentWO
	DEALLOCATE cSetNewParentWO
	
	-- Have AMT Task Type Set
	-- If the child WO has AMTTaskTypeId set but the parent has not this child WO should be the parent.
	DECLARE cSetNewParentWO CURSOR READ_ONLY FOR
		SELECT     MIN(cwo.WorkOrderId) AS NewParentWOID, pwo.AMTParentWorkOrderId AS OldParentWOID
		FROM         dbo.tblWorkOrders cwo INNER JOIN
		                      dbo.tblWorkOrders pwo ON cwo.AMTParentWorkOrderId = pwo.WorkOrderId AND cwo.WorkOrderId <> pwo.WorkOrderId
		WHERE     (ISNULL(pwo.AMTTaskTypeId, 0) = 0) 
				AND (ISNULL(pwo.MntPlanId, 0) = 0) 
				AND (ISNULL(pwo.Reviewed, 0) = 0) 
				AND (ISNULL(cwo.AMTTaskTypeId, 0)  <> 0) 
				AND (ISNULL(pwo.PricedJobId, 0) = 0)
				-- RF 6 MARCH 03
				AND (ISNULL(cwo.CurrentWorkOrder, 0) <> 0) 
				AND (ISNULL(pwo.CurrentWorkOrder, 0) <> 0)
		GROUP BY pwo.AMTParentWorkOrderId
	
	OPEN cSetNewParentWO
	FETCH NEXT FROM cSetNewParentWO INTO 
	@NewParentWOID, @OldParentWOID
	
	WHILE @@Fetch_Status = 0
	BEGIN
	
		-- DUPLICATE WORKORDERS  RF 3 MARCH 03
	
-- 		EXEC 	usp_DuplicateWorkOrder
-- 				@piWorkOrderId = @NewParentWOID,
-- 				@piNewWorkOrderId = @DupWorkorderID OUTPUT
-- 		
-- 		SET @NewParentWOID = @DupWorkorderID
-- 	
-- 		EXEC 	usp_DuplicateWorkOrder
-- 				@piWorkOrderId = @OldParentWOID,
-- 				@piNewWorkOrderId = @DupWorkorderID OUTPUT
-- 		
-- 		SET @OldParentWOID = @DupWorkorderID
		----------------------------------------------------------------
	/*
	--ID Commented (19-Sep-2006)
		EXEC	usp_Set_Work_Order_Unlinked
			@WorkOrderId  = @NewParentWOID
	*/
		UPDATE    tblWorkOrders
		SET              AMTParentWorkOrderId = @NewParentWOID 
		WHERE     (AMTParentWorkOrderId = @OldParentWOID)
			AND (ForcedChild<>2 OR @Merging_Rule>0)	--AL: 16/10/06
			AND AMTParentWorkOrderId <> @NewParentWOID
		
		FETCH NEXT FROM cSetNewParentWO INTO 
		@NewParentWOID, @OldParentWOID
	
	END
	
	CLOSE cSetNewParentWO
	DEALLOCATE cSetNewParentWO

/* FIX FOR CHILDREN REVIEWED AND PARENTS NOT - 20 FEB 03*/

-- Have AMT Task Type Set
-- If the child WO is reviewed but the parent is not this child WO should be the parent.
	DECLARE cSetNewParentWO CURSOR READ_ONLY FOR
		SELECT     MIN(cwo.WorkOrderId) AS NewParentWO, pwo.WorkOrderId AS OldParentWO
		FROM         tblWorkOrders cwo INNER JOIN
		                      tblWorkOrders pwo ON cwo.AMTParentWorkOrderId = pwo.WorkOrderId
		WHERE     (ISNULL(cwo.Reviewed, 0) <> 0) 
				AND (ISNULL(pwo.Reviewed, 0) = 0)
				-- RF 6 MARCH 03
				AND (ISNULL(cwo.CurrentWorkOrder, 0) <> 0) 
				AND (ISNULL(pwo.CurrentWorkOrder, 0) <> 0)
		GROUP BY pwo.WorkOrderId
		ORDER BY pwo.WorkOrderId
	
		OPEN cSetNewParentWO
		FETCH NEXT FROM cSetNewParentWO INTO 
		@NewParentWOID, @OldParentWOID
	
	WHILE @@Fetch_Status = 0
	BEGIN
	
		-- DUPLICATE WORKORDERS  RF 3 MARCH 03
	
-- 		EXEC 	usp_DuplicateWorkOrder
-- 				@piWorkOrderId = @NewParentWOID,
-- 				@piNewWorkOrderId = @DupWorkorderID OUTPUT
-- 		
-- 		SET @NewParentWOID = @DupWorkorderID
-- 	
-- 		EXEC 	usp_DuplicateWorkOrder
-- 				@piWorkOrderId = @OldParentWOID,
-- 				@piNewWorkOrderId = @DupWorkorderID OUTPUT
-- 		
-- 		SET @OldParentWOID = @DupWorkorderID
		----------------------------------------------------------------
	/*
	--ID Commented (19-Sep-2006)
		EXEC	usp_Set_Work_Order_Unlinked
			@WorkOrderId  = @NewParentWOID
	*/
		UPDATE    tblWorkOrders
		SET              AMTParentWorkOrderId = @NewParentWOID 
		WHERE     (AMTParentWorkOrderId = @OldParentWOID)
			AND (ForcedChild<>2 OR @Merging_Rule>0)	--AL: 16/10/06
			AND AMTParentWorkOrderId <> @NewParentWOID 
		
		FETCH NEXT FROM cSetNewParentWO INTO 
		@NewParentWOID, @OldParentWOID
	
	END
	
	CLOSE cSetNewParentWO
	DEALLOCATE cSetNewParentWO

END

--************************************************************
-- 6. Merging rules for Ellipse (It is executed only if the Ellipse merging rule is set)
IF @Merging_Rule=2
BEGIN --Ellipse Merging Rule

	DECLARE @MergeDateRange int
	
	/*VV E518*/
	EXEC AMT_TYPED_VARIABLE_GET_P  @Value_Name='NoOfPeriodsToMerge',@Varchar_Value=@MergeDateRange OUTPUT
	
	SET @MergeDateRange=ISNULL(@MergeDateRange,4)
	
	
-- 	DECLARE @ArchivedWorkOrder bit

	-- if we use AMTStartDate we will get duplicated records
	--UPDATE woi
	--	SET AMTParentWorkOrderId=ISNULL(wop.WorkorderId,wo.WorkOrderId)

	/*VV #3980 changed SchedulingTask to ISNULL(SchedulingTask,'')*/
	
	DECLARE Cur CURSOR FAST_FORWARD FOR
	--SELECT 
	--	wo.WorkorderId, wo.WorkOrderNumber, wo.StartDate, wo.WONumber, wo.AMTParentWorkOrderId,
	--	ISNULL(wop.WorkorderId,wo.WorkOrderId) as AMTParentWorkOrderId, wop.WorkOrderNumber, wop.StartDate
	SELECT 
		wo.WorkorderId, wo.AMTParentWorkOrderId, ISNULL(wop.WorkorderId,wo.WorkOrderId) as pAMTParentWorkOrderId
		--,ISNULL(wo.ArchivedWorkOrder,0) as ArchivedWorkOrder
	FROM tblWorkOrders wo 
		LEFT JOIN tblWorkOrders wopc ON wo.AMTParentWorkOrderId = wopc.WorkorderId
		LEFT JOIN tblWorkOrders wop ON wo.PureWONumber = wop.PureWONumber 
						AND ISNULL(wo.CurrentWorkOrder,0) = ISNULL(wop.CurrentWorkOrder,0)
						--AND ISNULL(wo.ArchivedWorkOrder,0) = ISNULL(wop.ArchivedWorkOrder,0)
			AND ISNULL(wo.SchedulingTask,'')=ISNULL(wop.SchedulingTask,'')
			AND (
			     (
			      ( wop.StartDate=
					(SELECT MAX(StartDate)
					FROM tblWorkOrders wop2 
					WHERE ISNULL(SchedulingTask,'')<>'' -- Strategy WO
					GROUP BY wop2.PureWONumber
					HAVING wop.PureWONumber = wop2.PureWONumber)
					/*VV 23-Mar-2009*/
				AND 
				wop.WorkOrderId=
				(SELECT MAX(WorkOrderId) FROM tblWorkOrders w1
				WHERE ISNULL(w1.SchedulingTask,'')<>'' -- Strategy WO
					and wop.PureWONumber = w1.PureWONumber
					and w1.StartDate=(SELECT MAX(StartDate)
					FROM tblWorkOrders wop2 
					WHERE ISNULL(SchedulingTask,'')<>'' -- Strategy WO
					GROUP BY wop2.PureWONumber
					HAVING wop.PureWONumber = wop2.PureWONumber)
					GROUP BY PureWONumber)
				AND
				NOT EXISTS(SELECT PureWONumber
					FROM tblWorkOrders wop2 
					WHERE (Reviewed<>0 -- Reviewed & parent for itself -> this is the parent
						AND wop2.WorkorderId=wop2.AMTParentWorkOrderId)
						AND ISNULL(SchedulingTask,'')<>'' -- Strategy WO
					GROUP BY wop2.PureWONumber
					HAVING wop.PureWONumber = wop2.PureWONumber)
			      )
			      OR
	                      ( wop.WorkorderId=
					(SELECT MAX(WorkorderId)
					FROM tblWorkOrders wop2 
					WHERE (Reviewed<>0 -- Reviewed & parent for itself -> this is the parent
						AND wop2.WorkorderId=wop2.AMTParentWorkOrderId)
						AND ISNULL(SchedulingTask,'')<>'' -- Strategy WO
					GROUP BY wop2.PureWONumber
					HAVING wop.PureWONumber = wop2.PureWONumber)
	                      )
			     )
			     OR -- Not Strategy WO (SchedulingTask='')
			     (
	                      ( -- not reviewed and inside the range
				wop.StartDate=
					(SELECT MAX(StartDate)
					FROM tblWorkOrders wop2 
					WHERE ISNULL(SchedulingTask,'')='' -- Not Strategy WO
					GROUP BY wop2.PureWONumber
					HAVING wop.PureWONumber = wop2.PureWONumber)
				/*VV 23-Mar-2009*/
				AND 
				wop.WorkOrderId=
				(SELECT MAX(WorkOrderId) FROM tblWorkOrders w1
				WHERE ISNULL(w1.SchedulingTask,'')='' -- Not Strategy WO
					and wop.PureWONumber = w1.PureWONumber
					and w1.StartDate=(SELECT MAX(StartDate)
					FROM tblWorkOrders wop2 
					WHERE ISNULL(SchedulingTask,'')='' -- Not Strategy WO
					GROUP BY wop2.PureWONumber
					HAVING wop.PureWONumber = wop2.PureWONumber)
					GROUP BY PureWONumber)
				AND
				@MergeDateRange>=
					(SELECT ABS(DATEDIFF(Month, MIN(StartDate), MAX(AMTStartDate)))
					FROM tblWorkOrders wop2 
					GROUP BY wop2.PureWONumber
					HAVING wop.PureWONumber = wop2.PureWONumber)
				AND
				NOT EXISTS(SELECT PureWONumber
					FROM tblWorkOrders wop2 
					WHERE (Reviewed<>0 -- Reviewed & parent for itself -> this is the parent
						AND wop2.WorkorderId=wop2.AMTParentWorkOrderId)
						AND ISNULL(SchedulingTask,'')='' -- Not Strategy WO
					GROUP BY wop2.PureWONumber
					HAVING wop.PureWONumber = wop2.PureWONumber)
	                      )
			      OR
	                      ( -- if parent is reviewed and inside the range -> the reviewed parent WO is the parent
				wop.WorkorderId=
					(SELECT MAX(WorkorderId)
					FROM tblWorkOrders wop2 
					WHERE (Reviewed<>0 -- Reviewed & parent for itself -> this is the parent
						AND wop2.WorkorderId=wop2.AMTParentWorkOrderId)
						AND ISNULL(SchedulingTask,'')='' -- Not Strategy WO
					GROUP BY wop2.PureWONumber
					HAVING wop.PureWONumber = wop2.PureWONumber)
				AND
				@MergeDateRange>=
					(SELECT ABS(DATEDIFF(Month, MIN(StartDate), MAX(AMTStartDate)))
					FROM tblWorkOrders wop2 
					GROUP BY wop2.PureWONumber
					HAVING wop.PureWONumber = wop2.PureWONumber)
	                      )
			     )
			    )
	WHERE (wopc.Reviewed=0 OR wopc.WorkorderId<>wopc.AMTParentWorkOrderId) -- do not change relation if the Parent WO is reviewed (the parent WO should be the parent for itself)
		AND wo.AMTParentWorkOrderId<>ISNULL(wop.WorkorderId,wo.WorkOrderId)
		AND ISNULL(wo.CurrentWorkOrder,0)<>0
		AND wo.PureWONumber NOT IN ( -- If any parent is from another group do not automerge any WO in the group
				SELECT	wo3.PureWONumber
				FROM	tblWorkOrders wo3
					LEFT JOIN tblWorkOrders wopc3 ON wo3.AMTParentWorkOrderId = wopc3.WorkorderId
				WHERE	wopc3.PureWONumber <> wo3.PureWONumber
				GROUP BY wo3.PureWONumber
				HAVING COUNT(DISTINCT wopc3.WorkorderId) > 0 )

-- 	OPEN Cur
-- 	FETCH NEXT FROM Cur INTO @cWOID, @cParentWOID, @pParentWOID, @ArchivedWorkOrder
-- 	WHILE @@FETCH_STATUS = 0
-- 	BEGIN -- duplicate WO if they are Current and Archived
-- 		IF @ArchivedWorkOrder = 1
-- 		BEGIN
-- 			EXEC 	usp_DuplicateWorkOrder
-- 					@piWorkOrderId = @cParentWOID,
-- 					@piNewWorkOrderId = @DupWorkorderID OUTPUT
-- 			SET @cParentWOID = @DupWorkorderID
-- 		
-- 			EXEC 	usp_DuplicateWorkOrder
-- 					@piWorkOrderId = @pParentWOID,
-- 					@piNewWorkOrderId = @DupWorkorderID OUTPUT
-- 			SET @pParentWOID = @DupWorkorderID
-- 		
-- 			EXEC	usp_Set_Work_Order_Unlinked
-- 				@WorkOrderId = @pParentWOID
-- 		END
-- 		FETCH NEXT FROM Cur INTO @cWOID, @cParentWOID, @pParentWOID, @ArchivedWorkOrder
-- 	END
-- 	CLOSE Cur

	OPEN Cur
	FETCH NEXT FROM Cur INTO @cWOID, @cParentWOID, @pParentWOID--, @ArchivedWorkOrder
	WHILE @@FETCH_STATUS = 0
	BEGIN -- Update the relations for Current WOs
	
		UPDATE	tblWorkOrders
		SET	AMTParentWorkOrderId = @pParentWOID
		WHERE	WorkorderId = @cWOID
			AND AMTParentWorkOrderId <> @pParentWOID
	/*
	--ID Commented (19-Sep-2006)
		EXEC	usp_Set_Work_Order_Unlinked
			@WorkOrderId = @pParentWOID
	*/
		FETCH NEXT FROM Cur INTO @cWOID, @cParentWOID, @pParentWOID--, @ArchivedWorkOrder
	END
	CLOSE Cur

	DEALLOCATE Cur

END


----------------------------------------------------------------------------------------

-- 7. If there were any tasks linked to work orders which became children, relink the tasks
--24-Mar-2004 V Vasylyeva
--If there were any tasks linked to work orders which became children,
--relink the tasks
EXEC TASK_WO_PARENT_RELINK_P


--************************************************************
-- 8. Merging rules for Merchand (It is executed only if the Merchand merging rule is set)
--24-Mar-2005 DS
--Special Merchand 'merging' rules patch
IF @Merging_Rule=1
BEGIN
	--make sure the 'work order number' is stored in work_order_number_external
	update tblworkorders set work_order_number_External = RIGHT(LEFT(WorkOrderNumber, 2 + 10), 10)
	WHERE
		(AMTParentWorkOrderId = WorkOrderId) AND (LEFT(RIGHT(LEFT(WorkOrderNumber, 2 + 10), 10), 4) = 'CTMS') 
		AND work_order_number_External <> RIGHT(LEFT(WorkOrderNumber, 2 + 10), 10)
	
	DECLARE MerchandStrategy CURSOR READ_ONLY FOR
		SELECT     WorkOrderId, WONumber, EqpPlanId
		FROM       MERCHAND_STRATEGY_WO_V
		ORDER BY   WorkOrderId
	
	OPEN MerchandStrategy
	FETCH NEXT FROM MerchandStrategy INTO 
	@WorkOrderId, @WorkOrderNumber, @EqpPlanId
	
	WHILE @@Fetch_Status = 0
	BEGIN
	
		SET @NewParentWOId = 0
	
		--find the parent of this work order (already linked to EQS task, with the same 'WO Number' and the lowest 'period')
		SELECT TOP 1
			@NewParentWOId = WorkOrderId
		FROM
			MERCHAND_STRATEGY_WO_PARENT_V 
		WHERE
			EqpPlanId = @EqpPlanId
		AND	Work_Order_Number_External = @WorkOrderNumber
	
		IF ISNULL(@NewParentWOId,0) <> 0
		BEGIN
		/*
		--ID Commented (19-Sep-2006)	
			EXEC	usp_Set_Work_Order_Unlinked
				@WorkOrderId  = @WorkOrderId
		*/
			UPDATE    tblWorkOrders
			SET              AMTParentWorkOrderId = @NewParentWOID 
			WHERE     (WorkOrderId = @WorkOrderId)
				AND AMTParentWorkOrderId <> @NewParentWOID 
		END
		
		FETCH NEXT FROM MerchandStrategy INTO 
		@WorkOrderId, @WorkOrderNumber, @EqpPlanId
	
	
	END
	
	CLOSE MerchandStrategy
	DEALLOCATE MerchandStrategy
END


RETURN

GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[PARTS_FILTERED_GET_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[PARTS_FILTERED_GET_P]
GO

create          Procedure [dbo].[PARTS_FILTERED_GET_P]  
/******************************************************************************  
 File: amt_3_sp.sql.sql  
 Name: PARTS_FILTERED_GET_P  
  
 Called By:   
  
 Desc: 1. Get data set ffrom tblParts table or ROTABLE_PART  
               
  
 Auth: Harpreet Singh  
 Date: 03-Sep-2003  
*******************************************************************************  
  Change History  
*******************************************************************************  
 Date:  Author:  Description:  
 -------- -------- ----------------------------------------  
    24 Nov 03   ML          Put Distinct in Select statement  
 13 Feb 08 V Vasylyeva Added Reman_Part_Number  
  9 Apr 08 V Vasylyeva Changed input parameter from @ModelID varchar(8000) = '5' to @ModelID varchar(8000) = ''  
 11 Jun 08 V Vasylyeva Added @NoneId  
 27 May 09 AL   CR8179: Added @InProjTaskOnly  
 17 Feb 11 V Vasylyeva AmtMobile: Added @ShowCode  
 20 Aug 11	V Vasylyeva	E602 added @Show_SOS
 26 Sep 11	V vasylyeva	E637 Added @SourceOfSupplyId,@ShowPartType,@ShowPartDescription
 10 Apr 11	V Vasylyeva	E775 @ShowPartPrice
*******************************************************************************/  
 /* Param List */  
  
      
	@SearchText varchar(50) = '%%',  
	@ModelID varchar(8000) = '',  
	@RotablePart bit = 1,  
	@Reman bit = 1,  
	@NoneId int=NULL,  
	@InProjTaskOnly bit=0, --AL: 27/05/09  
	@ShowCode bit=0/*VV AmtMobile*/ ,
	@Show_SOS bit=0/*VV E602*/ ,
	/*VV E637*/
	@ShowPartDescription bit=0,
	@ShowPartType bit=0,
	@SourceOfSupplyId varchar(max)='',
	/*VV E775*/
	@ShowPartPrice bit=0
 
AS  
   
 DECLARE @SQL as varchar(8000)  
 /*VV E637*/
IF @SourceOfSupplyId ='0' SET @SourceOfSupplyId=''

/*VV E775*/
DECLARE @CurrencyId int, @PriceGroupId int
SELECT @CurrencyId=CurrencyId FROm tblCurrencies WHERE PrimaryCurr<>0
SELECT @PriceGroupId=Price_Group_ID FROM PRICE_GROUP WHERE DefaultValue=1

  
 IF ISNULL(@RotablePart,1) = 0   
 BEGIN  
  IF ISNULL(@InProjTaskOnly,0)=0  
  BEGIN  
     
	   SET @SQL = ' SELECT P.PartId Id, P.Part + '' '' + P.PartDescription Description, '''' GroupNumber, '''' Supplier'  
	   SET @SQL = @SQL+CASE @ShowCode WHEN 1 THEN ',Part' ELSE '' END  
	   /*VV E602*/
	   SET @SQL = @SQL+CASE @Show_SOS WHEN 1 THEN ',S.Sos_Code AS Part_SOS' ELSE '' END 
	   /*VV E637*/
	   SET @SQL = @SQL+CASE @ShowPartType WHEN 1 THEN ',PTY.PartType AS Part_Type' ELSE '' END 
	   SET @SQL = @SQL+CASE @ShowPartDescription WHEN 1 THEN ',P.PartDescription AS Part_Description' ELSE '' END 
	   /*VV E775*/
	   SET @SQL = @SQL+CASE @ShowPartPrice WHEN 1 THEN ',PP.Part_Sell AS DefaultPartPrice' ELSE '' END 

	   SET @SQL = @SQL + ' FROM tblParts P'  
	   IF @Show_SOS=1
	   BEGIN
			SET @SQL = @SQL +' INNER JOIN SOURCE_OF_SUPPLY S ON P.Source_Of_Supply_Id=S.Source_Of_Supply_Id '
	   END
	   
	    /*VV E637*/
	   IF @ShowPartType=1
	   BEGIN
		SET @SQL = @SQL +' INNER JOIN tblPartTypes PTY ON P.Part_Type_ID=PTY.PartTypeId '
	   END
	   
	   /*VV E775*/
	   IF @ShowPartPrice=1
	   BEGIN
			SET @SQL=@SQL+' LEFT JOIN tblPartPrices PP ON P.PartId=PP.PartId 
			AND PP.CurrencyId='+CAST(@CurrencyId AS varchar(50))+' AND PP.Price_Group_ID='+CAST(@PriceGroupId AS varchar(50))
	   END
	   
	   SET @SQL = @SQL + ' WHERE P.Part + '' '' + P.PartDescription LIKE ' + CHAR(39) + @SearchText + CHAR(39) 
	   /*VV E637*/
	   IF @SourceOfSupplyId<>''  
	   BEGIN
			
			SET @SQL = @SQL +' AND P.Source_Of_Supply_Id IN('+@SourceOfSupplyId+')'
	   END
 
  END  
  ELSE  
  BEGIN  
  
   SET @SQL = ' SELECT PartId Id, Part + '' '' + PartDescription Description, '''' GroupNumber, '''' Supplier'  
   SET @SQL = @SQL + ' FROM tblParts P INNER JOIN tblProjTasks PT ON P.PartId = PT.Part_Id'  
   SET @SQL = @SQL + ' WHERE Part + '' '' + PartDescription LIKE ' + CHAR(39) + @SearchText + CHAR(39)   
    
  END  
  
  IF @NoneId IS NOT NULL  
  BEGIN  
   SET @SQL = @SQL +' UNION  
       SELECT  '+CAST (@NoneId AS varchar)+' AS Id, ''(NONE) ''  AS Description, '''' GroupNumber, '''' Supplier'  
  END  
  
  SET @SQL = @SQL + ' ORDER BY Part + '' '' + PartDescription'  
  
 END  
 ELSE  
  BEGIN  
   SET @SQL = ' SELECT DISTINCT r.Rotable_Part_Id AS Id,   
      r.Part_Number + '' '' + r.Part_Description + '' ('' + cc.Code + '' '' + cc.Description + '')'' AS Description,   
      r.Group_Number GroupNumber, m.ManufacturerDesc Supplier,r.Reman_Part_Number'  
   SET @SQL = @SQL + ' FROM ROTABLE_PART r INNER JOIN  
                      ROTABLE_PART_MODEL rm ON r.Rotable_Part_Id = rm.Rotable_Part_Id INNER JOIN  
                      tblComponentCodes cc ON r.Component_Code_Id = cc.ComponentCodeID LEFT OUTER JOIN  
                      tblManufacturers m ON r.Manufacturer_Id = m.ManufacturerId'  
   SET @SQL = @SQL + ' WHERE r.Part_Number + '' '' + r.Part_Description + '' ('' + cc.Code + '' '' + cc.Description + '')'' LIKE ' + CHAR(39) + @SearchText + CHAR(39)   
   IF @Reman = 1 SET @SQL = @SQL + ' AND r.Reman_Part_Number <> '''''  
   IF ISNULL(@ModelID,'') <> ''  SET @SQL = @SQL + ' AND rm.Model_Id IN (' + @ModelID + ')'  
   SET @SQL = @SQL + ' ORDER BY r.Part_Number + '' '' + r.Part_Description + '' ('' + cc.Code + '' '' + cc.Description + '')'''  
  END  
   
 --Print(@SQL)  
 EXEC(@SQL)  
    
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[INVENTORY_PART_GET_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[INVENTORY_PART_GET_P]
GO

create Procedure [dbo].[INVENTORY_PART_GET_P]
/******************************************************************************
	Name: INVENTORY_PART_GET_P

	Called By: 

	Desc: Gets data for Inventory Parts
             

	Auth: Veronika Vasylyeva
	Date: 23-Sep-2011
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
    5-Apr-12	V Vasylyeva	E775 Inventory Parts	
*******************************************************************************/
	/* Param List */

@BranchId varchar(max)='',
@SourceOfSupplyId varchar(max)='',
@PartTypeId varchar(max)='',
@PartId varchar(max)='',
@PartDescription varchar(max)='',
@MinQtyOnHand varchar(max)='',
@Defaults bit=0

AS

SET @PartDescription='%'+ISNULL(@PartDescription,'')+'%'
DECLARE @QtyOnHand float,/*VV E775*/@CurrencyId int, @PriceGroupId int

SET @QtyOnHand=0
SELECT @CurrencyId=CurrencyId FROm tblCurrencies WHERE PrimaryCurr<>0
SELECT @PriceGroupId=Price_Group_ID FROM PRICE_GROUP WHERE DefaultValue=1

IF ISNUMERIC(@MinQtyOnHand)=1 SET @QtyOnHand=CAST(@MinQtyOnHand AS float)

SELECT B.Branch,SOS.Sos_Code+' - '+SOS.Sos_Description AS SourceOfSupply,
P.Part AS Part_Number,P.PartDescription AS Part_Description,I.QtyOnHand AS Qty_On_Hand,
I.QtyOnOrder AS Qty_On_Order,
/*VV E775*/
I.QtyBeingRebuilt AS Qty_Being_Rebuilt,S.Site AS Rebuild_Site,PP.Part_Sell AS DefaultPartPrice,
(I.QtyOnHand+I.QtyBeingRebuilt)*PP.Part_Sell AS TotalDefaultPrice,I.Location,I.Comments,
I.ExpectedDeliveryDate AS ExpectedDeliveryDate_D,
I.UniqueKey AS External_Identifier,I.LastModDate,

I.BranchId,I.PartId,
I.InventoryPartId,SOS.Sos_Code AS Part_SOS,SOS.Source_Of_Supply_ID,PT.PartType AS Part_Type,
/*VV E775*/I.RebuildSiteId
FROM
INVENTORY_PART I
	INNER JOIN
tblBranches B
	ON I.BranchId=B.BranchId
	INNER JOIN
tblParts P
	ON I.PartId=P.PartId
	INNER JOIN
SOURCE_OF_SUPPLY SOS
	ON P.Source_Of_Supply_ID=SOS.Source_Of_Supply_ID
	INNER JOIN
tblPartTypes PT
	ON P.Part_Type_ID=PT.PartTypeId
	LEFT JOIN
tblPartPrices PP
	ON P.PartId=PP.PartId
	AND PP.CurrencyId=@CurrencyId
	AND PP.Price_Group_ID=@PriceGroupId
	LEFT JOIN
tblSites S
	ON I.RebuildSiteId=S.SiteId
WHERE (@Defaults=0 OR (@Defaults=1 AND I.InventoryPartId<0)) AND
(@BranchId='' OR I.BranchId IN(SELECT list_item FROM dbo.LIST_TO_TABLE_F(@BranchId))) AND
(@SourceOfSupplyId='' OR SOS.Source_Of_Supply_ID IN(SELECT list_item FROM dbo.LIST_TO_TABLE_F(@SourceOfSupplyId))) AND
(@PartTypeId='' OR P.Part_Type_ID IN(SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PartTypeId))) AND
(@PartId='' OR P.PartId IN(SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PartId))) AND
(P.PartDescription LIKE @PartDescription) AND
(I.QtyOnHand>=@QtyOnHand)

GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[INVENTORY_PART_UPDATE_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[INVENTORY_PART_UPDATE_P]
GO

create     Procedure [dbo].[INVENTORY_PART_UPDATE_P]  
/******************************************************************************  
   
 Name: INVENTORY_PART_UPDATE_P  
  
 Called By:   
  
 Desc: Updates,adds, imports Inventory Parts.   
  
  
 Auth: Veronika Vasylyeva  
 Date: 29 Sep 2011  
*******************************************************************************  
  Change History  
*******************************************************************************  
 Date:  Author:  Description:  
 -------- -------- ----------------------------------------  
 11 Apr 12	V Vasylyeva	E775 new fields
 13-Dec-11	V Vasylyeva	Fixed spelling in some messages
*******************************************************************************/  
@UserId int=0,  
@xml xml='',  
@Deleted varchar(max)='', 
@ImportBatchName varchar(2000) = '',  
@RecordsInserted int=0 OUTPUT,  
@RecordsUpdated int=0 OUTPUT,  
@NoErrors int=0 OUTPUT  
  
AS  

SET XACT_ABORT ON
  
DECLARE @hDoc int  
DECLARE @TypeVarchar int  
DECLARE @TypeInt int  
DECLARE @TypeFloat int  
DECLARE @TypeBit int  
DECLARE @TypeDateInt int  
DECLARE @ErrParsing int  
DECLARE @ErrBusinessRules int  
DECLARE @Count int 
DECLARE @ErrCount int  
  
SET @ErrParsing=1  
SET @ErrBusinessRules=3  
  
SET @TypeVarchar =1  
SET @TypeInt =2  
SET @TypeFloat =3  
SET @TypeBit =4  
SET @TypeDateInt =5  
  
SET @ImportBatchName=ISNULL(@ImportBatchName,'')  

CREATE TABLE #z_INVENTORY_PART(
	Line_No int IDENTITY(1,1),
	InventoryPartId int,
	PartId int,
	BranchId int,
	Qty_On_Hand  varchar(1000) COLLATE DATABASE_DEFAULT,
	Qty_On_Order  varchar(1000) COLLATE DATABASE_DEFAULT,
	Expected_Delivery_Date  varchar(1000) COLLATE DATABASE_DEFAULT,
	External_Identifier varchar(1000) COLLATE DATABASE_DEFAULT,
	Branch varchar(1000) COLLATE DATABASE_DEFAULT,
	Part_Number varchar(1000) COLLATE DATABASE_DEFAULT,
	Part_Description varchar(1000) COLLATE DATABASE_DEFAULT,
	Part_SOS varchar(1000) COLLATE DATABASE_DEFAULT,
	Part_Type varchar(1000) COLLATE DATABASE_DEFAULT,
	SourceOfSupplyId int,
	PartTypeId int,
	/*VV E775*/
	Qty_Being_Rebuilt varchar(1000) COLLATE DATABASE_DEFAULT,
	RebuildSiteId int,
	Rebuild_Site varchar(1000) COLLATE DATABASE_DEFAULT,
	Location varchar(1000) COLLATE DATABASE_DEFAULT,
	Comments varchar(2000) COLLATE DATABASE_DEFAULT
	PRIMARY KEY (Line_No))

	
EXEC sp_xml_preparedocument @hDoc OUTPUT, @xml

INSERT INTO #z_INVENTORY_PART(InventoryPartId,PartId,BranchId,Qty_On_Hand,Qty_On_Order,
Expected_Delivery_Date,External_Identifier,Branch,Part_Number,Part_Description,Part_SOS,Part_Type,
/*VV E775*/Qty_Being_Rebuilt,	RebuildSiteId,	Rebuild_Site,Location,Comments)
SELECT
InventoryPartId,PartId,BranchId,Qty_On_Hand,Qty_On_Order,Expected_Delivery_Date,
External_Identifier,Branch,Part_Number,Part_Description,Part_SOS,Part_Type,
/*VV E775*/Qty_Being_Rebuilt,RebuildSiteId,	Rebuild_Site,Location,Comments
FROM  OPENXML (@hDoc,N'/I_INVENTORY_PARTs/I_INVENTORY_PART',2) WITH #z_INVENTORY_PART  

SET @Count=@@ROWCOUNT

EXEC sp_xml_removedocument @hDoc 

SET @NoErrors=0
SET @RecordsInserted=0
SET @RecordsUpdated=0

IF @Count=0 AND ISNULL(@Deleted,'')='' RETURN

CREATE TABLE #z_Message(MessageId int IDENTITY(1,1),Line_No int,
ErrorDescription varchar(5000) COLLATE DATABASE_DEFAULT,  
ErrorType int,External_Identifier varchar(50) COLLATE DATABASE_DEFAULT
PRIMARY KEY(MessageId))  
  
 --Check format of the data for import  
 --(@TypeId int,@FieldName varchar(max), @FieldLen int,@Value varchar(max),@CheckPositive bit)  

/*Check that qty>=0 even if it is not import*/
 INSERT INTO #z_Message(Line_No,ErrorDescription,ErrorType,External_Identifier)  
 SELECT Line_No, 
 dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Branch',50,Branch,0)+  
 dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Part_Number',50,Part_Number,0)+  
 dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'External_Identifier', 50,External_Identifier,0)+ 		  
 dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Part_Description', 50,Part_Description,0)+  
 dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Part_SOS', 50,Part_SOS,0)+		 
 dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Part_Type', 10,Part_Type,0)+
 dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Qty_On_Hand', 0,Qty_On_Hand,1)+
 dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Qty_On_Order', 0,Qty_On_Order,1)+
 dbo.CHECK_IMPORT_DATA_F(@TypeDateInt,'Expected_Delivery_Date', 0,Expected_Delivery_Date,0)+
 /*VV E775*/
 dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Qty_Being_Rebuilt', 0,Qty_Being_Rebuilt,1)+
 dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Rebuild_Site', 50,Rebuild_Site,0)+
 dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Location', 1000,Location,0)+
 dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Comments', 2000,Comments,0)

 AS ErrorDescription, 
 @ErrParsing AS ErrorType,External_Identifier  
 FROM  
 #z_INVENTORY_PART  

 DELETE #z_Message WHERE ErrorDescription=''  
  
 IF EXISTS(SELECT Line_No FROM #z_Message)  
 BEGIN  
	DELETE #z_INVENTORY_PART WHERE External_Identifier IN(SELECT External_Identifier FROM #z_Message)  
 END 
 
 
INSERT INTO #z_Message(Line_No,ErrorDescription,ErrorType,External_Identifier)  
SELECT Line_No, 'Duplicate External Identifiers' AS ErrorDescription,
@ErrBusinessRules,External_Identifier
FROM #z_INVENTORY_PART WHERE External_Identifier 
IN (SELECT External_Identifier FROM #z_INVENTORY_PART GROUP BY External_Identifier HAVING COUNT(*)>1)
	
IF @@ROWCOUNT>0 DELETE #z_INVENTORY_PART WHERE Line_No IN(SELECT Line_No FROM #z_Message)  
		 
/*For import*/  
IF ISNULL(@ImportBatchName,'')<>''  
BEGIN  

	UPDATE Z SET 
	Z.BranchId=B.BranchId,Z.PartId=P.PartId,Z.InventoryPartId=I.InventoryPartId,
	Z.SourceOfSupplyId=SOS.Source_Of_Supply_ID,Z.PartTypeId=PT.PartTypeId,
	/*VV E775*/Z.RebuildSiteId=S.SiteId
	FROM
	#z_INVENTORY_PART Z
		LEFT JOIN
	tblBranches B
		ON Z.Branch=B.Branch
		LEFT JOIN
	(SELECT P1.PartId, P1.Part,SOS.Sos_Code
	FROM
	tblParts P1
		INNER JOIN
	SOURCE_OF_SUPPLY SOS
		ON P1.Source_Of_Supply_ID=SOS.Source_Of_Supply_ID) P
		ON Z.Part_Number=P.Part 
		AND Z.Part_SOS=P.Sos_Code
		LEFT JOIN
	INVENTORY_PART I
		ON Z.External_Identifier=I.UniqueKey
		LEFT JOIN
	SOURCE_OF_SUPPLY SOS
		ON Z.Part_SOS=SOS.Sos_Code
		LEFT JOIN
	tblPartTypes PT
		ON Z.Part_Type=PT.PartType
		/*VV E775*/
		LEFT JOIN
	tblSites S
		ON Z.Rebuild_Site=S.Site
		
		
	
	
	INSERT INTO #z_Message(Line_No,ErrorDescription,ErrorType,External_Identifier)  
	SELECT Line_No, 'External Identifier is required' AS ErrorDescription,
	@ErrBusinessRules,External_Identifier
	FROM #z_INVENTORY_PART WHERE ISNULL(External_Identifier,'')=''
	
	IF @@ROWCOUNT>0 DELETE #z_INVENTORY_PART WHERE Line_No IN(SELECT Line_No FROM #z_Message)  
	
	INSERT INTO #z_Message(Line_No,ErrorDescription,ErrorType,External_Identifier)  
	SELECT Line_No, 'Source of Supply is required' AS ErrorDescription,
	@ErrBusinessRules,External_Identifier
	FROM #z_INVENTORY_PART WHERE PartId IS NULL AND ISNULL(Part_SOS,'')=''
	
	IF @@ROWCOUNT>0 DELETE #z_INVENTORY_PART WHERE Line_No IN(SELECT Line_No FROM #z_Message)  
	
	INSERT INTO #z_Message(Line_No,ErrorDescription,ErrorType,External_Identifier)  
	SELECT Line_No, 'Cannot identify Site' AS ErrorDescription,
	@ErrBusinessRules,External_Identifier
	FROM #z_INVENTORY_PART WHERE ISNULL(RebuildSiteId,0)=0 AND ISNULL(Rebuild_Site,'')<>''
	
	IF @@ROWCOUNT>0 DELETE #z_INVENTORY_PART WHERE Line_No IN(SELECT Line_No FROM #z_Message)  
END
	
/*Check that branch and part are entered*/
INSERT INTO #z_Message(Line_No,ErrorDescription,ErrorType,External_Identifier)  
SELECT Line_No,'Cannot identify Branch' as ErrorDescription,
@ErrBusinessRules AS ErrorType,External_Identifier
FROM #z_INVENTORY_PART Z WHERE ISNULL(BranchId,0)=0

IF @@ROWCOUNT>0 DELETE #z_INVENTORY_PART WHERE Line_No IN(SELECT Line_No FROM #z_Message) 
		
/*Add Parts*/
IF ISNULL(@ImportBatchName,'')<>'' AND EXISTS(SELECT Line_No FROM #z_INVENTORY_PART WHERE ISNULL(PartId,0)=0 AND ISNULL(Part_Number,'')<>'')
BEGIN
	DECLARE @DefPartTypeId int
	SELECT @DefPartTypeId=PartTypeId FROM tblPartTypes WHERE PartTypeDefault<>0 
	
	IF EXISTS(SELECT Line_No FROM #z_INVENTORY_PART WHERE SourceOfSupplyId IS NULL)
	BEGIN
		INSERT INTO SOURCE_OF_SUPPLY
		(Sos_Code, Sos_Description, Last_Mod_By_User_ID, Last_Mod_Date,	Create_By_User_ID, Create_Date)
		SELECT DISTINCT Z.Part_SOS AS Sos_Code, Z.Part_SOS AS Sos_Description, 
		0, GETDATE(), 0, GETDATE()
		FROM 
		#z_INVENTORY_PART Z
			LEFT JOIN 
		SOURCE_OF_SUPPLY SOS
			ON Z.Part_SOS=SOS.Sos_Code
		WHERE Z.Part_SOS IS NOT NULL AND SOS.Sos_Code IS NULL
	END
	
	UPDATE Z SET SourceOfSupplyId=SOS.Source_Of_Supply_ID
	FROM
	#z_INVENTORY_PART Z
		INNER JOIN 
	SOURCE_OF_SUPPLY SOS
		ON Z.Part_SOS=SOS.Sos_Code
	WHERE SourceOfSupplyId IS NULL
	
	CREATE TABLE #z_NewParts(Part_Number varchar(50) COLLATE DATABASE_DEFAULT,
	Part_Description  varchar(50) COLLATE DATABASE_DEFAULT,
	PartTypeId int, SourceOfSupplyId int)
	
	INSERT INTO #z_NewParts(Part_Number,Part_Description,PartTypeId, SourceOfSupplyId)
	SELECT DISTINCT Part_Number,ISNULL(NULLIF(Part_Description,''),Part_Number) AS Part_Description,
	PartTypeId, SourceOfSupplyId
	FROM #z_INVENTORY_PART WHERE PartId IS NULL
	
	INSERT INTO #z_Message(Line_No,ErrorDescription,ErrorType,External_Identifier)  
	SELECT Line_No, 'Duplicate Parts' AS ErrorDescription,
	@ErrBusinessRules,External_Identifier
	FROM 
	#z_INVENTORY_PART WHERE PartId IS NULL AND 
	Part_Number IN(SELECT Part_Number FROM #z_NewParts GROUP BY Part_Number,SourceOfSupplyId
	HAVING COUNT(*)>1)

	IF @@ROWCOUNT>0 
	BEGIN
		DELETE #z_INVENTORY_PART WHERE Line_No IN(SELECT Line_No FROM #z_Message) 
		DELETE #z_NewParts WHERE Part_Number NOT IN(SELECT Part_Number FROM #z_INVENTORY_PART)
	END
	
	IF EXISTS(SELECT * FROM #z_NewParts)
	BEGIN
		
		BEGIN TRANSACTION

		INSERT INTO tblParts
		(Part,PartDescription,Part_Type_Id,Source_Of_Supply_Id)
		SELECT Z.Part_Number AS Part,Z.Part_Description AS PartDescription,
		ISNULL(Z.PartTypeId,@DefPartTypeId) AS Part_Type_Id,
		Z.SourceOfSupplyId AS Source_Of_Supply_Id
		FROM #z_NewParts Z
			
		/*Insert part prices with 1 for price*/
		INSERT INTO tblPartPrices
		(PartId,CurrencyId,Part_Sell,Full_Credit_Sell,Partial_Credit_Sell,Price_Group_ID,
		LastModByUserId,LastModDate,CreateByUserId,CreateDate,Part_Cost,Full_Credit_Cost,
		Partial_Credit_Cost)
		SELECT P.PartId,C.CurrencyId,C.ExRate/*instead of 1*C.ExRate*/ AS Part_Sell,
		C.ExRate AS Full_Credit_Sell,C.ExRate AS Partial_Credit_Sell,
		PG.Price_Group_ID,	0 AS LastModByUserId,GETDATE() AS LastModDate,0 AS CreateByUserId,
		GETDATE() AS CreateDate,C.ExRate AS Part_Cost,C.ExRate AS Full_Credit_Cost,
		1 AS Partial_Credit_Cost
		FROM
		tblParts P
			INNER JOIN
		#z_NewParts Z
			ON P.Part=Z.Part_Number AND P.Source_Of_Supply_Id=Z.SourceOfSupplyId
			CROSS JOIN
		(SELECT C1.CurrencyID,E.ExRate FROM 
		tblCurrencies C1
			INNER JOIN
		tblExRateCurrencies E
			ON C1.CurrencyID=E.CurrencyID
			AND E.ExRateID=0
			) C
			CROSS JOIN
		PRICE_GROUP PG
	
		COMMIT TRANSACTION
		
		DROP TABLE #z_NewParts
		
		UPDATE Z SET PartId=P.PartId
		FROM
		#z_INVENTORY_PART Z
			INNER JOIN
		tblParts P
			ON Z.Part_Number=P.Part
			AND Z.SourceOfSupplyId=P.Source_Of_Supply_ID
		WHERE Z.PartId IS NULL
	END
END
	
INSERT INTO #z_Message(Line_No,ErrorDescription,ErrorType,External_Identifier)  
SELECT Line_No,'Cannot identify Part' as ErrorDescription,
@ErrBusinessRules AS ErrorType,External_Identifier
FROM #z_INVENTORY_PART Z WHERE ISNULL(PartId,0)=0	
	
IF @@ROWCOUNT>0 DELETE #z_INVENTORY_PART WHERE Line_No IN(SELECT Line_No FROM #z_Message) 


/*Delete records*/
IF @Deleted<>'' DELETE INVENTORY_PART WHERE InventoryPartId IN(SELECT list_item FROM dbo.LIST_TO_TABLE_F(@Deleted))

IF EXISTS(SELECT InventoryPartId FROM #z_INVENTORY_PART WHERE InventoryPartId>0)
BEGIN
	UPDATE I SET
	PartId=Z.PartId,BranchId=Z.BranchId,
	QtyOnHand=CAST(ISNULL(NULLIF(Z.Qty_On_Hand,''),'0') AS float),
	QtyOnOrder=CAST(ISNULL(NULLIF(Z.Qty_On_Order,''),'0') AS float),
	ExpectedDeliveryDate=CAST(NULLIF(Z.Expected_Delivery_Date,'') AS datetime),
	LastModDate=GETDATE(),
	LastModUserId=@UserId,
	/*VV E775*/
	QtyBeingRebuilt=CAST(ISNULL(NULLIF(Z.Qty_Being_Rebuilt,''),'0') AS float),
	RebuildSiteId=NULLIF(Z.RebuildSiteId,0),
	Location=NULLIF(Z.Location,''),
	Comments=NULLIF(Z.Comments,'')
	FROM
	#z_INVENTORY_PART Z
		INNER JOIN
	INVENTORY_PART I
		ON Z.InventoryPartId=I.InventoryPartId
		
	SET @RecordsUpdated=@@ROWCOUNT

END


IF EXISTS(SELECT InventoryPartId FROM #z_INVENTORY_PART WHERE ISNULL(InventoryPartId,0)<=0)
BEGIN
	INSERT INTO INVENTORY_PART(PartId,BranchId,QtyOnHand,QtyOnOrder,ExpectedDeliveryDate,
	UniqueKey, CreateDate,CreateUserId,LastModDate,LastModUserId,
	/*VV E775*/QtyBeingRebuilt,RebuildSiteId,Location,Comments)
	SELECT
	PartId,BranchId,
	CAST(ISNULL(NULLIF(Qty_On_Hand,''),'0') AS float) AS QtyOnHand,
	CAST(ISNULL(NULLIF(Qty_On_Order,''),'0') AS float) AS QtyOnOrder,
	CAST(NULLIF(Expected_Delivery_Date,'') AS datetime) AS ExpectedDeliveryDate,
	ISNULL(NULLIF(External_Identifier,''),NEWID()) AS UniqueKey,
	GETDATE() AS CreateDate,@UserId AS CreateUserId,GETDATE() AS LastModDate,@UserId AS LastModUserId,
	/*VV E775*/
	CAST(ISNULL(NULLIF(Qty_Being_Rebuilt,''),'0') AS float) AS QtyBeingRebuilt,
	NULLIF(RebuildSiteId,0) AS RebuildSiteId,	NULLIF(Location,'') AS Location,
	NULLIF(Comments,'') AS Comments
	FROM #z_INVENTORY_PART WHERE ISNULL(InventoryPartId,0)<=0
		
	SET @RecordsInserted=@@ROWCOUNT

END


FINISH:  
  
IF @ImportBatchName<>''  
BEGIN 
	SET @NoErrors=0 
	IF @Count>0 SET @NoErrors=@NoErrors+@Count-(SELECT COUNT(*) FROM #z_INVENTORY_PART)  
	SET @NoErrors=ISNULL(@NoErrors,0)  

	IF EXISTS(SELECT ImportFileName FROM IMPORT_ERROR WHERE ImportFileName=@ImportBatchName)  
	BEGIN  
		DELETE IMPORT_ERROR WHERE ImportFileName=@ImportBatchName  
	END  

	IF EXISTS(SELECT MessageId FROM #z_Message)  
	BEGIN  
		INSERT INTO IMPORT_ERROR(ImportFileName,Line_No,ErrorDescription,ImportErrorTypeId,LastModDate)  
		SELECT @ImportBatchName AS ImportFileName,Line_No,ErrorDescription,  
		ISNULL(ErrorType,@ErrBusinessRules) AS ImportErrorTypeId,   
		GETDATE() AS LastModDate  
		FROM #z_Message  
	END  
END 
ELSE
BEGIN
	IF EXISTS(SELECT * FROM #z_Message)
		SELECT External_Identifier,ErrorDescription FROM #z_Message
		ORDER BY Line_No
END
 
DROP TABLE  #z_INVENTORY_PART, #z_Message  


GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[RPT_DAILY_DOWNTIME_LOG_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[RPT_DAILY_DOWNTIME_LOG_P]
GO

create        Procedure  RPT_DAILY_DOWNTIME_LOG_P
/******************************************************************************
	File: RPT_DAILY_DOWNTIME_LOG_P.sql
	Name:RPT_DAILY_DOWNTIME_LOG_P

	Called By: 

	Desc: 1.
             

	Auth: Thy Rith
	Date: 14-OCT-2002
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	-------		----------------------------------------
	01 May 12	KN			E809: Fixed the calculation of Downtime.
	26 Apr 12   GD          Fixed 4056 Calculate  Var AS PlanDT-ActualDT rather than getting from view
	10 Apr 12   TW			#3908 set correct order for the report
	16 Mar 12	KN			E727 Fixed Empty Rows
	08 Mar 12	KN&Joel		E727: Added Notes Field
	17 Oct 03	HS			changed to return actual down time and actual up time relative to start and end date
	30 May 03	HS			Fixed bugs
	14 Apr 03	ML			Change Fleet And EqpPlan to multi select, Added Em Issue
	21-Sep-09	TAS			CR8389: Added UserID
	20 Nov 09	TAS			Added @BranchId against Issue#8450
	17 Aug 10	VV			#245 New Shift Downtime Log report
*******************************************************************************/
	/* Param List */

    @SiteID int =2 ,
    @FleetID varchar(MAX) = '',
    @EqpPlanID varchar(MAX) = '',
    @RespID varchar(MAX) = '',
    @ModelID varchar(MAX) = '',
    @TaskTypeID varchar(MAX) = '',
	@EMIssueId varchar(MAX) = '',
    @StartDate datetime = 'Aug 16 2003 12:00:00:000AM',
    @EndDate datetime = 'Aug 17 2003 12:00:00:000AM',
	@UserId INT=0,
	@BranchId varchar(MAX) = '',
	/*VV #245*/
	@ShiftStart bit=1

AS

SET NOCOUNT ON

DECLARE @sSQL as varchar(MAX)

	Declare @tmpFleetId varchar(MAX)
	Declare @tmpEqpPlanId varchar(MAX)

	if charindex(',',@FleetId) > 1 set @tmpFleetId = '0' else set @tmpFleetId = @FleetId
	if charindex(',',@EqpPlanId) > 1 set @tmpEqpPlanId = '0' else set @tmpEqpPlanId = @EqpPlanId

	--*******************************************
	--Change Start
	--Tas 21-Sep-09
	SET @UserId=ISNULL(@UserId,0)
	DECLARE @Level int
	SELECT @Level=User_Access_Level_Id From USER_LEVEL_PERMISSION where AMT_User_Id = @UserId
	SET @Level=ISNULL(@Level,0)
		/*
		0 -ALL
		1-Branch,
		2-Site
		*/
	--Change End
	--*******************************************
	
	/*GET SHIFT START TIME */
	/*VV #245*/ 
	IF @ShiftStart=1
	BEGIN
		EXEC RPT_GET_SHIFT_START_TIME_P @SiteID, @tmpFleetId, 0, @tmpEqpPlanId,  0, @StartDate OUTPUT, @EndDate OUTPUT
	END


	/* Event Details*/
	SET @sSQL = ' SELECT GroupBy,EventID,EquipPlan,Model,Description,[Plan],BreakDown, [DownDate],[UpDate], '
	SET @sSQL =  @sSQL + ' CASE WHEN Primary_DTA = 1 THEN [DownHours] ELSE 0 END DownHours,Cause,Activity,Resp,ROUND(CASE WHEN PlanDTC < 0 THEN 0 ELSE PlanDTC END,2) AS PlanDT,ROUND(ActualDT,2) AS ActualDT, '
	SET @sSQL =  @sSQL + ' ROUND(PlanDTC-ActualDT,2) AS Var,VarianceCause,Notes ,Sort_Order '
	
	SET @sSQL =  @sSQL + ' FROM (SELECT GroupBy, EventID, EquipPlan, Model, Description, [Plan], BreakDown,'

	 
	SET @sSQL = @sSQL + ' (case when downdate < ' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' Else downdate End) AS [DownDate],'
	SET @sSQL = @sSQL + ' (case when ActualUpDate > ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' Else ActualUpDate End) AS [UpDate], '
	SET @sSQL = @sSQL + ' ((CONVERT(float,(case when ActualUpDate > ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' Else ActualUpDate End)) - '
	SET @sSQL = @sSQL + ' CONVERT(float,(case when downdate < ' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' Else downdate End))) *24) AS [DownHours],'

	IF @RespId = '' 
	   BEGIN
		SET @sSQL =  @sSQL + ' Cause,  '
		SET @sSQL =  @sSQL + ' Activity,  '
		SET @sSQL =  @sSQL + ' Resp,  '
		--SET @sSQL = @sSQL + ' ((CONVERT(float,case when ActualUpDate > ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' Else ActualUpDate End) - '
		--SET @sSQL = @sSQL + ' CONVERT(float,case when downdate < ' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' Else downdate End))/(Convert(float, ActualUpDate)- CONVERT(float, downdate)))  * PlanDT as PlanDT, '
		
		--SET @sSQL = @sSQL + ' (((ActualDT/((Convert(float, ActualUpDate)- CONVERT(float, downdate)) * 24))) * ((CONVERT(float,(case when ActualUpDate > ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' Else ActualUpDate End)) - '
		--SET @sSQL = @sSQL + ' CONVERT(float,(case when downdate < ' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' Else downdate End))) *24)) as ActualDT,'
		SET @sSQL = @sSQL + ' ((CONVERT(float,case when DTAUpdate > ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' Else DTAUpdate End) - '
		SET @sSQL = @sSQL + ' CONVERT(float,case when DTADownDate < ' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' Else DTADownDate End))/(Convert(float, DTAUpdate)- CONVERT(float, DTADownDate)))  * PlanDT as PlanDTC, '
		
		SET @sSQL = @sSQL + ' CASE WHEN  '
		SET @sSQL = @sSQL + ' ((CONVERT(FLOAT,(CASE WHEN DTAUpdate > ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' Else DTAUpdate End))- CONVERT(FLOAT,(case when DTADownDate < '+ CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' then '+ CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' Else DTADownDate End))) *24) < 0 '
		SET @sSQL = @sSQL + ' THEN 0 ELSE '
		SET @sSQL = @sSQL + ' (CONVERT(FLOAT,(CASE WHEN DTAUpdate > ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' Else DTAUpdate End))- CONVERT(FLOAT,(case when DTADownDate < '+ CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' then '+ CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' Else DTADownDate End))) *24 '
		SET @sSQL = @sSQL + ' END as ActualDT  ,'
		
		SET @sSQL =  @sSQL + ' VarianceCause, Notes,Sort_order,Primary_DTA  '
	    END
	ELSE
	    BEGIN
		SET @sSQL =  @sSQL + ' CASE WHEN RespId Not IN (' + @RespId + ') THEN Null ELSE Cause END AS Cause,  '
		SET @sSQL =  @sSQL + ' CASE WHEN RespId Not IN (' + @RespId + ') THEN Null ELSE Activity  END AS Activity,  '
		SET @sSQL =  @sSQL + ' CASE WHEN RespId Not IN (' + @RespId + ') THEN Null ELSE Resp  END AS Resp,  '
		--SET @sSQL = @sSQL + ' CASE WHEN RespId Not IN (' + @RespId + ') THEN Null ELSE ((CONVERT(float,case when ActualUpDate > ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' Else ActualUpDate End) - '
		--SET @sSQL = @sSQL + ' CONVERT(float,case when DownDate < ' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' Else DownDate End))/(Convert(float, ActualUpDate)- CONVERT(float, DownDate)))  * PlanDT END as PlanDT, '
		
		--SET @sSQL = @sSQL + ' CASE WHEN RespId Not IN (' + @RespId + ') THEN Null ELSE (((ActualDT/((Convert(float, ActualUpDate)- CONVERT(float, DownDate)) * 24))) * ((CONVERT(float,(case when ActualUpDate > ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' Else ActualUpDate End)) - '
		--SET @sSQL = @sSQL + ' CONVERT(float,(case when DownDate < ' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' Else DownDate End))) *24)) END as ActualDT,'
		SET @sSQL = @sSQL + ' CASE WHEN RespId Not IN (' + @RespId + ') THEN Null ELSE ((CONVERT(float,case when DTAUpdate > ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' Else DTAUpdate End) - '
		SET @sSQL = @sSQL + ' CONVERT(float,case when DTADownDate < ' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' Else DTADownDate End))/(Convert(float, DTAUpdate)- CONVERT(float, DTADownDate)))  * PlanDT END as PlanDTC, '
		
			
		SET @sSQL = @sSQL + ' CASE WHEN RespId Not IN (' + @RespId + ') THEN Null ELSE (CASE WHEN  '
		SET @sSQL = @sSQL + ' ((CONVERT(FLOAT,(CASE WHEN DTAUpdate > ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' Else DTAUpdate End))- CONVERT(FLOAT,(case when DTADownDate < '+ CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' then '+ CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' Else DTADownDate End))) *24) < 0 '
		SET @sSQL = @sSQL + ' THEN 0 ELSE '
		SET @sSQL = @sSQL + ' (CONVERT(FLOAT,(CASE WHEN DTAUpdate > ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' Else DTAUpdate End))- CONVERT(FLOAT,(case when DTADownDate < '+ CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' then '+ CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' Else DTADownDate End))) *24 '
		SET @sSQL = @sSQL + ' END ) END as ActualDT  ,'
		
		SET @sSQL =  @sSQL + ' CASE WHEN RespId Not IN (' + @RespId + ') THEN Null ELSE VarianceCause END AS VarianceCause,Notes,Sort_order,Primary_DTA  '
	    END

	SET @sSQL = @sSQL + ' FROM RPT_DAILY_DOWNTIME_LOG_DTA_V'


	SET @sSQL = @sSQL + ' WHERE (ActualUpDate > ' + CHAR(39) + CONVERT(varchar, @StartDate,121) + CHAR(39) + ' AND DownDate <' + CHAR(39) + CONVERT(varchar,@EndDate,121) + CHAR(39) + ')'
	--*******************************************
	--Change Start
	--Tas 21-Sep-09
	SET @sSQL = @sSQL + ' AND ('+CAST(@Level AS varchar(50))+'<>1 OR BranchId In (SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = '+CAST(@UserId AS varchar(50))+'))'
	SET @sSQL =@sSQL	+ ' AND ('+CAST(@Level AS varchar(50))+'<>2 OR SiteID IN(SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = '+CAST(@UserId AS varchar(50))+'))'
	
	--Change End
	--*******************************************
	IF @SiteId > 0 SET @sSQL = @sSQL + ' AND SiteId = ' + CONVERT(varchar, @SiteId)
	IF @FleetId <> '' SET @sSQL = @sSQL + 'AND FleetId In (' + @FleetId + ') '
	IF @EqpPlanId <> '' SET @sSQL = @sSQL + 'AND EqpPlanId In (' + @EqpPlanId + ') '
	IF @ModelId <> '' SET @sSQL = @sSQL + 'AND ModelId IN (' +  @ModelId + ') '
	IF @EMIssueId <> '' Set @sSQL = @sSQL + ' AND EMIssueId In ( ' + @EmIssueId + ') '
	IF @TaskTypeId <> ''  SET @sSQL =  @sSQL + 'AND TaskTypeId IN (' + @TaskTypeId + ')'
	IF @BranchId <> ''  SET @sSQL =  @sSQL + 'AND BranchId IN (' + @BranchId + ')'
	

	 

	SET @sSQL = @sSQL + ' ) A WHERE Cause IS NOT NULL AND ActualDT > 0 '
	
	
	 -- #3908
    SET @sSQL = @sSQL + ' ORDER BY Sort_Order, Primary_DTA DESC   '  
  
	 --PRINT (@sSQL)
	
	EXEC (@sSQL)


SET NOCOUNT OFF
GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[RPT_EQUIPMENT_OPERATIONAL_PERFORMANCE_SUMMARY]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[RPT_EQUIPMENT_OPERATIONAL_PERFORMANCE_SUMMARY]
GO

create PROCEDURE [dbo].[RPT_EQUIPMENT_OPERATIONAL_PERFORMANCE_SUMMARY]
/******************************************************************************
	File: 
	Name: RPT_EQUIPMENT_OPERATIONAL_PERFORMANCE_SUMMARY

	Called By:

	Desc: 
             

	Auth: Veronika Vasylyeva
	Date: 27-July-2007
*******************************************************************************
		Change History
*******************************************************************************
Date:		Author:		Description:
--------	--------	----------------------------------------
 2 Apr 12	V Vasylyeva	#3645 Shift Start Time ligic to be the same as in daily log reports
21 Feb 11	KN			#E736: Fix Report Security
22 Nov 11	V Vasylyeva	E673: Added Analyse By Model, Equipment group
 7 Apr 10	V Vasylyeva	CR8853: Added calculation of actual hours>0 in query for events
30 Jul 09	V Vasylyeva	CR8333 Discrepancy between this report and Dally Downtime Log
15 Apr 09	V Vasylyeva	Changes CR7998
14 Apr 09	V Vasylyeva	CR7983 Join to EndQUOMId
22 Jul 08	V Vasylyeva	CR7233 If equipment starts within the selected date range calculate 
						the scheduled hrs from the shift start time on the start date of equipment
15 Aug 07	V Vasylyeva Took out @CurrentDate
10 Aug 07	V Vasylyeva	Changed calc of the usages for the non-whole days
02 Aug 07	V Vasylyeva	Changed calculations of MTTR and availability
*******************************************************************************/

/* Param List */
@StartDate DATETIME,
@EndDate DATETIME,
@BranchID VARCHAR(max) = '',
@SiteID VARCHAR(max) = '',
@FleetID VARCHAR(max) = '',
@EqpPlanID VARCHAR(max) = '',
@ResponsibilityID VARCHAR(max) = '',
@GroupBy VARCHAR(4) = '',
@AnalyseBy VARCHAR(4) = '',
@Message varchar(8000)='' OUTPUT,
@ModelFamilyId varchar(max)='',
@ModelId varchar(max)='',
@UserId int = 0

AS

/*VV #3645 DECLARE @MonthStartDate datetime*/
DECLARE @SQLSellect varchar(8000)
DECLARE @SQL varchar(8000)
DECLARE @SQLGroupBy varchar(8000)
DECLARE @Resp1 varchar(50)
DECLARE @Resp2 varchar(50)
DECLARE @Resp3 varchar(50)
DECLARE @GrBy varchar(50)
DECLARE @AnBy varchar(50)

/*VV #3645 SET @MonthStartDate= CAST('1'+RIGHT(CONVERT(varchar,@StartDate,106),9) AS datetime)*/
SET @StartDate= CAST(CONVERT(varchar,@StartDate,106) AS datetime)

/*VV #3645*/
DECLARE @StartDateStr varchar(50), @EndDateStr varchar(50),@MonthStartStr varchar(50)

SET @StartDateStr=CAST(YEAR(@StartDate)*10000+MONTH(@StartDate)*100+DAY(@StartDate) AS varchar(50))
SET @EndDateStr=CAST(YEAR(@EndDate)*10000+MONTH(@EndDate)*100+DAY(@EndDate) AS varchar(50))
SET @MonthStartStr=CAST(YEAR(@StartDate)*10000+MONTH(@StartDate)*100+1 AS varchar(50))

SET @UserId = ISNULL(@UserId,0)
Declare @Level int
SELECT TOP 1 @Level=User_Access_Level_Id From USER_LEVEL_PERMISSION where AMT_User_Id = @UserId
SET @Level = ISNULL(@Level,0)

SET @BranchID =REPLACE(ISNULL(@BranchID,''),'''','')
SET @SiteID =REPLACE(ISNULL(@SiteID,''),'''','')
SET @FleetID =REPLACE(ISNULL(@FleetID,''),'''','')
SET @EqpPlanID =REPLACE(ISNULL(@EqpPlanID,''),'''','')
SET @ResponsibilityID =REPLACE(ISNULL(@ResponsibilityID,''),'''','')



SET @ResponsibilityID=ISNULL(NULLIF(@ResponsibilityID,''),'1,2,3')


SET @SQLSellect='SELECT '+ CASE @GroupBy
	WHEN 'SITE' THEN 'S.SiteId AS GroupById_1,S.Site AS GroupBy_1,'
	WHEN 'EQPL' THEN 'EP.EqpPlanId AS GroupById_1,EP.EqpPlan AS GroupBy_1,'
	ELSE 'F.FleetId AS GroupById_1,F.Fleet AS GroupBy_1,'
	END


SET @SQLSellect=@SQLSellect+ CASE @AnalyseBy 
	WHEN 'DAYS' THEN '0 AS GroupById_2,'''' AS GroupBy_2,'
	WHEN 'FLEE' THEN 'F.FleetId AS GroupById_2,F.Fleet AS GroupBy_2,'
	/*VV E673*/
	WHEN 'MODL' THEN 'M.ModelId AS GroupById_2,M.Model AS GroupBy_2,'
	WHEN 'EGRP' THEN 'MF.Model_Family_Id AS GroupById_2,MF.Model_Family_Code+'' '' +MF.Model_Family_Desc AS GroupBy_2,'
	
	ELSE 'EP.EqpPlanId AS GroupById_2,EP.EqpPlan AS GroupBy_2,'
	END

--select  CONVERT(varchar(20),getdate(),106) + ' ' + CONVERT(varchar,Shifts_Start_Time,114) from tblSites
--select * from AVAILABILITY_TYPE
--select * from REP_DAILY_USAGE where eqp_plan_id=1
--select * from responsibility
--MA avail
--SUM(Actual_Usage) / (SUM(Actual_Usage) + SUM(Target_MA_Downtime)) = TargetAvalability
--SUM(Actual_Usage) / (SUM(Actual_Usage) + SUM(PeriodDowntimeHours)) = Availability 

--PA
--(SUM(Scheduled_Hours) - SUM(Target_Downtime))/ SUM(Scheduled_Hours) =TargetAvalability
--(SUM(Scheduled_Hours) - SUM(PeriodDowntimeHours))/SUM(Scheduled_Hours) =Availability

--'SITE','FLEE','EQPL' : 'DAYS'


SET @SQL='EP.EqpPlanId,EPR.EndQUOMId AS QUOM_ID,MAX(RecordingDate) AS MaxUsageDate, 
MAX(ActualUsage) AS MaxUsage, AT.Availability_ShortName AS Av,
CONVERT(varchar,S.Shifts_Start_Time,114) AS ShiftStart,

/*VV #3645*/
dbo.SHIFT_TIME_F(S.Shifts_Start_Time,dbo.MIN_DATE_2_F(GETDATE(), '''+@EndDateStr +''')) AS EndDate,

EPR.EqpProjId,EP.StartDate, 

/*VV #3645*/ 
dbo.SHIFT_TIME_F(S.Shifts_Start_Time,'''+@StartDateStr +''') AS ShiftStartDate,
dbo.SHIFT_TIME_F(S.Shifts_Start_Time,'''+@MonthStartStr +''') AS MonthStartDate,
/*Month start date is always the earliest or equal ShiftStartDate*/
CAST(CONVERT(varchar(50),dbo.SHIFT_TIME_F(S.Shifts_Start_Time,'''+@MonthStartStr +'''),106) AS datetime) AS FilterStartDate


FROM 
tblActualUsages AU
	INNER JOIN 
tblEqpPlans EP
	ON AU.EquipmentId=EP.EquipmentId
	INNER JOIN
tblEqpProjs EPR
	ON EP.EqpPlanId=EPR.EqpPlanId AND
	   AU.QUOMId=EPR.EndQUOMId
	INNER JOIN
tblQUOMs Q
	ON EPR.EndQUOMId=Q.QUOMId AND Q.Operating_Hours_QUOM=1
	INNER JOIN
tblFleets F
	ON EP.FleetId=F.FleetId
	INNER JOIN
tblSites S
	ON F.SiteId=S.SiteId
	INNER JOIN
AVAILABILITY_TYPE AT
	ON F.Availability_Type_Id=AT.Availability_Type_Id
	/*VV E673*/
	INNER JOIN
tblEquipment E
	ON EP.EquipmentId=E.EquipmentId
	INNER JOIN
tblModels M
	ON E.ModelId=M.ModelId
	INNER JOIN
MODEL_FAMILY MF
	ON M.Model_Family_Id=MF.Model_Family_Id
	WHERE EPR.Projection_Type_Id=1 AND EP.Advanced_Planning=1 '

IF @BranchID<>'' SET @SQL=@SQL+' AND S.BranchID IN('+@BranchID+')'
IF @SiteID<>'' SET @SQL=@SQL+' AND S.SiteID IN('+@SiteID+')'

IF @Level = 1 SET @SQL = @SQL + ' AND (S.BranchId In (SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = '+CAST(@UserId AS varchar(50))+'))'
IF @Level = 2 SET @SQL =@SQL + ' AND (S.SiteID IN(SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = '+CAST(@UserId AS varchar(50))+'))'

IF @FleetID<>'' SET @SQL=@SQL+' AND F.FleetID IN('+@FleetID+')'
IF @EqpPlanID<>'' SET @SQL=@SQL+' AND EP.EqpPlanID IN('+@EqpPlanID+')'
IF @ModelId<>'' SET @SQL=@SQL+' AND M.ModelId IN('+@ModelId+')'
IF @ModelFamilyId<>'' SET @SQL=@SQL+' AND MF.Model_Family_Id IN('+@ModelFamilyId+')'

SET @SQLGroupBy='
Group By EP.EqpPlanId,EPR.EndQUOMId,AT.Availability_ShortName,
/*VV #3645*/S.Shifts_Start_Time,EqpProjId,EP.StartDate,'

SET @SQLGroupBy= @SQLGroupBy+CASE @GroupBy 
	WHEN 'SITE' THEN 'S.SiteId,S.Site'
	WHEN 'FLEE' THEN 'F.FleetId,F.Fleet'
	ELSE 'EP.EqpPlanId,EP.EqpPlan'
	END

SET @SQLGroupBy=CASE  @AnalyseBy
	WHEN 'DAYS' THEN @SQLGroupBy+ ''
	WHEN 'EQPL' THEN @SQLGroupBy+',EP.EqpPlan'
	/*VV E673*/
	WHEN 'MODL' THEN @SQLGroupBy+',M.ModelId,M.Model'
	WHEN 'EGRP' THEN @SQLGroupBy+',MF.Model_Family_Id,MF.Model_Family_Code+'' '' +MF.Model_Family_Desc'
	ELSE @SQLGroupBy+ ',F.FleetId,F.Fleet'
	END


CREATE TABLE #z_EqpPlan(GroupById_1 int, GroupBy_1 varchar(1000) COLLATE DATABASE_DEFAULT,
GroupById_2 int, GroupBy_2 varchar(1000) COLLATE DATABASE_DEFAULT, Eqp_Plan_Id int,QUOM_Id int,
MaxUsageDate datetime,MaxUsage float,Av varchar(10),ShiftStart varchar(20) COLLATE DATABASE_DEFAULT,
EndDate datetime,EqpProjId int,StartDate datetime,
/*VV #3645*/
ShiftStartDate datetime,MonthStartDate datetime,FilterStartDate datetime
PRIMARY KEY (Eqp_Plan_Id))

CREATE TABLE #z_EqpPerf(Eqp_Plan_Id int,
StartDate datetime,EndDate datetime,Actual_Usage float,Scheduled_Hours float,
Planned int ,Break_Down int,Other int,TotalStop int,
DT_1 float,DT_2 float, DT_3 float,DT float,
Target_MA_Downtime float,Target_Downtime float,
Sch_Usage float
PRIMARY KEY(Eqp_Plan_Id,StartDate,EndDate))


INSERT INTO #z_EqpPlan(GroupById_1,GroupBy_1,GroupById_2,GroupBy_2,Eqp_Plan_Id,QUOM_ID,
MaxUsageDate, MaxUsage, Av,ShiftStart,EndDate,EqpProjId,StartDate,
/*VV #3645*/ShiftStartDate,MonthStartDate,FilterStartDate)
EXEC(@SQLSellect+@SQL+@SQLGroupBy)



--Check that availability is the same for all fleets
IF EXISTS(SELECT  COUNT(DISTINCT Av) AS CountAv 
	FROM #z_EqpPlan GROUP BY GroupById_1 HAVING COUNT(DISTINCT Av)>1)
BEGIN
	SET @Message='Cannot run report because chosen fleets have different availability types.
Please refine filter selection.'
	RETURN
END



/*VV #3645*/	
INSERT INTO #z_EqpPerf
(Eqp_Plan_ID,StartDate,EndDate,Actual_Usage, Scheduled_Hours,Target_MA_Downtime, Target_Downtime,
Sch_Usage)
SELECT RD.Eqp_Plan_ID,
dbo.MAX_DATE_2_F(RD.Usage_Date,EP.MonthStartDate) AS StartDate,
dbo.MIN_DATE_2_F(DATEADD(day,1,RD.Usage_Date),EP.EndDate) AS EndDate,

--Include only actual usages
CASE 
--When start period usage is greater than max actual usage --> 0
WHEN RD.Usage_Date>=EP.MaxUsageDate THEN 0
ELSE RD.Actual_Usage END AS Actual_Usage, /*There are records when the usage is not for the whole day. It is amended later in the update query*/

RD.Scheduled_Hours,
RD.Target_MA_Downtime, 
RD.Target_Downtime,
RD.Actual_Usage AS Sch_Usage
FROM
REP_DAILY_USAGE RD
	INNER JOIN
#z_EqpPlan EP
	ON RD.Eqp_Plan_Id=EP.Eqp_Plan_Id AND RD.QUOM_ID=EP.QUOM_ID
	AND RD.Usage_Date >=FilterStartDate AND RD.Usage_Date<EP.EndDate
	

--drop table z_EqpPlan
--select * into z_EqpPlan_New from #z_EqpPlan
--return

--drop table z_EqpPerf
--SELECT * into z_EqpPerf FROM #z_EqpPerf
--return


/*VV #3645*/

--Split into 2 records periods which contain the shift start date for the filters. 
-- The report will count all records for group 1 from the beginning of the month
-- and all records from the start time for the group 2
INSERT INTO #z_EqpPerf
(Eqp_Plan_ID,StartDate,EndDate,Actual_Usage, 
Scheduled_Hours,Target_MA_Downtime, Target_Downtime,Sch_Usage)

SELECT EPE.Eqp_Plan_ID,EP.ShiftStartDate AS StartDate,
EPE.EndDate,EPE.Actual_Usage, EPE.Scheduled_Hours,EPE.Target_MA_Downtime, 
EPE.Target_Downtime,EPE.Sch_Usage
FROM 
#z_EqpPerf EPE
	INNER JOIN
#z_EqpPlan EP
	ON EPE.Eqp_Plan_Id=EP.Eqp_Plan_Id
WHERE EP.ShiftStart<>'00:00:00:000'
AND (EP.ShiftStartDate>EPE.StartDate AND EP.ShiftStartDate<EPE.EndDate)

UPDATE EPE SET 
EPE.EndDate=EP.ShiftStartDate
FROM 
#z_EqpPerf EPE
	INNER JOIN
#z_EqpPlan EP
	ON EPE.Eqp_Plan_Id=EP.Eqp_Plan_Id
WHERE EP.ShiftStart<>'00:00:00:000'
AND (EP.ShiftStartDate>EPE.StartDate AND EP.ShiftStartDate<EPE.EndDate)


--drop table z_EqpPerf,z_EqpPlan
--select * into z_EqpPerf from #z_EqpPerf
--select * into z_EqpPlan from #z_EqpPlan
--return

DECLARE @z_Resp TABLE(ResponsibilityId int PRIMARY KEY(ResponsibilityId))

INSERT INTO @z_Resp SELECT * FROM dbo.LIST_TO_TABLE_F(@ResponsibilityID)

CREATE TABLE #z_Event(Eqp_Plan_Id int,Event_Id int,Actual_Down_Time datetime,
Actual_Up_Time datetime, Planned bit,Break_Down bit,Other bit 
PRIMARY KEY(Eqp_Plan_Id,Event_Id))

INSERT INTO #z_Event(Eqp_Plan_Id, Event_Id,Actual_Down_Time,Actual_Up_Time,
Planned,Break_Down,Other )
SELECT E.Eqp_Plan_Id, E.Event_Id,E.Actual_Down_Time,E.Actual_Up_Time,
E.Planned,E.Break_Down,
CASE WHEN E.Planned=0 AND E.Break_Down=0 THEN 1 ELSE 0 END AS Other
FROM
@z_Resp R
	INNER JOIN
DOWN_TIME_ALLOCATION DTA
	ON R.ResponsibilityId=DTA.Responsibility_Id
	INNER JOIN
EVENT E
	ON DTA.Event_Id=E.Event_Id
	INNER JOIN
#z_EqpPlan EPE
	ON E.Eqp_Plan_Id=EPE.Eqp_Plan_Id
WHERE E.Event_Status_Id IN (2,3) AND
E.Actual_Down_Time<E.Actual_Up_Time AND
/*VV CR8853*/
round((cast(E.actual_up_time as float)-cast(E.actual_down_time as float))*24.00,2)>0 AND
/*VV #3645*/
E.Actual_Up_Time>EPE.MonthStartDate AND
E.Actual_Down_Time<EPE.EndDate

GROUP BY E.Eqp_Plan_Id, E.Event_Id,E.Actual_Down_Time,E.Actual_Up_Time,
E.Planned,E.Break_Down

--Update fields because they are calculated for the day periods
-- and some of the periods are less than 1 day because of
--the shift start time or the end time or the periods
--were splitted on 2 records.
UPDATE EPER
SET 
/*VV #3645*/
EPER.Actual_Usage=CASE

--If start date of the period is greater or equal max actual usage date --> 0
WHEN EPER.StartDate>=EP.MaxUsageDate THEN 0

--When Max actual usage is in the period --> Actuialusage = Max actual usage - Start period usage
WHEN 
EPER.StartDate<EP.MaxUsageDate AND EPER.EndDate>EP.MaxUsageDate THEN
EP.MaxUsage - dbo.GET_USAGE_FROM_DATE_F(EP.EqpProjId,EP.QUOM_Id,EPER.StartDate)

--Calculate the usage if the period is not the whole day
WHEN CAST(EPER.EndDate AS float)-CAST(EPER.StartDate AS float)<1 THEN 
dbo.GET_USAGE_FROM_DATE_F(EP.EqpProjId,EP.QUOM_Id,EPER.EndDate)-
dbo.GET_USAGE_FROM_DATE_F(EP.EqpProjId,EP.QUOM_Id,EPER.StartDate)

--It is the whole day period and max actual usage is not within it
ELSE Actual_Usage END, 

EPER.Scheduled_Hours=EPER.Scheduled_Hours*(CAST(EPER.EndDate AS float)-CAST(EPER.StartDate AS float)),
EPER.Target_MA_Downtime=EPER.Target_MA_Downtime*(CAST(EPER.EndDate AS float)-CAST(EPER.StartDate AS float)), 
EPER.Target_Downtime=EPER.Target_Downtime*(CAST(EPER.EndDate AS float)-CAST(EPER.StartDate AS float)),
EPER.Sch_Usage=EPER.Sch_Usage*(CAST(EPER.EndDate AS float)-CAST(EPER.StartDate AS float)),
EPER.Planned=A.Planned,
EPER.Break_Down=A.Break_Down,
EPER.Other=A.Other,
EPER.TotalStop=A.TotalStop,
EPER.DT_1=A.ActHrsResp1,
EPER.DT_2=A.ActHrsResp2,
EPER.DT_3=A.ActHrsResp3,
EPER.DT=A.ActHrs
FROM
#z_EqpPlan EP
	INNER JOIN		
#z_EqpPerf EPER
	ON EP.Eqp_Plan_Id=EPER.Eqp_Plan_Id
	LEFT OUTER JOIN
(SELECT
EPE.Eqp_Plan_Id,EPE.StartDate,EPE.EndDate,

SUM(CASE WHEN EV.Actual_Down_Time>=EPE.StartDate AND EV.Actual_Down_Time<EPE.EndDate THEN EV.Planned
ELSE 0 END) AS Planned, 
SUM(CASE WHEN EV.Actual_Down_Time>=EPE.StartDate AND EV.Actual_Down_Time<EPE.EndDate THEN EV.Break_Down
ELSE 0 END) AS Break_Down, 
SUM(CASE WHEN EV.Actual_Down_Time>=EPE.StartDate AND EV.Actual_Down_Time<EPE.EndDate THEN EV.Other
ELSE 0 END) AS Other, 
SUM(CASE WHEN EV.Actual_Down_Time>=EPE.StartDate AND EV.Actual_Down_Time<EPE.EndDate THEN 1
ELSE 0 END) AS TotalStop, 

SUM(
CASE 
WHEN EV.Actual_Down_Time>=EPE.EndDate THEN 0
WHEN EV.Actual_Up_Time<=EPE.StartDate THEN 0
ELSE  
-- Period proportion in the event downtime=Period time/Event time
(CAST(CASE WHEN EV.Actual_Up_Time<=EPE.EndDate THEN EV.Actual_Up_Time ELSE EPE.EndDate END AS float)-
CAST(CASE WHEN EV.Actual_Down_Time<=EPE.StartDate THEN EPE.StartDate ELSE EV.Actual_Down_Time END AS float))
/(CAST(EV.Actual_Up_Time As float)-CAST(EV.Actual_Down_Time As float))*EV.ActHrsResp1
END) AS ActHrsResp1,
SUM(
CASE 
WHEN EV.Actual_Down_Time>=EPE.EndDate THEN 0
WHEN EV.Actual_Up_Time<=EPE.StartDate THEN 0
ELSE  
-- Period proportion in the event downtime=Period time/Event time
(CAST(CASE WHEN EV.Actual_Up_Time<=EPE.EndDate THEN EV.Actual_Up_Time ELSE EPE.EndDate END AS float)-
CAST(CASE WHEN EV.Actual_Down_Time<=EPE.StartDate THEN EPE.StartDate ELSE EV.Actual_Down_Time END AS float))
/NULLIF((CAST(EV.Actual_Up_Time As float)-CAST(EV.Actual_Down_Time As float)),0)*EV.ActHrsResp2
END) AS ActHrsResp2,
SUM(
CASE 
WHEN EV.Actual_Down_Time>=EPE.EndDate THEN 0
WHEN EV.Actual_Up_Time<=EPE.StartDate THEN 0
ELSE  
-- Period proportion in the event downtime=Period time/Event time
(CAST(CASE WHEN EV.Actual_Up_Time<=EPE.EndDate THEN EV.Actual_Up_Time ELSE EPE.EndDate END AS float)-
CAST(CASE WHEN EV.Actual_Down_Time<=EPE.StartDate THEN EPE.StartDate ELSE EV.Actual_Down_Time END AS float))
/NULLIF((CAST(EV.Actual_Up_Time As float)-CAST(EV.Actual_Down_Time As float)),0)*EV.ActHrsResp3
END) AS ActHrsResp3,
SUM(
CASE 
WHEN EV.Actual_Down_Time>=EPE.EndDate THEN 0
WHEN EV.Actual_Up_Time<=EPE.StartDate THEN 0
ELSE  
-- Period proportion in the event downtime=Period time/Event time
(CAST(CASE WHEN EV.Actual_Up_Time<=EPE.EndDate THEN EV.Actual_Up_Time ELSE EPE.EndDate END AS float)-
CAST(CASE WHEN EV.Actual_Down_Time<=EPE.StartDate THEN EPE.StartDate ELSE EV.Actual_Down_Time END AS float))
/NULLIF((CAST(EV.Actual_Up_Time As float)-CAST(EV.Actual_Down_Time As float)),0)*EV.ActHrs
END) AS ActHrs

FROM
#z_EqpPerf EPE
	INNER JOIN
(SELECT E.Eqp_Plan_Id, E.Event_Id,E.Actual_Down_Time,E.Actual_Up_Time,
E.Planned,E.Break_Down,E.Other,SUM(DTA.Actual_Hours) As ActHrs,
SUM(CASE WHEN DTA.Responsibility_Id=1 THEN DTA.Actual_Hours ELSE 0 END) AS ActHrsResp1,
SUM(CASE WHEN DTA.Responsibility_Id=2 THEN DTA.Actual_Hours ELSE 0 END) AS ActHrsResp2,
SUM(CASE WHEN DTA.Responsibility_Id=3 THEN DTA.Actual_Hours ELSE 0 END) AS ActHrsResp3

FROM
DOWN_TIME_ALLOCATION DTA
	INNER JOIN
#z_EVENT E
	ON DTA.Event_Id=E.Event_Id
GROUP BY E.Eqp_Plan_Id, E.Event_Id,E.Actual_Down_Time,E.Actual_Up_Time,
E.Planned,E.Break_Down,E.Other) EV
	ON EPE.Eqp_Plan_Id=EV.Eqp_Plan_Id
GROUP BY EPE.Eqp_Plan_Id,EPE.StartDate,EPE.EndDate) A

ON EPER.Eqp_Plan_Id=A.Eqp_Plan_Id AND 
   EPER.StartDate=A.StartDate AND
   EPER.EndDate=A.EndDate

--select * into z_EVENT from #z_EVENT
--select * into z_EqpPerf from #z_EqpPerf

--Output


SELECT @Resp1=Description FROM RESPONSIBILITY WHERE Responsibility_Id=1
SELECT @Resp2=Description FROM RESPONSIBILITY WHERE Responsibility_Id=2
SELECT @Resp3=Description FROM RESPONSIBILITY WHERE Responsibility_Id=3

SET @AnBy= CASE @AnalyseBy 
	WHEN 'DAYS' THEN 'Days'
	WHEN 'FLEE' THEN 'Fleet'
	WHEN 'MODL' THEN 'Model'
	WHEN 'EGRP' THEN 'Equipment Group'
	ELSE 'Equipment'
	END


SET @GrBy= CASE @GroupBy 
	WHEN 'SITE' THEN 'Site '	
	WHEN 'EQPL' THEN 'Equipment'
	ELSE 'Fleet'
	END



SELECT EP.GroupById_1,EP.GroupBy_1,
SUM(EPE.Actual_Usage) As OpHrs,SUM(EPE.Scheduled_Hours) AS SchHrs,
ISNULL(SUM(EPE.Break_Down),0) AS Break_Down,
ISNULL(SUM(EPE.TotalStop),0) AS TotalStop,
ISNULL(SUM(EPE.DT),0) AS DT,
CASE WHEN 1 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_1),0)
ELSE 0 END +
CASE WHEN 2 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_2),0)
ELSE 0 END+
CASE WHEN 3 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_3),0)
ELSE 0 END AS DTResp,
--MTBF=OperatingHrs/Breakdown stoppages
ISNULL(SUM(EPE.Actual_Usage)/NULLIF(SUM(EPE.Break_Down),0),0) AS MTBF,
--MTBS=OperatingHrs/Total stoppages
ISNULL(SUM(EPE.Actual_Usage)/NULLIF(SUM(EPE.TotalStop),0),0) AS MTBS,
--MTTR=Total Downtime of Events for the selected resp/Total stoppages
ISNULL(
(CASE WHEN 1 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_1),0)
ELSE 0 END +
CASE WHEN 2 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_2),0)
ELSE 0 END+
CASE WHEN 3 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_3),0)
ELSE 0 END)
/NULLIF(SUM(EPE.TotalStop),0),0) AS MTTR,

--MA avail
ISNULL(SUM(EPE.Actual_Usage) / NULLIF((SUM(EPE.Actual_Usage) + 
(CASE WHEN 1 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_1),0)
ELSE 0 END +
CASE WHEN 2 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_2),0)
ELSE 0 END+
CASE WHEN 3 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_3),0)
ELSE 0 END)
),0),0)*100.00 AS MAvail,
--VV 15-Apr-2009
CASE AV WHEN 'MA' THEN
	ISNULL(SUM(EPE.Sch_Usage) / NULLIF((SUM(EPE.Sch_Usage) + SUM(EPE.Target_MA_Downtime)),0),0)*100.00 
ELSE ISNULL((SUM(EPE.Scheduled_Hours) - SUM(EPE.Target_Downtime))/ NULLIF(SUM(EPE.Scheduled_Hours),0),0)*100.00
END AS TargetAval,
--PA
ISNULL((SUM(EPE.Scheduled_Hours) - SUM(EPE.Target_Downtime))/ NULLIF(SUM(EPE.Scheduled_Hours),0),0)*100.00 AS TargetAvalP,
ISNULL((SUM(Scheduled_Hours) - 
(CASE WHEN 1 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_1),0)
ELSE 0 END +
CASE WHEN 2 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_2),0)
ELSE 0 END+
CASE WHEN 3 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_3),0)
ELSE 0 END)
)/NULLIF(SUM(Scheduled_Hours),0),0)*100.00 AS  PAvail,
@Resp1 AS Resp1,@Resp2 AS Resp2,@Resp3 AS Resp3,@AnBy AS AnBy,@GrBy AS GrBy,EP.AV

FROM 
#z_EqpPerf EPE
	INNER JOIN
#z_EqpPlan EP
	ON EPE.Eqp_Plan_Id=EP.Eqp_Plan_Id
GROUP BY EP.GroupById_1,EP.GroupBy_1,EP.AV
ORDER BY EP.GroupBy_1

--select * into z_EqpPerf from #z_EqpPerf
--select * into z_EqpPlan from #z_EqpPlan
--return

--CASE @AnalyseBy WHEN 'DAYS' THEN YEAR(EPE.StartDate)*10000+MONTH(EPE.StartDate)*100+DAY(EPE.StartDate) ELSE EP.GroupById_2 END AS GroupById_2,
--CASE @AnalyseBy WHEN 'DAYS' THEN CONVERT(varchar,EPE.StartDate,106) ELSE EP.GroupBy_2 END AS GroupBy_2,
IF @AnalyseBy='DAYS'
BEGIN
	SELECT EP.GroupById_1,
	YEAR(EPE.StartDate)*10000+MONTH(EPE.StartDate)*100+DAY(EPE.StartDate) AS GroupById_2,
	CONVERT(varchar,EPE.StartDate,106) AS GroupBy_2,
	SUM(EPE.Actual_Usage) As OpHrs,SUM(EPE.Scheduled_Hours) AS SchHrs,
	ISNULL(SUM(EPE.Planned),0) AS Planned,
	ISNULL(SUM(EPE.Break_Down),0) AS Break_Down,
	ISNULL(SUM(EPE.Other),0) AS Other,ISNULL(SUM(EPE.TotalStop),0) AS TotalStop,
	ISNULL(SUM(EPE.DT_1),0) AS DT_1,ISNULL(SUM(EPE.DT_2),0) AS DT_2,
	ISNULL(SUM(EPE.DT_3),0) AS DT_3,
	ISNULL(SUM(EPE.DT),0) AS DT,
	--MTBF=OperatingHrs/Breakdown stoppages
	ISNULL(SUM(EPE.Actual_Usage)/NULLIF(SUM(EPE.Break_Down),0),0) AS MTBF,
	--MTBS=OperatingHrs/Total stoppages
	ISNULL(SUM(EPE.Actual_Usage)/NULLIF(SUM(EPE.TotalStop),0),0) AS MTBS,
	--MTTR=Total Downtime for the selected resposibility/Total stoppages
	ISNULL(
	(CASE WHEN 1 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_1),0)
	ELSE 0 END +
	CASE WHEN 2 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_2),0)
	ELSE 0 END+
	CASE WHEN 3 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_3),0)
	ELSE 0 END)
	/NULLIF(SUM(EPE.TotalStop),0),0) AS MTTR,
	
	CASE AV WHEN 'MA' THEN
		ISNULL(SUM(EPE.Actual_Usage) / NULLIF((SUM(EPE.Actual_Usage) + 
		(CASE WHEN 1 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_1),0)
		ELSE 0 END +
		CASE WHEN 2 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_2),0)
		ELSE 0 END+
		CASE WHEN 3 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_3),0)
		ELSE 0 END)
		),0),0)*100.00 
	ELSE ISNULL((SUM(Scheduled_Hours) - 
	(CASE WHEN 1 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_1),0)
	ELSE 0 END +
	CASE WHEN 2 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_2),0)
	ELSE 0 END+
	CASE WHEN 3 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_3),0)
	ELSE 0 END))/NULLIF(SUM(Scheduled_Hours),0),0)*100.00
	END AS Avail,
	
	CASE AV WHEN 'MA' THEN
		ISNULL(SUM(EPE.Sch_Usage) / NULLIF((SUM(EPE.Sch_Usage) + SUM(EPE.Target_MA_Downtime)),0),0)*100.00 
	ELSE ISNULL((SUM(EPE.Scheduled_Hours) - SUM(EPE.Target_Downtime))/ NULLIF(SUM(EPE.Scheduled_Hours),0),0)*100.00
	END AS TargetAval,
	--PA
	ISNULL((SUM(EPE.Scheduled_Hours) - SUM(EPE.Target_Downtime))/ NULLIF(SUM(EPE.Scheduled_Hours),0),0)*100.00 AS TargetAvalP,
	ISNULL((SUM(Scheduled_Hours) - 
	(CASE WHEN 1 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_1),0)
	ELSE 0 END +
	CASE WHEN 2 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_2),0)
	ELSE 0 END+
	CASE WHEN 3 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_3),0)
	ELSE 0 END)
	)/NULLIF(SUM(Scheduled_Hours),0),0)*100.00 AS  PAvail
	
	FROM 
	#z_EqpPerf EPE
		INNER JOIN
	#z_EqpPlan EP
		ON EPE.Eqp_Plan_Id=EP.Eqp_Plan_Id
	/*VV #3645 WHERE EPE.StartDate>=CONVERT(varchar,@StartDate,106)+' '+EP.ShiftStart*/
	WHERE EPE.StartDate>=EP.ShiftStartDate
	GROUP BY EP.GroupById_1,EP.AV,
	YEAR(EPE.StartDate)*10000+MONTH(EPE.StartDate)*100+DAY(EPE.StartDate),
	CONVERT(varchar,EPE.StartDate,106)
	ORDER BY GroupById_2

END
ELSE
BEGIN
	SELECT EP.GroupById_1,EP.GroupById_2,EP.GroupBy_2,
	SUM(EPE.Actual_Usage) As OpHrs,SUM(EPE.Scheduled_Hours) AS SchHrs,
	ISNULL(SUM(EPE.Planned),0) AS Planned,
	ISNULL(SUM(EPE.Break_Down),0) AS Break_Down,
	ISNULL(SUM(EPE.Other),0) AS Other,ISNULL(SUM(EPE.TotalStop),0) AS TotalStop,
	ISNULL(SUM(EPE.DT_1),0) AS DT_1,ISNULL(SUM(EPE.DT_2),0) AS DT_2,
	ISNULL(SUM(EPE.DT_3),0) AS DT_3,
	ISNULL(SUM(EPE.DT),0) AS DT,
	--MTBF=OperatingHrs/Breakdown stoppages
	ISNULL(SUM(EPE.Actual_Usage)/NULLIF(SUM(EPE.Break_Down),0),0) AS MTBF,
	--MTBS=OperatingHrs/Total stoppages
	ISNULL(SUM(EPE.Actual_Usage)/NULLIF(SUM(EPE.TotalStop),0),0) AS MTBS,
	--MTTR=Total Downtime for the selected resposibility/Total stoppages
	ISNULL(
	(CASE WHEN 1 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_1),0)
	ELSE 0 END +
	CASE WHEN 2 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_2),0)
	ELSE 0 END+
	CASE WHEN 3 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_3),0)
	ELSE 0 END)
	/NULLIF(SUM(EPE.TotalStop),0),0) AS MTTR,
	--MA avail
	CASE AV WHEN 'MA' THEN
		ISNULL(SUM(EPE.Actual_Usage) / NULLIF((SUM(EPE.Actual_Usage) + 
	(CASE WHEN 1 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_1),0)
	ELSE 0 END +
	CASE WHEN 2 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_2),0)
	ELSE 0 END+
	CASE WHEN 3 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_3),0)
	ELSE 0 END)
	),0),0)*100.00 
	ELSE ISNULL((SUM(Scheduled_Hours) - 
	(CASE WHEN 1 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_1),0)
	ELSE 0 END +
	CASE WHEN 2 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_2),0)
	ELSE 0 END+
	CASE WHEN 3 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_3),0)
	ELSE 0 END)
	)/NULLIF(SUM(Scheduled_Hours),0),0)*100.00
	END AS Avail,
	
	CASE AV WHEN 'MA' THEN
		ISNULL(SUM(EPE.Sch_Usage) / NULLIF((SUM(EPE.Sch_Usage) + SUM(EPE.Target_MA_Downtime)),0),0)*100.00 
	ELSE ISNULL((SUM(EPE.Scheduled_Hours) - SUM(EPE.Target_Downtime))/ NULLIF(SUM(EPE.Scheduled_Hours),0),0)*100.00
	END AS TargetAval,
	--PA
	ISNULL((SUM(EPE.Scheduled_Hours) - SUM(EPE.Target_Downtime))/ NULLIF(SUM(EPE.Scheduled_Hours),0),0)*100.00 AS TargetAvalP,
	ISNULL((SUM(Scheduled_Hours) - 
	(CASE WHEN 1 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_1),0)
	ELSE 0 END +
	CASE WHEN 2 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_2),0)
	ELSE 0 END+
	CASE WHEN 3 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_3),0)
	ELSE 0 END)
	)/NULLIF(SUM(Scheduled_Hours),0),0)*100.00 AS  PAvail
	
	FROM 
	#z_EqpPerf EPE
		INNER JOIN
	#z_EqpPlan EP
		ON EPE.Eqp_Plan_Id=EP.Eqp_Plan_Id
	/*VV #3645 WHERE EPE.StartDate>=CONVERT(varchar,@StartDate,106)+' '+EP.ShiftStart*/
	WHERE EPE.StartDate>=EP.ShiftStartDate
	GROUP BY EP.GroupById_1,EP.GroupById_2,EP.GroupBy_2,EP.AV
	ORDER BY GroupBy_2
END

SELECT EP.GroupById_1,
SUM(EPE.Actual_Usage) As OpHrs,SUM(EPE.Scheduled_Hours) AS SchHrs,
ISNULL(SUM(EPE.Planned),0) AS Planned,
ISNULL(SUM(EPE.Break_Down),0) AS Break_Down,
ISNULL(SUM(EPE.Other),0) AS Other,ISNULL(SUM(EPE.TotalStop),0) AS TotalStop,
ISNULL(SUM(EPE.DT_1),0) AS DT_1,ISNULL(SUM(EPE.DT_2),0) AS DT_2,
ISNULL(SUM(EPE.DT_3),0) AS DT_3,
ISNULL(SUM(EPE.DT),0) AS DT,
--MTBF=OperatingHrs/Breakdown stoppages
ISNULL(SUM(EPE.Actual_Usage)/NULLIF(SUM(EPE.Break_Down),0),0) AS MTBF,
--MTBS=OperatingHrs/Total stoppages
ISNULL(SUM(EPE.Actual_Usage)/NULLIF(SUM(EPE.TotalStop),0),0) AS MTBS,
--MTTR=Total Downtime for the selected resposibility/Total stoppages
	ISNULL(
	(CASE WHEN 1 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_1),0)
	ELSE 0 END +
	CASE WHEN 2 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_2),0)
	ELSE 0 END+
	CASE WHEN 3 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_3),0)
	ELSE 0 END)
	/NULLIF(SUM(EPE.TotalStop),0),0) AS MTTR,
CASE AV WHEN 'MA' THEN
		ISNULL(SUM(EPE.Actual_Usage) / NULLIF((SUM(EPE.Actual_Usage) + 
		(CASE WHEN 1 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_1),0)
		ELSE 0 END +
		CASE WHEN 2 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_2),0)
		ELSE 0 END+
		CASE WHEN 3 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_3),0)
		ELSE 0 END)

		),0),0)*100.00 
	ELSE ISNULL((SUM(Scheduled_Hours) - 
	(CASE WHEN 1 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_1),0)
	ELSE 0 END +
	CASE WHEN 2 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_2),0)
	ELSE 0 END+
	CASE WHEN 3 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_3),0)
	ELSE 0 END)
	)/NULLIF(SUM(Scheduled_Hours),0),0)*100.00
	END AS Avail,
	
	CASE AV WHEN 'MA' THEN
		ISNULL(SUM(EPE.Sch_Usage) / NULLIF((SUM(EPE.Sch_Usage) + SUM(EPE.Target_MA_Downtime)),0),0)*100.00 
	ELSE ISNULL((SUM(EPE.Scheduled_Hours) - SUM(EPE.Target_Downtime))/ NULLIF(SUM(EPE.Scheduled_Hours),0),0)*100.00
	END AS TargetAval,
--PA
ISNULL((SUM(EPE.Scheduled_Hours) - SUM(EPE.Target_Downtime))/ NULLIF(SUM(EPE.Scheduled_Hours),0),0)*100.00 AS TargetAvalP,
ISNULL((SUM(Scheduled_Hours) - 
(CASE WHEN 1 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_1),0)
ELSE 0 END +
CASE WHEN 2 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_2),0)
ELSE 0 END+
CASE WHEN 3 IN (SELECT ResponsibilityId FROM @z_Resp) THEN ISNULL(SUM(EPE.DT_3),0)
ELSE 0 END)
)/NULLIF(SUM(Scheduled_Hours),0),0)*100.00 AS  PAvail

FROM 
#z_EqpPerf EPE
	INNER JOIN
#z_EqpPlan EP
	ON EPE.Eqp_Plan_Id=EP.Eqp_Plan_Id
/* VV #3645 WHERE EPE.StartDate>=CONVERT(varchar,@StartDate,106)+' '+EP.ShiftStart*/
WHERE EPE.StartDate>=EP.ShiftStartDate
GROUP BY EP.GroupById_1,EP.AV


--drop table z_Event
--select * into z_Event from #z_Event


--drop table z_EqpPlan
--select * into z_EqpPlan from #z_EqpPlan

--drop table z_EqpPerf
--SELECT * into z_EqpPerf_New FROM #z_EqpPerf




GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[BUDGET_EQUIPMENT_RECALCULATE_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[BUDGET_EQUIPMENT_RECALCULATE_P]
GO


CREATE PROCEDURE [dbo].[BUDGET_EQUIPMENT_RECALCULATE_P]
/******************************************************************************
	File: 
	Name: BUDGET_EQUIPMENT_RECALCULATE_P
	
	Called By: 


	DESCRIPTION:
			STEPS: 
				1 - RECALC BUDGET_PERIOD_USAGE TABLE
				2 - RECALC BUDGET_OCC TABLE
				3 - RECALC BUDGET_PERIOD TABLE
				4 - RECALC BUDGET_EQUIPMENT TABLE

	Auth: Koushik.Nagarajan
	Date: 25-Apr-2006
*******************************************************************************
		Change History
*******************************************************************************
Date:		Author:		Description:
--------	--------	----------------------------------------
09 May 12	KN	#4153	Divide by Zero error while calculating the occurrences beyond end date.
05 Apr 12	KN	#3932	Divide by Zero error while calculating the Occ Date , when Budget Period Usage 0 on that particular month.
21 Mar 11	KN	#1438 , #1437 , #1440: Fix Occurences of Task with Different UOM
13 May 10	VV			CR8935: BUDGET_PH_REVENUE_REPLACE_P
01 Dec 01	KN		CR8426: Fixed Divide by  Zero Error ( KN & DS)
04 Sep 09	KN		CR8344: costs do not come into budgeting correctly if there are multiple QUOMS.
12 Jun 09	AL	Removed tblAdministration
26 May 08	KN	Support Zero Period Usage
24 Aug 07	SI	Fixed task downtime calculation
15 Jun 07	SI	Used "FLOAT_TO_DATE_F" to convert float to datetime
15 Feb 07	KN	Set the Occurrence Date and Usage Past the End Date /usage of the Equipment.
13 Nov 06	SI	Changed to support date based tasks
10-Jun-2006	KN	Fixed the Cost Date Calculation
10-Jun-2006	KN	Included Cost_Bearer_id = 1
23-Jun-2006	KN	Updated the Proj_Start_Usage
08-Jun-2006	KN	Fixed the Task_Time Calculation
05-Jun-2006	KN	Fixed the Availability Task Downtime Calculation
18-May-2006	KN	Optimised the Query
18-May-2006	KN	Fixed the Crash Due to Availability NULL
15-May-2006	KN	Set the End_Date of the Equipment if the End_Usage > Max(Period_End_Usage)  to Budget_Header.End_Period + 2 Years
15-May-2006	KN	Fixed the Crash occured while Recalculating Budget( Handled the Update Procedure when Proj_Start_Date or Proj_Start_Usage IS NULL)
09-May-2006	KN	Set the Occ_Date if the Occ_Usage > Max(End_Usage)  to Budget_Header.End_Period + 2 Years
09-May-2006	KN	Fixed updated Start Period Usage
09-May-2006	KN	Added Force Calculate Business Rule
08-May-2006	KN	Rounding to two Decimal Places
*******************************************************************************/
	@Budget_Header_Id INT,
	@ForceCalculate BIT = 0,
	@CalcInProgress BIT = 0 OUTPUT,
	@Message	VARCHAR(100) = '' OUTPUT
AS




SET NOCOUNT ON


	DECLARE @BudgetStatus INT
	DECLARE @CalculatingStatus INT
	DECLARE @CalculationRequiredStatus INT
	DECLARE @OKStatus INT
	
	SET @OKStatus = 0
	SET @CalculatingStatus = 2
	SET @CalculationRequiredStatus =1

	SELECT @BudgetStatus = Calc_Status_Id FROM BUDGET_HEADER WHERE Budget_Header_Id = @Budget_Header_Id

	IF NOT EXISTS(SELECT Budget_Equipment_Id  FROM BUDGET_EQUIPMENT  WHERE Budget_Header_Id  = @Budget_Header_Id)
		BEGIN
			SET NOCOUNT OFF
			SET @Message	 = 'The specified budget header has no equipments.'
			RETURN
		END

	IF @BudgetStatus = @CalculatingStatus AND  @ForceCalculate = 0
		BEGIN
			SET NOCOUNT OFF
			SET @CalcInProgress = 1
			SET @Message	 = 'Calculation in progress. Are you sure want to restart the calculation?. '
			RETURN
		END


	IF @BudgetStatus = @OKStatus AND  @ForceCalculate = 0
		BEGIN
			SET NOCOUNT OFF
			SET @Message	 = 'Budget Header Level indicates , no calculation required for any of the Equipment. '
			RETURN
		END

	
/***********************************************************************************
	SET THE BUDGET_EQUIPMENT Status as "CALCULATING" WHERE Status = "CALC REQUIRED"
***********************************************************************************/
	UPDATE BUDGET_EQUIPMENT 
		SET 
			Calc_Status_Id = @CalculatingStatus,
			Last_Mod_Date = getdate()
	WHERE 
		Budget_Header_Id = @Budget_Header_Id 
		AND  Calc_Status_Id = @CalculationRequiredStatus

	UPDATE BUDGET_HEADER
		SET 
			Calc_Status_Id = @CalculatingStatus,
			Last_Mod_Date = getdate()
	WHERE 
		Budget_Header_Id = @Budget_Header_Id 
		AND  Calc_Status_Id = @CalculationRequiredStatus
	
/**************************************************************************
	1 - RECALC BUDGET_PERIOD_USAGE TABLE
**************************************************************************/

	DECLARE @tmpBudget_Equipment_Id INT
	DECLARE @tmpBudget_Usage_Id INT
	DECLARE @tmpBudget_Period_Id INT
	DECLARE @tmpQUOM_Id INT
	DECLARE @tmpPeriod_Start_Usage FLOAT 
	DECLARE @tmpPeriod_End_Usage FLOAT
	DECLARE @tmpPeriod_Usage FLOAT

	DECLARE @NewStartUsage FLOAT
	DECLARE @NewEndUsage FLOAT
	DECLARE @oldEqupId INT
	DECLARE @oldQUOM_Id  INT
	DECLARE @UpdateFuture BIT

	SET @UpdateFuture = 0
	SET @oldQUOM_Id = 0
	SET @oldEqupId = 0

	DECLARE ds_Cursor CURSOR FOR 
		SELECT     
			BE.Budget_Equipment_Id,
			BPU.Budget_Usage_Id, 
			BPU.Budget_Period_Id, 
			BPU.QUOM_Id, 
			BPU.Period_Start_Usage, 
			BPU.Period_End_Usage, 
			BPU.Period_Usage
		FROM         
			BUDGET_PERIOD_USAGE BPU INNER JOIN
			BUDGET_PERIOD BP ON BPU.Budget_Period_Id = BP.Budget_Period_Id INNER JOIN
                      		BUDGET_EQUIPMENT BE ON BP.Budget_Equipment_Id = BE.Budget_Equipment_Id INNER JOIN
                      		BUDGET_HEADER BH ON BE.Budget_Header_Id = BH.Budget_Header_Id
		WHERE 
			BH.Budget_Header_Id = @Budget_Header_Id  
			AND BE.Calc_Status_Id = @CalculatingStatus
		ORDER BY BE.Budget_Equipment_Id, BPU.QUOM_ID ,BPU.Period_Start_Usage
		
	FOR UPDATE

	OPEN ds_Cursor

	FETCH NEXT FROM ds_Cursor 
	INTO @tmpBudget_Equipment_Id, @tmpBudget_Usage_Id, @tmpBudget_Period_Id, @tmpQUOM_Id, @tmpPeriod_Start_Usage, @tmpPeriod_End_Usage, @tmpPeriod_Usage
	WHILE @@FETCH_STATUS = 0
		BEGIN
			IF @oldEqupId <> @tmpBudget_Equipment_Id
				SET @UpdateFuture = 0

			IF ISNULL(@oldQUOM_Id,0) <> ISNULL(@tmpQUOM_Id,0)
				SET @UpdateFuture = 0

			IF (@tmpPeriod_End_Usage - @tmpPeriod_Start_Usage <> @tmpPeriod_Usage AND @UpdateFuture = 0)
				BEGIN
					SET @NewStartUsage = @tmpPeriod_Start_Usage
					SET @UpdateFuture = 1		
				END		
				
			IF @UpdateFuture = 1
				BEGIN
					UPDATE BUDGET_PERIOD_USAGE
					SET 
						Period_Start_Usage = @NewStartUsage,
						Period_End_Usage = @NewStartUsage + @tmpPeriod_Usage
					WHERE Budget_Usage_Id = @tmpBudget_Usage_Id

					SET @NewStartUsage =  @NewStartUsage + @tmpPeriod_Usage
				END
				
			SET @oldQUOM_Id = @tmpQUOM_Id
			SET @oldEqupId = @tmpBudget_Equipment_Id
			
  			FETCH NEXT FROM ds_Cursor 
			INTO  @tmpBudget_Equipment_Id,@tmpBudget_Usage_Id, @tmpBudget_Period_Id, @tmpQUOM_Id, @tmpPeriod_Start_Usage, @tmpPeriod_End_Usage, @tmpPeriod_Usage
		END
	CLOSE ds_Cursor
	DEALLOCATE ds_Cursor

	-- UPDATE THE PROJ START USAGE OF THE EQUIPMENT
	UPDATE BPU
		SET BPU.Proj_Start_Usage =  BPU.Period_Start_Usage
	FROM         dbo.BUDGET_PERIOD_USAGE BPU INNER JOIN
	                      dbo.BUDGET_PERIOD BP ON BPU.Budget_Period_Id = BP.Budget_Period_Id INNER JOIN
	                      dbo.BUDGET_EQUIPMENT BE ON BP.Budget_Equipment_Id = BE.Budget_Equipment_Id INNER JOIN
	                      dbo.BUDGET_HEADER BH ON BE.Budget_Header_Id = BH.Budget_Header_Id
	WHERE     
		(BH.Budget_Header_Id = @Budget_Header_Id) AND 
		(BE.Calc_Status_Id =@CalculatingStatus) AND 
		(BP.Proj_Start_Date = BP.Period_Start_Date) AND 
		(BPU.Proj_Start_Usage IS NOT NULL)
		
/**************************************************************************
	2 - RECALC BUDGET_OCC TABLE
**************************************************************************/

	--UPDATE OCC usage w.r.t Cost_Date
	UPDATE BUDGET_OCC  
		SET 	
		Occ_Usage = 
			CASE 
				WHEN  BP.Proj_Start_Date IS NULL THEN
					BPU.Period_Start_Usage + ((BPU.Period_End_Usage-BPU.Period_Start_Usage) * (CONVERT(FLOAT,BO.Cost_Date)-CONVERT(FLOAT,BP.Period_Start_Date))/(CONVERT(FLOAT,BP.Period_End_Date)-CONVERT(FLOAT,BP.Period_Start_Date)))
				WHEN BO.Cost_Date BETWEEN BP.Proj_Start_Date AND BP.Period_End_Date THEN
					BPU.Proj_Start_Usage + ((BPU.Period_End_Usage-BPU.Proj_Start_Usage) * (CONVERT(FLOAT,BO.Cost_Date)-CONVERT(FLOAT,BP.Proj_Start_Date))/(CONVERT(FLOAT,BP.Period_End_Date)-CONVERT(FLOAT,BP.Proj_Start_Date)))
				ELSE
					BPU.Period_Start_Usage + ((BPU.Proj_Start_Usage-BPU.Period_Start_Usage) * (CONVERT(FLOAT,BO.Cost_Date)-CONVERT(FLOAT,BP.Period_Start_Date))/(CONVERT(FLOAT,BP.Proj_Start_Date)-CONVERT(FLOAT,BP.Period_Start_Date)))
			END
	FROM         
		BUDGET_OCC BO INNER JOIN
		BUDGET_TASK BT ON BO.Budget_Task_Id = BT.Budget_Task_Id INNER JOIN
		BUDGET_EQUIPMENT BE ON BT.Budget_Equipment_Id = BE.Budget_Equipment_Id INNER JOIN
		BUDGET_PERIOD BP ON BE.Budget_Equipment_Id = BP.Budget_Equipment_Id AND BO.Cost_Date BETWEEN BP.Period_Start_Date AND BP.Period_End_Date INNER JOIN
		BUDGET_PERIOD_USAGE BPU ON BP.Budget_Period_Id = BPU.Budget_Period_Id AND ISNULL(BT.QUOM_Id,0) = ISNULL(BPU.QUOM_Id,0)
	WHERE     
		(BO.Manual_Edited = 1 OR BO.Occ_Usage IS NULL) 
		AND BO.Is_Actual_Cost = 0 
		AND BE.Budget_Header_Id = @Budget_Header_Id
		AND BE.Calc_Status_Id = @CalculatingStatus


	--KN 15 Feb 2007
	-- Calculate Usage for the occurrence Past the End date of the Equipment.
	UPDATE BO
		SET BO.Occ_Usage = BP.Start_Usage + CASE WHEN CONVERT(FLOAT,BP.End_Date)-CONVERT(FLOAT,BP.Start_Date) = 0 THEN 0 ELSE  ((BP.End_Usage-BP.Start_Usage) * (CONVERT(FLOAT,BO.Cost_Date)-CONVERT(FLOAT,BP.Start_Date))/(CONVERT(FLOAT,BP.End_Date)-CONVERT(FLOAT,BP.Start_Date))) END
	FROM         
		BUDGET_OCC BO INNER JOIN
		BUDGET_TASK BT ON BO.Budget_Task_Id = BT.Budget_Task_Id INNER JOIN
		BUDGET_EQUIPMENT BE ON BT.Budget_Equipment_Id = BE.Budget_Equipment_Id INNER JOIN
		(
			SELECT  dbo.BUDGET_EQUIPMENT.Budget_Header_Id, 
				dbo.BUDGET_PERIOD.Budget_Equipment_Id, 
				dbo.BUDGET_PERIOD_USAGE.QUOM_Id, 
				dbo.BUDGET_EQUIPMENT.End_date as EqpEndDate,
				dbo.BUDGET_EQUIPMENT.End_Usage as EqpEndUsage,
				MAX(dbo.BUDGET_PERIOD.Proj_Start_Date) AS Start_Date, 
			        MAX(dbo.BUDGET_PERIOD_USAGE.Proj_Start_Usage) AS Start_Usage, 
				MAX(dbo.BUDGET_PERIOD.Period_End_Date) AS End_Date, 
				MAX(dbo.BUDGET_PERIOD_USAGE.Period_End_Usage) AS End_Usage
			FROM         dbo.BUDGET_PERIOD INNER JOIN
			                      dbo.BUDGET_PERIOD_USAGE ON dbo.BUDGET_PERIOD.Budget_Period_Id = dbo.BUDGET_PERIOD_USAGE.Budget_Period_Id INNER JOIN
			                      dbo.BUDGET_EQUIPMENT ON dbo.BUDGET_PERIOD.Budget_Equipment_Id = dbo.BUDGET_EQUIPMENT.Budget_Equipment_Id 
			                      --AND     ISNULL(dbo.BUDGET_PERIOD_USAGE.QUOM_Id,0) = ISNULL(dbo.BUDGET_EQUIPMENT.End_QUOM_Id,0)
			WHERE dbo.BUDGET_EQUIPMENT.Budget_Header_Id = @Budget_Header_Id AND dbo.BUDGET_PERIOD_USAGE.Period_End_Usage < dbo.BUDGET_EQUIPMENT.End_Usage AND dbo.BUDGET_EQUIPMENT.Calc_Status_Id = @CalculatingStatus
			GROUP BY dbo.BUDGET_PERIOD.Budget_Equipment_Id, dbo.BUDGET_PERIOD_USAGE.QUOM_Id, dbo.BUDGET_EQUIPMENT.Budget_Header_Id,dbo.BUDGET_EQUIPMENT.End_date,dbo.BUDGET_EQUIPMENT.End_Usage
		)
		BP ON BT.Budget_Equipment_Id = BP.Budget_Equipment_Id AND BE.Budget_Header_Id = BP.Budget_Header_Id AND ISNULL(BT.QUOM_Id,0) = ISNULL(BP.Quom_Id,0)
	WHERE     
		 BO.Cost_Date >= BE.End_Date
		AND BE.Budget_Header_Id = @Budget_Header_Id
		AND BO.Manual_Edited = 1
		AND  BE.Calc_Status_Id = @CalculatingStatus

	--UPDATE Cost_Date usage w.r.t usage
	UPDATE BUDGET_OCC  
		SET 	
			Cost_Date = 
				CASE
				WHEN BPU.Proj_Start_Usage IS NULL THEN
					CASE 
						WHEN BPU.Period_End_Usage - BPU.Period_Start_Usage = 0 THEN BP.Period_Start_Date
						ELSE dbo.FLOAT_TO_DATE_F(CONVERT(FLOAT,BP.Period_Start_Date) + ( (BO.Occ_Usage - BPU.Period_Start_Usage) / (BPU.Period_End_Usage - BPU.Period_Start_Usage) ) *  (CONVERT(FLOAT,BP.Period_End_Date)-CONVERT(FLOAT,BP.Period_Start_Date)))
					END
				WHEN BO.Occ_Usage BETWEEN  BPU.Proj_Start_Usage AND BPU.Period_End_Usage THEN
					CASE 
						WHEN BPU.Period_End_Usage - BPU.Proj_Start_Usage = 0 THEN BP.Proj_Start_Date 
						ELSE dbo.FLOAT_TO_DATE_F(CONVERT(FLOAT,BP.Proj_Start_Date) + ( (BO.Occ_Usage - BPU.Proj_Start_Usage) / (BPU.Period_End_Usage - BPU.Proj_Start_Usage) ) *  (CONVERT(FLOAT,BP.Period_End_Date)-CONVERT(FLOAT,BP.Proj_Start_Date)))
					END
				ELSE
					CASE 
						WHEN BPU.Proj_Start_Usage - BPU.Period_Start_Usage = 0 THEN  BP.Period_Start_Date
						ELSE dbo.FLOAT_TO_DATE_F(CONVERT(FLOAT,BP.Period_Start_Date) + ( (BO.Occ_Usage - BPU.Period_Start_Usage) / (BPU.Proj_Start_Usage - BPU.Period_Start_Usage) ) *  (CONVERT(FLOAT,BP.Proj_Start_Date)-CONVERT(FLOAT,BP.Period_Start_Date)))
					END
				END
	FROM         
		BUDGET_OCC BO INNER JOIN
		BUDGET_TASK BT ON BO.Budget_Task_Id = BT.Budget_Task_Id INNER JOIN
		BUDGET_EQUIPMENT BE ON BT.Budget_Equipment_Id = BE.Budget_Equipment_Id INNER JOIN
		BUDGET_PERIOD BP ON BE.Budget_Equipment_Id = BP.Budget_Equipment_Id  INNER JOIN
		BUDGET_PERIOD_USAGE BPU ON BP.Budget_Period_Id = BPU.Budget_Period_Id AND  ISNULL(BT.QUOM_Id,0) = ISNULL(BPU.QUOM_Id,0)  AND   BO.Occ_Usage > BPU.Period_Start_Usage AND BO.Occ_Usage <= BPU.Period_End_Usage
	WHERE     
		(BE.Budget_Header_Id = @Budget_Header_Id ) 
		AND BO.Is_Actual_Cost = 0  
		AND  BE.Calc_Status_Id = @CalculatingStatus
		AND  ABS(DATEDIFF(HOUR, BO.Cost_Date,	CASE
				WHEN BPU.Proj_Start_Usage IS NULL THEN
					CASE 
						WHEN BPU.Period_End_Usage - BPU.Period_Start_Usage = 0 THEN BP.Period_Start_Date
						ELSE dbo.FLOAT_TO_DATE_F(CONVERT(FLOAT,BP.Period_Start_Date) + ( (BO.Occ_Usage - BPU.Period_Start_Usage) / (BPU.Period_End_Usage - BPU.Period_Start_Usage) ) *  (CONVERT(FLOAT,BP.Period_End_Date)-CONVERT(FLOAT,BP.Period_Start_Date)))
					END
				WHEN BO.Occ_Usage BETWEEN  BPU.Proj_Start_Usage AND BPU.Period_End_Usage THEN
					CASE 
						WHEN BPU.Period_End_Usage - BPU.Proj_Start_Usage = 0 THEN BP.Proj_Start_Date 
						ELSE dbo.FLOAT_TO_DATE_F(CONVERT(FLOAT,BP.Proj_Start_Date) + ( (BO.Occ_Usage - BPU.Proj_Start_Usage) / (BPU.Period_End_Usage - BPU.Proj_Start_Usage) ) *  (CONVERT(FLOAT,BP.Period_End_Date)-CONVERT(FLOAT,BP.Proj_Start_Date)))
					END
				ELSE
					CASE 
						WHEN BPU.Proj_Start_Usage - BPU.Period_Start_Usage = 0 THEN  BP.Period_Start_Date
						ELSE dbo.FLOAT_TO_DATE_F(CONVERT(FLOAT,BP.Period_Start_Date) + ( (BO.Occ_Usage - BPU.Period_Start_Usage) / (BPU.Proj_Start_Usage - BPU.Period_Start_Usage) ) *  (CONVERT(FLOAT,BP.Proj_Start_Date)-CONVERT(FLOAT,BP.Period_Start_Date)))
					END
				END)) > 1


	--SET Date of the usage to End Period of the Budget + 1 year if Max End Usage is < Occ Usage
	SELECT     
		BE.Budget_Equipment_Id, 
		BPU.QUOM_Id,
		MAX(BPU.Period_End_Usage) AS MaxUsage, 
		BH.End_Period
	INTO #z_UpdateOutOfRangeOccs
	FROM         
		dbo.BUDGET_HEADER BH INNER JOIN
		dbo.BUDGET_EQUIPMENT BE ON BH.Budget_Header_Id = BE.Budget_Header_Id INNER JOIN
		dbo.BUDGET_PERIOD BP ON BE.Budget_Equipment_Id = BP.Budget_Equipment_Id INNER JOIN
              		dbo.BUDGET_PERIOD_USAGE BPU ON BP.Budget_Period_Id = BPU.Budget_Period_Id --AND ISNULL(BE.End_QUOM_Id,0) = ISNULL(BPU.QUOM_Id,0)
	WHERE     
		(BE.Budget_Header_Id = @Budget_Header_Id ) 
		AND  BE.Calc_Status_Id = @CalculatingStatus
	GROUP BY BE.Budget_Equipment_Id, BPU.QUOM_Id, BH.End_Period

	
	UPDATE BUDGET_OCC  
		SET 	
			Cost_Date =   DATEADD(YEAR,2,CONVERT(datetime, CONVERT(varchar,BH.End_Period) + '01', 112)) 
	FROM         
		BUDGET_OCC BO INNER JOIN
		BUDGET_TASK BT ON BO.Budget_Task_Id = BT.Budget_Task_Id INNER JOIN
		BUDGET_EQUIPMENT BE ON BT.Budget_Equipment_Id = BE.Budget_Equipment_Id INNER JOIN
		#z_UpdateOutOfRangeOccs ORO ON BE.Budget_Equipment_Id = ORO.Budget_Equipment_Id AND ISNULL(BT.QUOM_Id,0) = ISNULL(ORO.QUOM_Id,0) INNER JOIN
		BUDGET_HEADER BH ON BH.Budget_Header_Id = BE.Budget_Header_Id
	WHERE 
		(BE.Budget_Header_Id = @Budget_Header_Id ) 
		AND BO.Is_Actual_Cost = 0  
		AND  BE.Calc_Status_Id = @CalculatingStatus
		AND BO.Occ_Usage > ORO.MaxUsage

	--KN 15 Feb 2007
	-- Calculate Date for the occurrence Past the End date of the Equipment.
	UPDATE BO
	SET BO.Cost_Date =
		BP.Start_Date + ( (BO.Occ_Usage - BP.Start_Usage) / (BP.End_Usage - BP.Start_Usage) ) *  (CONVERT(FLOAT,BP.End_Date)-CONVERT(FLOAT,BP.Start_Date))
	FROM         
		BUDGET_OCC BO INNER JOIN
		BUDGET_TASK BT ON BO.Budget_Task_Id = BT.Budget_Task_Id INNER JOIN
		BUDGET_EQUIPMENT BE ON BT.Budget_Equipment_Id = BE.Budget_Equipment_Id INNER JOIN
		(
			SELECT  dbo.BUDGET_EQUIPMENT.Budget_Header_Id, 
				dbo.BUDGET_PERIOD.Budget_Equipment_Id, 
				dbo.BUDGET_PERIOD_USAGE.QUOM_Id, 
				dbo.BUDGET_EQUIPMENT.End_date as EqpEndDate,
				dbo.BUDGET_EQUIPMENT.End_Usage as EqpEndUsage,
				MAX(dbo.BUDGET_PERIOD.Proj_Start_Date) AS Start_Date, 
			        MAX(dbo.BUDGET_PERIOD_USAGE.Proj_Start_Usage) AS Start_Usage, 
				MAX(dbo.BUDGET_PERIOD.Period_End_Date) AS End_Date, 
				MAX(dbo.BUDGET_PERIOD_USAGE.Period_End_Usage) AS End_Usage
			FROM         dbo.BUDGET_PERIOD INNER JOIN
			                      dbo.BUDGET_PERIOD_USAGE ON dbo.BUDGET_PERIOD.Budget_Period_Id = dbo.BUDGET_PERIOD_USAGE.Budget_Period_Id INNER JOIN
			                      dbo.BUDGET_EQUIPMENT ON dbo.BUDGET_PERIOD.Budget_Equipment_Id = dbo.BUDGET_EQUIPMENT.Budget_Equipment_Id 
			                      --AND                     ISNULL(dbo.BUDGET_PERIOD_USAGE.QUOM_Id,0) = ISNULL(dbo.BUDGET_EQUIPMENT.End_QUOM_Id,0)
--DS 2009-08-20
--			WHERE dbo.BUDGET_EQUIPMENT.Budget_Header_Id = @Budget_Header_Id AND dbo.BUDGET_PERIOD_USAGE.Period_End_Usage < dbo.BUDGET_EQUIPMENT.End_Usage AND dbo.BUDGET_EQUIPMENT.Calc_Status_Id = @CalculatingStatus
			WHERE dbo.BUDGET_EQUIPMENT.Budget_Header_Id = @Budget_Header_Id AND dbo.BUDGET_PERIOD_USAGE.Period_End_Usage <= dbo.BUDGET_EQUIPMENT.End_Usage AND dbo.BUDGET_EQUIPMENT.Calc_Status_Id = @CalculatingStatus
			GROUP BY dbo.BUDGET_PERIOD.Budget_Equipment_Id, dbo.BUDGET_PERIOD_USAGE.QUOM_Id, dbo.BUDGET_EQUIPMENT.Budget_Header_Id,dbo.BUDGET_EQUIPMENT.End_date,dbo.BUDGET_EQUIPMENT.End_Usage
		)
		BP ON BT.Budget_Equipment_Id = BP.Budget_Equipment_Id AND BE.Budget_Header_Id = BP.Budget_Header_Id AND  ISNULL(BT.QUOM_Id,0) = ISNULL(BP.Quom_Id,0)
	WHERE     
		 BO.Cost_Date >= BE.End_Date
		AND BE.Budget_Header_Id = @Budget_Header_Id
		AND BO.Manual_Edited = 1
		AND  BE.Calc_Status_Id = @CalculatingStatus
--DS & KN 2009-10-23 (exclude occs past the end where Proj_Start_Usage = Period_End_Usage - to be investigated)
		AND (BP.End_Usage - BP.Start_Usage <>0)

--	DROP TABLE #z_UpdateOutOfRangeOccs

	
/**************************************************************************
	3 - RECALC BUDGET_PERIOD TABLE
**************************************************************************/

	---UPDATE  Task_Downtime, Availability , RVIC(using eqn  y = y1+ (x-x1)*(y2-y1)/(x2-x1))

	UPDATE BUDGET_PERIOD
	SET 
		Task_Downtime = ISNULL(TT.Task_Downtime,0),
		Availability =			
			CASE
				WHEN TT.Availability_Type_Id = 1 AND TT.Scheduled_Hours > 0 THEN
					100*(TT.Scheduled_Hours - ( ISNULL(TT.Baseline_Downtime,0) + ISNULL(TT.Task_Downtime,0)) )/ TT.Scheduled_Hours
				WHEN TT.Availability_Type_Id = 2 AND (TT.Operating_Hours + TT.Baseline_Downtime + TT.Task_Downtime ) > 0 THEN
					100* TT.Operating_Hours / (TT.Operating_Hours + ISNULL(TT.Baseline_Downtime,0) + ISNULL(TT.Task_Downtime,0) )
				ELSE
					100
			END,
		RVIC = TT.Low_RVIC + ( ( TT.Period_End_Usage - TT.Low_Cum) *(ISNULL(TT.High_RVIC,0) - TT.Low_RVIC) / (ISNULL(TT.High_Cum,0) - TT.Low_Cum) )

	FROM 
	(
		SELECT     
			BP.Budget_Period_Id, 
			BP.Budget_Equipment_Id, 
			BP.Calendar_Period, 
			BE.Scheduling_Efficiency, 
			BE.Availability_Type_Id, 
			BP.Scheduled_Hours, 
			BP.Baseline_Downtime, 
			BPU.Period_End_Usage,
	        (BPU.Period_End_Usage - BPU.Period_Start_Usage) As Operating_Hours,
			SUM(TT.TASK_DOWNTIME) AS Total_Task_Downtime, 
	        MAX(TT.TASK_DOWNTIME) AS Max_Task_Downtime,
			MAX(TT.TASK_DOWNTIME) + ( 1- (ISNULL(BE.Scheduling_Efficiency,0)/100))* (SUM(TT.TASK_DOWNTIME) - MAX(TT.TASK_DOWNTIME)) AS Task_Downtime,
			(SELECT TOP 1 CUM_USAGE FROM BUDGET_RVIC WHERE CUM_USAGE <= BPU.Period_End_Usage  AND Budget_Equipment_Id = BP.Budget_Equipment_Id  ORDER BY CUM_USAGE DESC) AS Low_Cum,
			(SELECT TOP 1 RVIC FROM BUDGET_RVIC WHERE CUM_USAGE <= BPU.Period_End_Usage  AND Budget_Equipment_Id = BP.Budget_Equipment_Id  ORDER BY CUM_USAGE DESC) AS Low_RVIC,
			(SELECT TOP 1 CUM_USAGE FROM BUDGET_RVIC WHERE CUM_USAGE > BPU.Period_End_Usage AND Budget_Equipment_Id = BP.Budget_Equipment_Id  ORDER BY CUM_USAGE ASC ) AS High_Cum,		
			(SELECT TOP 1 RVIC FROM BUDGET_RVIC WHERE CUM_USAGE > BPU.Period_End_Usage AND Budget_Equipment_Id = BP.Budget_Equipment_Id  ORDER BY CUM_USAGE ASC ) AS High_RVIC
		FROM   
			BUDGET_PERIOD BP 
			INNER JOIN BUDGET_EQUIPMENT BE ON BP.Budget_Equipment_Id = BE.Budget_Equipment_Id 
			INNER JOIN
			(	SELECT 
					BE.Budget_Equipment_Id, 
					btsk.Budget_Task_Id,
					YEAR(bocc.Cost_Date)*100 + MONTH(bocc.Cost_Date) AS CalenderPeriod, 
					SUM(bocc.Downtime_Hours) AS TASK_DOWNTIME
				FROM	BUDGET_OCC bocc
					INNER JOIN BUDGET_TASK btsk ON btsk.Budget_Task_Id = bocc.Budget_Task_Id		
					INNER JOIN BUDGET_EQUIPMENT be ON be.Budget_Equipment_Id = btsk.Budget_Equipment_Id AND btsk.Is_Downtime_Task = 1
				WHERE	bocc.Occ_Usage <= be.End_Usage
						AND BE.Budget_Header_Id = @Budget_Header_Id
						AND BE.Calc_Status_Id = @CalculatingStatus
				GROUP BY 
					be.Budget_Equipment_Id, btsk.Budget_Task_Id,YEAR(bocc.Cost_Date)*100 + MONTH(bocc.Cost_Date), be.Scheduling_Efficiency
			) TT ON TT.Budget_Equipment_Id = BE.Budget_Equipment_Id AND TT.CalenderPeriod = BP.Calendar_Period
			INNER JOIN BUDGET_PERIOD_USAGE BPU ON BP.Budget_Period_Id = BPU.Budget_Period_Id
													AND ISNULL(BE.End_QUOM_Id,0) = ISNULL(BPU.QUOM_Id,0)
		WHERE     
			BE.Budget_Header_Id = @Budget_Header_Id
			AND BE.Calc_Status_Id = @CalculatingStatus
		GROUP BY 
			BP.Budget_Period_Id, 
			BP.Budget_Equipment_Id, 
			BP.Calendar_Period, 
			BE.Scheduling_Efficiency, 
			BE.Availability_Type_Id, 
			BP.Scheduled_Hours, 
			BP.Baseline_Downtime, 
			BPU.Period_End_Usage, 
			BPU.Period_Start_Usage
--		SELECT     
--			BP.Budget_Period_Id, 
--			BP.Budget_Equipment_Id, 
--			BP.Calendar_Period, 
--			BE.Scheduling_Efficiency, 
--			BE.Availability_Type_Id, 
--			BP.Scheduled_Hours, 
--			BP.Baseline_Downtime, 
--			BPU.Period_End_Usage,
--	        (BPU.Period_End_Usage - BPU.Period_Start_Usage) As Operating_Hours,
--			SUM(BO.Downtime_Hours) AS Total_Task_Downtime, 
--	        MAX(BO.Downtime_Hours) AS Max_Task_Downtime,
--			MAX(BO.Downtime_Hours) + ( 1- (ISNULL(BE.Scheduling_Efficiency,0)/100))* (SUM(BO.Downtime_Hours) - MAX(BO.Downtime_Hours)) AS Task_Downtime,
--			(SELECT TOP 1 CUM_USAGE FROM BUDGET_RVIC WHERE CUM_USAGE <= BPU.Period_End_Usage  AND Budget_Equipment_Id = BP.Budget_Equipment_Id  ORDER BY CUM_USAGE DESC) AS Low_Cum,
--			(SELECT TOP 1 RVIC FROM BUDGET_RVIC WHERE CUM_USAGE <= BPU.Period_End_Usage  AND Budget_Equipment_Id = BP.Budget_Equipment_Id  ORDER BY CUM_USAGE DESC) AS Low_RVIC,
--			(SELECT TOP 1 CUM_USAGE FROM BUDGET_RVIC WHERE CUM_USAGE > BPU.Period_End_Usage AND Budget_Equipment_Id = BP.Budget_Equipment_Id  ORDER BY CUM_USAGE ASC ) AS High_Cum,		
--			(SELECT TOP 1 RVIC FROM BUDGET_RVIC WHERE CUM_USAGE > BPU.Period_End_Usage AND Budget_Equipment_Id = BP.Budget_Equipment_Id  ORDER BY CUM_USAGE ASC ) AS High_RVIC
--		FROM   
--			BUDGET_PERIOD BP INNER JOIN
--			BUDGET_EQUIPMENT BE ON BP.Budget_Equipment_Id = BE.Budget_Equipment_Id INNER JOIN
--			BUDGET_TASK BT ON BE.Budget_Equipment_Id = BT.Budget_Equipment_Id AND BT.Is_Downtime_Task = 1 LEFT JOIN
--			BUDGET_OCC BO ON BT.Budget_Task_Id = BO.Budget_Task_Id AND BO.Cost_Date BETWEEN BP.Period_Start_Date AND DATEADD(SECOND, -1, BP.Period_End_Date)  INNER JOIN
--			BUDGET_PERIOD_USAGE BPU ON BP.Budget_Period_Id = BPU.Budget_Period_Id AND 
--			ISNULL(BE.End_QUOM_Id,0) = ISNULL(BPU.QUOM_Id,0)
--		WHERE     
--			(BE.Budget_Header_Id = @Budget_Header_Id ) 
--			AND  BE.Calc_Status_Id = @CalculatingStatus
--		GROUP BY 
--			BP.Budget_Period_Id, 
--			BP.Budget_Equipment_Id, 
--			BP.Calendar_Period, 
--			BE.Scheduling_Efficiency, 
--			BE.Availability_Type_Id, 
--			BP.Scheduled_Hours, 
--			BP.Baseline_Downtime, 
--			BPU.Period_End_Usage, 
--			BPU.Period_Start_Usage
	) TT
	WHERE TT.Budget_Period_Id = BUDGET_PERIOD.Budget_Period_Id 

/**************************************************************************
	4 - RECALC BUDGET_EQUIPMENT TABLE
**************************************************************************/
DECLARE @UsageTermRule INT
DECLARE @DateTermRule INT
SET @UsageTermRule = 1
SET @DateTermRule = 2

--.Eqp_Term_Rule_ID = 2 = Date = @DateTermRule
	UPDATE BE  
		SET 	
			BE.End_Usage = 	CASE 		
								WHEN BP.Proj_Start_Date IS NULL THEN
									BPU.Period_Start_Usage + ((BPU.Period_End_Usage-BPU.Period_Start_Usage) *( CONVERT(FLOAT,BE.End_Date)-CONVERT(FLOAT,BP.Period_Start_Date))/(CONVERT(FLOAT,BP.Period_End_Date)-CONVERT(FLOAT,BP.Period_Start_Date)))
								WHEN BE.End_Date BETWEEN BP.Proj_Start_Date AND BP.Period_End_Date THEN
									BPU.Proj_Start_Usage + ((BPU.Period_End_Usage-BPU.Proj_Start_Usage) *( CONVERT(FLOAT,BE.End_Date)-CONVERT(FLOAT,BP.Proj_Start_Date))/(CONVERT(FLOAT,BP.Period_End_Date)-CONVERT(FLOAT,BP.Proj_Start_Date)))
								ELSE
									BPU.Period_Start_Usage + ((BPU.Proj_Start_Usage-BPU.Period_Start_Usage) *( CONVERT(FLOAT,BE.End_Date)-CONVERT(FLOAT,BP.Period_Start_Date))/(CONVERT(FLOAT,BP.Proj_Start_Date)-CONVERT(FLOAT,BP.Period_Start_Date)))
								END
	FROM         
			BUDGET_HEADER BH INNER JOIN
			BUDGET_EQUIPMENT BE ON BH.Budget_Header_Id = BE.Budget_Header_Id  AND BE.Eqp_Term_Rule_ID = @DateTermRule INNER JOIN
			BUDGET_PERIOD BP ON BE.Budget_Equipment_Id = BP.Budget_Equipment_Id AND BE.End_Date BETWEEN BP.Period_Start_Date AND BP.Period_End_Date INNER JOIN
			BUDGET_PERIOD_USAGE BPU ON BP.Budget_Period_Id = BPU.Budget_Period_Id AND ISNULL(BE.End_QUOM_Id,0) = ISNULL(BPU.QUOM_Id,0)
	WHERE    
		(BE.Budget_Header_Id = @Budget_Header_Id ) 
		AND  BE.Calc_Status_Id = @CalculatingStatus

--.Eqp_Term_Rule_ID = 1 = Usage = @UsageTermRule

	UPDATE BE  
		SET 	
			End_Date = CASE
							WHEN BPU.Proj_Start_Usage IS NULL THEN
								dbo.FLOAT_TO_DATE_F(CONVERT(FLOAT,BP.Period_Start_Date) + ( (BE.End_Usage - BPU.Period_Start_Usage) / (BPU.Period_End_Usage - BPU.Period_Start_Usage) ) *  (CONVERT(FLOAT,BP.Period_End_Date)-CONVERT(FLOAT,BP.Period_Start_Date)))
							WHEN BE.End_Usage BETWEEN  BPU.Proj_Start_Usage AND BPU.Period_End_Usage THEN
								dbo.FLOAT_TO_DATE_F(CONVERT(FLOAT,BP.Proj_Start_Date) + ( (BE.End_Usage - BPU.Proj_Start_Usage) / (BPU.Period_End_Usage - BPU.Proj_Start_Usage) ) *  (CONVERT(FLOAT,BP.Period_End_Date)-CONVERT(FLOAT,BP.Proj_Start_Date)))
							ELSE
								dbo.FLOAT_TO_DATE_F(CONVERT(FLOAT,BP.Period_Start_Date) + ( (BE.End_Usage - BPU.Period_Start_Usage) / (BPU.Proj_Start_Usage - BPU.Period_Start_Usage) ) *  (CONVERT(FLOAT,BP.Proj_Start_Date)-CONVERT(FLOAT,BP.Period_Start_Date)))
							END
	FROM         
			BUDGET_HEADER BH INNER JOIN
            BUDGET_EQUIPMENT BE ON BH.Budget_Header_Id = BE.Budget_Header_Id AND BE.Eqp_Term_Rule_ID = @UsageTermRule INNER JOIN
            BUDGET_PERIOD BP ON BE.Budget_Equipment_Id = BP.Budget_Equipment_Id  INNER JOIN
            BUDGET_PERIOD_USAGE BPU ON BP.Budget_Period_Id = BPU.Budget_Period_Id AND ISNULL(BE.End_QUOM_Id,0) = ISNULL(BPU.QUOM_Id,0) AND BE.End_Usage BETWEEN BPU.Period_Start_Usage AND BPU.Period_End_Usage
	WHERE    
		(BE.Budget_Header_Id = @Budget_Header_Id ) 
		AND  BE.Calc_Status_Id = @CalculatingStatus


--Set the End_Date if the End_Usage > Max(End_Usage)  to Budget_Header.End_Period + 2 Years
	
	UPDATE BE  
		SET 	
			BE.End_Date =   DATEADD(YEAR,2,CONVERT(datetime, CONVERT(varchar,BH.End_Period) + '01', 112)) 
	FROM         
		BUDGET_HEADER BH INNER JOIN
           		 BUDGET_EQUIPMENT BE ON BH.Budget_Header_Id = BE.Budget_Header_Id AND BE.Eqp_Term_Rule_ID = @UsageTermRule INNER JOIN
		#z_UpdateOutOfRangeOccs ORO ON BE.Budget_Equipment_Id = ORO.Budget_Equipment_Id 
	WHERE 
		(BE.Budget_Header_Id = @Budget_Header_Id ) 
		AND  BE.Calc_Status_Id = @CalculatingStatus
		AND BE.End_Usage > ORO.MaxUsage


	DROP TABLE #z_UpdateOutOfRangeOccs


--BUDGET EQUIPMENT  RVIC
	UPDATE BUDGET_EQUIPMENT
		SET 
			RVIC = TT.Low_RVIC + ( ( TT.End_Usage - TT.Low_Cum) *(ISNULL(TT.High_RVIC,0) - TT.Low_RVIC) / (ISNULL(TT.High_Cum,0) - TT.Low_Cum) )
	FROM 
	(
		SELECT     

			BE.Budget_Equipment_Id, 
			BE.End_Usage,
			(SELECT TOP 1 CUM_USAGE FROM BUDGET_RVIC WHERE CUM_USAGE <= BE.End_Usage  AND Budget_Equipment_Id = BE.Budget_Equipment_Id  ORDER BY CUM_USAGE DESC) AS Low_Cum,
			(SELECT TOP 1 RVIC FROM BUDGET_RVIC WHERE CUM_USAGE <= BE.End_Usage  AND Budget_Equipment_Id = BE.Budget_Equipment_Id  ORDER BY CUM_USAGE DESC) AS Low_RVIC,
			(SELECT TOP 1 CUM_USAGE FROM BUDGET_RVIC WHERE CUM_USAGE > BE.End_Usage AND Budget_Equipment_ID = BE.Budget_Equipment_Id  ORDER BY CUM_USAGE ASC ) AS High_Cum,		

			(SELECT TOP 1 RVIC FROM BUDGET_RVIC WHERE CUM_USAGE > BE.End_Usage AND Budget_Equipment_Id = BE.Budget_Equipment_Id  ORDER BY CUM_USAGE ASC ) AS High_RVIC
		FROM        
			BUDGET_HEADER BH INNER JOIN
           			BUDGET_EQUIPMENT BE ON BH.Budget_Header_Id = BE.Budget_Header_Id AND CAST(CONVERT(VARCHAR(6), BE.End_Date, 112) AS INT) BETWEEN BH.Start_Period AND BH.End_Period INNER JOIN
            			BUDGET_PERIOD BP ON BE.Budget_Equipment_Id = BP.Budget_Equipment_Id AND BE.End_Date BETWEEN BP.Period_Start_Date AND BP.Period_End_Date INNER JOIN
			BUDGET_PERIOD_USAGE BPU ON BP.Budget_Period_Id = BPU.Budget_Period_Id AND ISNULL(BE.End_QUOM_Id,0) = ISNULL(BPU.QUOM_Id,0)
		WHERE     	   
			(BE.Budget_Header_Id = @Budget_Header_Id ) 
			AND  BE.Calc_Status_Id = @CalculatingStatus			
		GROUP BY  BE.Budget_Equipment_Id, BE.End_Usage
	) TT
	WHERE TT.Budget_Equipment_Id = BUDGET_EQUIPMENT.Budget_Equipment_Id 


--BUDGET EQUIPMENT  Opt_End_Date
	UPDATE B
		SET     
			B.Opt_End_Date=(	
					SELECT 
						TOP 1 FP.MonthEndDate 
					FROM 
							BUDGET_PERIOD BP INNER JOIN  tblFinancialPeriods FP ON BP.Calendar_Period = FP.CalenderPeriod
					WHERE 
						BP.Budget_Equipment_Id = B.Budget_Equipment_Id 
						AND(BP.Calendar_Period BETWEEN YEAR(DATEADD(YEAR,-1,B.End_Date))*100+MONTH(DATEADD(YEAR,-1,B.End_Date)) AND YEAR(DATEADD(YEAR,1,B.End_Date))*100+MONTH(DATEADD(YEAR,1,B.End_Date)) )
					ORDER BY BP.RVIC ASC
					) 
	FROM         
		BUDGET_EQUIPMENT B INNER JOIN
        		BUDGET_HEADER BH ON B.Budget_Header_Id = BH.Budget_Header_Id AND CAST(CONVERT(VARCHAR(6), B.End_Date, 112) AS INT)  BETWEEN BH.Start_Period AND BH.End_Period
	WHERE
		(B.Budget_Header_Id = @Budget_Header_Id ) 
		AND  B.Calc_Status_Id = @CalculatingStatus


-- BUDGET EQUIPMENT COSTS

DECLARE @Start_Period INT
DECLARE @End_Period INT
BEGIN
	SELECT 
		@Start_Period = Start_Period,
		@End_Period = End_Period
	FROM BUDGET_HEADER
	WHERE Budget_Header_Id = @Budget_Header_Id
END

DECLARE @Start_Date datetime
DECLARE @End_Date datetime
SET @Start_Date = CONVERT(datetime, SUBSTRING(CAST(@Start_Period as varchar),1,4)+'-'+SUBSTRING(CAST(@Start_Period as varchar),5,2)+'-01')
SET @End_Date = DATEADD(Month, 1, CONVERT(datetime, SUBSTRING(CAST(@End_Period as varchar),1,4)+'-'+SUBSTRING(CAST(@End_Period as varchar),5,2)+'-01') ) 


	SELECT     
		BE.Budget_Equipment_Id AS Budget_Equipment_Id, 
		COST_CATEGORY.Cost_Category_Id,
		NULLIF(100* (SUM(BUDGET_COST.SELL)-SUM(BUDGET_COST.COST))/NULLIF(SUM(BUDGET_COST.SELL),0),0) AS MARGIN
	INTO #z_Margins
	FROM         
		BUDGET_EQUIPMENT BE INNER JOIN
		BUDGET_HEADER BH ON BE.Budget_Header_Id = BH.Budget_Header_Id INNER JOIN
		BUDGET_TASK ON BE.Budget_Equipment_Id = BUDGET_TASK.Budget_Equipment_Id INNER JOIN
		BUDGET_OCC ON BUDGET_TASK.Budget_Task_Id = BUDGET_OCC.Budget_Task_Id AND BUDGET_OCC.Cost_Date < BE.End_Date INNER JOIN
		BUDGET_COST ON BUDGET_OCC.Budget_Occ_Id = BUDGET_COST.Budget_Occ_Id INNER JOIN
		COST_CATEGORY ON BUDGET_COST.Cost_Category_Id = COST_CATEGORY.Cost_Category_Id
	WHERE
		(BE.Budget_Header_Id = @Budget_Header_Id ) 
		AND  BE.Calc_Status_Id = @CalculatingStatus 
		AND BUDGET_COST.Cost_Bearer_Id = 1
		AND  BUDGET_OCC.Cost_Date >= @Start_Date AND BUDGET_OCC.Cost_Date < @End_Date
	GROUP BY 
		BE.Budget_Equipment_Id, 
		COST_CATEGORY.Cost_Category_Id, 
		BH.Start_Period, 

		BH.End_Period

	--AL: 12/06/09
	DECLARE @LabMargin FLOAT,@MiscMargin FLOAT,@PartsMargin FLOAT

	SELECT 
		@LabMargin = ISNULL(CASE WHEN Value_Name = 'LabourDefaultMargin' THEN Varchar_Value  ELSE   @LabMargin END,0), 
		@MiscMargin = ISNULL(CASE WHEN Value_Name = 'MiscDefaultMargin' THEN Varchar_Value  ELSE   @MiscMargin END,0), 
		@PartsMargin = ISNULL(CASE WHEN Value_Name = 'PartDefaultMargin' THEN Varchar_Value  ELSE   @PartsMargin END,0)
	FROM 
		AMT_TYPED_VARIABLE
	WHERE Value_Name IN (
	'LabourDefaultMargin',
	'MiscDefaultMargin',
	'PartDefaultMargin'
	)

	-- PARTS MARGIN
	UPDATE BUDGET_EQUIPMENT
		SET  Pct_Margin_Parts =  ROUND(ISNULL(TT.Margin, ISNULL(@PartsMargin,0)),2)
	FROM  #z_Margins TT INNER JOIN
		BUDGET_EQUIPMENT ON TT.Budget_Equipment_Id = BUDGET_EQUIPMENT.Budget_Equipment_Id AND  TT.Cost_Category_Id = 1


	-- LABOUR  MARGIN
	UPDATE BUDGET_EQUIPMENT
		SET  Pct_Margin_Labour = ROUND(ISNULL(TT.Margin, ISNULL(@LabMargin,0)),2)
	FROM  #z_Margins TT INNER JOIN
		BUDGET_EQUIPMENT ON TT.Budget_Equipment_Id = BUDGET_EQUIPMENT.Budget_Equipment_Id AND  TT.Cost_Category_Id = 2

	-- MISC  MARGIN
	UPDATE BUDGET_EQUIPMENT
		SET  Pct_Margin_Misc = ROUND(ISNULL(TT.Margin, ISNULL(@PartsMargin,0)),2)
	FROM  #z_Margins TT INNER JOIN
		BUDGET_EQUIPMENT ON TT.Budget_Equipment_Id = BUDGET_EQUIPMENT.Budget_Equipment_Id AND  TT.Cost_Category_Id = 3


	SELECT     
		BE.Budget_Equipment_Id AS Budget_Equipment_Id, 
		SUM(BUDGET_COST.SELL) AS Total_Sell,
		SUM(BUDGET_COST.COST) AS Total_Cost
	INTO #z_TotalValues
	FROM      
		BUDGET_EQUIPMENT BE INNER JOIN
		BUDGET_HEADER BH ON BE.Budget_Header_Id = BH.Budget_Header_Id INNER JOIN
		BUDGET_TASK ON BE.Budget_Equipment_Id = BUDGET_TASK.Budget_Equipment_Id INNER JOIN
		BUDGET_OCC ON BUDGET_TASK.Budget_Task_Id = BUDGET_OCC.Budget_Task_Id AND BUDGET_OCC.Cost_Date < BE.End_Date INNER JOIN
		BUDGET_COST ON BUDGET_OCC.Budget_Occ_Id = BUDGET_COST.Budget_Occ_Id 
	WHERE      
		(BE.Budget_Header_Id = @Budget_Header_Id ) 
		AND BE.Calc_Status_Id = @CalculatingStatus
		AND BUDGET_COST.Cost_Bearer_Id = 1
		AND BUDGET_OCC.Cost_Date >= @Start_Date AND BUDGET_OCC.Cost_Date < @End_Date
	GROUP BY 
		BE.Budget_Equipment_Id

	--TOTAL COST
	UPDATE BUDGET_EQUIPMENT
		SET  TOTAL_COST = ROUND(TT.Total_Cost,2)
	FROM  #z_TotalValues TT INNER JOIN
		BUDGET_EQUIPMENT ON TT.Budget_Equipment_Id = BUDGET_EQUIPMENT.Budget_Equipment_Id 

	--TOTAL SELL
	UPDATE BUDGET_EQUIPMENT
		SET  TOTAL_SELL = ROUND(TT.Total_Sell,2)
	FROM  #z_TotalValues TT INNER JOIN
		BUDGET_EQUIPMENT ON TT.Budget_Equipment_Id = BUDGET_EQUIPMENT.Budget_Equipment_Id

	DROP TABLE #z_TotalValues
	DROP TABLE #z_Margins
	
/*************************************
VV CR8935 Replace Plant Hire Revenue
************************************/

EXEC BUDGET_PH_REVENUE_REPLACE_P @BudgetHeaderId=@Budget_Header_Id

/***********************************************************************************
	SET THE BUDGET_EQUIPMENT & BUDGET_HEADER Status as OK WHERE Status = "CALCULATING"
***********************************************************************************/

	UPDATE BUDGET_EQUIPMENT 
		SET 
			Calc_Status_Id = @OKStatus,
			Last_Mod_Date = getdate()
	WHERE 
		Budget_Header_Id = @Budget_Header_Id 
		AND Calc_Status_Id = @CalculatingStatus

	UPDATE BUDGET_Header
		SET 
			Calc_Status_Id = @OKStatus,
			Last_Mod_Date = getdate()
	WHERE 
		Budget_Header_Id = @Budget_Header_Id 
		AND Calc_Status_Id = @CalculatingStatus

SET NOCOUNT OFF

GO



if exists (select * from dbo.sysobjects where id = object_id(N'dbo.[RPT_BUDGET_COST_WORKSHEET_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[RPT_BUDGET_COST_WORKSHEET_P]
GO

CREATE Procedure [dbo].[RPT_BUDGET_COST_WORKSHEET_P]
/******************************************************************************
      File: 
      Name: RPT_BUDGET_COST_WORKSHEET_P

      Called By: 

      Desc: Get data for Budget Cost Worksheet Report
             

      Auth: Veronika Vasylyeva
      Date: 09-Oct-2003
*******************************************************************************
            Change History
*******************************************************************************
Date:       Author:         Description:
--------    --------		----------------------------------------
13 Apr 12	KN				3974: Fix CostBearer for 0 Id.
04 Apr 12	KN				3935: String Trucate Error
14 Mar 12	KN				754: Added Enhancement
04 Mar 12	KN				E#732& E#751 enhancements
07 Feb 12	KN				Fixed 3337: Workorders list does not open report
07 Feb 12	KN				Fixed 3350: Forecast Worksheet report goes to year 2100

19 Aug 11   G Dhillon       Fixed issue #2305
02 Aug 11	K Nagarajan		#2220: Fixed Collation Issue
16 Jun 11   G Dhillon		fixed issue #1657
19 May 11	V Vasylyeva		#1315 - added @ShowPeriods
15 Oct 10   VS              #521 - modified column equip costcentre in temp table to varchar(max) 
23 Sep 10   VS              #292 & #294 enhancements - added strategy task description 
 2 Jul 10	V Vasylyeva		CR9009: Error Could not continue scan with NOLOCK due to data movement
							OR Error Attempt to fetch logical page (1:976) in database 2 failed.
26 Oct 09	AL				CR8421: Added new fields and analyse by
							CR8424: Fixed Manufacturer filter and Parent Eqp Analyse by
19 Sep 08   AL              Fixed @YearStartMonth
27 Jun 08   AL              Added @YearStartMonth
13 May 08   YS              Fixed Analyse By PEQP
05 May 08   YS              Added Analyse By PEQP
08 Apr 08   YS              Added Cost Category to Group By
03 Apr 08   AL              Now uses EQP_SIBLINGS_F 
26 Mar 08   YS              Added @CostCategoryId,@modifierID,@ActualProjected
07 Mar 08   YS				Added @EqpCostCentre,@ParentEquipmentID
06 Mar 08   YS				Transition of RadioButtonCollection to CheckBoxCollection
19 Jun 07   ID              Added Work Group
25 May 06   PJ				Increased size of component code field in temp table
23 May 06   PJ				Increased size of component code field in temp table
08 Feb 06   SI				New filters/group by/analyse Region, Division, Criticality, Equipment Classification, Equipment Group
20 Sep 05   V Vasylyeva		New group by: PLM, Component Code.
							New parameter: @TaskTypeID
17 May 04   V Vasylyeva		Task_Header_ID for ProjTask grouping
23 Oct 03   V Vasylyeva		Added Variance
21 Oct 03   V Vasylyeva		Added Order By
16 Oct 03   V Vasylyeva		Changed For 2 Scenarios
13 Oct 03   V Vasylyeva		Set NOCOUNT
13 Apr 04   H Singh         instead of "-" show "(NONE)"
07 Oct 11   DA				Added E#641
10 Oct 11   GD              E642 for cost category code
12 Oct 11   GD              E646 add modifier code and task counter as filter and group by
13 Oct 11	VV				E643: Added workorder settlement number
01 Feb 11   GD              Fixed 3397

*******************************************************************************/
        /* Param List */

    @DealerId int = 1,
    @BranchId varchar(MAX)='',
    @SiteID varchar(MAX)='',
    @FleetID varchar(MAX)='',     
    @EqpPlanID varchar(MAX)='',
    @Projection_Header_Id varchar(MAX)='1',
    @CostBearerID varchar(MAX)='1',
    @ModelId varchar(MAX) = '',
    @CostTypeID varchar(MAX) = '',
    @SystemID varchar(MAX) = '',     
    @SubSystemID varchar(MAX) = '',
    @ComponentCodeID varchar(MAX) = '',
    @ProjTaskId varchar(MAX) = '',
    @PartsLabourMisc int=0,
    @CostResponsibilityID varchar(MAX)='',
    @CostCentreID varchar(MAX)='',
    @CostActivityID varchar(MAX)='',
    @CostExpenseID varchar(MAX)='',
    @LabourActivityID varchar(MAX)='',
    @StartDate int = 200305,
    @EndDate int = 200309,
    @AnalyseBy varchar(10) = 'Monh',
    @GroupBy varchar(MAX)='BRAN,SITE,FLEE,EQPL,CTTY',
    @AnalyseVariance bit=0,
    @Name1 varchar(50)=NULL OUTPUT,
    @Name2 varchar(50)=NULL OUTPUT,
    @TaskTypeID varchar(MAX)='',
   
    @RegionId varchar(MAX)='',
    @DivisionId varchar(MAX)='',
    @CriticalityId varchar(MAX)='',
    @EqpClassId varchar(MAX)='',
    @EqpGroupId varchar(MAX)='',
    @EqpLocationId varchar(MAX)='',

    @EqpCategoryId varchar(MAX)='', --Added ID
	@WorkGroupId varchar(MAX)='',             --Added ID
	@EqpCostCentre varchar(MAX)='',     --Added ID
	@ParentEquipmentID varchar(MAX)='', --Added ID
	@CostCategoryId varchar(MAX)='',    --Added ID
	@modifierID varchar(MAX) = '',            --Added ID
	@ActualProjected int=3,
	@YearStartMonth int=0,   --AL: 27/06/08

	--AL: 22/10/09
	@ManufacturerID varchar(MAX)='', 
	@TaskCounterID varchar(MAX)='', 
	@TaskHeaderID varchar(MAX)='', 
	@CCActivity varchar(MAX)='',
	@CCLocation varchar(MAX)='',
	@CCResponsibility varchar(MAX)='',
	/*VV #1315*/
	@ShowPeriods bit=0,
	--GD  fixed issue #1657
	@IsCrossTab BIT =0,
	-- DA E641
	@ContractId varchar(MAX) = '',
	-- DA E643
	@WorkorderNumber VARCHAR(50) = '',
	@TaskMode VARCHAR(MAX) = '',
	@ProjTaskDescId VARCHAR(MAX) = '' 
AS

----------------------------------------------------------------------------------------------------------------
SET NOCOUNT ON


-- Parts/Labour/Misc: ALL=0,PART=1,LABOUR=2,MISC=3
DECLARE @Where_Clause varchar(MAX)
DECLARE @Eqp_Where_Clause as varchar(MAX)
DECLARE @GroupBy1Clause1 varchar(MAX)
DECLARE @GroupBy1Clause2 varchar(MAX)
DECLARE @SQL varchar(MAX)
DECLARE @SQL1 varchar(MAX)
DECLARE @SQL2 varchar(MAX)
DECLARE @Column varchar(5)
DECLARE @Counter smallint
DECLARE @GroupBy1Col smallint
DECLARE @SelectColumns varchar(MAX)
DECLARE @GroupBy1ColMAX smallint
DECLARE @IncludeMissingCalenderPeriods varchar(10) 
DECLARE @AnalyseByFld varchar(50)
DECLARE @InsertIntoClause varchar(MAX)
DECLARE @GroupBy1  varchar(1000)
DECLARE @ShowInsteadOfNull varchar(10)
DECLARE @InclMissPerFields varchar(MAX)
DECLARE @Table varchar(4000)
DECLARE @GroupingByParentEqp bit

DECLARE @All int
DECLARE @Parts int
DECLARE @Labour int
DECLARE @Misc int
DECLARE @PLM bit

--GD  added to fix fixed issue #1657
DECLARE @SelectQueryForCrossTab VARCHAR(MAX)
DECLARE @OrderByCrossTab VARCHAR(MAX)

/*DA E#641*/
DECLARE @equipEStartDate DATETIME
DECLARE @iEquipEStartDate INT	-- int representation for @equipEStartDate
SET @iEquipEStartDate = @startDate

/*KN #3350 Restrict year to End Of Equipment */
DECLARE @MaxEqpEndDate DATETIME
 
IF @CostBearerID='0'
	SET @CostBearerID=''
	
SELECT @equipEStartDate = MIN(EH.EqpStartDate), @MaxEqpEndDate = MAX(EH.EndDate)
FROM EQUIPMENT_HIERARCHY_V EH
WHERE 
(@EqpPlanID='' OR EH.EqpPlanId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EqpPlanID))) AND
(@FleetId='' OR EH.FleetId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@FleetId))) AND
(@SiteId='' OR EH.SiteId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@SiteId))) AND
(@BranchId='' OR EH.BranchId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@BranchId))) AND
(@DealerId='' OR EH.DealerId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@DealerId))) AND
(@Projection_Header_Id='' OR EH.ProjHeaderId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@Projection_Header_Id))) AND
(@ModelId='' OR EH.ModelId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@ModelId))) AND
(@EqpLocationId='' OR EH.Eqp_Location_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EqpLocationId))) AND
(@CriticalityId='' OR EH.Eqp_Criticality_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@CriticalityId))) AND
(@EqpCategoryId='' OR EH.Eqp_Category_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EqpCategoryId))) AND
(@EqpClassId='' OR EH.Eqp_Class_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EqpClassId))) AND
(@EqpGroupId='' OR EH.Equipment_Group_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EqpGroupId))) AND
(@ContractId='' OR EH.ContractId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@ContractId))) 
      
set @iEquipEStartDate = CAST(LEFT(CONVERT(VARCHAR(20), ISNULL(@equipEStartDate,'20030501'), 112), 6) AS INT)
 
/*KN #3350 Restrict year to End Of Equipment */
IF @MaxEqpEndDate IS NOT NULL AND @EndDate > CAST(LEFT(CONVERT(VARCHAR(20), @MaxEqpEndDate, 112), 6) AS INT)
	set @EndDate = CAST(LEFT(CONVERT(VARCHAR(20), @MaxEqpEndDate, 112), 6) AS INT)

IF @ActualProjected = 1
	SET @EndDate =  CAST(LEFT(CONVERT(VARCHAR(20), GetDate(), 112), 6) AS INT)
	
SET @SelectQueryForCrossTab=''
SET @OrderByCrossTab =''


SET @All=7
SET @Parts=1
SET @Labour=2
SET @Misc=4
SET @PLM=0

SET @GroupingByParentEqp=0

SET @ShowInsteadOfNull='(NONE)'

 --max number of columns in group by
SET @GroupBy1ColMAX=CASE @GroupBy
               WHEN 'YEAR' THEN 1
                 WHEN 'QRTR' THEN 1
                 WHEN 'MONH' THEN 1
               ELSE 5 
               END
SET @SQL1=''
SET @SQL2=''

--Set Parts/Labour/Misc to all if it is null
SET @PartsLabourMisc=ISNULL(@PartsLabourMisc,@All)

--Set the upper case

-- Used by Drill Down, report 174.  RY
SET @AnalyseBy =ISNULL(@AnalyseBy, 'MONH')
SET @AnalyseBy=UPPER(@AnalyseBy)
SET @GroupBy=UPPER(@GroupBy)

--Include missing calendar periods if AnalyseBy month, year or quater
SET @IncludeMissingCalenderPeriods=CASE @AnalyseBy
                     WHEN 'MONH' THEN 'MONH'
                     WHEN 'YEAR' THEN 'MONH'
                     WHEN 'QRTR' THEN 'MONH'
                     ELSE NULL END

--Where Close
      
SET @Where_Clause = ' WHERE (CalenderPeriod BETWEEN ' + Convert(varchar(6),@StartDate) + ' AND ' + Convert(varchar(6),@EndDate) + ')'

If @EqpPlanID <> '' SET @Where_Clause = @Where_Clause + ' AND EqpPlanID IN (' + @EqpPlanID + ' )'
If @FleetID <> '' SET @Where_Clause = @Where_Clause + ' AND FleetID IN (' + @FleetID + ' )'
If @SiteID <> '' SET @Where_Clause = @Where_Clause + ' AND SiteID IN (' + @SiteID + ' )'
If @BranchId <> '' SET @Where_Clause = @Where_Clause + ' AND BranchId IN (' + @BranchId + ' )'
If @DealerId > 0 SET @Where_Clause = @Where_Clause + ' AND DealerId = ' + Convert(varchar, @DealerId)
If @Projection_Header_Id <> '' SET @Where_Clause = @Where_Clause + ' AND Projection_Header_Id IN (' + @Projection_Header_Id + ')'
If @ProjTaskId <> ''
BEGIN
      SET @Where_Clause = @Where_Clause + ' AND ProjTaskID IN '
      SET @Where_Clause = @Where_Clause + ' ('
      SET @Where_Clause = @Where_Clause + ' SELECT projtaskid FROM tblprojtasks '
      SET @Where_Clause = @Where_Clause + ' WHERE Task_Header_id in  (' + @ProjTaskId + ' )'
       SET @Where_Clause = @Where_Clause + ' ) '--     ProjTask= @ProjTaskId 
END
If @ModelId <> '' SET @Where_Clause = @Where_Clause + ' AND ModelId IN (' + @ModelId + ')'
If @CostTypeID <> '' SET @Where_Clause = @Where_Clause + ' AND CostTypeID IN (' + @CostTypeID + ')' 
If @SystemID <> '' SET @Where_Clause = @Where_Clause + ' AND SystemID IN (' + @SystemID + ')'
If @SubSystemID <> '' SET @Where_Clause = @Where_Clause + ' AND SubSystemID IN (' + @SubSystemID + ')'
If @ComponentCodeID <> '' SET @Where_Clause = @Where_Clause + ' AND ComponentCodeID IN (' + @ComponentCodeID + ')'
If @TaskTypeID <> '' SET @Where_Clause = @Where_Clause + ' AND TaskTypeID IN (' + @TaskTypeID + ')'
If @CostBearerID <> '' SET @Where_Clause = @Where_Clause + ' AND CostBearerID IN (' + @CostBearerID + ')'           
IF @CostResponsibilityID <>'' SET @Where_Clause = @Where_Clause + ' AND Cost_Responsibility_ID IN (' + @CostResponsibilityID + ')'        
IF @CostCentreID <>'' SET @Where_Clause = @Where_Clause + ' AND Cost_Centre_ID IN (' + @CostCentreID + ')'               
IF @CostActivityID <>'' SET @Where_Clause = @Where_Clause + ' AND Cost_Activity_ID IN (' + @CostActivityID + ')'             
IF @CostExpenseID <>'' SET @Where_Clause = @Where_Clause + ' AND Cost_Expense_ID IN (' + @CostExpenseID + ')'              
IF @LabourActivityID <>'' SET @Where_Clause = @Where_Clause + ' AND LabourActivityID IN (' + @LabourActivityID + ')'           

IF @RegionId <>'' SET @Where_Clause = @Where_Clause + ' AND Region_Id IN (' + @RegionId + ')'                
IF @DivisionId <>'' SET @Where_Clause = @Where_Clause + ' AND Division_Id IN (' + @DivisionId + ')'           
IF @EqpLocationId <>'' SET @Where_Clause = @Where_Clause + ' AND Eqp_Location_Id IN (' + @EqpLocationId + ')'
IF @CriticalityId <>'' SET @Where_Clause = @Where_Clause + ' AND Eqp_Criticality_Id IN (' + @CriticalityId + ')'              
IF @EqpCategoryId <>'' SET @Where_Clause = @Where_Clause + ' AND Eqp_Category_Id IN (' + @EqpCategoryId + ')'              
IF @EqpClassId <>'' SET @Where_Clause = @Where_Clause + ' AND Eqp_Class_Id IN (' + @EqpClassId + ')'           
IF @EqpGroupId <>'' SET @Where_Clause = @Where_Clause + ' AND Equipment_Group_Id IN (' + @EqpGroupId + ')'           

IF @WorkGroupId <>'' SET @Where_Clause = @Where_Clause +  ' AND Work_Group_ID IN (SELECT Work_Group_Id                             
                                                                                                                        FROM WORK_GROUP                                                   
                                                                                                                        WHERE Work_Group_Code                           
                                                                                                                        IN (SELECT Work_Group_Code                      
                                                                                                                              FROM WORK_GROUP                                 
                                                                                                                              WHERE Work_Group_Id IN (' + @WorkGroupId + '))) '     --Added ID
IF @EqpCostCentre <>'' SET @Where_Clause = @Where_Clause + ' AND EqpCostCentreId IN (' + @EqpCostCentre + ')'
IF @CostCategoryId <>'' SET @Where_Clause = @Where_Clause + ' AND Cost_Category_Id IN (' + @CostCategoryId + ')'
If @modifierID <> '' SET @Where_Clause = @Where_Clause + ' AND ModifierID IN (' + @modifierID + ')'

IF ISNULL(@ParentEquipmentID,'')<>''
      SET @Where_Clause = @Where_Clause + ' AND EqpPlanID IN (SELECT EqpPlanID FROM dbo.EQP_SIBLINGS_F('+@ParentEquipmentID+')) '

/* DA E#641 */
IF @ContractId <>'' SET @Where_Clause = @Where_Clause + ' AND ContractId IN (' + @ContractId + ')'

--AL: 22/10/09
If @ManufacturerID <> '' SET @Where_Clause = @Where_Clause + ' AND ManufacturerId IN (' + @ManufacturerID + ')'
If @TaskCounterID <> '' SET @Where_Clause = @Where_Clause + ' AND ApplicationCodeID IN (' + @TaskCounterID + ')'
If @TaskHeaderID <> '' SET @Where_Clause = @Where_Clause + ' AND TaskHeaderId IN (' + @TaskHeaderID + ')'
If @CCActivity <> '' SET @Where_Clause = @Where_Clause + ' AND CC_Activity IN (' + @CCActivity + ')'
If @CCLocation <> '' SET @Where_Clause = @Where_Clause + ' AND CC_Location IN (' + @CCLocation + ')'
If @CCResponsibility <> '' SET @Where_Clause = @Where_Clause + ' AND CC_Responsibility IN (' + @CCResponsibility + ')'

/*VV E643*/
IF @WorkorderNumber<>'' SET @Where_Clause = @Where_Clause + ' AND Workorder Like ''%' +@WorkorderNumber+'%'''
 
IF @TaskMode <> ''
		SET @Where_Clause = @Where_Clause + ' AND TaskModeId IN (' + @TaskMode + ') '

IF @ProjTaskDescId <>''
	BEGIN
			SET @Where_Clause = @Where_Clause + ' AND Task_Description IN ( '
			SET @Where_Clause = @Where_Clause + ' SELECT DISTINCT dbo.TASK_DESCRIPTION_F(PT.Task_Description,TH.Component_Code,TH.Modifier_Code,TH.Task_Type,TH.Application_Code,TH.Description) as Task_Description '
			SET @Where_Clause = @Where_Clause + ' FROM tblProjTasks PT '
			SET @Where_Clause = @Where_Clause + ' INNER JOIN TASK_HEADER TH ON TH.Task_Header_Id = PT.Task_Header_Id '
			SET @Where_Clause = @Where_Clause + ' WHERE PT.ProjTaskId IN (' + @ProjTaskDescId + ') ) '
	END
	
--Create a temporary table
CREATE TABLE #z_Cost(                     
      [Cost] [float] NULL)

--Add Analyseby field
SET @AnalyseByFld=CASE @AnalyseBy
              WHEN 'PRTY' THEN 'Projection_Header_ID'       
              WHEN 'MONH' THEN 'CalenderPeriod'
              WHEN 'YEAR' THEN 'CalenderPeriod'
              WHEN 'QRTR' THEN 'CalenderPeriod'          
              ELSE 'CalenderPeriod' END

DECLARE @AnalyseByFld2 varchar(MAX)
SET @AnalyseByFld2=CASE @AnalyseBy
              WHEN 'PRTY' THEN 'Projection_Header_ID'       
              WHEN 'MONH' THEN 'CalPer'
              WHEN 'YEAR' THEN 'CalPer'
              WHEN 'QRTR' THEN 'CalPer'     
              ELSE 'CalPer' END


SET @SQL= 'ALTER TABLE #z_Cost ADD '+@AnalyseByFld+' int NULL'
 
EXEC(@SQL)

--GroupBy
--Branch, Site, Fleet, Equipment Plan, 
--Cost type, System, Sub-system, Task Type,
--Cost Responsibility, Cost Centre, Cost Activity, 
--Cost Expense, Labour Activity, 
--Projected task

--Create Group by
SET @GroupBy1Clause1 = ''
SET @GroupBy1Clause2 = ''
--Put Coma at the end
SET @GroupBy1=@GroupBy+','

--Find if any group by members were supplied
SET @Counter=CHARINDEX(',',@GroupBy1)

SET @SelectColumns=''
SET @InsertIntoClause=''
SET @InclMissPerFields=''
SET @GroupBy1Col=1

--Create Group By
WHILE @Counter>0
BEGIN
      
      SET @Column=LEFT(@GroupBy1,@Counter-1)
      SET @GroupBy1=RIGHT(@GroupBy1,LEN(@GroupBy1)-@Counter)
      

      IF @Column ='BRAN'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'BranchId, Branch,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'BranchId, Branch,'
            SET @InsertIntoClause = @InsertIntoClause + 'BranchId, Branch,'
            SET @InclMissPerFields=@InclMissPerFields + 'BranchId, Branch,'         
            SET @SelectColumns = @SelectColumns + 'Branch AS Col' + CAST(@GroupBy1Col as varchar) + ','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab + 'Col' + CAST(@GroupBy1Col as varchar) + ' AS Branch ' + ','
			SET @OrderByCrossTab = @OrderByCrossTab + 'Branch' + ','
            
            --Add columns for the temporary table
            SET @SQL= 'ALTER TABLE #z_Cost ADD BranchId int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD Branch varchar(50) NULL'
            EXEC(@SQL)
      END 
      ELSE IF @Column ='SITE'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'SiteId, Site,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'SiteId, Site,'
            SET @InsertIntoClause = @InsertIntoClause + 'SiteId, Site,'
            SET @InclMissPerFields=@InclMissPerFields + 'SiteId, Site,'
            SET @SelectColumns= @SelectColumns+'Site AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab + 'Col' + CAST(@GroupBy1Col as varchar) + ' AS Site ' + ','
            SET @OrderByCrossTab = @OrderByCrossTab + 'Site' + ','
            --Add columns for the temporary table
            SET @SQL= 'ALTER TABLE #z_Cost ADD SiteId int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD Site varchar(50) NULL'
            EXEC(@SQL)
      END
      ELSE IF @Column ='FLEE'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'FleetId, Fleet,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'FleetId, Fleet,'
            SET @InsertIntoClause = @InsertIntoClause + 'FleetId, Fleet,'
            SET @InclMissPerFields=@InclMissPerFields + 'FleetId, Fleet,'
            SET @SelectColumns= @SelectColumns+'Fleet AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab + 'Col' + CAST(@GroupBy1Col as varchar) + ' AS Fleet ' + ','
            SET @OrderByCrossTab = @OrderByCrossTab + 'Fleet' + ','
            
            SET @SQL= 'ALTER TABLE #z_Cost ADD FleetId int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD Fleet varchar(50) NULL'
            EXEC(@SQL)
      END
      ELSE IF @Column ='WONO'/*VV E643*/
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'WorkorderId,Workorder,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'WorkorderId,Workorder,'
            SET @InsertIntoClause = @InsertIntoClause + 'WorkorderId,Workorder,'
            SET @InclMissPerFields=@InclMissPerFields + 'WorkorderId,Workorder,'
            SET @SelectColumns= @SelectColumns+'Workorder AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab + 'Col' + CAST(@GroupBy1Col as varchar) + ' AS Workorder ' + ','
            SET @OrderByCrossTab = @OrderByCrossTab + 'Workorder' + ','
            
            SET @SQL= 'ALTER TABLE #z_Cost ADD WorkorderId int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD Workorder varchar(100) COLLATE DATABASE_DEFAULT NULL'
            EXEC(@SQL)
      END
      ELSE IF @Column ='CONT'		/*DA E#641*/
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'ContractId, Contract,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'ContractId, Contract,'
            SET @InsertIntoClause = @InsertIntoClause + 'ContractId, Contract,'
            SET @InclMissPerFields=@InclMissPerFields + 'ContractId, Contract,'
            SET @SelectColumns= @SelectColumns+'Contract AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab + 'Col' + CAST(@GroupBy1Col as varchar) + ' AS Contract ' + ','
            SET @OrderByCrossTab = @OrderByCrossTab + 'Contract' + ','
            
            SET @SQL= 'ALTER TABLE #z_Cost ADD ContractId int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD Contract varchar(50) NULL'
            EXEC(@SQL)
      END 
      ELSE IF @Column ='EQPL'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'EqpPlanId, EqpPlan,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'EqpPlanId, EqpPlan,'
            SET @InsertIntoClause = @InsertIntoClause + 'EqpPlanId, EqpPlan,'
            SET @InclMissPerFields=@InclMissPerFields + 'EqpPlanId, EqpPlan,'
            SET @SelectColumns = @SelectColumns+'EqpPlan AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab + 'Col' + CAST(@GroupBy1Col as varchar) + ' AS Equipment ' + ','
            SET @OrderByCrossTab = @OrderByCrossTab + 'Equipment' + ','
            SET @SQL= 'ALTER TABLE #z_Cost ADD EqpPlanId int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD EqpPlan varchar(50) NULL'
            EXEC(@SQL)
      END 
	ELSE IF @Column ='EQPD'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'EqpDescID, EqpDesc,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'EqpDescID, EqpDesc,'
            SET @InsertIntoClause = @InsertIntoClause + 'EqpDescID, EqpDesc,'
            SET @InclMissPerFields=@InclMissPerFields + 'EqpDescID, EqpDesc,'
            SET @SelectColumns = @SelectColumns+'EqpDesc AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab + 'Col' + CAST(@GroupBy1Col as varchar) + ' AS ''Equipment Desc'' ' + ','
            SET @OrderByCrossTab = @OrderByCrossTab + '''Equipment Desc''' + ','
            SET @SQL= 'ALTER TABLE #z_Cost ADD EqpDescID int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD EqpDesc varchar(260) NULL'
            EXEC(@SQL)
      END 
      ELSE IF @Column ='PEQP'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'EqpPlanId, EqpPlan,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'ParentEqpPlanId, ParentEqpPlan,'
            SET @InsertIntoClause = @InsertIntoClause + 'ParentEqpPlanId, ParentEqpPlan,'
            SET @InclMissPerFields=@InclMissPerFields + 'ParentEqpPlanId, ParentEqpPlan,'
            SET @SelectColumns= @SelectColumns+'ParentEqpPlan AS Col'+ CAST(@GroupBy1Col as varchar)+',' 
                      
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab + 'Col' + CAST(@GroupBy1Col as varchar) + ' AS ''Parent Equipment'' ' + ','
            SET @OrderByCrossTab = @OrderByCrossTab + '''Parent Equipment''' + ','
            
            SET @SQL= 'ALTER TABLE #z_Cost ADD ParentEqpPlanId int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD ParentEqpPlan varchar(50) NULL'
            EXEC(@SQL)

            SET @GroupingByParentEqp=1
      END 
      ELSE IF @Column ='CTTY'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'CostTypeId, CostType,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'CostTypeId, CostType,'
            SET @InsertIntoClause = @InsertIntoClause + 'CostTypeId, CostType,'
            SET @InclMissPerFields=@InclMissPerFields + 'CostTypeId, CostType,'
            SET @SelectColumns= @SelectColumns+'CostType AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab + 'Col' + CAST(@GroupBy1Col as varchar) + ' AS ''Cost Type'' ' + ','            
            SET @OrderByCrossTab = @OrderByCrossTab + '''Cost Type''' + ','
            
            SET @SQL= 'ALTER TABLE #z_Cost ADD CostTypeId int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD CostType varchar(50) NULL'
            EXEC(@SQL)
      END         
      ELSE IF @Column ='SYST'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'SystemId, System,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'SystemId, System,'
            SET @InsertIntoClause = @InsertIntoClause + 'SystemId, System,'
            SET @InclMissPerFields=@InclMissPerFields + 'SystemId, System,'
            SET @SelectColumns= @SelectColumns+'System AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab + 'Col' + CAST(@GroupBy1Col as varchar) + ' AS System ' + ','
            SET @OrderByCrossTab = @OrderByCrossTab + 'System' + ','
            SET @SQL= 'ALTER TABLE #z_Cost ADD SystemId int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD System varchar(50) NULL'
            EXEC(@SQL)
      END               
      ELSE IF @Column ='SUBS'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'SubSystemId, SubSystem,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'SubSystemId, SubSystem,'
            SET @InsertIntoClause = @InsertIntoClause + 'SubSystemId, SubSystem,'
            SET @InclMissPerFields=@InclMissPerFields + 'SubSystemId, SubSystem,'
            SET @SelectColumns= @SelectColumns+'SubSystem AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab + 'Col' + CAST(@GroupBy1Col as varchar) + ' AS ''Sub System'' ' + ','
            SET @OrderByCrossTab = @OrderByCrossTab + '''Sub System''' + ','
            
            SET @SQL= 'ALTER TABLE #z_Cost ADD SubSystemId int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD SubSystem varchar(50) NULL'
            EXEC(@SQL)
      END   
      ELSE IF @Column ='EVTT'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'TaskTypeID, TaskType,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'TaskTypeID, TaskType,'
            SET @InsertIntoClause = @InsertIntoClause + 'TaskTypeID, TaskType,'
            SET @InclMissPerFields=@InclMissPerFields + 'TaskTypeID, TaskType,'
            SET @SelectColumns= @SelectColumns+'TaskType AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab + 'Col' + CAST(@GroupBy1Col as varchar) + ' AS ''Task Type'' ' + ','
            SET @OrderByCrossTab = @OrderByCrossTab + '''Task Type''' + ','
            
            SET @SQL= 'ALTER TABLE #z_Cost ADD TaskTypeID int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD TaskType varchar(50) NULL'
            EXEC(@SQL)
      END   
      ELSE IF @Column ='EVCC'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'ComponentCodeID, CompCode,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'ComponentCodeID, CompCode,'
            SET @InsertIntoClause = @InsertIntoClause + 'ComponentCodeID, CompCode,'
            SET @InclMissPerFields=@InclMissPerFields + 'ComponentCodeID, CompCode,'
            SET @SelectColumns= @SelectColumns+'CompCode AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab + 'Col' + CAST(@GroupBy1Col as varchar) + ' AS ''Component Code'' ' + ','
            SET @OrderByCrossTab = @OrderByCrossTab + '''Component Code''' + ','
            
            SET @SQL= 'ALTER TABLE #z_Cost ADD ComponentCodeID int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD CompCode varchar(80) NULL'
            EXEC(@SQL)
      END               
      ELSE IF @Column ='CACT'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'ISNULL(Cost_Activity_ID,0),ISNULL(Cost_Activity_Code,'''+@ShowInsteadOfNull+'''),'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'Cost_Activity_ID,Cost_Activity_Code,'
            SET @InsertIntoClause = @InsertIntoClause + 'Cost_Activity_ID,Cost_Activity_Code,'
            SET @InclMissPerFields=@InclMissPerFields + 'Cost_Activity_ID,Cost_Activity_Code,'
            SET @SelectColumns= @SelectColumns+'Cost_Activity_Code AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab + 'Col' + CAST(@GroupBy1Col as varchar) + ' AS ''Maintenanace Type'' ' + ','
            SET @OrderByCrossTab = @OrderByCrossTab + '''Maintenanace Type''' + ','
            
            SET @SQL= 'ALTER TABLE #z_Cost ADD Cost_Activity_ID int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD Cost_Activity_Code varchar(70) NULL'
            EXEC(@SQL)
      END
      ELSE IF @Column ='WGRP'       --Added ID
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'ISNULL(Work_Group_ID,0),ISNULL(Work_Group_Code,'''+@ShowInsteadOfNull+'''),'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'Work_Group_ID,Work_Group_Code,'
            SET @InsertIntoClause = @InsertIntoClause + 'Work_Group_ID,Work_Group_Code,'
            SET @InclMissPerFields=@InclMissPerFields + 'Work_Group_ID,Work_Group_Code,'
            SET @SelectColumns = @SelectColumns + 'Work_Group_Code AS Col' + CAST(@GroupBy1Col as varchar) + ','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab + 'Col' + CAST(@GroupBy1Col as varchar) + ' AS ''Work Group'' ' + ','
            SET @OrderByCrossTab = @OrderByCrossTab + '''Work Group''' + ','
            
            SET @SQL= 'ALTER TABLE #z_Cost ADD Work_Group_ID int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD Work_Group_Code varchar(70) NULL'
            EXEC(@SQL)
      END   
      ELSE IF @Column ='CCTR'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'ISNULL(Cost_Centre_ID,0),ISNULL(Cost_Centre_Code,'''+@ShowInsteadOfNull+'''),'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'Cost_Centre_ID,Cost_Centre_Code,'
            SET @InsertIntoClause = @InsertIntoClause + 'Cost_Centre_ID,Cost_Centre_Code,'
            SET @InclMissPerFields=@InclMissPerFields + 'Cost_Centre_ID,Cost_Centre_Code,'
            SET @SelectColumns = @SelectColumns + 'Cost_Centre_Code AS Col' + CAST(@GroupBy1Col as varchar) +','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab + 'Col' + CAST(@GroupBy1Col as varchar) + ' AS ''Cost Centre'' ' + ','
            SET @OrderByCrossTab = @OrderByCrossTab + '''Cost Centre''' + ','
            
            SET @SQL= 'ALTER TABLE #z_Cost ADD Cost_Centre_ID int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD Cost_Centre_Code varchar(70) NULL'
            EXEC(@SQL)
      END 
      ELSE IF @Column ='CRSP'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'ISNULL(Cost_Responsibility_ID,0), ISNULL(Cost_Responsibility_Code,'''+@ShowInsteadOfNull+'''),'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'Cost_Responsibility_ID, Cost_Responsibility_Code,'
            SET @InsertIntoClause = @InsertIntoClause + 'Cost_Responsibility_ID, Cost_Responsibility_Code,'
            SET @InclMissPerFields=@InclMissPerFields + 'Cost_Responsibility_ID, Cost_Responsibility_Code,'
            SET @SelectColumns= @SelectColumns+'Cost_Responsibility_Code AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab + 'Col' + CAST(@GroupBy1Col as varchar) + ' AS Responsibility ' + ','
            SET @OrderByCrossTab = @OrderByCrossTab + 'Responsibility' + ','
            
            SET @SQL= 'ALTER TABLE #z_Cost ADD Cost_Responsibility_ID int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD Cost_Responsibility_Code varchar(70) NULL'
            EXEC(@SQL)
      END   
      ELSE IF @Column ='CEXP'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'ISNULL(Cost_Expense_ID,0), ISNULL(Cost_Expense_Code,'''+@ShowInsteadOfNull+'''),'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'Cost_Expense_ID, Cost_Expense_Code,'
            SET @InsertIntoClause = @InsertIntoClause + 'Cost_Expense_ID, Cost_Expense_Code,'
            SET @InclMissPerFields=@InclMissPerFields + 'Cost_Expense_ID, Cost_Expense_Code,'
            SET @SelectColumns= @SelectColumns+'Cost_Expense_Code AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab + 'Col' + CAST(@GroupBy1Col as varchar) + ' AS ''Expense Element''' + ','
            SET @OrderByCrossTab = @OrderByCrossTab + '''Expense Element''' + ','
            
            SET @SQL= 'ALTER TABLE #z_Cost ADD Cost_Expense_ID int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD Cost_Expense_Code varchar(70) NULL'
            EXEC(@SQL)
      END 
      ELSE IF @Column ='LABA'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'ISNULL(LabourActivityId,0),ISNULL(ActivityCode,'''+@ShowInsteadOfNull+'''),'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'LabourActivityId,ActivityCode,'
            SET @InsertIntoClause = @InsertIntoClause + 'LabourActivityId,ActivityCode,'
            SET @InclMissPerFields=@InclMissPerFields + 'LabourActivityId,ActivityCode,'
            SET @SelectColumns= @SelectColumns+'ActivityCode AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab + 'Col' + CAST(@GroupBy1Col as varchar) + ' AS ''Labour Activity'' ' + ','
            SET @OrderByCrossTab = @OrderByCrossTab + '''Labour Activity''' + ','
            
            SET @SQL= 'ALTER TABLE #z_Cost ADD LabourActivityId int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD ActivityCode varchar(50) NULL'
            EXEC(@SQL)
      END 
      ELSE IF @Column ='PRTA'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'TaskHeaderId, ProjTask,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'TaskHeaderId, ProjTask,'
            SET @InsertIntoClause = @InsertIntoClause + 'TaskHeaderId, ProjTask,'
            SET @InclMissPerFields=@InclMissPerFields + 'TaskHeaderId, ProjTask,'
            SET @SelectColumns= @SelectColumns+'ProjTask AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab + 'Col' + CAST(@GroupBy1Col as varchar) + ' AS ''Strategy Task'' ' + ','
            SET @OrderByCrossTab = @OrderByCrossTab + '''Strategy Task''' + ','
               
            SET @SQL= 'ALTER TABLE #z_Cost ADD TaskHeaderId int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD ProjTask varchar(150) NULL'
            EXEC(@SQL)
      END 
      
      -- added for strategy task description
      ELSE IF @Column ='PRTD'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'Task_Description,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'Task_Description,'
            SET @InsertIntoClause = @InsertIntoClause + 'Task_Description,'
            SET @InclMissPerFields=@InclMissPerFields + 'Task_Description,'
            SET @SelectColumns= @SelectColumns+'Task_Description AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab + 'Col' + CAST(@GroupBy1Col as varchar) + ' AS ''Strategy Task Description'' ' + ','
            SET @OrderByCrossTab = @OrderByCrossTab + '''Strategy Task Description''' + ','
              
            --SET @SQL= 'ALTER TABLE #z_Cost ADD TaskHeaderId int NULL'
            --EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD Task_Description varchar(500) NULL'
            EXEC(@SQL)
      END 
       
      ELSE IF @Column ='MONH'
      BEGIN
            --SET @SQL1='RIGHT(CONVERT(VARCHAR(12),CONVERT(DATETIME,CONVERT(VARCHAR,CalenderPeriod)+''01'',112),113),9),'
            SET @SQL1='RIGHT(CONVERT(VARCHAR(12),CONVERT(DATETIME,CONVERT(VARCHAR,CalPer)+''01'',112),113),9),'
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'CalenderPeriod, '+ @SQL1
            SET @GroupBy1Clause2 = @GroupBy1Clause2 +'CalenderPeriod,CalPeriodDescr,'
            SET @InsertIntoClause = @InsertIntoClause + 'CalenderPeriod, CalPeriodDescr,'
            --If Analysing the variance (Projection1-Projection2) calender period will
            --be at the end of Select close before TotalCost
            IF @AnalyseVariance=0 SET @SelectColumns= @SelectColumns+' CalPeriodDescr AS Col'+ CAST(@GroupBy1Col as varchar)+','             
            
            IF @AnalyseVariance=1 SET @GroupBy1Col=@GroupBy1Col-1
            SET @SQL= 'ALTER TABLE #z_Cost ADD CalenderPeriod int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD CalPeriodDescr varchar(20) NULL'
            EXEC(@SQL)
            --Include missing calendar period
            SET @IncludeMissingCalenderPeriods=@Column
            
      END   
      ELSE IF @Column ='YEAR'
      BEGIN       
            --SET @SQL1='CAST(CalenderPeriod/100 AS varchar),'
            SET @SQL1='CAST(CalPer/100 AS varchar),'
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'CalenderPeriod/100, '+@SQL1
            SET @GroupBy1Clause2 = @GroupBy1Clause2 +'CalenderPeriod,CalPeriodDescr,'
            SET @InsertIntoClause = @InsertIntoClause + 'CalenderPeriod, CalPeriodDescr,'
            --If Analysing the variance (Projection1-Projection2) calender period will
            --be at the end of Select close before TotalCost
            IF @AnalyseVariance=0 SET @SelectColumns= @SelectColumns+' CalPeriodDescr AS Col'+ CAST(@GroupBy1Col as varchar)+','             
           
            IF @AnalyseVariance=1 SET @GroupBy1Col=@GroupBy1Col-1
            SET @SQL= 'ALTER TABLE #z_Cost ADD CalenderPeriod int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD CalPeriodDescr varchar(20) NULL'
            EXEC(@SQL)
            --Include missing calendar period
            SET @IncludeMissingCalenderPeriods=@Column
      END   
      ELSE IF @Column ='QRTR'
      BEGIN 
            --SET @SQL1 = @SQL1 + ' CAST(Left(CalenderPeriod,4) + CONVERT(varchar(1),((Right(CalenderPeriod,2)+2)/3)) AS int), '
            --SET @SQL1 = @SQL1 + 'Left(CalenderPeriod,4) + ''-Q'' + CONVERT(varchar(1),((Right(CalenderPeriod,2)+2)/3))  ,'
            SET @SQL1 = @SQL1 + ' CAST(Left(CalPer,4) + CONVERT(varchar(1),((Right(CalPer,2)+2)/3)) AS int), '
            SET @SQL1 = @SQL1 + 'Left(CalPer,4) + ''-Q'' + CONVERT(varchar(1),((Right(CalPer,2)+2)/3))  ,'
            SET @GroupBy1Clause1 = @GroupBy1Clause1 +@SQL1
            SET @GroupBy1Clause2 = @GroupBy1Clause2 +'CalenderPeriod,CalPeriodDescr,'
            SET @InsertIntoClause = @InsertIntoClause + 'CalenderPeriod, CalPeriodDescr,'
            --If Analysing the variance (Projection1-Projection2) calender period will
            --be at the end of Select close before TotalCost
            IF @AnalyseVariance=0 SET @SelectColumns= @SelectColumns+' CalPeriodDescr AS Col'+ CAST(@GroupBy1Col as varchar)+','           
            
            IF @AnalyseVariance=1 SET @GroupBy1Col=@GroupBy1Col-1
            SET @SQL= 'ALTER TABLE #z_Cost ADD CalenderPeriod int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD CalPeriodDescr varchar(20) NULL'
            EXEC(@SQL)
            --Include missing calendar period
            SET @IncludeMissingCalenderPeriods=@Column
      END   
      ELSE IF @Column ='PLM'
      BEGIN 
            SET @PLM=1  

            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'PLM_ID, PLM,'          
            SET @SelectColumns= @SelectColumns+'PLM AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab +'Col'+ CAST(@GroupBy1Col as varchar)+' AS ''Part/Lab/Misc'' ' + ','
            SET @OrderByCrossTab = @OrderByCrossTab +'''Part/Lab/Misc''' + ','

            SET @SQL= 'ALTER TABLE #z_Cost ADD PartsCost float NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD LabourCost float NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD MiscCost float NULL'
            EXEC(@SQL)
      END   

      ELSE IF @Column ='REGN'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'Region_Id, Region_Desc,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'Region_Id, Region_Desc,'
            SET @InsertIntoClause = @InsertIntoClause + 'Region_Id, Region_Desc,'
            SET @InclMissPerFields=@InclMissPerFields + 'Region_Id, Region_Desc,'
            SET @SelectColumns= @SelectColumns+'Region_Desc AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab +'Col'+ CAST(@GroupBy1Col as varchar)+' AS Region' + ','
            SET @OrderByCrossTab = @OrderByCrossTab +'Region' +','
             
            SET @SQL= 'ALTER TABLE #z_Cost ADD Region_Id int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD Region_Desc varchar(50) NULL'
            EXEC(@SQL)
      END 
      ELSE IF @Column ='DEVI'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'Division_Id, Division_Desc,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'Division_Id, Division_Desc,'
            SET @InsertIntoClause = @InsertIntoClause + 'Division_Id, Division_Desc,'
            SET @InclMissPerFields=@InclMissPerFields + 'Division_Id, Division_Desc,'
            SET @SelectColumns= @SelectColumns+'Division_Desc AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab + 'Col' + CAST(@GroupBy1Col as varchar) + ' AS Division' + ','
            SET @OrderByCrossTab = @OrderByCrossTab + 'Division' + ','
            
            SET @SQL= 'ALTER TABLE #z_Cost ADD Division_Id int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD Division_Desc varchar(50) NULL'
            EXEC(@SQL)
      END 
      ELSE IF @Column ='LCTN'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'Eqp_Location_Id, Eqp_Location_Desc,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'Eqp_Location_Id, Eqp_Location_Desc,'
            SET @InsertIntoClause = @InsertIntoClause + 'Eqp_Location_Id, Eqp_Location_Desc,'
            SET @InclMissPerFields=@InclMissPerFields + 'Eqp_Location_Id, Eqp_Location_Desc,'
            SET @SelectColumns= @SelectColumns+'Eqp_Location_Desc AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab + 'Col' + CAST(@GroupBy1Col as varchar) + ' AS ''Equipment Location''' + ','
            SET @OrderByCrossTab = @OrderByCrossTab + '''Equipment Location''' + ','
            
            
            SET @SQL= 'ALTER TABLE #z_Cost ADD Eqp_Location_Id int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD Eqp_Location_Desc varchar(50) NULL'
            EXEC(@SQL)
      END 
      ELSE IF @Column ='CRIT'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'Eqp_Criticality_Id, Eqp_Criticality_Desc,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'Eqp_Criticality_Id, Eqp_Criticality_Desc,'
            SET @InsertIntoClause = @InsertIntoClause + 'Eqp_Criticality_Id, Eqp_Criticality_Desc,'
            SET @InclMissPerFields=@InclMissPerFields + 'Eqp_Criticality_Id, Eqp_Criticality_Desc,'
            SET @SelectColumns= @SelectColumns+'Eqp_Criticality_Desc AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab + 'Col' + CAST(@GroupBy1Col as varchar) + ' AS ''Equipment Criticality'' ' + ','
            SET @OrderByCrossTab = @OrderByCrossTab + '''Equipment Criticality''' + ','
             
            SET @SQL= 'ALTER TABLE #z_Cost ADD Eqp_Criticality_Id int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD Eqp_Criticality_Desc varchar(50) NULL'
            EXEC(@SQL)
      END 
      ELSE IF @Column ='CTGR'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'Eqp_Category_Id, Eqp_Category_Desc,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'Eqp_Category_Id, Eqp_Category_Desc,'
            SET @InsertIntoClause = @InsertIntoClause + 'Eqp_Category_Id, Eqp_Category_Desc,'
            SET @InclMissPerFields=@InclMissPerFields + 'Eqp_Category_Id, Eqp_Category_Desc,'
            SET @SelectColumns= @SelectColumns+'Eqp_Category_Desc AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab + 'Col' + CAST(@GroupBy1Col as varchar) + ' AS ''Equipment Category'' ' + ','
            SET @OrderByCrossTab = @OrderByCrossTab +'''Equipment Category''' + ','
            
            SET @SQL= 'ALTER TABLE #z_Cost ADD Eqp_Category_Id int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD Eqp_Category_Desc varchar(50) NULL'
            EXEC(@SQL)
      END 
      ELSE IF @Column ='ECLS'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'Eqp_Class_Id, Eqp_Class_Desc,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'Eqp_Class_Id, Eqp_Class_Desc,'
            SET @InsertIntoClause = @InsertIntoClause + 'Eqp_Class_Id, Eqp_Class_Desc,'
            SET @InclMissPerFields=@InclMissPerFields + 'Eqp_Class_Id, Eqp_Class_Desc,'
            SET @SelectColumns= @SelectColumns+'Eqp_Class_Desc AS Col'+ CAST(@GroupBy1Col as varchar)+','
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab +'Col'+ CAST(@GroupBy1Col as varchar)+' AS ''Equipment Class'' ' + ','
            SET @OrderByCrossTab = @OrderByCrossTab +'''Equipment Class''' + ','
             
            SET @SQL= 'ALTER TABLE #z_Cost ADD Eqp_Class_Id int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD Eqp_Class_Desc varchar(50) NULL'
            EXEC(@SQL)
      END 
      ELSE IF @Column ='EGRP'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'Equipment_Group_Id, Equipment_Group_Desc,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'Equipment_Group_Id, Equipment_Group_Desc,'
            SET @InsertIntoClause = @InsertIntoClause + 'Equipment_Group_Id, Equipment_Group_Desc,'
            SET @InclMissPerFields=@InclMissPerFields + 'Equipment_Group_Id, Equipment_Group_Desc,'
            SET @SelectColumns= @SelectColumns+'Equipment_Group_Desc AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab +'Col'+ CAST(@GroupBy1Col as varchar)+' AS ''Equipment Group''' + ','
            SET @OrderByCrossTab = @OrderByCrossTab +'''Equipment Group''' + ','
            
            SET @SQL= 'ALTER TABLE #z_Cost ADD Equipment_Group_Id int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD Equipment_Group_Desc varchar(50) NULL'
            EXEC(@SQL)
      END 
      ELSE IF @Column ='ECCT'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'EqpCostCentreId, EqpCostCentre,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'EqpCostCentreId, EqpCostCentre,'
            SET @InsertIntoClause = @InsertIntoClause + 'EqpCostCentreId, EqpCostCentre,'
            SET @InclMissPerFields=@InclMissPerFields + 'EqpCostCentreId, EqpCostCentre,'
            SET @SelectColumns= @SelectColumns+'EqpCostCentre AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab +'Col'+ CAST(@GroupBy1Col as varchar)+' AS ''Equipment Cost Centre'' ' + ','
            SET @OrderByCrossTab = @OrderByCrossTab +'''Equipment Cost Centre''' + ','
            
            SET @SQL= 'ALTER TABLE #z_Cost ADD EqpCostCentreId int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD EqpCostCentre varchar(max) NULL'
            EXEC(@SQL)
      END 
      ELSE IF @Column ='CCAT'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'Cost_Category_Id, Cost_Category_Desc,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'Cost_Category_Id, Cost_Category_Desc,'
            SET @InsertIntoClause = @InsertIntoClause + 'Cost_Category_Id, Cost_Category_Desc,'
            SET @InclMissPerFields=@InclMissPerFields + 'Cost_Category_Id, Cost_Category_Desc,'
            SET @SelectColumns= @SelectColumns+'Cost_Category_Desc AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab +'Col'+ CAST(@GroupBy1Col as varchar)+' AS ''Cost Category''' + ','
            SET @OrderByCrossTab = @OrderByCrossTab +'''Cost Category''' + ','
             
            SET @SQL= 'ALTER TABLE #z_Cost ADD Cost_Category_Id int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD Cost_Category_Desc varchar(50) NULL'
            EXEC(@SQL)        
      END 
 
	--GD 10/10/11 E642     
      ELSE IF @Column ='CCCD'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'Cost_CategoryCode_Id, Cost_Category_Code,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'Cost_CategoryCode_Id, Cost_Category_Code,'
            SET @InsertIntoClause = @InsertIntoClause + 'Cost_CategoryCode_Id, Cost_Category_Code,'
            SET @InclMissPerFields=@InclMissPerFields + 'Cost_CategoryCode_Id, Cost_Category_Code,'
            SET @SelectColumns= @SelectColumns+'Cost_Category_Code AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab +'Col'+ CAST(@GroupBy1Col as varchar)+' AS ''Cost Category''' + ','
            SET @OrderByCrossTab = @OrderByCrossTab +'''Cost Category''' + ','
             
            SET @SQL= 'ALTER TABLE #z_Cost ADD Cost_CategoryCode_Id int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD Cost_Category_Code varchar(50) NULL'
            EXEC(@SQL)        
      END 


	--AL: 22/10/09
      ELSE IF @Column ='COBE'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'CostBearerID, CostBearer,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'CostBearerID, CostBearer,'
            SET @InsertIntoClause = @InsertIntoClause + 'CostBearerID, CostBearer,'
            SET @InclMissPerFields=@InclMissPerFields + 'CostBearerID, CostBearer,'
            SET @SelectColumns= @SelectColumns+'CostBearer AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab +'Col'+ CAST(@GroupBy1Col as varchar)+' AS CostBearer ' + ','
            SET @OrderByCrossTab = @OrderByCrossTab +'CostBearer' + ','
             
            SET @SQL= 'ALTER TABLE #z_Cost ADD CostBearerID int NULL'
            EXEC(@SQL)
            SET @SQL= 'ALTER TABLE #z_Cost ADD CostBearer varchar(50) NULL'
            EXEC(@SQL)        
      END 
      ELSE IF @Column ='CCAC'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'CC_Activity,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'CC_Activity,'
            SET @InsertIntoClause = @InsertIntoClause + 'CC_Activity,'
            SET @InclMissPerFields=@InclMissPerFields + 'CC_Activity,'
            SET @SelectColumns= @SelectColumns+'CC_Activity AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab +'Col'+ CAST(@GroupBy1Col as varchar)+' AS CC_Activity ' + ','
            SET @OrderByCrossTab = @OrderByCrossTab +'CC_Activity' + ','
             
            SET @SQL= 'ALTER TABLE #z_Cost ADD CC_Activity varchar(10) NULL'
            EXEC(@SQL)
      END 
      ELSE IF @Column ='CCLO'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'CC_Location,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'CC_Location,'
            SET @InsertIntoClause = @InsertIntoClause + 'CC_Location,'
            SET @InclMissPerFields=@InclMissPerFields + 'CC_Location,'
            SET @SelectColumns= @SelectColumns+'CC_Location AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab +'Col'+ CAST(@GroupBy1Col as varchar)+' AS CC_Location ' + ','
            SET @OrderByCrossTab = @OrderByCrossTab +'''CC_Location''' + ','
            
            SET @SQL= 'ALTER TABLE #z_Cost ADD CC_Location varchar(10) NULL'
            EXEC(@SQL)
      END 
      ELSE IF @Column ='CCRP'
      BEGIN
            SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'CC_Responsibility,'
            SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'CC_Responsibility,'
            SET @InsertIntoClause = @InsertIntoClause + 'CC_Responsibility,'
            SET @InclMissPerFields=@InclMissPerFields + 'CC_Responsibility,'
            SET @SelectColumns= @SelectColumns+'CC_Responsibility AS Col'+ CAST(@GroupBy1Col as varchar)+','
            
            SET @SelectQueryForCrossTab = @SelectQueryForCrossTab +'Col'+ CAST(@GroupBy1Col as varchar)+' AS CC_Responsibility ' + ','
            SET @OrderByCrossTab = @OrderByCrossTab +'CC_Responsibility' + ','
            
            SET @SQL= 'ALTER TABLE #z_Cost ADD CC_Responsibility varchar(10) NULL'
            EXEC(@SQL)
      END 
      ELSE IF @Column ='MDCO'
	  BEGIN
		SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'ModifierID, ModCode,'
		SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'ModifierID, ModCode,'
		SET @InsertIntoClause = @InsertIntoClause + 'ModifierID, ModCode,'
		SET @SelectColumns= @SelectColumns+'ModCode AS Col'+ CAST(@GroupBy1Col as varchar)+','
		SET @SQL= 'ALTER TABLE #z_Cost ADD ModifierID int NULL'
		EXEC(@SQL)
		SET @SQL= 'ALTER TABLE #z_Cost ADD ModCode varchar(150) NULL'
		EXEC(@SQL)
	 END	
	 ELSE IF @Column ='TACO'
	 BEGIN
		SET @GroupBy1Clause1 = @GroupBy1Clause1 + 'ApplicationCodeID, AppCode,'
		SET @GroupBy1Clause2 = @GroupBy1Clause2 + 'ApplicationCodeID, AppCode,'
		SET @InsertIntoClause = @InsertIntoClause + 'ApplicationCodeID, AppCode,'
		SET @SelectColumns= @SelectColumns+'AppCode AS Col'+ CAST(@GroupBy1Col as varchar)+','
		SET @SQL= 'ALTER TABLE #z_Cost ADD ApplicationCodeID int NULL'
		EXEC(@SQL)
		SET @SQL= 'ALTER TABLE #z_Cost ADD AppCode varchar(150) NULL'
		EXEC(@SQL)
	 END	
	 
      SET @Counter=CHARINDEX(',',@GroupBy1)
      SET @GroupBy1Col=@GroupBy1Col+1
END


--Add Null columns if Groupby contains less items then @GroupBy1ColMAX
WHILE @GroupBy1Col<=@GroupBy1ColMAX
BEGIN
      SET @SelectColumns= @SelectColumns+''''' AS Col'+ CAST(@GroupBy1Col as varchar)+','
      SET @GroupBy1Col=@GroupBy1Col+1
END

--Take out the coma at the end
IF LEN(@GroupBy1Clause1)>0 SET @GroupBy1Clause1=LEFT(@GroupBy1Clause1,LEN(@GroupBy1Clause1)-1)
IF LEN(@GroupBy1Clause2)>0 SET @GroupBy1Clause2=LEFT(@GroupBy1Clause2,LEN(@GroupBy1Clause2)-1)
IF LEN(@SelectColumns)>0 SET @SelectColumns=LEFT(@SelectColumns,LEN(@SelectColumns)-1)
IF LEN(@InsertIntoClause)>0 SET @InsertIntoClause=LEFT(@InsertIntoClause,LEN(@InsertIntoClause)-1)
IF LEN(@InclMissPerFields)>0 SET @InclMissPerFields=LEFT(@InclMissPerFields,LEN(@InclMissPerFields)-1)

--Insert into temporary table the actual costs 
SET @SQL1 =   ' INSERT INTO #z_Cost'  + '('+@AnalyseByFld+
CASE @PLM WHEN 1 THEN ', PartsCost, LabourCost,MiscCost'
        ELSE ', Cost' END +
        CASE WHEN @InsertIntoClause='' THEN ''
             ELSE ', '+@InsertIntoClause END+')'

SET @SQL1 =  @SQL1 + ' SELECT '
SET @SQL1 =  @SQL1 + @AnalyseByFld2+ ', '


IF @PLM=0
            SET @SQL1 =  @SQL1 + ' 0 '
       

IF @PartsLabourMisc & 1 = 1
BEGIN
      IF @PLM=0
            SET @SQL1 =  @SQL1 +  ' + SUM(PrimePartsSell)'
      ELSE
            SET @SQL1 =  @SQL1 +  ' SUM(PrimePartsSell),'
END
ELSE
      IF @PLM=1
            SET @SQL1 =  @SQL1 +  ' 0,'

IF @PartsLabourMisc & 2 = 2
BEGIN
      IF @PLM=0
            SET @SQL1 =  @SQL1 +  ' + SUM(PrimeLabourSell)'
      ELSE
            SET @SQL1 =  @SQL1 +  ' SUM(PrimeLabourSell), '
END   
ELSE
      IF @PLM=1
            SET @SQL1 =  @SQL1 +  ' 0,'

IF @PartsLabourMisc & 4 = 4
BEGIN 
      IF @PLM=0
            SET @SQL1 =  @SQL1 +  ' + SUM(PrimeMiscSell)'
      ELSE
            SET @SQL1 =  @SQL1 +  '  SUM(PrimeMiscSell)'
END
ELSE
      IF @PLM=1
            SET @SQL1 =  @SQL1 +  ' 0'


SET @GroupBy1Clause1 = REPLACE(@GroupBy1Clause1, 'Cost_CategoryCode_Id', 'Cost_Category_Id')
SET @SQL1 =  @SQL1 + CASE WHEN @GroupBy1Clause1='' THEN '' ELSE ', '+ @GroupBy1Clause1 END



SET @SQL2 =  @Where_Clause + ' GROUP BY ' + CASE WHEN @GroupBy1Clause1='' THEN '' 
                                     ELSE @GroupBy1Clause1 +  ', ' END + @AnalyseByFld2


-- print @SQL1 + ' FROM RPT_COST_COMPARISON_ACTUAL_V ' + @SQL2
-- print @SQL1 + ' FROM RPT_COST_COMPARISON_PROJ_V ' + @SQL2
--  return

--AL: 19/09/08
DECLARE @SQLT varchar(MAX)

IF @ActualProjected & 1 = 1
BEGIN
      SET @SQLT=' FROM
                              (SELECT *,left(convert(varchar,dateadd(month,-1*' + convert(varchar,@YearStartMonth) + ', convert(datetime,convert(varchar,calenderperiod) + ''01'',112)),112),6)  AS CalPer
                              FROM RPT_COST_COMPARISON_ACTUAL_V) A '
      EXEC(@SQL1 + @SQLT + @SQL2)
      --    EXEC(@SQL1 + ' FROM RPT_COST_COMPARISON_ACTUAL_V ' + @SQL2)
END



IF @ActualProjected & 2 = 2
BEGIN
      SET @SQLT=' FROM
                              (SELECT *,left(convert(varchar,dateadd(month,-1*' + convert(varchar,@YearStartMonth) + ', convert(datetime,convert(varchar,calenderperiod) + ''01'',112)),112),6)    AS CalPer
                              FROM RPT_COST_COMPARISON_PROJ_V) A '
      EXEC(@SQL1 + @SQLT + @SQL2)

--    EXEC(@SQL1 + ' FROM RPT_COST_COMPARISON_PROJ_V ' + @SQL2)
END



--If Analyse By date insert the missing calender periods
IF @IncludeMissingCalenderPeriods IS NOT NULL
BEGIN
	/*VV CR9009*/
	SELECT * INTO #z_Cost2 FROM #z_Cost
	
      IF @AnalyseBy = 'PRTY'
      BEGIN
            SET @SQL1=' CalenderPeriod,CalPeriodDescr'
            SET @SQL2=CASE @IncludeMissingCalenderPeriods
              WHEN 'MONH' THEN 'rm.Calendar_Period,rm.MonthDescr'
              WHEN 'QRTR' THEN 'rm.QuarterPer,rm.Quarter'
              WHEN 'YEAR' THEN 'CAST(rm.Year as int),rm.Year'           
              END
      END
      ELSE
      BEGIN
            SET @SQL1=' CalenderPeriod'
            SET @SQL2='rm.Calendar_Period'
      END 

      

      SET @Where_Clause=CASE @IncludeMissingCalenderPeriods
              WHEN 'MONH' THEN 'rm.Calendar_Period'
              WHEN 'QRTR' THEN 'rm.QuarterPer'
              WHEN 'YEAR' THEN 'CAST(rm.Year as int)'
              ELSE ''
              END
      
      
      --Select the missing calender periods into a temporary table
      SET @SQL =  ' INSERT INTO #z_Cost(' + @SQL1 + ',Cost'
      SET @SQL= @SQL + CASE @InclMissPerFields 
                     WHEN '' THEN ')'
                   ELSE ', '+ @InclMissPerFields + ')'
                   END
      SET @SQL = @SQL + ' SELECT '+@SQL2+',0' 
      SET @SQL= @SQL + CASE @InclMissPerFields 
                     WHEN '' THEN ''
                   ELSE ', '+ @InclMissPerFields + ''
                   END
      SET @SQL = @SQL + ' FROM REPORT_MONTH_V rm '
      SET @SQL= @SQL + CASE @InclMissPerFields 
                     WHEN '' THEN ''
                   ELSE ' CROSS JOIN (SELECT DISTINCT '+ @InclMissPerFields + ' FROM #z_Cost2/*VV CR9009*/) A'
                   END
            
      SET @SQL = @SQL + ' WHERE ('+@Where_Clause+' NOT IN'
      SET @SQL = @SQL + ' (SELECT DISTINCT CalenderPeriod'
      SET @SQL = @SQL + ' FROM  #z_Cost2/*VV CR9009*/'  + '))'
      /*DA E#641*/
      If (@iEquipEStartDate > @StartDate)
		BEGIN
		SET @SQL = @SQL + ' AND (rm.Calendar_Period BETWEEN ' + Convert(varchar(6),@iEquipEStartDate) + ' AND ' + Convert(varchar(6),@EndDate) + ')'
		END
      ELSE
		BEGIN
		SET @SQL = @SQL + ' AND (rm.Calendar_Period BETWEEN ' + Convert(varchar(6),@StartDate) + ' AND ' + Convert(varchar(6),@EndDate) + ')'
		END
            
      SET @SQL = @SQL + ' GROUP BY '+ @SQL2 
      SET @SQL= @SQL + CASE @InclMissPerFields 
                     WHEN '' THEN ''
                   ELSE ', '+ @InclMissPerFields 
                   END
      --Test
      --delete  from #z_Cost Where CalenderPeriod=@StartDate
--    drop table z_Cost
--    select * into z_Cost from #z_Cost
--    select *  from #z_Cost
--    print(@SQL)
--    return
      EXEC(@SQL)
      
      /*VV CR9009*/
      DROP TABLE #z_Cost2
END   
      

IF ISNULL(@GroupingByParentEqp,0) = 1
BEGIN

      CREATE TABLE #aa_EqpTemp(
                              [EqpPlanId] [int] PRIMARY KEY,
                              [ParentEqpPlanID] [int])

      SET @Eqp_Where_Clause = ' WHERE 1=1 '

      If @EqpPlanID <> '' SET @Eqp_Where_Clause = @Eqp_Where_Clause + ' AND EqpPlanID IN (' + @EqpPlanID + ' )'
      If @FleetID <> '' SET @Eqp_Where_Clause = @Eqp_Where_Clause + ' AND FleetID IN (' + @FleetID + ' )'
      If @SiteID <> '' SET @Eqp_Where_Clause = @Eqp_Where_Clause + ' AND SiteID IN (' + @SiteID + ' )'
      If @BranchId <> '' SET @Eqp_Where_Clause = @Eqp_Where_Clause + ' AND BranchId IN (' + @BranchId + ' )'
      If @DealerId > 0 SET @Eqp_Where_Clause = @Eqp_Where_Clause + ' AND DealerId = ' + Convert(varchar, @DealerId)
      If @Projection_Header_Id <> '' SET @Eqp_Where_Clause = @Eqp_Where_Clause + ' AND ProjHeaderId IN (' + @Projection_Header_Id + ')'
      If @ModelId <> '' SET @Eqp_Where_Clause = @Eqp_Where_Clause + ' AND ModelId IN (' + @ModelId + ')'
      IF @CostResponsibilityID <>'' SET @Where_Clause = @Where_Clause + ' AND Cost_Responsibility_ID IN (' + @CostResponsibilityID + ')'            
      IF @RegionId <>'' SET @Where_Clause = @Where_Clause + ' AND Region_Id IN (' + @RegionId + ')'           
      IF @DivisionId <>'' SET @Where_Clause = @Where_Clause + ' AND Division_Id IN (' + @DivisionId + ')'           
      IF @EqpLocationId <>'' SET @Eqp_Where_Clause = @Eqp_Where_Clause + ' AND Eqp_Location_Id IN (' + @EqpLocationId + ')'
      IF @CriticalityId <>'' SET @Eqp_Where_Clause = @Eqp_Where_Clause + ' AND Eqp_Criticality_Id IN (' + @CriticalityId + ')'           
      IF @EqpCategoryId <>'' SET @Eqp_Where_Clause = @Eqp_Where_Clause + ' AND Eqp_Category_Id IN (' + @EqpCategoryId + ')'              
      IF @EqpClassId <>'' SET @Eqp_Where_Clause = @Eqp_Where_Clause + ' AND Eqp_Class_Id IN (' + @EqpClassId + ')'            
      IF @EqpGroupId <>'' SET @Eqp_Where_Clause = @Eqp_Where_Clause + ' AND Equipment_Group_Id IN (' + @EqpGroupId + ')'              
	  IF @EqpCostCentre <>'' SET @Where_Clause = @Where_Clause + ' AND EqpCostCentreId IN (' + @EqpCostCentre + ')'
	  IF @CostCategoryId <>'' SET @Where_Clause = @Where_Clause + ' AND Cost_Category_Id IN (' + @CostCategoryId + ')'
	  IF @ContractId <>'' SET @Eqp_Where_Clause = @Eqp_Where_Clause + ' AND ContractId IN (' + @ContractId + ')'

      IF ISNULL(@ParentEquipmentID,'')<>''
            SET @Eqp_Where_Clause = @Eqp_Where_Clause + ' AND EqpPlanID IN (SELECT EqpPlanID FROM dbo.EQP_SIBLINGS_F('+@ParentEquipmentID+')) '

	  If @ManufacturerID <> '' SET @Where_Clause = @Where_Clause + ' AND ManufacturerId IN (' + @ManufacturerID + ')'

      SET @SQL =   ' INSERT INTO #aa_EqpTemp'  + '  (EqpPlanId,ParentEqpPlanID)'
      SET @SQL =  @SQL + ' SELECT EqpPlanId,NULL'
                        
      EXEC(@SQL +  ' FROM EQUIPMENT_HIERARCHY_V ' +  @Eqp_Where_Clause)

      --1: get list of children saved within ParentEqpPlan(Id) columns
      DECLARE @selection varchar(max)
      SET @selection= REPLACE(REPLACE((select EqpPlanId from #aa_EqpTemp for xml raw),'<row EqpPlanId="',''),'"/>',',')

      --2: reset values in ParentEqpPlanId columns with actual top most parent ID
      UPDATE #aa_EqpTemp 
      SET ParentEqpPlanId  = dbo.GET_TOPMOST_PARENT_EQUIPMENT_F(EqpPlanId,@selection)                 

      --3: update ParentEqpPlan name

      UPDATE CCT 
      SET         parenteqpplanid = ET.ParentEqpPlanID,
                  parenteqpplan = EP.EqpPlan
      FROM 
                  #z_Cost CCT INNER JOIN
                  #aa_EqpTemp ET ON CCT.ParentEqpPlanId =ET.EqpPlanID INNER JOIN
                  tblEqpPlans EP ON ET.ParentEqpPlanID=EP.EqpPlanID

      DROP TABLE #aa_EqpTemp
END

-- select * into z_Cost From #z_Cost
-- Return

--VVV
IF @PLM=1
BEGIN
      SET @Table=CASE @PartsLabourMisc             
            
            WHEN @Parts THEN

                  '( SELECT '+@AnalyseByFld+ ', 1 AS PLM_ID,''Parts'' AS PLM, PartsCost AS Cost '+                 
                    CASE @InsertIntoClause WHEN '' THEN ''
                          ELSE ', '+@InsertIntoClause END +' FROM #z_Cost) A' 
                   
            WHEN @Labour THEN

                  '( SELECT '+@AnalyseByFld+ ', 2 AS PLM_ID,''Labour'' AS PLM, LabourCost AS Cost '+                 
                    CASE @InsertIntoClause WHEN '' THEN ''
                          ELSE ', '+@InsertIntoClause END +' FROM #z_Cost) A' 
            WHEN @Misc THEN

                  '( SELECT '+@AnalyseByFld+ ', 3 AS PLM_ID,''Misc'' AS PLM, MiscCost AS Cost '+                
                    CASE @InsertIntoClause WHEN '' THEN ''
                          ELSE ', '+@InsertIntoClause END +' FROM #z_Cost) A' 
            WHEN @Parts + @Labour THEN
                  '( SELECT '+@AnalyseByFld+ ', 1 AS PLM_ID,''Parts'' AS PLM, PartsCost AS Cost '+                 
                    CASE @InsertIntoClause WHEN '' THEN ''
                          ELSE ', '+@InsertIntoClause END +' FROM #z_Cost '+
                  ' UNION ALL '+
                  'SELECT '+@AnalyseByFld+ ', 2 AS PLM_ID,''Labour'' AS PLM, LabourCost AS Cost '+                 
                    CASE @InsertIntoClause WHEN '' THEN ''
                          ELSE ', '+@InsertIntoClause END +' FROM #z_Cost) B'
            WHEN @Parts + @Misc THEN      
                  '( SELECT '+@AnalyseByFld+ ', 1 AS PLM_ID,''Parts'' AS PLM, PartsCost AS Cost '+                 
                    CASE @InsertIntoClause WHEN '' THEN ''
                          ELSE ', '+@InsertIntoClause END +' FROM #z_Cost '+
                  ' UNION ALL '+
                  'SELECT '+@AnalyseByFld+ ', 3 AS PLM_ID,''Misc'' AS PLM, MiscCost AS Cost '+                
                    CASE @InsertIntoClause WHEN '' THEN ''
                          ELSE ', '+@InsertIntoClause END +' FROM #z_Cost) B' 
            WHEN @Labour + @Misc THEN
                  '( SELECT '+@AnalyseByFld+ ', 2 AS PLM_ID,''Labour'' AS PLM, LabourCost AS Cost '+                 
                    CASE @InsertIntoClause WHEN '' THEN ''
                          ELSE ', '+@InsertIntoClause END +' FROM #z_Cost '+ 
                  ' UNION ALL '+
                  'SELECT '+@AnalyseByFld+ ', 3 AS PLM_ID,''Misc'' AS PLM, MiscCost AS Cost '+                
                    CASE @InsertIntoClause WHEN '' THEN ''
                          ELSE ', '+@InsertIntoClause END +' FROM #z_Cost) B'       
      
            ELSE
                  '( SELECT '+@AnalyseByFld+ ', 1 AS PLM_ID,''Parts'' AS PLM, PartsCost AS Cost '+                 
                    CASE @InsertIntoClause WHEN '' THEN ''
                          ELSE ', '+@InsertIntoClause END +' FROM #z_Cost '+
                    ' UNION ALL '+
                    'SELECT '+@AnalyseByFld+ ', 2 AS PLM_ID,''Labour'' AS PLM, LabourCost AS Cost '+                 
                    CASE @InsertIntoClause WHEN '' THEN ''
                          ELSE ', '+@InsertIntoClause END +' FROM #z_Cost '+
                    ' UNION ALL '+
                    'SELECT '+@AnalyseByFld+ ', 3 AS PLM_ID,''Misc'' AS PLM, MiscCost AS Cost '+                
                    CASE @InsertIntoClause WHEN '' THEN ''
                          ELSE ', '+@InsertIntoClause END +' FROM #z_Cost) B' 
            END
      
END
ELSE
BEGIN
      SET @Table='#z_Cost B'
END

--exec('SELECT * FROM ' + @Table)

IF @AnalyseBy = 'MONH' 
BEGIN
      SET @SQL =  ' SELECT ' 
      SET @SQL = @SQL + @SelectColumns +', '
      SET @SQL = @SQL +' CalenderPeriod, '
      /*VV #1315*/
      SET @SQL =@SQL+CASE @ShowPeriods WHEN 1 THEN 
		'RIGHT(CAST(CalenderPeriod AS varchar(10)),2)+''-''+LEFT(CAST(CalenderPeriod AS varchar(10)),4) AS CalPeriodDescr,'
      ELSE 
		'RIGHT(CONVERT(VARCHAR(12),CONVERT(DATETIME,CONVERT(VARCHAR,CalenderPeriod)+''01'',112),113),9) AS CalPeriodDescr,'
      END
	
      SET @SQL = @SQL + ' CAST(SUM(Cost) as Decimal(38,3)) AS TotalCost   FROM ' + @Table 
      SET @SQL = @SQL + ' GROUP BY '+ @GroupBy1Clause2+',CalenderPeriod,' 
      SET @SQL = @SQL + 'RIGHT(CONVERT(VARCHAR(12),CONVERT(DATETIME,CalenderPeriod +''01'',112),113),9)'
      SET @SQL = @SQL + ' ORDER BY CalenderPeriod '
      
END
ELSE IF @AnalyseBy = 'QRTR' 
BEGIN
      SET @SQL =  ' SELECT '
      SET @SQL = @SQL + @SelectColumns +', '
      SET @SQL = @SQL + ' CAST(Left(CalenderPeriod,4) + CONVERT(varchar(1),((Right(CalenderPeriod,2)+2)/3)) AS int) as  CalenderPeriod, '
      SET @SQL = @SQL + 'Left(CalenderPeriod,4) + ''-Q'' + CONVERT(varchar(1),((Right(CalenderPeriod,2)+2)/3)) as CalPeriodDescr ,'
      SET @SQL = @SQL + ' CAST(SUM(Cost) as Decimal(38,3)) AS TotalCost FROM ' + @Table   
      SET @SQL = @SQL + ' GROUP BY '+ @GroupBy1Clause2 + ', '
      SET @SQL = @SQL + ' CAST(Left(CalenderPeriod,4) + CONVERT(varchar(1),((Right(CalenderPeriod,2)+2)/3)) AS int), '
      SET @SQL = @SQL + ' Left(CalenderPeriod,4) + ''-Q'' + CONVERT(varchar(1),((Right(CalenderPeriod,2)+2)/3)) '
      SET @SQL = @SQL + ' ORDER BY Left(CalenderPeriod,4) + ''-Q'' + CONVERT(varchar(1),((Right(CalenderPeriod,2)+2)/3)) '
      
END
ELSE IF @AnalyseBy = 'YEAR'  
BEGIN
      SET @SQL =  ' SELECT '
      SET @SQL = @SQL + @SelectColumns +', '
      SET @SQL = @SQL +' CalenderPeriod/100 as  CalenderPeriod, CAST(CalenderPeriod/100 AS varchar) AS CalPeriodDescr ,'
      SET @SQL = @SQL + ' CAST(SUM(Cost) as Decimal(38,3)) AS TotalCost FROM ' + @Table   
      SET @SQL = @SQL + ' GROUP BY '+ @GroupBy1Clause2+',CalenderPeriod/100, CAST(CalenderPeriod/100 AS varchar)'
      SET @SQL = @SQL + ' ORDER BY CalenderPeriod/100 '
      
END
ELSE IF @AnalyseBy = 'PRTY'
BEGIN
      
      --Find ID for the first Projection  
      DECLARE @HeaderID varchar(20)
      SET @HeaderID=LEFT(@Projection_Header_Id,CHARINDEX(',',@Projection_Header_Id)-1)
      
      --Return Costs
      SET @SQL = 'SELECT '
      SET @SQL = @SQL + @SelectColumns +', '
      
      SET @SQL = @SQL + CASE @AnalyseVariance               
                    WHEN 0 THEN ' CAST(SUM(Cost1) as Decimal(38,3)) AS Cost1, CAST(SUM(Cost2) as Decimal(38,3)) AS Cost2'
                    ELSE ' CalenderPeriod,CalPeriodDescr, CAST(SUM(Cost1)-SUM(Cost2) as Decimal(38,3)) AS TotalCost '
                      END
      
      SET @SQL = @SQL + ' FROM (SELECT '
      SET @SQL = @SQL + @GroupBy1Clause2 +', '
      SET @SQL = @SQL + ' SUM(CASE Projection_Header_ID WHEN '+ @HeaderID +' THEN Cost ELSE 0 END) AS Cost1, '
      SET @SQL = @SQL + ' SUM(CASE Projection_Header_ID WHEN '+ @HeaderID +' THEN 0 ELSE Cost END) AS Cost2 '
      SET @SQL = @SQL + 'FROM  ' + @Table
      SET @SQL = @SQL + ' GROUP BY ' + @GroupBy1Clause2
      SET @SQL = @SQL + ', Projection_Header_ID) A '
      SET @SQL = @SQL + ' GROUP BY ' + @GroupBy1Clause2
      SET @SQL = @SQL + CASE RIGHT(@GroupBy,4)
                    WHEN 'MONH' THEN ' ORDER BY CalenderPeriod'
                    WHEN 'QRTR' THEN ' ORDER BY CalenderPeriod'
                    WHEN 'YEAR' THEN ' ORDER BY CalenderPeriod'
                    ELSE ' HAVING SUM(Cost1)<>0 OR SUM(Cost2)<>0 ORDER BY '+@GroupBy1Clause2
                    END
      --Return the Projection names
      SET @Name1=(SELECT Projection_Name FROM PROJECTION_HEADER WHERE Projection_Header_ID=CAST(@HeaderID AS int))
      SET @Counter=LEN(@Projection_Header_Id)-LEN(@HeaderID)-1
      SET @HeaderID=RIGHT(@Projection_Header_Id,@Counter)
      SET @Name2=(SELECT Projection_Name FROM PROJECTION_HEADER WHERE Projection_Header_ID=CAST(@HeaderID AS int))
END

-- print @SQL
--return
--KN 2220 : Error in Actual vs Archive Analysis report
IF(@ISCrossTab = 'true')
	BEGIN
			CREATE TABLE [#temp](
				[Col1] [varchar](max) COLLATE DATABASE_DEFAULT NULL,
				[CalendarPeriod] [varchar](max) COLLATE DATABASE_DEFAULT NULL,
				[CalPeriodDescr] [varchar](max) COLLATE DATABASE_DEFAULT NULL,
				[TotalCost] [float],
				[Col2] [varchar](max) COLLATE DATABASE_DEFAULT NULL,
				[Col3] [varchar](max) COLLATE DATABASE_DEFAULT NULL,
				[Col4] [varchar](max) COLLATE DATABASE_DEFAULT NULL,
				[Col5] [varchar](max) COLLATE DATABASE_DEFAULT NULL
			) ON [PRIMARY]
			 
			INSERT INTO #temp( Col1 , Col2,Col3,Col4 ,Col5 ,CalendarPeriod , CalPeriodDescr , TotalCost) 
			EXEC(@SQL)
				
			DECLARE @ListCol VARCHAR(MAX)
			DECLARE @Query VARCHAR(MAX)

			SELECT  @ListCol = STUFF(( SELECT DISTINCT  '],[' + CalendarPeriod  FROM   #temp
									ORDER BY '],[' + CalendarPeriod ASC
									FOR XML PATH('') ), 1, 2, '') + ']'

			SET @Query ='SELECT * FROM ( SELECT '+@SelectQueryForCrossTab +' CalendarPeriod,TotalCost from #temp WHERE TotalCost!=0) tmp PIVOT (SUM(TotalCost) for CalendarPeriod in('+@ListCol+')) AS pvt
						 ORDER BY ' + SUBSTRING(@OrderByCrossTab,1,LEN(@OrderByCrossTab)-1)
			print @Query
			EXECUTE (@Query)
	END
ELSE
	EXEC(@SQL)

GO


if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[STD_JOB_COPY_TO_PROJ_TASK_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[STD_JOB_COPY_TO_PROJ_TASK_P]
GO


 
create              PROCEDURE  STD_JOB_COPY_TO_PROJ_TASK_P
/******************************************************************************
	Name: STD_JOB_COPY_TO_PROJ_TASK_P

	Called By: Wizard - Create projected tasks

	
             

	Auth: Veronika Vasylyeva
	Date: 07-Jul-05
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	07 May 2012	K Nagarajan	3919: Add new task type Logic.
	03 Apr 2012	K Nagarajan	3922: Error while Update Shop/Labour from New Job Codes
	03 Apr 2012	K Nagarajan	3926: Error while updating Strategy Task from Standard Jobs
	13 Feb 2012	K Nagarajan	E725: Routine to create Strategy Tasks from Standard Jobs
	 2/02/10	VV			CR8759 Took out check for part type
	17/09/08	AL			removed links to tblqualifier and tbluoms
	16/09/08	AL			Removed UsageUOMID
	21-Jul-07	KN			Fixed - Collation and tempDB Conflicts
	19 Jan 07	V Vasylyeva	Changed to support date based tasks and simple/no utilisation methods
	13 Nov 06	SI		Changed to support date based tasks
	10 Nov 06	SI		Changed to support simple/no utilisation equipments
	12 Jul 06	V Vasylyeva	Added relinking to EQS tasks	
	07 Apr 06	A Lassauniere	Removed laborshare=null from usp_Add_Proj_Task_Amount call to have it set to default val of 100 (also Null insert fails)
	16 Sep 05	V Vasylyeva	Added Parts Cost Expense
	01 Aug 05	V Vasylyeva	Added Check for the required fields for proj tasks (Validation 1a)
	26-Jul-05	V Vasylyeva	Proj Task options fix
*******************************************************************************/
	/* Param List */

@BranchID varchar(8000)='',
@SiteID varchar(8000)='',
@FleetID varchar(8000)='',
@EqpPlanID varchar(8000)='',
@ModelID  varchar(8000)='',
@ProjHeaderID varchar(8000),
@StdJobsCopy varchar(8000),
@UpdateExisting bit=0,
@Message varchar(8000)='' OUTPUT,
@RetValue int =0 OUTPUT

AS

SET NOCOUNT ON

DECLARE @SQL varchar(8000)
DECLARE @Where varchar(8000)
DECLARE @msgStdJob varchar(8000)
DECLARE @CreateMsg bit
DECLARE @ProjTaskId int
DECLARE @PricedJobId int
DECLARE @EqpProjId int
DECLARE @CEqpPlanID int
DECLARE @ComponentCodeId int
DECLARE @ModifierCodeId int
DECLARE @TaskTypeId int
DECLARE @ApplicationCodeID int
DECLARE @QUOM_ID int
DECLARE @Not_After float
DECLARE @Last_Change_Usage float
DECLARE @Last_Change_Date datetime
DECLARE @Use_Rotable bit
DECLARE @Rotable_Part_Id int
DECLARE @Group_No varchar(50)
DECLARE @Planning_Task bit
DECLARE @Lead_Days int
DECLARE @Projection_Type_ID int
DECLARE @ProjTypeBudget int
DECLARE @ProjTypeCurrent int
DECLARE @ProjTypeEstimateCurrent int
DECLARE @ProjTypeEstimateDraft int
DECLARE @Default_Cost_Bearer_ID int
DECLARE @Dummy_Job bit
DECLARE @JobCodeId int 
DECLARE @Occurrence_Type_Id int 
DECLARE @Option_Pobability real
DECLARE @Job_Default_Option bit 
DECLARE @Labour_Hrs float
DECLARE @Duration_Hrs float 
DECLARE @Pricing_Date datetime 
DECLARE @Part_Type_ID int 
DECLARE @Labour_Activity_ID int
DECLARE @Default_First float
DECLARE @Default_Interval float
DECLARE @ProjTaskOptId int
DECLARE @PlannedOption smallint
DECLARE @CBranchID int
DECLARE @Price_Group_ID int
DECLARE @LabourCost float
DECLARE @PartsCost float 
DECLARE @MiscCost float 
DECLARE @LabourHours float
DECLARE @DurationHours float
DECLARE @Currency_ID int
DECLARE @Proj_Pricing_Date datetime
DECLARE @Part_Id int
DECLARE @Manufacturer_Id int
DECLARE @NewProjTask bit
DECLARE @UsageMethod char(1)
DECLARE @UnassignedTaskType int
DECLARE @CFleetID int
DECLARE @CostExpenseID int
DECLARE @UtilMethod_Smpl int
DECLARE @UtilMethod_NoUtl int
DECLARE @UtilMethod_Adv int
DECLARE @COMA char(2)
DECLARE @MAXMessageLen int
DECLARE @SchLastPerformedUOM int
DECLARE @SchLastPerformedDate int
DECLARE @Schedule_Type_Id int
DECLARE @CounterT int
DECLARE @CounterO int
DECLARE @ModelIdC int
DECLARE @Labour_Hrs_Field bit
DECLARE @Filter_Std_Job_Model bit
DECLARE @StartingSerialNo INT
SET @SchLastPerformedUOM=1
SET @SchLastPerformedDate=3

SET @MAXMessageLen=8000


SET @COMA=', '
SET @UtilMethod_Adv =1
SET @UtilMethod_Smpl =2
SET @UtilMethod_NoUtl =3

SET @UnassignedTaskType=1 

SET @UsageMethod='U'

SET @ProjTypeCurrent =1
SET @ProjTypeBudget =2
SET @ProjTypeEstimateCurrent =6
SET @ProjTypeEstimateDraft =7


set @Message=''
SET @CreateMsg=0

--Create a temporary table for the Std Jobs to copy
CREATE TABLE [#z_tblStdJobs] (
	[StdJobId] [int]  ,
	[StdJob] [varchar] (500) COLLATE database_default,
	[ModelId] [int]  ,	
	[Dummy_Job] [bit]  ,	
	[ComponentCodeId] [int]  ,
	[ModifierCodeId] [int]  ,
	[JobCodeId] [int]  ,
	[TaskTypeId] [int]  ,
	[ApplicationCodeID] [int]  ,
	[Occurrence_Type_Id] [int]  ,
	[Option_Pobability] [float]  ,
	[Job_Default_Option] [bit]  ,	
	[Currency_ID] [int]  ,	
	[Job_Quantity] [int]  ,	
	[Parts_Cost] [float]  ,
	[Labour_Cost] [float]  ,
	[Misc_Cost] [float]  ,
	[Labour_Hrs] [float]  ,
	[Duration_Hrs] [float]  ,	
	[Group_No] [varchar] (50) COLLATE database_default,
	[Use_Rotable] [bit]  ,
	[Rotable_Part_Id] [int]  ,
	[Default_First] [float]  ,
	[Default_Interval] [float]  ,
	[QUOM_ID] [int]  ,	
	[Planning_Task] [bit]  ,
	[Lead_Days] [int]  ,
	[Not_After] [float]  ,	
	[Use_Std_Job] [bit]  ,
	[Pricing_Date] [datetime]  ,
	[Part_Type_ID] [int]  ,
	[Labour_Activity_ID] [int], 
	[Manufacturer_Id] [int],
	[Cost_Expense_ID] [int],
	PRIMARY KEY(StdJobId)) 

/*KN 3919: Add new Task type Logic */
SET @SQL='SELECT
SJ.StdJobId,SJ.StdJob,SJ.ModelId,SJ.Dummy_Job,SJ.ComponentCodeId,SJ.ModifierCodeId,SJ.JobCodeId,
CASE WHEN SJ.TaskTypeId = 0 THEN 
	( CASE WHEN ISNULL(JC.DefaultTaskTypeId,0) = 0 THEN ISNULL(DTT.TaskTypeID,0)
	  ELSE JC.DefaultTaskTypeId	END)
ELSE SJ.TaskTypeId END  AS TaskTypeId,
SJ.ApplicationCodeID,SJ.
Occurrence_Type_Id,SJ.Option_Pobability,SJ.Job_Default_Option,SJ.Currency_ID,SJ.Job_Quantity,SJ.Parts_Cost,SJ.Labour_Cost,SJ.
Misc_Cost,SJ.Labour_Hrs,SJ.Duration_Hrs,SJ.Group_No,SJ.Use_Rotable,SJ.Rotable_Part_Id,SJ.Default_First,SJ.Default_Interval,SJ.
QUOM_ID,SJ.Planning_Task,SJ.Lead_Days,SJ.Not_After,SJ.Use_Std_Job,SJ.Pricing_Date,SJ.
Part_Type_ID,SJ.Labour_Activity_ID,SJ.Manufacturer_Id,SS.Cost_Expense_ID 
FROM 
tblComponentCodes CC 
	INNER JOIN
tblStdJobs SJ 
	ON CC.ComponentCodeID = SJ.ComponentCodeId 
	INNER JOIN
tblSubSystems SS 
	ON CC.SubSystemID = SS.SubSystemID 	
	LEFT JOIN tblJobCodes JC ON JC.JobCodeId = SJ.JobCodeId
	CROSS JOIN (SELECT TOP 1 TaskTypeID FROM tblTaskTypes WHERE Default_Record <> 0) DTT  
WHERE SJ.StdJobID IN('+@StdJobsCopy+')'

INSERT INTO #z_tblStdJobs (	
StdJobId,StdJob,ModelId,Dummy_Job,ComponentCodeId,ModifierCodeId,JobCodeId,TaskTypeId,ApplicationCodeID,
Occurrence_Type_Id,Option_Pobability,Job_Default_Option,Currency_ID,Job_Quantity,Parts_Cost,Labour_Cost,
Misc_Cost,Labour_Hrs,Duration_Hrs,Group_No,Use_Rotable,Rotable_Part_Id,Default_First,Default_Interval,
QUOM_ID,Planning_Task,Lead_Days,Not_After,Use_Std_Job,Pricing_Date,
Part_Type_ID,Labour_Activity_ID,Manufacturer_Id,Cost_Expense_ID)
EXEC(@SQL)



/**********************VALIDATION***********************/

/**VALIDATION 1a **********************************************************
Check the data in the fields
1. First Occs>=0
2. Frequency>0
3. PartType shall exist
4. Job Code is required
5. labour hrs, duration hrs >=0
6. UOM is required
7. Comp Code is required
8. Task Type is required
9. If task is a planning task, lead days are required
***************************************************************************/

--1. First Occs>=0
IF EXISTS(SELECT Default_First FROM #z_tblStdJobs WHERE Default_First < 0)
BEGIN
	SET @Message='First occurrence is negative in the following Standard Jobs:'+nchar(13)

-- 	DECLARE msgCursor CURSOR LOCAL FAST_FORWARD FOR
-- 	SELECT DISTINCT StdJob FROM #z_tblStdJobs
-- 	WHERE Default_First < 0
-- 
-- 	SET @CreateMsg=1

	SELECT @Message=CASE WHEN LEN(@Message)+LEN(StdJob+@COMA)>@MAXMessageLen THEN @Message
				 ELSE @Message+	StdJob +@COMA END 
	FROM #z_tblStdJobs
	WHERE Default_First < 0

	GOTO CREATE_MESSAGE
END	

--1. Frequency>0
IF EXISTS(SELECT StdJob FROM #z_tblStdJobs WHERE Default_Interval <= 0)
BEGIN
	SET @Message='Frequency shall be greater than 0 in the following Standard Jobs:'+nchar(13)

-- 	DECLARE msgCursor CURSOR LOCAL FAST_FORWARD FOR
-- 	SELECT DISTINCT StdJob FROM #z_tblStdJobs WHERE Default_Interval <= 0
-- 
-- 	SET @CreateMsg=1

	SELECT @Message=CASE WHEN LEN(@Message)+LEN(StdJob+@COMA)>@MAXMessageLen THEN @Message
				 ELSE @Message+	StdJob +@COMA END 
	FROM #z_tblStdJobs WHERE Default_Interval <= 0
	GOTO CREATE_MESSAGE
END	

/*VV CR8759
--3. PartType shall exist
IF EXISTS(SELECT StdJob FROM #z_tblStdJobs WHERE Part_Type_ID IS NULL)
BEGIN
	SET @Message='Part Type is required in the following Standard Jobs:'+nchar(13)

-- 	DECLARE msgCursor CURSOR LOCAL FAST_FORWARD FOR
-- 	SELECT DISTINCT StdJob FROM #z_tblStdJobs WHERE Part_Type_ID IS NULL
-- 
-- 	SET @CreateMsg=1

	SELECT @Message=CASE WHEN LEN(@Message)+LEN(StdJob+@COMA)>@MAXMessageLen THEN @Message
				 ELSE @Message+	StdJob +@COMA END 
	FROM #z_tblStdJobs WHERE Part_Type_ID IS NULL
	GOTO CREATE_MESSAGE
END	
*/

--4. Job Code is required. We need to check if the default job code is not 0.
--If a std job was created from projected task linked to cost aloocations the routine to create std job
--substituted "0" Job code with the default value.
IF EXISTS(SELECT JobCodeId FROM tblJobCodes WHERE Default_Record=1 AND JobCodeId>0)
BEGIN
	IF EXISTS(SELECT StdJob FROM #z_tblStdJobs WHERE JobCodeId = 0)
	BEGIN
		SET @Message='Job Code is required in the following Standard Jobs:'+nchar(13)
	
	-- 	DECLARE msgCursor CURSOR LOCAL FAST_FORWARD FOR
	-- 	SELECT DISTINCT StdJob FROM #z_tblStdJobs WHERE JobCodeId = 0
	-- 
	-- 	SET @CreateMsg=1
		SELECT @Message=CASE WHEN LEN(@Message)+LEN(StdJob+@COMA)>@MAXMessageLen THEN @Message
					 ELSE @Message+	StdJob +@COMA END 
		FROM #z_tblStdJobs WHERE JobCodeId = 0
	
		GOTO CREATE_MESSAGE
	END	
END
--5. labour hrs, duration hrs >=0
IF EXISTS(SELECT StdJob FROM #z_tblStdJobs WHERE Labour_Hrs < 0)
BEGIN
	SET @Message='Labour Hours are negative in the following Standard Jobs:'+nchar(13)

-- 	DECLARE msgCursor CURSOR LOCAL FAST_FORWARD FOR
-- 	SELECT DISTINCT StdJob FROM #z_tblStdJobs WHERE Labour_Hrs < 0
-- 
-- 	SET @CreateMsg=1

	SELECT @Message=CASE WHEN LEN(@Message)+LEN(StdJob+@COMA)>@MAXMessageLen THEN @Message
					 ELSE @Message+	StdJob +@COMA END 
	FROM #z_tblStdJobs WHERE Labour_Hrs < 0

	GOTO CREATE_MESSAGE
END	

IF EXISTS(SELECT StdJob FROM #z_tblStdJobs WHERE Duration_Hrs < 0)
BEGIN
	SET @Message='Duration Hours are negative in the following Standard Jobs:'+nchar(13)

-- 	DECLARE msgCursor CURSOR LOCAL FAST_FORWARD FOR
-- 	SELECT DISTINCT StdJob FROM #z_tblStdJobs WHERE Duration_Hrs < 0
-- 
-- 	SET @CreateMsg=1
	SELECT @Message=CASE WHEN LEN(@Message)+LEN(StdJob+@COMA)>@MAXMessageLen THEN @Message
					 ELSE @Message+	StdJob +@COMA END 
	FROM #z_tblStdJobs WHERE Duration_Hrs < 0
	GOTO CREATE_MESSAGE
END	

--6. UOM is required
-- IF EXISTS(SELECT StdJob FROM #z_tblStdJobs WHERE ISNULL(QUOM_ID,0) = 0)
-- BEGIN
--	SET @Message='UOM is required in the following Standard Jobs:'+nchar(13)
--
--	DECLARE msgCursor CURSOR LOCAL FAST_FORWARD FOR
--	SELECT DISTINCT StdJob FROM #z_tblStdJobs WHERE ISNULL(QUOM_ID,0) = 0

--	SET @CreateMsg=1
--	GOTO CREATE_MESSAGE
-- END	

-- 7. Comp Code is required
IF EXISTS(SELECT StdJob FROM #z_tblStdJobs WHERE ComponentCodeId = 0)
BEGIN
	SET @Message='Component Code is required in the following Standard Jobs:'+nchar(13)

-- 	DECLARE msgCursor CURSOR LOCAL FAST_FORWARD FOR
-- 	SELECT DISTINCT StdJob FROM #z_tblStdJobs WHERE ComponentCodeId = 0
-- 
-- 	SET @CreateMsg=1
	SELECT @Message=CASE WHEN LEN(@Message)+LEN(StdJob+@COMA)>@MAXMessageLen THEN @Message
					 ELSE @Message+	StdJob +@COMA END 
	FROM #z_tblStdJobs WHERE ComponentCodeId = 0
	GOTO CREATE_MESSAGE
END	
-- 8. Task Type is required
IF EXISTS(SELECT StdJob FROM #z_tblStdJobs WHERE TaskTypeId = 0)
BEGIN
	SET @Message='Task Type is required in the following Standard Jobs:'+nchar(13)

--  	DECLARE msgCursor CURSOR LOCAL FAST_FORWARD FOR
--  	SELECT DISTINCT StdJob FROM #z_tblStdJobs WHERE TaskTypeId = 0
-- 
-- 	SET @CreateMsg=1
	SELECT @Message=CASE WHEN LEN(@Message)+LEN(StdJob+@COMA)>@MAXMessageLen THEN @Message
					 ELSE @Message+	StdJob +@COMA END 
	FROM #z_tblStdJobs WHERE TaskTypeId = 0
	GOTO CREATE_MESSAGE
END	
-- 9. If task is a planning task, lead days are required
 
IF EXISTS(SELECT StdJob FROM #z_tblStdJobs WHERE Planning_Task = 1 AND Lead_Days <= 0)
BEGIN
	SET @Message='Lead Days are required in the following Standard Jobs:'+nchar(13)

-- 	DECLARE msgCursor CURSOR LOCAL FAST_FORWARD FOR
-- 	SELECT DISTINCT StdJob FROM #z_tblStdJobs WHERE Planning_Task = 1 AND Lead_Days <= 0
-- 
-- 	SET @CreateMsg=1
	SELECT @Message=CASE WHEN LEN(@Message)+LEN(StdJob+@COMA)>@MAXMessageLen THEN @Message
					 ELSE @Message+	StdJob +@COMA END 
	FROM #z_tblStdJobs WHERE Planning_Task = 1 AND Lead_Days <= 0
	GOTO CREATE_MESSAGE
END	

/**VALIDATION 1b **********************************************************
If the Task Option probabilities for a Strategy Task 
(Strategy Task = Component Code + Modifier Code + Task Type + Counter) 
do not add up to 100% then the import process will be aborted with a message 
to the user and the offending Standard Jobs listed
***************************************************************************/
--E725 2. Remove the 100% restriction (Currently, AMT doesnt allow to create Strategy Tasks where the options probabilities do not add up to 100%)


--IF EXISTS(
--SELECT     ComponentCodeId, ModifierCodeId, TaskTypeId, ApplicationCodeID 
--FROM #z_tblStdJobs
--GROUP BY ComponentCodeId, ModifierCodeId, TaskTypeId, ApplicationCodeID
--HAVING SUM(Option_Pobability) <> 1)
--BEGIN
--	SET @Message='The Projected Task Option probabilities for the combination of Component Code, Modifier Code, Task Type and Task Counter '+nchar(13)+
--		' do not add up to 100% in the following Standard Jobs:'+nchar(13)

---- 	DECLARE msgCursor CURSOR LOCAL FAST_FORWARD FOR
---- 	SELECT SJ.StdJob FROM 
---- 	#z_tblStdJobs SJ
---- 		INNER JOIN
----  	(SELECT     ComponentCodeId, ModifierCodeId, TaskTypeId, ApplicationCodeID 
---- 		FROM #z_tblStdJobs
---- 		GROUP BY ComponentCodeId, ModifierCodeId, TaskTypeId, ApplicationCodeID
---- 		HAVING SUM(Option_Pobability) <> 1) A
---- 	ON SJ.ComponentCodeId=A.ComponentCodeId AND
---- 	   SJ.ModifierCodeId=A.ModifierCodeId AND 
---- 	   SJ.TaskTypeId=A.TaskTypeId AND 
---- 	   SJ.ApplicationCodeID=A.ApplicationCodeID 
---- 
---- 	SET @CreateMsg=1

--	SELECT @Message=CASE WHEN LEN(@Message)+LEN(StdJob+@COMA)>@MAXMessageLen THEN @Message
--					 ELSE @Message+	StdJob +@COMA END
--	FROM 
--	#z_tblStdJobs SJ
--		INNER JOIN
-- 	(SELECT     ComponentCodeId, ModifierCodeId, TaskTypeId, ApplicationCodeID 
--		FROM #z_tblStdJobs
--		GROUP BY ComponentCodeId, ModifierCodeId, TaskTypeId, ApplicationCodeID
--		HAVING SUM(Option_Pobability) <> 1) A
--	ON SJ.ComponentCodeId=A.ComponentCodeId AND
--	   SJ.ModifierCodeId=A.ModifierCodeId AND 
--	   SJ.TaskTypeId=A.TaskTypeId AND 
--	   SJ.ApplicationCodeID=A.ApplicationCodeID 

--	GOTO CREATE_MESSAGE
--END	
	
/**VALIDATION 2 **********************************************************
Check that the proj tasks fields are all the same in the std jobs.
The sum of option probability shall be 1, assuming that the validation 1
has been performed and the probability for CC+MC+TT+AC =1
***************************************************************************/
IF EXISTS(
	SELECT     
	ComponentCodeId, ModifierCodeId, TaskTypeId, ApplicationCodeID, QUOM_ID, Not_After, 
	Use_Rotable, Rotable_Part_Id, Group_No, Planning_Task, 
	Lead_Days, Manufacturer_ID, SUM(Option_Pobability) AS Option_Pobability
	FROM #z_tblStdJobs
	GROUP BY ComponentCodeId, ModifierCodeId, TaskTypeId, ApplicationCodeID, QUOM_ID, Not_After, 
	Use_Rotable, Rotable_Part_Id, Group_No, Planning_Task, 
	Lead_Days, Manufacturer_ID
	HAVING SUM(Option_Pobability) <> 1)
BEGIN
	SET @Message='The Projected Task details for the combination of Component Code, Modifier Code, Task Type and Task Counter '+nchar(13)+
		' are not the same in the following Standard Jobs:'+nchar(13)

-- 	DECLARE msgCursor CURSOR LOCAL FAST_FORWARD FOR
-- 	SELECT DISTINCT SJ.StdJob FROM 
-- 	#z_tblStdJobs SJ
-- 		INNER JOIN
--  	(SELECT     
-- 	ComponentCodeId, ModifierCodeId, TaskTypeId, ApplicationCodeID, QUOM_ID, Not_After, 
-- 	Use_Rotable, Rotable_Part_Id, Group_No, Planning_Task, 
-- 	Lead_Days, Manufacturer_ID,SUM(Option_Pobability) AS Option_Pobability
-- 	FROM #z_tblStdJobs
-- 	GROUP BY ComponentCodeId, ModifierCodeId, TaskTypeId, ApplicationCodeID, QUOM_ID, Not_After, 
-- 	Use_Rotable, Rotable_Part_Id, Group_No, Planning_Task, 
-- 	Lead_Days, Manufacturer_ID
-- 	HAVING SUM(Option_Pobability) <> 1) A
-- 
-- 	ON SJ.ComponentCodeId=A.ComponentCodeId AND
-- 	   SJ.ModifierCodeId=A.ModifierCodeId AND 
-- 	   SJ.TaskTypeId=A.TaskTypeId AND 
-- 	   SJ.ApplicationCodeID=A.ApplicationCodeID 
-- 	
-- 	SET @CreateMsg=1

	SELECT @Message=CASE WHEN LEN(@Message)+LEN(StdJob+@COMA)>@MAXMessageLen THEN @Message
					 ELSE @Message+	StdJob +@COMA END
	FROM 
	#z_tblStdJobs SJ
		INNER JOIN
 	(SELECT     
	ComponentCodeId, ModifierCodeId, TaskTypeId, ApplicationCodeID, QUOM_ID, Not_After, 
	Use_Rotable, Rotable_Part_Id, Group_No, Planning_Task, 
	Lead_Days, Manufacturer_ID,SUM(Option_Pobability) AS Option_Pobability
	FROM #z_tblStdJobs
	GROUP BY ComponentCodeId, ModifierCodeId, TaskTypeId, ApplicationCodeID, QUOM_ID, Not_After, 
	Use_Rotable, Rotable_Part_Id, Group_No, Planning_Task, 
	Lead_Days, Manufacturer_ID
	HAVING SUM(Option_Pobability) <> 1) A

	ON SJ.ComponentCodeId=A.ComponentCodeId AND
	   SJ.ModifierCodeId=A.ModifierCodeId AND 
	   SJ.TaskTypeId=A.TaskTypeId AND 
	   SJ.ApplicationCodeID=A.ApplicationCodeID 

	GOTO CREATE_MESSAGE

END

/**VALIDATION 3 **********************************************************
There should be never a quantity >2
***************************************************************************/
IF EXISTS(
	SELECT StdJobID  	
	FROM #z_tblStdJobs
	WHERE Job_Quantity>2)
BEGIN
	SET @Message='The following Standard Jobs have quantity greater than 2:'+nchar(13)

-- 	DECLARE msgCursor CURSOR LOCAL FAST_FORWARD FOR
-- 	SELECT SJ.StdJob FROM 
-- 	#z_tblStdJobs SJ
-- 	WHERE Job_Quantity>2	
-- 	
-- 	SET @CreateMsg=1

	SELECT @Message=CASE WHEN LEN(@Message)+LEN(StdJob+@COMA)>@MAXMessageLen THEN @Message
					 ELSE @Message+	StdJob +@COMA END
	FROM 
	#z_tblStdJobs SJ
	WHERE Job_Quantity>2	
	
	GOTO CREATE_MESSAGE

END

CREATE_MESSAGE:
IF LEN(@Message)>0
BEGIN
-- 	OPEN msgCursor
-- 
-- 	FETCH NEXT FROM msgCursor INTO @msgStdJob
-- 
-- 	WHILE @@FETCH_STATUS = 0
-- 	BEGIN	
-- 		IF LEN(	@Message + @msgStdJob+', ')<=8000
-- 			SET @Message=@Message + @msgStdJob+', '
-- 	      	
-- 
-- 	      	FETCH NEXT FROM msgCursor INTO @msgStdJob
-- 	   
-- 	END
-- 
-- 	CLOSE msgCursor
-- 	DEALLOCATE msgCursor
	
	-- Take out the coma
	SET @Message=LEFT(@Message,LEN(@Message)-LEN(@COMA))  
	GOTO FINISH 
END

/****************************************************

If a Standard Job has a Quantity of 2 in the table then the create 2 Strategy Tasks and differentiate 
them by Modifier Codes (use the top two Modifier Codes in the System table (but not the Default) 
and the user can edit them later (Note, there should never be a quantity > 2)

****************************************************/
IF EXISTS(SELECT SJ.StdJob FROM #z_tblStdJobs SJ WHERE Job_Quantity>1)
BEGIN	
	
	--Create a temporary table for the first 2 Modifier Codes
	SELECT  TOP 2 ModifierID, Code
	INTO #z_tblModifierCodes
	FROM tblModifierCodes
	WHERE(ModifierID <> 0) AND (Default_Record = 0) 
	
	--Update the Std Jobs where quantity >2 with the first modifier code 
	UPDATE SJ  
	SET SJ.ModifierCodeId = M.ModifierID
	FROM  
	#z_tblStdJobs SJ
		CROSS JOIN
        (SELECT TOP 1 * FROM #z_tblModifierCodes) M
	WHERE SJ.Job_Quantity=2
	
	--Insert the std jobs with the missing modifier codes. 
	--Insert (-StdJobID) for StdJobID - because of the unique index created on the temporary table
	INSERT INTO #z_tblStdJobs(
				StdJobId,StdJob,ModelId,Dummy_Job,ComponentCodeId,ModifierCodeId,JobCodeId,TaskTypeId,ApplicationCodeID,
				Occurrence_Type_Id,Option_Pobability,Job_Default_Option,Currency_ID,Job_Quantity,Parts_Cost,Labour_Cost,
				Misc_Cost,Labour_Hrs,Duration_Hrs,Group_No,Use_Rotable,Rotable_Part_Id,Default_First,Default_Interval,
				QUOM_ID,Planning_Task,Lead_Days,Not_After,Use_Std_Job,Pricing_Date,
				Part_Type_ID,Labour_Activity_ID,Manufacturer_Id)

	SELECT     

	-A.StdJobId,StdJob,ModelId,Dummy_Job,ComponentCodeId,A.ModifierCodeId,JobCodeId,TaskTypeId,ApplicationCodeID,
	Occurrence_Type_Id,Option_Pobability,Job_Default_Option,Currency_ID,Job_Quantity,Parts_Cost,Labour_Cost,
	Misc_Cost,Labour_Hrs,Duration_Hrs,Group_No,Use_Rotable,Rotable_Part_Id,Default_First,Default_Interval,
	QUOM_ID,Planning_Task,Lead_Days,Not_After,Use_Std_Job,Pricing_Date,
	Part_Type_ID,Labour_Activity_ID,Manufacturer_Id
	FROM 
	(SELECT
	SJ.StdJobId, SJ.StdJob, SJ.ModelId, SJ.Dummy_Job, SJ.ComponentCodeId,
	M.ModifierID AS ModifierCodeId, SJ.JobCodeId, SJ.TaskTypeId, SJ.ApplicationCodeID, 
	SJ.Occurrence_Type_Id, SJ.Option_Pobability, SJ.Job_Default_Option, SJ.Currency_ID, SJ.Job_Quantity, 
	SJ.Parts_Cost, SJ.Labour_Cost, SJ.Misc_Cost, SJ.Labour_Hrs, SJ.Duration_Hrs, SJ.Group_No, SJ.Use_Rotable, 
	SJ.Rotable_Part_Id, SJ.Default_First, SJ.Default_Interval, SJ.QUOM_ID, SJ.Planning_Task, SJ.Lead_Days, 
	SJ.Not_After, SJ.Use_Std_Job, SJ.Pricing_Date, 
	SJ.Part_Type_ID, SJ.Labour_Activity_ID, SJ.Manufacturer_Id 	
	FROM   
	#z_tblStdJobs SJ 
		CROSS JOIN
	#z_tblModifierCodes M 
	WHERE SJ.Job_Quantity>1) A
	LEFT OUTER JOIN
	(SELECT StdJobId,ModifierCodeId FROM #z_tblStdJobs WHERE Job_Quantity>1) SJ 
	ON A.StdJobId = SJ.StdJobId AND A.ModifierCodeId = SJ.ModifierCodeId
	WHERE  (SJ.StdJobId IS NULL)

-- 	DROP TABLE z_tblModifierCodes
-- 	select * into z_tblModifierCodes from #z_tblModifierCodes
	DROP TABLE #z_tblModifierCodes

END



--Create a temporary table for projections

SET @SQL='SELECT BranchId,FleetId, EqpPlanId,EqpProjId,Price_Group_ID,Projection_Type_ID,Default_Cost_Bearer_ID,
Pricing_Date,ManufacturerId, EqpStartDate,Utilisation_Method_Id,QUOMId,ModelId
 FROM  EQUIPMENT_HIERARCHY_V EH WHERE Projection_Type_ID<>4 '
SET @Where=''
 
IF ISNULL(@BranchID,'') <> ''	SET @Where = @Where + ' AND (eh.BranchId IN (' + @BranchID + '))'
IF ISNULL(@SiteID,'') <> '' SET @Where = @Where + ' AND (eh.SiteId IN (' + @SiteID + '))' 
IF ISNULL(@FleetID,'') <> '' SET @Where = @Where + ' AND (eh.FleetId IN (' + @FleetID + '))' 
IF ISNULL(@EqpPlanId,'') <> '' SET @Where = @Where + ' AND (eh.EqpPlanId IN (' + @EqpPlanId + '))'
IF ISNULL(@ModelID,'') <> '' SET @Where = @Where + ' AND (eh.ModelId IN (' + @ModelID + '))'
IF ISNULL(@ProjHeaderId,'') <> '' SET @Where = @Where + ' AND (eh.ProjHeaderId IN (' + @ProjHeaderId + '))'
 

CREATE TABLE #z_tblEqpProjs (
BranchId int, 
FleetId int,
EqpPlanID int, 
EqpProjId int,
Price_Group_ID int,
Projection_Type_ID int,
Default_Cost_Bearer_ID int,
Proj_Pricing_Date datetime,
ManufacturerID int,
EqpStartDate datetime,
Utilisation_Method_Id int,
QUOMId int,
ModelId int )



INSERT INTO #z_tblEqpProjs(BranchId,FleetId, EqpPlanId,EqpProjId,Price_Group_ID,Projection_Type_ID,Default_Cost_Bearer_ID,
	    Proj_Pricing_Date,ManufacturerId, EqpStartDate,Utilisation_Method_Id,QUOMId,ModelId)
EXEC(@SQL+@Where)



-- DROP TABLE z_tblEqpProjs
-- SELECT * INTO z_tblEqpProjs FROM #z_tblEqpProjs
-- return
-- DROP TABLE z_tblStdJobs
-- SELECT * INTO z_tblStdJobs FROM #z_tblStdJobs
-- 
-- return

/**VALIDATION 4 **********************************************************
	
	Check that UOM in Std Jobs is supported by projections
***************************************************************************/
IF EXISTS(SELECT QUOM_Id FROM #z_tblStdJobs WHERE QUOM_Id IS NOT NULL)
BEGIN
	/* Validation 4a Check equipment with usage profiles*/
	IF EXISTS(SELECT EqpPlanId FROM #z_tblEqpProjs WHERE Utilisation_Method_Id=@UtilMethod_Adv)
	BEGIN
		IF EXISTS(SELECT  A.EqpPlan, A.EqpProjName, A.UsageProfile, A.UOM
			  FROM 
			(SELECT DISTINCT EPR.EqpProjId, SJ.QUOM_ID, EP.EqpPlan, EPR_1.EqpProjName, UP.UsageProfile, 
			 QUOM.QUOMId,QUOM.UOMShortDesc AS UOM
			FROM     
--					  tblUOMs UOM INNER JOIN
--		              tblQualifiers Q INNER JOIN
--		              tblQUOMs QUOM ON Q.QualifierId = QUOM.QualifierId ON UOM.UOMId = QUOM.UOMId INNER JOIN
					  tblQUOMs QUOM INNER JOIN
		              #z_tblStdJobs SJ ON QUOM.QUOMId = SJ.QUOM_ID CROSS JOIN
		              tblEqpProjs EPR_1 INNER JOIN
		              tblUsageProfiles UP ON EPR_1.ProjUsageProfileId = UP.UsageProfileId INNER JOIN
		              #z_tblEqpProjs EPR ON EPR_1.EqpProjId = EPR.EqpProjId INNER JOIN
		              tblEqpPlans EP ON EPR_1.EqpPlanId = EP.EqpPlanId) A 
				LEFT OUTER JOIN
		        (SELECT DISTINCT EPR.EqpProjId, USR.ChildQUOMId
			FROM         
				#z_tblEqpProjs ZEPR INNER JOIN
		              tblEqpProjs EPR ON ZEPR.EqpProjId = EPR.EqpProjId INNER JOIN
		              tblUsageProfiles UP ON EPR.ProjUsageProfileId = UP.UsageProfileId INNER JOIN
		              tblUsageSteps US INNER JOIN
		              tblUsageStepRels USR ON US.UsageStepId = USR.UsageStepId ON UP.UsageProfileId = US.UsageProfileId) B ON 
				A.EqpProjId = B.EqpProjId AND A.QUOM_ID = B.ChildQUOMId
			WHERE B.EqpProjId IS NULL) 
		BEGIN
			SET @Message='The following UOM is not supported by equipment:'+nchar(13)
		
			
			SELECT  @Message=CASE WHEN LEN(@Message)+LEN('('+A.UOM+') - '+ A.EqpPlan+':'+ A.EqpProjName+@COMA)>@MAXMessageLen THEN @Message
					 ELSE @Message+	'('+A.UOM+') - '+ A.EqpPlan+':'+ A.EqpProjName +@COMA END 
			  FROM 
			(SELECT DISTINCT EPR.EqpProjId, SJ.QUOM_ID, EP.EqpPlan, EPR_1.EqpProjName, UP.UsageProfile, 
			 QUOM.QUOMId,QUOM.UOMShortDesc AS UOM, SJ.StdJob
				FROM     
--					  tblUOMs UOM INNER JOIN
--		              tblQualifiers Q INNER JOIN
--		              tblQUOMs QUOM ON Q.QualifierId = QUOM.QualifierId ON UOM.UOMId = QUOM.UOMId INNER JOIN
					  tblQUOMs QUOM INNER JOIN
		              #z_tblStdJobs SJ ON QUOM.QUOMId = SJ.QUOM_ID CROSS JOIN
		              tblEqpProjs EPR_1 INNER JOIN
		              tblUsageProfiles UP ON EPR_1.ProjUsageProfileId = UP.UsageProfileId INNER JOIN
		              #z_tblEqpProjs EPR ON EPR_1.EqpProjId = EPR.EqpProjId INNER JOIN
		              tblEqpPlans EP ON EPR_1.EqpPlanId = EP.EqpPlanId) A 
				LEFT OUTER JOIN
		        (SELECT DISTINCT EPR.EqpProjId, USR.ChildQUOMId
			FROM         
				#z_tblEqpProjs ZEPR INNER JOIN
		              tblEqpProjs EPR ON ZEPR.EqpProjId = EPR.EqpProjId INNER JOIN
		              tblUsageProfiles UP ON EPR.ProjUsageProfileId = UP.UsageProfileId INNER JOIN
		              tblUsageSteps US INNER JOIN
		              tblUsageStepRels USR ON US.UsageStepId = USR.UsageStepId ON UP.UsageProfileId = US.UsageProfileId) B ON 
				A.EqpProjId = B.EqpProjId AND A.QUOM_ID = B.ChildQUOMId
			WHERE B.EqpProjId IS NULL
			
			--SET @CreateMsg=1
			GOTO CREATE_MESSAGE
		END
	END
	
	
	/* Validation 4b Check equipment with simple utilisation*/

	IF EXISTS(SELECT EqpPlanId FROM #z_tblEqpProjs WHERE Utilisation_Method_Id=@UtilMethod_Smpl)
	BEGIN
		IF EXISTS(SELECT C.EqpProjId,C.QUOM_Id FROM
		(SELECT B.EqpProjId,A.QUOM_Id
		FROM        
		(SELECT QUOM_Id FROM #z_tblStdJobs WHERE QUOM_Id IS NOT NULL) A
			CROSS JOIN
		#z_tblEqpProjs B WHERE B.Utilisation_Method_Id=@UtilMethod_Smpl) C
			LEFT OUTER JOIN
		(SELECT EqpProjId, QUOMId FROM #z_tblEqpProjs WHERE Utilisation_Method_Id=@UtilMethod_Smpl) D
			ON C.EqpProjId=D.EqpProjId AND C.QUOM_Id=D.QUOMId
		WHERE D.EqpProjId IS NULL)
		BEGIN
			SET @Message='The following UOM is not supported by equipment:'+nchar(13)
		
			
			SELECT @Message=CASE WHEN LEN(@Message)+LEN('('+QUOM.UOMShortDesc+') - '+ EP.EqpPlan+':'+ EPR.EqpProjName+@COMA)>@MAXMessageLen THEN @Message
					 ELSE @Message+	'('+QUOM.UOMShortDesc+') - '+ EP.EqpPlan+':'+ EPR.EqpProjName +@COMA END 

			--SELECT EP.EqpPlan,EPR.EqpProjName,Q.QualifierShort+' - '+UOM.UOMShort AS UOM
			FROM
			(SELECT DISTINCT C.EqpProjId,C.QUOM_Id FROM
			(SELECT B.EqpProjId,A.QUOM_Id
			FROM        
			(SELECT QUOM_Id FROM #z_tblStdJobs WHERE QUOM_Id IS NOT NULL) A
				CROSS JOIN
			#z_tblEqpProjs B WHERE B.Utilisation_Method_Id=@UtilMethod_Smpl) C
				LEFT OUTER JOIN
			(SELECT EqpProjId, QUOMId FROM #z_tblEqpProjs WHERE Utilisation_Method_Id=@UtilMethod_Smpl) D
				ON C.EqpProjId=D.EqpProjId AND C.QUOM_Id=D.QUOMId
			WHERE D.EqpProjId IS NULL) E
			
				INNER JOIN
			tblEqpProjs EPR
				ON E.EqpProjId=EPR.EqpProjID
				INNER JOIN
			tblEqpPlans EP
				ON EPR.EqpPlanId=EP.EqpPlanId
				INNER JOIN
			tblQUOMs QUOM
				ON E.QUOM_Id=QUOM.QUOMId
--				INNER JOIN
--			tblUOMs UOM 
--				ON QUOM.UOMId=UOM.UOMId 
--				INNER JOIN
--			tblQualifiers Q 
--				ON QUOM.QualifierId=Q.QualifierId 

			GOTO CREATE_MESSAGE				
			
		END
		
	END
	/* Validation 4c Check equipment with no utilisation*/
	IF EXISTS(SELECT EqpPlanId FROM #z_tblEqpProjs WHERE Utilisation_Method_Id=@UtilMethod_NoUtl) 
	BEGIN
		SET @Message='The following UOM is not supported by equipment:'+nchar(13)
		
			
		SELECT @Message=CASE WHEN LEN(@Message)+LEN('('+QUOM.UOMShortDesc+') - '+ EP.EqpPlan+':'+ EPR.EqpProjName+@COMA)>@MAXMessageLen THEN @Message
				 ELSE @Message+	'('+QUOM.UOMShortDesc+') - '+ EP.EqpPlan+':'+ EPR.EqpProjName +@COMA END 
		FROM
		(SELECT DISTINCT A.EqpProjId, B.QUOM_Id FROM
		(SELECT EqpProjId FROM #z_tblEqpProjs WHERE Utilisation_Method_Id=@UtilMethod_NoUtl) A
			CROSS JOIN
		(SELECT DISTINCT QUOM_Id FROM #z_tblStdJobs WHERE QUOM_Id IS NOT NULL)  B
		)E
			INNER JOIN
		tblEqpProjs EPR
			ON E.EqpProjId=EPR.EqpProjID
			INNER JOIN
		tblEqpPlans EP
			ON EPR.EqpPlanId=EP.EqpPlanId
			INNER JOIN
		tblQUOMs QUOM
			ON E.QUOM_Id=QUOM.QUOMId
--			INNER JOIN
--		tblUOMs UOM 
--			ON QUOM.UOMId=UOM.UOMId 
--			INNER JOIN
--		tblQualifiers Q 
--			ON QUOM.QualifierId=Q.QualifierId 	
		
		GOTO CREATE_MESSAGE

	END
END

	


/**************************************************
Validate the required fields
*************************************************/

SELECT @Filter_Std_Job_Model=Filter_Std_Job_Model FROM AMT_VARIABLE

DECLARE @Tasks TABLE(ListId int IDENTITY(1,1),
ProjTaskId int, EqpProjId int, EqpPlanID int,Projection_Type_ID int,Default_Cost_Bearer_ID int,
ComponentCodeId int, ModifierCodeId int, TaskTypeId int, ApplicationCodeID int, 
QUOM_ID int, Not_After float, Last_Change_Usage float, Last_Change_Date datetime,
Rotable_Part_Id int, Part_Id int,Group_No varchar(50), Planning_Task bit, Lead_Days int,BranchId int,
Price_Group_ID int,Proj_Pricing_Date datetime,ManufacturerId int, FleetId int,Cost_Expense_ID int,
ModelId int, StartingSerialNo INT
PRIMARY KEY(ListId))


-- Update the existing Projected tasks 
IF @UpdateExisting=1
BEGIN
	INSERT INTO @Tasks(ProjTaskId , EqpProjId , EqpPlanID ,Projection_Type_ID ,Default_Cost_Bearer_ID ,
	ComponentCodeId , ModifierCodeId , TaskTypeId , ApplicationCodeID , QUOM_ID , Not_After , 
	Last_Change_Usage , Last_Change_Date ,Rotable_Part_Id , Part_Id ,Group_No , Planning_Task , Lead_Days ,BranchId ,
	Price_Group_ID ,Proj_Pricing_Date ,ManufacturerId , FleetId ,Cost_Expense_ID,ModelId,StartingSerialNo)

	SELECT PT.ProjTaskId, A.EqpProjId, A.EqpPlanID,A.Projection_Type_ID,A.Default_Cost_Bearer_ID,
	A.ComponentCodeId, A.ModifierCodeId, A.TaskTypeId, A.ApplicationCodeID, 
		A.QUOM_ID, A.Not_After, 
		ISNULL(PT.Last_Change_Usage,0) AS Last_Change_Usage, 
		ISNULL(PT.Last_Change_Date,A.EqpStartDate) AS Last_Change_Date,
		CASE A.Use_Rotable WHEN 1 THEN A.Rotable_Part_Id ELSE NULL END AS Rotable_Part_Id, 
		CASE A.Use_Rotable WHEN 0 THEN A.Rotable_Part_Id ELSE NULL END AS Part_Id,
		A.Group_No, A.Planning_Task, A.Lead_Days,A.BranchId,
		A.Price_Group_ID,A.Proj_Pricing_Date,A.ManufacturerId, A.FleetId,A.Cost_Expense_ID,A.ModelId, PT.StartingSerialNoId
		FROM tblProjTasks PT 
			RIGHT OUTER JOIN
          	(SELECT DISTINCT SJ.ComponentCodeId, SJ.ModifierCodeId, SJ.TaskTypeId, SJ.ApplicationCodeID, 
		SJ.QUOM_ID, SJ.Not_After, SJ.Use_Rotable, 
		SJ.Rotable_Part_Id, SJ.Group_No, SJ.Planning_Task, SJ.Lead_Days, 
		EPR.EqpProjId, EPR.EqpPlanID,EPR.Projection_Type_ID,EPR.Default_Cost_Bearer_ID,
		EPR.BranchId,EPR.Price_Group_ID,EPR.Proj_Pricing_Date,
		ISNULL(SJ.Manufacturer_Id,EPR.ManufacturerId) AS ManufacturerId,
		EPR.EqpStartDate,EPR.FleetID,SJ.Cost_Expense_ID,EPR.ModelId
		FROM  		
              	#z_tblEqpProjs EPR  
			CROSS JOIN
              	#z_tblStdJobs SJ ) A 
		ON PT.EqpProjId = A.EqpProjId AND 
		   PT.ComponentCodeId = A.ComponentCodeId AND 
		   PT.ModifierId = A.ModifierCodeId AND 
              	   PT.TaskTypeId = A.TaskTypeId AND 
		   PT.ApplicationCodeId = A.ApplicationCodeID
END
ELSE
BEGIN
	--Last change usage=0 for the new tasks
	--Last change date=start date of Eqp plan
	INSERT INTO @Tasks(ProjTaskId , EqpProjId , EqpPlanID ,Projection_Type_ID ,Default_Cost_Bearer_ID ,
	ComponentCodeId , ModifierCodeId , TaskTypeId , ApplicationCodeID , QUOM_ID , Not_After , 
	Last_Change_Usage , Last_Change_Date ,Rotable_Part_Id , Part_Id ,Group_No , Planning_Task , Lead_Days ,BranchId ,
	Price_Group_ID ,Proj_Pricing_Date ,ManufacturerId , FleetId ,Cost_Expense_ID,ModelId)

	SELECT PT.ProjTaskId, A.EqpProjId, A.EqpPlanID,A.Projection_Type_ID,A.Default_Cost_Bearer_ID,
	A.ComponentCodeId, A.ModifierCodeId, A.TaskTypeId, A.ApplicationCodeID, 
		A.QUOM_ID, A.Not_After, 0 AS Last_Change_Usage, A.EqpStartDate AS Last_Change_Date,
		CASE A.Use_Rotable WHEN 1 THEN A.Rotable_Part_Id ELSE NULL END AS Rotable_Part_Id, 
		CASE A.Use_Rotable WHEN 0 THEN A.Rotable_Part_Id ELSE NULL END AS Part_Id, 
		A.Group_No, A.Planning_Task, A.Lead_Days,A.BranchId,
		A.Price_Group_ID,A.Proj_Pricing_Date,A.ManufacturerId,A.FleetId, A.Cost_Expense_ID,A.ModelId
		FROM tblProjTasks PT 
			RIGHT OUTER JOIN
          	(SELECT DISTINCT SJ.ComponentCodeId, SJ.ModifierCodeId, SJ.TaskTypeId, SJ.ApplicationCodeID, 
		SJ.QUOM_ID, SJ.Not_After, SJ.Use_Rotable, 
		SJ.Rotable_Part_Id, SJ.Group_No, SJ.Planning_Task, SJ.Lead_Days, 
		EPR.EqpProjId, EPR.EqpPlanID,EPR.Projection_Type_ID,EPR.Default_Cost_Bearer_ID,
		EPR.BranchId,EPR.Price_Group_ID,EPR.Proj_Pricing_Date,
		ISNULL(SJ.Manufacturer_Id,EPR.ManufacturerId) AS ManufacturerId,
		EPR.EqpStartDate, EPR.FleetID, SJ.Cost_Expense_ID,EPR.ModelId
		FROM  		
              	#z_tblEqpProjs EPR  
			CROSS JOIN
              	#z_tblStdJobs SJ ) A 
		ON PT.EqpProjId = A.EqpProjId AND 
		   PT.ComponentCodeId = A.ComponentCodeId AND 
		   PT.ModifierId = A.ModifierCodeId AND 
              	   PT.TaskTypeId = A.TaskTypeId AND 
		   PT.ApplicationCodeId = A.ApplicationCodeID
		WHERE PT.ProjTaskId IS NULL
END

--drop table z_Tasks
--select * into z_Tasks from @Tasks return

SET @CounterT=(SELECT COUNT(ListId) FROM @Tasks)

--Proj task options
CREATE TABLE #Options (ListId int IDENTITY(1,1),
Dummy_Job bit, JobCodeId int, Occurrence_Type_Id int, Option_Pobability float, Job_Default_Option bit, 
Labour_Hrs float, Duration_Hrs float, Pricing_Date datetime, Part_Type_ID int, Labour_Activity_ID int,
Default_First float, Default_Interval float,PricedJobId int, LabourCost float,PartsCost float, 
MiscCost float, LabourHours float, DurationHours float,	Currency_ID int, Labour_Hrs_Field bit,
PRIMARY KEY(ListId))

WHILE @CounterT>0
BEGIN	
	
	
	SELECT
	@ProjTaskId=ProjTaskId ,		
	@EqpProjId=EqpProjId ,
	@CEqpPlanID =EqpPlanID,
	@Projection_Type_ID=Projection_Type_ID,
	@Default_Cost_Bearer_ID=Default_Cost_Bearer_ID,
	@ComponentCodeId =ComponentCodeId,
	@ModifierCodeId=ModifierCodeId ,
	@TaskTypeId =TaskTypeId,
	@ApplicationCodeID =ApplicationCodeID,
	@QUOM_ID=QUOM_ID ,
	@Not_After =Not_After,
	@Last_Change_Usage =Last_Change_Usage,
	@Last_Change_Date=Last_Change_Date ,				
	@Rotable_Part_Id =Rotable_Part_Id,
	@Part_Id=Part_Id,
	@Group_No =Group_No,
	@Planning_Task =Planning_Task,
	@Lead_Days=Lead_Days,
	@BranchId=BranchId,
	@Price_Group_ID=Price_Group_ID,
	@Proj_Pricing_Date=Proj_Pricing_Date,
	@Manufacturer_Id=ManufacturerId,
	@CFleetID=FleetId,
	@CostExpenseID=Cost_Expense_ID,
	@ModelIdC=ModelId,
	@StartingSerialNo = StartingSerialNo 
	FROM @Tasks WHERE ListId=@CounterT	


	--select @ProjTaskId

	SET @NewProjTask=0

	SET @Schedule_Type_Id=CASE WHEN @QUOM_ID>0 THEN @SchLastPerformedUOM ELSE @SchLastPerformedDate END

	BEGIN TRANSACTION
	--Add the projected task if it does not exist
	IF @ProjTaskId IS NULL
	BEGIN
		-- Do not add new unassigned tasks
		IF @TaskTypeId=@UnassignedTaskType GOTO FINISH_COMMIT

		EXEC PROJ_TASK_ADD_P 	@EqpProjID =@EqpProjId,
					@ComponentCodeId =@ComponentCodeId,
					@ModifierId =@ModifierCodeId,
					@TaskTypeId =@TaskTypeId,
					@ApplicationCodeId =@ApplicationCodeID,
					@UsageQUOMId =@QUOM_ID,
					@FinalOcc =@Not_After, 
					@LastChangeUsage =@Last_Change_Usage, 
					@LastChangeDate =@Last_Change_Date,
					@PlanningTask =@Planning_Task,
					@PlanningLeadTime =@Lead_Days,
					@ProjTaskId =@ProjTaskId OUTPUT,
					@Message =@Message OUTPUT,
					@ManufacturerId =@Manufacturer_Id,
					@RotablePartId =@Rotable_Part_Id, 
					@GroupNumber =@Group_No, 
					@PartId =@Part_Id,
					@Schedule_Type_Id=@Schedule_Type_Id

		IF @Message='' AND @ProjTaskId IS NOT NULL
			SET @NewProjTask=1
		ELSE
		BEGIN
			ROLLBACK TRANSACTION
			GOTO FINISH_UPDATE
		END
			
	END
	

	INSERT INTO #Options(
	Dummy_Job , JobCodeId , Occurrence_Type_Id , Option_Pobability , Job_Default_Option , 
	Labour_Hrs , Duration_Hrs , Pricing_Date , Part_Type_ID , Labour_Activity_ID ,
        Default_First , Default_Interval ,PricedJobId , LabourCost ,PartsCost , 
	MiscCost , LabourHours , DurationHours ,Currency_ID ,Labour_Hrs_Field)

	SELECT     
	Dummy_Job, SJ.JobCodeId, Occurrence_Type_Id, Option_Pobability, Job_Default_Option, 
	Labour_Hrs, Duration_Hrs, Pricing_Date, Part_Type_ID, CASE WHEN LA.CntLA = 1 THEN LA.Labour_Activity_ID ELSE NULL END,
        Default_First, Default_Interval,
	CASE WHEN Dummy_Job=0 AND @Filter_Std_Job_Model=0 THEN A.PricedJobId
	WHEN Dummy_Job=0 AND @Filter_Std_Job_Model=1 AND SJ.ModelId=@ModelIdC THEN A.PricedJobId 
	ELSE NULL END AS PricedJobId, 
	A.LabourCost, 
	CASE A.Fix_Costs WHEN 0 THEN A.PartsCost ELSE A.PJ_PartsCost END AS PartsCost, 
	A.MiscCost, A.LabourHours, A.DurationHours,
	SJ.Currency_ID, CASE WHEN JC.ShopLabour = 0 THEN 1 ELSE 0 END AS Labour_Hrs_Field
	
	FROM 
	#z_tblStdJobs SJ
		INNER JOIN

	(
	SELECT C.PricedJobId,C.StdJobId,C.Fix_Costs,C.LabourCost, ISNULL(B.PartsCost,0) AS PartsCost,C.PartsCost AS PJ_PartsCost, 
	C.MiscCost, C.LabourHours,C.DurationHours 
	FROM
	(SELECT     SJO.StdJobId, 
	SUM((CASE WHEN SJOP.Use_Credit_Price = 0 THEN PP.Part_Sell WHEN SJOP.Full_credit = 1 THEN PP.Part_Sell - PP.Full_Credit_Sell ELSE PP.Part_Sell
	- PP.Partial_Credit_Sell END) * SJOP.Quantity * SJOP.Probability * SJ.Parts_Usage_Factor * PPA.Part_Price_Adjustment_Factor / 100.00) 
	AS PartsCost
	FROM         
	tblStdJobOperations SJO INNER JOIN
	tblStdJobOperationParts SJOP ON SJO.StdJobOperationId = SJOP.StdJobOperationId INNER JOIN
	tblParts P ON SJOP.PartId = P.PartId INNER JOIN
	tblPartPrices PP ON P.PartId = PP.PartId INNER JOIN
	PART_PRICE_ADJUSTMENT PPA ON P.Part_Type_ID = PPA.Part_Type_ID INNER JOIN
	tblStdJobs SJ ON SJO.StdJobId = SJ.StdJobId AND PP.CurrencyId = SJ.Currency_ID
	INNER JOIN #z_tblStdJobs Z ON SJ.StdJobId=Z.StdJobId
	
	WHERE     
	PPA.Fleet_ID = @CFleetID AND 
	PP.Price_Group_ID = @Price_Group_ID  
	GROUP BY SJO.StdJobId ) B
		RIGHT OUTER JOIN
	
	(SELECT  
	pj.StdJobId,pj.PricedJobId,pj.Currency_Id, 
	pj.LabourCost, 
	pj.Fix_Costs ,pj.PartsCost, 
	pj.MiscCost, pj.LabourHours, pj.DurationHours
	FROM  
	#z_tblStdJobs Z INNER JOIN   
	tblStdJobs sj ON Z.StdJobId=sj.StdJobId INNER JOIN
	tblPricedJobs pj ON sj.StdJobId = pj.StdJobId AND sj.Currency_ID = pj.Currency_ID 
	WHERE PJ.BranchId=@BranchId AND PJ.Price_Group_Id=@Price_Group_ID) C
		ON B.StdJobId=C.StdJobId
	)
	A
	
		ON SJ.StdJobId=A.StdJobId
	INNER JOIN tblJobCodes JC ON JC.JobCodeID = SJ.JobCodeId
	/*VV #3859 inner join*/
	left JOIN
	(
		SELECT SJ.StdJobId,COUNT(DISTINCT ISNULL(SJOL.Labour_Activity_ID,0)) AS CntLA, MAX(SJOL.Labour_Activity_ID) AS Labour_Activity_ID
		FROM #z_tblStdJobs SJ
		INNER JOIN tblStdJobOperations SJOP ON SJOP.StdJobId = SJ.StdJobId
		INNER JOIN STD_JOB_OPERATION_LABOUR SJOL ON SJOL.Std_Job_Operation_ID = SJOP.StdJobOperationId		 
		GROUP BY SJ.StdJobId
	) LA ON LA.StdJobId = SJ.StdJobId
	WHERE SJ.ComponentCodeId=@ComponentCodeId AND 
	      SJ.ModifierCodeId=@ModifierCodeId AND
	      SJ.TaskTypeId=@TaskTypeId AND
	      SJ.ApplicationCodeId=@ApplicationCodeID
	      
	
	SELECT @CounterO=COUNT(ListId) FROM #Options
	
	

	WHILE @CounterO>0	
	BEGIN	
		SELECT
		@Dummy_Job=Dummy_Job, 
		@JobCodeId=JobCodeId, 
		@Occurrence_Type_Id=Occurrence_Type_Id, 
		@Option_Pobability=Option_Pobability, 
		@Job_Default_Option=Job_Default_Option, 
		@Labour_Hrs=Labour_Hrs, 
		@Duration_Hrs=Duration_Hrs, 
		@Pricing_Date=Pricing_Date, 
		@Part_Type_ID=Part_Type_ID, 
		@Labour_Activity_ID=Labour_Activity_ID,
		@Default_First=Default_First, 
		@Default_Interval=Default_Interval,
		@PricedJobId=PricedJobId, 
		@LabourCost=LabourCost, 
		@PartsCost=PartsCost, 
		@MiscCost=MiscCost, 
		@LabourHours=LabourHours, 
		@DurationHours=DurationHours,
		@Currency_ID=Currency_ID,
		@Labour_Hrs_Field = Labour_Hrs_Field
		FROM #Options WHERE ListId=@CounterO
	
		
		--Check if the proj task option exists
		-- if it is exists:
		-- delete proj task amts, add new proj task amts,
		-- update the proj task opt		
		--if proj task opt does not exist add a new proj task option
		
		-- delete all proj task opts which were not updated

		SET @ProjTaskOptId=NULL
		SET @Option_Pobability=@Option_Pobability*100
		SET @PlannedOption=CAST(@Job_Default_Option AS smallint)
		
		SET @Pricing_Date=CASE 
			     WHEN @Projection_Type_ID IN(@ProjTypeBudget,@ProjTypeEstimateCurrent,@ProjTypeEstimateDraft) 
			     THEN @Proj_Pricing_Date
			     ELSE @Pricing_Date END

		-- The pricing date cannot be greater than the current date
		IF @Pricing_Date>GETDATE() SET @Pricing_Date=GETDATE()

		
		IF @NewProjTask=0
		BEGIN
			SELECT  @ProjTaskOptId=ProjTaskOptId
			FROM  tblProjTaskOpts
			WHERE ProjTaskID=@ProjTaskId AND OccurrenceTypeId=@Occurrence_Type_Id
		END

		--select @ProjTaskOptId

		IF @ProjTaskOptId IS NULL
		BEGIN
			--if proj task opt does not exist add a new proj task option
			EXEC usp_Add_Proj_Task_Option
				@projTaskId =@ProjTaskId,
				@mntPlanId =NULL,
				@occurrenceTypeId =@Occurrence_Type_Id,
				@projTaskOpt =NULL,
				@optProbability =@Option_Pobability, 
				@isPlannedOption =@PlannedOption,
				@firstOcc =@Default_First, 
				@occFrequency =@Default_Interval,
				@AddDefaultJob  = 0,
				@OverwriteJob =0,
				@EqpPlanId =@CEqpPlanId,
				@newProjTaskOptionId =@ProjTaskOptId OUTPUT,
				@newProjTaskJobId =NULL
		END
		ELSE
		BEGIN
			--Update proj task option
			EXEC usp_Update_Proj_Task_Option
				    @ProjTaskOptId =@ProjTaskOptId,
				    @ProjTaskId =@ProjTaskId,
				    @OccurrenceTypeId =@Occurrence_Type_Id,
				    @Probability =@Option_Pobability,
				    @PlannedOption =@PlannedOption,
				    @First =@Default_First,
				    @Frequency =@Default_Interval,
				    @MntPlanId =NULL,
				    @OverwriteJob =0,
				    @EqpPlanId =@CEqpPlanId
			-- Delete proj task amts
			EXEC usp_Delete_Proj_Task_Amount
					@taskAmountId =0,
					@taskOptionId =@ProjTaskOptId,
					@numberOfOccs =0
			
		END

		-- Add Proj task amts
		EXEC usp_Add_Proj_Task_Amount
			@projTaskOptId =@ProjTaskOptId,
		        @pricedJobId =@PricedJobId, 
		        @jobCodeId =@JobCodeId,
		        @performedAtSiteId =NULL,
		        --@laborShare =null,
		        @partTypeId =@Part_Type_ID,
		        @currencyId =@Currency_ID,
		        @laborCost =@LabourCost,
		        @partsCost =@PartsCost,
		        @miscCost =@MiscCost,
		        @laborHours =@LabourHours,
		        @duration =@DurationHours,
			@newProjTaskAmtId =NULL,
			@labourExpenseId = @CostExpenseID,
			@miscExpenseId = @CostExpenseID,
			@CostBearerID= @Default_Cost_Bearer_ID,
			@pricingDate =@Pricing_Date, 
			@labourActivityId = @Labour_Activity_ID,
			@PartsExpenseId=@CostExpenseID,
			@Labour_Hrs_Field = @Labour_Hrs_Field
      		SET @CounterO=@CounterO-1
	END

	
	--Update the existing ProjTask
	IF @NewProjTask=0
	BEGIN
		EXEC usp_Update_Task 	@projTaskId =@ProjTaskId,
					@componentCodeId =@ComponentCodeId,
					@modifierId =@ModifierCodeId,
					@taskTypeId =@TaskTypeId,
					@applicationCodeId =@ApplicationCodeID,
					@manufacturerId =@Manufacturer_Id,
					@usageMethod =@UsageMethod,
					@usageQUOMId =@QUOM_ID,
					--@usageUOMId =NULL,	AL: 16/08/09
					@FinalOcc =@Not_After, 
					@pricingDate =NULL, 
					@fromStdJobs =0, 
					@RunPlanning = 0,
					@RecalcCosts  = 0,
					@ForceCalc  = 0,
					@LastChangeUsage =@Last_Change_Usage, 
					@LastChangeDate =@Last_Change_Date,
					@RotablePartId =@Rotable_Part_Id, 
					@GroupNumber =@Group_No, 
					@PartId =@Part_Id,
					@PlanningTask =@Planning_Task,
					@PlanningLeadTime =@Lead_Days,
					@Schedule_Type_Id=@Schedule_Type_Id,
					@StartingSerialNo = @StartingSerialNo
	END
	ELSE IF @Projection_Type_ID= @ProjTypeCurrent
	BEGIN
		-- For the current projection if the new projected task is added link EQS tasks
		EXEC STRATEGY_TASK_LINK_TO_EQS_TASK_P @ProjTaskId=@ProjTaskId
	END

FINISH_COMMIT:

	COMMIT TRANSACTION
      	
	TRUNCATE TABLE #Options

	SET @CounterT=@CounterT-1  
END
--Delete the options which are not in the Std Jobs
FINISH_UPDATE:


-- DROP TABLE z_tblEqpProjs
-- SELECT * INTO z_tblEqpProjs FROM #z_tblEqpProjs

DROP TABLE #z_tblEqpProjs,#Options

FINISH:


-- DROP TABLE z_tblStdJobs
-- SELECT * INTO z_tblStdJobs FROM #z_tblStdJobs

DROP TABLE #z_tblStdJobs

SET NOCOUNT OFF

GO

/****** Object:  StoredProcedure [dbo].[REP_DAILY_PERF_CHECK_SHEET_P]    Script Date: 04/26/2012 17:04:52 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[REP_DAILY_PERF_CHECK_SHEET_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[REP_DAILY_PERF_CHECK_SHEET_P]
GO


/****** Object:  StoredProcedure [dbo].[REP_DAILY_PERF_CHECK_SHEET_P]    Script Date: 04/26/2012 17:04:52 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[REP_DAILY_PERF_CHECK_SHEET_P]   
/******************************************************************************  
 File: REP_DAILY_PERF_CHECK_SHEET_P.sql  
 Name: REP_DAILY_PERF_CHECK_SHEET_P  
  
 Called By:   
  
 Desc: 1. Get data set for DAILY MACHINE PERFORMANCE CHECK SHEET report  
               
  
 Auth: Sergey Babeshko  
 Date: 23-Feb-2005  
*******************************************************************************  
  Change History  
*******************************************************************************  
 Date:  Author:  Description:  
 -------- -------- ----------------------------------------  
 04 May 12   GD   Fixed 4057
 23 Apr 12   GD   Fixed 3962
 04 Apr 12   GD   Fixed 3913
 07 Mar 12   GD   Fixed 3682 
 27 Feb 12   GD   Enhancement 728  
 --OLD COMMENTS  
 21-Jul-07 KN   Fixed - Collation and tempDB Conflicts  
 14 Nov 06 SI  Changed to support date based tasks  
 21 Jun 06 k Nagarajan Modified the Date as Date-Range.  
 18 Mar 05 S Babeshko Change Target_Availability comes from REP_EQP_PLAN_SCHED_HRS, not from REP_DAILY_USAGE  
 22 Apr 05 S Babeshko Fixed calculation of the Daily Availability if there are more then 1 Events per day.   
     Added TotalMonthHours, TotalMonthHoursMA fields for calculated Allow Remaining Downtime  
*******************************************************************************/  
 /* Param List */    
 @DealerId INT = 1,    
 @BranchID varchar(8000) = '',    
 @SiteID varchar(8000) = '',    
 @FleetID varchar(8000) = '',    
 @EqpPlanID varchar(8000)='',    
 @TaskTypeID varchar(8000) = '',    
 @SystemId varchar(8000) = '',    
 @ResponsibilityID varchar(8000) = '',    
 @StartDate datetime = 'Jul  1 2003 17:00:00:000AM',    
 @EndDate datetime = 'Jul  1 2003 17:00:00:000AM' ,  
 @AvailabilityTypeID INT =1   
AS    
-- Declare    @EqpPlanID int    
-- Set @EqpPlanID=1000001    
-- Declare    @TaskTypeID varchar(8000)    
-- Set @TaskTypeID = ''    
-- Declare    @SystemId varchar(8000)    
-- Set @SystemId = ''    
-- Declare    @ResponsibilityID varchar(8000)    
-- Set @ResponsibilityID = '1'    
-- Declare    @StartDate datetime    
-- Set @StartDate = '07/01/2003 17:00:00:000AM'    
 Declare @SQL as varchar(8000)    
 Declare @SQL2 as varchar(8000)    
    
 IF @EqpPlanID = ''      
	BEGIN     
		SET @EqpPlanID = (SELECT DISTINCT(CAST(EqpPlanId AS VARCHAR))+',' FROM EQUIPMENT_HIERARCHY_V WHERE 1=1 AND    
		(@FleetID = '' OR FleetId IN( SELECT list_item FROM dbo.LIST_TO_TABLE_F(@FleetID)))  AND    
		(@SiteID = '' OR SiteId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@SiteID)))  AND    
		(@BranchID = '' OR BranchId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@BranchID))) AND    
		(@DealerId = '' OR DealerId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@DealerId) ))  FOR XML PATH(''))      
	SET @EqpPlanID = SUBSTRING(@EqpPlanID,1,LEN(@EqpPlanID)-1)
	END    
    
SET ANSI_WARNINGS OFF    
SET NOCOUNT ON    
    
 Declare @AvailabilityType as varchar(2)     
  
   
 Set @AvailabilityType = (SELECT Availability_ShortName FROM AVAILABILITY_TYPE WHERE Availability_Type_Id = @AvailabilityTypeID )      
    
-- Set @AvailabilityType = 'MA'    
-- print @StartDate    
-- print @EndDate    
-- print @AvailabilityType    
-- print @EqpPlan    
    
    
-- IF EXISTS(SELECT name     
--    FROM   sysobjects     
--    WHERE  name = N'aaa'     
--    AND   type = 'U')    
--     DROP TABLE aaa    
--set @AvailabilityType = 'MA'    
    
Declare @CountResponsib as int   
Declare @ResponsibId as int  
Declare @ResponsibName as varchar(50)   
  
CREATE TABLE #tmp_avail  
(Calendar_Date [datetime] NULL,  
Eqp_Plan_ID INT NULL,  
EqpPlan Varchar(500) COLLATE database_default DEFAULT NULL,  
Scheduled_Hours Float NULL,Actual_Usage Float NULL,Target_Downtime Float NULL,Target_MA_Downtime Float Null,Event_ID INT NULL ,Description VARCHAR(500) COLLATE database_default DEFAULT NULL,Responsibility_ID INT NULL,TaskTypeId INT NULL,SystemID INT NULL,
  
PeriodDowntimeHours FLOAT NULL,Actual_Down_Time DAteTime NULL,TotalMonthHours FLOAT NULL,
--GD  
Total_Scheduled_Hours real NULL,     
Total_Operating_Hours real NULL , Target_Downtime_PA Float NULL 
)  
  
INSERT INTO #tmp_avail    
SELECT  REP_DAILY_USAGE.Usage_Date as Calendar_Date, REP_DAILY_USAGE.Eqp_Plan_ID,tblEqpPlans.EqpPlan, REP_DAILY_USAGE.Scheduled_Hours,   
REP_DAILY_USAGE.Actual_Usage, CASE WHEN  @AvailabilityType = 'MA' THEN REP_EQP_PLAN_SCHED_HRS.Target_MA_Percent ELSE REP_EQP_PLAN_SCHED_HRS.Target_Availability_Percent END AS Target_Downtime,   
  
REP_DAILY_USAGE.Target_MA_Downtime, EVENT.Event_ID, EVENT.Description,RPT_DAILY_AVAILABILITY_V.Responsibility_ID, RPT_DAILY_AVAILABILITY_V.DTATaskTypeId TaskTypeId,    
RPT_DAILY_AVAILABILITY_V.SystemID,     
SUM(ROUND((CASE WHEN     
(ISNULL(CONVERT(float, RPT_DAILY_AVAILABILITY_V.Actual_Up_Time), 0) - ISNULL(CONVERT(float, RPT_DAILY_AVAILABILITY_V.Actual_Down_Time), 0))  <> 0  THEN     
((ISNULL(RPT_DAILY_AVAILABILITY_V.Actual_Hours, 0) /     
(ISNULL(CONVERT(float, RPT_DAILY_AVAILABILITY_V.Actual_Up_Time), 0) - ISNULL(CONVERT(float, RPT_DAILY_AVAILABILITY_V.Actual_Down_Time), 0)))) *     
(ISNULL(CONVERT(float, RPT_DAILY_AVAILABILITY_V.UpTime), 0) - ISNULL(CONVERT(float, RPT_DAILY_AVAILABILITY_V.DownTime), 0))     
ELSE 0 END), 2)) AS PeriodDowntimeHours, RPT_DAILY_AVAILABILITY_V.Actual_Down_Time,     
REP_EQP_PLAN_SCHED_HRS.Scheduled_Use_Hours as TotalMonthHours ,  
NULL AS Total_Scheduled_Hours,  
NULL AS Total_Operating_Hours  ,

CASE 
		WHEN (DATEDIFF(SECOND, REP_DAILY_USAGE.Usage_Date,  @StartDate)) > 0  AND (DATEDIFF(SECOND, REP_DAILY_USAGE.Usage_Date,@StartDate)) < 86400  
		THEN 
			CASE 
				WHEN ((DATEDIFF(SECOND, REP_DAILY_USAGE.Usage_Date,@EndDate)) < 86400 )
				THEN
					( (REP_DAILY_USAGE.Target_Downtime / (24.00 * 60.00)) * DATEDIFF(MINUTE,@StartDate ,@EndDate))  
				ELSE
					REP_DAILY_USAGE.Target_Downtime - ( (REP_DAILY_USAGE.Target_Downtime / (24.00 * 60.00)) * DATEDIFF(MINUTE, REP_DAILY_USAGE.Usage_Date, @StartDate ))  
			END
		WHEN (DATEDIFF(SECOND, REP_DAILY_USAGE.Usage_Date, @EndDate)) > 0  AND (DATEDIFF(SECOND, REP_DAILY_USAGE.Usage_Date, @EndDate)) < 86400  
		THEN ((REP_DAILY_USAGE.Target_Downtime / (24.00 * 60.00)) * DATEDIFF(MINUTE,REP_DAILY_USAGE.Usage_Date, @EndDate))  
  
		ELSE REP_DAILY_USAGE.Target_Downtime 
	end AS Target_Downtime_PA
  
  
FROM RPT_DAILY_AVAILABILITY_V INNER JOIN     
EVENT ON RPT_DAILY_AVAILABILITY_V.Event_ID = EVENT.Event_ID RIGHT OUTER JOIN     
REP_DAILY_USAGE ON RPT_DAILY_AVAILABILITY_V.Usage_Date = REP_DAILY_USAGE.Usage_Date AND     
RPT_DAILY_AVAILABILITY_V.EqpPlanId = REP_DAILY_USAGE.Eqp_Plan_ID AND   
(@EqpPlanID = '' OR RPT_DAILY_AVAILABILITY_V.EqpPlanId IN ( SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EqpPlanID)  )) AND     
(RPT_DAILY_AVAILABILITY_V.Usage_Date >=  @StartDate ) AND     
(RPT_DAILY_AVAILABILITY_V.Usage_Date <  @EndDate ) INNER JOIN     
REP_EQP_PLAN_SCHED_HRS ON REP_EQP_PLAN_SCHED_HRS.Eqp_Plan_ID = REP_DAILY_USAGE.Eqp_Plan_ID INNER JOIN     
CALENDAR_DATES ON REP_DAILY_USAGE.Usage_Date = CALENDAR_DATES.Calendar_Date AND     
REP_EQP_PLAN_SCHED_HRS.Calendar_Period = CALENDAR_DATES.Calendar_Period INNER JOIN  
tblEqpPlans ON REP_DAILY_USAGE.Eqp_Plan_ID = tblEqpPlans.EqpPlanId     
WHERE     (REP_DAILY_USAGE.Usage_Date >=  @StartDate ) AND     
(REP_DAILY_USAGE.Usage_Date <  @EndDate ) AND ( @EqpPlanID = '' OR REP_DAILY_USAGE.Eqp_Plan_ID IN ( SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EqpPlanID) )) AND    
( @TaskTypeID = '' OR RPT_DAILY_AVAILABILITY_V.DTATaskTypeId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@TaskTypeID)  )   ) AND  
( @SystemID = ''  OR RPT_DAILY_AVAILABILITY_V.SystemID IN ( SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@SystemID)  )  )   
GROUP BY EVENT.Event_ID, REP_DAILY_USAGE.Usage_Date, EVENT.Description, RPT_DAILY_AVAILABILITY_V.Responsibility_ID,     
RPT_DAILY_AVAILABILITY_V.DTATaskTypeId, RPT_DAILY_AVAILABILITY_V.SystemID, REP_DAILY_USAGE.Eqp_Plan_ID,     
REP_DAILY_USAGE.Scheduled_Hours, REP_DAILY_USAGE.Actual_Usage,     
CASE WHEN  @AvailabilityType = 'MA' THEN REP_EQP_PLAN_SCHED_HRS.Target_MA_Percent ELSE REP_EQP_PLAN_SCHED_HRS.Target_Availability_Percent END,  
REP_DAILY_USAGE.Target_MA_Downtime, RPT_DAILY_AVAILABILITY_V.Actual_Down_Time, REP_EQP_PLAN_SCHED_HRS.Scheduled_Use_Hours,tblEqpPlans.EqpPlan,REP_DAILY_USAGE.Target_Downtime   
  
-- if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[aaa]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)    
-- drop table [dbo].[aaa1]    
  
  
 CREATE TABLE [dbo].[#tmp_result] ( 
 Line_Num int IDENTITY(1,1),   
 [Calendar_Date] [datetime] NULL ,    
 [Scheduled_Hours] [float] NULL ,    
 [Operating_Hours] [float] NULL ,    
 [Event_ID] [int] NULL ,    
 [EventDescription] [varchar] (500) COLLATE database_default DEFAULT '' NULL ,    
 [DailyAvailability] [float] NULL ,    
 [MTD] [float] NULL ,    
 [TotalDowntimeEvent] [float] NULL ,    
 [MTBS] [bit] NULL,    
 [TotalAvailability] [float] NULL,    
 [TotalDowntime] [float] NULL,    
 [Target_Downtime] [float] NULL,    
 [Respons1] [float] NULL ,    
 [Respons2] [float] NULL ,    
 [Respons3] [float] NULL ,    
 [ResponsName1] [varchar] (50) COLLATE database_default DEFAULT '' NULL ,    
 [ResponsName2] [varchar] (50) COLLATE database_default DEFAULT '' NULL ,    
 [ResponsName3] [varchar] (50) COLLATE database_default DEFAULT '' NULL ,    
 [Total_Scheduled_Hours] [real] NULL,     
 [Total_Operating_Hours] [real] NULL,     
 [Max_MTD] [float] NULL,     
 [Total_Stoppages] [int] NULL,     
 [TotalMonthHours] [float] NULL,     
 [TotalMonthHoursMA] [float] NULL,Eqp_Plan_ID INT NULL,       
 [EqpPlan] [varchar] (500) COLLATE database_default DEFAULT '' NULL  ,
 [Total_MTD] [float] NULL,
 [Total_Target_Downtime] [float] NULL,
 [Allowable_Remaining_Downtime] [float] NULL,
 [Eqp_Required] [varchar] (500) COLLATE database_default DEFAULT '' NULL,
 [Target_Downtime_MA] [float] NULL,
 [Actual_Usage] [float] NULL,
 [Target_Downtime_PA] Float NULL  
 
  ) ON [PRIMARY]  
   
 DECLARE @Responsibilty VARCHAR(MAX)  
 SELECT @Responsibilty = List_Item FROM dbo.LIST_TO_TABLE_F(@ResponsibilityID)  
    
 INSERT INTO #tmp_result (Calendar_Date, Scheduled_Hours, Operating_Hours, Event_ID, EventDescription, TotalMonthHours,EqpPlan, Eqp_Plan_ID,Target_Downtime_MA,Actual_Usage,Target_Downtime_PA)     
 SELECT Calendar_Date, AVG(Scheduled_Hours), AVG(Actual_Usage), Event_ID, [Description], TotalMonthHours,EqpPlan ,Eqp_Plan_ID ,Target_MA_Downtime ,Actual_Usage,Target_Downtime_PA  
 FROM #tmp_avail     
 GROUP BY Calendar_Date, Event_ID, [Description], TotalMonthHours ,EqpPlan ,Eqp_Plan_ID ,Target_MA_Downtime  ,Actual_Usage,Target_Downtime_PA
  
 Declare @MaxDate as datetime     
 SET @MaxDate = (SELECT MAX(Calendar_Date) FROM #tmp_avail)    
-- Totals downtime per Event per Day, MTBS    
 UPDATE #tmp_result     
 SET #tmp_result.TotalDowntimeEvent = X.TotalDowntimeEvent, #tmp_result.MTBS = X.MTBS     
 FROM (SELECT Calendar_Date, Event_ID, SUM(PeriodDowntimeHours) AS TotalDowntimeEvent,   
 MAX(CASE WHEN (Actual_Down_Time < dateadd(day, 1, Calendar_Date) AND Actual_Down_Time >= Calendar_Date)  AND(  @Responsibilty = '' OR Responsibility_ID IN ( @Responsibilty ))  
 THEN 1 ELSE 0 END) AS MTBS     
 FROM  #tmp_avail WHERE Event_ID is not null     
 GROUP BY Calendar_Date, Event_ID) X     
 WHERE #tmp_result.Calendar_Date = x.Calendar_Date AND #tmp_result.Event_ID = x.Event_ID     
     
    
---- Daily Availability, MTD     
 SELECT Calendar_Date, MAX(Scheduled_Hours) AS Scheduled_Hours, MAX(Actual_Usage) AS Operating_Hours, EqpPlan AS EqpPlan   
 INTO #Total_Hours FROM #tmp_avail GROUP BY Calendar_Date, EqpPlan    
    
UPDATE #tmp_result  SET #tmp_result.DailyAvailability = X.DailyAvailability FROM ( SELECT Calendar_Date, EqpPlan,   CASE WHEN @AvailabilityType = 'MA' THEN     CASE WHEN (AVG(Actual_Usage) + SUM(CASE WHEN ISNULL(@Responsibilty,'')='' OR Responsibility_ID IN (@Responsibilty) THEN PeriodDowntimeHours ELSE 0 END)) <> 0 THEN AVG(Actual_Usage)/(AVG(Actual_Usage) + SUM(CASE WHEN ISNULL(@Responsibilty,'')='' OR Responsibility_ID IN (@Responsibilty) THEN PeriodDowntimeHours ELSE 0 END)) ELSE 0 END   ELSE   CASE WHEN AVG(Scheduled_Hours) <> 0 THEN (AVG(Scheduled_Hours) - SUM(CASE WHEN ISNULL(@Responsibilty,'')='' OR Responsibility_ID IN (@Responsibilty) THEN PeriodDowntimeHours ELSE 0 END)) / AVG(Scheduled_Hours) ELSE 0 END     END AS DailyAvailability  FROM  #tmp_avail   GROUP BY Calendar_Date, EqpPlan ) X  WHERE #tmp_result.Calendar_Date = x.Calendar_Date AND #tmp_result.EqpPlan = x.EqpPlan    
   
   
--Update  MTDs for Indivisual Equipments   
UPDATE #tmp_result    
SET  #tmp_result.MTD = X.MTD    
FROM (SELECT Calendar_Date,EqpPlan,  
(  
SELECT CASE WHEN @AvailabilityType = 'MA' THEN   
   CASE WHEN ((Select SUM(#Total_Hours.Operating_Hours) from #Total_Hours where #Total_Hours.Calendar_Date <= #tmp_avail.Calendar_Date) + SUM(a.PeriodDowntimeHours)) <> 0 THEN (Select SUM(#Total_Hours.Operating_Hours) from #Total_Hours where #Total_Hours.
Calendar_Date <= #tmp_avail.Calendar_Date)/((Select SUM(#Total_Hours.Operating_Hours) from #Total_Hours where #Total_Hours.Calendar_Date <= #tmp_avail.Calendar_Date) + SUM(a.PeriodDowntimeHours)) ELSE 0 END   
    ELSE   
   CASE WHEN (Select SUM(#Total_Hours.Scheduled_Hours) from #Total_Hours where #Total_Hours.Calendar_Date <= #tmp_avail.Calendar_Date) <> 0 THEN ((Select SUM(#Total_Hours.Scheduled_Hours) from #Total_Hours where #Total_Hours.Calendar_Date <= #tmp_avail.Calendar_Date) - SUM(a.PeriodDowntimeHours)) / (Select SUM(#Total_Hours.Scheduled_Hours) from #Total_Hours where #Total_Hours.Calendar_Date <= #tmp_avail.Calendar_Date) ELSE 0 END  
END FROM  #tmp_avail a  WHERE a.Calendar_Date <= #tmp_avail.Calendar_Date  
)   
AS MTD    
FROM  #tmp_avail    
GROUP BY Calendar_Date,EqpPlan) X    
WHERE #tmp_result.Calendar_Date = x.Calendar_Date AND #tmp_result.EqpPlan = X.EqpPlan    

--Update MTD for all equipments
UPDATE #tmp_result    
SET  #tmp_result.Total_MTD = X.MTD    
FROM (SELECT Calendar_Date,  
(  
SELECT CASE WHEN @AvailabilityType = 'MA' THEN   
   CASE WHEN ((Select SUM(#Total_Hours.Operating_Hours) from #Total_Hours where #Total_Hours.Calendar_Date <= #tmp_avail.Calendar_Date) + SUM(a.PeriodDowntimeHours)) <> 0 THEN (Select SUM(#Total_Hours.Operating_Hours) from #Total_Hours where #Total_Hours.
Calendar_Date <= #tmp_avail.Calendar_Date)/((Select SUM(#Total_Hours.Operating_Hours) from #Total_Hours where #Total_Hours.Calendar_Date <= #tmp_avail.Calendar_Date) + SUM(a.PeriodDowntimeHours)) ELSE 0 END   
    ELSE   
   CASE WHEN (Select SUM(#Total_Hours.Scheduled_Hours) from #Total_Hours where #Total_Hours.Calendar_Date <= #tmp_avail.Calendar_Date) <> 0 THEN ((Select SUM(#Total_Hours.Scheduled_Hours) from #Total_Hours where #Total_Hours.Calendar_Date <= #tmp_avail.Calendar_Date) - SUM(a.PeriodDowntimeHours)) / (Select SUM(#Total_Hours.Scheduled_Hours) from #Total_Hours where #Total_Hours.Calendar_Date <= #tmp_avail.Calendar_Date) ELSE 0 END  
END FROM  #tmp_avail a  WHERE a.Calendar_Date <= #tmp_avail.Calendar_Date  
)   
AS MTD    
FROM  #tmp_avail    
GROUP BY Calendar_Date) X    
WHERE #tmp_result.Calendar_Date = x.Calendar_Date   
  
  
-- Totals Availability and Downtime for selected responsibilities    
  
   
---- Update hours    
UPDATE #tmp_avail SET Total_Scheduled_Hours = HRS.Scheduled_Hours  
FROM (SELECT SUM(Scheduled_Hours) AS Scheduled_Hours,EqpPlan FROM  #Total_Hours GROUP BY EqpPlan )HRS  
WHERE #tmp_avail.EqpPlan = HRS.EqpPlan  
  
UPDATE #tmp_avail SET Total_Operating_Hours = HRS.Total_Operating_Hours  
FROM (SELECT SUM(Operating_Hours) AS Total_Operating_Hours,EqpPlan FROM  #Total_Hours GROUP BY EqpPlan )HRS  
WHERE #tmp_avail.EqpPlan = HRS.EqpPlan   
  
UPDATE #tmp_result SET #tmp_result.Total_Scheduled_Hours = #tmp_avail.Total_Scheduled_Hours   
FROM #tmp_avail  WHERE #tmp_result.EqpPlan = #tmp_avail.EqpPlan   
  
UPDATE #tmp_result SET #tmp_result.Total_Operating_Hours = #tmp_avail.Total_Operating_Hours   
FROM #tmp_avail  WHERE #tmp_result.EqpPlan = #tmp_avail.EqpPlan    
  
  
  
UPDATE #tmp_result  
SET #tmp_result.TotalAvailability = X.TotalAvailability  
FROM   
 (  
 SELECT EqpPlan, CASE WHEN @AvailabilityType = 'MA' THEN  
 CASE WHEN (#tmp_avail.Total_Operating_Hours + SUM(PeriodDowntimeHours)) <> 0 THEN #tmp_avail.Total_Operating_Hours/(Total_Operating_Hours + SUM(PeriodDowntimeHours)) ELSE 0 END            
 ELSE CASE WHEN Total_Scheduled_Hours <> 0 THEN (Total_Scheduled_Hours - SUM(PeriodDowntimeHours)) / Total_Scheduled_Hours ELSE 0 END END AS TotalAvailability  
 FROM  #tmp_avail   WHERE (ISNULL(@Responsibilty,'') = '' OR Responsibility_ID IN (@Responsibilty))  
 GROUP BY EqpPlan ,Total_Operating_Hours,Total_Scheduled_Hours  
 )X  
WHERE #tmp_result.EqpPlan = X.EqpPlan  
  
--Update Target Downtime for Indivisual equipments  
UPDATE #tmp_result   
SET #tmp_result.Target_Downtime = TDT.Target_Downtime   
FROM  
 (SELECT AVG(Target_Downtime) AS Target_Downtime,EqpPlan FROM  #tmp_avail Group By EqpPlan)TDT  
WHERE #tmp_result.EqpPlan = TDT.EqpPlan  

--Update Total_Target_Downtime Downtime for all equipments  
UPDATE #tmp_result   
SET #tmp_result.Total_Target_Downtime = TDT.Target_Downtime   
FROM  
 (SELECT AVG(Target_Downtime) AS Target_Downtime FROM  #tmp_avail )TDT  
  
UPDATE #tmp_result   
SET #tmp_result.TotalDowntime = TDT.TotalDowntime   
FROM  
 (SELECT SUM(PeriodDowntimeHours) AS TotalDownTime,EqpPlan FROM  #tmp_avail Group By EqpPlan)TDT  
WHERE #tmp_result.EqpPlan = TDT.EqpPlan  
  
---- Downtime for responsibilities columns   
 SET @CountResponsib = 0   
    
declare Responsib_Cursor cursor for    
SELECT  TOP 3   Responsibility_ID, [Description]    
FROM RESPONSIBILITY   
ORDER BY [Description]   
    
OPEN Responsib_Cursor   
FETCH NEXT FROM Responsib_Cursor INTO @ResponsibId, @ResponsibName     
    
 WHILE @@FETCH_STATUS = 0     
 BEGIN     
 SET @CountResponsib = @CountResponsib + 1     
 IF @CountResponsib = 1     
 BEGIN     
 UPDATE #tmp_result SET ResponsName1 = @ResponsibName     
 UPDATE #tmp_result     
 SET Respons1 = X.DowntimeRespons     
 FROM (SELECT Calendar_Date, Event_ID, SUM(PeriodDowntimeHours) AS DowntimeRespons     
 FROM #tmp_avail     
 WHERE Responsibility_ID = @ResponsibId     
 GROUP BY Calendar_Date, Event_ID, EqpPlan) X     
 WHERE #tmp_result.Calendar_Date = X.Calendar_Date AND #tmp_result.Event_ID = X.Event_ID     
 END     
 ELSE IF @CountResponsib = 2     
 BEGIN     
 UPDATE #tmp_result SET ResponsName2 = @ResponsibName     
 UPDATE #tmp_result     
 SET Respons2 = X.DowntimeRespons     
 FROM (SELECT Calendar_Date, Event_ID, SUM(PeriodDowntimeHours) AS DowntimeRespons     
 FROM #tmp_avail     
 WHERE Responsibility_ID = @ResponsibId     
 GROUP BY Calendar_Date, Event_ID) X     
 WHERE #tmp_result.Calendar_Date = X.Calendar_Date AND #tmp_result.Event_ID = X.Event_ID     
 END     
 ELSE IF @CountResponsib = 3     
 BEGIN     
 UPDATE #tmp_result SET ResponsName3 = @ResponsibName     
 UPDATE #tmp_result     
 SET Respons3 = X.DowntimeRespons     
 FROM (SELECT Calendar_Date, Event_ID, SUM(PeriodDowntimeHours) AS DowntimeRespons     
 FROM #tmp_avail     
 WHERE Responsibility_ID = @ResponsibId     
 GROUP BY Calendar_Date, Event_ID) X     
 WHERE #tmp_result.Calendar_Date = X.Calendar_Date AND #tmp_result.Event_ID = X.Event_ID      
 END     
    
 FETCH NEXT FROM Responsib_Cursor     
 INTO @ResponsibId, @ResponsibName     
 END    
    
 CLOSE Responsib_Cursor     
 DEALLOCATE Responsib_Cursor   
    
 INSERT INTO #tmp_result (EqpPlan, Calendar_Date)   
 SELECT distinct Eqpplan,P.Calendar_Date
 FROM    #tmp_result 
 CROSS JOIN
 (  
 SELECT Calendar_Date FROM CALENDAR_DATES       
 WHERE (Calendar_Date >=  convert(varchar, @StartDate) )
  AND(Calendar_Date <  convert(varchar, @EndDate) ) 
  AND Calendar_Date NOT IN (SELECT DISTINCT Calendar_Date FROM #tmp_result)
 ) AS P   
  
   
 DROP TABLE #tmp_avail    
-- Update Max_MTD, total_stoppages    
 UPDATE #tmp_result SET Max_MTD = X.MTD FROM (SELECT EqpPlan, a.MTD * 100 MTD FROM #tmp_result a WHERE a.Calendar_Date = @MaxDate) X  
 WHERE  #tmp_result.EqpPlan = X.EqpPlan    
 UPDATE #tmp_result SET Total_Stoppages = X.Total_Stoppages FROM (SELECT EqpPlan,COUNT(a.MTBS) Total_Stoppages FROM #tmp_result a WHERE a.MTBS = 1 GROUP BY EqpPlan) X    
 WHERE  #tmp_result.EqpPlan = X.EqpPlan  
   
 Declare @TotalMonthHoursMA as float   
 --select * from #tmp_result  
     
     
UPDATE #tmp_result SET TotalMonthHoursMA = ISNULL(TMH.UsagePerday,0)  
FROM(   
 SELECT SUM((CONVERT(float, CASE WHEN cd.CalDateEndTime > us.StepEndDate THEN us.StepEndDate ELSE cd.CalDateEndTime END) -     
 CONVERT(float, CASE WHEN cd.CalDateStartTime > us.StepStartDate THEN cd.CalDateStartTime ELSE us.StepStartDate END)) *     
 UsagePerday) AS UsagePerday , cd.EqpPlanID   
   
 FROM  dbo.SCH_HRS_BY_DATE_AND_EQP_PLAN_V cd INNER JOIN     
 dbo.REP_USAGE_STEP_V us ON cd.EqpPlanId = us.EqpPlanId AND ISNULL(cd.QUOMId,0) = ISNULL(us.QUOMId,0) AND cd.CalDateStartTime <= us.StepEndDate AND     
 cd.CalDateEndTime > us.StepStartDate     
 WHERE (@EqpPlanID = '' OR cd.EqpPlanId IN ( SELECT List_Item FROM dbo.LIST_TO_TABLE_2_F(@EqpPlanID)) )  
 AND cd.CalDateStartTime in (select distinct Calendar_Date from #tmp_result where Operating_Hours is null )  
 GROUP BY cd.EqpPlanID  )TMH  
 WHERE #tmp_result.Eqp_Plan_ID = TMH.EqpPlanID  

 UPDATE #tmp_result SET TotalMonthHoursMA =  ISNULL(TotalMonthHoursMA,0)+ Total_Operating_Hours  
 
 --Calculate Variables for report   
 UPDATE #tmp_result
 SET #tmp_result.Allowable_Remaining_Downtime = ART.Allowable_Remaining_Time1
 FROM
 (
 SELECT EqpPlan,
 CASE WHEN @AvailabilityType = 'MA' THEN 
	CASE WHEN Max(Target_Downtime) !=0 THEN  
	(Max(TotalMonthHoursMA)*100/Max(Target_Downtime) )-Max(TotalMonthHoursMA) -Max(TotalDowntime)
	ELSE 0 END 
 ELSE 
 (Max(TotalMonthHours) * (100 - MAX(Target_Downtime)))/100-Max(TotalDowntime) 
 END AS Allowable_Remaining_Time1 
 FROM #tmp_result
 GROUP BY EqpPlan
 )ART
 WHERE  #tmp_result.EqpPlan = ART.EqpPlan
 
 --Update required field
 UPDATE #tmp_result
 SET #tmp_result.Eqp_Required = ER.ERequired
 FROM (
 SELECT EqpPlan, 
 CASE WHEN MONTH(MIN(Calendar_Date))= MONTH(GETDATE()) AND YEAR(MIN(Calendar_Date))= YEAR(GETDATE()) THEN
	CASE WHEN @AvailabilityType = 'MA' THEN 
	CASE WHEN (Max(TotalMonthHoursMA) - Max(Total_Operating_Hours) + Allowable_Remaining_Downtime) !=0
		 THEN Round(((Max(TotalMonthHoursMA) -Max(Total_Operating_Hours))/(Max(TotalMonthHoursMA) - Max(Total_Operating_Hours) + Allowable_Remaining_Downtime)) * 100,2)
		 ELSE 0.00 END
	ELSE 
	CASE WHEN (Max(TotalMonthHours) -Max(Total_Scheduled_Hours) )!=0 THEN 	
	Round(((Max(TotalMonthHours)-Max(Total_Scheduled_Hours)-Allowable_Remaining_Downtime)/(Max(TotalMonthHours)-Max(Total_Scheduled_Hours)))*100,2)
	ELSE 0.00 END
	END
		
 ELSE NULL END AS ERequired
 FROM #tmp_result
 GROUP BY EqpPlan,Allowable_Remaining_Downtime
 )ER
 WHERE  #tmp_result.EqpPlan = ER.EqpPlan
 
 IF EXISTS (SELECT * FROM #tmp_result GROUP BY EqpPlan, Calendar_Date HAVING COUNT(*)>1)
	BEGIN
		 SET ANSI_WARNINGS ON 

		UPDATE #tmp_result
		SET EventDescription = TEMP.EventDescription
		FROM #tmp_result INNER JOIN
		( SELECT  EqpPlan, Calendar_Date,
		STUFF((SELECT ', ' + CAST(EventDescription AS VARCHAR(MAX))FROM #tmp_result WHERE (EqpPlan = Results.EqpPlan AND Calendar_Date = Results.Calendar_Date) FOR XML PATH(''),TYPE ).value('.','VARCHAR(MAX)'),1,2,'') as EventDescription
		FROM    #tmp_result Results
		GROUP BY EqpPlan, Calendar_Date) TEMP
		ON #tmp_result.EqpPlan = TEMP.EqpPlan AND #tmp_result.Calendar_Date = TEMP.Calendar_Date


		UPDATE #tmp_result
		SET Respons1 = X.Respons1,
		Respons2 = X.Respons2,
		Respons3 = X.Respons3,
		TotalDownTimeEvent = X.TotalDownTimeEvent
		FROM #tmp_result INNER JOIN
		(
		SELECT EqpPlan,Calendar_Date,SUM(Respons1) AS Respons1, SUM(Respons2) AS Respons2, SUM(Respons3) AS Respons3, SUM(TotalDownTimeEvent) AS TotalDownTimeEvent FROM #tmp_result
		GROUP BY EqpPlan,Calendar_Date)X
		ON X.EqpPlan = #tmp_result.EqpPlan AND X.Calendar_Date = #tmp_result.Calendar_Date


		DELETE
		FROM #tmp_result
		WHERE Line_Num NOT IN
		(
			SELECT MAX(Line_Num)
			FROM #tmp_result
			GROUP BY EqpPlan, Calendar_Date
		)
	END  
    
 SELECT Calendar_Date, Scheduled_Hours, Operating_Hours, Event_ID, EventDescription, DailyAvailability * 100 as DailyAvailability,     
 MTD * 100 as MTD, TotalDowntimeEvent, MTBS, ISNULL(TotalAvailability, 0) * 100 as TotalAvailability, ISNULL(TotalDowntime, 0) AS TotalDowntime,     
 Target_Downtime, Respons1, Respons2, Respons3, ResponsName1, ResponsName2, ResponsName3,     
 @AvailabilityType  as AvailabilityType, EqpPlan,     
 ISNULL(Total_Scheduled_Hours,0) AS Total_Scheduled_Hours, ISNULL(Total_Operating_Hours,0) AS Total_Operating_Hours, Max_MTD, ISNULL(Total_Stoppages,0) AS Total_Stoppages, ISNULL(TotalMonthHours,0) AS TotalMonthHours, ISNULL(TotalMonthHoursMA,0) AS TotalMonthHoursMA ,ISNULL(Total_MTD,0) * 100 AS  Total_MTD ,Total_Target_Downtime,ROUND(Allowable_Remaining_Downtime,2) AS Allowable_Remaining_Downtime,
 ISNULL(Eqp_Required,'N/A') AS Eqp_Required FROM #tmp_result     
 ORDER BY  EqpPlan, Calendar_Date  
 
 

 SELECT A.Calendar_Date, CASE WHEN @AvailabilityType = 'MA' THEN ISNULL(SUM(A.Operating_Hours)/ NULLIF(SUM(A.Operating_Hours)+ ISNULL(SUM(A.TotalDowntimeEvent),0),0),0)*100 ELSE 
 ISNULL((SUM(A.Scheduled_Hours)- ISNULL(SUM(A.TotalDowntimeEvent),0)) / NULLIF(SUM(A.Scheduled_Hours),0),0) *100 END AS DailyAvailability
 ,ISNULL(min(A.Total_MTD),0) * 100 AS Total_MTD,
 TEMP.Total_Target_Downtime
 FROM 
 (	SELECT EqpPlan,Calendar_Date, AVG(Scheduled_Hours) AS Scheduled_Hours,AVG(Operating_Hours) AS Operating_Hours,SUM(TotalDowntimeEvent) as TotalDowntimeEvent,
	AVG(Target_Downtime) as Target_Downtime, MIN(Total_MTD) AS Total_MTD
	FROM 
	#tmp_result  
	GROUP BY EqpPlan,Calendar_Date
  ) a
  INNER JOIN
	(SELECT Calendar_Date,CASE WHEN @AvailabilityType = 'MA' THEN 
	CASE WHEN ISNULL((ISNULL(SUM (Actual_Usage),0)+ SUM (ISNULL(Target_Downtime_MA,0))),0)>0 THEN 
	ISNULL(SUM(Actual_Usage),0)/ISNULL((ISNULL(SUM (Actual_Usage),0)+ SUM (ISNULL(Target_Downtime_MA,0))),0)*100 ELSE 0 END
	ELSE CASE WHEN SUM(ISNULL(Scheduled_Hours,0))>0 THEN(SUM (ISNULL(Scheduled_Hours,0))- SUM (ISNULL(Target_Downtime_PA,0)))/SUM(ISNULL(Scheduled_Hours,0))*100 ELSE 0 END END AS  Total_Target_Downtime
	FROM #tmp_result
	GROUP BY Calendar_Date) TEMP
ON a.Calendar_Date = TEMP.Calendar_Date
GROUP BY  A.Calendar_Date ,TEMP.Total_Target_Downtime 
 
 DROP TABLE #tmp_result
SET ANSI_WARNINGS ON  
SET NOCOUNT OFF  



GO



if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[RPT_EVENT_ANALYSIS_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[RPT_EVENT_ANALYSIS_P]
GO
 

CREATE             Procedure RPT_EVENT_ANALYSIS_P  
/******************************************************************************  
 File:   
 Name: RPT_EVENT_ANALYSIS_GET_P  
  
 Called By:   
  
 Desc: Get data for Event Analysis Report  
               
  
 Auth: Mat Lam  
 Date: 11-Mar-2003  
*******************************************************************************  
  Change History  
*******************************************************************************  
 Date:  Author:  Description:  
 -------- -------- ----------------------------------------  
 6 Feb 04 M Lam  Added Preventable Filter and Analyse By  
 19 Apr 04 D Smith  For 'plan to current month', set To Date to now  
 06 Sep 06 K Nagarajan Added DateBase Output Parameter   
 09 May 08 KN/YS  Added Line Chart  
 27 May 08 AL   Replaced varchar(MAX) to varchar(MAX)  
 27 Jan 09 V Vasylyeva Added AnalyseByItemId  
 30 Jan 09 V Vasylyeva Added AnalyseBy Source  
 21 Sep 09 Tas   CR8389: Added UserID  
 26 Oct 11   G Dhillon   Fixed issue 2699  
 22 Feb 12 DA   E741  
 3	Apr 12 JW	3870 Modified to use tblFinancialPeriods table to populate Month table
*******************************************************************************/  
 /* Param List */  
  
 @DealerId int = 1,    
 @BranchId varchar(MAX) = NULL,    
 @SiteId varchar(MAX) = NULL,    
 @FleetId varchar(MAX) = NULL,    
 @EqpPlanId varchar(MAX) = NULL,    
 @ModelId varchar(MAX) = NULL,    
 @ResponsibilityId varchar(MAX) = NULL,    
 @EventTaskTypeId varchar(MAX) = NULL,    
 @CostTypeId varchar(MAX) = NULL,    
 @SystemId varchar(MAX) = NULL,    
 @SubSystemId varchar(MAX) = NULL,    
 @ComponentCodeId varchar(MAX) = NULL,    
 @Planned int = 1,    
 @Breakdown int = 1,    
 @Redo int = 1,    
 @DTACauseId varchar(MAX) = Null,    
 @ActivityId varchar(MAX) = Null,    
 @VarianceCauseId varchar(MAX) = Null,    
 @EMIssueId varchar(MAX) = Null,      
 @StartDate datetime = '11-11-1990',    
 @EndDate datetime = '11-11-2005',    
 @AnalyseBy varchar(10)= 'QRTR',    
 @Chart bit = 0,    
 @PlanToCurrent bit =0,    
 @preventableId varchar(MAX) = '',    
 @DateBased varchar(10) = 'False' OUTPUT,    
 @LineChart BIT = 0,    
 @UserID INT=0    
     
        
AS    
SET NOCOUNT ON    
    
 SET  @DateBased= 'False'     
    
 IF @AnalyseBy = 'MONH' OR @AnalyseBy = 'QRTR' OR @AnalyseBy = 'YEAR'      
 BEGIN    
  SET @DateBased = 'True'    
 END    
--*******************************************    
  --Change Start    
  --Tas 21-Sep-2009    
  SET @UserId=ISNULL(@UserId,0)    
  DECLARE @Level int    
  SELECT @Level=User_Access_Level_Id From USER_LEVEL_PERMISSION where AMT_User_Id = @UserId    
  SET @Level=ISNULL(@Level,0)    
   /*    
   0 -ALL    
   1-Branch,    
   2-Site    
   */    
  --Change End    
 --*******************************************    
    
 if @PlanToCurrent = 1    
 begin    
  exec GET_MIN_EQP_PLAN_START_DATE_P    
   @DealerId = @DealerId,    
   @BranchId = @branchId,    
   @SiteId = @SiteId,     
   @FleetId = @FleetId,    
   @EqpPlanId = @EqpPlanId,    
   @StartDate = @StartDate OUTPUT    
      
  --DS 19-Apr-2004    
  set @EndDate = GetDate()    
    
  --print @startDate    
 end     
     
 --IF @DealerId <> '' SET @DealerId=','+@DealerId+',' ELSE SET @DealerId = Null    
    IF @BranchId <> '' SET @BranchId=','+@BranchId+',' ELSE SET @BranchId = Null    
    IF @SiteId <> ''  SET @SiteId=','+@SiteId+',' ELSE SET @SiteId = Null    
    IF @FleetId <> ''  SET @FleetId=','+@FleetId+',' ELSE SET @FleetId = Null    
    IF @EqpPlanId <> ''  SET @EqpPlanId=','+@EqpPlanId+',' ELSE SET @EqpPlanId = Null    
    
 IF @ModelId <> '' SET @ModelId=','+@ModelId+',' ELSE SET @ModelId = Null    
 IF @ResponsibilityId <> '' SET @ResponsibilityId=','+@ResponsibilityId+','  ELSE SET @ResponsibilityId = Null        
 IF @EventTaskTypeId <> '' SET @EventTaskTypeId=','+@EventTaskTypeId+',' ELSE SET @EventTaskTypeId = Null    
     
 IF @CostTypeId <> '' SET @CostTypeId=','+@CostTypeId+',' ELSE SET @CostTypeId = Null    
 IF @SystemId <> '' SET @SystemId=','+@SystemId+',' ELSE SET @SystemId = Null    
 IF @SubSystemId <> '' SET @SubSystemId=','+@SubSystemId+',' ELSE SET @SubSystemId = Null    
 IF @ComponentCodeId <> '' SET @ComponentCodeId=','+@ComponentCodeId+',' ELSE SET @ComponentCodeId = Null    
     
 IF @DTACauseId <> '' SET @DTACauseId=','+@DTACauseId+',' ELSE SET @DTACauseId = Null    
 IF @ActivityId <> '' SET @ActivityId=','+@ActivityId+',' ELSE SET @ActivityId = Null    
 IF @VarianceCauseId <> '' SET @VarianceCauseId=','+@VarianceCauseId+',' ELSE SET @VarianceCauseId = Null    
 IF @EMIssueId <> '' SET @EMIssueId=','+@EMIssueId+',' ELSE SET @EMIssueId = Null     
 IF @preventableId <> '' SET @preventableId=','+@preventableId+',' ELSE SET @preventableId = Null     
     
    
    
SELECT      
    
*    
INTO #FILTERED    
From RPT_EVENT_ANALYSIS_V     
    
Where    
 ActualDownTime  >= @StartDate     
 And ActualDownTime <= @EndDate And    
 DealerId = IsNull(@DealerId,DealerId) And    
 --*******************************************    
 --Change Start    
 --Tas 21-Sep-2009    
 (@Level<>1 OR BranchId IN(SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = @UserId))AND    
 (@Level<>2 OR SiteId IN(SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = @UserId)) AND    
     
 --Change End    
 --*******************************************    
    
 case when @BranchId is not null then CHARINDEX(',' + CONVERT(varchar,BranchId) + ',',@BranchId) else 1 end > 0 And    
 case when @SiteId is not null then CHARINDEX(',' + CONVERT(varchar,SiteId) + ',',@SiteId) else 1 end > 0 And    
 case when @FleetId is not null then CHARINDEX(',' + CONVERT(varchar,FleetId) + ',',@FleetId) else 1 end > 0 And    
 case when @EqpPlanId is not null then CHARINDEX(',' + CONVERT(varchar,EqpPlanId) + ',',@EqpPlanId) else 1 end > 0    
  
IF @LineChart = 1    
BEGIN    
 BEGIN  
  SELECT     
   CASE @AnalyseBy    
   WHEN 'DEAL' THEN Dealer    
    WHEN 'BRAN' THEN Branch    
    WHEN 'SITE' THEN Site    
    WHEN 'FLEE' THEN Fleet    
    WHEN 'EQPL' THEN EqpPlan    
    WHEN 'MODL' THEN Model    
    WHEN 'RESP' THEN Responsibility    
    WHEN 'EVTT' THEN EventTaskType    
    WHEN 'VARC' THEN VarianceCause    
    WHEN 'EMI' THEN (CASE WHEN EMIssue is not NUll THEN convert(varchar,EMIssueId) + ' - ' + EMIssue ELSE 'N/A' end)    
    WHEN 'PREV' THEN IsNUll(Prevention, 'N/A')    
    
    WHEN 'CTTY' THEN CostType    
    WHEN 'SYST' THEN [System]    
    WHEN 'SUBS' THEN SubSystem    
    WHEN 'EVCC' THEN ComponentCode    
    WHEN 'PLAN' THEN (CASE WHEN Planned = 1 THEN 'Planned - Yes' ELSE 'Planned - No' end )    
    WHEN 'BREA' THEN (CASE WHEN Breakdown = 1 THEN 'Breakdown - Yes' ELSE 'Breakdown - No' end)     
    WHEN 'REDO' THEN (CASE WHEN Redo = 1 THEN 'Redo - Yes' ELSE 'Redo - No' END)     
    WHEN 'DTAC' THEN DTACause    
    WHEN 'DTAA' THEN Activity    
    /*VV 30-Jan-2009*/    
    WHEN 'SRCE' THEN ISNULL(Source,'N/A')    
   END as AnalyseBy,    
    
  YEAR(ActualDownTime)*100 + MONTH(ActualDownTime) AS Period,    
  CONVERT(DATETIME,CONVERT(VARCHAR,YEAR(ActualDownTime)*100 + MONTH(ActualDownTime))+ '01',112) AS PeriodStr,    
  --YEAR(ActualDownTime)*100 + MONTH(ActualDownTime)  AS PeriodStr, -- RIGHT(CONVERT(varchar, CONVERT(datetime, CONVERT(varchar,YEAR(ActualDownTime)*100 + MONTH(ActualDownTime)) + '01', 112), 6), 6) As PeriodStr,    
   Count(Distinct(EventId)) AS Events     
   INTO #LINECHART  
    FROM #FILTERED    
    WHERE    
     Planned = case @Planned when 1 then Planned when 2 then 1 when 3 then 0 end And    
     Breakdown = case @Breakdown when 1 then Breakdown when 2 then 1 when 3 then 0 end And    
     Redo = case @Redo when 1 then Redo when 2 then 1 when 3 then 0 end And    
    
    
     case when @ModelId is not null then CHARINDEX(',' + CONVERT(varchar,ModelId) + ',',@ModelId) else 1 end > 0 And    
     case when @ResponsibilityId is not null then CHARINDEX(',' + CONVERT(varchar,ResponsibilityId) + ',',@ResponsibilityId) else 1 end > 0 And    
     case when @EventTaskTypeId is not null then CHARINDEX(',' + CONVERT(varchar,EventTaskTypeId) + ',',@EventTaskTypeId) else 1 end > 0 And    
         
     case when @CostTypeId is not null then CHARINDEX(',' + CONVERT(varchar,CostTypeId) + ',',@CostTypeId) else 1 end > 0 And    
     case when @SystemId is not null then CHARINDEX(',' + CONVERT(varchar,SystemId) + ',',@SystemId) else 1 end > 0 And    
     case when @SubSystemId is not null then CHARINDEX(',' + CONVERT(varchar,SubSystemId) + ',',@SubSystemId) else 1 end > 0 And    
     case when @ComponentCodeId is not null then CHARINDEX(',' + CONVERT(varchar,ComponentCodeId) + ',',@ComponentCodeId) else 1 end > 0 And    
    
     case when @DTACauseId is not null then CHARINDEX(',' + CONVERT(varchar,DTACauseId) + ',',@DTACauseId) else 1 end > 0 And    
     case when @ActivityId is not null then CHARINDEX(',' + CONVERT(varchar,ActivityId) + ',',@ActivityId) else 1 end > 0 And    
     case when @VarianceCauseId is not null then CHARINDEX(',' + CONVERT(varchar,VarianceCauseId) + ',',@VarianceCauseId) else 1 end > 0 And    
     case when @EMIssueId is not null then CHARINDEX(',' + CONVERT(varchar,EMIssueId) + ',',@EMIssueId)else 1 end  > 0 AND    
     case when @preventableId is not null then CHARINDEX(',' + CONVERT(varchar,PreventionId) + ',',@preventableId)else 1 end  > 0     
    
    group by CASE @AnalyseBy    
   WHEN 'DEAL' THEN Dealer    
    WHEN 'BRAN' THEN Branch    
    WHEN 'SITE' THEN Site    
    WHEN 'FLEE' THEN Fleet    
    WHEN 'EQPL' THEN EqpPlan    
    WHEN 'MODL' THEN Model    
    WHEN 'RESP' THEN Responsibility    
    WHEN 'EVTT' THEN EventTaskType    
    WHEN 'VARC' THEN VarianceCause    
    WHEN 'EMI' THEN (CASE WHEN EMIssue is not NUll THEN convert(varchar,EMIssueId) + ' - ' + EMIssue ELSE 'N/A' end)    
    WHEN 'PREV' THEN IsNUll(Prevention, 'N/A')    
    
    WHEN 'CTTY' THEN CostType    
    WHEN 'SYST' THEN [System]    
    WHEN 'SUBS' THEN SubSystem    
    WHEN 'EVCC' THEN ComponentCode    
    WHEN 'PLAN' THEN (CASE WHEN Planned = 1 THEN 'Planned - Yes' ELSE 'Planned - No' end )    
    WHEN 'BREA' THEN (CASE WHEN Breakdown = 1 THEN 'Breakdown - Yes' ELSE 'Breakdown - No' end)     
    WHEN 'REDO' THEN (CASE WHEN Redo = 1 THEN 'Redo - Yes' ELSE 'Redo - No' END)     
    WHEN 'DTAC' THEN DTACause    
    WHEN 'DTAA' THEN Activity    
    /*VV 30-Jan-09*/    
    WHEN 'SRCE' THEN ISNULL(Source,'N/A')    
   END,YEAR(ActualDownTime)*100 + MONTH(ActualDownTime),CONVERT(DATETIME,CONVERT(VARCHAR,YEAR(ActualDownTime)*100 + MONTH(ActualDownTime))+ '01',112)    
  --RIGHT(CONVERT(varchar, CONVERT(datetime, CONVERT(varchar,YEAR(ActualDownTime)*100 + MONTH(ActualDownTime)) + '01', 112), 6), 6)     
   ORDER BY PeriodStr,AnalyseBy    
   END  
     
   BEGIN  
  DECLARE @Start int = YEAR(@StartDate)*100+MONTH(@StartDate)   
  DECLARE @End int = YEAR(@EndDate)*100+MONTH(@EndDate)  
  SELECT AnalyseBy, CalenderPeriod AS Period, CONVERT(DATETIME,CONVERT(VARCHAR,CalenderPeriod)+'01',112) AS PeriodStr  
  INTO #LINECHARTTIMETABLE   
  FROM dbo.tblFinancialPeriods CROSS JOIN (SELECT DISTINCT AnalyseBy FROM #LINECHART) AS AnalyseByTable   
  WHERE CalenderPeriod BETWEEN @Start AND @End  
  END  
END    
    
IF @LineChart = 1    
BEGIN    
  SELECT LT.AnalyseBy,LT.Period,LT.PeriodStr,ISNULL(L.Events,0) AS Events FROM #LINECHARTTIMETABLE LT  
  LEFT JOIN #LINECHART L ON LT.AnalyseBy = L.AnalyseBy AND LT.Period = L.Period AND LT.PeriodStr = L.PeriodStr  
  DROP TABLE #LINECHART  
  DROP TABLE #LINECHARTTIMETABLE  
 END    
ELSE    
  BEGIN    
    
   SELECT     
   /*VV 27-jan-09*/    
   CASE @AnalyseBy    
    WHEN 'DEAL' THEN DealerId    
    WHEN 'BRAN' THEN BranchId    
    WHEN 'SITE' THEN SiteId    
    WHEN 'FLEE' THEN FleetId    
    WHEN 'EQPL' THEN EqpPlanId    
    WHEN 'MODL' THEN ModelId    
    WHEN 'RESP' THEN ResponsibilityId    
    WHEN 'EVTT' THEN EventTaskTypeId    
    WHEN 'VARC' THEN VarianceCauseId    
    WHEN 'EMI' THEN convert(varchar,ISNULL(EMIssueId,0))    
    WHEN 'PREV' THEN IsNUll(PreventionId, 0)    
    
    WHEN 'CTTY' THEN CostTypeID    
    WHEN 'SYST' THEN SystemID    
    WHEN 'SUBS' THEN SubSystemId    
    WHEN 'EVCC' THEN ComponentCodeId    
    WHEN 'PLAN' THEN ISNULL(Planned,0)    
    WHEN 'BREA' THEN ISNULL(Breakdown,0)     
    WHEN 'REDO' THEN ISNULL(Redo,0)     
    WHEN 'DTAC' THEN DTACauseId    
    WHEN 'DTAA' THEN ActivityId    
    /*VV 30-Jan-09*/    
    WHEN 'SRCE' THEN ISNULL(SourceId,0)    
    WHEN 'QRTR' THEN YEAR(ActualDownTime)*100 + (MONTH(ActualDownTime) + 2)/3     
    WHEN 'MONH' THEN YEAR(ActualDownTime)*100 + MONTH(ActualDownTime)    
    WHEN 'YEAR' THEN YEAR(ActualDownTime)    
   END AS AnalyseByItemId ,      
    
   CASE @AnalyseBy    
    WHEN 'DEAL' THEN Dealer    
    WHEN 'BRAN' THEN Branch    
    WHEN 'SITE' THEN Site    
    WHEN 'FLEE' THEN Fleet    
    WHEN 'EQPL' THEN EqpPlan    
    WHEN 'MODL' THEN Model    
    WHEN 'RESP' THEN Responsibility    
    WHEN 'EVTT' THEN EventTaskType    
    WHEN 'VARC' THEN VarianceCause    
    WHEN 'EMI' THEN (CASE WHEN EMIssue is not NUll THEN convert(varchar,EMIssueId) + ' - ' + EMIssue ELSE 'N/A' end)    
    WHEN 'PREV' THEN IsNUll(Prevention, 'N/A')    
    
    WHEN 'CTTY' THEN CostType    
    WHEN 'SYST' THEN [System]    
    WHEN 'SUBS' THEN SubSystem    
    WHEN 'EVCC' THEN ComponentCode    
    WHEN 'PLAN' THEN (CASE WHEN Planned = 1 THEN 'Planned - Yes' ELSE 'Planned - No' end )    
    WHEN 'BREA' THEN (CASE WHEN Breakdown = 1 THEN 'Breakdown - Yes' ELSE 'Breakdown - No' end)     
    WHEN 'REDO' THEN (CASE WHEN Redo = 1 THEN 'Redo - Yes' ELSE 'Redo - No' END)     
    WHEN 'DTAC' THEN DTACause    
    WHEN 'DTAA' THEN Activity    
    /*VV 30-Jan-09*/    
    WHEN 'SRCE' THEN ISNULL(Source,'N/A')    
    WHEN 'QRTR' THEN CONVERT(varchar,DATEPART(yyyy, ActualDownTime)) + '-Q' + CONVERT(varchar(1),(DATEPART(mm, ActualDownTime) + 2)/3 )    
    WHEN 'MONH' THEN CONVERT(varchar,DATEPART(yyyy, ActualDownTime)) + '-' + CASE WHEN LEN(CONVERT(varchar,(DATEPART(mm, ActualDownTime)))) = 1 then '0' + CONVERT(varchar,(DATEPART(mm, ActualDownTime))) ELSE  CONVERT(varchar,(DATEPART(mm, ActualDownTime) 
 
)) END    
    WHEN 'YEAR' THEN CONVERT(varchar,DATEPART(yyyy, ActualDownTime))    
   END AS AnalyseBy ,     
   Count(Distinct(EventId)) AS Events     
   INTO #TT    
   From #FILTERED    
   WHERE    
    Planned = case @Planned when 1 then Planned when 2 then 1 when 3 then 0 end And    
    Breakdown = case @Breakdown when 1 then Breakdown when 2 then 1 when 3 then 0 end And    
    Redo = case @Redo when 1 then Redo when 2 then 1 when 3 then 0 end And    
    
    
    case when @ModelId is not null then CHARINDEX(',' + CONVERT(varchar,ModelId) + ',',@ModelId) else 1 end > 0 And    
    case when @ResponsibilityId is not null then CHARINDEX(',' + CONVERT(varchar,ResponsibilityId) + ',',@ResponsibilityId) else 1 end > 0 And    
    case when @EventTaskTypeId is not null then CHARINDEX(',' + CONVERT(varchar,EventTaskTypeId) + ',',@EventTaskTypeId) else 1 end > 0 And    
        
    case when @CostTypeId is not null then CHARINDEX(',' + CONVERT(varchar,CostTypeId) + ',',@CostTypeId) else 1 end > 0 And    
    case when @SystemId is not null then CHARINDEX(',' + CONVERT(varchar,SystemId) + ',',@SystemId) else 1 end > 0 And    
    case when @SubSystemId is not null then CHARINDEX(',' + CONVERT(varchar,SubSystemId) + ',',@SubSystemId) else 1 end > 0 And    
    case when @ComponentCodeId is not null then CHARINDEX(',' + CONVERT(varchar,ComponentCodeId) + ',',@ComponentCodeId) else 1 end > 0 And    
    
    case when @DTACauseId is not null then CHARINDEX(',' + CONVERT(varchar,DTACauseId) + ',',@DTACauseId) else 1 end > 0 And    
    case when @ActivityId is not null then CHARINDEX(',' + CONVERT(varchar,ActivityId) + ',',@ActivityId) else 1 end > 0 And    
    case when @VarianceCauseId is not null then CHARINDEX(',' + CONVERT(varchar,VarianceCauseId) + ',',@VarianceCauseId) else 1 end > 0 And    
    case when @EMIssueId is not null then CHARINDEX(',' + CONVERT(varchar,EMIssueId) + ',',@EMIssueId)else 1 end  > 0 AND    
    case when @preventableId is not null then CHARINDEX(',' + CONVERT(varchar,PreventionId) + ',',@preventableId)else 1 end  > 0     
    
   group by     
   /*VV 27-Jan-09*/    
   CASE @AnalyseBy    
    WHEN 'DEAL' THEN DealerId    
    WHEN 'BRAN' THEN BranchId    
    WHEN 'SITE' THEN SiteId    
    WHEN 'FLEE' THEN FleetId    
    WHEN 'EQPL' THEN EqpPlanId    
    WHEN 'MODL' THEN ModelId    
    WHEN 'RESP' THEN ResponsibilityId    
    WHEN 'EVTT' THEN EventTaskTypeId    
    WHEN 'VARC' THEN VarianceCauseId    
    WHEN 'EMI' THEN convert(varchar,ISNULL(EMIssueId,0))    
    WHEN 'PREV' THEN IsNUll(PreventionId, 0)    
    
    WHEN 'CTTY' THEN CostTypeID    
    WHEN 'SYST' THEN SystemID    
    WHEN 'SUBS' THEN SubSystemId    
    WHEN 'EVCC' THEN ComponentCodeId    
    WHEN 'PLAN' THEN ISNULL(Planned,0)    
    WHEN 'BREA' THEN ISNULL(Breakdown,0)     
    WHEN 'REDO' THEN ISNULL(Redo,0)     
    WHEN 'DTAC' THEN DTACauseId    
    WHEN 'DTAA' THEN ActivityId    
    /*VV 30-Jan-09*/    
    WHEN 'SRCE' THEN ISNULL(SourceId,0)    
    WHEN 'QRTR' THEN YEAR(ActualDownTime)*100 + (MONTH(ActualDownTime) + 2)/3     
    WHEN 'MONH' THEN YEAR(ActualDownTime)*100 + MONTH(ActualDownTime)    
    WHEN 'YEAR' THEN YEAR(ActualDownTime)    
   END,    
       
   case @AnalyseBy    
    WHEN 'DEAL' THEN Dealer    
    when 'BRAN' then Branch    
    when 'SITE' then Site    
    when 'FLEE' then Fleet    
    when 'EQPL' then EqpPlan    
    WHEN 'MODL' THEN Model    
    when 'RESP' then Responsibility    
    when 'EVTT' then EventTaskType    
    WHEN 'VARC' THEN VarianceCause    
    WHEN 'EMI'  THEN (CASE WHEN EMIssue is not NUll THEN convert(varchar,EMIssueId) + ' - ' + EMIssue ELSE 'N/A' end)    
    when 'PREV' then IsNull(Prevention,'N/A')    
    when 'CTTY' then CostType    
    when 'SYST' then [System]    
    when 'SUBS' then SubSystem    
    when 'EVCC' then ComponentCode    
    when 'PLAN' then (case when Planned = 1 then 'Planned - Yes' else 'Planned - No' end )    
    when 'BREA' then (case when Breakdown = 1 then 'Breakdown - Yes' else 'Breakdown - No' end)     
    when 'REDO' then (case when Redo = 1 then 'Redo - Yes' else 'Redo - No' end)     
    when 'DTAC' then DTACause    
    when 'DTAA' then Activity    
    /*VV 30-Jan-09*/    
    WHEN 'SRCE' THEN ISNULL(Source,'N/A')    
    WHEN 'QRTR' THEN CONVERT(varchar,DATEPART(yyyy, ActualDownTime)) + '-Q' + CONVERT(varchar(1),(DATEPART(mm, ActualDownTime) + 2)/3 )    
    WHEN 'MONH' THEN CONVERT(varchar,DATEPART(yyyy, ActualDownTime)) + '-' + CASE WHEN LEN(CONVERT(varchar,(DATEPART(mm, ActualDownTime)))) = 1 then '0' + CONVERT(varchar,(DATEPART(mm, ActualDownTime))) ELSE  CONVERT(varchar,(DATEPART(mm, ActualDownTime))
  
) END    
    WHEN 'YEAR' THEN CONVERT(varchar,DATEPART(yyyy, ActualDownTime))    
  end     
    
  Order by Events    
    
    
    
    
  If (@AnalyseBy = 'QRTR') or (@AnalyseBy = 'MONH') or (@AnalyseBy = 'YEAR')     
    
  BEGIN     
   Select     
   CAST(case @AnalyseBy     
    when 'QRTR' then QuarterPer    
    when 'MONH' then Calendar_Period    
    when 'YEAR' then [Year]    
    end AS int) as AnalyseByItemId,    
   case @AnalyseBy     
    when 'QRTR' then [Quarter]    
    when 'MONH' then [Month]    
    when 'YEAR' then [Year]    
   end as Period into #Base from REPORT_MONTH_V    
   where     
    End_Date  > @StartDate     
    
    And Start_Date < @EndDate    
    
   group by     
   CAST(case @AnalyseBy     
    when 'QRTR' then QuarterPer    
    when 'MONH' then Calendar_Period    
    when 'YEAR' then [Year]    
    end AS int),    
   case @AnalyseBy     
    when 'QRTR' then [Quarter]    
    when 'MONH' then [Month]    
    when 'YEAR' then [Year]    
   end     
    
    
    
   --Select * from aa_tt order by AnalyseBy    
   Select /*VV 27-Jan-09*/B.AnalyseByItemId,B.Period as AnalyseBy, IsNull(T.Events,0) as Events, 1 as [Order] from     
   #base B    
    Left outer join    
   #TT T    
    on B.[Period] =T.AnalyseBy    
   Order by AnalyseBy    
  END    
  else    
  BEGIN    
   if (@Chart = 1)    
   BEGIN    
    Declare @Total as int    
    Set @Total = (Select Sum(Events) from #TT  )    
       
    Select top 10 /*VV 27-Jan-09*/AnalyseByItemId,AnalyseBy, Events into #TT2 from #TT order by Events Desc    
        
    Declare @Total10 as int    
    Set @Total10 = (Select Sum(Events) from #TT2 )    
        
    if  (@Total - @Total10 > 0)    
    BEGIN    
     SELECT /*VV 27-Jan-09*/AnalyseByItemId,AnalyseBy, Events, 2 AS [Order] FROM #tt2     
     UNION /*VV 27-Jan-09*/ALL    
     SELECT /*VV 27-Jan-09*/0 AS AnalyseByItemId,'Other', @Total - @Total10, 1 AS [Order]     
     Order by [Order], Events DESC    
    END    
    else    
    BEGIN    
     SELECT /*VV 27-Jan-09*/ AnalyseByItemId,AnalyseBy, Events, 2 AS [Order] FROM #tt2      
     Order by [Order], Events DESC    
    END    
    Drop table #TT2      
   END    
   ELSE    
   BEGIN    
    SELECT analyseBy, Events, 1 AS [Order] FROM #TT     
    ORDER BY [Order], Events DESC     
   END    
  END    
    
       
  Drop table #TT    
END    
    
DROP TABLE #FILTERED 
GO

/****** Object:  StoredProcedure [dbo].[RPT_EQUIPMENT_KPI_P]    Script Date: 04/05/2012 11:41:00 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[RPT_EQUIPMENT_KPI_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[RPT_EQUIPMENT_KPI_P]
GO

/****** Object:  StoredProcedure [dbo].[RPT_EQUIPMENT_KPI_P]    Script Date: 04/05/2012 11:41:00 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[RPT_EQUIPMENT_KPI_P] 
/******************************************************************************
	File: RPT_EQUIPMENT_KPI_P.sql
	Name: RPT_EQUIPMENT_KPI_P

	Called BY: 

	Desc: 
             

	Auth: Taral Patel
	Date: 17-Oct-2011	
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	05 Apr 12   GD          Fixed 3912
	14 Mar 12   GD          Fixed 3679
 *******************************************************************************/
	/* Param List */	
 	@UserID	INT =0,
	@BranchId	VARCHAR(MAX) = '',
	@SiteId	VARCHAR(MAX) = '',
	@FleetId	VARCHAR(MAX) = '',
	@EqpPlanId	VARCHAR(MAX) = '',	
	@ModelId VARCHAR(MAX) = '',
	@UseActualUOM bit = 0,	
	@StartDate DATETIME = '1-Jan-2010',
	@EndDate	DATETIME =  '1-Jan-2011',
	@ResponsibilityIds VARCHAR(MAX)=''
AS

SET @BranchId = ISNULL(@BranchId,'')
SET @SiteId = ISNULL(@SiteId,'')
SET @FleetId = ISNULL(@FleetId,'')
SET @ModelId = ISNULL(@ModelId,'')
SET @EqpPlanId = ISNULL(@EqpPlanId,'')
SET @ResponsibilityIds = ISNULL(@ResponsibilityIds,'')


Declare @RealEquipmentTypeId AS int
SET @RealEquipmentTypeId=1

Declare @CurrentProjectionTypeId AS int
SET @CurrentProjectionTypeId=1

SET @UserId=ISNULL(@UserId,0)
DECLARE @Level int
SELECT @Level=User_Access_Level_Id From USER_LEVEL_PERMISSION where AMT_User_Id = @UserId
SET @Level=ISNULL(@Level,0)
		
SELECT	dbo.tblEqpPlans.EqpPlanId,
		dbo.tblBranches.Branch,
		dbo.tblSites.[Site], 
		dbo.tblFleets.Fleet,
		dbo.tblModels.Model,
		dbo.tblEqpPlans.EqpPlan,
		dbo.tblQUOMs.UOMShortDesc,
		dbo.tblQUOMs.QUOMId,
		dbo.tblEqpProjs.EqpProjId
INTO #EquipmentPlans
FROM dbo.tblEqpPlans
		INNER JOIN dbo.tblFleets ON dbo.tblEqpPlans.FleetId = dbo.tblFleets.FleetId 
			AND (@FleetId='' OR dbo.tblFleets.FleetId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@FleetId)))
		INNER JOIN dbo.tblSites ON dbo.tblFleets.SiteId = dbo.tblSites.SiteId 
			AND (@SiteId='' OR dbo.tblSites.SiteId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@SiteId)))
			AND (@Level<>2 OR dbo.tblSites.SiteId IN(SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = @UserId)) 
		INNER JOIN dbo.tblBranches ON dbo.tblSites.BranchId = dbo.tblBranches.BranchId 
			AND (@BranchId='' OR dbo.tblBranches.BranchId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@BranchId)))
			AND (@Level<>1 OR dbo.tblBranches.BranchId IN(SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = @UserId))
		INNER JOIN dbo.tblEquipment ON dbo.tblEqpPlans.EquipmentId = dbo.tblEquipment.EquipmentId 		
		INNER JOIN dbo.tblModels ON dbo.tblEquipment.ModelId = dbo.tblModels.ModelId 
			AND (@ModelId='' OR dbo.tblModels.ModelId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@ModelId)))	
		INNER JOIN dbo.tblEqpProjs ON dbo.tblEqpPlans.EqpPlanId = dbo.tblEqpProjs.EqpPlanId
			AND dbo.tblEqpPlans.Equipment_Type_Id=@RealEquipmentTypeId
		INNER JOIN dbo.tblQUOMs ON dbo.tblEqpProjs.EndQUOMId = dbo.tblQUOMs.QUOMId 
			AND tblQUOMs.Operating_Hours_QUOM=1
			AND dbo.tblEqpProjs.Projection_Type_ID=@CurrentProjectionTypeId
WHERE (@EqpPlanId='' OR tblEqpPlans.EqpPlanId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpPlanId)))

SELECT	dbo.[EVENT].Eqp_Plan_ID,				
		(sum(CASE WHEN dbo.[EVENT].Planned=1 AND dbo.[EVENT].Break_Down=0 AND datediff(MINUTE, dbo.[EVENT].Actual_Up_Time, dbo.[EVENT].Actual_Down_Time)<>0
				  THEN dbo.DOWN_TIME_ALLOCATION.Actual_Hours 
						* (convert(float, CASE WHEN dbo.[EVENT].Actual_Up_Time >= @EndDate 
										  THEN @EndDate
										  ELSE Actual_Up_Time  
										  END) - 
							convert(float, CASE WHEN Actual_Down_Time <= @StartDate  
										   THEN @StartDate  
										   ELSE dbo.[EVENT].Actual_Down_Time 
									       END))/(convert(float, dbo.[EVENT].Actual_Up_Time) - convert(float, dbo.[EVENT].Actual_Down_Time))
				  ELSE 0 END)) AS PlannedTotalHours,
		(sum(CASE WHEN dbo.[EVENT].Planned=0 AND dbo.[EVENT].Break_Down=1 AND datediff(MINUTE, dbo.[EVENT].Actual_Up_Time, dbo.[EVENT].Actual_Down_Time)<>0
				  THEN dbo.DOWN_TIME_ALLOCATION.Actual_Hours 
						* (convert(float, CASE WHEN dbo.[EVENT].Actual_Up_Time >= @EndDate 
										  THEN @EndDate
										  ELSE Actual_Up_Time  
										  END) - 
							convert(float, CASE WHEN Actual_Down_Time <= @StartDate  
										   THEN @StartDate  
										   ELSE dbo.[EVENT].Actual_Down_Time 
									       END))/(convert(float, dbo.[EVENT].Actual_Up_Time) - convert(float, dbo.[EVENT].Actual_Down_Time))
				  ELSE 0 END)) AS BrekDownTotalHours,				
		(sum(CASE WHEN dbo.[EVENT].Planned=0 AND dbo.[EVENT].Break_Down=0 AND datediff(MINUTE, dbo.[EVENT].Actual_Up_Time, dbo.[EVENT].Actual_Down_Time)<>0
				  THEN (convert(float, CASE WHEN dbo.[EVENT].Actual_Up_Time >= @EndDate 
										  THEN @EndDate
										  ELSE Actual_Up_Time  
										  END) - 
							convert(float, CASE WHEN Actual_Down_Time <= @StartDate  
										   THEN @StartDate  
										   ELSE dbo.[EVENT].Actual_Down_Time 
									       END))/(convert(float, dbo.[EVENT].Actual_Up_Time) - convert(float, dbo.[EVENT].Actual_Down_Time))
				  ELSE 0 END)) AS OtherTotalHours
INTO #EquipmentEvents
FROM dbo.[EVENT]
INNER JOIN dbo.DOWN_TIME_ALLOCATION ON dbo.[EVENT].Event_ID = dbo.DOWN_TIME_ALLOCATION.Event_ID 
	AND (@ResponsibilityIds='' OR dbo.DOWN_TIME_ALLOCATION.Responsibility_ID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@ResponsibilityIds)))
WHERE dbo.[EVENT].Eqp_Plan_ID in (SELECT EqpPlanId FROM #EquipmentPlans)
		AND dbo.[EVENT].Actual_Down_Time <= @EndDate AND dbo.[EVENT].Actual_Up_Time >= @StartDate
GROUP BY dbo.[EVENT].Eqp_Plan_ID

SELECT dbo.[EVENT].Eqp_Plan_ID, 
	   sum(CASE WHEN dbo.[EVENT].Planned=1 AND dbo.[EVENT].Break_Down=0 THEN 1 ELSE 0 END) as PlannedTotalEvents,
	   sum(CASE WHEN dbo.[EVENT].Planned=0 AND dbo.[EVENT].Break_Down=1 THEN 1 ELSE 0 END) as BreakDownTotalEvents,
	   sum(CASE WHEN dbo.[EVENT].Planned=0 AND dbo.[EVENT].Break_Down=0 THEN 1 ELSE 0 END) as OtherTotalEvents
INTO #EquipmentEventsCounts
FROM dbo.[EVENT]
WHERE dbo.[EVENT].Eqp_Plan_ID in (SELECT EqpPlanId FROM #EquipmentPlans)
		AND dbo.[EVENT].Actual_Down_Time <= @EndDate AND dbo.[EVENT].Actual_Up_Time >= @StartDate
GROUP BY dbo.[EVENT].Eqp_Plan_ID

IF @UseActualUOM=1
BEGIN 					
	SELECT #EquipmentPlans.Branch,
		   #EquipmentPlans.[Site], 
		   #EquipmentPlans.Fleet,
		   #EquipmentPlans.Model,
		   #EquipmentPlans.EqpPlan,
		   #EquipmentPlans.UOMShortDesc,
		   ISNULL(#EquipmentEvents.PlannedTotalHours,0) AS PlannedTotalHours,    
           ISNULL(#EquipmentEventsCounts.PlannedTotalEvents,0) AS PlannedTotalEvents,    
           ISNULL(#EquipmentEvents.BrekDownTotalHours,0) AS BrekDownTotalHours,    
           ISNULL(#EquipmentEventsCounts.BreakDownTotalEvents,0) AS BreakDownTotalEvents,     
           ISNULL(#EquipmentEvents.OtherTotalHours,0) AS OtherTotalHours,    
           ISNULL(#EquipmentEventsCounts.OtherTotalEvents,0) AS OtherTotalEvents, 
		   EquipmentUsage.StartUsage,
		   EquipmentUsage.EndUsage,
		   dbo.GET_REP_DAILY_USAGE_BY_TIME_RANGE_AND_EQP_PLAN_ID_F(#EquipmentPlans.EqpPlanId, convert(datetime, @StartDate), convert(datetime, @EndDate)) AS ScheduledHours		    
	FROM #EquipmentPlans/*GD 3912 changed INNER JOIN to LEFT JOIN*/
		 LEFT JOIN #EquipmentEvents ON #EquipmentEvents.Eqp_Plan_ID = #EquipmentPlans.EqpPlanId
		 LEFT JOIN #EquipmentEventsCounts ON #EquipmentEvents.Eqp_Plan_ID = #EquipmentEventsCounts.Eqp_Plan_ID
		 LEFT JOIN (
				SELECT dbo.tblEqpPlans.EqpPlanId,
					MAX(CASE WHEN tblActualUsages.RecordingDate <= @StartDate THEN ActualUsage ELSE /*GD 3679 14/03/12 */tblEqpPlanStartUsages.StartUsage END) AS StartUsage,
					MAX(CASE WHEN tblActualUsages.RecordingDate <= @EndDate THEN ActualUsage ELSE 0 END) AS EndUsage
				FROM dbo.tblActualUsages
				INNER JOIN  dbo.tblEqpPlans ON dbo.tblEqpPlans.EquipmentId=dbo.tblActualUsages.EquipmentId
				INNER JOIN tblEqpPlanStartUsages ON tblEqpPlanStartUsages.EqpPlanId =  dbo.tblEqpPlans.EqpPlanId AND tblEqpPlanStartUsages.StartUsageQUOMId = tblActualUsages.QUOMId				
				GROUP BY dbo.tblEqpPlans.EqpPlanId
			) AS EquipmentUsage ON EquipmentUsage.EqpPlanId=#EquipmentPlans.EqpPlanId
END ELSE BEGIN
	SELECT #EquipmentPlans.Branch,
		   #EquipmentPlans.[Site], 
		   #EquipmentPlans.Fleet,
		   #EquipmentPlans.Model,
		   #EquipmentPlans.EqpPlan,
		   #EquipmentPlans.UOMShortDesc,
		   ISNULL(#EquipmentEvents.PlannedTotalHours,0) AS PlannedTotalHours,    
		   ISNULL(#EquipmentEventsCounts.PlannedTotalEvents,0) AS PlannedTotalEvents,    
		   ISNULL(#EquipmentEvents.BrekDownTotalHours,0) AS BrekDownTotalHours,    
		   ISNULL(#EquipmentEventsCounts.BreakDownTotalEvents,0) AS BreakDownTotalEvents,     
		   ISNULL(#EquipmentEvents.OtherTotalHours,0) AS OtherTotalHours,    
		   ISNULL(#EquipmentEventsCounts.OtherTotalEvents,0) AS OtherTotalEvents, 
		   dbo.GET_USAGE_FROM_DATE_F(#EquipmentPlans.EqpProjId, #EquipmentPlans.QUOMId, @StartDate) AS StartUsage, 
		   dbo.GET_USAGE_FROM_DATE_F(#EquipmentPlans.EqpProjId, #EquipmentPlans.QUOMId, @EndDate) AS EndUsage,
		   dbo.GET_REP_DAILY_USAGE_BY_TIME_RANGE_AND_EQP_PLAN_ID_F(#EquipmentPlans.EqpPlanId, convert(datetime, @StartDate), convert(datetime, @EndDate)) AS ScheduledHours    
	FROM #EquipmentPlans/*GD 3912 changed INNER JOIN to LEFT JOIN*/
		 LEFT JOIN #EquipmentEvents ON #EquipmentEvents.Eqp_Plan_ID = #EquipmentPlans.EqpPlanId
		 LEFT JOIN #EquipmentEventsCounts ON #EquipmentEvents.Eqp_Plan_ID = #EquipmentEventsCounts.Eqp_Plan_ID
		 LEFT JOIN (
				SELECT dbo.tblEqpPlans.EqpPlanId,
					MAX(CASE WHEN tblActualUsages.RecordingDate <= @StartDate THEN ActualUsage ELSE 0 END) AS StartUsage,
					MAX(CASE WHEN tblActualUsages.RecordingDate <= @EndDate THEN ActualUsage ELSE 0 END) AS EndUsage
				FROM dbo.tblActualUsages
				INNER JOIN  dbo.tblEqpPlans ON dbo.tblEqpPlans.EquipmentId=dbo.tblActualUsages.EquipmentId				
				GROUP BY dbo.tblEqpPlans.EqpPlanId
			) AS EquipmentUsage ON EquipmentUsage.EqpPlanId=#EquipmentPlans.EqpPlanId
END


GO



 


if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[RPT_PLANNED_BREAKDOWN_HOUR_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[RPT_PLANNED_BREAKDOWN_HOUR_P]
GO

Create  Procedure [dbo].[RPT_PLANNED_BREAKDOWN_HOUR_P]    
/******************************************************************************    
   
 File: RPT_PLANNED_BREAKDOWN_HOUR_P.sql    
 Name: RPT_PLANNED_BREAKDOWN_HOUR_P    
    
 Called By:     
    
 Desc: 1. Get data set for Planned Downtime Events %, Breakdown Downtime Events %    
                 
    
 Auth: Harpreet Singh    
 Date: 1-May-2003    
*******************************************************************************    
  Change History    
*******************************************************************************    
 Date:  Author:  Description:    
 -------- -------- ----------------------------------------    
 05 Mar 12  TW   #3950 Fix issue with incorrect date range
 08 Mar 12  TW   E744  StartDate & EndDate contain time part   
 06 Sep 06 K Nagarajan Added DateBased Output Parameter     
 05-Jan-2004 V Vasylyeva Added SUM and group by for Line Chart    
 21-Sep-09 TAS  CR8389: Added UserID    
*******************************************************************************/    
 /* Param List */    
   
    @DealerID int ,    
    @BranchId varchar(MAX)='',    
    @SiteID varchar(MAX)='',    
    @FleetID varchar(MAX)='',    
    @EqpPlanID varchar(MAX)='',    
    @ModelID varchar(MAX) = '',    
    @ResponsibilityID varchar(MAX) = '',    
    @TaskTypeID varchar(MAX) = '',    
    @ComponentCodeID varchar(MAX) = '',    
    @Planned bit = 1,    
    @Breakdown bit = 0,    
    @CostTypeId varchar(MAX)= '',    
    @SystemId varchar(MAX) = '',    
    @SubSystemId varchar(MAX) = '',    
    @ProjTaskId varchar(MAX) = '',    
    @StartDate datetime ,    
    @EndDate datetime ,     
    @AnalyseBy varchar(4) = '',    
    @LineChart bit = 1,    
    @DateBased varchar(10) = 'False' OUTPUT,    
 @UserID INT=0    
    
AS    
    
SET NOCOUNT ON    
    
 SET  @DateBased= 'False'     
    
 IF @AnalyseBy = 'MONH' OR @AnalyseBy = 'QRTR' OR @AnalyseBy = 'YEAR'      
 BEGIN    
  SET @DateBased = 'True'    
 END    
     
 DECLARE @SQL as varchar(MAX)    
 DECLARE @RandomNumber as varchar(5)    
--******************************************    
--Change Start    
--Tas 21-Sep-09    
 SET @UserId=ISNULL(@UserId,0)    
 DECLARE @Level int    
 SELECT @Level=User_Access_Level_Id From USER_LEVEL_PERMISSION where AMT_User_Id = @UserId    
 SET @Level=ISNULL(@Level,0)    
    
  /*    
  0 -ALL    
  1-Branch,    
  2-Site    
  */    
--Change End    
--******************************************    
 --E744 Get rid of date range adjustment as it was selecting month range.   
 --SET @EndDate = DateAdd(d, -1, @EndDate)   
    
 SET @RandomNumber = CONVERT(CHAR(4), CONVERT(INT,RAND() * 8999) + 1000)    
   
 -- E744 TW 08 03 12  Start  
 --SET @SQL = 'SELECT Event_ID, Calendar_Period, MonthStartDate, MonthEndDate, Start_Date, Next_Month_Start_Date, '   
    
 SET @SQL = 'SELECT Event_ID, Calendar_Period, '   
 Set @SQL = @SQL + 'CASE WHEN ''' + CONVERT(Varchar(16), @StartDate, 120) + ''' > MonthStartDate THEN '''  
 SET @SQL = @SQL + CONVERT(Varchar(16), @StartDate, 120) + ''' ELSE MonthStartDate END AS MonthStartDate, '   
   
 Set @SQL = @SQL + 'CASE WHEN ''' + CONVERT(Varchar(16), @EndDate, 120) + ''' < MonthEndDate THEN '''  
 SET @SQL = @SQL + CONVERT(Varchar(16), @EndDate, 120) + ''' ELSE MonthEndDate END AS MonthEndDate, '   
 -- E744 TW 08 03 12  End  
   
 SET @SQL = @SQL + ' Actual_Down_Time, Actual_Up_Time, TaskType, CostType, System, SubSystem, CompCode, EqpPlan, Model, '    
 SET @SQL = @SQL + ' Fleet, Site, Branch, Planned, Break_Down, TaskTypeID, CostTypeID, SystemID, SubSystemID, '    
 SET @SQL = @SQL + ' ComponentCodeID, EqpPlanId, ModelId, FleetId, SiteId, BranchId, StrategyTask,'    
 SET @SQL = @SQL + ' Sum(Actual_Hours) Actual_Hours'    
 SET @SQL = @SQL + ' INTO     ##_1PLAN_BD_EVENT_' + @RandomNumber + '  '    
 SET @SQL = @SQL + ' FROM         RPT_PLAN_BD_EVENT_HOUR_V'   
    
 -- E744 TW 08 03 12  Start  
 --SET @SQL = @SQL + ' WHERE (Calendar_Period BETWEEN ' + CONVERT(varchar(6),(YEAR(@StartDate)*100)+MONTH(@StartDate)) + ' AND ' + CONVERT(varchar(6),(YEAR(@EndDate)*100)+MONTH(@EndDate)) + ') '    
 SET @SQL = @SQL + ' WHERE  (Actual_Down_Time < ''' + CONVERT(varchar(16), @EndDate, 120 ) + ''' AND Actual_Up_Time > ''' + CONVERT(Varchar(16), @StartDate, 120) + ''') '  
 -- #3950
 Set @SQL = @SQL + ' AND CASE WHEN ''' + CONVERT(Varchar(16), @StartDate, 120) + ''' > MonthStartDate THEN '''  
 SET @SQL = @SQL + CONVERT(Varchar(16), @StartDate, 120) + ''' ELSE MonthStartDate END < '   
   
 Set @SQL = @SQL + 'CASE WHEN ''' + CONVERT(Varchar(16), @EndDate, 120) + ''' < MonthEndDate THEN '''  
 SET @SQL = @SQL + CONVERT(Varchar(16), @EndDate, 120) + ''' ELSE MonthEndDate END  '   

 -- E744 TW 08 03 12  End  
     
 --*******************************************    
 --Change Start    
 --Tas 21-Sep-09    
 SET @Sql = @Sql + ' AND ('+CAST(@Level AS varchar(50))+'<>1 OR BranchId In (SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = '+CAST(@UserId AS varchar(50))+'))'    
 SET @SQL =@SQL + ' AND ('+CAST(@Level AS varchar(50))+'<>2 OR SiteID IN(SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = '+CAST(@UserId AS varchar(50))+'))'    
     
 --Change End    
 --*******************************************    
    
 If @EqpPlanID <> '' SET @SQL = @SQL + ' AND EqpPlanID IN (' + @EqpPlanID + ' )'    
 If @FleetID <> '' SET @SQL = @SQL + ' AND FleetID IN (' + @FleetID + ' )'    
 If @SiteID <> '' SET @SQL = @SQL + ' AND SiteID IN (' + @SiteID + ' )'    
 If @BranchId <> '' SET @SQL = @SQL + ' AND BranchId IN (' + @BranchId + ' )'    
 If @DealerId > 0 SET @SQL = @SQL + ' AND DealerId = ' + Convert(varchar, @DealerId)    
 If @AnalyseBy = 'PTTA' SET @SQL = @SQL + ' AND ProjTaskID is not Null '    
 If @ProjTaskId <> ''    
  BEGIN    
   SET @SQL = @SQL + ' AND ProjTaskID IN '    
   SET @SQL = @SQL + ' ('    
   SET @SQL = @SQL + ' SELECT projtaskid FROM tblprojtasks '    
   SET @SQL = @SQL + ' WHERE componentcodeid in (SELECT componentcodeid FROM tblprojtasks WHERE projtaskid IN (' + @ProjTaskId + ')) '    
   SET @SQL = @SQL + ' AND modifierid in (SELECT modifierid FROM tblprojtasks WHERE projtaskid IN  (' + @ProjTaskId + ')) '    
   SET @SQL = @SQL + ' AND tasktypeid in (SELECT tasktypeid FROM tblprojtasks WHERE projtaskid IN (' + @ProjTaskId + ')) '    
   SET @SQL = @SQL + ' AND applicationcodeid in (SELECT applicationcodeid FROM tblprojtasks WHERE projtaskid IN  (' + @ProjTaskId + ')) '    
   SET @SQL = @SQL + ' ) '-- ProjTask= @ProjTaskId     
  END    
 IF @ModelID <> ''  SET @SQL = @SQL + ' AND ModelId IN (' + @ModelID + ')'    
 IF @ResponsibilityID <> ''  SET @SQL = @SQL + ' AND Responsibility_Id IN (' + @ResponsibilityID + ') '    
 IF @TaskTypeID <> ''  SET @SQL = @SQL + ' AND TaskTypeId IN (' + @TaskTypeID + ')'    
 IF @ComponentCodeID <> ''  SET @SQL = @SQL + ' AND ComponentCodeId IN (' + @ComponentCodeID + ')'    
 IF @SystemId <> ''  SET @SQL = @SQL + ' AND SystemId IN (' + @SystemId + ')'    
 IF @SubSystemId <> ''  SET @SQL = @SQL + ' AND SubSystemId IN (' + @SubSystemId + ')'    
 IF @CostTypeId <> ''  SET @SQL = @SQL + ' AND CostTypeId IN (' + @CostTypeId + ')'    
 SET @SQL = @SQL + ' GROUP BY Event_ID, Calendar_Period, MonthStartDate, MonthEndDate, Start_Date, Next_Month_Start_Date,     
 Actual_Down_Time, Actual_Up_Time, TaskType, CostType, System, SubSystem, CompCode, EqpPlan, Model,     
 Fleet, Site, Branch, Planned, Break_Down, TaskTypeID, CostTypeID, SystemID, SubSystemID,     
 ComponentCodeID, EqpPlanId, ModelId, FleetId, SiteId, BranchId,StrategyTask '    
     
 print @SQL    
--  return    
     
 EXEC (@SQL)    
     
   
     
    
 SET @SQL = ' SELECT ' +     
 CASE @AnalyseBy      
  WHEN 'MONH' THEN 'Left(Calendar_Period,4) + ''-'' + Right(Calendar_Period,2)'    
  WHEN 'QRTR' THEN 'Left(Calendar_Period,4) + ''-Q'' + CONVERT(varchar(1),((Right(Calendar_Period,2)+2)/3))'    
  WHEN 'YEAR' THEN 'LEFT(Calendar_Period,4) '    
  WHEN 'BRAN' THEN 'Branch'    
  WHEN 'SITE' THEN 'Site'    
  WHEN 'FLEE' THEN 'Fleet'    
  WHEN 'EQPL' THEN 'EqpPlan'    
  WHEN 'MODL' THEN 'Model'    
  WHEN 'EVTT' THEN 'TaskType'    
  WHEN 'EVCC' THEN 'CompCode'    
  WHEN 'SYST' THEN 'System'    
  WHEN 'CTTY' THEN 'CostType'    
  WHEN 'PTTA' THEN 'StrategyTask'    
  ELSE 'SubSystem'    
 END     
--  print @AnalyseBy    
--  return    
    
 SET @SQL = @SQL + ' AS [Description], Calendar_Period, Convert(datetime, CONVERT(varchar(4), LEFT(Calendar_Period,4)) + ''-'' +  CONVERT(varchar(2), RIGHT(Calendar_Period,2)) + ''-01'') Calendar_Date,'    
 SET @SQL = @SQL + ' SUM(CASE WHEN (CONVERT(float, Actual_Up_Time) - CONVERT(float, Actual_Down_Time)) <= 0 THEN 0 ELSE ((Actual_Hours)/(CONVERT(float, Actual_Up_Time) - CONVERT(float, Actual_Down_Time))) * (CONVERT(float, MonthEndDate) - CONVERT(float, MonthStartDate)) END) AS TotalDT, '    
 SET @SQL = @SQL + ' SUM(CASE WHEN Planned = 1 THEN CASE WHEN (CONVERT(float, Actual_Up_Time) - CONVERT(float, Actual_Down_Time)) <= 0 THEN 0 ELSE ((Actual_Hours)/(CONVERT(float, Actual_Up_Time) - CONVERT(float, Actual_Down_Time))) * (CONVERT(float, MonthEndDate) - CONVERT(float, MonthStartDate)) END ELSE 0 END) as PlannedHours,  '    
 SET @SQL = @SQL + ' SUM(CASE WHEN Break_Down = 1 THEN CASE WHEN (CONVERT(float, Actual_Up_Time) - CONVERT(float, Actual_Down_Time)) <= 0 THEN 0 ELSE ((Actual_Hours)/(CONVERT(float, Actual_Up_Time) - CONVERT(float, Actual_Down_Time))) * (CONVERT(float, MonthEndDate) - CONVERT(float, MonthStartDate)) END ELSE 0 END) as BreakdownHours '    
 SET @SQL = @SQL + ' INTO     ##_2PLAN_BD_EVENT_' + @RandomNumber + '  '    
 SET @SQL = @SQL + ' FROM ##_1PLAN_BD_EVENT_' + @RandomNumber     
 SET @SQL = @SQL + ' GROUP BY Calendar_Period, Planned, Break_Down, ' +    
 CASE @AnalyseBy      
  WHEN 'MONH' THEN 'Left(Calendar_Period,4) + ''-'' + Right(Calendar_Period,2)'    
  WHEN 'QRTR' THEN 'Left(Calendar_Period,4) + ''-Q'' + CONVERT(varchar(1),((Right(Calendar_Period,2)+2)/3))'    
  WHEN 'YEAR' THEN 'LEFT(Calendar_Period,4) '    
  WHEN 'BRAN' THEN 'Branch'    
  WHEN 'SITE' THEN 'Site'    
  WHEN 'FLEE' THEN 'Fleet'    
  WHEN 'EQPL' THEN 'EqpPlan'    
  WHEN 'MODL' THEN 'Model'    
  WHEN 'EVTT' THEN 'TaskType'    
  WHEN 'EVCC' THEN 'CompCode'    
  WHEN 'SYST' THEN 'System'    
  WHEN 'CTTY' THEN 'CostType'    
  WHEN 'PTTA' THEN 'StrategyTask'    
  ELSE 'SubSystem'    
 END     
 EXEC (@SQL)    
--  print @SQL    
--  return    
    
    
    
 IF @AnalyseBy = 'MONH' OR @AnalyseBy = 'QRTR' OR @AnalyseBy = 'YEAR'     
     BEGIN     
  SET @SQL =  ' SELECT Description, Getdate() Calendar_Date, SUM(PlannedHours) PlannedDT, SUM(BreakdownHours) BreakdownDT, SUM(TotalDT) TotalDT '    
  SET @SQL = @SQL + ' FROM          ##_2PLAN_BD_EVENT_' + @RandomNumber     
  SET @SQL = @SQL + ' GROUP BY Description'    
  SET @SQL = @SQL + ' UNION '    
    
  IF @AnalyseBy = 'MONH' SET @SQL = @SQL + ' SELECT Left(rm.Calendar_Period,4) + ''-'' + Right(rm.Calendar_Period,2), '    
  IF @AnalyseBy = 'QRTR' SET @SQL = @SQL + ' SELECT Left(rm.Calendar_Period,4) + ''-Q'' + CONVERT(varchar(1),((Right(rm.Calendar_Period,2)+2)/3)), '    
    
  IF @AnalyseBy = 'YEAR' SET @SQL = @SQL + ' SELECT Left(rm.Calendar_Period,4), '    
    
  SET @SQL = @SQL + ' Null, 0, 0, 0'    
  SET @SQL = @SQL + ' FROM REPORT_MONTH_V rm'    
  SET @SQL = @SQL + ' WHERE (rm.Calendar_Period BETWEEN ' + CONVERT(varchar(6),(YEAR(@StartDate)*100)+MONTH(@StartDate)) + ' AND ' + CONVERT(varchar(6),(YEAR(@EndDate)*100)+MONTH(@EndDate)) + ') '     
  SET @SQL = @SQL + ' AND (rm.Calendar_Period  NOT IN'    
  SET @SQL = @SQL + ' (SELECT DISTINCT Calendar_Period'    
  SET @SQL = @SQL + ' FROM ##_2PLAN_BD_EVENT_' + @RandomNumber + '))'    
    
  IF @AnalyseBy = 'MONH' SET @SQL = @SQL + ' GROUP BY  Left(rm.Calendar_Period,4) + ''-'' + Right(rm.Calendar_Period,2) '    
  IF @AnalyseBy = 'QRTR' SET @SQL = @SQL + ' GROUP BY  Left(rm.Calendar_Period,4) + ''-Q'' + CONVERT(varchar(1),((Right(rm.Calendar_Period,2)+2)/3)) '    
  IF @AnalyseBy = 'YEAR' SET @SQL = @SQL + ' GROUP BY  Left(rm.Calendar_Period,4) '    
     END    
 ELSE IF @LineChart = 1     
     BEGIN     
      
  IF @Planned =1     
   SET @SQL =  ' SELECT Top 10  Description as Descr INTO #_TOP_SIX FROM  ##_2PLAN_BD_EVENT_' + @RandomNumber + '  GROUP BY Description ORDER BY CASE WHEN SUM(TotalDT) = 0 THEN 0 ELSE SUM(PlannedHours)/SUM(TotalDT) END ASC'    
  ELSE    
   SET @SQL =  ' SELECT Top 10  Description as Descr INTO #_TOP_SIX FROM  ##_2PLAN_BD_EVENT_' + @RandomNumber + '  GROUP BY Description ORDER BY CASE WHEN SUM(TotalDT) = 0 THEN 0 ELSE SUM(BreakdownHours)/SUM(TotalDT) END DESC'    
    
  --05-Jan-2004 V Vasylyeva    
  SET @SQL = @SQL + '  SELECT Description,Calendar_Date, SUM(PlannedDT) AS PlannedDT,    
   SUM(BreakdownDT) AS BreakdownDT, SUM(TotalDT) AS TotalDT    
   FROM    
    ('    
  SET @SQL = @SQL + ' SELECT ev.Description, ev.Calendar_Date, ev.PlannedHours PlannedDT, ev.BreakdownHours BreakdownDT, ev.TotalDT '    
  SET @SQL = @SQL + ' FROM          ##_2PLAN_BD_EVENT_' + @RandomNumber + ' ev  INNER JOIN #_TOP_SIX t6 ON ev.Description  = t6.Descr'    
  SET @SQL = @SQL + ' UNION '    
  SET @SQL = @SQL + ' SELECT ev.Description, rm.Start_Date, 0, 0, 0'    
  SET @SQL = @SQL + ' FROM         ##_2PLAN_BD_EVENT_' + @RandomNumber + ' ev INNER JOIN #_TOP_SIX t6 ON ev.Description  = t6.Descr CROSS JOIN'    
  SET @SQL = @SQL + ' REPORT_MONTH_V rm'    
  SET @SQL = @SQL + ' WHERE     (rm.Calendar_Period BETWEEN ' + CONVERT(varchar(6),(YEAR(@StartDate)*100)+MONTH(@StartDate)) + ' AND ' + CONVERT(varchar(6),(YEAR(@EndDate)*100)+MONTH(@EndDate)) + ') '     
  SET @SQL = @SQL + ' AND (rm.Calendar_Period  NOT IN'    
  SET @SQL = @SQL + ' (SELECT DISTINCT Calendar_Period'    
  SET @SQL = @SQL + ' FROM          ##_2PLAN_BD_EVENT_' + @RandomNumber     
  SET @SQL = @SQL + ' WHERE      Description = ev.Description))'    
   SET @SQL = @SQL + ' GROUP BY ev.Description, rm.Start_Date'    
      
  --05-Jan-2004 V Vasylyeva    
  SET @SQL = @SQL + ') A '    
  SET @SQL = @SQL +' GROUP BY Description, Calendar_Date '     
     
  SET @SQL = @SQL + ' ORDER BY Description, Calendar_Date'    
     END    
 ELSE    
     BEGIN    
  SET @SQL =  ' SELECT Description, Getdate() Calendar_Date, SUM(PlannedHours) PlannedDT, SUM(BreakdownHours) BreakdownDT, SUM(TotalDT) TotalDT '    
  SET @SQL = @SQL + ' FROM          ##_2PLAN_BD_EVENT_' + @RandomNumber     
  SET @SQL = @SQL + ' GROUP BY Description'    
  IF @Planned =1     
   SET @SQL = @SQL + ' ORDER BY  CASE WHEN SUM(TotalDT) = 0 Then 0 ELSE SUM(PlannedHours)/SUM(TotalDT) END ASC, SUM(TotalDT) DESC'    
  ELSE    
   SET @SQL = @SQL + ' ORDER BY CASE WHEN SUM(TotalDT) = 0 Then 0 ELSE SUM(BreakdownHours)/SUM(TotalDT) END  DESC, SUM(TotalDT) ASC'    
     END    
    
--  PRINT (@SQL)    
--  return    
 EXEC (@SQL)    
    
  EXEC('DROP TABLE ##_1PLAN_BD_EVENT_' + @RandomNumber + ', ##_2PLAN_BD_EVENT_' + @RandomNumber)    
     
    
    
SET NOCOUNT OFF    
    
GO






--if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[RPT_DAILY_DOWNTIME_LOG_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
--drop procedure [dbo].[RPT_DAILY_DOWNTIME_LOG_P]
--GO

--create        Procedure  RPT_DAILY_DOWNTIME_LOG_P
--/******************************************************************************
--	File: RPT_DAILY_DOWNTIME_LOG_P.sql
--	Name:RPT_DAILY_DOWNTIME_LOG_P

--	Called By: 

--	Desc: 1.
             

--	Auth: Thy Rith
--	Date: 14-OCT-2002
--*******************************************************************************
--		Change History
--*******************************************************************************
--	Date:		Author:		Description:
--	--------		--------		----------------------------------------
--	10 Apr 12   TW			#3908 set correct order for the report
--	16 Mar 12	KN			E727 Fixed Empty Rows
--	08 Mar 12	KN&Joel		E727: Added Notes Field
--	17 Oct 03	HS			changed to return actual down time and actual up time relative to start and end date
--	30 May 03	HS			Fixed bugs
--	14 Apr 03	ML			Change Fleet And EqpPlan to multi select, Added Em Issue
--	21-Sep-09	TAS			CR8389: Added UserID
--	20 Nov 09	TAS			Added @BranchId against Issue#8450
--	17 Aug 10	VV			#245 New Shift Downtime Log report
--*******************************************************************************/
--	/* Param List */

--    @SiteID int =2 ,
--    @FleetID varchar(MAX) = '',
--    @EqpPlanID varchar(MAX) = '',
--    @RespID varchar(MAX) = '',
--    @ModelID varchar(MAX) = '',
--    @TaskTypeID varchar(MAX) = '',
--	@EMIssueId varchar(MAX) = '',
--    @StartDate datetime = 'Aug 16 2003 12:00:00:000AM',
--    @EndDate datetime = 'Aug 17 2003 12:00:00:000AM',
--	@UserId INT=0,
--	@BranchId varchar(MAX) = '',
--	/*VV #245*/
--	@ShiftStart bit=1

--AS

--SET NOCOUNT ON

--DECLARE @sSQL as varchar(MAX)

--	Declare @tmpFleetId varchar(MAX)
--	Declare @tmpEqpPlanId varchar(MAX)

--	if charindex(',',@FleetId) > 1 set @tmpFleetId = '0' else set @tmpFleetId = @FleetId
--	if charindex(',',@EqpPlanId) > 1 set @tmpEqpPlanId = '0' else set @tmpEqpPlanId = @EqpPlanId

--	--*******************************************
--	--Change Start
--	--Tas 21-Sep-09
--	SET @UserId=ISNULL(@UserId,0)
--	DECLARE @Level int
--	SELECT @Level=User_Access_Level_Id From USER_LEVEL_PERMISSION where AMT_User_Id = @UserId
--	SET @Level=ISNULL(@Level,0)
--		/*
--		0 -ALL
--		1-Branch,
--		2-Site
--		*/
--	--Change End
--	--*******************************************
	
--	/*GET SHIFT START TIME */
--	/*VV #245*/ 
--	IF @ShiftStart=1
--	BEGIN
--		EXEC RPT_GET_SHIFT_START_TIME_P @SiteID, @tmpFleetId, 0, @tmpEqpPlanId,  0, @StartDate OUTPUT, @EndDate OUTPUT
--	END


--	/* Event Details*/
--	SET @sSQL = ' SELECT GroupBy,EventID,EquipPlan,Model,Description,[Plan],BreakDown, [DownDate],[UpDate],CASE WHEN Primary_DTA = 1 THEN [DownHours] ELSE 0 END DownHours,Cause,Activity,Resp,PlanDT,ActualDT,Var,VarianceCause,Notes ,Sort_Order FROM (SELECT GroupBy, EventID, EquipPlan, Model, Description, [Plan], BreakDown,'

---- 	DownDate,'
---- 	SET @sSQL =  @sSQL + ' CASE WHEN EventStatus = ' + CHAR(39) + 'IP' + CHAR(39) + ' THEN 0 ELSE Cast(ActualDT as decimal(30,3))  END AS UpDate,  '
---- 	/* If EventStatus is "in progress" then set DownDate = Null*/
---- 	SET @sSQL =  @sSQL + ' CASE WHEN EventStatus = ' + CHAR(39) + 'IP' + CHAR(39) + ' THEN null ELSE ActualUpDate END AS [UpDate], '
---- 	
---- 	/*If EventStatus is "in progress" then  set Downhours = 0*/
---- 	SET @sSQL =  @sSQL + ' CASE WHEN EventStatus = ' + CHAR(39) + 'IP' + CHAR(39) + ' THEN Null ELSE cast(DownHours as decimal(30,3))  END AS DownHours,  '
---- 		
	 
--	SET @sSQL = @sSQL + ' (case when downdate < ' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' Else downdate End) AS [DownDate],'
--	SET @sSQL = @sSQL + ' (case when ActualUpDate > ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' Else ActualUpDate End) AS [UpDate], '
--	SET @sSQL = @sSQL + ' ((CONVERT(float,(case when ActualUpDate > ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' Else ActualUpDate End)) - '
--	SET @sSQL = @sSQL + ' CONVERT(float,(case when downdate < ' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' Else downdate End))) *24) AS [DownHours],'

--	IF @RespId = '' 
--	   BEGIN
--		SET @sSQL =  @sSQL + ' Cause,  '
--		SET @sSQL =  @sSQL + ' Activity,  '
--		SET @sSQL =  @sSQL + ' Resp,  '
--		SET @sSQL = @sSQL + ' ((CONVERT(float,case when ActualUpDate > ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' Else ActualUpDate End) - '
--		SET @sSQL = @sSQL + ' CONVERT(float,case when downdate < ' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' Else downdate End))/(Convert(float, ActualUpDate)- CONVERT(float, downdate)))  * PlanDT as PlanDT, '
---- 		SET @sSQL =  @sSQL + ' CASE WHEN EventStatus = ' + CHAR(39) + 'IP' + CHAR(39) + ' THEN Null ELSE Cast(PlanDT as Decimal(30,3)) END AS PlanDT,  '
--		SET @sSQL = @sSQL + ' (((ActualDT/((Convert(float, ActualUpDate)- CONVERT(float, downdate)) * 24))) * ((CONVERT(float,(case when ActualUpDate > ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' Else ActualUpDate End)) - '
--		SET @sSQL = @sSQL + ' CONVERT(float,(case when downdate < ' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' Else downdate End))) *24)) as ActualDT,'
---- 		SET @sSQL =  @sSQL + ' CASE WHEN EventStatus = ' + CHAR(39) + 'IP' + CHAR(39) + ' THEN Null ELSE Cast(ActualDT as Decimal(30,3)) END AS ActualDT,  '
--		SET @sSQL =  @sSQL + ' Cast(0 as Decimal(30,3)) AS [Var],  '
--		SET @sSQL =  @sSQL + ' VarianceCause, Notes,Sort_order,Primary_DTA  '
--	    END
--	ELSE
--	    BEGIN
--		SET @sSQL =  @sSQL + ' CASE WHEN RespId Not IN (' + @RespId + ') THEN Null ELSE Cause END AS Cause,  '
--		SET @sSQL =  @sSQL + ' CASE WHEN RespId Not IN (' + @RespId + ') THEN Null ELSE Activity  END AS Activity,  '
--		SET @sSQL =  @sSQL + ' CASE WHEN RespId Not IN (' + @RespId + ') THEN Null ELSE Resp  END AS Resp,  '
---- 		SET @sSQL =  @sSQL + ' CASE WHEN EventStatus = ' + CHAR(39) + 'IP' + CHAR(39) + ' OR RespId Not IN (' + @RespId + ') THEN Null ELSE PlanDT END AS PlanDT,  '
--		SET @sSQL = @sSQL + ' CASE WHEN RespId Not IN (' + @RespId + ') THEN Null ELSE ((CONVERT(float,case when ActualUpDate > ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' Else ActualUpDate End) - '
--		SET @sSQL = @sSQL + ' CONVERT(float,case when DownDate < ' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' Else DownDate End))/(Convert(float, ActualUpDate)- CONVERT(float, DownDate)))  * PlanDT END as PlanDT, '
---- 		SET @sSQL =  @sSQL + ' CASE WHEN EventStatus = ' + CHAR(39) + 'IP' + CHAR(39) + ' OR RespId Not IN (' + @RespId + ') THEN Null ELSE ActualDT  END AS ActualDT,  '
--		SET @sSQL = @sSQL + ' CASE WHEN RespId Not IN (' + @RespId + ') THEN Null ELSE (((ActualDT/((Convert(float, ActualUpDate)- CONVERT(float, DownDate)) * 24))) * ((CONVERT(float,(case when ActualUpDate > ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' Else ActualUpDate End)) - '
--		SET @sSQL = @sSQL + ' CONVERT(float,(case when DownDate < ' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' then ' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' Else DownDate End))) *24)) END as ActualDT,'
--		SET @sSQL =  @sSQL + ' CASE WHEN RespId Not IN (' + @RespId + ') THEN Null ELSE Variance END AS [Var],  '
--		SET @sSQL =  @sSQL + ' CASE WHEN RespId Not IN (' + @RespId + ') THEN Null ELSE VarianceCause END AS VarianceCause,Notes,Sort_order,Primary_DTA  '
--	    END

--	SET @sSQL = @sSQL + ' FROM RPT_DAILY_DOWNTIME_LOG_V'


--	SET @sSQL = @sSQL + ' WHERE (ActualUpDate > ' + CHAR(39) + CONVERT(varchar, @StartDate,121) + CHAR(39) + ' AND DownDate <' + CHAR(39) + CONVERT(varchar,@EndDate,121) + CHAR(39) + ')'
--	--*******************************************
--	--Change Start
--	--Tas 21-Sep-09
--	SET @sSQL = @sSQL + ' AND ('+CAST(@Level AS varchar(50))+'<>1 OR BranchId In (SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = '+CAST(@UserId AS varchar(50))+'))'
--	SET @sSQL =@sSQL	+ ' AND ('+CAST(@Level AS varchar(50))+'<>2 OR SiteID IN(SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = '+CAST(@UserId AS varchar(50))+'))'
	
--	--Change End
--	--*******************************************
--	IF @SiteId > 0 SET @sSQL = @sSQL + ' AND SiteId = ' + CONVERT(varchar, @SiteId)
--	IF @FleetId <> '' SET @sSQL = @sSQL + 'AND FleetId In (' + @FleetId + ') '
--	IF @EqpPlanId <> '' SET @sSQL = @sSQL + 'AND EqpPlanId In (' + @EqpPlanId + ') '
--	IF @ModelId <> '' SET @sSQL = @sSQL + 'AND ModelId IN (' +  @ModelId + ') '
--	IF @EMIssueId <> '' Set @sSQL = @sSQL + ' AND EMIssueId In ( ' + @EmIssueId + ') '
--	IF @TaskTypeId <> ''  SET @sSQL =  @sSQL + 'AND TaskTypeId IN (' + @TaskTypeId + ')'
--	IF @BranchId <> ''  SET @sSQL =  @sSQL + 'AND BranchId IN (' + @BranchId + ')'
	

	 

--	SET @sSQL = @sSQL + ' ) A WHERE Cause IS NOT NULL '
	
	
--	 -- #3908
--    SET @sSQL = @sSQL + ' ORDER BY Sort_Order, Primary_DTA DESC   '  
  
--	--PRINT (@sSQL)
	
--	EXEC (@sSQL)


--SET NOCOUNT OFF
--go
/****** Object:  StoredProcedure [dbo].[PART_CLASSIFICATION_GET_ALL_P]    Script Date: 04/11/2012 15:41:55 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PART_CLASSIFICATION_GET_ALL_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[PART_CLASSIFICATION_GET_ALL_P]
GO

/****** Object:  StoredProcedure [dbo].[PART_CLASSIFICATION_GET_ALL_P]    Script Date: 04/11/2012 15:41:55 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[PART_CLASSIFICATION_GET_ALL_P]        
/******************************************************************************        
 File:         
 Name: PARTS_CLASSIFICATION_GET_ALL_P        
        
 Called By:         
        
 Desc:         
        
 Auth: G Dhillon       
 Date: 11/04/120       
*******************************************************************************        
  Change History        
*******************************************************************************        
Date:  Author:  Description:        
-------- -------- ----------------------------------------        
        
*******************************************************************************/        
 /* Param List */
 @SearchText varchar(100)='%'
        
AS        
 SELECT PartClassificationId,PartClassification,CoreRetained     
 FROM PART_CLASSIFICATION   
 WHERE  PartClassification LIKE @SearchText      
 ORDER BY PartClassification      
GO

/****** Object:  StoredProcedure [dbo].[PART_CLASSIFICATION_ADD_P]    Script Date: 04/11/2012 15:42:22 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PART_CLASSIFICATION_ADD_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[PART_CLASSIFICATION_ADD_P]
GO

/****** Object:  StoredProcedure [dbo].[PART_CLASSIFICATION_ADD_P]    Script Date: 04/11/2012 15:42:22 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE    Procedure [dbo].[PART_CLASSIFICATION_ADD_P]  
/******************************************************************************  
   
 Name: PART_CLASSIFICATION_ADD_P  
  
 Called By:   
  
 Desc: 1.Create  part classification
  
 Auth: Gurdeep Dhillon  
 Date: 11-Apr-2012  
*******************************************************************************  
  Change History  
*******************************************************************************  
 Date:  Author:  Description:  
 -------- -------- ----------------------------------------  
   
*******************************************************************************/  
 /* Param List */  
    @PartClassification VARCHAR(50), 
    @CoreRetained bit,  
    @Message varchar(2000)='' OUTPUT  
AS  
 IF EXISTS(SELECT * FROM PART_CLASSIFICATION WHERE PartClassification = @PartClassification) 
 BEGIN 
 SET @Message = 'Can not add this record, another record exists with same Part Classification'
 RETURN 
 END
  
BEGIN TRANSACTION  
--Create a Part Classification 
INSERT INTO PART_CLASSIFICATION(  
PartClassification,   
CoreRetained)  
VALUES(  
@PartClassification,@CoreRetained)  
  
IF @@ERROR<>0  
BEGIN  
 ROLLBACK TRANSACTION  
 RETURN  
END 
  
COMMIT TRANSACTION  
  
  
GO
/****** Object:  StoredProcedure [dbo].[PART_CLASSIFICATION_UPDATE_P]    Script Date: 04/11/2012 15:42:56 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PART_CLASSIFICATION_UPDATE_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[PART_CLASSIFICATION_UPDATE_P]
GO

/****** Object:  StoredProcedure [dbo].[PART_CLASSIFICATION_UPDATE_P]    Script Date: 04/11/2012 15:42:56 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE    Procedure [dbo].[PART_CLASSIFICATION_UPDATE_P]  
/******************************************************************************  
   
 Name: PARTS_CLASSIFICATION_UPDATE_P  
  
 Called By:   
  
 Desc: 1.Update  part classification
  
 Auth: Gurdeep Dhillon  
 Date: 11-Apr-2012  
*******************************************************************************  
  Change History  
*******************************************************************************  
 Date:  Author:  Description:  
 -------- -------- ----------------------------------------  
   
*******************************************************************************/  
 /* Param List */ 
    @PartClassificationID INT, 
    @PartClassification VARCHAR(50), 
    @CoreRetained bit, 
    @Message varchar(2000)='' OUTPUT  
AS  
 
IF EXISTS(SELECT * FROM PART_CLASSIFICATION WHERE PartClassification = @PartClassification AND PartClassificationId!= @PartClassificationID) 
 BEGIN 
 SET @Message = 'Can not update this record, another record exists with same part classification'
 RETURN
 END
 
BEGIN TRANSACTION  
--Update a Part Classification 
UPDATE PART_CLASSIFICATION
SET PartClassification =@PartClassification,
CoreRetained = @CoreRetained
WHERE PartClassificationId = @PartClassificationID  

IF @@ERROR<>0  
BEGIN  
 ROLLBACK TRANSACTION  
 RETURN  
END   

COMMIT TRANSACTION  
    
GO


/****** Object:  StoredProcedure [dbo].[PARTCLASSIFICATION_DELETE_P]    Script Date: 04/11/2012 15:43:47 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PART_CLASSIFICATION_DELETE_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[PART_CLASSIFICATION_DELETE_P]
GO

/****** Object:  StoredProcedure [dbo].[PARTCLASSIFICATION_DELETE_P]    Script Date: 04/11/2012 15:43:47 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE Procedure [dbo].[PART_CLASSIFICATION_DELETE_P]  
/******************************************************************************  
 File: PARTCLASSIFICATION_DELETE_P.sql  
 Name: PARTCLASSIFICATION_DELETE_P  
  
 Called By: SysSubSystem.cls  
  
 Desc: Deletes Part Classification
 Auth: Gurdeep Dhillon  
 Date: 11 Feb 2012  
*******************************************************************************  
  Change History  
*******************************************************************************  
 Date:  Author:  Description:  
 -------- -------- ----------------------------------------  
*******************************************************************************/  
 /* Param List */  
 @PartClassificationId int,  
 @Message varchar(8000) ='' OUTPUT  
AS  

IF EXISTS (SELECT * FROM TASK WHERE RebuildPartTypeID=@PartClassificationId)  
 BEGIN  
  SET @Message='This part classification cannot be deleted. It has rebuild part linked to it.'  
  RETURN  
 END 
 
IF EXISTS (SELECT * FROM tblProjTasks WHERE PartClassificationId=@PartClassificationId)  
 BEGIN  
  SET @Message='This part classification cannot be deleted. It has projected task linked to it.'  
  RETURN  
 END    
  
 DELETE FROM PART_CLASSIFICATION
 WHERE PartClassificationId = @PartClassificationId
  
  
GO




if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[RPT_WORK_SCHEDULE_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[RPT_WORK_SCHEDULE_P]
GO


CREATE            PROCEDURE [RPT_WORK_SCHEDULE_P] 
/******************************************************************************
	File: RPT_WORK_SCHEDULE_P.sql
	Name: RPT_WORK_SCHEDULE_P

	Called By: 

	Desc: 1. 
             

	Auth: Thy Rith
	Date: 07-NOV-2002
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	12 Apr 12   GD          E780
	
	OLD COMMENTS
	---------------------------------------------------------------------	
	16 APR 03	ML			Added filters changed existing to multi select
	16 Dec 03 	HS 			Start Date filter is fixed
	26 Jul 06	KN			Added LifeUsed Column
	02 Apr 08   YS          Added @SiteID
	11 Apr 08   YS			Added @TaskCounterID and @StrategyTaskID
	05 Feb 09	KN			Added EqpLocation filter
	12 Nov 09	AL			CR8308: Fixed StrategyTask Filter
*******************************************************************************/
	/* Param List */
	@DealerId int = 1,
	@BranchID varchar(MAX) = '',
	@SiteID  varchar(MAX) = '',
	@FleetId  varchar(MAX) = '',
	@EqpPlanID  varchar(MAX) = '',
	@ProjHeaderID varchar(MAX) = '',
	@ModelID varchar(MAX) ='',
	@TaskTypeID varchar(MAX)='',
	@CostTypeId varchar(MAX) = '',
	@SystemID varchar(MAX) = '',
	@SubSystemID varchar(MAX) = '',
	@CompCodeID varchar(MAX) ='',
	@StartDate DATEtime = '2003-12-15',
	@EndDate DATEtime = '2004-1-20',
	@AnalyseBy varchar(4) = '4',
	@TaskCounterID varchar(MAX) ='',
	@StrategyTaskID varchar(MAX) ='',
	@EqpLocationId Varchar(MAX) = '',
	/*GD 12/04/12 E780*/
	@PartClassificationId Varchar(MAX) = ''  ,
    @PartRatingId Varchar(MAX) = ''  ,
    @PrimaryPartNumberId Varchar(MAX) = ''  ,
    @RebuildLocationId Varchar(MAX) = ''  ,
    @ReviewStatusId Varchar(MAX) = ''  ,
    @SalesStatusId Varchar(MAX) = ''  
AS


BEGIN

	if @ProjHeaderID = '' Set @ProjHeaderId = '1'

	DECLARE @sSQL as varchar(MAX)	
	DECLARE @CurrentDate as datetime
	
	SET @CurrentDate = Getdate()
		
	IF @AnalyseBy = 'EQPL'  
		SET @sSQL =  'SELECT EqpPlan AS GroupDescr, Component AS ColDescr, '
		
	ELSE IF @AnalyseBy = 'PACL'  
		SET @sSQL =  'SELECT REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PartClassification,''''),''[NONE]''),'' - '',''-''),''-'','' - ''),''(NONE)'',''[NONE]'') AS GroupDescr, Component AS ColDescr, '
		
		
	ELSE IF @AnalyseBy = 'PARA'  
		SET @sSQL =  'SELECT REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PartRating,''''),''[NONE]''),'' - '',''-''),''-'','' - ''),''(NONE)'',''[NONE]'') AS GroupDescr, Component AS ColDescr, '
		
	ELSE IF @AnalyseBy = 'PRPA'  
		SET @sSQL =  'SELECT  REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PrimaryPartDescr,''''),''[NONE]''),'' - '',''-''),''-'','' - ''),''(NONE)'',''[NONE]'')AS GroupDescr, Component AS ColDescr, '
		
	ELSE IF @AnalyseBy = 'RELO'  
		SET @sSQL =  'SELECT  REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RebuildLocation,''''),''[NONE]''),'' - '',''-''),''-'','' - ''),''(NONE)'',''[NONE]'')  AS GroupDescr, Component AS ColDescr, '
		
	ELSE IF @AnalyseBy = 'REST'  
		SET @sSQL =  'SELECT REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(ReviewStatusDesc,''''),''[NONE]''),'' - '',''-''),''-'','' - ''),''(NONE)'',''[NONE]'')  AS GroupDescr, Component AS ColDescr, '
		
	ELSE IF @AnalyseBy = 'SAST'  
		SET @sSQL =  'SELECT REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SalesStatus,''''),''[NONE]''),'' - '',''-''),''-'','' - ''),''(NONE)'',''[NONE]'')  AS GroupDescr, Component AS ColDescr, '
	
	ELSE   
		SET @sSQL =  'SELECT  REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(Component,''''),''[NONE]''),'' - '',''-''),''-'','' - ''),''(NONE)'',''[NONE]'') AS GroupDescr, EqpPlan AS ColDescr, ' 

	
	SET @sSQL = @sSQL + ' Modifier, taskType, TaskCounter AS OccurrenceType, StrategyLocked, '
	SET @sSQL = @sSQL + ' (CASE WHEN DueDate < ' + CHAR(39) + CONVERT(varchar(20),@CurrentDate,120) +  CHAR(39) + ' THEN 1 ELSE 0 END) Overdue, DueDate, Cast([Usage] as decimal(30,0)) as [Usage], QUOM, ProjInterval, cast(ProjCost as Decimal(30,0)) as ProjCost, cast(ProjLabHours as Decimal(30,2)) as ProjLabHours, cast(ProjDuration as decimal(30,2)) as ProjDuration, '
    SET @sSQL = @sSQL + ' OccDate, '

	SET @sSQL = @sSQL + 'PrimaryPartDescr AS PartNo, CAST((CASE WHEN ISNULL(Part_Number, '''') = '''' THEN 0 ELSE 1 END) AS bit) Rotable, RotableItemId RotSerialNo, LifeUsed '

	SET @sSQL = @sSQL + ' FROM RPT_WORK_SCHEDULE_V'
	
	SET @sSQL = @sSQL + ' WHERE OccDate >= ' + CHAR(39) + CONVERT(varchar,@StartDate,121) + CHAR(39) + ' AND OccDate <= ' + CHAR(39) + CONVERT(varchar,@EndDate,121) + CHAR(39)

	IF @DealerID > 0 SET @sSQL = @sSQL + ' AND DealerID = ' + CONVERT (VARCHAR, @DealerId)  
	IF @ProjHeaderID <> '' SET @sSQL = @sSQL + ' AND ProjHeaderId In ( ' + @ProjHeaderId + ') '
	IF @BranchID <> '' SET @sSQL = @sSQL + ' AND BranchID In (' + @BranchID + ') '   
	IF @FleetID <> ''  SET @sSQL = @sSQL + ' AND FleetID In (' + @FleetID + ') ' 
	IF @EqpPlanID <> '' SET @sSQL = @sSQL + ' AND EqpPlanID  In (' + @EqpPlanID + ') ' 	
	IF @ModelID <> ''  SET @sSQL = @sSQL + ' AND ModelID IN (' + @ModelID +')'
	If @CostTypeId <> '' Set @sSql = @sSQL + ' AND CostTypeId In (' + @CostTypeId + ') ' 
	IF @SystemId <> ''  SET @sSQL = @sSQL + ' AND Systemid IN (' + @Systemid +') '
	IF @SubSystemId <> ''  SET @sSQL = @sSQL + ' AND SubSystemId IN (' + @SubSystemid +') '	
	IF @TaskTypeID <> ''  SET @sSQL = @sSQL + 'AND TaskTypeID IN (' + @TaskTypeID + ') '
	IF @CompCodeID <> ''  SET @sSQL = @sSQL + 'AND  CompCodeID IN (' +  @CompCodeID + ') '
	IF @SiteID <> '' SET @sSQL = @sSQL + ' AND SiteId  In (' + @SiteID + ') '
	IF @TaskCounterID <> '' SET @sSQL = @sSQL + ' AND TaskCounterID  In (' + @TaskCounterID + ') '
	IF @StrategyTaskID <> '' SET @sSQL = @sSQL + ' AND Task_Header_ID  In (' + @StrategyTaskID + ') '
	IF @EqpLocationId <> '' SET @sSQL = @sSQL + ' AND ISNULL(Eqp_Location_Id,0)  IN (' + @EqpLocationId + ') '
	IF @EqpLocationId <> '' SET @sSQL = @sSQL + ' AND ISNULL(Eqp_Location_Id,0)  IN (' + @EqpLocationId + ') '
	IF @PartClassificationId <> '' SET @sSQL = @sSQL + ' AND PartClassificationId  IN (' + @PartClassificationId + ') '  
	IF @PartRatingId <> '' SET @sSQL = @sSQL + ' AND PartRatingId  IN (' + @PartRatingId + ') ' 
	IF @PrimaryPartNumberId <> '' SET @sSQL = @sSQL + ' AND Part_Id  IN (' + @PrimaryPartNumberId + ') ' 
	IF @RebuildLocationId <> '' SET @sSQL = @sSQL + ' AND RebuildLocationId  IN (' + @RebuildLocationId + ') '
	IF @ReviewStatusId <> '' SET @sSQL = @sSQL + ' AND ReviewStatusId  IN (' + @ReviewStatusId + ') '
	IF @SalesStatusId <> '' SET @sSQL = @sSQL + ' AND SalesStatusId  IN (' + @SalesStatusId + ') '


	IF @AnalyseBy = 'EVCC'
		SET @sSQL = @sSQL + 'ORDER BY  DueDate, EqpPlan, Modifier'	
	ELSE 
		SET @sSQL = @sSQL + 'ORDER BY  DueDate, Component, Modifier '
		


	--PRINT(@sSQL)	
	EXEC(@sSQL)	
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PARTS_MANAGER_PUT_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[PARTS_MANAGER_PUT_P]
GO

CREATE PROCEDURE PARTS_MANAGER_PUT_P
/******************************************************************************
	File: PARTS_MANAGER_PUT_P.sql
	Name: PARTS_MANAGER_PUT_P

	Called By: 

	Desc: 
             

	Auth: Koushik.Nagarajan
	Date: 22-Aug-2008	
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	11 APR 12   SD			E778 - Add new PEX fields
	
OLD HISTORY
------------	
	07 Nov 08	K N			Update Linked Prices as well
	17 Nov 08	K N			Use PartNumber + source of supply as UNIQUE
*******************************************************************************/
	/* Param List */	
	@XMLDocument XML,
	@ForceUpdate BIT = 0,	
	@UserId INT = 0,
	@Message VARCHAR(MAX) = '' OUTPUT
	
AS

 
CREATE TABLE #TT_PARTS_DETAILS
	(
		PartPriceId INT NOT NULL,
		Source_Of_Supply_ID INT NOT NULL,
		PartId INT NOT NULL,
		Part VARCHAR(50) COLLATE database_default NOT NULL,
		PartDescription VARCHAR(50) COLLATE database_default NOT NULL,
		PartTypeId INT NOT NULL,
		Price_Group_Id INT NOT NULL,
		CurrencyID INT NOT NULL,
		Part_Sell FLOAT NOT NULL,
		Part_Cost FLOAT NOT NULL,
		Full_Credit_Sell FLOAT NOT NULL,
		Full_Credit_Cost FLOAT NOT NULL,
		Partial_Credit_Sell FLOAT NOT NULL,
		Partial_Credit_Cost FLOAT NOT NULL,
		PartSuperseded BIT NOT NULL,
		LastPriceUpdate DATETIME NOT NULL,
		/*E778*/
		BudgetDeliveryTimeToWorkshop  FLOAT NOT NULL,
        BudgetTimeWaitingForRebuild   FLOAT NOT NULL,
        BudgetRebuildDuration         FLOAT NOT NULL,
        BudgetDeliveryTimeToWarehouse FLOAT NOT NULL,
        BudgetTotalTurnTime           FLOAT NOT NULL,
        DefaultComponentCodeId        INT   NULL,
        DefaultPartRatingId           INT   NULL	
	)
CREATE INDEX #TT_PARTS_DETAILS_IDX ON #TT_PARTS_DETAILS(PartPriceId)

DECLARE @idoc int
EXEC sp_xml_preparedocument @idoc OUTPUT, @XMLDocument
 
INSERT INTO	#TT_PARTS_DETAILS (
	PartPriceId,
	Source_Of_Supply_ID,
	PartId,
	Part,
	PartDescription,
	PartTypeId,
	Price_Group_Id,
	CurrencyID,
	Part_Sell,
	Part_Cost,
	Full_Credit_Sell,
	Full_Credit_Cost,
	Partial_Credit_Sell,
	Partial_Credit_Cost,
	PartSuperseded,
	LastPriceUpdate,
	/*E778*/
	BudgetDeliveryTimeToWorkshop,
    BudgetTimeWaitingForRebuild,
    BudgetRebuildDuration,
    BudgetDeliveryTimeToWarehouse,
    BudgetTotalTurnTime,
    DefaultComponentCodeId,
    DefaultPartRatingId	
	)
SELECT 
	sdata.PartPriceId,
	sdata.Source_Of_Supply_ID,
	sdata.PartId,
	sdata.Part,
	sdata.PartDescription,
	sdata.PartTypeId,
	sdata.Price_Group_Id,
	sdata.CurrencyID,
	sdata.Part_Sell,
	sdata.Part_Cost,
	sdata.Full_Credit_Sell,
	sdata.Full_Credit_Cost,
	sdata.Partial_Credit_Sell,
	sdata.Partial_Credit_Cost,
	sdata.PartSuperseded,
	sdata.LastPriceUpdate,
	/*E778*/
	sdata.BudgetDeliveryTimeToWorkshop,
    sdata.BudgetTimeWaitingForRebuild,
    sdata.BudgetRebuildDuration,
    sdata.BudgetDeliveryTimeToWarehouse,
    sdata.BudgetTotalTurnTime,
    sdata.DefaultComponentCodeId,
    sdata.DefaultPartRatingId	
FROM	OPENXML (@idoc, '/Parts/Part',2) WITH #TT_PARTS_DETAILS sdata

EXEC sp_xml_removedocument @idoc	

--SELECT * FROM #TT_PARTS_DETAILS

---- BUSINESS RULES
IF @ForceUpdate=0
	IF EXISTS(	SELECT sdata.PartPriceId
				FROM	tblPartPrices PP
						RIGHT JOIN #TT_PARTS_DETAILS sdata ON sdata.PartPriceId=PP.PartPriceId
				WHERE	 sdata.LastPriceUpdate <> PP.LastModDate
		) 
	  
	BEGIN		
		SET @Message='The data was modified by another user.'
		RETURN
	END

--BUSINESS RULES
IF EXISTS (SELECT P.PartId FROM tblParts P	INNER JOIN #TT_PARTS_DETAILS sdata ON sdata.Part = P.Part AND sdata.Source_Of_Supply_ID = P.Source_Of_Supply_ID AND sdata.PartId <> P.PartId WHERE P.PartId > 0)
OR EXISTS (SELECT P.PartId FROM tblParts P	INNER JOIN #TT_PARTS_DETAILS sdata ON sdata.Part = P.Part AND sdata.Source_Of_Supply_ID = P.Source_Of_Supply_ID WHERE P.PartId = 0)
BEGIN		
	SET @Message='Combination of Part Number and Source of Supply already exists.'
	RETURN
END

DECLARE @TodaysDate DATETIME
SET @TodaysDate = GETDATE()
 
--INSERT
INSERT INTO tblParts( 
	Part,
	PartDescription,
	Part_Type_ID,
	Fluid_Part,
	Source_Of_Supply_ID,
	PartSuperseded,
	LastModByUserId,
	LastModDate,
	CreateByUserId,
	CreateDate,
	/*E778*/
	BudgetDeliveryTimeToWorkshop,
    BudgetTimeWaitingForRebuild,
    BudgetRebuildDuration,
    BudgetDeliveryTimeToWarehouse,
    BudgetTotalTurnTime,
    DefaultComponentCodeId,
    DefaultPartRatingId	
	)
SELECT DISTINCT
	sdata.Part,
	sdata.PartDescription,
	sdata.PartTypeId,
	0,
	sdata.Source_Of_Supply_ID,
	sdata.PartSuperseded,
	@UserId,
	@TodaysDate,
	@UserId,
	@TodaysDate,
	/*E778*/
	sdata.BudgetDeliveryTimeToWorkshop,
    sdata.BudgetTimeWaitingForRebuild,
    sdata.BudgetRebuildDuration,
    sdata.BudgetDeliveryTimeToWarehouse,
    sdata.BudgetTotalTurnTime,
    sdata.DefaultComponentCodeId,
    sdata.DefaultPartRatingId		
FROM #TT_PARTS_DETAILS sdata
WHERE PartPriceId < 0

--Update PartId
UPDATE sdata
	SET sdata.PartId = P.PartId
FROM #TT_PARTS_DETAILS sdata
	INNER JOIN tblParts P ON sdata.Part = P.Part AND sdata.Source_Of_Supply_ID = P.Source_Of_Supply_ID
WHERE sdata.PartPriceId < 0

INSERT INTO tblPartPrices( 
	PartId,
	CurrencyId,
	Part_Sell,
	Part_Cost,
	Full_Credit_Sell,
	Full_Credit_Cost,
	Partial_Credit_Sell,
	Partial_Credit_Cost,
	Price_Group_ID,
	LastModByUserId,
	LastModDate,
	CreateByUserId,
	CreateDate
	)
SELECT  
	sdata.PartId,
	--sdata.CurrencyId,
	C.CurrencyID,
	(sdata.Part_Sell / ERC.ExRate ) * ERC2.ExRate,
	(sdata.Part_Cost / ERC.ExRate ) * ERC2.ExRate,
	(sdata.Full_Credit_Sell / ERC.ExRate ) * ERC2.ExRate,
	(sdata.Full_Credit_Cost / ERC.ExRate ) * ERC2.ExRate,
	(sdata.Partial_Credit_Sell / ERC2.ExRate ) * ERC2.ExRate,
	(sdata.Partial_Credit_Cost / ERC2.ExRate ) * ERC2.ExRate,
	PG.Price_Group_ID,
	@UserId,
	@TodaysDate,
	@UserId,
	@TodaysDate
FROM #TT_PARTS_DETAILS sdata 
	CROSS JOIN tblCurrencies C
	CROSS JOIN PRICE_GROUP PG
	INNER JOIN tblExRateCurrencies ERC ON ERC.ExRateId =0 AND ERC.CurrencyId = sdata.CurrencyId
	INNER JOIN tblExRateCurrencies ERC2 ON ERC2.ExRateId =0 AND ERC2.CurrencyId = C.CurrencyId
WHERE PartPriceId < 0
 
UPDATE P
	SET
		P.Part = sdata.Part,
		P.PartDescription = sdata.PartDescription,
		P.Part_Type_ID = sdata.PartTypeId,
		P.Source_Of_Supply_ID = sdata.Source_Of_Supply_ID,
		P.PartSuperseded = sdata.PartSuperseded,
		P.LastModDate = @TodaysDate,
		/*E778*/
		P.BudgetDeliveryTimeToWorkshop = sdata.BudgetDeliveryTimeToWorkshop,
		P.BudgetTimeWaitingForRebuild = sdata.BudgetTimeWaitingForRebuild,
		P.BudgetRebuildDuration = sdata.BudgetRebuildDuration,
		P.BudgetDeliveryTimeToWarehouse = sdata.BudgetDeliveryTimeToWarehouse,
		P.BudgetTotalTurnTime = sdata.BudgetTotalTurnTime,
		P.DefaultComponentCodeId = sdata.DefaultComponentCodeId,
		P.DefaultPartRatingId = sdata.DefaultPartRatingId			
FROM tblParts P
	INNER JOIN #TT_PARTS_DETAILS sdata ON P.PartId = sdata.PartId 
WHERE sdata.PartPriceId > 0


 
UPDATE PP
	SET 		
	PP.Part_Sell = sdata.Part_Sell,
	PP.Part_Cost = sdata.Part_Cost,
	PP.Full_Credit_Sell = sdata.Full_Credit_Sell,
	PP.Full_Credit_Cost = sdata.Full_Credit_Cost,
	PP.Partial_Credit_Sell = sdata.Partial_Credit_Sell,
	PP.Partial_Credit_Cost = sdata.Partial_Credit_Cost,
	PP.LastModDate = @TodaysDate
FROM tblPartPrices PP
	INNER JOIN #TT_PARTS_DETAILS sdata ON sdata.PartPriceId = PP.PartPriceId
	 

DECLARE @StdJobId VARCHAR(MAX)

SET @StdJobId=''

SELECT @StdJobId  = (SELECT DISTINCT CAST(SJO.StdJobId AS varchar)+','
						FROM #TT_PARTS_DETAILS sdata
						INNER JOIN tblStdJobOperationParts SJOP ON  SJOP.PartId = sdata.PartId
						INNER JOIN tblStdJobOperations SJO ON SJOP.StdJobOperationId = SJO.StdJobOperationId
						FOR XML PATH('')
					)

IF ISNULL(@StdJobId,'') <> ''
BEGIN

	SET @StdJobId=LEFT(@StdJobId,LEN(@StdJobId)-1)
	EXEC PRICED_JOB_HRS_COST_UPDATE_P @StdJobID=@StdJobID, @UpdateProjTaskAmts=1

END
DROP TABLE #TT_PARTS_DETAILS


GO	

 
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PARTS_MANAGER_GET_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[PARTS_MANAGER_GET_P]
GO

CREATE PROCEDURE PARTS_MANAGER_GET_P
/******************************************************************************
	File: PARTS_MANAGER_GET_P.sql
	Name: PARTS_MANAGER_GET_P

	Called By: 

	Desc: 
             

	Auth: Koushik.Nagarajan
	Date: 10/09/07
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	11 APR 12   SD			E778 - Add new PEX fields	
	
OLD HISTORY
------------
	15-Oct-08	K N			Fixed filtering SJ Description.
	01-May-09	K N			Terex Enhancements (Reorder Column) + include Min Max Std Job Prob	
	03 Dec 09	K N			Fixed filtering TaskType
*******************************************************************************/
	/* Param List */
	@UserId INT = 0,
	@PriceGroupId VARCHAR(MAX) ='',
	@CurrencyId VARCHAR(MAX) ='',
	@SourceOfSupplyId VARCHAR(MAX) ='',
	@PartTypeId VARCHAR(MAX) ='',
	@PartDescription VARCHAR(MAX) ='',
	@PartNumber VARCHAR(MAX) ='',
	@MinPrice VARCHAR(MAX) ='',
	@MaxPrice VARCHAR(MAX) ='',
	@IsLastUpdated BIT = 0 ,
	@PriorDate DATETIME = '1-Jan-1950',
	@IsSuperSeded INT = 0,	
	@SJBranchId VARCHAR(MAX) ='',
	@SJModelId VARCHAR(MAX) ='',
	@SJComponentCodeId VARCHAR(MAX) ='',
	@SJModifierCodeId VARCHAR(MAX) ='',
	@SJTaskTypeId VARCHAR(MAX) ='',
	@SJJobCodeId VARCHAR(MAX) ='',
	@SJStatusId VARCHAR(MAX) ='',
	@SJSourceId VARCHAR(MAX) ='',	
	@SJShowDummy SMALLINT = 0,
	@SJReference VARCHAR(MAX) ='',
	@SJSearchText VARCHAR(100) = '',
	@SJMaxProbability  VARCHAR(100) = '',
	@SJMinProbability VARCHAR(100) = '',
	@IsGetAnyway BIT = 0,
	@IsAddNewRow BIT = 0

AS


IF @IsAddNewRow = 1
BEGIN
	SELECT  V.PartPriceId, V.Source_Of_Supply_ID, 
		V.SourceOfSupply, 
		V.PartTypeId, 
		V.PartType, 
		V.PartId, 
		V.Part, 
		V.PartDescription, 
		V.Price_Group_Id, 
		V.Price_Group, 	
		V.CurrencyID, 
		V.Currency, 

		V.Part_Sell, 
		V.Part_Cost, 
		V.Full_Credit_Sell, 
		V.Full_Credit_Cost, 
		V.Partial_Credit_Sell,
		V.Partial_Credit_Cost,  
		V.LastPriceUpdate,
		V.PartSuperseded, 
		0 AS UsedInStdJob,
		/*E778*/
		V.BudgetDeliveryTimeToWorkshop,
		V.BudgetTimeWaitingForRebuild,
		V.BudgetRebuildDuration,
		V.BudgetDeliveryTimeToWarehouse,
		V.BudgetTotalTurnTime,
		V.DefaultComponentCodeId,
		V.DefaultComponent,
		V.DefaultPartRatingId,
		V.DefaultPartRating		
	FROM PART_PRICE_DETAILS_V V  WHERE  V.PartPriceId < 0

	RETURN
END
DECLARE @SqlWhereClause VARCHAR(MAX)
DECLARE @SJSqlWhereClause VARCHAR(MAX)

DECLARE @Sql VARCHAR(MAX)

DECLARE @SqlFrom VARCHAR(MAX) 
DECLARE @SqlSJ VARCHAR (MAX)

SET @SqlFrom = ' FROM PART_PRICE_DETAILS_V V '
SET @SqlFrom = @SqlFrom +  ' LEFT JOIN (SELECT tblStdJobOperationParts.PartId , COUNT(DISTINCT tblStdJobs.StdJobId) AS NoOfStdJobs '
SET @SqlFrom = @SqlFrom +  ' FROM   tblStdJobOperationParts  '
SET @SqlFrom = @SqlFrom +  ' INNER JOIN tblStdJobOperations ON tblStdJobOperationParts.StdJobOperationId = tblStdJobOperations.StdJobOperationId  '
SET @SqlFrom = @SqlFrom +  ' INNER JOIN tblStdJobs ON tblStdJobOperations.StdJobId = tblStdJobs.StdJobId '
SET @SqlFrom = @SqlFrom +  ' GROUP BY  tblStdJobOperationParts.PartId) CSJ ON CSJ.PartId = V.PartId '




 
SET @SqlWhereClause = ' WHERE 1 = 1 '

IF @PriceGroupId <> ''
BEGIN
	IF RIGHT(@PriceGroupId,1)=',' SET @PriceGroupId=LEFT(@PriceGroupId,LEN(@PriceGroupId)-1)
	SET  @SqlWhereClause = @SqlWhereClause +  ' AND V.Price_Group_ID IN (' + @PriceGroupId + ') '
END

IF @CurrencyId <> ''
BEGIN
	IF RIGHT(@CurrencyId,1)=',' SET @CurrencyId=LEFT(@CurrencyId,LEN(@CurrencyId)-1)
	SET  @SqlWhereClause = @SqlWhereClause +  ' AND V.CurrencyID IN (' + @CurrencyId + ') '
END


IF @SourceofSupplyId <> ''
	BEGIN
		IF RIGHT(@SourceofSupplyId,1)=',' SET @SourceofSupplyId=LEFT(@SourceofSupplyId,LEN(@SourceofSupplyId)-1)
		SET  @SqlWhereClause = @SqlWhereClause +  ' AND V.Source_Of_Supply_ID IN (' + @SourceofSupplyId + ') '
	END

IF @PartTypeId <> ''
	BEGIN
		IF RIGHT(@PartTypeId,1)=',' SET @PartTypeId=LEFT(@PartTypeId,LEN(@PartTypeId)-1)
		SET  @SqlWhereClause = @SqlWhereClause +  ' AND V.PartTypeId IN (' + @PartTypeId + ') '
	END

IF @PartNumber <> ''
	BEGIN	
		SET @SqlWhereClause =  @SqlWhereClause + ' AND V.Part LIKE ''%'+ @PartNumber +'%'' '
	END

IF @PartDescription <> ''
	BEGIN	
		SET @SqlWhereClause =  @SqlWhereClause + ' AND V.PartDescription LIKE ''%'+ @PartDescription +'%'' '
	END

IF @MinPrice <> ''
	SET @SqlWhereClause =  @SqlWhereClause + ' AND V.Part_Sell >= ' + @MinPrice


IF @MaxPrice  <> ''
	SET @SqlWhereClause =  @SqlWhereClause + ' AND V.Part_Sell <= ' + @MaxPrice

IF @IsSuperSeded <> 2
BEGIN
	SET @SqlWhereClause =  @SqlWhereClause + ' AND V.PartSuperSeded = ' + CASE WHEN @IsSuperSeded = 1 THEN ' 1 ' ELSE ' 0 ' END
END
--
 
IF @IsLastUpdated =1 AND @PriorDate IS NOT NULL
BEGIN
	SET @SqlWhereClause =  @SqlWhereClause + ' AND V.LastPriceUpdate <= ''' + CAST(@PriorDate AS VARCHAR) + ''' '
END
 

SET @SJSqlWhereClause = ' WHERE 1 = 1 '



IF @SJBranchId <> ''
	BEGIN
		IF RIGHT(@SJBranchId,1)=',' SET @SJBranchId=LEFT(@SJBranchId,LEN(@SJBranchId)-1)
		SET @SJSqlWhereClause = @SJSqlWhereClause + ' AND SJV.BranchId IN (' + @SJBranchId + ') '
	END


IF @SJModelId <> ''
	BEGIN
		IF RIGHT(@SJModelId,1)=',' SET @SJModelId=LEFT(@SJModelId,LEN(@SJModelId)-1)
		SET  @SJSqlWhereClause = @SJSqlWhereClause +  ' AND SJV.ModelId IN (' + @SJModelId + ') '
	END

IF @SJComponentCodeId <> ''
	BEGIN
		IF RIGHT(@SJComponentCodeId,1)=',' SET @SJComponentCodeId=LEFT(@SJComponentCodeId,LEN(@SJComponentCodeId)-1)
		SET  @SJSqlWhereClause = @SJSqlWhereClause +  ' AND SJV.ComponentCodeId IN (' + @SJComponentCodeId + ') '
	END

IF @SJModifierCodeId <> ''
	BEGIN
		IF RIGHT(@SJModifierCodeId,1)=',' SET @SJModifierCodeId=LEFT(@SJModifierCodeId,LEN(@SJModifierCodeId)-1)
		SET  @SJSqlWhereClause = @SJSqlWhereClause +  ' AND SJV.ModifierID IN (' + @SJModifierCodeId + ') '
	END

IF @SJTaskTypeId <> ''
	BEGIN
		IF RIGHT(@SJTaskTypeId,1)=',' SET @SJTaskTypeId=LEFT(@SJTaskTypeId,LEN(@SJTaskTypeId)-1)
		SET  @SJSqlWhereClause = @SJSqlWhereClause +  ' AND SJV.TaskTypeId IN (' + @SJTaskTypeId + ') '
	END

IF @SJJobCodeId <> ''
	BEGIN
		IF RIGHT(@SJJobCodeId,1)=',' SET @SJJobCodeId=LEFT(@SJJobCodeId,LEN(@SJJobCodeId)-1)
		SET  @SJSqlWhereClause = @SJSqlWhereClause +  ' AND SJV.JobCodeId IN (' + @SJJobCodeId + ') '
	END

IF @SJSourceId <> ''
	BEGIN
		IF RIGHT(@SJSourceId,1)=',' SET @SJSourceId=LEFT(@SJSourceId,LEN(@SJSourceId)-1)
		SET  @SJSqlWhereClause = @SJSqlWhereClause +  ' AND SJV.System_Source_Id IN (' + @SJSourceId + ') '
	END

 
IF @SJReference <> ''
	BEGIN
		IF RIGHT(@SJReference,1)=',' SET @SJReference=LEFT(@SJReference,LEN(@SJReference)-1)
		SET  @SJSqlWhereClause = @SJSqlWhereClause +  ' AND SJV.Simulation_Reference IN (' + @SJReference + ') '
	END
 
IF @SJSearchText <> '' AND @SJSearchText <> '%%'
 		SET @SJSqlWhereClause = @SJSqlWhereClause+ ' AND SJV.StdJob LIKE ''%' + @SJSearchText + '%'' '

 
IF @SJStatusId <> ''
	BEGIN		
		SET @SJStatusId =REPLACE(ISNULL(@SJStatusId,''),'''','') 		

		IF @SJStatusId = '1'
			SET  @SJSqlWhereClause = @SJSqlWhereClause +  ' AND  SJV.Live_Job = 1 '
		ELSE IF @SJStatusId = '0'
			SET  @SJSqlWhereClause = @SJSqlWhereClause +  ' AND  SJV.Live_Job = 0 '
	END

IF @SJSqlWhereClause <> ' WHERE 1 = 1 ' OR @SJMaxProbability <> '' OR  @SJMinProbability <> ''
BEGIN

	SET @SqlSJ = ' SELECT DISTINCT SJP.PartId SJP FROM tblStdJobOperationParts SJP '
	SET @SqlSJ = @SqlSJ +  ' INNER JOIN tblStdJobOperations SJO ON SJO.StdJobOperationId = SJP.StdJobOperationId '
	SET @SqlSJ = @SqlSJ +  ' INNER JOIN STD_JOBS_V SJV ON SJV.StdJobId = SJO.StdJobId  '

	IF @PriceGroupId <> ''
	BEGIN
		SET  @SJSqlWhereClause = @SJSqlWhereClause +  ' AND SJV.Price_Group_ID IN (' + @PriceGroupId + ') '
	END

	IF @CurrencyId <> ''
	BEGIN
		SET  @SJSqlWhereClause = @SJSqlWhereClause +  ' AND SJV.CurrencyID IN (' + @CurrencyId + ') '
	END

	IF @SJMaxProbability <> ''
	BEGIN
		SET  @SJSqlWhereClause = @SJSqlWhereClause +  ' AND SJP.Probability  <= ' + @SJMaxProbability
	END


	IF @SJMinProbability <> ''
	BEGIN
		SET  @SJSqlWhereClause = @SJSqlWhereClause +  ' AND SJP.Probability  >= ' + @SJMinProbability
	END
	
	SET @SqlWhereClause = @SqlWhereClause + ' AND V.PartId IN (' + @SqlSJ + @SJSqlWhereClause  + ' ) '
END





IF @IsGetAnyWay = 0
BEGIN
	CREATE TABLE #CountRec( CountRec INT NULL)	

	SET @Sql =  ' INSERT INTO #CountRec SELECT Count(*) '
	SET @Sql = @Sql +  @SqlFrom 
	SET @Sql = @Sql + @SqlWhereClause
	EXEC (@Sql)	
	
	IF EXISTS (SELECT 	CountRec FROM #CountRec WHERE CountRec > 2000)
	BEGIN	
		SELECT CountRec FROM #CountRec
		DROP TABLE #CountRec
		RETURN
	END
END

 
SET @Sql =  ' SELECT  V.PartPriceId, V.Source_Of_Supply_ID, V.SourceOfSupply, V.PartTypeId, V.PartType, V.PartId, V.Part, V.PartDescription, '
SET @Sql = @Sql + ' V.Price_Group_Id, V.Price_Group, V.CurrencyID, V.Currency, V.Part_Sell, V.Part_Cost, V.Full_Credit_Sell, V.Full_Credit_Cost,  '
SET @Sql = @Sql + ' V.Partial_Credit_Sell,	V.Partial_Credit_Cost,  V.LastPriceUpdate, V.PartSuperseded, ISNULL(CSJ.NoOfStdJobs,0) AS UsedInStdJob, '
/*E778*/
SET @Sql = @Sql + ' V.BudgetDeliveryTimeToWorkshop, V.BudgetTimeWaitingForRebuild, V.BudgetRebuildDuration, V.BudgetDeliveryTimeToWarehouse, '
SET @Sql = @Sql + ' V.BudgetTotalTurnTime, V.DefaultComponentCodeId, V.DefaultComponent, V.DefaultPartRatingId, V.DefaultPartRating	'
SET @Sql = @Sql +  @SqlFrom 
SET @Sql = @Sql + @SqlWhereClause +  ' ORDER BY V.Part, V.PartDescription,V.Currency , V.Price_Group  '

--PRINT @SQL
EXEC (@Sql)

GO


if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[PROJECTION_TASK_COPY_MULTIEQP_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[PROJECTION_TASK_COPY_MULTIEQP_P]
GO




create   Procedure [dbo].[PROJECTION_TASK_COPY_MULTIEQP_P]
/******************************************************************************
	File: 
	Name: PROJECTION_TASK_COPY_MULTIEQP_P

	Called By: -

	Desc:	Copies 1 task for many equipments..

	Auth: Sergey Ivanov
	Date: 16 May 2005

*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	12 Apr 2012 SD          E781 - Add PEX tblProjTasks new fields
	29 Oct 2010	V Vasylyeva #721
	27 Oct 2010	V Vasylyeva	#721 Errors if overwrite option is set to 0,
							and the strategy task exist in one of equipment
							to copy to and does not exist in the other equipment
	 5 Oct 2010	V Vasylyeva	E316 Added PartRatingId
							#672 Proj task opt does not copy 
	 7 Jul 10	V Vasylyeva	CR9019: Added CBDTask
	11 Feb 10	V Vasylyeva	CR8774 Added default value for ReviewStatusId
	03 Sep 09	K Nagarajan	CR8377 Copy AMT_Wo_Last_Occ Fields
	25-May-09	V Vasylyeva	CR8109 Copy occ fields for alternate projections
	 1-May-09	V Vaylyeva	CR8035 Library Links
	 7 Nov 08	V Vasylyeva	CR7673 
	26 Aug 08	V Vasylyeva Added external identifier to the business rules
	13 Jun 08	V Vasylyeva	Added StdJobPartsMargin
	11 Mar 08	V Vasylyeva	Added @CopyPerfStrat, changed to bulk copy/update
	 7 Feb 08	V Vasylyeva Removed Show_Strategy
	02 Jul 07	KN		Copy Inspection Logic fields as well.
	09 Nov 06	AL		fixed loop through projections and tasks
	20 Oct 06	AL		Fixed first occurrence for options and @firstOccOption=1 
	18 Oct 06	AL		Added overwrite,firstOccOption,rotPartOption,supDepOption
	29 Sep 06	VV		Removed call to PROJECTION_TASK_COPY_P
	23 Dec 05	SI		Fixed EqpPlanId substring
	28 Dec 05	  RF		Strip out QUOTES (') from the Equip Plan String being passed in
	04 Apr 11   GW      Add AutoGenerateWOS
*******************************************************************************/
	/* Param List */

	@fromEqpPlanId int,
	@fromEqpProjHeaderId int,
	@fromProjTaskHeaderId int,

	@toFleetId int,
	@toEqpPlanId varchar(8000),
	@toEqpProjHeaderId int,

	@Esc_Desc_Prices bit=0,
	@KeepLinkToStdJob bit=1,
	@EqpUpdated int=0 OUTPUT,
	
	@overwrite bit=0,
	@firstOccOption int=1,
	@rotPartOption int=1,
	@supDepOption int=1,
	
	@errorMsg varchar(8000)='' OUTPUT,
	@CopyPerfStrat bit=1


AS



DECLARE @error bit,@Max_Entries	int,@IDcount1 int,@IDcount2 int
DECLARE @ProjTypeArch int,@ProjHeaderCur int
DECLARE @CurrDate datetime

DECLARE @ProjTypeBud int
DECLARE @ProjTypeEstC int
DECLARE @ProjTypeEstD int
DECLARE @ProjTypeCurr int
DECLARE @ProjTypeAlt int
DECLARE @ProjTypeCen int

DECLARE @Filter_Std_Job_Model BIT
DECLARE @SystemSourceAMT int
DECLARE @CopyRotable bit

DECLARE @firstFromSource int
DECLARE @firstFromLastChange int
DECLARE @PlanStatusUsage int
DECLARE @PlanStatusDate int

DECLARE @Id varchar(8000)
DECLARE @Counter int
DECLARE @ProjTaskId int

SET @ProjTypeCurr =1
SET @ProjTypeAlt =3
SET @ProjTypeCen =5

SET @PlanStatusUsage=1
SET @PlanStatusDate=2


SET @firstFromSource=1
SET @firstFromLastChange=2

SET @SystemSourceAMT=1

SET @ProjTypeArch=4
SET @ProjHeaderCur=1

SET @ProjTypeBud=2
SET @ProjTypeEstC=6
SET @ProjTypeEstD=7

SET @CurrDate=GETDATE()

SET @errorMsg=''
SET @EqpUpdated=0

SET @toEqpPlanId = REPLACE(@toEqpPlanId,char(39),'')
--check eqpplans to apply to
IF @toEqpPlanId=''
BEGIN
	SET @errorMsg='Please select equipments to copy the task to.'
	RETURN
END
SELECT @Max_Entries=Max_Entries_to_Process,@Filter_Std_Job_Model = Filter_Std_Job_Model
FROM AMT_VARIABLE

SET @IDcount1=LEN(@toEqpPlanId)
SET @IDcount2=LEN(REPLACE(@toEqpPlanId,',',''))
IF @Max_Entries>0 AND (@IDcount1-@IDcount2+1)>@Max_Entries
BEGIN
	SET @errorMsg='Please select UP TO ' + convert(varchar,@Max_Entries) + ' equipments to copy the task to.'
	RETURN
END



--Do not copy rotable details for non-current projections
SET @CopyRotable=0

IF @toEqpProjHeaderId=@ProjHeaderCur SET @CopyRotable=1
	

CREATE TABLE #z_PTFrom(
ProjTaskId int,
EqpPlanId int,
EqpProjId int,
ComponentCodeId int,
ModifierId int,
TaskTypeId int,
ApplicationCodeId int,
ManufacturerId int,
UsageMethod char(1),
UsageQUOMId int,
[First] float,
Frequency float,
Final float,
Unscheduled smallint,
Task_Header_Id int,
Rotable_Part_Id int,
Group_Number varchar(50) COLLATE DATABASE_DEFAULT,
Part_Id int,
Planning_Task bit,
Planning_Lead_Time int,
Schedule_Type_Id int,
Scheduling_Group_Id int,
Scheduling_Group_Counter int,
Operational_Criticality_Id int,
Warranty_Period_Usage float,
Warranty_Period_Days float,
Maintenance_Strategy_Id int,
Changeout_Guidelines varchar(1000) COLLATE DATABASE_DEFAULT,
Task_Description varchar(100) COLLATE DATABASE_DEFAULT,
InspectionTaskTypeId int,
InspectionOffset float,
PerformanceStrategyReason varchar(200) COLLATE DATABASE_DEFAULT,
RCMComponentStructureId int,
ParentTaskId int,
AutomaticUpdate bit,
/*VV CR8109*/
LastOcc float,
LastOccDate datetime,
PlanUseCalc bit,
PlanStatus tinyint,
NextOcc float,
NextOccDate datetime,
ReviewStatusID int,
ReviewUserID int,
ReviewDate datetime,
Projection_Type_Id int,
AMT_WO_Last_Occ float,
AMT_WO_Last_Occ_Date datetime,
/*VV CR9019*/CBDTask bit,
/*VV E316*/PartRatingId int,
AutoGenerateWOS bit,
/*E781*/
PartClassificationId int,
DefaultLocationForRebuild int

PRIMARY KEY(ProjTaskId))

CREATE TABLE #z_PTOFrom(
	ProjTaskOptId int,
	ProjTaskId int,
	OccurrenceTypeId int,
	ProjTaskOpt varchar(50) COLLATE DATABASE_DEFAULT,
	Probability real,
	PlannedOption smallint,
	[First] float,
	Frequency float PRIMARY KEY(ProjTaskId,ProjTaskOptId))


CREATE TABLE #z_PTAFrom(
	ProjTaskAmtId int,
	ProjTaskOptId int,
	PricedJobId int,
	JobCodeId int,
	PerformedAtSiteId int,
	LaborShare float,
	PartTypeId int,
	CurrencyId int,
	LaborCost float,
	PartsCost float,
	MiscCost float,
	Duration float,
	Rotable_Repair_Strategy bit,
	Action_Required_Id int,
	Rebuild_Location_Id int,
	Pricing_Date datetime,
	Labour_Activity_Id int,
	Misc_Cost_Expense_ID int,
	Labour_Cost_Expense_ID int,
	Cost_Bearer_ID int,
	Parts_Cost_Expense_ID int,
	Crane_Cost float,
	Pct_Freight float,
	Avg_Daily_Work_Hrs float,
	Avg_No_People float,
	Avg_Travel_Hrs float,
	Travel_Distance float,
	Travel_Recovery_Rate_L float,
	Misc_Trip_Cost float,
	LaborHours float,
	Labour_Hrs_Field bit,
	Travel_Recovery_Rate_V float,
	Parts_EDC_ID int,
	Labour_EDC_ID int,
	Misc_EDC_ID int,
	Cost_Centre_ID int,
	Work_Group_Id int,
	Health_Safety_Id int,
	QtyVolume float,
	PercentTopUp float,
	UnitPrice float,
	Consumable bit,
	StdJobId int,
	StdJobModelId int,
	StdJobPartsMargin float
PRIMARY KEY(ProjTaskAmtId,ProjTaskOptId))

CREATE TABLE #z_CAFrom(
	Cost_Allocation_Id int,
	Cost_Allocation_Ref varchar(100)COLLATE DATABASE_DEFAULT,
	Currency_Id int,
	System_Source_Id int,
	Component_Code_Id int,
	Model_Id int,
	Create_Date datetime,
	Last_Mod_Date datetime,
	Proj_Task_Amt_Id int,
	Scheduling_Task_Id int,
	Eqp_Plan_Id int,
	ModifierId int
PRIMARY KEY(Cost_Allocation_Id,Proj_Task_Amt_Id))

CREATE TABLE #z_CADFrom(
Cost_Allocation_Details_Id int,
Cost_Allocation_Id int,
Work_Group_Id int,
Cost_Centre_Id int,
Parts_Cost_Expense_Id int,
Labour_Cost_Expense_Id int,
Misc_Cost_Expense_Id int,
Cost_Bearer_Id int,
Parts_Cost float,
Misc_Cost float,
Labour_Cost float,
Labour_Activity_Id int,
Labour_Hrs float,
Duration_Hrs float,
Job_Code_Id int
PRIMARY KEY(Cost_Allocation_Details_Id,Cost_Allocation_Id))

--VV 1-May-2009 CR8035
CREATE TABLE #z_PROJ_TASK_DOCUMENT(ProjTaskId int, WorkScopeDocumentId int PRIMARY KEY(ProjTaskId,WorkScopeDocumentId))

CREATE TABLE #Z_PROJ_TASK_EXTERNAL_DOCUMENT(ProjTaskId int, 
DocumentLink nvarchar(2000) COLLATE DATABASE_DEFAULT, DocumentName nvarchar(100) COLLATE DATABASE_DEFAULT)

INSERT INTO #z_PTFrom(
ProjTaskId,EqpPlanId,EqpProjId,ComponentCodeId,ModifierId,TaskTypeId,ApplicationCodeId,ManufacturerId,
UsageMethod,UsageQUOMId,[First],Frequency,Final,Unscheduled,Task_Header_Id,
Rotable_Part_Id,Group_Number,Part_Id,Planning_Task,Planning_Lead_Time,Schedule_Type_Id,Scheduling_Group_Id,
Scheduling_Group_Counter,Operational_Criticality_Id,Warranty_Period_Usage,Warranty_Period_Days,Maintenance_Strategy_Id,
Changeout_Guidelines,Task_Description,InspectionTaskTypeId,InspectionOffset,PerformanceStrategyReason,
RCMComponentStructureId,ParentTaskId,AutomaticUpdate,
/*VV CR8109*/
LastOcc,LastOccDate,PlanUseCalc,PlanStatus,NextOcc,NextOccDate,ReviewStatusID,ReviewUserID,ReviewDate,Projection_Type_Id,
AMT_WO_Last_Occ, AMT_WO_Last_Occ_Date,/*VV CR9019*/CBDTask,/*VV E316*/PartRatingId,/*GW*/AutoGenerateWOS,
/*E781*/ PartClassificationId, DefaultLocationForRebuild)
SELECT
PT.ProjTaskId, PT.EqpPlanId, PT.EqpProjId, PT.ComponentCodeId, PT.ModifierId, PT.TaskTypeId, PT.ApplicationCodeId, PT.ManufacturerId, 
PT.UsageMethod, PT.UsageQUOMId, PT.[First], PT.Frequency, PT.Final, PT.Unscheduled, PT.Task_Header_Id, 
PT.Rotable_Part_Id, 
PT.Group_Number, PT.Part_Id, PT.Planning_Task, PT.Planning_Lead_Time, 
PT.Schedule_Type_Id, PT.Scheduling_Group_Id,PT.Scheduling_Group_Counter, 

PT.Operational_Criticality_Id, PT.Warranty_Period_Usage, PT.Warranty_Period_Days, 
PT.Maintenance_Strategy_Id, PT.Changeout_Guidelines, PT.Task_Description, 

PT.InspectionTaskTypeId, PT.InspectionOffset, 

PT.PerformanceStrategyReason, 
PT.RCMComponentStructureId, 
/*if it is a RR task copied without the parent make it an ordinary task*/
NULL AS ParentTaskId, 0 AS AutomaticUpdate,
/*VV CR8109*/
PT.LastOcc,PT.LastOccDate,PT.PlanUseCalc,PT.PlanStatus,PT.NextOcc,PT.NextOccDate,PT.ReviewStatusID,
PT.ReviewUserID,PT.ReviewDate, EPR.Projection_Type_Id,
PT.AMT_WO_Last_Occ, PT.AMT_WO_Last_Occ_Date,/*VV CR9019*/PT.CBDTask,/*VV E316*/PT.PartRatingId,/*GW*/PT.AutoGenerateWOS,
/*E781*/ PT.PartClassificationId, PT.DefaultLocationForRebuild
FROM
tblProjTasks PT
	INNER JOIN
tblEqpProjs EPR
	ON PT.EqpProjId=EPR.EqpProjId
WHERE PT.EqpPlanId=@fromEqpPlanId AND 
EPR.Projection_Header_Id=@fromEqpProjHeaderId AND 
PT.Task_Header_Id=@fromProjTaskHeaderId



--Insert the child task
INSERT INTO #z_PTFrom(
ProjTaskId,EqpPlanId,EqpProjId,ComponentCodeId,ModifierId,TaskTypeId,ApplicationCodeId,ManufacturerId,
UsageMethod,UsageQUOMId,[First],Frequency,Final,Unscheduled,Task_Header_Id,
Rotable_Part_Id,Group_Number,Part_Id,Planning_Task,Planning_Lead_Time,Schedule_Type_Id,Scheduling_Group_Id,
Scheduling_Group_Counter,Operational_Criticality_Id,Warranty_Period_Usage,Warranty_Period_Days,Maintenance_Strategy_Id,
Changeout_Guidelines,Task_Description,InspectionTaskTypeId,InspectionOffset,PerformanceStrategyReason,
RCMComponentStructureId,ParentTaskId,AutomaticUpdate,
/*VV CR8109*/
LastOcc,LastOccDate,PlanUseCalc,PlanStatus,NextOcc,NextOccDate,ReviewStatusID,ReviewUserID,ReviewDate,
Projection_Type_Id,/*VV CR9019*/CBDTask,/*VV E316*/PartRatingId,/*GW*/AutoGenerateWOS,
/*E781*/ PartClassificationId, DefaultLocationForRebuild)
SELECT
PT.ProjTaskId, PT.EqpPlanId, PT.EqpProjId, PT.ComponentCodeId, PT.ModifierId, PT.TaskTypeId, PT.ApplicationCodeId, PT.ManufacturerId, 
PT.UsageMethod, PT.UsageQUOMId, PT.[First], PT.Frequency, PT.Final, PT.Unscheduled, PT.Task_Header_Id, 
PT.Rotable_Part_Id, 
PT.Group_Number, PT.Part_Id, PT.Planning_Task, PT.Planning_Lead_Time, 
PT.Schedule_Type_Id, PT.Scheduling_Group_Id,PT.Scheduling_Group_Counter, 

PT.Operational_Criticality_Id, PT.Warranty_Period_Usage, PT.Warranty_Period_Days, 
PT.Maintenance_Strategy_Id, PT.Changeout_Guidelines, PT.Task_Description, 

PT.InspectionTaskTypeId, PT.InspectionOffset, 

PT.PerformanceStrategyReason, 
PT.RCMComponentStructureId, 
PT.ParentTaskId, PT.AutomaticUpdate,
/*VV CR8109*/
PT.LastOcc,PT.LastOccDate,PT.PlanUseCalc,PT.PlanStatus,PT.NextOcc,PT.NextOccDate,PT.ReviewStatusID,
PT.ReviewUserID,PT.ReviewDate,ParentT.Projection_Type_Id,/*VV CR9019*/PT.CBDTask,/*VV E316*/PT.PartRatingId,/*GW*/PT.AutoGenerateWOS,
/*E781*/ PT.PartClassificationId, PT.DefaultLocationForRebuild
FROM
tblProjTasks PT
	INNER JOIN
#z_PTFrom ParentT
	ON PT.ParentTaskId=ParentT.ProjTaskId



--VV 1-May-2009 CR8035
INSERT INTO #z_PROJ_TASK_DOCUMENT(ProjTaskId, WorkScopeDocumentId)
SELECT PTD.ProjTaskId, PTD.WorkScopeDocumentId
FROM
#z_PTFrom PT
	INNER JOIN
PROJ_TASK_DOCUMENT PTD
	ON PT.ProjTaskId=PTD.ProjTaskId

INSERT INTO #z_PROJ_TASK_EXTERNAL_DOCUMENT(ProjTaskId, DocumentLink, DocumentName)
SELECT PTD.ProjTaskId, PTD.DocumentLink, PTD.DocumentName
FROM
#z_PTFrom PT
	INNER JOIN
PROJ_TASK_EXTERNAL_DOCUMENT PTD
	ON PT.ProjTaskId=PTD.ProjTaskId

INSERT INTO #z_PTOFrom(
ProjTaskOptId,ProjTaskId,OccurrenceTypeId,ProjTaskOpt,Probability,PlannedOption,[First],Frequency)
SELECT
PTO.ProjTaskOptId,PTO.ProjTaskId,PTO.OccurrenceTypeId,PTO.ProjTaskOpt,PTO.Probability,PTO.PlannedOption,
PTO.[First],PTO.Frequency
FROM
tblProjTaskOpts PTO
	INNER JOIN
#z_PTFrom PT
	ON PTO.ProjTaskId=PT.ProjTaskId


INSERT INTO #z_PTAFrom(
ProjTaskAmtId,ProjTaskOptId,PricedJobId,JobCodeId,PerformedAtSiteId,LaborShare,
PartTypeId,CurrencyId,LaborCost,PartsCost,MiscCost,Duration,Rotable_Repair_Strategy,
Action_Required_Id,Rebuild_Location_Id,Pricing_Date,Labour_Activity_Id,Misc_Cost_Expense_ID,
Labour_Cost_Expense_ID,Cost_Bearer_ID,Parts_Cost_Expense_ID,Crane_Cost,Pct_Freight,
Avg_Daily_Work_Hrs,Avg_No_People,Avg_Travel_Hrs,Travel_Distance,Travel_Recovery_Rate_L,
Misc_Trip_Cost,LaborHours,Labour_Hrs_Field,Travel_Recovery_Rate_V,Parts_EDC_ID,
Labour_EDC_ID,Misc_EDC_ID,Cost_Centre_ID,Work_Group_Id,Health_Safety_Id,
QtyVolume,PercentTopUp,UnitPrice,Consumable,StdJobId,StdJobModelId,StdJobPartsMargin)
SELECT
PTA.ProjTaskAmtId,PTA.ProjTaskOptId,PTA.PricedJobId,PTA.JobCodeId,PTA.PerformedAtSiteId,PTA.LaborShare,
PTA.PartTypeId,PTA.CurrencyId,PTA.LaborCost,PTA.PartsCost,PTA.MiscCost,PTA.Duration,PTA.Rotable_Repair_Strategy,
PTA.Action_Required_Id,PTA.Rebuild_Location_Id,PTA.Pricing_Date,PTA.Labour_Activity_Id,PTA.Misc_Cost_Expense_ID,
PTA.Labour_Cost_Expense_ID,PTA.Cost_Bearer_ID,PTA.Parts_Cost_Expense_ID,PTA.Crane_Cost,PTA.Pct_Freight,
PTA.Avg_Daily_Work_Hrs,PTA.Avg_No_People,PTA.Avg_Travel_Hrs,PTA.Travel_Distance,PTA.Travel_Recovery_Rate_L,
PTA.Misc_Trip_Cost,PTA.LaborHours,PTA.Labour_Hrs_Field,PTA.Travel_Recovery_Rate_V,PTA.Parts_EDC_ID,
PTA.Labour_EDC_ID,PTA.Misc_EDC_ID,PTA.Cost_Centre_ID,PTA.Work_Group_Id,PTA.Health_Safety_Id,
PTA.QtyVolume,PTA.PercentTopUp,PTA.UnitPrice,PTA.Consumable,
CASE @KeepLinkToStdJob WHEN 1 THEN PJ.StdJobId ELSE NULL END AS StdJobId,
CASE @KeepLinkToStdJob WHEN 1 THEN SJ.ModelId ELSE NULL END AS StdJobModelId,
CASE @KeepLinkToStdJob WHEN 1 THEN PTA.StdJobPartsMargin ELSE NULL END AS StdJobPartsMargin

FROM
tblProjTaskAmts PTA
	INNER JOIN
#z_PTOFrom PTO
	ON PTA.ProjTaskOptId=PTO.ProjTaskOptId
	LEFT JOIN
tblPricedJobs PJ
	ON PTA.PricedJobId=PJ.PricedJobId
	LEFT JOIN
tblStdJobs SJ
	ON PJ.StdJobId=SJ.StdJobId
	

INSERT INTO #z_CAFrom(
Cost_Allocation_Id,Cost_Allocation_Ref,Currency_Id,System_Source_Id,Component_Code_Id,Model_Id,
Proj_Task_Amt_Id,Scheduling_Task_Id,Eqp_Plan_Id,ModifierId)
SELECT
CA.Cost_Allocation_Id,CA.Cost_Allocation_Ref,CA.Currency_Id,CA.System_Source_Id,CA.Component_Code_Id,CA.Model_Id,
CA.Proj_Task_Amt_Id,CA.Scheduling_Task_Id,CA.Eqp_Plan_Id,CA.ModifierId
FROM
COST_ALLOCATION CA
	INNER JOIN
#z_PTAFrom PTA
	ON CA.Proj_Task_Amt_Id=PTA.ProjTaskAmtId

INSERT INTO #z_CADFrom(
Cost_Allocation_Details_Id,Cost_Allocation_Id,Work_Group_Id,Cost_Centre_Id,Parts_Cost_Expense_Id,
Labour_Cost_Expense_Id,Misc_Cost_Expense_Id,Cost_Bearer_Id,Parts_Cost,Misc_Cost,Labour_Cost,
Labour_Activity_Id,Labour_Hrs,Duration_Hrs,Job_Code_Id)

SELECT
CAD.Cost_Allocation_Details_Id,CAD.Cost_Allocation_Id,CAD.Work_Group_Id,CAD.Cost_Centre_Id,CAD.Parts_Cost_Expense_Id,
CAD.Labour_Cost_Expense_Id,CAD.Misc_Cost_Expense_Id,CAD.Cost_Bearer_Id,CAD.Parts_Cost,CAD.Misc_Cost,
CAD.Labour_Cost,CAD.Labour_Activity_Id,CAD.Labour_Hrs,CAD.Duration_Hrs,CAD.Job_Code_Id
FROM
COST_ALLOCATION_DETAIL CAD
	INNER JOIN
#z_CAFrom CA
	ON CAD.Cost_Allocation_Id=CA.Cost_Allocation_Id

--Update First and frequency from the options
UPDATE PT SET PT.First=PTO.First, PT.Frequency=PTO.Frequency FROM
#z_PTFrom PT
	INNER JOIN
#z_PTOFrom PTO
	ON PT.ProjTaskId=PTO.ProjTaskId


CREATE TABLE #z_EqpTo(ListId int IDENTITY(1,1),EqpPlanId int,EqpProjId int,ModelId int,
Pricing_Date datetime,ProjTaskIdFrom int, ProjTaskId int,
ProjTaskIdUpdate int,Task_Header_Id int,
SiteId int,BranchId int,FleetId int,Price_Group_Id int,
Rotable_Part_Id int,StartDate datetime,CopyPerfStrat bit,ManufacturerId int,Projection_Type_Id int,
CopyOccData bit
PRIMARY KEY (ListId,EqpPlanId,EqpProjId))

INSERT INTO #z_EqpTo(EqpPlanId,EqpProjId,ModelId,Task_Header_Id,
SiteId,BranchId,FleetId,Price_Group_Id,Rotable_Part_Id,Pricing_Date,
StartDate,ProjTaskIdFrom,CopyPerfStrat,Projection_Type_Id,CopyOccData)
SELECT EP.EqpPlanId,EPR.EqpProjId,E.ModelId,PT.Task_Header_Id,
S.SiteId,S.BranchId,EP.FleetId,F.Price_Group_Id,Rotable_Part_Id,
CASE WHEN EPR.Projection_Type_Id IN(@ProjTypeBud,@ProjTypeEstC,@ProjTypeEstD) THEN EPR.Pricing_Date
/*For the other projections if the prices are escalated they are escalated to the current date */
WHEN @Esc_Desc_Prices=1 THEN @CurrDate ELSE NULL END AS Pricing_Date,
EP.StartDate,PT.ProjTaskId AS ProjTaskIdFrom,0 AS CopyPerfStrat,EPR.Projection_Type_Id,
CASE 
WHEN EP.EqpPlanId=PT.EqpPlanId AND PT.Projection_Type_Id=@ProjTypeCurr AND EPR.Projection_Type_Id=@ProjTypeAlt
THEN 1 ELSE 0 END AS CopyOccData
FROM
tblEquipment E
	INNER JOIN
tblEqpPlans EP
	ON E.EquipmentId=EP.EquipmentId
	INNER JOIN
dbo.LIST_TO_TABLE_F(@toEqpPlanId) LTT
	ON EP.EqpPlanId=LTT.list_item
	INNER JOIN
tblEqpProjs EPR
	ON EP.EqpPlanId=EPR.EqpPlanId
	INNER JOIN
tblFleets F
	ON EP.FleetId=F.FleetId
	INNER JOIN
tblSites S
	ON F.SiteId=S.SiteId
	CROSS JOIN
#z_PTFrom PT
WHERE EPR.Projection_Header_Id=@toEqpProjHeaderId AND EPR.Projection_Type_Id<>@ProjTypeArch
--VV 6-Nov-2008
AND (PT.EqpProjId<>EPR.EqpProjId)


/*VV #721*/
--Find out the parent tasks which need to be updated  
UPDATE E SET E.ProjTaskId=PT.ProjTaskId,E.ProjTaskIdUpdate=PT.ProjTaskId,  
CopyPerfStrat=@CopyPerfStrat,E.ManufacturerId=PT.ManufacturerId  
FROM  
#z_EqpTo E  
INNER JOIN  
tblProjTasks PT  
ON E.EqpProjId=PT.EqpProjId AND  
 E.Task_Header_Id=PT.Task_Header_Id  
WHERE E.Task_Header_Id=@fromProjTaskHeaderId AND PT.ParentTaskId IS NULL  
   
IF @overwrite=0 
BEGIN  
	DELETE #z_EqpTo WHERE ProjTaskId>0
END  
/**************************
	Check the business rules

******************************/
CREATE TABLE #z_Message(EqpProjId int,Msg varchar(1000))
INSERT INTO #z_Message(EqpProjId,Msg)

SELECT PT.EqpProjId, 
dbo.PROJ_TASK_BUSINESS_RULES_F
(PT.EqpProjId,
NULL/*@ComponentCodeId*/,
PT.ModifierId,
PT.TaskTypeId,
PT.ApplicationCodeId,	
PTF.Schedule_Type_Id, 
CASE WHEN PTF.Planning_Task= 0 THEN NULL
		WHEN PT.ParentTaskId>0 OR @supDepOption=0 THEN PT.Scheduling_Group_Id 
		ELSE PTF.Scheduling_Group_Id END /*Scheduling_Group_Id*/,  
CASE WHEN PTF.Planning_Task = 0 THEN NULL
		WHEN PT.ParentTaskId>0 OR @supDepOption= 0 THEN PT.Scheduling_Group_Counter 
		ELSE PTF.Scheduling_Group_Counter END/*Scheduling_Group_Counter*/, 
PTF.UsageQUOMId,
PT.ProjTaskId,
CASE WHEN ISNULL(PT.UsageQUOMId,0)=ISNULL(PTF.UsageQUOMId,0) THEN PT.Last_Change_Date ELSE E.StartDate END/*@LastChangeDate*/,
CASE WHEN ISNULL(PT.UsageQUOMId,0)=ISNULL(PTF.UsageQUOMId,0) THEN PT.Last_Change_Usage ELSE 0 END/*@LastChangeUsage*/,
CASE WHEN PTF.Planning_Task = 0 THEN NULL
		WHEN PT.ParentTaskId>0 OR @supDepOption=0 THEN PT.InspectionTaskTypeId 
		ELSE PTF.InspectionTaskTypeId END/*InspectionTaskTypeId*/,
CASE WHEN PTF.Planning_Task = 0 THEN 0
						WHEN PT.ParentTaskId>0 OR @supDepOption=0 THEN PT.InspectionOffset 
						ELSE PTF.InspectionOffset END/*@InspectionOffset*/,
PTF.Planning_Task,
PTF.ParentTaskId,
PTF.Frequency,
E.StartDate,
1/*@CheckGroup*/,
''/*@ExternalIdentifier do not check because it will be deleted or not updated*/)


FROM
#z_EqpTo E
	INNER JOIN
tblProjTasks PT
	ON E.ProjTaskId=PT.ProjTaskId AND E.EqpProjId=PT.EqpProjId
	INNER JOIN
#z_PTFrom PTF
	ON E.ProjTaskIdFrom=PTF.ProjTaskId
	WHERE PTF.ParentTaskId IS NULL

/*--VV Debug
drop table z_EqpTo,z_PTFrom,z_PTOFrom,z_PTAFrom,z_CAFrom,z_CADFrom
select * into z_EqpTo from #z_EqpTo
select * into z_PTFrom from #z_PTFrom
select * into z_PTOFrom from #z_PTOFrom
select * into z_PTAFrom from #z_PTAFrom
select * into z_CAFrom from #z_CAFrom
select * into z_CADFrom from #z_CADFrom*/

/*drop table z_Message1
select * into z_Message1 from #z_Message*/



SELECT @errorMsg=@errorMsg+EP.EqpPlan+' : '+EPR.EqpProjName+': '+Msg+'
' FROM 
tblEqpPlans EP
	INNER JOIN
tblEqpProjs EPR
	ON EP.EqpPlanId=EPR.EqpPlanId
	INNER JOIN
#z_Message M
	ON M.EqpProjId=EPR.EqpProjId
WHERE Msg<>''
IF @errorMsg<>'' RETURN



TRUNCATE TABLE #z_Message

INSERT INTO #z_Message(EqpProjId,Msg)
SELECT A.EqpProjIdTo,dbo.PROJ_TASK_COPY_OVERWRITE_BUSINESS_RULES_F(
	A.EqpProjIdTo,
	A.Schedule_Type_Id, 
	A.Scheduling_Group_Id, 
	A.Scheduling_Group_Counter, 
	A.UsageQUOMId,
	0 /*ProjTaskId*/,A.InspectionTaskTypeId,A.Frequency)
FROM
(SELECT PTF.*,E.EqpProjId AS EqpProjIdTo FROM
#z_PTFrom PTF
	INNER JOIN
#z_EqpTo E
	ON PTF.ProjTaskId=E.ProjTaskIdFrom
	WHERE PTF.ParentTaskId IS NULL AND E.ProjTaskIdUpdate IS NULL) A
	LEFT JOIN
tblProjTasks PT
	ON A.EqpProjIdTo=PT.EqpProjId AND 
	   A.Task_Header_Id=PT.Task_Header_Id
WHERE PT.Task_Header_Id IS NULL

/*drop table z_Message2
select * into z_Message2 from #z_Message*/

SELECT @errorMsg=@errorMsg+EP.EqpPlan+' : '+EPR.EqpProjName+': '+Msg+'
' FROM 
tblEqpPlans EP
	INNER JOIN
tblEqpProjs EPR
	ON EP.EqpPlanId=EPR.EqpPlanId
	INNER JOIN
#z_Message M
	ON M.EqpProjId=EPR.EqpProjId
WHERE Msg<>''

IF @errorMsg<>'' RETURN

DROP TABLE #z_Message


/*--VV Debug
drop table z_EqpTo,z_PTFrom,z_PTOFrom,z_PTAFrom,z_CAFrom,z_CADFrom
select * into z_EqpTo from #z_EqpTo
select * into z_PTFrom from #z_PTFrom
select * into z_PTOFrom from #z_PTOFrom
select * into z_PTAFrom from #z_PTAFrom
select * into z_CAFrom from #z_CAFrom
select * into z_CADFrom from #z_CADFrom

return*/



--Before the parents are updated, delete the children RR tasks
IF EXISTS(Select ProjTaskId FROM #z_EqpTo WHERE ProjTaskId>0)
BEGIN
	--Delete linked RR tasks
	IF EXISTS(SELECT PT.ProjTaskId FROM 
			tblProjTasks PT
				INNER JOIN
			#z_EqpTo E
				ON PT.ParentTaskId=E.ProjTaskId
			WHERE E.CopyPerfStrat=1)
	BEGIN
		
		SET @Id=''

		SELECT @Id=@Id+CAST(A.EqpPlanId AS varchar)+','
		FROM
		(SELECT DISTINCT EqpPlanId FROM #z_EqpTo WHERE CopyPerfStrat=1) A

		IF @Id<>'' SET @Id=LEFT(@Id,LEN(@Id)-1)

		EXEC TASK_DELETE_MULTI_EQP @eqpPlanID=@toEqpPlanId,
				@EqpProjHeaderId=@toEqpProjHeaderId,
				@ProjTaskHeaderId =@fromProjTaskHeaderId,/*RR tasks are the children of the tasks with source task header*/
				@EquipmentTypeId='',
				@FleetId = @toFleetId,
				@forceDelete = 0,
				@Message =@errorMsg OUTPUT,
				@DeleteRRTasksOnly=1

		SET @errorMsg=ISNULL(@errorMsg,'')

		IF @errorMsg<>'' RETURN
	END
	
	
	--Update projected tasks
	UPDATE PT SET
	PT.ManufacturerId=PTF.ManufacturerId,
	PT.Frequency=PTF.Frequency,
	PT.Final=PTF.Final,

	/*Depend on QUOM changes*/
	PT.First= CASE @firstOccOption 
			  WHEN @firstFromSource THEN PTF.First
			  WHEN @firstFromLastChange THEN
					CASE 
					WHEN ISNULL(PT.UsageQUOMId,0)=ISNULL(PTF.UsageQUOMId,0) AND 
						 PT.Last_Change_Usage<>0 AND (PT.Last_Change_Usage+PTF.Frequency)>0/*For the date based tasks last change usage is negative*/
					THEN (PT.Last_Change_Usage+PTF.Frequency)
					ELSE PTF.First END
			 ELSE PTO.First END,

	PT.Last_Change_Usage=CASE WHEN ISNULL(PT.UsageQUOMId,0)=ISNULL(PTF.UsageQUOMId,0) THEN PT.Last_Change_Usage ELSE 0 END,
	PT.Last_Change_Date=CASE WHEN ISNULL(PT.UsageQUOMId,0)=ISNULL(PTF.UsageQUOMId,0) THEN PT.Last_Change_Date ELSE E.StartDate END,

	/*VV CR8109*/

	PT.PlanStatus=CASE E.CopyOccData WHEN 1 THEN PTF.PlanStatus ELSE	
					  CASE WHEN PTF.Planning_Task=0 THEN 0/*Do not set plan status for non-planning tasks*/
					   /*If QUOM changes and it is a planning task - set plan status to date-based if it was the 
						usage-based and leave review status/user/date */
					   WHEN (ISNULL(PT.UsageQUOMId,0)!=ISNULL(PTF.UsageQUOMId,0)) AND PT.PlanStatus=@PlanStatusUsage THEN @PlanStatusDate 
					   ELSE PT.PlanStatus END
				   END,
	PT.PlanUseCalc=CASE E.CopyOccData WHEN 1 THEN PTF.PlanUseCalc ELSE 
						CASE PTF.Planning_Task WHEN 0 THEN 1 ELSE PT.PlanUseCalc END
					END,
	
	PT.ReviewStatusID= CASE E.CopyOccData WHEN 1 THEN PTF.ReviewStatusID ELSE 
						CASE PTF.Planning_Task WHEN 0 THEN 1 ELSE PT.ReviewStatusID END
					  END,
	PT.ReviewUserID=CASE E.CopyOccData WHEN 1 THEN PTF.ReviewUserID ELSE 
						CASE PTF.Planning_Task WHEN 0 THEN NULL ELSE PT.ReviewUserID END
					END,
	PT.ReviewDate=CASE E.CopyOccData WHEN 1 THEN PTF.ReviewDate ELSE 
					CASE PTF.Planning_Task WHEN 0 THEN NULL ELSE PT.ReviewDate END
				  END,

	/*Scheduling task*/
	PT.ExternalIdentifier=CASE WHEN ISNULL(PT.UsageQUOMId,0)<>ISNULL(PTF.UsageQUOMId,0) AND 
								PT.SchedulingTaskId>0 THEN NULL/*The scheduling task will be unlinked*/
								ELSE PT.ExternalIdentifier END,
	PT.SchedulingTaskId=CASE WHEN ISNULL(PT.UsageQUOMId,0)=ISNULL(PTF.UsageQUOMId,0) THEN PT.SchedulingTaskId ELSE NULL END,

	PT.UsageMethod=PTF.UsageMethod,
	PT.UsageQUOMId=PTF.UsageQUOMId,

	PT.LastModifiedDate=@CurrDate,
	
	/*Rotables*/
	PT.Part_Id=CASE @rotPartOption
				WHEN 1 THEN /*Overwrite rotables*/
					CASE WHEN RPM.Rotable_Part_Id>0 THEN NULL /*Rotable will be set from the source task*/
					     ELSE PTF.Part_Id END/*Source task does not have rotable or rotable does not match the model*/
				WHEN 0 THEN /*Do not overwrite the rotable*/
					CASE WHEN PT.Rotable_Part_Id>0 THEN PT.Part_Id /*The destination task has a rotable linked but we don't update part*/
						 WHEN PTF.Rotable_Part_Id>0 THEN PT.Part_Id/*We do not update part details if source has rotable*/
						 ELSE PTF.Part_Id END/*The destination and the source tasks do not have rotable, overwrite the part*/
				END,

	PT.Rotable_Part_Id=CASE WHEN @rotPartOption=1 THEN RPM.Rotable_Part_Id ELSE PT.Rotable_Part_Id END,

	PT.Group_Number=CASE @rotPartOption
					WHEN 1 THEN /*Overwrite rotables*/
						CASE WHEN RPM.Rotable_Part_Id>0 THEN PT.Group_Number/*Rotable will be set from the source task*/
							 ELSE PTF.Group_Number END/*Source task does not have rotable or rotable does not match the model*/
					WHEN 0 THEN /*Do not overwrite the rotable*/
						CASE WHEN PT.Rotable_Part_Id>0 THEN PT.Group_Number/*The destination task has a rotable linked but we don't update part*/
							 WHEN PTF.Rotable_Part_Id>0 THEN PT.Group_Number/*We do not update part details if source has rotable*/
							 ELSE PTF.Group_Number END/*The destination and the source tasks do not have rotable, overwrite the part*/
					END,

	PT.Planning_Task=PTF.Planning_Task,
	PT.Planning_Lead_Time=PTF.Planning_Lead_Time,		
	PT.Schedule_Type_Id=PTF.Schedule_Type_Id,

	/*Advanced scheduling logic*/
	PT.Scheduling_Group_Id=CASE WHEN PTF.Planning_Task= 0 THEN NULL
							WHEN PT.ParentTaskId>0 OR @supDepOption=0 THEN PT.Scheduling_Group_Id 
							ELSE PTF.Scheduling_Group_Id END,
	PT.Scheduling_Group_Counter=CASE WHEN PTF.Planning_Task = 0 THEN NULL
								WHEN PT.ParentTaskId>0 OR @supDepOption= 0 THEN PT.Scheduling_Group_Counter 
								ELSE PTF.Scheduling_Group_Counter END,
	PT.InspectionTaskTypeId=CASE WHEN PTF.Planning_Task = 0 THEN NULL
							WHEN PT.ParentTaskId>0 OR @supDepOption=0 THEN PT.InspectionTaskTypeId 
							ELSE PTF.InspectionTaskTypeId END,
	PT.InspectionOffset=CASE WHEN PTF.Planning_Task = 0 THEN 0
						WHEN PT.ParentTaskId>0 OR @supDepOption=0 THEN PT.InspectionOffset 
						ELSE PTF.InspectionOffset END,


	PT.Operational_Criticality_Id=PTF.Operational_Criticality_Id,
	PT.Warranty_Period_Usage=PTF.Warranty_Period_Usage,
	PT.Warranty_Period_Days=PTF.Warranty_Period_Days,
	
	PT.Task_Description=PTF.Task_Description,
	PT.Last_Mod_Date=@Currdate,	

	/*Strategy fields*/
	PT.Changeout_Guidelines=CASE @CopyPerfStrat WHEN 0 THEN PT.Changeout_Guidelines ELSE PTF.Changeout_Guidelines END,

	PT.PerformanceStrategyReason=CASE @CopyPerfStrat WHEN 0 THEN PT.PerformanceStrategyReason ELSE PTF.PerformanceStrategyReason END,

	/*CBM parent task and automatic update fields are not updated because this query updates the parent tasks only*/
	PT.RCMComponentStructureId=CASE @CopyPerfStrat WHEN 0 THEN PT.RCMComponentStructureId ELSE PTF.RCMComponentStructureId END,

	PT.Maintenance_Strategy_Id=CASE @CopyPerfStrat WHEN 0 THEN PT.Maintenance_Strategy_Id ELSE PTF.Maintenance_Strategy_Id END,

	/*calculated fields for strategy task manager*/
	PT.ProjPartsTotal=NULL,
	PT.ProjLaborTotal=NULL,
	PT.ProjMiscTotal=NULL,
	PT.ProjPartsTotalEsc=NULL,
	PT.ProjLaborTotalEsc=NULL,
	PT.ProjMiscTotalEsc=NULL,

	PT.PastOccNumber=CASE WHEN E.Projection_Type_Id IN(@ProjTypeCurr,@ProjTypeAlt) THEN PastOccNumber ELSE NULL END,
	PT.PastTotalSell=CASE WHEN E.Projection_Type_Id IN(@ProjTypeCurr,@ProjTypeAlt) THEN PastTotalSell ELSE NULL END,
	PT.PastTotalSellEsc=CASE WHEN E.Projection_Type_Id IN(@ProjTypeCurr,@ProjTypeAlt) THEN PastTotalSellEsc ELSE NULL END,
	PT.PastLabourHours=CASE WHEN E.Projection_Type_Id IN(@ProjTypeCurr,@ProjTypeAlt) THEN PastLabourHours ELSE NULL END,
	PT.PastDuration=CASE WHEN E.Projection_Type_Id IN(@ProjTypeCurr,@ProjTypeAlt) THEN PastDuration ELSE NULL END,

	PT.FutureOccNumber=NULL,
	PT.FuturePartsSell=NULL,
	PT.FutureLabourSell=NULL,
	PT.FutureMiscSell=NULL,
	PT.FuturePartsSellEsc=NULL,
	PT.FutureLabourSellEsc=NULL,
	PT.FutureMiscSellEsc=NULL,
	PT.FutureLabourHours=NULL,
	PT.FutureDuration=NULL,
	/*VV CR8109*/
	PT.LastOcc=CASE E.CopyOccData WHEN 1 THEN PTF.LastOcc ELSE PT.LastOcc END,
	PT.LastOccDate=CASE E.CopyOccData WHEN 1 THEN PTF.LastOccDate ELSE PT.LastOccDate END,
	PT.NextOcc=CASE E.CopyOccData WHEN 1 THEN PTF.NextOcc ELSE PT.NextOcc END,
	PT.NextOccDate=CASE E.CopyOccData WHEN 1 THEN PTF.NextOccDate ELSE PT.NextOccDate END,	
	PT.AMT_WO_Last_Occ=CASE E.CopyOccData WHEN 1 THEN PTF.AMT_WO_Last_Occ ELSE PT.AMT_WO_Last_Occ END,
	PT.AMT_WO_Last_Occ_Date=CASE E.CopyOccData WHEN 1 THEN PTF.AMT_WO_Last_Occ_Date ELSE PT.AMT_WO_Last_Occ_Date END,
	/*VV CR9019*/PT.CBDTask=PTF.CBDTask,
	/*VV E316*/PT.PartRatingId=PTF.PartRatingId,
	/*GW*/PT.AutoGenerateWOS=PTF.AutoGenerateWOS,
	/*E781*/ 
	PT.PartClassificationId=PTF.PartClassificationId,
	PT.DefaultLocationForRebuild=PTF.DefaultLocationForRebuild

	FROM
	#z_PTFrom PTF
		INNER JOIN
	#z_EqpTo E
		ON PTF.ProjTaskId=E.ProjTaskIdFrom
		INNER JOIN
	tblProjTasks PT
		ON E.ProjTaskId=PT.ProjTaskId
		INNER JOIN
	tblProjTaskOpts PTO
		ON PT.ProjTaskId=PTO.ProjTaskId
		LEFT JOIN
	ROTABLE_PART_MODEL RPM
		ON @CopyRotable=1 AND E.ModelId=RPM.Model_Id AND PTF.Rotable_Part_Id=RPM.Rotable_Part_Id

	--Update the projected tasks options
	UPDATE PTO SET
	PTO.OccurrenceTypeId=PTOF.OccurrenceTypeId, 
	PTO.Probability=PTOF.Probability, 
	PTO.PlannedOption=PTOF.PlannedOption, 
	PTO.First=PT.First, 
	PTO.Frequency=PT.Frequency
	FROM
	tblProjTasks PT
		INNER JOIN
	tblProjTaskOpts PTO
		ON PT.ProjTaskId=PTO.ProjTaskId
		INNER JOIN
	#z_EqpTo E
		ON E.ProjTaskId=PTO.ProjTaskId
		INNER JOIN
	#z_PTOFrom PTOF
		ON E.ProjTaskIdFrom=PTOF.ProjTaskId

	--Delete proj task amts and cost allocations

	--Delete cost allocations
	IF EXISTS(SELECT Cost_Allocation_Id FROM
		COST_ALLOCATION CA
			INNER JOIN
		tblProjTaskAmts PTA
			ON CA.Proj_Task_Amt_Id=PTA.ProjTaskAmtId
			INNER JOIN
		tblProjTaskOpts PTO 
			ON PTA.ProjTaskOptId = PTO.ProjTaskOptId
			INNER JOIN
		#z_EqpTo E
			ON E.ProjTaskId=PTO.ProjTaskId)
	BEGIN
		DELETE CAD FROM
		COST_ALLOCATION_DETAIL CAD
			INNER JOIN
		COST_ALLOCATION CA
			ON CAD.Cost_Allocation_Id=CA.Cost_Allocation_Id
			INNER JOIN
		tblProjTaskAmts PTA
			ON CA.Proj_Task_Amt_Id=PTA.ProjTaskAmtId
			INNER JOIN
		tblProjTaskOpts PTO 
			ON PTA.ProjTaskOptId = PTO.ProjTaskOptId
			INNER JOIN
		#z_EqpTo E
			ON E.ProjTaskId=PTO.ProjTaskId


		DELETE CA FROM
		COST_ALLOCATION CA
			INNER JOIN
		tblProjTaskAmts PTA
			ON CA.Proj_Task_Amt_Id=PTA.ProjTaskAmtId
			INNER JOIN
		tblProjTaskOpts PTO 
			ON PTA.ProjTaskOptId = PTO.ProjTaskOptId
			INNER JOIN
		#z_EqpTo E
			ON E.ProjTaskId=PTO.ProjTaskId
	END

	--ProjTaskAmts
	DELETE PTA FROM
	tblProjTaskAmts PTA
		INNER JOIN
	tblProjTaskOpts PTO 
		ON PTA.ProjTaskOptId = PTO.ProjTaskOptId
		INNER JOIN
	#z_EqpTo E
		ON E.ProjTaskId=PTO.ProjTaskId

	-- VV 1-May-2009 CR8035 Delete the library links
	DELETE PTD FROM
	PROJ_TASK_DOCUMENT PTD
		INNER JOIN
	#z_EqpTo E
		ON E.ProjTaskId=PTD.ProjTaskId

	DELETE PTD FROM
	PROJ_TASK_EXTERNAL_DOCUMENT PTD
		INNER JOIN
	#z_EqpTo E
		ON E.ProjTaskId=PTD.ProjTaskId

END/*IF EXISTS(Select ProjTaskId FROM #z_EqpTo WHERE ProjTaskId>0)*/


-- Add new tasks. Add the parents first
INSERT INTO tblProjTasks(EqpPlanId,EqpProjId,ComponentCodeId,ModifierId,TaskTypeId,ApplicationCodeId,ManufacturerId,
UsageMethod,UsageQUOMId,[First],Frequency,Final,Unscheduled,Task_Header_Id,
Rotable_Part_Id,Group_Number,Part_Id,Planning_Task,Planning_Lead_Time,Schedule_Type_Id,Scheduling_Group_Id,
Scheduling_Group_Counter,Operational_Criticality_Id,Warranty_Period_Usage,Warranty_Period_Days,Maintenance_Strategy_Id,
Changeout_Guidelines,Task_Description,InspectionTaskTypeId,InspectionOffset,PerformanceStrategyReason,
RCMComponentStructureId,ParentTaskId,AutomaticUpdate,Create_Date,Last_Mod_Date,Last_Change_Usage,Last_Change_Date,
/*VV CR8109*/
LastOcc,LastOccDate,PlanUseCalc,PlanStatus,NextOcc,NextOccDate,ReviewStatusID,ReviewUserID,ReviewDate,
AMT_WO_Last_Occ, AMT_WO_Last_Occ_Date,/*VV CR9019*/CBDTask,/*VV E316*/PartRatingId,/*GW*/AutoGenerateWOS,
/*E781*/PartClassificationId, DefaultLocationForRebuild)

SELECT A.EqpPlanIdTo, A.EqpProjIdTo, A.ComponentCodeId, A.ModifierId, A.TaskTypeId, A.ApplicationCodeId, A.ManufacturerId, 
A.UsageMethod, A.UsageQUOMId, 
A.[First], A.Frequency, 
A.Final, A.Unscheduled, A.Task_Header_Id, 
RPM.Rotable_Part_Id, 
A.Group_Number, A.Part_Id, A.Planning_Task, A.Planning_Lead_Time, 
A.Schedule_Type_Id, 
A.Scheduling_Group_Id, 
A.Scheduling_Group_Counter, 
A.Operational_Criticality_Id, A.Warranty_Period_Usage, A.Warranty_Period_Days, A.Maintenance_Strategy_Id, 
A.Changeout_Guidelines, A.Task_Description, A.InspectionTaskTypeId, A.InspectionOffset, A.PerformanceStrategyReason, 
A.RCMComponentStructureId, NULL AS ParentTaskId, 0 AS AutomaticUpdate,@CurrDate AS Create_Date,@CurrDate AS Last_Mod_Date,
0 AS Last_Change_Usage,A.StartDate AS Last_Change_Date,
CASE A.CopyOccData WHEN 1 THEN A.LastOcc ELSE NULL END AS LastOcc,
CASE A.CopyOccData WHEN 1 THEN A.LastOccDate ELSE NULL END AS LastOccDate,
CASE A.CopyOccData WHEN 1 THEN A.PlanUseCalc ELSE 1 END AS PlanUseCalc,
CASE A.CopyOccData WHEN 1 THEN A.PlanStatus ELSE 0 END AS PlanStatus,
CASE A.CopyOccData WHEN 1 THEN A.NextOcc ELSE NULL END AS NextOcc,
CASE A.CopyOccData WHEN 1 THEN A.NextOccDate ELSE NULL END AS NextOccDate,
CASE A.CopyOccData WHEN 1 THEN A.ReviewStatusID ELSE 1 /*VV CR8774*/ END AS ReviewStatusID,
CASE A.CopyOccData WHEN 1 THEN A.ReviewUserID ELSE NULL END AS ReviewUserID,
CASE A.CopyOccData WHEN 1 THEN A.ReviewDate ELSE NULL END AS ReviewDate,
CASE A.CopyOccData WHEN 1 THEN A.AMT_WO_Last_Occ ELSE NULL END AS AMT_WO_Last_Occ,
CASE A.CopyOccData WHEN 1 THEN A.AMT_WO_Last_Occ_Date ELSE NULL END AS AMT_WO_Last_Occ_Date,
/*VV CR9019*/A.CBDTask,/*VV E316*/A.PartRatingId,/*GW*/A.AutoGenerateWOS,
/*E781*/A.PartClassificationId, A.DefaultLocationForRebuild
FROM
(SELECT PT.*,E.ModelId,E.StartDate,E.EqpProjId AS EqpProjIdTo,E.EqpPlanId AS EqpPlanIdTo,E.CopyOccData
FROM
#z_PTFrom PT
	INNER JOIN
#z_EqpTo E
	ON PT.ProjTaskId=E.ProjTaskIdFrom
	WHERE PT.ParentTaskId IS NULL AND E.ProjTaskIdUpdate IS NULL) A
	LEFT JOIN
tblProjTasks PT
	ON A.EqpProjIdTo=PT.EqpProjId AND 
	   A.Task_Header_Id=PT.Task_Header_Id
	LEFT JOIN
ROTABLE_PART_MODEL RPM
	ON @CopyRotable=1 AND A.ModelId=RPM.Model_Id AND A.Rotable_Part_Id=RPM.Rotable_Part_Id
WHERE PT.Task_Header_Id IS NULL


IF @@RowCount>0 
BEGIN
	--get the new proj tasks id
	UPDATE E SET E.ProjTaskId=PT.ProjTaskId,E.Rotable_Part_Id=PT.Rotable_Part_Id,E.ManufacturerId=PT.ManufacturerId,
	CopyPerfStrat=@CopyPerfStrat
	FROM
	tblProjTasks PT
		INNER JOIN
	#z_EqpTo E
		ON PT.EqpProjId=E.EqpProjId AND PT.Task_Header_Id=E.Task_Header_Id
	WHERE (E.ProjTaskIdUpdate IS NULL) /*VV #672 AND PT.Last_Mod_Date=@CurrDate*/
END


--Add children RR tasks if required
IF EXISTS(SELECT RR.ParentTaskId FROM 
	#z_PTFrom PT
		INNER JOIN
	#z_EqpTo E
		ON PT.ProjTaskId=E.ProjTaskIdFrom
		INNER JOIN
	#z_PTFrom RR
		ON PT.ProjTaskId=RR.ParentTaskId
	WHERE E.ProjTaskId>0 AND E.CopyPerfStrat=1)
BEGIN
	INSERT INTO tblProjTasks(EqpPlanId,EqpProjId,ComponentCodeId,ModifierId,TaskTypeId,ApplicationCodeId,ManufacturerId,
	UsageMethod,UsageQUOMId,[First],Frequency,Final,Unscheduled,Task_Header_Id,
	Rotable_Part_Id,Group_Number,Part_Id,Planning_Task,Planning_Lead_Time,Schedule_Type_Id,Scheduling_Group_Id,
	Scheduling_Group_Counter,Operational_Criticality_Id,Warranty_Period_Usage,Warranty_Period_Days,Maintenance_Strategy_Id,
	Changeout_Guidelines,Task_Description,InspectionTaskTypeId,InspectionOffset,PerformanceStrategyReason,
	RCMComponentStructureId,ParentTaskId,AutomaticUpdate,Create_Date,Last_Mod_Date,Last_Change_Usage,
	Last_Change_Date,AMT_WO_Last_Occ, AMT_WO_Last_Occ_Date,/*VV CR9019*/CBDTask,/*VV E316*/PartRatingId,/*GW*/AutoGenerateWOS,
	/*E781*/PartClassificationId, DefaultLocationForRebuild)

	SELECT A.EqpPlanIdTo, A.EqpProjIdTo, A.ComponentCodeId, A.ModifierId, A.TaskTypeId, A.ApplicationCodeId, A.ManufacturerId, 
	A.UsageMethod, A.UsageQUOMId, 
	A.[First], A.Frequency, 
	A.Final,A.Unscheduled, A.Task_Header_Id, 
	NULL AS Rotable_Part_Id, 
	A.Group_Number, A.Part_Id, A.Planning_Task, A.Planning_Lead_Time, 
	A.Schedule_Type_Id, 
	A.Scheduling_Group_Id, 
	A.Scheduling_Group_Counter, 
	A.Operational_Criticality_Id, A.Warranty_Period_Usage, A.Warranty_Period_Days, A.Maintenance_Strategy_Id, 
	A.Changeout_Guidelines, A.Task_Description, A.InspectionTaskTypeId, A.InspectionOffset, A.PerformanceStrategyReason, 
	A.RCMComponentStructureId, A.NewParentTaskId AS ParentTaskId, A.AutomaticUpdate,@CurrDate AS Create_Date,@CurrDate AS Last_Mod_Date,
	0 AS Last_Change_Usage,A.StartDate AS Last_Change_Date,
	A.AMT_WO_Last_Occ, A.AMT_WO_Last_Occ_Date,/*VV CR9019*/A.CBDTask,/*VV E316*/A.PartRatingId,/*GW*/A.AutoGenerateWOS,
	/*E781*/A.PartClassificationId, A.DefaultLocationForRebuild
	FROM
	(/*Add RR tasks for the tasks which has been updated and inserted*/
	SELECT RR.*,ERR.ModelId,ERR.StartDate,E.ProjTaskId AS NewParentTaskId,ERR.EqpProjId AS EqpProjIdTo,
	E.EqpPlanId AS EqpPlanIdTo
	FROM
	#z_PTFrom RR
		INNER JOIN
	#z_EqpTo ERR
		ON RR.ProjTaskId=ERR.ProjTaskIdFrom
		INNER JOIN
	#z_EqpTo E
		ON RR.ParentTaskId=E.ProjTaskIdFrom AND ERR.EqpProjId=E.EqpProjId
	WHERE E.ProjTaskId>0 AND E.CopyPerfStrat=1
	) A
		LEFT JOIN
	tblProjTasks PT
		ON A.EqpProjIdTo=PT.EqpProjId AND 
		   A.Task_Header_Id=PT.Task_Header_Id
	WHERE PT.Task_Header_Id IS NULL


	IF @@ROWCOUNT>0 
	BEGIN
		--get the new proj tasks id
		UPDATE E SET E.ProjTaskId=PT.ProjTaskId,E.Rotable_Part_Id=PT.Rotable_Part_Id,
		E.ManufacturerId=PT.ManufacturerId
		FROM
		tblProjTasks PT
			INNER JOIN
		#z_EqpTo E
			ON PT.EqpProjId=E.EqpProjId AND PT.Task_Header_Id=E.Task_Header_Id
		WHERE E.ProjTaskIdUpdate IS NULL /*#672 AND PT.Last_Mod_Date=@CurrDate*/
	END
END --Add chilren RR tasks if required

/*--VV Debug
drop table z_EqpTo,z_PTFrom,z_PTOFrom,z_PTAFrom,z_CAFrom,z_CADFrom
select * into z_EqpTo from #z_EqpTo
select * into z_PTFrom from #z_PTFrom
select * into z_PTOFrom from #z_PTOFrom
select * into z_PTAFrom from #z_PTAFrom
select * into z_CAFrom from #z_CAFrom
select * into z_CADFrom from #z_CADFrom
return*/

IF EXISTS(SELECT E.ProjTaskId FROM #z_EqpTo E WHERE E.ProjTaskId>0 AND E.ProjTaskIdUpdate IS NULL)
BEGIN	
	
	--Insert options for the new tasks
	INSERT INTO tblProjTaskOpts(
	ProjTaskId,OccurrenceTypeId,ProjTaskOpt,Probability,PlannedOption,[First],Frequency)
	SELECT
	E.ProjTaskId,PTO.OccurrenceTypeId,PTO.ProjTaskOpt,PTO.Probability,PTO.PlannedOption,
	PTO.[First],PTO.Frequency
	FROM
	#z_PTOFrom PTO
		INNER JOIN
	#z_EqpTo E
		ON PTO.ProjTaskId=E.ProjTaskIdFrom
		WHERE E.ProjTaskIdUpdate IS NULL
		/*VV 6-Nov-08*/AND E.ProjTaskId>0
		
	--Set planned option. Do not set First and frequency because it is only 1 option now
	UPDATE PT SET PlanTaskOptId=PTO.ProjTaskOptId
	FROM
	tblProjTasks PT
		INNER JOIN
	tblProjTaskOpts PTO
		ON PT.ProjTaskId=PTO.ProjTaskId
		INNER JOIN
	#z_EqpTo E
		ON PT.ProjTaskId=E.ProjTaskId
	WHERE E.ProjTaskIdUpdate IS NULL
	/*VV 6-Nov-08*/AND E.ProjTaskId>0
	
	--ProjTaskAmts and cost allocations are copied later
END



INSERT INTO tblProjTaskAmts(
ProjTaskOptId,PricedJobId,JobCodeId,PerformedAtSiteId,LaborShare,
PartTypeId,CurrencyId,
LaborCost,PartsCost,MiscCost,
Duration,Rotable_Repair_Strategy,
Action_Required_Id,Rebuild_Location_Id,Pricing_Date,Labour_Activity_Id,Misc_Cost_Expense_ID,
Labour_Cost_Expense_ID,Cost_Bearer_ID,Parts_Cost_Expense_ID,Crane_Cost,Pct_Freight,
Avg_Daily_Work_Hrs,Avg_No_People,Avg_Travel_Hrs,Travel_Distance,Travel_Recovery_Rate_L,
Misc_Trip_Cost,LaborHours,Labour_Hrs_Field,Travel_Recovery_Rate_V,Parts_EDC_ID,
Labour_EDC_ID,Misc_EDC_ID,Cost_Centre_ID,Work_Group_Id,Health_Safety_Id,
QtyVolume,PercentTopUp,UnitPrice,Consumable,StdJobPartsMargin)

SELECT
PTA.ProjTaskOptIdTo AS ProjTaskOptId,
A.PricedJobId,
PTA.JobCodeId,PTA.PerformedAtSiteId,PTA.LaborShare,
PTA.PartTypeId,PTA.CurrencyId,

CASE @Esc_Desc_Prices WHEN 1 THEN ceCur.CumLaborEscalation/ceNew.CumLaborEscalation ELSE 1.00 END *PTA.LaborCost AS LaborCost,

CASE	
/*VV 15 feb 08 Discussed with GE. Do not escalate parts cost if consumable, just copy it across.
We don't change unit price, qty, top up pct.*/
WHEN pta.Consumable=1 THEN 1.00
WHEN @Esc_Desc_Prices =1 THEN cpeCur.CumPartsEscalation/cpeNew.CumPartsEscalation ELSE 1.00 END *pta.PartsCost
AS PartsCost,

CASE @Esc_Desc_Prices WHEN 1 THEN ceCur.CumMiscEscalation/ceNew.CumMiscEscalation ELSE 1.00 END *pta.MiscCost AS MiscCost,
PTA.Duration,
CASE WHEN PTA.Rotable_Part_Id>0 THEN PTA.Rotable_Repair_Strategy ELSE 0 END AS Rotable_Repair_Strategy,
CASE WHEN PTA.Rotable_Part_Id>0 THEN PTA.Action_Required_Id ELSE NULL END AS Action_Required_Id,
CASE WHEN PTA.Rotable_Part_Id>0 THEN PTA.Rebuild_Location_Id ELSE NULL END AS Rebuild_Location_Id,
PTA.TaskPricingDate AS Pricing_Date,
PTA.Labour_Activity_Id,PTA.Misc_Cost_Expense_ID,
PTA.Labour_Cost_Expense_ID,PTA.Cost_Bearer_ID,PTA.Parts_Cost_Expense_ID,PTA.Crane_Cost,PTA.Pct_Freight,
PTA.Avg_Daily_Work_Hrs,PTA.Avg_No_People,PTA.Avg_Travel_Hrs,PTA.Travel_Distance,PTA.Travel_Recovery_Rate_L,
PTA.Misc_Trip_Cost,PTA.LaborHours,PTA.Labour_Hrs_Field,PTA.Travel_Recovery_Rate_V,PTA.Parts_EDC_ID,
PTA.Labour_EDC_ID,PTA.Misc_EDC_ID,PTA.Cost_Centre_ID,PTA.Work_Group_Id,PTA.Health_Safety_Id,
PTA.QtyVolume,PTA.PercentTopUp,PTA.UnitPrice,PTA.Consumable,
CASE WHEN A.PricedJobId>0 THEN PTA.StdJobPartsMargin ELSE NULL END AS StdJobPartsMargins
FROM
(SELECT PTO.ProjTaskOptId AS ProjTaskOptIdTo,E.Rotable_Part_Id,E.ManufacturerId,
ISNULL(E.Pricing_Date,PTA.Pricing_Date) AS TaskPricingDate,E.ProjTaskId,
PTA.*
FROM
#z_PTAFrom PTA
	INNER JOIN
#z_PTOFrom PTOF
	ON PTA.ProjTaskOptId=PTOF.ProjTaskOptId
	INNER JOIN
#z_EqpTo E
	ON PTOF.ProjTaskId=E.ProjTaskIdFrom
	INNER JOIN
tblProjTaskOpts PTO
	ON E.ProjTaskId=PTO.ProjTaskId) PTA
	LEFT JOIN
(SELECT C.ProjTaskId,C.ProjTaskAmtId, PJ.PricedJobId FROM 
tblPricedJobs PJ 
	INNER JOIN
(SELECT Eqp.ProjTaskId, PTASJ.ProjTaskAmtId,Eqp.BranchId,Eqp.Price_Group_ID,PTASJ.CurrencyId,PTASJ.StdJobId FROM
#z_EqpTo Eqp
	INNER JOIN
#z_PTOFrom PTOSJ
	ON Eqp.ProjTaskIdFrom=PTOSJ.ProjTaskId
	INNER JOIN
#z_PTAFrom PTASJ
	ON PTOSJ.ProjTaskOptId=PTASJ.ProjTaskOptId
WHERE @KeepLinkToStdJob=1 AND Eqp.ProjTaskId>0 AND PTASJ.PricedJobId>0 AND 
(@Filter_Std_Job_Model=0 OR Eqp.ModelId=PTASJ.StdJobModelId))C

	ON PJ.StdJobId=C.StdJobId AND 
	   PJ.Currency_ID=C.CurrencyId AND 
	   PJ.BranchId=C.BranchId AND 
	   PJ.Price_Group_ID=C.Price_Group_ID
)A
	ON PTA.ProjTaskId=A.ProjTaskId AND
	   PTA.ProjTaskAmtId=A.ProjTaskAmtId

	LEFT JOIN 
tblCostEscalations ceCur
	ON ceCur.EscalationDate <= pta.Pricing_Date -- @oldTaskPricingDate
	   AND ceCur.EndDate > pta.Pricing_Date -- @oldTaskPricingDate
	LEFT JOIN 
tblCostPartsEscalations cpeCur 
	ON ceCur.CostEscalationId =cpeCur.CostEscalationId
	AND cpeCur.ManufacturerId= PTA.ManufacturerId 
	LEFT JOIN 
tblCostEscalations ceNew 
	ON ceNew.EscalationDate <= pta.TaskPricingDate
	AND ceNew.EndDate > pta.TaskPricingDate
	LEFT JOIN 
tblCostPartsEscalations cpeNew 
	ON ceNew.CostEscalationId =cpeNew.CostEscalationId
	AND cpeNew.ManufacturerId= PTA.ManufacturerId

ORDER BY PTA.ProjTaskOptIdTo,PTA.ProjTaskAmtId

--Cost allocations
IF EXISTS(SELECT Cost_Allocation_Id FROM #z_CAFrom)
BEGIN
	CREATE TABLE #z_OldId(ListId int IDENTITY(1,1),ProjTaskOptId int,ProjTaskAmtId int PRIMARY KEY(ListId,ProjTaskOptId))
	CREATE TABLE #z_NewId(ListId int IDENTITY(1,1),ProjTaskOptId int,ProjTaskAmtId int PRIMARY KEY(ListId,ProjTaskOptId,ProjtaskAmtId))

	INSERT INTO #z_OldId(ProjTaskOptId,ProjTaskAmtId)
	SELECT PTO.ProjTaskOptId,PTA.ProjTaskAmtId
	FROM
	#z_PTAFrom PTA
		INNER JOIN
	#z_PTOFrom PTOF
		ON PTA.ProjTaskOptId=PTOF.ProjTaskOptId
		INNER JOIN
	#z_PTFrom PT
		ON PTOF.ProjTaskId=PT.ProjTaskId
		INNER JOIN
	#z_EqpTo E
		ON PT.Task_Header_Id=E.Task_Header_Id
		INNER JOIN
	tblProjTaskOpts PTO
		ON E.ProjTaskId=PTO.ProjTaskId
	ORDER BY PTO.ProjTaskOptId,PTA.ProjTaskAmtId

	INSERT INTO #z_NewId(ProjTaskOptId,ProjTaskAmtId)
	SELECT PTO.ProjTaskOptId,PTA.ProjTaskAmtId
	FROM
	tblProjTaskAmts PTA
		INNER JOIN
	tblProjTaskOpts PTO
		ON PTA.ProjTaskOptId=PTO.ProjTaskOptId
		INNER JOIN
	#z_EqpTo E
		ON PTO.ProjTaskId=E.ProjTaskId
	ORDER BY PTO.ProjTaskOptId,PTA.ProjTaskAmtId

	INSERT INTO COST_ALLOCATION(
		Cost_Allocation_Ref, Currency_Id, System_Source_Id, Component_Code_Id, 
		Model_Id, Create_Date, Last_Mod_Date, Proj_Task_Amt_Id, Eqp_Plan_Id,ModifierId)

	SELECT	cal.Cost_Allocation_Ref, cal.Currency_Id, @SystemSourceAMT AS System_Source_Id, 
	cal.Component_Code_Id, E.ModelId AS Model_Id, @CurrDate AS Create_Date, @CurrDate AS Last_Mod_Date, 
	N.ProjTaskAmtId AS Proj_Task_Amt_Id, E.EqpPlanId AS Eqp_Plan_Id,cal.ModifierId
	FROM	
	#z_CAFrom CAL
		INNER JOIN
	#z_PTAFrom PTAF
		ON CAL.Proj_Task_Amt_Id=PTAF.ProjTaskAmtId
		INNER JOIN
	#z_OldId O
		ON PTAF.ProjTaskAmtId=O.ProjTaskAmtId
		INNER JOIN
	#z_NewId N
		ON O.ListId=N.ListId
		INNER JOIN
	tblProjTaskOpts PTO 
		ON N.ProjTaskOptId=PTO.ProjTaskOptId
		INNER JOIN
	#z_EqpTo E
		ON E.ProjTaskId=PTO.ProjTaskId

	INSERT INTO COST_ALLOCATION_DETAIL(
		Cost_Allocation_Id, Work_Group_Id, Cost_Centre_Id, Parts_Cost_Expense_Id, Labour_Cost_Expense_Id, 
		Misc_Cost_Expense_Id, Cost_Bearer_Id, Parts_Cost, Misc_Cost, Labour_Cost, Labour_Activity_Id, Labour_Hrs, 
		Duration_Hrs, Job_Code_Id, Create_Date, Last_Mod_Date)
	SELECT	CA.Cost_Allocation_Id, 
		cald.Work_Group_Id, 
		cald.Cost_Centre_Id, 
		cald.Parts_Cost_Expense_Id, 
		cald.Labour_Cost_Expense_Id, 
		cald.Misc_Cost_Expense_Id, 
		cald.Cost_Bearer_Id, 
		CASE @Esc_Desc_Prices WHEN 1 THEN cpeCur.CumPartsEscalation/cpeNew.CumPartsEscalation ELSE 1.00 END *cald.Parts_Cost AS Parts_Cost,
		CASE @Esc_Desc_Prices WHEN 1 THEN ceCur.CumMiscEscalation/ceNew.CumMiscEscalation ELSE 1.00 END *cald.Misc_Cost AS Misc_Cost,
		CASE @Esc_Desc_Prices WHEN 1 THEN ceCur.CumLaborEscalation/ceNew.CumLaborEscalation ELSE 1.00 END *cald.Labour_Cost AS Labour_Cost,
		cald.Labour_Activity_Id, 
		cald.Labour_Hrs, 
		cald.Duration_Hrs, 	
		cald.Job_Code_Id, 
		@CurrDate AS Create_Date, 
		@CurrDate AS Last_Mod_Date	
	FROM
	#z_CADFrom CALD
		INNER JOIN
	#z_CAFrom CAL
		ON CALD.Cost_Allocation_Id=CAL.Cost_Allocation_Id
		INNER JOIN
	#z_PTAFrom PTAF
		ON CAL.Proj_Task_Amt_Id=PTAF.ProjTaskAmtId
		INNER JOIN
	#z_PTOFrom PTOF
		ON PTAF.ProjTaskOptId=PTOF.ProjTaskOptId
		INNER JOIN
	#z_PTFrom PTF
		ON PTOF.ProjTaskId=PTF.ProjTaskId
		INNER JOIN
	#z_OldId O
		ON PTAF.ProjTaskAmtId=O.ProjTaskAmtId
		INNER JOIN
	#z_NewId N
		ON O.ListId=N.ListId
		INNER JOIN
	COST_ALLOCATION CA
		ON N.ProjTaskAmtId=CA.Proj_Task_Amt_Id
		INNER JOIN
	tblProjTaskAmts PTA
		ON CA.Proj_Task_Amt_Id=PTA.ProjTaskAmtId
		LEFT JOIN 
tblCostEscalations ceCur
	ON ceCur.EscalationDate <= PTAF.Pricing_Date -- @oldTaskPricingDate
	   AND ceCur.EndDate > PTAF.Pricing_Date -- @oldTaskPricingDate
	LEFT JOIN 
tblCostPartsEscalations cpeCur 
	ON ceCur.CostEscalationId =cpeCur.CostEscalationId
	AND cpeCur.ManufacturerId= PTF.ManufacturerId
	LEFT JOIN 
tblCostEscalations ceNew 
	ON ceNew.EscalationDate <= PTA.Pricing_Date
	AND ceNew.EndDate > PTA.Pricing_Date
	LEFT JOIN 
tblCostPartsEscalations cpeNew 
	ON ceNew.CostEscalationId =cpeNew.CostEscalationId
	AND cpeNew.ManufacturerId= PTF.ManufacturerId
		
END

--VV 1-May-2009 CR8035
IF EXISTS(SELECT ProjTaskId FROM #z_PROJ_TASK_DOCUMENT)
BEGIN
	INSERT INTO PROJ_TASK_DOCUMENT(ProjTaskId, WorkScopeDocumentId)
	SELECT E.ProjTaskId,PTD.WorkScopeDocumentId
	FROM
	tblProjTasks PT
		INNER JOIN
	#z_EqpTo E
		ON PT.ProjTaskId=E.ProjTaskId
		INNER JOIN
	#z_PROJ_TASK_DOCUMENT PTD
		ON E.ProjTaskIdFrom=PTD.ProjTaskId
	
END	

IF EXISTS(SELECT ProjTaskId FROM #z_PROJ_TASK_EXTERNAL_DOCUMENT)
BEGIN
	INSERT INTO PROJ_TASK_EXTERNAL_DOCUMENT(ProjTaskId, DocumentLink, DocumentName)
	SELECT E.ProjTaskId,PTD.DocumentLink, PTD.DocumentName
	FROM
	tblProjTasks PT
		INNER JOIN
	#z_EqpTo E
		ON PT.ProjTaskId=E.ProjTaskId
		INNER JOIN
	#z_PROJ_TASK_EXTERNAL_DOCUMENT PTD
		ON E.ProjTaskIdFrom=PTD.ProjTaskId
	
END	

--Update std jobs price if required
IF @KeepLinkToStdJob=1 AND EXISTS(SELECT E.EqpProjId FROM 
	#z_EqpTo E
		INNER JOIN
	#z_PTOFrom PTO
		ON E.ProjTaskIdFrom=PTO.ProjTaskId
		INNER JOIN
	#z_PTAFrom PTA
		ON PTO.ProjTaskOptId=PTA.ProjTaskOptId
	WHERE E.Projection_Type_Id IN(@ProjTypeCurr,@ProjTypeAlt,@ProjTypeCen) AND
	PTA.PricedJobID>0)
BEGIN
	SET @Id =''

	SELECT @Id=@Id+CAST(A.EqpProjId AS varchar)+','
	FROM
	(SELECT DISTINCT E.EqpProjId FROM
	#z_EqpTo E
		INNER JOIN
	tblProjTaskOpts PTO
		ON E.ProjTaskId=PTO.ProjTaskId
		INNER JOIN
	tblProjTaskAmts PTA
		ON PTO.ProjTaskOptId=PTA.ProjTaskOptId
	WHERE PTA.PricedJobId>0) A
	
	IF @Id<>''
	BEGIN
		SET @Id=LEFT(@Id,LEN(@Id)-1)
	
		DECLARE @StdJobID varchar(8000)

		SELECT @StdJobID=@StdJobID+CAST(StdJobID AS varchar)+','
		FROM #z_PTAFrom

		SET @StdJobID=LEFT(@StdJobID,LEN(@StdJobID)-1)

		EXEC PRICED_JOB_PROJ_TASK_AMTS_UPDATE_P @PricedJobID =NULL,
												@StdJobID=@StdJobID,
												@Price_Group_ID=NULL,
												@CurrencyID=NULL,
												@BranchID=NULL,
												@LastModDate=NULL,
												@ProjTaskAmtId=NULL,
												@EqpProjId=@Id
	END
END


IF @toEqpProjHeaderId=@ProjHeaderCur
BEGIN
	--Link EQS tasks to the new projected tasks.

	SET @Id=''

	SELECT @Id=@Id+CAST(ProjTaskId AS varchar)+','
	FROM #z_EqpTo WHERE ProjTaskId>0 AND ProjTaskIdUpdate IS NULL

	IF @Id<>'' 
	BEGIN
		SET @Id=LEFT(@Id,LEN(@Id)-1)
		EXEC STRATEGY_TASK_LINK_TO_EQS_TASK_P @ProjTaskId =NULL, 
												@EqpProjId =NULL,   
												@EqpPlanId =NULL,
												@Message =@errorMsg OUTPUT,
												@ProjTaskIdMany =@Id

		SET @errorMsg=ISNULL(@errorMsg,'')
		IF @errorMsg<>'' RETURN
	END

	--Update scheduling task
	SET @Id=''

	SELECT @Id=@Id+CAST(PT.ProjTaskId AS varchar)+','
	FROM
	tblProjTasks PT
		INNER JOIN
	#z_EqpTo E
		ON PT.ProjTaskId=E.ProjTaskIdUpdate
	WHERE PT.SchedulingTaskId>0
	
	IF @Id<>''
	BEGIN
		EXEC SCHEDULING_TASK_TO_PROJ_TASK_P @ProjTaskIdMany=@Id
	END

END

SELECT @EqpUpdated=COUNT(DISTINCT EqpPlanId) FROM #z_EqpTo WHERE ProjTaskId>0
SET @EqpUpdated=ISNULL(@EqpUpdated,0)

/*
--VV Debug
drop table z_EqpTo,z_PTFrom,z_PTOFrom,z_PTAFrom,z_CAFrom,z_CADFrom
select * into z_EqpTo from #z_EqpTo
select * into z_PTFrom from #z_PTFrom
select * into z_PTOFrom from #z_PTOFrom
select * into z_PTAFrom from #z_PTAFrom
select * into z_CAFrom from #z_CAFrom
select * into z_CADFrom from #z_CADFrom
*/






GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Copy_Proj_Task]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Copy_Proj_Task]
GO

create PROCEDURE [dbo].[usp_Copy_Proj_Task]
	/* Param List */
	@fromEqpProjId int,
	@toEqpProjID int,
	@NewEquipment bit=0,
	@Esc_Desc_Prices bit=0,
	@LeavePricingDate bit=0,
	@KeepLinkToStdJob bit=1,
	@NewPricingDate datetime=NULL,
	@EqpRolloverId int=0,
	@RolloverOpt int=0,
	@Message varchar(8000)='' OUTPUT,
	@RaiseError bit=1
	
AS


/******************************************************************************
	File: usp_Copy_Proj_Task.sql
	Name: usp_Copy_Proj_Task

	Called By: -

	Desc:	Copies tasks.
			Calls copy of task options and amounts.

	RULES ARE:
	- If copy from a BUDGET then:
		- Pricing Date REmains the same
		- Do Not escalate prices to todays date
	- ALL OTHER COPIES
		- Pricing Date made TODAYS DATE
		- Prices are escalated

	Auth: Robbie Feyder
	Date: 3 June 2002

*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	12 Apr 2012 SD          E781 - Add PEX tblProjTask Fields
	 6 Oct 2010	V Vasylyeva	E316 Copy PartRatingId
	 7 Jul 10	V Vasylyeva	CR9019 Copy CBDTask
	03 Sep 09	K Nagarajan	CR8377 Copy AMT_Wo_Last_Occ Fields
	 1-May-09	V Vasylyeva	CR8035: Library documents
	16/09/08	AL			Removed UsageUOMID
	13 Jun 08	V Vasylyeva	Added StdJobPartsMargin
    21 Feb 08	AL			Changed PlanDateLocked to ReviewStatusID
	20 Feb 08	V Vasylyeva	Copy cost allocations to the other equipment
	15 Feb 08	V Vasylyeva	New fields in the task tables, copy repair reserve task link
							New fields: 
							tblProjTasks
							PerformanceStrategyReason,RCMComponentStructureId,
							ParentTaskId,AutomaticUpdate

							tblProjTaskAmts
							QtyVolume,PercentTopUp,UnitPrice,Consumable

	 7 Feb 08	V Vasylyeva Removed Show_Strategy
	 7 Aug 07	V Vasylyeva	Copy fields which contain precalculated values
							for the default cost bearer only to alternate/archived 
							projections.
	13 Jul 07	K Nagarajan	Added ModifierId
	13 Jul 07	K Nagarajan	Removed Operation_id from CostAllocation
	 5 Jul 07	SI			Added coping PlanTaskOptId
	02 Jul 07	K Nagarajan	Added Inspection Logic fields
	 2 Jul 07	V Vasylyeva	Took out exchange rate for cost allocations
	11 Apr 07	A Lassauniere	Fixed job cost copy for alternates and archives (CR6065)
	21 Nov 06	V Vasylyeva	Rotables are copied only to the current projection
					First is incorrect if modelling equipment projection
					is created
					Changed to use occusage instead of occdate
	20 Nov 06	V Vasylyeva	Speeded up creation of Proj Task Opts
	07 Nov 06	SI		Changed completely to remove cursors
	02 Nov 06	V Vasylyeva	Copy next occ data only to the current projection
	01 Nov 06	V Vasylyeva	Rollover changes
	25 Oct 06	V Vasylyeva	Rollover logic
	22 Sep 06	V Vasylyeva	Added new fields
					Operational_Criticality_Id, Warranty_Period_Usage, Warranty_Period_Days, Maintenance_Strategy_Id, 
					Changeout_Guidelines, Task_Description,Show_Strategy, Schedule_Type_Id, Scheduling_Group_Id, 
					Scheduling_Group_Counter
	17 Jul 06	SI		Added coping the new Calc fields of ProjTask
	27 Jun 06	SI		Changed the rules for Rotables
	05-May-05	V Vasylyeva	Changes for the new types of equipment
	01-Mar-05	V Vasylyeva	Changes for the new equipment
	03-Feb-05	V Vasylyeva	added @NewEquipment, @Esc_Desc_Prices, @LeavePricingDate, @KeepLinkToStdJob,@NewPricingDate
	15 Apr 04	H Singh		Planning task fix (moved to tblProjtasks table)
	03-Dec-03	ML		Set PlanTaskOptId to null to Destination Task
	27-Nov-03	ML		Last Change Date/Usage Fix  
	29-Sep-03	ML		Added Last Change Date/Usage 
	10-Sep-03	HS		Pricing Date Fix
	14 Jun 02	R Feyder	Fix up logic for pricing date and applying escalation    	
					Also fix for Type of Projection creating, and if copying to a different Equipment
	04 Apr 11	GW add AutoGenerateWOS
*******************************************************************************/

	/* Local procedure variables */ 

/*VV Discussed with GE&RF. 
Do not escalate misc trip cost, crane cost, consumable unit price just copy it across.
*/

DECLARE @fromProjTaskId int
DECLARE @toProjTaskId int
DECLARE @ToBudgetProj int
DECLARE @CopyOccData bit
Declare @toEqpPlanId int
Declare @fromEqpPlanId int

DECLARE @ProjTypeCurrent int
DECLARE @ProjTypeBudget int
DECLARE @ProjTypeAlternate int
DECLARE @ProjTypeArchived int
DECLARE @ProjTypeCenterline int
DECLARE @ProjTypeEstimateCurrent int
DECLARE @ProjTypeEstimateDraft int
DECLARE @ToCurrentProj bit
DECLARE @CopyPrecalcFields int
DECLARE @NewModelId int


SET @ProjTypeCurrent =1
SET @ProjTypeBudget =2
SET @ProjTypeAlternate =3
SET @ProjTypeArchived =4
SET @ProjTypeCenterline =5
SET @ProjTypeEstimateCurrent =6
SET @ProjTypeEstimateDraft =7

SET @Message=''

SET @CopyOccData = 0

DECLARE @return_status int

SET @ToCurrentProj=0

SELECT  @fromEqpPlanId=EqpPlanId
FROM  tblEqpProjs
WHERE	EqpProjID = @FromEqpProjId

--TO BUDGET?
SELECT  @toEqpPlanId=EqpPlanId,
@ToBudgetProj= 
	CAST( CASE 
	WHEN Projection_Type_Id IN (@ProjTypeBudget,@ProjTypeEstimateCurrent,@ProjTypeEstimateDraft,@ProjTypeCenterline)
	THEN 1 ELSE 0 END AS bit),
	@ToCurrentProj= CASE Projection_Type_Id WHEN @ProjTypeCurrent THEN 1 ELSE 0 END,
	@CopyPrecalcFields= CAST( CASE 
	WHEN Projection_Type_Id IN (@ProjTypeAlternate,@ProjTypeArchived)
	THEN 1 ELSE 0 END AS bit)
FROM tblEqpProjs
WHERE EqpProjID = @toEqpProjID



IF @NewEquipment=1 OR @toEqpPlanId<>@fromEqpPlanId
BEGIN

	EXEC @return_status = COPY_TASKS_BUSINESS_RULES_P @EqpProjIdFrom=@FromEqpProjId,
						@EqpProjIdTo =@toEqpProjID,	
						@Message =@Message OUTPUT		
	
	IF ISNULL(@Message,'')<>'' 
	BEGIN
		IF @RaiseError=1 
		BEGIN
			RAISERROR (@Message, 16, 1)
		END

		RETURN
	END
	
	--Do not copy precalculated fields into projection if equipment plan is different
	SET @CopyPrecalcFields=0
END


Declare @lastChangeDate datetime
Declare @lastChangeUsage float

Set @lastChangeDate = null
Set @lastChangeUsage = null

DECLARE @UseLastOcc bit
DECLARE @EqpProjRol int
DECLARE @StartDate datetime
DECLARE @StartUsage float
DECLARE @Rollover bit
DECLARE @RolloverOptSetNext int

--VV 22 Feb 2008
DECLARE @EscCosts bit

SET @EscCosts=0

/*@RolloverOpt 
1 - Set First based on Rollover Equipment Last Occurrence
2 - Set First based on Rollover Equipment Last Occurrence and Set Next based 
    on Rollover Equipment Next Occurrence
*/

SET @RolloverOptSetNext=2

SET @UseLastOcc=0
SET @EqpProjRol=0
SET @Rollover=0


IF @EqpRolloverId>0
BEGIN
	EXEC @return_status = EQP_ROLLOVER_BUSINESS_RULES_P
					@EqpRolloverId =@EqpRolloverId,						
					@EqpProjTo =@toEqpProjID,		
					@Message =@Message OUTPUT
	IF ISNULL(@Message,'')<>''
	BEGIN
		IF @RaiseError=1 
		BEGIN
			RAISERROR (@Message, 16, 1)
		END

		RETURN
	END

	SELECT @EqpProjRol=EPR.EqpProjId
	FROM tblEqpProjs EPR 	
	WHERE EPR.EqpPlanID=@EqpRolloverId AND
	EPR.Projection_Type_Id IN(@ProjTypeCurrent, @ProjTypeCenterline, @ProjTypeEstimateCurrent)
	
	SET @EqpProjRol=ISNULL(@EqpProjRol,0)

	IF @ToCurrentProj=1 
	BEGIN
		SET @UseLastOcc=1
	END
END
--03-Feb-05 VV
IF @NewEquipment=1
BEGIN

	SET @CopyOccData=0
	
	Select @lastChangeDate = StartDate, @lastChangeUsage=0,@StartDate=StartDate  From tblEqpPlans Where EqpPlanId = @toEqpPlanId

END
--SAME EQUIPMENT?
ELSE IF @toEqpPlanId=@fromEqpPlanId
	BEGIN
		IF ISNULL(@ToBudgetProj,0) = 0
		BEGIN
			SET @CopyOccData = 1
		END
	END
ELSE
	BEGIN
		-- ML: 27 NOV 03 - IF DIFFERENT EQUIPMENT THEN GET LAST CHANGE USAGE AND DATE FROM EQP PLAN START DATE
		Select @lastChangeDate = StartDate, @lastChangeUsage=0,@StartDate=StartDate  From tblEqpPlans Where EqpPlanId = @toEqpPlanId
	END

CREATE TABLE #z_tblCostEscalations_New(CostEscalationId int,CumLaborEscalation float,CumMiscEscalation float ,
	EqpProjId int
	PRIMARY KEY(CostEscalationId,EqpProjId))

--VV 22 Feb 2008 
--Check do we need to escalate/de-escalate costs
IF @NewEquipment=1 AND @Esc_Desc_Prices=1 AND @NewPricingDate IS NOT NULL 
BEGIN
	SET @EscCosts=1

	INSERT INTO #z_tblCostEscalations_New (CostEscalationId,CumLaborEscalation,CumMiscEscalation,EqpProjId)
		
	SELECT CostEscalationId, CumLaborEscalation, CumMiscEscalation,@toEqpProjID AS EqpProjID
	FROM  tblCostEscalations WHERE EscalationDate <= @NewPricingDate AND EndDate > @NewPricingDate
END		

CREATE TABLE #OLD_ID1 (Rec_No INT NOT NULL IDENTITY (1,1) PRIMARY KEY CLUSTERED, Rec_Id INT NOT NULL,
/*VV 15 Feb 08*/ParentTaskId int)
CREATE TABLE #NEW_ID1 (Rec_No INT NOT NULL IDENTITY (1,1) PRIMARY KEY CLUSTERED, Rec_Id INT NOT NULL)
CREATE TABLE #OLD_ID2 (Rec_No INT NOT NULL IDENTITY (1,1) PRIMARY KEY CLUSTERED, Rec_Id INT NOT NULL)
CREATE TABLE #NEW_ID2 (Rec_No INT NOT NULL IDENTITY (1,1) PRIMARY KEY CLUSTERED, Rec_Id INT NOT NULL)
CREATE UNIQUE INDEX #OLD_ID1_ind ON #OLD_ID1(Rec_Id)
CREATE UNIQUE INDEX #NEW_ID1_ind ON #NEW_ID1(Rec_Id)
CREATE UNIQUE INDEX #OLD_ID2_ind ON #OLD_ID2(Rec_Id)
CREATE UNIQUE INDEX #NEW_ID2_ind ON #NEW_ID2(Rec_Id)


--select @EqpProjRol as EqpProjRol,@UseLastOcc as UseLastOcc,@StartDate as StartDate,@toEqpPlanId as toEqpPlanId
--return


INSERT INTO tblProjTasks(
	EqpPlanId, EqpProjId, ComponentCodeId, ModifierId, AltModifierId, 
	TaskTypeId, ApplicationCodeId, ManufacturerId, 
	UsageMethod, --not used
	UsageQUOMId, --UsageUOMId, AL: 16/09/08
	LastOcc, LastOccDate,
	[First], Frequency, Final,
	PlanUseCalc, PlanStatus, 
	--PlanDateLocked, AL: 21/02/08
	NextOcc, NextOccDate,
	Unscheduled, FromStdJobs, Task_Header_Id,
	Rotable_Part_Id, 
	Group_Number, Part_Id, Last_Change_Date, Last_Change_Usage, Planning_Task, Planning_Lead_Time,
	ProjPartsTotal, ProjLaborTotal, ProjMiscTotal, 
	ProjPartsTotalEsc, ProjLaborTotalEsc, ProjMiscTotalEsc,
	PastOccNumber, PastTotalSell, PastTotalSellEsc, PastLabourHours, PastDuration,
	FutureOccNumber, FuturePartsSell, FutureLabourSell, FutureMiscSell, 
	FuturePartsSellEsc, FutureLabourSellEsc, FutureMiscSellEsc, FutureLabourHours, 
	FutureDuration,				
	Operational_Criticality_Id, Warranty_Period_Usage, Warranty_Period_Days, Maintenance_Strategy_Id, 
	Changeout_Guidelines, Task_Description,/* VV 7 Feb 08 Show_Strategy,*/ Schedule_Type_Id, Scheduling_Group_Id, 
	Scheduling_Group_Counter,InspectionTaskTypeId, InspectionOffset,
	/*VV 15 Feb 08*/
	PerformanceStrategyReason,RCMComponentStructureId,AutomaticUpdate,
	--AL: 21/02/08
	ReviewStatusID,ReviewUserID,ReviewDate, AMT_WO_Last_Occ, AMT_WO_Last_Occ_Date,
	/*VV CR9019*/CBDTask,/*E316*/PartRatingId,/*GW*/AutoGenerateWOS,
	/*E781*/ PartClassificationId, DefaultLocationForRebuild
	)
SELECT	CASE @NewEquipment WHEN 1 THEN @toEqpPlanId  ELSE prtsk.EqpPlanId END AS EqpPlanId, 
	@toEqpProjID, 
	prtsk.ComponentCodeId, prtsk.ModifierId, prtsk.AltModifierId, prtsk.TaskTypeId, prtsk.ApplicationCodeId, prtsk.ManufacturerId, 
	prtsk.UsageMethod,
	prtsk.UsageQUOMId, --prtsk.UsageUOMId,  AL: 16/09/08
	CASE @CopyOccData WHEN 1 THEN prtsk.LastOcc ELSE NULL END,
	CASE @CopyOccData WHEN 1 THEN prtsk.LastOccDate ELSE NULL END,
	prtsk.[First], prtsk.Frequency, prtsk.Final, 
	CASE WHEN @RolloverOpt=@RolloverOptSetNext AND @ToCurrentProj=1 AND prtskRollover.PlanUseCalc=0 THEN prtskRollover.PlanUseCalc ELSE CASE WHEN @CopyOccData = 1 THEN prtsk.PlanUseCalc ELSE 1 END END AS PlanUseCalc, 	-- @RolloverOpt=@RolloverOptSetNext AND @ToCurrentProj=1 AND @PlanUseCalcRol=0
	CASE WHEN @RolloverOpt=@RolloverOptSetNext AND @ToCurrentProj=1 AND prtskRollover.PlanUseCalc=0 THEN prtskRollover.PlanStatus ELSE CASE WHEN @CopyOccData = 1 THEN prtsk.PlanStatus ELSE 0 END END AS PlanStatus,
	--CASE WHEN @RolloverOpt=@RolloverOptSetNext AND @ToCurrentProj=1 AND prtskRollover.PlanUseCalc=0 THEN prtskRollover.PlanDateLocked ELSE CASE WHEN @CopyOccData = 1 THEN prtsk.PlanDateLocked ELSE 0 END END AS PlanDateLocked,	AL: 21/02/08
	CASE WHEN @RolloverOpt=@RolloverOptSetNext AND @ToCurrentProj=1 AND prtskRollover.PlanUseCalc=0 THEN prtskRollover.NextOcc ELSE CASE WHEN @CopyOccData = 1 THEN prtsk.NextOcc ELSE NULL END END AS NextOcc,
	CASE WHEN @RolloverOpt=@RolloverOptSetNext AND @ToCurrentProj=1 AND prtskRollover.PlanUseCalc=0 THEN prtskRollover.NextOccDate ELSE CASE WHEN @CopyOccData = 1 THEN prtsk.NextOccDate ELSE NULL END END AS NextOccDate,
	prtsk.Unscheduled, 
	prtsk.FromStdJobs, 
	prtsk.Task_Header_Id, 
	CASE /*WHEN @ToCurrentProj=1 THEN NULL*/
	     WHEN rpmepr.EqpProjId IS NOT NULL THEN prtsk.Rotable_Part_Id 
	     ELSE NULL END as Rotable_Part_Id, 
	prtsk.Group_Number, 
	prtsk.Part_Id, 
	CASE WHEN @ToCurrentProj=1 AND prtskRollover.ProjTaskId IS NOT NULL 
		THEN ISNULL(prtskRollover.AMT_WO_Last_Occ_Date, prtskRollover.Last_Change_Date)
		ELSE ISNULL(@lastChangeDate, prtsk.Last_Change_Date) 
	END, 
	CASE WHEN @ToCurrentProj=1 AND prtskRollover.ProjTaskId IS NOT NULL
		THEN ISNULL(prtskRollover.AMT_WO_Last_Occ, prtskRollover.Last_Change_Usage)
		ELSE ISNULL(@lastChangeUsage, prtsk.Last_Change_Usage) 
	END, 
	prtsk.Planning_Task, prtsk.Planning_Lead_Time,
	@CopyPrecalcFields*prtsk.ProjPartsTotal, @CopyPrecalcFields*prtsk.ProjLaborTotal, 
	@CopyPrecalcFields*prtsk.ProjMiscTotal, @CopyPrecalcFields*prtsk.ProjPartsTotalEsc, 
	@CopyPrecalcFields*prtsk.ProjLaborTotalEsc, @CopyPrecalcFields*prtsk.ProjMiscTotalEsc,
	@CopyPrecalcFields*prtsk.PastOccNumber, @CopyPrecalcFields*prtsk.PastTotalSell, 
	@CopyPrecalcFields*prtsk.PastTotalSellEsc, @CopyPrecalcFields*prtsk.PastLabourHours, 
	@CopyPrecalcFields*prtsk.PastDuration,@CopyPrecalcFields*prtsk.FutureOccNumber, 
	@CopyPrecalcFields*prtsk.FuturePartsSell, @CopyPrecalcFields*prtsk.FutureLabourSell, 
	@CopyPrecalcFields*prtsk.FutureMiscSell, @CopyPrecalcFields*prtsk.FuturePartsSellEsc, 
	@CopyPrecalcFields*prtsk.FutureLabourSellEsc, @CopyPrecalcFields*prtsk.FutureMiscSellEsc, 
	@CopyPrecalcFields*prtsk.FutureLabourHours, @CopyPrecalcFields*prtsk.FutureDuration,				
	prtsk.Operational_Criticality_Id, prtsk.Warranty_Period_Usage, prtsk.Warranty_Period_Days, prtsk.Maintenance_Strategy_Id, 
	prtsk.Changeout_Guidelines, prtsk.Task_Description, /* VV 7 Feb 08 prtsk.Show_Strategy,*/ prtsk.Schedule_Type_Id, prtsk.Scheduling_Group_Id, 
	prtsk.Scheduling_Group_Counter,	prtsk.InspectionTaskTypeId,prtsk.InspectionOffSet,
	prtsk.PerformanceStrategyReason,prtsk.RCMComponentStructureId,prtsk.AutomaticUpdate,
	--AL: 21/02/08
	CASE WHEN @RolloverOpt=@RolloverOptSetNext AND @ToCurrentProj=1 AND prtskRollover.PlanUseCalc=0 THEN prtskRollover.ReviewStatusID ELSE CASE WHEN @CopyOccData = 1 THEN prtsk.ReviewStatusID ELSE 1 END END AS ReviewStatusID,
	CASE WHEN @RolloverOpt=@RolloverOptSetNext AND @ToCurrentProj=1 AND prtskRollover.PlanUseCalc=0 THEN prtskRollover.ReviewUserID ELSE CASE WHEN @CopyOccData = 1 THEN prtsk.ReviewUserID ELSE NULL END END AS ReviewUserID,
	CASE WHEN @RolloverOpt=@RolloverOptSetNext AND @ToCurrentProj=1 AND prtskRollover.PlanUseCalc=0 THEN prtskRollover.ReviewDate ELSE CASE WHEN @CopyOccData = 1 THEN prtsk.ReviewDate ELSE NULL END END AS ReviewDate,
	prtsk.AMT_WO_Last_Occ, prtsk.AMT_WO_Last_Occ_Date,/*VV CR9019*/prtsk.CBDTask,/*E316*/prtsk.PartRatingId,/*GW*/prtsk.AutoGenerateWOS,
	/*E781*/ prtsk.PartClassificationId, prtsk.DefaultLocationForRebuild
FROM	tblProjTasks prtsk
	LEFT JOIN (ROTABLE_PART_MODEL rpm 
		INNER JOIN tblEquipment rpmeqp ON rpmeqp.ModelId = rpm.Model_Id
		INNER JOIN tblEqpPlans rpmepl ON rpmepl.EquipmentId = rpmeqp.EquipmentId
		INNER JOIN tblEqpProjs rpmepr ON rpmepr.EqpPlanId = rpmepl.EqpPlanId AND rpmepr.EqpProjId = @toEqpProjID 
		AND @ToCurrentProj=1--VV 21-Nov-2006
		
	) ON prtsk.Rotable_Part_Id = rpm.Rotable_Part_Id
	LEFT JOIN tblProjTasks prtskRollover ON prtskRollover.EqpProjId=@EqpProjRol 
					AND prtskRollover.Task_Header_Id=prtsk.Task_Header_Id
					AND ISNULL(prtskRollover.UsageQUOMId,0) = ISNULL(prtsk.UsageQUOMId,0)
WHERE	prtsk.EqpProjId = @fromEqpProjId
ORDER BY prtsk.ProjTaskId

INSERT INTO #OLD_ID1(Rec_Id,ParentTaskId)
SELECT	prtsk.ProjTaskId,ParentTaskId
FROM	tblProjTasks prtsk
WHERE	prtsk.EqpProjId = @fromEqpProjId
ORDER BY prtsk.ProjTaskId

INSERT INTO #NEW_ID1(Rec_Id)
SELECT	prtsk.ProjTaskId
FROM	tblProjTasks prtsk
WHERE	prtsk.EqpProjId = @toEqpProjID
ORDER BY prtsk.ProjTaskId

--VV 15 Feb 08
--Copy RR tasks links to parent tasks
IF EXISTS(SELECT ParentTaskId FROM #OLD_ID1 WHERE ParentTaskId>0)
BEGIN
	--Update RR tasks
	UPDATE PT SET ParentTaskId=N2.Rec_Id
	FROM
	(SELECT O1.Rec_No AS RRId,O2.Rec_No AS ParentId
	FROM	
	#OLD_ID1 O1	--old Children	
		INNER JOIN
	#OLD_ID1 O2 -- old Parents
		ON O1.ParentTaskId=O2.Rec_Id) A
		
			INNER JOIN
	#NEW_ID1 N1 --new children
		ON A.RRId=N1.Rec_No
		INNER JOIN
	tblProjTasks PT
		ON N1.Rec_Id=PT.ProjTaskId
		INNER JOIN
	#NEW_ID1 N2 --new parents
		ON A.ParentId=N2.Rec_No
		
END

--EXEC usp_Copy_Proj_Task_Options

/*VV
drop table z_OLD_ID1
drop table z_NEW_ID1

SELECT * INTO z_OLD_ID1 FROM #OLD_ID1
SELECT * INTO z_NEW_ID1 FROM #NEW_ID1
-- SELECT * INTO z_OLD_ID2 FROM #OLD_ID2
-- SELECT * INTO z_NEW_ID2 FROM #NEW_ID2

CREATE UNIQUE INDEX OLD_ID1_ind ON z_OLD_ID1(Rec_Id)
CREATE UNIQUE INDEX NEW_ID1_ind ON z_NEW_ID1(Rec_Id)
-- CREATE UNIQUE INDEX OLD_ID2_ind ON z_OLD_ID2(Rec_Id)
-- CREATE UNIQUE INDEX NEW_ID2_ind ON z_NEW_ID2(Rec_Id)

RETURN*/

declare @z_StartUsages table (QUOMId int,StartUsage float Primary Key(QUOMId))

INSERT INTO @z_StartUsages(QUOMId,StartUsage)
SELECT StartUsageQUOMId, StartUsage
FROM 
tblEqpPlanStartUsages SU
	INNER JOIN
(SELECT Distinct UsageQUOMId FROM tblProjTasks WHERE EqpProjId=@fromEqpProjId) A
	ON SU.EqpPlanId=@toEqpPlanId AND SU.StartUsageQUOMId=A.UsageQUOMId

PRINT 'Update ProjTaskOpt'
INSERT INTO tblProjTaskOpts
	(ProjTaskId, MntPlanId, OccurrenceTypeId, 
	ProjTaskOpt, Probability, PlannedOption, 
	[First], Frequency)
SELECT	NwId.Rec_Id, 
	NULL, 
	pto.OccurrenceTypeId, 
	pto.ProjTaskOpt, 
	pto.Probability, 
	pto.PlannedOption, 
	ROUND(
		CASE	WHEN cv.ProjTaskOptId IS NULL -- no Rollover
			THEN pto.First
			ELSE	CASE	WHEN cv.UsageQUOMId IS NOT NULL AND cv.CalcFirst < cv.StartUsage THEN cv.StartUsage
					WHEN cv.UsageQUOMId IS NULL AND cv.CalcFirst < cv.StartUsage THEN 0
					WHEN cv.UsageQUOMId IS NULL THEN cv.CalcFirst - cv.StartUsage
					ELSE cv.CalcFirst
				END
		END
	, 0), 
	pto.Frequency
FROM	tblProjTaskOpts pto
	INNER JOIN #OLD_ID1 OldId ON OldId.Rec_Id = pto.ProjTaskId
	INNER JOIN #NEW_ID1 NwId ON NwId.Rec_No = OldId.Rec_No
	LEFT JOIN (
		SELECT	c.*,
			CASE	WHEN c.LastOcc <> 0 THEN c.LastOcc + c.Frequency
				WHEN c.UsageQUOMId IS NULL THEN c.First + c.StartUsage
				ELSE c.First
			END as CalcFirst
		FROM (
			SELECT	pto.ProjTaskOptId,
				prtsk.UsageQUOMId,
				pto.First,
				pto.Frequency,
				CASE WHEN prtsk.UsageQUOMId IS NULL THEN CAST(@StartDate AS float) ELSE ISNULL(su.StartUsage,0) END as StartUsage,
				CASE @UseLastOcc 
					WHEN 1 THEN ISNULL(prtskRollover.AMT_WO_Last_Occ,0) /*WOLastOcc*/
					ELSE	CASE WHEN mocc.LastOcc > ISNULL(prtskRollover.AMT_WO_Last_Occ,0) /*WOLastOcc*/
							THEN mocc.LastOcc
							ELSE ISNULL(prtskRollover.AMT_WO_Last_Occ,0) /*WOLastOcc*/
						END
				END as LastOcc
			FROM	tblProjTaskOpts pto
				LEFT JOIN tblProjTasks prtsk On prtsk.ProjTaskId = pto.ProjTaskId
				--LEFT JOIN tblEqpProjs epr ON epr.EqpProjId = prtsk.EqpProjId
				LEFT JOIN @z_StartUsages su ON su.QUOMId=prtsk.UsageQUOMId
				INNER JOIN tblProjTasks prtskRollover ON prtskRollover.EqpProjId=@EqpProjRol 
								AND prtskRollover.Task_Header_Id=prtsk.Task_Header_Id
								AND ISNULL(prtskRollover.UsageQUOMId,0) = ISNULL(prtsk.UsageQUOMId,0)
				LEFT JOIN (	SELECT	pto1.ProjTaskId, ISNULL(MAX(pto1.OccUsage),0) AS LastOcc
						FROM	tblProjTaskOccs pto1 inner join
						tblProjTasks pt1 on pto1.ProjTaskId=pt1.ProjTaskId
						LEFT JOIN @z_StartUsages su1 ON 
						su1.QUOMId=pt1.UsageQUOMId
						WHERE							
						-- 20 Nov 2006 VV
						pt1.EqpProjId=@EqpProjRol AND 
						pto1.OccUsage<=CASE WHEN pt1.UsageQUOMId IS NULL THEN CAST(@StartDate AS float) 
						ELSE ISNULL(su1.StartUsage,0) END 
						GROUP BY pto1.ProjTaskId
				) mocc ON mocc.ProjTaskId = prtskRollover.ProjTaskId --VV 21 Nov 2006 instead of prtsk.ProjTaskId = prtskRollover.ProjTaskId
		) c
	) cv ON cv.ProjTaskOptId = pto.ProjTaskOptId
ORDER BY pto.ProjTaskOptId

PRINT 'Update ProjTask First & Freq'
UPDATE	prtsk
SET	prtsk.First = nf.[First],
	prtsk.Frequency = nf.Frequency
FROM	tblProjTasks prtsk
	INNER JOIN #NEW_ID1 NwId ON NwId.Rec_Id = prtsk.ProjTaskId
	LEFT JOIN (
		SELECT	pto.ProjTaskId,
			SUM(pto.Probability * pto.[First] / 100) as First,
			SUM(pto.Probability * pto.[Frequency] / 100) as Frequency
		FROM	tblProjTaskOpts pto
		GROUP BY pto.ProjTaskId
	) nf ON nf.ProjTaskId = prtsk.ProjTaskId
WHERE	prtsk.First <> nf.First
	OR prtsk.Frequency <> nf.Frequency

--VV CR8035
INSERT INTO PROJ_TASK_DOCUMENT(ProjTaskId,WorkScopeDocumentId)
SELECT NwId.Rec_Id AS ProjTaskId, PTD.WorkScopeDocumentId
FROM  
PROJ_TASK_DOCUMENT PTD
	INNER JOIN
#OLD_ID1 OldId 
	ON PTD.ProjTaskId=OldId.Rec_Id
	INNER JOIN 
#NEW_ID1 NwId 
	ON OldId.Rec_No=NwId.Rec_No

INSERT INTO PROJ_TASK_EXTERNAL_DOCUMENT(ProjTaskId, DocumentLink, DocumentName)
SELECT NwId.Rec_Id AS ProjTaskId, PTD.DocumentLink, PTD.DocumentName
FROM         
PROJ_TASK_EXTERNAL_DOCUMENT PTD
	INNER JOIN
#OLD_ID1 OldId 
	ON PTD.ProjTaskId=OldId.Rec_Id
	INNER JOIN 
#NEW_ID1 NwId 
	ON OldId.Rec_No=NwId.Rec_No


INSERT INTO #OLD_ID2(Rec_Id)
SELECT	pto.ProjTaskOptId
FROM	tblProjTaskOpts pto
	INNER JOIN #OLD_ID1 OldId ON OldId.Rec_Id = pto.ProjTaskId
	INNER JOIN #NEW_ID1 NwId ON NwId.Rec_No = OldId.Rec_No
ORDER BY pto.ProjTaskOptId

INSERT INTO #NEW_ID2(Rec_Id)
SELECT	pto.ProjTaskOptId
FROM	tblProjTaskOpts pto
	INNER JOIN #NEW_ID1 NwId ON NwId.Rec_Id = pto.ProjTaskId
ORDER BY pto.ProjTaskOptId

PRINT 'Update PlanTaskOptId in ProjTask'
UPDATE	prtskNew
SET		PlanTaskOptId = 
			CASE WHEN @RolloverOpt=@RolloverOptSetNext AND @ToCurrentProj=1 AND prtskRollover.PlanUseCalc=0 
				THEN ptoRolloverNew.ProjTaskOptId
				ELSE CASE WHEN @CopyOccData = 1 THEN ptoNewId.Rec_Id ELSE NULL END 
			END
FROM	tblProjTasks prtskNew
		INNER JOIN #NEW_ID1 prtskNewId ON prtskNewId.Rec_Id = prtskNew.ProjTaskId
		INNER JOIN #OLD_ID1 prtskOldId ON prtskOldId.Rec_No = prtskNewId.Rec_No
		INNER JOIN tblProjTasks prtskOld ON prtskOldId.Rec_Id = prtskOld.ProjTaskId
		LEFT JOIN #OLD_ID2 ptoOldId ON ptoOldId.Rec_Id = prtskOld.PlanTaskOptId
		LEFT JOIN #NEW_ID2 ptoNewId ON ptoNewId.Rec_No = ptoOldId.Rec_No
		LEFT JOIN tblProjTasks prtskRollover ON prtskRollover.EqpProjId=@EqpProjRol 
						AND prtskRollover.Task_Header_Id=prtskNew.Task_Header_Id
						AND ISNULL(prtskRollover.UsageQUOMId,0) = ISNULL(prtskNew.UsageQUOMId,0)
		LEFT JOIN tblProjTaskOpts ptoRollover ON prtskRollover.PlanTaskOptId = ptoRollover.ProjTaskOptId
		LEFT JOIN tblProjTaskOpts ptoRolloverNew ON ptoRolloverNew.ProjTaskId = prtskNew.ProjTaskId
													AND ptoRollover.OccurrenceTypeId = ptoRolloverNew.OccurrenceTypeId
WHERE
		CASE WHEN @RolloverOpt=@RolloverOptSetNext AND @ToCurrentProj=1 AND prtskRollover.PlanUseCalc=0 
			THEN ptoRolloverNew.ProjTaskOptId
			ELSE CASE WHEN @CopyOccData = 1 THEN ptoNewId.Rec_Id ELSE NULL END 
		END IS NOT NULL


PRINT 'Update ProjTaskAmt'

DECLARE @Filter_Std_Job_Model BIT
SELECT TOP 1 @Filter_Std_Job_Model = Filter_Std_Job_Model FROM AMT_VARIABLE

INSERT INTO tblProjTaskAmts (
	ProjTaskOptId,
	PricedJobId, JobCodeId, PerformedAtSiteId, 
	PartTypeId, LaborShare, 
	CurrencyId, LaborCost, PartsCost, 
	MiscCost, LaborHours, Duration, Next_Occ_Part_Location_Id,
	Labour_Cost_Expense_Id, Misc_Cost_Expense_Id, Parts_Cost_Expense_Id,
	Pricing_Date, Cost_Bearer_ID, labour_Activity_Id,
	Crane_Cost, Pct_Freight, Avg_Daily_Work_Hrs, Avg_No_People, 
	Avg_Travel_Hrs, Travel_Distance, Travel_Recovery_Rate_L, Travel_Recovery_Rate_V,
	Misc_Trip_Cost, Labour_Hrs_Field,Parts_EDC_ID,Labour_EDC_ID,Misc_EDC_ID,Cost_Centre_Id,
	Rotable_Repair_Strategy, Action_Required_Id, Rebuild_Location_Id,
	Work_Group_Id, Health_Safety_Id,QtyVolume,PercentTopUp,UnitPrice,Consumable,StdJobPartsMargin)
SELECT	NwId.Rec_Id as ProjTaskOptId,
	CASE	WHEN @KeepLinkToStdJob = 0
		THEN NULL
		WHEN eqp.EquipmentId IS NULL AND @Filter_Std_Job_Model = 1 THEN NULL 
		ELSE pjNew.PricedJobId
	END AS PricedJobId,

	pta.JobCodeId,
	pta.PerformedAtSiteId,
	pta.PartTypeId, pta.LaborShare,
	pta.CurrencyId, 

	CASE @EscCosts WHEN 1 THEN ceCur.CumLaborEscalation/ceNew.CumLaborEscalation ELSE 1.00 END *pta.LaborCost
	AS LaborCost,

	CASE	
	/*VV 15 feb 08 Discussed with GE. Do not escalate parts cost if consumable, just copy it across.
	We don't change unit price, qty, top up pct.*/
	WHEN pta.Consumable=1 THEN 1.00
	WHEN @EscCosts =1 THEN cpeCur.CumPartsEscalation/cpeNew.CumPartsEscalation ELSE 1.00 END *pta.PartsCost
	AS PartsCost,

	CASE @EscCosts WHEN 1 THEN ceCur.CumMiscEscalation/ceNew.CumMiscEscalation ELSE 1.00 END *pta.MiscCost
	AS MiscCost,

	pta.LaborHours,
	pta.Duration,
	st.SiteId as Next_Occ_Part_Location_Id,
	pta.Labour_Cost_Expense_Id,
	pta.Misc_Cost_Expense_Id,
	pta.Parts_Cost_Expense_Id,

	CASE WHEN @NewEquipment=1 AND @LeavePricingDate=0 AND @NewPricingDate IS NOT NULL THEN @NewPricingDate
		 ELSE pta.Pricing_Date
	END AS Pricing_Date,

	pta.Cost_Bearer_Id,

	pta.Labour_Activity_Id,

	/*VV Discussed with GE&RF. Do not escalate crane cost, just copy it across.*/
	pta.Crane_Cost,
	pta.Pct_Freight, 
	pta.Avg_Daily_Work_Hrs, 
	pta.Avg_No_People, 
	pta.Avg_Travel_Hrs, 
	pta.Travel_Distance, 
	pta.Travel_Recovery_Rate_L, 
	pta.Travel_Recovery_Rate_V,
	/*VV Discussed with GE&RF. Do not escalate misc trip cost, just copy it across.*/
	pta.Misc_Trip_Cost, 
	pta.Labour_Hrs_Field,
	pta.Parts_EDC_ID,
	pta.Labour_EDC_ID,
	pta.Misc_EDC_ID,
	
	pta.Cost_Centre_Id,
	CASE WHEN rpmepr.EqpProjId IS NOT NULL THEN pta.Rotable_Repair_Strategy ELSE 0 END AS Rotable_Repair_Strategy,
	CASE WHEN rpmepr.EqpProjId IS NOT NULL THEN pta.Action_Required_Id ELSE NULL END AS Action_Required_Id, 
	CASE WHEN rpmepr.EqpProjId IS NOT NULL THEN pta.Rebuild_Location_Id ELSE NULL END AS Rebuild_Location_Id,

	pta.Work_Group_Id,
	
	pta.Health_Safety_Id,
	pta.QtyVolume,pta.PercentTopUp,pta.UnitPrice,pta.Consumable,pta.StdJobPartsMargin
FROM	tblProjTaskAmts pta
	INNER JOIN #OLD_ID2 OldId ON OldId.Rec_Id = pta.ProjTaskOptId
	INNER JOIN #NEW_ID2 NwId ON NwId.Rec_No = OldId.Rec_No
	LEFT JOIN tblEqpProjs eprFr ON eprFr.EqpProjId = @fromEqpProjId
	LEFT JOIN tblProjTaskOpts pto ON pto.ProjTaskOptId = NwId.Rec_Id
	LEFT JOIN tblProjTasks prtsk ON prtsk.ProjTaskId = pto.ProjTaskId
	LEFT JOIN tblEqpProjs epr ON epr.EqpProjId = prtsk.EqpProjId
	LEFT JOIN tblEqpPlans epl ON epl.EqpPlanId = epr.EqpPlanId
	LEFT JOIN tblFleets fl ON fl.FleetId = epl.FleetId
	LEFT JOIN tblSites st ON st.SiteId = fl.SiteId
	LEFT JOIN tblPricedJobs pjCur ON pjCur.PricedJobId= pta.PricedJobId
	LEFT JOIN tblPricedJobs pjNew ON pjNew.StdJobId=pjCur.StdJobId AND pjNew.Currency_ID=pjCur.Currency_Id
					AND pjNew.BranchId = st.BranchId
					AND pjNew.Price_Group_Id = fl.Price_Group_ID
	LEFT JOIN tblStdJobs sjNew ON pjNew.StdJobId = sjNew.StdJobId AND pjNew.Currency_ID = sjNew.Currency_ID
	LEFT JOIN tblEquipment eqp ON epl.EquipmentId = eqp.EquipmentId AND sjNew.ModelId = eqp.ModelId
	LEFT JOIN (ROTABLE_PART_MODEL rpm 
		INNER JOIN tblEquipment rpmeqp ON rpmeqp.ModelId = rpm.Model_Id
		INNER JOIN tblEqpPlans rpmepl ON rpmepl.EquipmentId = rpmeqp.EquipmentId
		INNER JOIN tblEqpProjs rpmepr ON rpmepr.EqpPlanId = rpmepl.EqpPlanId AND rpmepr.EqpProjId = @toEqpProjID
	) ON prtsk.Rotable_Part_Id = rpm.Rotable_Part_Id
	LEFT JOIN tblCostBearers cbDef ON cbDef.Default_Value=1 -- epl.Default_Cost_Bearer_ID
	LEFT JOIN tblJobCodes jcDef ON jcDef.Default_Record=1
	LEFT JOIN tblCostEscalations ceCur ON ceCur.EscalationDate <= pta.Pricing_Date -- @oldTaskPricingDate
						AND ceCur.EndDate > pta.Pricing_Date -- @oldTaskPricingDate
	LEFT JOIN tblCostPartsEscalations cpeCur ON ceCur.CostEscalationId =cpeCur.CostEscalationId
						AND cpeCur.ManufacturerId= prtsk.ManufacturerId
	LEFT JOIN tblCostEscalations ceNew ON ceNew.EscalationDate <= @NewPricingDate
						AND ceNew.EndDate > @NewPricingDate
	LEFT JOIN tblCostPartsEscalations cpeNew ON ceNew.CostEscalationId =cpeNew.CostEscalationId
						AND cpeNew.ManufacturerId= prtsk.ManufacturerId

ORDER BY pta.ProjTaskAmtId


TRUNCATE TABLE #NEW_ID1
TRUNCATE TABLE #OLD_ID1

INSERT INTO #OLD_ID1(Rec_Id)
SELECT	pta.ProjTaskAmtId
FROM	tblProjTaskAmts pta
	INNER JOIN #OLD_ID2 OldId ON OldId.Rec_Id = pta.ProjTaskOptId
	INNER JOIN #NEW_ID2 NwId ON NwId.Rec_No = OldId.Rec_No
ORDER BY pta.ProjTaskAmtId

INSERT INTO #NEW_ID1(Rec_Id)
SELECT	pta.ProjTaskAmtId
FROM	tblProjTaskAmts pta
	INNER JOIN #NEW_ID2 NwId ON NwId.Rec_Id = pta.ProjTaskOptId
ORDER BY pta.ProjTaskAmtId


DECLARE @SystemSourceAMT int
SET @SystemSourceAMT=1

IF EXISTS(SELECT CA.Cost_Allocation_Id FROM 
	COST_ALLOCATION CA
		INNER JOIN
	tblProjTaskAmts PTA
		ON CA.Proj_Task_Amt_Id=PTA.ProjTaskAmtId
		INNER JOIN
	tblProjTaskOpts PTO
		ON PTA.ProjTaskOptId=PTA.ProjTaskOptId
		INNER JOIN
	tblProjTasks PT
		ON PTO.ProjTaskId=PT.ProjTaskId
	WHERE PT.EqpProjid=@fromEqpProjId)
BEGIN
	
	SELECT @NewModelId=ModelId FROM
	tblEqpProjs EPR
		INNER JOIN
	tblEqpPlans EP
		ON EPR.EqpPlanId=EP.EqpPlanId
		INNER JOIN
	tblEquipment E
		ON EP.EquipmentId=E.EquipmentId
	WHERE EPR.EqpProjId=@toEqpProjID

	--COST_ALLOCATION_PROJ_TASK_AMT_LINK_P
	INSERT INTO COST_ALLOCATION(
		Cost_Allocation_Ref, Currency_Id, System_Source_Id, Component_Code_Id, 
		Model_Id, Create_Date, Last_Mod_Date, Proj_Task_Amt_Id, Eqp_Plan_Id,ModifierId)
	SELECT	cal.Cost_Allocation_Ref, cal.Currency_Id, @SystemSourceAMT AS System_Source_Id, 
	cal.Component_Code_Id, @NewModelId AS Model_Id, GETDATE() AS Create_Date, GETDATE() AS Last_Mod_Date, 
	NwId.Rec_Id AS Proj_Task_Amt_Id, @toEqpPlanId AS Eqp_Plan_Id,cal.ModifierId
	FROM	
	COST_ALLOCATION cal
		INNER JOIN
	tblProjTaskAmts pta
		ON cal.Proj_task_amt_id=pta.ProjTaskAmtId
		INNER JOIN 
	#OLD_ID1 OldId 
		ON OldId.Rec_Id = pta.ProjTaskAmtId
		INNER JOIN 
	#NEW_ID1 NwId 
		ON OldId.Rec_No=NwId.Rec_No


	INSERT INTO COST_ALLOCATION_DETAIL(
		Cost_Allocation_Id, Work_Group_Id, Cost_Centre_Id, Parts_Cost_Expense_Id, Labour_Cost_Expense_Id, 
		Misc_Cost_Expense_Id, Cost_Bearer_Id, Parts_Cost, Misc_Cost, Labour_Cost, Labour_Activity_Id, Labour_Hrs, 
		Duration_Hrs, Job_Code_Id, Create_Date, Last_Mod_Date)
	SELECT	calNew.Cost_Allocation_Id AS Cost_Allocation_Id, 
		cald.Work_Group_Id, 
		cald.Cost_Centre_Id, 
		cald.Parts_Cost_Expense_Id, 
		cald.Labour_Cost_Expense_Id, 
		cald.Misc_Cost_Expense_Id, 
		cald.Cost_Bearer_Id, 
		CASE @EscCosts WHEN 1 THEN cpeCur.CumPartsEscalation/cpeNew.CumPartsEscalation ELSE 1.00 END *cald.Parts_Cost AS Parts_Cost,
		CASE @EscCosts WHEN 1 THEN ceCur.CumMiscEscalation/ceNew.CumMiscEscalation ELSE 1.00 END *cald.Misc_Cost AS Misc_Cost,
		CASE @EscCosts WHEN 1 THEN ceCur.CumLaborEscalation/ceNew.CumLaborEscalation ELSE 1.00 END *cald.Labour_Cost AS Labour_Cost,
		cald.Labour_Activity_Id, 
		cald.Labour_Hrs, 
		cald.Duration_Hrs, 	
		cald.Job_Code_Id, 
		GETDATE() AS Create_Date, 
		GETDATE() AS Last_Mod_Date	
	FROM
	
	tblProjTaskAmts ptaOld
		INNER JOIN 
	#OLD_ID1 OldId 
		ON ptaOld.ProjTaskAmtId=OldId.Rec_Id
		INNER JOIN 
	#NEW_ID1 NwId 
		ON OldId.Rec_No=NwId.Rec_No
		INNER JOIN 
	COST_ALLOCATION cal 
		ON ptaOld.ProjTaskAmtId=cal.Proj_Task_Amt_Id
		INNER JOIN 
	COST_ALLOCATION_DETAIL cald 
		ON cal.Cost_Allocation_Id=cald.Cost_Allocation_Id
		INNER JOIN
	COST_ALLOCATION calNew
		ON NwId.Rec_Id=calNew.Proj_Task_Amt_Id
		INNER JOIN
	tblProjTaskAmts ptaNew
		ON NwId.Rec_Id=ptaNew.ProjTaskAmtId
		INNER JOIN
	tblProjTaskOpts ptoNew
		ON ptaNew.ProjTaskOptId=ptoNew.ProjTaskOptId
		INNER JOIN
	tblProjTasks ptNew	
		ON ptoNew.ProjTaskId=ptNew.ProjTaskId
		INNER JOIN 
	tblCostEscalations ceCur 
		ON ceCur.EscalationDate <= ptaOld.Pricing_Date -- @oldTaskPricingDate
		   AND ceCur.EndDate > ptaOld.Pricing_Date -- @oldTaskPricingDate
		INNER JOIN 
	tblCostPartsEscalations cpeCur 
		ON ceCur.CostEscalationId =cpeCur.CostEscalationId
			AND cpeCur.ManufacturerId= ptNew.ManufacturerId
		LEFT JOIN 
	#z_tblCostEscalations_New ceNew 
		ON ptNew.EqpProjId =ceNew.EqpProjId		
		LEFT JOIN 
	tblCostPartsEscalations cpeNew 
		ON ceNew.CostEscalationId =cpeNew.CostEscalationId
		   AND cpeNew.ManufacturerId= ptNew.ManufacturerId
END

DROP TABLE #NEW_ID1
DROP TABLE #OLD_ID1
DROP TABLE #NEW_ID2
DROP TABLE #OLD_ID2



EXEC PRICED_JOB_PROJ_TASK_AMTS_UPDATE_P @EqpProjId=@toEqpProjID

EXEC STRATEGY_TASK_LINK_TO_EQS_TASK_P @EqpProjId = @toEqpProjID


RETURN



GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[MULTI_TASK_EDITOR_TASK_FIELDS_GET_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[MULTI_TASK_EDITOR_TASK_FIELDS_GET_P]
GO

create PROCEDURE [dbo].[MULTI_TASK_EDITOR_TASK_FIELDS_GET_P]
/******************************************************************************
	Name: MULTI_TASK_EDITOR_TASK_FIELDS_GET_P 

	Called By: 

	Desc: Returns data for multi-task editor
             

	Auth: Veronika Vasylyeva
	Date: 1-Apr=2008
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	12/04/12    SD		    E781 - Add PEX fields
	
OLD HISTORY
-----------

	06/04/09	AL			Fixed collation
    31/03/09	AL			CR7965: Added @IsMarketingCustomerSupport
    23/07/2009	KN			Added PerformanceStrategy and Component Structure
    12-Jul-10	V Vasylyeva	CR9019: CBD
     7 Oct 10	V Vasylyeva	E316: PartRating
    04	Apr 11	GW add AutoGenerateWOS
*******************************************************************************/
	/* Param List */

	@SearchText varchar(50)='%',
	@IsMarketingCustomerSupport bit=0

AS

--AL: 31/03/09
CREATE TABLE #MarketingCustomerSupport (Fld varchar(100) COLLATE DATABASE_DEFAULT,FldDesc varchar(100) COLLATE DATABASE_DEFAULT)

IF ISNULL(@IsMarketingCustomerSupport,0)<>0
BEGIN
	INSERT INTO #MarketingCustomerSupport(Fld,FldDesc)
	SELECT Fld,FldDesc FROM
	(
	SELECT 'PctPurchaseNewPart' AS Fld, '% of New Parts Purchase' FldDesc
	UNION ALL
	SELECT 'PctPurchasePart' AS Fld, 'Parts % of Purchase from Dealer' FldDesc
	UNION ALL
	SELECT 'PctPurchaseLabour' AS Fld, 'Labour % of Purchase from Dealer' FldDesc
	UNION ALL
	SELECT 'PctPurchaseMisc' AS Fld, 'Misc % of Purchase from Dealer' FldDesc
	UNION ALL
	SELECT 'SalesResponsibility' AS Fld, 'Sales Responsibility' FldDesc
	)A
END



SELECT Fld,FldDesc FROM
(
SELECT 'Description' AS Fld, 'Description' FldDesc
UNION ALL
SELECT 'Task_Mode' AS Fld, 'Task Mode' FldDesc
UNION ALL
SELECT 'Planning_Lead_Time' AS Fld, 'Planning Lead Time' FldDesc
UNION ALL
SELECT 'Operational_Criticality' AS Fld, 'Operational Criticality' FldDesc
UNION ALL
SELECT 'Manufacturer' AS Fld, 'Manufacturer' FldDesc
UNION ALL
SELECT 'Primary_Part_Number' AS Fld, 'Primary Part Number' FldDesc
UNION ALL
SELECT 'Group_Number' AS Fld, 'Group Number' FldDesc
UNION ALL
SELECT 'Warranty_Days' AS Fld, 'Warranty Days' FldDesc
UNION ALL
SELECT 'Warranty_Usage' AS Fld, 'Warranty Usage' FldDesc
UNION ALL
SELECT 'Date_Based' AS Fld, 'Date Based' FldDesc
UNION ALL
SELECT 'UOM' AS Fld, 'UOM' FldDesc
UNION ALL
SELECT 'First_Occurrence' AS Fld, 'First Occurrence' FldDesc
UNION ALL
SELECT 'Frequency' AS Fld, 'Frequency' FldDesc
UNION ALL
SELECT 'Not_After' AS Fld, 'Not After' FldDesc
UNION ALL
SELECT 'Performance_Strategy' AS Fld, 'Performance Strategy' FldDesc
UNION ALL
SELECT 'Component_Structure' AS Fld, 'Component Structure' FldDesc
UNION ALL
/*VV CR9019*/
SELECT 'CBDTask' AS Fld, 'CBD' FldDesc
/*VV E316*/
UNION ALL
SELECT 'PartRating' AS Fld, 'Rating' FldDesc
--AL: 31/03/09
UNION ALL
SELECT 'AutoGenerateWOS' AS Fld, 'Auto Generate WOS' FldDesc
/*SD E781 */
UNION ALL
SELECT 'DefaultLocationForRebuild' AS Fld, 'Default Location For Rebuild' FldDesc
UNION ALL
SELECT 'PartClassification' AS Fld, 'Part Classification' FldDesc
--GW
UNION ALL
SELECT Fld,FldDesc FROM #MarketingCustomerSupport
) A
WHERE FldDesc LIKE @SearchText

DROP TABLE #MarketingCustomerSupport



GO


if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[PROJ_TASK_MULTI_UPDATE_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[PROJ_TASK_MULTI_UPDATE_P]
GO


create       PROCEDURE [dbo].[PROJ_TASK_MULTI_UPDATE_P]
/******************************************************************************
	File: 
	Name: PROJ_TASK_MULTI_UPDATE_P

	Called By: Multi-Task Summary Editor

	Desc: Updates data for projected tasks
             

	Auth: Veronika Vasylyeva
	Date: 20-Apr-2005
*******************************************************************************
		Change History
*******************************************************************************
Date:		Author:		Description:
--------	--------	----------------------------------------
12-Apr-12   SD		    E781 - Add PEX fields
 7 Oct 10	V Vasylyeva	E316: PartRating
12-Jul-10	V Vasylyeva	CR9019: CBD
11 Jan 10   KN			CR8693: Delete RR Task before updating the TASK.
 8 Dec 09	V Vasylyeva	CR8601: Duration is updated to labour hours
27 Aug 09	KN			Included Std Job/ Component Strucuture
27 May 09	AL			CR8180: Marketing fields: can save 0
15 May 09	V Vasylyeva	CR7824: Always save planning lead time
31 Mar 09	AL			CR7965: added new fields
23 Oct 08	V vasylyeva	pricing date must be less or equal current date
 8 Oct 08	V Vasylyeva CR7410 - duplicate task headers
26 Aug 08	V Vasylyeva	Changed PROJ_TASK_BUSINESS_RULES_F to include external identifier
13 Jun 08	V Vasylyeva	Added StdJobPartsMargin
11 Jun 08	V Vasylyeva	Changed to update to NULL
11 Apr 08	V Vasylyeva	Changed for bulk update and new requirements
21-Jul-07	KN			Fixed - Collation and tempDB Conflicts
27-Jun-07	K Nagarajan	Added InspectionTaskType, InspectionOffset
22 Jan 07	V Vasylyeva	Took out transactions
19 Sep 06	V Vasylyeva	Changes in spec
24 May 06	V Vasylyeva	Took out filtering by equipment type which excluded
				centrelines
24 Feb 06	K Nagarajan	Added Cost Centre
13 Feb 06	K Nagarajan	Fixed update Projected Tasks Amount
13 Feb 06	K Nagarajan	Added Entry Distribution Code Fields to update tblProjTaskAmt table
				Also Fixed the sproc to have "Labour_Hrs_Field" Parameter
20 Dec 05	V Vasylyeva	If @First, @Frequency, @Final,@LaborHours,@Duration,
			        @MiscCost,@PartsCost,@LaborCost=0 - do
				not update these fields
10 Oct 05	S Ivanov	Fixed bug with SchedulingTaskId
23 Sep 05	S Ivanov	Added @SchedulingTaskId
16-Sep-05	V Vasylyeva	Added @PartsCostExpenseID
04-Apr-11   G Wang		Added @AutoGenerateWOS
06-May-11	D Smith		Allow update of the 4 key codes (CC, MC, TT, TC) to zero

*******************************************************************************/

/* Param List */
@taskXML text='',
@UpdateHistory bit=0,
@UpdatePricingDate bit=0,
@Message varchar(8000)='' OUTPUT

AS

DECLARE @hDoc int
DECLARE @CostSourceM int
DECLARE @CostSourceC int
DECLARE @CostSourceS int
DECLARE @LabourTypeF int
DECLARE @LabourTypeS int
DECLARE @TaskModeP int
DECLARE @TaskModeNonP int
DECLARE @DefPlanLeadTime int
DECLARE @ProjTypeBud int
DECLARE @ProjTypeEstCurr int
DECLARE @ProjTypeEstDr int
DECLARE @ProjTypeCurr int
DECLARE @ProjTypeAlt int
DECLARE @PlanStatusUsage int
DECLARE @PlanStatusDate int
DECLARE @SchT_LastPerformedUOM int
DECLARE @SchT_LastScheduledUOM int
DECLARE @SchT_LastPerformedDate int
DECLARE @SchT_LastScheduledDate int
DECLARE @Counter int
DECLARE @MaxMessageLenth int
DECLARE @UpdateTask bit
DECLARE @UpdateOpt bit
DECLARE @UpdateJob bit
DECLARE @ProjTaskUpdate varchar(max)
DECLARE @NoneId int

SET @MaxMessageLenth=8000


SET @SchT_LastPerformedUOM=1
SET @SchT_LastScheduledUOM=2
SET @SchT_LastPerformedDate=3
SET @SchT_LastScheduledDate=4

SET @NoneId=-1

SET @ProjTaskUpdate=''

SET @CostSourceM= 1
SET @CostSourceC=2
SET @CostSourceS = 3
SET @LabourTypeF= 1
SET @LabourTypeS=2
SET @TaskModeP= 1
SET @TaskModeNonP=2

SET @ProjTypeCurr=1
SET @ProjTypeBud=2
SET @ProjTypeAlt=3
SET @ProjTypeEstCurr=6
SET @ProjTypeEstDr=7

SET @DefPlanLeadTime=30

SET @PlanStatusUsage=1
SET @PlanStatusDate=2


CREATE TABLE #z_MTE_TASK(
	MTEId int DEFAULT 1,
	[Component_Code] int,
	[Modifier_Code] int,
	[Task_Type] int,
	[Task_Counter] int,
	[Description] varchar(100) COLLATE DATABASE_DEFAULT,
	[Task_Mode] int,
	[Planning_Lead_Time] int,
	[Operational_Criticality] int,
	[Manufacturer] int,
	[Primary_Part_Number] int,
	[Group_Number] varchar(50) COLLATE DATABASE_DEFAULT,
	[Warranty_Days] float,
	[Warranty_Usage] float,
	[UOM] int,
	[First_Occurrence] float,
	[Frequency] float,
	[Not_After] float,
	[Date_Based] bit,
	[Task_Cost] float,
	[Job_Code] int,
	[Currency] int ,
	[Cost_Source] int,
	[Cost_Bearer] int,
	[Cost_Centre] int,
	[Work_Group] int,
	[Part_Type] int,
	[OH&S] int,
	[Pricing_Date] datetime,
	[Consumable_Qty] float ,
	[Consumable_Top_Up_%] float ,
	[Consumable_Price] float ,
	[Job_Parts_Cost] float ,
	[Job_Labour_Cost] float ,
	[Job_Misc_Cost] float ,
	[Parts_Exp_Element] int,
	[Labour_Exp_Element] int,
	[Misc_Exp_Element] int,
	[Parts_EDC] int,
	[Labour_EDC] int,
	[Misc_EDC] int,
	[Labour_Type] int,
	[Job_Labour_Hours] float ,
	[Labour_Activity] int,
	[Job_Duration] float ,
	--AL: 31/03/09
	PctPurchasePart float ,
	PctPurchaseLabour float ,
	PctPurchaseMisc float ,
	PctPurchaseNewPart float ,
	SalesResponsibility int,
	Performance_Strategy int,
	Component_Structure int,
	Standard_Job int,
	/*VV CR9019*/
	CBDTask bit,
	/*VV E316*/
	PartRating int,
	/*GW*/
	AutoGenerateWOS bit,
	/*E781*/
	DefaultLocationForRebuild int,
	PartClassification int
	PRIMARY KEY(MTEId)
) 

CREATE TABLE #z_TASK_ID(ProjTaskId int,ProjTaskAmtId int PRIMARY KEY(ProjTaskId,ProjTaskAmtId))

EXEC sp_xml_preparedocument @hDoc OUTPUT, @taskXML 


INSERT INTO #z_MTE_TASK(
[Component_Code],[Modifier_Code],[Task_Type],[Task_Counter],[Description],[Task_Mode],[Planning_Lead_Time],[Operational_Criticality],
[Manufacturer],[Primary_Part_Number],[Group_Number],[Warranty_Days],[Warranty_Usage],[UOM],[First_Occurrence],
[Frequency],[Not_After],[Date_Based],[Task_Cost],[Job_Code],[Currency],[Cost_Source],[Cost_Bearer],[Cost_Centre],
[Work_Group],[Part_Type],[OH&S],[Pricing_Date],[Consumable_Qty] ,[Consumable_Top_Up_%] ,[Consumable_Price] ,[Job_Parts_Cost] ,
[Job_Labour_Cost] ,[Job_Misc_Cost] ,[Parts_Exp_Element],[Labour_Exp_Element],[Misc_Exp_Element],[Parts_EDC],
[Labour_EDC],[Misc_EDC],[Labour_Type],[Job_Labour_Hours] ,[Labour_Activity],[Job_Duration],
--AL: 31/03/09
PctPurchasePart,PctPurchaseLabour,PctPurchaseMisc,PctPurchaseNewPart,SalesResponsibility,
Performance_Strategy,Component_Structure,Standard_Job ,/*VV CR9019*/CBDTask,/*VV E316*/PartRating,/*GW*/AutoGenerateWOS,
/*E781*/DefaultLocationForRebuild, PartClassification)

SELECT
[Component_Code],[Modifier_Code],[Task_Type],[Task_Counter],[Description],[Task_Mode],

CASE [Task_Mode] 
WHEN @TaskModeP THEN ISNULL([Planning_Lead_Time],@DefPlanLeadTime)
WHEN @TaskModeNonP THEN 0 
ELSE [Planning_Lead_Time] END AS [Planning_Lead_Time],

[Operational_Criticality],
[Manufacturer],[Primary_Part_Number],[Group_Number],[Warranty_Days],[Warranty_Usage],[UOM],[First_Occurrence],
[Frequency],[Not_After],[Date_Based],[Task_Cost],[Job_Code],[Currency],[Cost_Source],[Cost_Bearer],[Cost_Centre],
[Work_Group],[Part_Type],[OH&S],[Pricing_Date],[Consumable_Qty] ,[Consumable_Top_Up_%] ,[Consumable_Price] ,[Job_Parts_Cost] ,
[Job_Labour_Cost] ,[Job_Misc_Cost] ,[Parts_Exp_Element],[Labour_Exp_Element],[Misc_Exp_Element],[Parts_EDC],
[Labour_EDC],[Misc_EDC],[Labour_Type],[Job_Labour_Hours] ,[Labour_Activity],[Job_Duration] ,
--AL: 31/03/09
PctPurchasePart,PctPurchaseLabour,PctPurchaseMisc,PctPurchaseNewPart,SalesResponsibility,
Performance_Strategy,Component_Structure,Standard_Job,/*VV CR9019*/CBDTask,/*VV E316*/PartRating,/*GW*/AutoGenerateWOS,
/*E781*/DefaultLocationForRebuild, PartClassification

FROM  OPENXML (@hDoc,'/DS_MTE/TBL_VAL',2) WITH #z_MTE_TASK

INSERT INTO #z_TASK_ID(ProjTaskId,ProjTaskAmtId)
SELECT ProjTaskId,ISNULL(ProjTaskAmtId,0) AS ProjTaskAmtId
FROM  OPENXML (@hDoc,'/DS_MTE/TBL_T',2) WITH #z_TASK_ID

EXEC sp_xml_removedocument @hDoc

--drop table z_MTE_TASK,z_TASK_ID
--SELECT * into z_MTE_TASK FROM #z_MTE_TASK
--select * into z_TASK_ID from #z_TASK_ID
--return


SET @UpdateTask=0
SET @UpdateOpt=0
SET @UpdateJob=0

IF EXISTS(SELECT MTEId FROM #z_MTE_TASK WHERE
--[Component_Code] >0 OR [Modifier_Code] IS NOT NULL OR [Task_Type]>0 OR [Task_Counter]IS NOT NULL OR
[Component_Code] IS NOT NULL OR [Modifier_Code] IS NOT NULL OR [Task_Type] IS NOT NULL OR [Task_Counter] IS NOT NULL OR
[Description] IS NOT NULL OR [Task_Mode]>0 OR [Planning_Lead_Time]>=0 OR [Operational_Criticality] IS NOT NULL OR
[Manufacturer]>0 OR [Primary_Part_Number] IS NOT NULL OR [Group_Number] IS NOT NULL OR [Warranty_Days]>=0 OR
[Warranty_Usage]>=0 OR [UOM]>0 OR [Not_After]>=0 OR [Date_Based] IS NOT NULL OR [First_Occurrence]>=0 OR 
[Frequency]>0 
--AL: 31/03/09, 27/05/09
OR PctPurchasePart>=0 OR PctPurchaseLabour>=0 OR PctPurchaseMisc>=0 OR PctPurchaseNewPart>=0 OR SalesResponsibility IS NOT NULL 
OR Performance_Strategy IS NOT NULL 
OR Component_Structure IS NOT NULL 
/*VV CR9019*/ OR CBDTask IS NOT NULL
/*VV E316*/OR PartRating IS NOT NULL
/*GW*/ OR AutoGenerateWOS IS NOT NULL
/*E781*/OR DefaultLocationForRebuild IS NOT NULL OR PartClassification IS NOT NULL
)
BEGIN
	SET @UpdateTask=1
END

IF EXISTS(SELECT MTEId FROM #z_MTE_TASK WHERE [First_Occurrence]>=0 OR [Frequency]>0)
BEGIN
	SET @UpdateOpt=1
END


IF EXISTS(SELECT MTEId FROM #z_MTE_TASK WHERE
Job_Code IS NOT NULL OR Currency>0 OR Cost_Source>0 OR Cost_Bearer>0 OR Cost_Centre IS NOT NULL OR Work_Group IS NOT NULL OR 
Part_Type IS NOT NULL OR [OH&S] IS NOT NULL OR Pricing_Date IS NOT NULL OR  Consumable_Qty IS NOT NULL OR
[Consumable_Top_Up_%] IS NOT NULL OR Consumable_Price IS NOT NULL OR Job_Parts_Cost IS NOT NULL OR 
Job_Labour_Cost IS NOT NULL OR Job_Misc_Cost IS NOT NULL OR  Parts_Exp_Element IS NOT NULL OR  Labour_Exp_Element IS NOT NULL OR  
Misc_Exp_Element IS NOT NULL OR  Parts_EDC IS NOT NULL OR  Labour_EDC IS NOT NULL OR  Misc_EDC IS NOT NULL OR  
Labour_Type>0 OR  Job_Labour_Hours IS NOT NULL OR  
Labour_Activity IS NOT NULL OR Job_Duration IS NOT NULL OR Standard_Job IS NOT NULL)
BEGIN
	SET @UpdateJob=1
END


IF @UpdateTask=0 AND @UpdateOpt=0 AND @UpdateJob=0
BEGIN
	RETURN
END

CREATE TABLE #z_ProjTaskUpdate(ProjTaskId int ,EqpProjId int,EqpPlanId int,
ComponentCodeId int, ModifierId int,TaskTypeId int,ApplicationCodeId int,Task_Description varchar(100) COLLATE DATABASE_DEFAULT,
Schedule_Type_Id int,InspectionTaskTypeId int,InspectionOffset float,Scheduling_Group_Id int,Scheduling_Group_Counter int,
ExternalIdentifier varchar(50) COLLATE DATABASE_DEFAULT,SchedulingTaskId int,Planning_Task bit,Planning_Lead_Time int,
Operational_Criticality_Id int,ManufacturerId int,Part_Id int,Group_Number varchar(50) COLLATE DATABASE_DEFAULT,
Warranty_Period_Days float,Warranty_Period_Usage float,Last_Change_Usage float,Last_Change_Date datetime,
UsageQUOMId int,[First] float,Frequency float,Final float,Last_Mod_Date datetime,
ComponentCodeIdOld int, ModifierIdOld int,TaskTypeIdOld int,ApplicationCodeIdOld int,Task_Header_Id int,
--AL: 31/03/09
PctPurchasePart float ,PctPurchaseLabour float ,PctPurchaseMisc float ,PctPurchaseNewPart float ,
SalesResponsibilityID int, Maintenance_Strategy_Id int,RCMComponentStructureId int,/*VV CR9019*/CBDTask bit,
/*VV E316*/PartRatingId int,/*GW*/AutoGenerateWOS bit,
/*E781*/DefaultLocationForRebuild int, PartClassification int

PRIMARY KEY(ProjTaskId))

CREATE TABLE #z_Message(EqpProjId int,ProjTaskId int,ProjTaskAmtId int default 0, Msg varchar(1000) PRIMARY KEY(ProjTaskId,ProjTaskAmtId))

/*drop table z_MTE_TASK,z_TASK_Id
SELECT * into z_TASK_Id from #z_TASK_Id
SELECT * into z_MTE_TASK from #z_MTE_TASK
return*/

IF @UpdateJob=1 AND EXISTS(SELECT MTEId FROM #z_MTE_TASK WHERE Job_Code IS NOT NULL OR Currency>0)
BEGIN
	DECLARE @CheckCostSource bit
	SELECT @CheckCostSource=CASE WHEN Cost_Source IN(@CostSourceM,@CostSourceC) THEN 0 ELSE 1 END FROM #z_MTE_TASK

	SET @CheckCostSource=ISNULL(@CheckCostSource,0)

--select @CheckCostSource return
	
	INSERT  INTO #z_Message(EqpProjId,ProjTaskId,ProjTaskAmtId)
	SELECT PT.EqpProjId,PT.ProjTaskId,MAX(PTA.ProjTaskAmtId) AS ProjTaskAmtId
	FROM
	tblProjTasks PT
		INNER JOIN
	tblProjTaskOpts PTO
		ON PT.ProjTaskId=PTO.ProjTaskId
		INNER JOIN
	tblProjTaskAmts	PTA
		ON PTO.ProjTaskOptId=PTA.ProjTaskOptId
		LEFT JOIN
	COST_ALLOCATION CA
		ON PTA.ProjTaskAmtId=CA.Proj_Task_Amt_Id
		LEFT JOIN
	SYSTEM_SOURCE SS
		ON CA.System_Source_Id=SS.System_Source_Id
		LEFT JOIN
	( SELECT I.ProjTaskAmtId,MTE.Job_Code,MTE.Currency FROM #z_TASK_Id I CROSS JOIN #z_MTE_TASK MTE) T
		ON PTA.ProjTaskAmtId=T.ProjTaskAmtId
		CROSS JOIN
	COST_ALLOCATION_CONFIGURATION CAC
	WHERE 
	PT.ProjTaskId IN(SELECT ProjTaskId FROM #z_TASK_ID) AND
	(@CheckCostSource=0 OR (PTA.PricedJobId IS NULL AND (CA.Proj_Task_Amt_Id IS NULL OR SS.AmtSystemSource=1 OR (SS.AmtSystemSource=0 AND CAC.JobCode=1))))
	
	GROUP BY PT.EqpProjId,PT.ProjTaskId,
	NULLIF(ISNULL(T.Job_Code,PTA.JobCodeId),@NoneId),ISNULL(T.Currency,PTA.CurrencyId)
	HAVING COUNT(PTA.ProjTaskAmtId)>1

	

	IF EXISTS(SELECT EqpProjId FROM #z_Message)
	BEGIN
		SET @Message=''

		SELECT @Message=@Message+CASE WHEN LEN(@Message)<@MaxMessageLenth THEN EP.EqpPlan+': '+EPR.EqpProjName+': '+TH.Description+
': There is duplicate selection of Currency and Job Code		
' ELSE '' END
		FROM 
		tblEqpPlans EP
			INNER JOIN
		tblEqpProjs EPR
			ON EP.EqpPlanId=EPR.EqpPlanId
			INNER JOIN
		#z_Message M
			ON EPR.EqpProjId=M.EqpProjId
			INNER JOIN
		tblProjTasks PT
			ON M.ProjTaskId=PT.ProjTaskId
			INNER JOIN
		TASK_HEADER TH
			ON PT.Task_Header_Id=TH.Task_Header_Id
		ORDER BY EP.EqpPlan,EPR.EqpProjName,TH.Description
		RETURN
	END

END
 
IF @UpdateJob=1 AND EXISTS(SELECT MTEId FROM #z_MTE_TASK WHERE (Standard_Job IS NOT NULL AND ISNULL(Cost_Source,0) <> @CostSourceS) OR ( ISNULL(Cost_Source,0) =  @CostSourceS AND ISNULL(Standard_Job,0) = 0) )
BEGIN
	 SET @Message='In order to update Standard Job, the Cost Source should be set to ''Standard Job'' and a Standard job should be selected.'
	 RETURN
END
 
IF @UpdateTask=1 AND EXISTS(SELECT MTEId FROM #z_MTE_TASK WHERE (Component_Structure IS NOT NULL AND ISNULL(Performance_Strategy,0) <> 1))
BEGIN
	 SET @Message='In order to update Component Structure, the Performance Strategy should be set to ''On Condition'' and a Component Structure should be selected.'
	 RETURN
END
-- Task with Multiple jobs 
IF @UpdateJob=1 AND EXISTS(SELECT MTEId FROM #z_MTE_TASK WHERE Standard_Job IS NOT NULL)
BEGIN
 
	
	INSERT  INTO #z_Message(EqpProjId,ProjTaskId,ProjTaskAmtId)
	SELECT PT.EqpProjId,PT.ProjTaskId,MAX(PTA.ProjTaskAmtId) AS ProjTaskAmtId
	FROM
	tblProjTasks PT
		INNER JOIN
	tblProjTaskOpts PTO
		ON PT.ProjTaskId=PTO.ProjTaskId
		INNER JOIN
	tblProjTaskAmts	PTA
		ON PTO.ProjTaskOptId=PTA.ProjTaskOptId
	 
	WHERE 
	PT.ProjTaskId IN(SELECT ProjTaskId FROM #z_TASK_ID)	
	GROUP BY PT.EqpProjId,PT.ProjTaskId 
 	HAVING COUNT(PTA.ProjTaskAmtId)>1

	

	IF EXISTS(SELECT EqpProjId FROM #z_Message)
	BEGIN
		SET @Message=''

		SELECT @Message=@Message+CASE WHEN LEN(@Message)<@MaxMessageLenth THEN EP.EqpPlan+': '+EPR.EqpProjName+': '+TH.Description+
': Cannot link same standard job to all the jobs in a Task.		
' ELSE '' END
		FROM 
		tblEqpPlans EP
			INNER JOIN
		tblEqpProjs EPR
			ON EP.EqpPlanId=EPR.EqpPlanId
			INNER JOIN
		#z_Message M
			ON EPR.EqpProjId=M.EqpProjId
			INNER JOIN
		tblProjTasks PT
			ON M.ProjTaskId=PT.ProjTaskId
			INNER JOIN
		TASK_HEADER TH
			ON PT.Task_Header_Id=TH.Task_Header_Id
		ORDER BY EP.EqpPlan,EPR.EqpProjName,TH.Description
		RETURN
	END

END

-- Unassigned Task
IF @UpdateJob=1 AND EXISTS(SELECT MTEId FROM #z_MTE_TASK WHERE Standard_Job IS NOT NULL)
BEGIN
 
	
	INSERT  INTO #z_Message(EqpProjId,ProjTaskId)
	SELECT DISTINCT PT.EqpProjId,PT.ProjTaskId AS ProjTaskAmtId
	FROM
	tblProjTasks PT
		 
	WHERE 
	PT.ProjTaskId IN(SELECT ProjTaskId FROM #z_TASK_ID)	
	AND PT.Unscheduled <> 0
	 
	

	IF EXISTS(SELECT EqpProjId FROM #z_Message)
	BEGIN
		SET @Message=''

		SELECT @Message=@Message+CASE WHEN LEN(@Message)<@MaxMessageLenth THEN EP.EqpPlan+': '+EPR.EqpProjName+': '+TH.Description+
': Cannot link a standard job to unassigned Task.		
' ELSE '' END
		FROM 
		tblEqpPlans EP
			INNER JOIN
		tblEqpProjs EPR
			ON EP.EqpPlanId=EPR.EqpPlanId
			INNER JOIN
		#z_Message M
			ON EPR.EqpProjId=M.EqpProjId
			INNER JOIN
		tblProjTasks PT
			ON M.ProjTaskId=PT.ProjTaskId
			INNER JOIN
		TASK_HEADER TH
			ON PT.Task_Header_Id=TH.Task_Header_Id
		ORDER BY EP.EqpPlan,EPR.EqpProjName,TH.Description
		RETURN
	END

END

IF @UpdateJob=1 AND EXISTS(SELECT MTEId FROM #z_MTE_TASK WHERE Pricing_Date>GETDATE())
BEGIN
	DECLARE @CostSource int
	
	SELECT @CostSource=Cost_Source FROM #z_MTE_TASK

	INSERT  INTO #z_Message(EqpProjId,ProjTaskId)
	SELECT DISTINCT PT.EqpProjId,PT.ProjTaskId
	FROM
	tblProjTasks PT
		INNER JOIN
	tblEqpProjs EPR
		ON PT.EqpProjId=EPR.EqpProjId
		INNER JOIN
	tblProjTaskOpts PTO
		ON PT.ProjTaskId=PTO.ProjTaskId
		INNER JOIN
	tblProjTaskAmts	PTA
		ON PTO.ProjTaskOptId=PTA.ProjTaskOptId
	WHERE 
	PT.ProjTaskId IN(SELECT ProjTaskId FROM #z_TASK_ID) AND
	(EPR.Projection_Type_Id NOT IN(@ProjTypeBud,@ProjTypeEstCurr,@ProjTypeEstDr)) AND
	(@CostSource IN(@CostSourceM,@CostSourceC) OR PTA.PricedJobId IS NULL) AND
	(@UpdatePricingDate=0) AND (PT.AutomaticUpdate=0)

	IF EXISTS(SELECT EqpProjId FROM #z_Message)
	BEGIN
		SET @Message=''

		SELECT @Message=@Message+CASE WHEN LEN(@Message)<@MaxMessageLenth THEN EP.EqpPlan+': '+EPR.EqpProjName+': '+TH.Description+
': Pricing date must be less or equal current date.		
' ELSE '' END
		FROM 
		tblEqpPlans EP
			INNER JOIN
		tblEqpProjs EPR
			ON EP.EqpPlanId=EPR.EqpPlanId
			INNER JOIN
		#z_Message M
			ON EPR.EqpProjId=M.EqpProjId
			INNER JOIN
		tblProjTasks PT
			ON M.ProjTaskId=PT.ProjTaskId
			INNER JOIN
		TASK_HEADER TH
			ON PT.Task_Header_Id=TH.Task_Header_Id
		ORDER BY EP.EqpPlan,EPR.EqpProjName,TH.Description
		RETURN
	END

END


IF @UpdateTask=1
BEGIN

	INSERT INTO #z_ProjTaskUpdate(ProjTaskId,EqpProjId,EqpPlanId,ComponentCodeId, ModifierId,TaskTypeId,ApplicationCodeId,
	Task_Description,Schedule_Type_Id,InspectionTaskTypeId,InspectionOffset ,Scheduling_Group_Id,Scheduling_Group_Counter,ExternalIdentifier,SchedulingTaskId,
	Planning_Task ,Planning_Lead_Time,Operational_Criticality_Id,ManufacturerId,Part_Id,Group_Number,Warranty_Period_Days,
	Warranty_Period_Usage ,Last_Change_Usage ,Last_Change_Date,UsageQUOMId,[First],Frequency ,Final,Last_Mod_Date,
	ComponentCodeIdOld, ModifierIdOld,TaskTypeIdOld,ApplicationCodeIdOld,Task_Header_Id,
	--AL: 31/03/09
	PctPurchasePart,PctPurchaseLabour,PctPurchaseMisc,PctPurchaseNewPart,SalesResponsibilityID,
	Maintenance_Strategy_Id,RCMComponentStructureId ,/*VV CR9019*/CBDTask,/*VV E316*/PartRatingId,/*GW*/AutoGenerateWOS,
	/*E781*/DefaultLocationForRebuild, PartClassification)

	SELECT 
	PT.ProjTaskId,PT.EqpProjId,PT.EqpPlanId,
	ISNULL(MTE.Component_Code,PT.ComponentCodeId) AS ComponentCodeId,
	ISNULL(NULLIF(ISNULL(MTE.Modifier_Code, PT.ModifierId),@NoneId),0) AS ModifierId,
	ISNULL(MTE.Task_Type,PT.TaskTypeId) AS TaskTypeId, 
	ISNULL(NULLIF(ISNULL(MTE.Task_Counter,PT.ApplicationCodeId),@NoneId),0) AS ApplicationCodeId, 
	ISNULL(MTE.Description,PT.Task_Description) AS Task_Description,
	
	--If usage method or planning changes set scheduling type(date_based 1 or null)
	CASE /*1*/WHEN MTE.Task_Mode=@TaskModeNonP THEN/*For non-planning tasks always last performed*/
								CASE WHEN MTE.Date_Based=1 THEN @SchT_LastPerformedDate
								     WHEN ISNULL(MTE.UOM,PT.UsageQUOMId)>0 THEN @SchT_LastPerformedUOM
								     ELSE @SchT_LastPerformedDate END
							
		/*2*/ELSE
			CASE /*2.1*/WHEN MTE.Date_Based=1 AND PT.UsageQUOMId>0 THEN
							CASE PT.Schedule_Type_Id 
							WHEN @SchT_LastPerformedUOM THEN @SchT_LastPerformedDate
						    WHEN @SchT_LastScheduledUOM THEN @SchT_LastScheduledDate
							ELSE PT.Schedule_Type_Id END
				/*2.2*/WHEN PT.UsageQUOMId IS NULL AND MTE.UOM>0 THEN 
							CASE PT.Schedule_Type_Id 
							WHEN @SchT_LastPerformedDate THEN @SchT_LastPerformedUOM
						    WHEN @SchT_LastScheduledDate THEN @SchT_LastScheduledUOM
							ELSE PT.Schedule_Type_Id END
					   ELSE PT.Schedule_Type_Id
			END
		END AS Schedule_Type_Id,
	
	CASE MTE.Task_Mode WHEN @TaskModeNonP THEN NULL ELSE PT.InspectionTaskTypeId END AS InspectionTaskTypeId,
	CASE MTE.Task_Mode WHEN @TaskModeNonP THEN 0 ELSE PT.InspectionOffset END AS InspectionOffset,
	CASE MTE.Task_Mode WHEN @TaskModeNonP THEN NULL ELSE PT.Scheduling_Group_Id END AS Scheduling_Group_Id,
	CASE MTE.Task_Mode WHEN @TaskModeNonP THEN NULL ELSE PT.Scheduling_Group_Counter END AS Scheduling_Group_Counter,
	CASE WHEN MTE.Task_Mode = @TaskModeNonP AND PT.SchedulingTaskId>0 THEN NULL /*The scheduling task will be unlinked*/
							    WHEN ((PT.UsageQUOMId>0 AND MTE.Date_Based=1) OR ISNULL(PT.UsageQUOMId,0)<>ISNULL(ISNULL(MTE.UOM,PT.UsageQUOMId),0)) AND
								PT.SchedulingTaskId>0 THEN NULL/*The scheduling task will be unlinked*/
							    ELSE PT.ExternalIdentifier END AS ExternalIdentifier,
	CASE WHEN MTE.Task_Mode= @TaskModeNonP THEN NULL
							 WHEN ((PT.UsageQUOMId>0 AND MTE.Date_Based=1) OR ISNULL(PT.UsageQUOMId,0)<>ISNULL(ISNULL(MTE.UOM,PT.UsageQUOMId),0)) THEN NULL
							 ELSE PT.SchedulingTaskId END AS SchedulingTaskId,

	CASE WHEN PT.Unscheduled<>0 THEN PT.Planning_Task
						  WHEN PT.ParentTaskId>0 THEN PT.Planning_Task
					      WHEN MTE.Task_Mode=@TaskModeP THEN 1 
						  WHEN MTE.Task_Mode=@TaskModeNonP THEN 0 
						  ELSE PT.Planning_Task END AS Planning_Task,
	CASE WHEN PT.Unscheduled<>0 THEN PT.Planning_Lead_Time
						  WHEN PT.ParentTaskId>0 THEN PT.Planning_Lead_Time
						/*VV CR7824 
						  WHEN MTE.Task_Mode IN(@TaskModeP,@TaskModeNonP) THEN MTE.Planning_Lead_Time 
						  ELSE PT.Planning_Lead_Time END */
						  ELSE ISNULL(MTE.Planning_Lead_Time,PT.Planning_Lead_Time) END AS Planning_Lead_Time,
	NULLIF(ISNULL(MTE.Operational_Criticality,PT.Operational_Criticality_Id),@NoneId) AS Operational_Criticality_Id, 
	ISNULL(MTE.Manufacturer,PT.ManufacturerId) AS ManufacturerId, 
	CASE WHEN PT.Rotable_Part_Id>0 THEN PT.Part_Id
					WHEN PT.Unscheduled<>0 THEN PT.Part_Id
					ELSE NULLIF(ISNULL(MTE.Primary_Part_Number,PT.Part_Id),@NoneId) END  AS Part_Id,
	CASE WHEN PT.Rotable_Part_Id>0 THEN PT.Group_Number
					WHEN PT.Unscheduled<>0 THEN PT.Group_Number
					ELSE ISNULL(MTE.Group_Number,PT.Group_Number) END AS Group_Number,
	ISNULL(MTE.Warranty_Days,PT.Warranty_Period_Days) AS Warranty_Period_Days, 
	ISNULL(MTE.Warranty_Usage,PT.Warranty_Period_Usage) AS Warranty_Period_Usage, 

	CASE WHEN MTE.Date_Based=1 AND PT.UsageQUOMId>0 THEN 0
							  WHEN ISNULL(PT.UsageQUOMId,0)<>ISNULL(ISNULL(MTE.UOM,PT.UsageQUOMId),0) THEN 0
							  ELSE PT.Last_Change_Usage END AS Last_Change_Usage,

	CASE WHEN MTE.Date_Based=1 AND PT.UsageQUOMId>0 THEN EP.StartDate
							  WHEN ISNULL(PT.UsageQUOMId,0)<>ISNULL(ISNULL(MTE.UOM,PT.UsageQUOMId),0) THEN EP.StartDate
							  ELSE PT.Last_Change_Date END AS Last_Change_Date,

	CASE WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1 THEN PT.UsageQUOMId
						WHEN MTE.Date_Based=1 THEN NULL 
						ELSE ISNULL(MTE.UOM,PT.UsageQUOMId) END AS UsageQUOMId, 
	CASE WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1 THEN PT.[First]
		 WHEN PT.Unscheduled<>0 THEN PT.[First]
					ELSE ISNULL(MTE.First_Occurrence,PT.[First]) END AS [First], 
	CASE WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1 THEN PT.Frequency
					  ELSE ISNULL(MTE.Frequency,PT.Frequency) END AS Frequency,
	CASE WHEN PT.Unscheduled<>0 THEN PT.Final ELSE ISNULL(MTE.Not_After,PT.Final) END AS Final,
	PT.Last_Mod_Date,
	PT.ComponentCodeId AS ComponentCodeIdOld, PT.ModifierId AS ModifierIdOld,PT.TaskTypeId AS TaskTypeIdOld,
	PT.ApplicationCodeId AS ApplicationCodeIdOld,
	CASE WHEN ISNULL(MTE.Component_Code,PT.ComponentCodeId) <>PT.ComponentCodeId OR
			ISNULL(NULLIF(ISNULL(MTE.Modifier_Code, PT.ModifierId),@NoneId),0) <>PT.ModifierId OR
			ISNULL(MTE.Task_Type,PT.TaskTypeId) <>PT.TaskTypeId OR
			ISNULL(NULLIF(ISNULL(MTE.Task_Counter,PT.ApplicationCodeId),@NoneId),0)<>PT.ApplicationCodeId THEN NULL
		ELSE PT.Task_Header_Id END AS Task_Header_Id,

	--AL: 31/03/09, 27/05/09
	ISNULL(MTE.PctPurchasePart, PT.PctPurchasePart),
	ISNULL(MTE.PctPurchaseLabour, PT.PctPurchaseLabour),
	ISNULL(MTE.PctPurchaseMisc, PT.PctPurchaseMisc),
	ISNULL(MTE.PctPurchaseNewPart, PT.PctPurchaseNewPart),
	NULLIF(ISNULL(MTE.SalesResponsibility,PT.SalesResponsibilityID),@NoneId),
	ISNULL(MTE.Performance_Strategy, PT.Maintenance_Strategy_Id),
	CASE WHEN ISNULL(ISNULL(MTE.Performance_Strategy, PT.Maintenance_Strategy_Id),0) <> 1 THEN NULL ELSE 
		ISNULL(MTE.Component_Structure, PT.RCMComponentStructureId)
	END,
	/*VV CR9019*/
	ISNULL(MTE.CBDTask,PT.CBDTask) AS CBDTask,
	/*VV E316*/ISNULL(MTE.PartRating,PT.PartRatingId) AS PartRatingId,
	/*GW*/ISNULL(MTE.AutoGenerateWOS,PT.AutoGenerateWOS) AS AutoGenerateWOS,
	/*E781*/
	ISNULL(MTE.DefaultLocationForRebuild, PT.DefaultLocationForRebuild) AS DefaultLocationForRebuild, 
	ISNULL(MTE.PartClassification, PT.PartClassificationId) AS PartClassification
	FROM
	tblEqpPlans EP
		INNER JOIN
	tblProjTasks PT
		ON EP.EqpPlanId=PT.EqpPlanId
		CROSS JOIN
	#z_MTE_TASK MTE
	WHERE PT.ProjTaskId IN (SELECT ProjTaskId FROM #z_TASK_ID)

 
--drop table z_ProjTaskUpdate
--SELECT * INTO z_ProjTaskUpdate FROM #z_ProjTaskUpdate
--
--select * from z_ProjTaskUpdate
--RETURN

	--Check business rules for duplicate component codes for the tasks which 
	-- component codes changed and update task headers
	
	IF EXISTS(SELECT ProjTaskId FROM #z_ProjTaskUpdate WHERE Task_Header_Id IS NULL)
	BEGIN
		--Check the data in the update table for the duplicate combination of codes. It could happen
		--if there are tasks for the same projection in the user selection list

		INSERT INTO #z_Message(EqpProjId,ProjTaskId,Msg)
		SELECT EqpProjId,MAX(ProjTaskId) AS ProjTaskId,CAST(COUNT(ProjTaskId) AS varchar) AS Msg
		FROM #z_ProjTaskUpdate
		GROUP BY EqpProjId,ComponentCodeId,ModifierId,TaskTypeId,ApplicationCodeId
		HAVING COUNT(ProjTaskId)>1

		--drop table z_Message
		--select * into z_Message from #z_Message return

		SET @Counter=@@ROWCOUNT
		
		IF @Counter>0
		BEGIN
			SET @Message=''

			SELECT @Message=@Message+CASE WHEN LEN(@Message)<@MaxMessageLenth THEN EP.EqpPlan+' : '+EPR.EqpProjName+': Duplicate tasks '+
			CC.Code + '.' + MC.Code + '.' + TT.Code + '.' + AC.Code + ' ' + CC.Description +'
' ELSE '' END
			FROM 
			tblEqpPlans EP
				INNER JOIN
			tblEqpProjs EPR
				ON EP.EqpPlanId=EPR.EqpPlanId
				INNER JOIN
			#z_Message M
				ON M.EqpProjId=EPR.EqpProjId
				INNER JOIN
			#z_ProjTaskUpdate U
				ON M.ProjTaskId=U.ProjTaskId
				INNER JOIN
			tblComponentCodes CC
				ON U.ComponentCodeId=CC.ComponentCodeId
				INNER JOIN
			tblModifierCodes MC
				ON U.ModifierId=MC.ModifierId
				INNER JOIN
			tblTaskTypes TT
				ON U.TaskTypeId=TT.TaskTypeId
				INNER JOIN
			tblApplicationCodes AC
				ON U.ApplicationCodeId=AC.ApplicationCodeId
			ORDER BY EP.EqpPlan,EPR.EqpProjName,CC.Code + '.' + MC.Code + '.' + TT.Code + '.' + AC.Code + ' ' + CC.Description
			RETURN
			
		END
		
		--Check duplicate codes in projection
		INSERT INTO #z_Message(EqpProjId,ProjTaskId)
		SELECT U.EqpProjId,U.ProjTaskId
		FROM
		tblProjTasks PT
			INNER JOIN
		#z_ProjTaskUpdate U
			ON PT.EqpProjId=U.EqpProjId AND
			   PT.ComponentCodeId=U.ComponentCodeId AND
			   PT.ModifierId=U.ModifierId AND
			   PT.TaskTypeId=U.TaskTypeId AND
			   PT.ApplicationCodeId=U.ApplicationCodeId 
		WHERE PT.ProjTaskId<>U.ProjTaskId

		SET @Counter=@@ROWCOUNT
		
		IF @Counter>0
		BEGIN
			SET @Message=''

			SELECT @Message=@Message+CASE WHEN LEN(@Message)<@MaxMessageLenth THEN EP.EqpPlan+' : '+EPR.EqpProjName+': Duplicate tasks '+
			CC.Code + '.' + MC.Code + '.' + TT.Code + '.' + AC.Code + ' ' + CC.Description +'
	' ELSE '' END
			FROM 
			tblEqpPlans EP
				INNER JOIN
			tblEqpProjs EPR
				ON EP.EqpPlanId=EPR.EqpPlanId
				INNER JOIN
			#z_Message M
				ON M.EqpProjId=EPR.EqpProjId
				INNER JOIN
			#z_ProjTaskUpdate U
				ON M.ProjTaskId=U.ProjTaskId
				INNER JOIN
			tblComponentCodes CC
				ON U.ComponentCodeId=CC.ComponentCodeId
				INNER JOIN
			tblModifierCodes MC
				ON U.ModifierId=MC.ModifierId
				INNER JOIN
			tblTaskTypes TT
				ON U.TaskTypeId=TT.TaskTypeId
				INNER JOIN
			tblApplicationCodes AC
				ON U.ApplicationCodeId=AC.ApplicationCodeId
			ORDER BY EP.EqpPlan,EPR.EqpProjName,CC.Code + '.' + MC.Code + '.' + TT.Code + '.' + AC.Code + ' ' + CC.Description
			RETURN
			
		END

			SET @ProjTaskUpdate=''

			SELECT @ProjTaskUpdate=@ProjTaskUpdate+CAST(ProjTaskId AS varchar)+','
			FROM (SELECT DISTINCT PT.ProjTaskId FROM 
					#z_ProjTaskUpdate PT
						INNER JOIN
					tblEqpProjs EPR
						ON PT.EqpProjId=EPR.EqpProjId
				WHERE EPR.Projection_Type_Id=@ProjTypeCurr AND Task_Header_Id IS NULL) A

			IF @ProjTaskUpdate<>'' SET @ProjTaskUpdate=LEFT(@ProjTaskUpdate,LEN(@ProjTaskUpdate)-1)
		--Task Headers

		INSERT INTO TASK_HEADER(Component_Code, Modifier_Code, Task_Type, Application_Code,Description)
		/*8 Oct 08	V Vasylyeva CR7410 - duplicate task headers*/
		SELECT DISTINCT A.Component_Code, A.Modifier_Code, A.Task_Type, A.Application_Code,
		A.Component_Code + '.' + A.Modifier_Code + '.' + A.Task_Type + '.' + A.Application_Code + ' ' + A.Description AS Description
		FROM
		(SELECT CC.Code AS Component_Code,MC.Code AS Modifier_Code,TT.Code AS Task_Type,AC.Code AS Application_Code,
		CC.Description
		FROM
		#z_ProjTaskUpdate U
			INNER JOIN
		tblComponentCodes CC
			ON U.ComponentCodeId=CC.ComponentCodeId
			INNER JOIN
		tblModifierCodes MC
			ON U.ModifierId=MC.ModifierId
			INNER JOIN
		tblTaskTypes TT
			ON U.TaskTypeId=TT.TaskTypeId
			INNER JOIN
		tblApplicationCodes AC
					ON U.ApplicationCodeId=AC.ApplicationCodeId
		WHERE U.Task_Header_Id IS NULL) A
			LEFT JOIN
		TASK_HEADER TH
			ON A.Component_Code=TH.Component_Code AND
			   A.Modifier_Code=TH.Modifier_Code AND
			   A.Task_Type=TH.Task_Type AND
			   A.Application_Code=TH.Application_Code
		WHERE TH.Task_Header_Id IS NULL

		UPDATE PT SET PT.Task_Header_Id=TH.Task_Header_Id
		FROM         
			#z_ProjTaskUpdate PT INNER JOIN
			tblComponentCodes CC ON PT.ComponentCodeId = CC.ComponentCodeID INNER JOIN
			tblApplicationCodes AC ON PT.ApplicationCodeId = AC.ApplicationCodeID INNER JOIN
			tblModifierCodes MC ON PT.ModifierId = MC.ModifierID INNER JOIN
			tblTaskTypes TT ON PT.TaskTypeId = TT.TaskTypeID INNER JOIN
			TASK_HEADER TH ON CC.Code = TH.Component_Code AND MC.Code = TH.Modifier_Code AND TT.Code = TH.Task_Type AND 
			AC.Code = TH.Application_Code
		WHERE PT.Task_Header_Id IS NULL

	END /*IF EXISTS(SELECT ProjTaskId FROM #z_ProjTaskUpdate WHERE Task_Header_Id IS NULL)*/
	
--drop table z_ProjTaskUpdate
--SELECT * INTO z_ProjTaskUpdate FROM #z_ProjTaskUpdate
--RETURN
	
	--The other business rules
	INSERT INTO #z_Message(EqpProjId,ProjTaskId,Msg)
	SELECT U.EqpProjId,U.ProjTaskId,
	dbo.PROJ_TASK_BUSINESS_RULES_F
		(U.EqpProjId,
		NULL/*ComponentCodeId*/,
		U.ModifierId,
		U.TaskTypeId,
		U.ApplicationCodeId,	
		U.Schedule_Type_Id, 
		U.Scheduling_Group_Id, 
		U.Scheduling_Group_Counter, 
		U.usageQUOMId,
		U.ProjTaskId,
		U.Last_Change_Date,
		U.Last_Change_Usage,
		U.InspectionTaskTypeId,
		U.InspectionOffset,
		U.Planning_Task,
		NULL /*ParentTaskId*/,
		U.Frequency,
		EP.StartDate,
		CASE WHEN ISNULL(A.TaskNum,0)=ISNULL(B.TaskNum,0) THEN 0 ELSE 1 END/*@CheckGroup*/,
		''/*@ExternalIdentifier do not check because it will be deleted or not updated*/)
	FROM
	tblEqpPlans EP
		INNER JOIN
	#z_ProjTaskUpdate U
		ON EP.EqpPlanId=U.EqpPlanId
		LEFT JOIN
	(SELECT 
	EqpProjId,Scheduling_Group_Id,COUNT(ProjTaskId) AS TaskNum
	FROM #z_ProjTaskUpdate
	WHERE Scheduling_Group_Id>0
	GROUP BY EqpProjId,Scheduling_Group_Id)A
		ON U.EqpProjId=A.EqpProjId AND U.Scheduling_Group_Id=A.Scheduling_Group_Id
		LEFT JOIN
	(SELECT 
	EqpProjId,Scheduling_Group_Id,COUNT(ProjTaskId) AS TaskNum
	FROM tblProjTasks
	WHERE Scheduling_Group_Id>0 AND EqpProjId IN(SELECT EqpProjId FROM #z_ProjTaskUpdate)
	
	GROUP BY EqpProjId,Scheduling_Group_Id) B
	ON U.EqpProjId=B.EqpProjId AND U.Scheduling_Group_Id=B.Scheduling_Group_Id

	IF EXISTS(SELECT * FROM #z_Message WHERE ISNULL(Msg,'')<>'')
	BEGIN
		SET @Message=''

		SELECT @Message=@Message+CASE WHEN LEN(@Message)<@MaxMessageLenth THEN EP.EqpPlan+': '+EPR.EqpProjName+': '+
		TH.Description+': '+M.Msg+'
' ELSE '' END
		FROM 
		tblEqpPlans EP
			INNER JOIN
		tblEqpProjs EPR
			ON EP.EqpPlanId=EPR.EqpPlanId
			INNER JOIN
		#z_Message M
			ON EPR.EqpProjId=M.EqpProjId
			INNER JOIN
		#z_ProjTaskUpdate PT
			ON M.ProjTaskId=PT.ProjTaskId
			INNER JOIN
		TASK_HEADER TH
			ON PT.Task_Header_Id=TH.Task_Header_Id
		WHERE ISNULL(Msg,'')<>''
		ORDER BY EP.EqpPlan,EPR.EqpProjName,TH.Description

		RETURN
	END	

END

 
 
DROP TABLE #z_Message
 
--drop table z_ProjTaskUpdate
--select * into z_ProjTaskUpdate from #z_ProjTaskUpdate
--return


IF EXISTS(SELECT ProjTaskId FROM #z_ProjTaskUpdate)
BEGIN
 
		--Delete RR tasks if Component Structure is unlinked from the parent task // KN 11-Jan 10 Delete before saving Task.
		IF EXISTS(SELECT RR.ParentTaskId FROM
					tblProjTasks RR
						INNER JOIN
					#z_ProjTaskUpdate IPT
						ON RR.ParentTaskId=IPT.ProjTaskId
						INNER JOIN
					tblProjTasks PT
						ON IPT.ProjTaskId=PT.ProjTaskId
					WHERE /*12-Jan-2009 VV*/ ISNULL(PT.Maintenance_Strategy_Id,0)<>ISNULL(IPT.Maintenance_Strategy_Id,0))
		BEGIN
			DECLARE @ProjTaskId VARCHAR(MAX)
			SET @ProjTaskId=''

			SELECT @ProjTaskId = (select CAST(RR.ParentTaskId AS varchar)+',' FROM
				tblProjTasks RR
					INNER JOIN
				#z_ProjTaskUpdate IPT
					ON RR.ParentTaskId=IPT.ProjTaskId
					INNER JOIN
				tblProjTasks PT
					ON IPT.ProjTaskId=PT.ProjTaskId
				WHERE /*12-Jan-2009 VV*/ ISNULL(PT.Maintenance_Strategy_Id,0)<>ISNULL(IPT.Maintenance_Strategy_Id,0) 
				GROUP BY RR.ParentTaskId
			 FOR XML PATH('') )

			SET @ProjTaskId=ISNULL(@ProjTaskId,'')

			EXEC TASK_DELETE_MULTI_EQP @eqpPlanID='',@EqpProjHeaderId =NULL,@ProjTaskHeaderId =NULL,@forceDelete=1,@DeleteRRTasksOnly=1,@ProjTaskId=@ProjTaskId,@CheckRules=1
		 
		END

	--Update tasks
	UPDATE PT SET
	PT.ComponentCodeId =U.ComponentCodeId,
	PT.ModifierId=U.ModifierId,
	PT.TaskTypeId=U.TaskTypeId, 
	PT.ApplicationCodeId=U.ApplicationCodeId, 
	PT.Task_Description=U.Task_Description,		
	PT.Schedule_Type_Id=U.Schedule_Type_Id,
	PT.Task_Header_Id=U.Task_Header_Id,

	--Depend on planning flag
	PT.PlanTaskOptId =CASE U.Planning_Task WHEN 0 THEN NULL ELSE PT.PlanTaskOptId END,
	PT.PlanStatus = CASE U.Planning_Task WHEN 0 THEN 0 ELSE PT.PlanStatus END, 
	PT.PlanUseCalc=CASE U.Planning_Task WHEN 0 THEN 1 ELSE PT.PlanUseCalc END,
	PT.ReviewStatusID=CASE U.Planning_Task WHEN 0 THEN 1 ELSE PT.ReviewStatusID END,
	PT.ReviewUserID=CASE U.Planning_Task WHEN 0 THEN NULL ELSE PT.ReviewUserID END,
	PT.ReviewDate=CASE U.Planning_Task WHEN 0 THEN NULL ELSE PT.ReviewDate END,

	PT.InspectionTaskTypeId=U.InspectionTaskTypeId,
	PT.InspectionOffset=U.InspectionOffset,
	PT.Scheduling_Group_Id=U.Scheduling_Group_Id,
	PT.Scheduling_Group_Counter=U.Scheduling_Group_Counter,

	PT.ExternalIdentifier=U.ExternalIdentifier,
	PT.SchedulingTaskId=U.SchedulingTaskId,

	PT.Planning_Task=U.Planning_Task,
	/* VV CR7824 
	PT.Planning_Lead_Time=U.Planning_Lead_Time,
	*/
	PT.Planning_Lead_Time=CASE WHEN U.Planning_Task=1 AND U.Planning_Lead_Time>0 THEN U.Planning_Lead_Time ELSE PT.Planning_Lead_Time END,
	PT.Operational_Criticality_Id=U.Operational_Criticality_Id, 
	PT.ManufacturerId=U.ManufacturerId, 
	PT.Part_Id=U.Part_Id,
	PT.Group_Number=U.Group_Number,
	PT.Warranty_Period_Days=U.Warranty_Period_Days, 
	PT.Warranty_Period_Usage=U.Warranty_Period_Usage, 

	PT.Last_Change_Usage=U.Last_Change_Usage,
	PT.Last_Change_Date=U.Last_Change_Date,
	PT.UsageQUOMId=U.UsageQUOMId, 
	PT.UsageMethod =CASE WHEN U.UsageQUOMId>0 THEN 'U' ELSE 'D' END,
	PT.[First]=U.[First], 
	PT.Frequency=U.Frequency, 
	PT.Final=U.Final,
	PT.Last_Mod_Date= GETDATE(),
	--AL: 31/01/09
	PT.PctPurchasePart=U.PctPurchasePart,
	PT.PctPurchaseLabour=U.PctPurchaseLabour,
	PT.PctPurchaseMisc=U.PctPurchaseMisc,
	PT.PctPurchaseNewPart=U.PctPurchaseNewPart,
	PT.SalesResponsibilityID=U.SalesResponsibilityID,
	PT.Maintenance_Strategy_Id = U.Maintenance_Strategy_Id,
	PT.RCMComponentStructureId = U.RCMComponentStructureId,
	/*VV CR9019*/	PT.CBDTask=U.CBDTask,
	/*VV E316*/PT.PartRatingId=U.PartRatingId,
	/*GW*/PT.AutoGenerateWOS=U.AutoGenerateWOS,
	/*E781*/
	DefaultLocationForRebuild = U.DefaultLocationForRebuild, 
	PartClassificationId = U.PartClassification
		 
	FROM
	#z_ProjTaskUpdate U
		INNER JOIN
	tblProjTasks PT
		ON U.ProjTaskId=PT.ProjTaskId
END



IF @UpdateOpt=1
BEGIN
	UPDATE PTO SET
	PTO.[First]=CASE WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1 THEN PTO.[First]
					ELSE ISNULL(MTE.First_Occurrence,PT.[First]) END, 
	PTO.Frequency=CASE WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1 THEN PTO.Frequency
					  ELSE ISNULL(MTE.Frequency,PTO.Frequency) END
	FROM
	tblProjTasks PT
		INNER JOIN
	tblProjTaskOpts PTO
		ON PT.ProjTaskId=PTO.ProjTaskId
		CROSS JOIN
	#z_MTE_TASK MTE
	WHERE PT.ProjTaskId IN (SELECT ProjTaskId FROM #z_TASK_ID)
END

IF @UpdateJob=1
BEGIN
 
	--Delete Cost Allocations if cost source is set to update
	IF EXISTS(SELECT MTEId FROM #z_MTE_TASK WHERE Cost_Source>0)
	BEGIN
		IF EXISTS(SELECT CA.Proj_Task_Amt_Id FROM COST_ALLOCATION CA INNER JOIN #z_TASK_ID T 
				ON CA.Proj_Task_Amt_Id=T.ProjTaskAmtId)
		BEGIN
			DELETE CAD FROM
			COST_ALLOCATION_DETAIL CAD
				INNER JOIN
			COST_ALLOCATION CA
				ON CAD.Cost_Allocation_Id=CA.Cost_Allocation_Id
				INNER JOIN
			#z_TASK_ID PTA
				ON CA.Proj_Task_Amt_Id=PTA.ProjTaskAmtId
				
			DELETE CA FROM
			COST_ALLOCATION CA
				INNER JOIN
			#z_TASK_ID PTA
				ON CA.Proj_Task_Amt_Id=PTA.ProjTaskAmtId
		END
	END

	

	UPDATE PTA SET 
	PTA.JobCodeId= CASE WHEN MTE.Cost_Source IN(@CostSourceM,@CostSourceC) THEN NULLIF(ISNULL(MTE.Job_Code, PTA.JobCodeId),@NoneId)
				    WHEN PTA.PricedJobId>0 THEN PTA.JobCodeId
					/*External CA field shall be updated from AMT Proj Job if configuration is set update from AMT*/							
					WHEN SS.AMTSystemSource=0 AND CAC.JobCode=0 THEN PTA.JobCodeId
					ELSE NULLIF(ISNULL(MTE.Job_Code, PTA.JobCodeId),@NoneId) END,
	PTA.CurrencyId= CASE WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1 THEN PTA.CurrencyId
						 WHEN MTE.Cost_Source IN(@CostSourceM,@CostSourceC) THEN ISNULL(MTE.Currency, PTA.CurrencyId)
						 WHEN PTA.PricedJobId>0 THEN PTA.CurrencyId/*Discussed with RF. Do not change currency if linked to CA*/
						 WHEN CA.Proj_Task_Amt_Id>0 THEN PTA.CurrencyId/*Discussed with RF. Do not change currency if linked to CA*/
						 ELSE ISNULL(MTE.Currency, PTA.CurrencyId) END,
	PTA.Cost_Bearer_ID=/*External CA field shall be updated from AMT Proj Job if configuration is set update from AMT*/							
						CASE WHEN SS.AMTSystemSource=0 AND CAC.CostBearer=0 THEN PTA.Cost_Bearer_ID
						ELSE ISNULL(MTE.Cost_Bearer,PTA.Cost_Bearer_ID) END, 
	PTA.Cost_Centre_ID=/*External CA field shall be updated from AMT Proj Job if configuration is set update from AMT*/							
						CASE WHEN SS.AMTSystemSource=0 AND CAC.CostCentre=0 THEN PTA.Cost_Centre_ID
							 ELSE NULLIF(ISNULL(MTE.Cost_Centre, PTA.Cost_Centre_ID),@NoneId) END,
	PTA.Work_Group_Id=/*External CA field shall be updated from AMT Proj Job if configuration is set update from AMT*/							
						CASE WHEN SS.AMTSystemSource=0 AND CAC.WorkGroup=0 THEN PTA.Work_Group_Id
							 ELSE NULLIF(ISNULL(MTE.Work_Group, PTA.Work_Group_Id),@NoneId) END,
	PTA.PartTypeId=NULLIF(ISNULL(MTE.Part_Type, PTA.PartTypeId),@NoneId),
	PTA.Health_Safety_Id=NULLIF(ISNULL(MTE.[OH&S], PTA.Health_Safety_Id),@NoneId),
	PTA.Pricing_Date=CASE WHEN EPR.Projection_Type_Id IN(@ProjTypeBud,@ProjTypeEstCurr,@ProjTypeEstDr) THEN PTA.Pricing_Date
						  WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1  THEN PTA.Pricing_Date
					      WHEN MTE.Cost_Source IN(@CostSourceM,@CostSourceC) THEN ISNULL(MTE.Pricing_Date, PTA.Pricing_Date)
						  WHEN PTA.PricedJobId >0 THEN PTA.Pricing_Date
						  WHEN @UpdatePricingDate=1 AND EPR.Projection_Type_Id IN(@ProjTypeCurr,@ProjTypeAlt) THEN GETDATE()
						  ELSE ISNULL(MTE.Pricing_Date, PTA.Pricing_Date) END,

	PTA.QtyVolume=CASE 
					   WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1 THEN PTA.QtyVolume
					   WHEN MTE.Cost_Source =@CostSourceC THEN ISNULL(MTE.Consumable_Qty,PTA.QtyVolume)
					   WHEN MTE.Cost_Source =@CostSourceM THEN 0
					   WHEN PTA.Consumable=1 THEN ISNULL(MTE.Consumable_Qty,PTA.QtyVolume)
					   ELSE PTA.QtyVolume END,

	PTA.PercentTopUp=CASE 
						WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1 THEN PTA.PercentTopUp
						WHEN MTE.Cost_Source =@CostSourceC THEN ISNULL(MTE.[Consumable_Top_Up_%],PTA.PercentTopUp)
						WHEN MTE.Cost_Source =@CostSourceM THEN 0
						WHEN PTA.Consumable=1 THEN ISNULL(MTE.[Consumable_Top_Up_%],PTA.PercentTopUp)
						ELSE PTA.PercentTopUp END,

	PTA.UnitPrice=CASE WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1 THEN PTA.UnitPrice
					   WHEN MTE.Cost_Source =@CostSourceC THEN ISNULL(MTE.Consumable_Price,PTA.UnitPrice)
					   WHEN MTE.Cost_Source =@CostSourceM THEN 0
					   WHEN PTA.Consumable=1 THEN ISNULL(MTE.Consumable_Price,PTA.UnitPrice)
					   ELSE PTA.UnitPrice END,

	PTA.PartsCost=CASE  WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1 THEN PTA.PartsCost
						WHEN MTE.Cost_Source =@CostSourceC THEN dbo.CONSUMABLE_PART_PRICE_F(ISNULL(MTE.Consumable_Qty,PTA.QtyVolume)/*@QtyVolume*/,
									ISNULL(MTE.Consumable_Price,PTA.UnitPrice)/*@UnitPrice*/,
									ISNULL(MTE.[Consumable_Top_Up_%],PTA.PercentTopUp)/*@PercentTopUp*/)
						WHEN MTE.Cost_Source =@CostSourceM THEN ISNULL(MTE.Job_Parts_Cost,PTA.PartsCost)
						WHEN PTA.PricedJobId>0 OR CA.Proj_Task_Amt_Id>0 THEN PTA.PartsCost
						WHEN PTA.Consumable=1 THEN dbo.CONSUMABLE_PART_PRICE_F(ISNULL(MTE.Consumable_Qty,PTA.QtyVolume)/*@QtyVolume*/,
									ISNULL(MTE.Consumable_Price,PTA.UnitPrice)/*@UnitPrice*/,
									ISNULL(MTE.[Consumable_Top_Up_%],PTA.PercentTopUp)/*@PercentTopUp*/)
					    ELSE ISNULL(MTE.Job_Parts_Cost,PTA.PartsCost) END,

	PTA.LaborCost=CASE WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1 THEN PTA.LaborCost
					   WHEN MTE.Cost_Source IN(@CostSourceC,@CostSourceM) THEN ISNULL(MTE.Job_Labour_Cost,PTA.LaborCost)
					   WHEN PTA.PricedJobId>0 OR CA.Proj_Task_Amt_Id>0 THEN PTA.LaborCost
					   ELSE ISNULL(MTE.Job_Labour_Cost,PTA.LaborCost) END,

	PTA.MiscCost=CASE WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1 THEN PTA.MiscCost
					  WHEN MTE.Cost_Source IN(@CostSourceC,@CostSourceM) THEN ISNULL(MTE.Job_Misc_Cost,PTA.MiscCost)
					  WHEN PTA.PricedJobId>0 OR CA.Proj_Task_Amt_Id>0 THEN PTA.MiscCost
					  ELSE ISNULL(MTE.Job_Misc_Cost,PTA.MiscCost) END,
	
	PTA.LaborHours=CASE WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1 THEN PTA.LaborHours
						WHEN MTE.Cost_Source IN(@CostSourceC,@CostSourceM) THEN ISNULL(MTE.Job_Labour_Hours,PTA.LaborHours)
					   WHEN PTA.PricedJobId>0 OR CA.Proj_Task_Amt_Id>0 THEN PTA.LaborHours
					   ELSE ISNULL(MTE.Job_Labour_Hours,PTA.LaborHours) END,

	PTA.Duration=CASE WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1 THEN PTA.Duration
						/*VV CR8601 Replaced LaborHours to Duration*/
					   WHEN MTE.Cost_Source IN(@CostSourceC,@CostSourceM) THEN ISNULL(MTE.Job_Duration,PTA.Duration)
					   WHEN PTA.PricedJobId>0 OR CA.Proj_Task_Amt_Id>0 THEN PTA.Duration
					   ELSE ISNULL(MTE.Job_Duration,PTA.Duration) END,

	PTA.Parts_Cost_Expense_ID=/*External CA field shall be updated from AMT Proj Job if configuration is set update from AMT*/							
								CASE WHEN SS.AMTSystemSource=0 AND CAC.PartsCostExpense=0 THEN PTA.Parts_Cost_Expense_ID
									 ELSE NULLIF(ISNULL(MTE.Parts_Exp_Element, PTA.Parts_Cost_Expense_ID),@NoneId) END,

	PTA.Labour_Cost_Expense_ID=/*External CA field shall be updated from AMT Proj Job if configuration is set update from AMT*/							
								CASE WHEN SS.AMTSystemSource=0 AND CAC.LabourCostExpense=0 THEN PTA.Labour_Cost_Expense_ID
								     ELSE NULLIF(ISNULL(MTE.Labour_Exp_Element, PTA.Labour_Cost_Expense_ID),@NoneId) END,

	PTA.Misc_Cost_Expense_ID=/*External CA field shall be updated from AMT Proj Job if configuration is set update from AMT*/							
								CASE WHEN SS.AMTSystemSource=0 AND CAC.MiscCostExpense=0 THEN PTA.Misc_Cost_Expense_ID
								     ELSE NULLIF(ISNULL(MTE.Misc_Exp_Element, PTA.Misc_Cost_Expense_ID),@NoneId) END,
	PTA.Parts_EDC_ID=NULLIF(ISNULL(MTE.Parts_EDC,PTA.Parts_EDC_ID),@NoneId),
	PTA.Labour_EDC_ID=NULLIF(ISNULL(MTE.Labour_EDC,PTA.Labour_EDC_ID), @NoneId),
	PTA.Misc_EDC_ID=NULLIF(ISNULL(MTE.Misc_EDC,PTA.Misc_EDC_ID),@NoneId),

	PTA.Labour_Activity_Id=/*External CA field shall be updated from AMT Proj Job if configuration is set update from AMT*/							
								CASE WHEN SS.AMTSystemSource=0 AND CAC.LabourActivity=0 THEN PTA.Labour_Activity_Id
								     ELSE NULLIF(ISNULL(MTE.Labour_Activity, PTA.Labour_Activity_Id),@NoneId) END,

	PTA.Labour_Hrs_Field=CASE WHEN MTE.Labour_Type=@LabourTypeF THEN 1
							  WHEN MTE.Labour_Type=@LabourTypeS THEN 0
						 ELSE PTA.Labour_Hrs_Field END,
	PTA.PricedJobId= CASE WHEN MTE.Cost_Source IN(@CostSourceM,@CostSourceC,@CostSourceS) THEN NULL 
						 ELSE PTA.PricedJobId END
						 ,
	PTA.Consumable=CASE WHEN MTE.Cost_Source =@CostSourceC THEN 1
						WHEN MTE.Cost_Source =@CostSourceM THEN 0
						WHEN MTE.Cost_Source =@CostSourceS THEN 0
						ELSE PTA.Consumable END,
	PTA.StdJobPartsMargin=CASE WHEN MTE.Cost_Source IN(@CostSourceM,@CostSourceC,@CostSourceS) THEN NULL 
						 ELSE PTA.StdJobPartsMargin END,
	PTA.StdJobReference=CASE 
								WHEN MTE.Cost_Source IN(@CostSourceM,@CostSourceC) THEN NULL 
								WHEN MTE.Cost_Source = @CostSourceS THEN SJ.Std_Job_Ref
						 ELSE PTA.StdJobReference END
	
	FROM
	tblEqpProjs EPR
		INNER JOIN
	tblProjTasks PT
		ON EPR.EqpProjId=PT.EqpProjId
		INNER JOIN
	tblProjTaskOpts PTO
		ON PT.ProjTaskId=PTO.ProjTaskId
		INNER JOIN
	tblProjTaskAmts PTA
		ON PTO.ProjTaskOptId=PTA.ProjTaskOptId
		INNER JOIN
	#z_TASK_ID T
		ON PTA.ProjTaskAmtId=T.ProjTaskAmtId
		LEFT JOIN
	COST_ALLOCATION CA
		ON PTA.ProjTaskAmtId=CA.Proj_Task_Amt_Id
		LEFT JOIN
	SYSTEM_SOURCE SS
		ON CA.System_Source_Id=SS.System_Source_Id
		CROSS JOIN
	#z_MTE_TASK MTE
		CROSS JOIN
	COST_ALLOCATION_CONFIGURATION CAC
		LEFT JOIN 
	tblPricedJobs PJ ON PJ.PricedJobId = MTE.Standard_Job
	LEFT JOIN tblStdJobs SJ ON SJ.StdJobId  = PJ.StdJobId

	IF EXISTS(SELECT CA.proj_Task_Amt_Id FROM
			tblProjTaskAmts PTA
				INNER JOIN
			COST_ALLOCATION CA
				ON PTA.ProjTaskAmtId=CA.Proj_Task_Amt_Id		
				INNER JOIN
			#z_TASK_ID T
				ON PTA.ProjTaskAmtId=T.ProjTaskAmtId)
	BEGIN

		--Update cost allocations
		UPDATE CAD SET
		CAD.Job_Code_Id=CASE 	
						/*For internal cost allocations update the field only if there is a value in Proj Job*/	
						WHEN SS.AMTSystemSource=1 THEN ISNULL(PTA.JobCodeId,CAD.Job_Code_Id)	

						/*External CA field shall be updated from AMT Proj Job*/							
						WHEN SS.AMTSystemSource=0 AND CAC.JobCode=1 THEN PTA.JobCodeId
						
						/*External CA  the value for the field shall come from CA (A.AMTSystemSource=0 AND @JobCode=0)*/
						ELSE CAD.Job_Code_Id END, 

		CAD.Labour_Activity_Id=CASE 	
						/*For internal cost allocations update the field only if there is a value in Proj Job*/	
						WHEN SS.AMTSystemSource=1 THEN ISNULL(PTA.Labour_Activity_Id,CAD.Labour_Activity_Id)	

						/*External CA field shall be updated from AMT Proj Job*/							
						WHEN SS.AMTSystemSource=0 AND CAC.LabourActivity=1 THEN PTA.Labour_Activity_Id
						
						/*External CA  the value for the field shall come from CA (A.AMTSystemSource=0 AND @LabourActivity=0)*/
						ELSE CAD.Labour_Activity_Id END, 

		CAD.Labour_Cost_Expense_ID=CASE 	
						/*For internal cost allocations update the field only if there is a value in Proj Job*/	
						WHEN SS.AMTSystemSource=1 THEN ISNULL(PTA.Labour_Cost_Expense_ID,CAD.Labour_Cost_Expense_ID)	

						/*External CA field shall be updated from AMT Proj Job*/							
						WHEN SS.AMTSystemSource=0 AND CAC.LabourCostExpense=1 THEN PTA.Labour_Cost_Expense_ID
						
						/*External CA  the value for the field shall come from CA (A.AMTSystemSource=0 AND @LabourCostExpense=0)*/
						ELSE CAD.Labour_Cost_Expense_ID END, 

		CAD.Parts_Cost_Expense_ID=CASE 	
						/*For internal cost allocations update the field only if there is a value in Proj Job*/	
						WHEN SS.AMTSystemSource=1 THEN ISNULL(PTA.Parts_Cost_Expense_ID,CAD.Parts_Cost_Expense_ID)	

						/*External CA field shall be updated from AMT Proj Job*/							
						WHEN SS.AMTSystemSource=0 AND CAC.PartsCostExpense=1 THEN PTA.Parts_Cost_Expense_ID
						
						/*External CA  the value for the field shall come from CA (A.AMTSystemSource=0 AND @PartsCostExpense=0)*/
						ELSE CAD.Labour_Cost_Expense_ID END,

		CAD.Misc_Cost_Expense_ID=CASE 	
						/*For internal cost allocations update the field only if there is a value in Proj Job*/	
						WHEN SS.AMTSystemSource=1 THEN ISNULL(PTA.Misc_Cost_Expense_ID,CAD.Misc_Cost_Expense_ID)	

						/*External CA field shall be updated from AMT Proj Job*/							
						WHEN SS.AMTSystemSource=0 AND CAC.MiscCostExpense=1 THEN PTA.Misc_Cost_Expense_ID
						
						/*External CA  the value for the field shall come from CA (A.AMTSystemSource=0 AND @MiscCostExpense=0)*/
						ELSE CAD.Misc_Cost_Expense_ID END,

		CAD.Cost_Bearer_ID=CASE 	
						/*For internal cost allocations update the field only if there is a value in Proj Job*/	
						WHEN SS.AMTSystemSource=1 THEN ISNULL(PTA.Cost_Bearer_ID,CAD.Cost_Bearer_ID)	

						/*External CA field shall be updated from AMT Proj Job*/							
						WHEN SS.AMTSystemSource=0 AND CAC.CostBearer=1 THEN PTA.Cost_Bearer_ID
						
						/*External CA  the value for the field shall come from CA (A.AMTSystemSource=0 AND @CostBearer=0)*/
						ELSE CAD.Cost_Bearer_ID END,

		CAD.Cost_Centre_ID=CASE 	
						/*For internal cost allocations update the field only if there is a value in Proj Job*/	
						WHEN SS.AMTSystemSource=1 THEN ISNULL(PTA.Cost_Centre_ID,CAD.Cost_Centre_ID)	

						/*External CA field shall be updated from AMT Proj Job*/							
						WHEN SS.AMTSystemSource=0 AND CAC.CostCentre=1 THEN PTA.Cost_Centre_ID
						
						/*External CA  the value for the field shall come from CA (A.AMTSystemSource=0 AND @CostCentre=0)*/
						ELSE CAD.Cost_Centre_ID END,	

		CAD.Work_Group_Id=CASE 	
						/*For internal cost allocations update the field only if there is a value in Proj Job*/	
						WHEN SS.AMTSystemSource=1 THEN ISNULL(PTA.Work_Group_Id,CAD.Work_Group_Id)	

						/*External CA field shall be updated from AMT Proj Job*/							
						WHEN SS.AMTSystemSource=0 AND CAC.WorkGroup=1 THEN PTA.Work_Group_Id
						
						/*External CA  the value for the field shall come from CA (A.AMTSystemSource=0 AND @WorkGroup=0)*/
						ELSE CAD.Work_Group_Id END
		FROM
		tblProjTaskAmts PTA
			INNER JOIN
		COST_ALLOCATION CA
			ON PTA.ProjTaskAmtId=CA.Proj_Task_Amt_Id
			INNER JOIN
		COST_ALLOCATION_DETAIL CAD
			ON CA.Cost_Allocation_Id=CAD.Cost_Allocation_Id
			INNER JOIN
		SYSTEM_SOURCE SS
			ON CA.System_Source_Id=SS.System_Source_Id
			INNER JOIN
		#z_TASK_ID T
			ON PTA.ProjTaskAmtId=T.ProjTaskAmtId
			CROSS JOIN
		COST_ALLOCATION_CONFIGURATION CAC

	END
END


DECLARE @StdJobRef XML

	SET @StdJobRef=(SELECT DISTINCT Std_Job_Ref AS List_Item FROM tblStdJobs 
				INNER JOIN tblPricedJobs ON tblPricedJobs.StdJobId = tblStdJobs.StdJobId
			WHERE tblPricedJobs.PricedJobId IN (SELECT Standard_Job FROM #z_MTE_TASK)
			FOR XML RAW('Row'),ROOT('Rows'),ELEMENTS)

	IF @StdJobRef IS NOT NULL
	BEGIN
		EXEC STD_JOB_LINK_P @StdJobRef=@StdJobRef, @IncludeAllProjections = 1
	END
	
DROP TABLE #z_MTE_TASK,#z_TASK_ID

IF @ProjTaskUpdate<>''
BEGIN
	IF @UpdateHistory=1 
		EXEC UPDATE_STRATEGY_TASK_HISTORY_P @projTaskId=@ProjTaskUpdate
	ELSE
		EXEC TASK_UNLINK_FROM_STRATEGY_TASK_P @ProjTaskId=@ProjTaskUpdate



	--Relink EQS tasks
	EXEC STRATEGY_TASK_LINK_TO_EQS_TASK_P @ProjTaskId =NULL, 
												@EqpProjId =NULL,   
												@EqpPlanId =NULL,
												@Message =@Message OUTPUT,
												@ProjTaskIdMany =@ProjTaskUpdate

	SET @Message=ISNULL(@Message,'')

	IF @Message<>'' RETURN
		
	

END



IF EXISTS(SELECT SchedulingTaskId FROM #z_ProjTaskUpdate WHERE SchedulingTaskId>0)
BEGIN
	SET @ProjTaskUpdate=''

	SELECT @ProjTaskUpdate=@ProjTaskUpdate+CAST(ProjTaskId AS varchar)+',' FROM
	(SELECT DISTINCT ProjTaskId FROM #z_ProjTaskUpdate WHERE SchedulingTaskId>0) A

	IF @ProjTaskUpdate<>'' SET @ProjTaskUpdate=LEFT(@ProjTaskUpdate,LEN(@ProjTaskUpdate)-1)

	EXEC SCHEDULING_TASK_TO_PROJ_TASK_P @ProjTaskIdMany=@ProjTaskUpdate
					 
END







GO

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[MULTI_TASK_EDITOR_GET_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[MULTI_TASK_EDITOR_GET_P]
GO

create PROCEDURE [dbo].[MULTI_TASK_EDITOR_GET_P]
/******************************************************************************
	Name: MULTI_TASK_EDITOR_GET

	Called By: 

	Desc: Returns data for multi-task editor
             

	Auth: Veronika Vasylyeva
	Date: 1-Apr=2008
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	12/04/12    SD		    E781 - Add PEX fields
	
OLD HISTORY
-----------
	 9-Dec-09	V Vasylyeva	CR8604 Error when filtering for tasks
	31 Mar 09	A Lassaun.	CR7965: Added @ContractTypeID and @PrimaryPartNumberID
	 3 Sep 08	V Vasylyeva	Added EqpLocation
    11 Jun 08	V Vasylyeva	Changed datatypes in the last query	
	23 Jul 09	K Nagarajan	Added StdJob / Component Struc
	03 Sep 09	K Nagarajan Check Filter_Std_Job_Model
	 7 Oct 10	V vasylyeva	E316 Part Rating
	12 Oct 11   G Dhillon   E646 Add Task Counter and modifier code as filters
*******************************************************************************/
	/* Param List */
@EquipmentTypeId varchar(max)='',
@BranchId varchar(max)='',
@SiteId varchar(max)='',
@FleetId varchar(max)='',
@EqpPlanId varchar(max)='',
@ModelId varchar(max)='', 
@Regionid varchar(max)='', 
@DivisionId varchar(max)='', 
@EqpCriticalityId varchar(max)='', 
@EqpClassId varchar(max)='', 
@EqpGroupId  varchar(max)='', 
@EqpCategoryId varchar(max)='', 
@EqpCostCentreId varchar(max)='',
@ParentEquipmentId varchar(max)='', 
@ProjectionHeaderId varchar(max)='',
@CostResponsibilityId varchar(max)='',
@SystemId varchar(max)='',
@SubSystemId varchar(max)='',
@ComponentCodeId varchar(max)='',
@TaskTypeId varchar(max)='',
@TaskHeaderId varchar(max)='',
@TaskModeId varchar(max)='',
@JobCodeId varchar(max)='',
@CurrencyId varchar(max)='',
@CostSourceId varchar(max)='',
@TaskFields varchar(max)='',
@JobFields varchar(max)='',
@EditJob bit=0,
@Message varchar(8000)='' OUTPUT,
@EqpLocationId varchar(max)='',
--AL: 31/03/09
@ContractTypeID varchar(max)='',
@PrimaryPartNumberID varchar(max)='',
--GD E646 12/10/11
@ApplicationCodeId VARCHAR(MAX)='',
@ModifierId VARCHAR(MAX)=''

AS

DECLARE @Filter_Std_Job_Model bit
SELECT @Filter_Std_Job_Model = Filter_Std_Job_Model FROM AMT_VARIABLE

/*VV CR8604*/
DECLARE @GetModel bit
SET @GetModel=0

IF @Filter_Std_Job_Model = 1 AND CHARINDEX('Standard_Job', ISNULL(@JobFields,'') ) > 0
BEGIN
	IF ISNULL(@ModelId,'') = '' OR CHARINDEX(',', ISNULL(@ModelId,'') ) > 0
	BEGIN
		SELECT 'To update Standard Job, please select one Model.' As Msg
		RETURN
	END
	/*VV CR8604*/	
	SET @GetModel=1
END

DECLARE @CA varchar(10)
DECLARE @Multiple varchar(20)
DECLARE @Select varchar(8000)
DECLARE @From varchar(8000)
DECLARE @OrderBy varchar(8000)

SET @CA='CA - '
SET @Multiple='Multiple'


/*TaskModeId:
1 - Planning
2 - Non Planning
3 - Unassigned
*/

DECLARE @PlanningTask bit
DECLARE @NonPlanningTask bit
DECLARE @UnassignedTask bit

DECLARE @CSStdJob bit
DECLARE @CSCA bit
DECLARE @CSCons bit
DECLARE @CSMan bit

SET @PlanningTask =0
	SET @NonPlanningTask =0
	SET @UnassignedTask =0

IF @TaskModeId<>''
BEGIN
	SELECT @PlanningTask =CASE List_Item WHEN 1 THEN 1 ELSE @PlanningTask END,
	@NonPlanningTask=CASE List_Item WHEN 2 THEN 1 ELSE @NonPlanningTask END,
	@UnassignedTask=CASE List_Item WHEN 3 THEN 1 ELSE @UnassignedTask END
	FROM dbo.LIST_TO_TABLE_F(@TaskModeId)

END

SET @CSStdJob =0
SET @CSCA =0
SET @CSCons =0
SET @CSMan =0

IF @CostSourceId<>''
BEGIN
	SELECT 
	@CSStdJob =CASE List_Item WHEN 1 THEN 1 ELSE @CSStdJob END,
	@CSCA=CASE List_Item WHEN 2 THEN 1 ELSE @CSCA END,
	@CSCons=CASE List_Item WHEN 3 THEN 1 ELSE @CSCons END,
	@CSMan=CASE List_Item WHEN 0 THEN 1 ELSE @CSMan END
	FROM dbo.LIST_TO_TABLE_F(@CostSourceId)

END

CREATE TABLE #z_ProjTaskSel(ProjTaskId int,EqpPlan varchar(100) COLLATE DATABASE_DEFAULT,ParentTaskId int,
FleetId_NV int,Fleet_NV varchar(50) COLLATE DATABASE_DEFAULT,EqpPlanId_NV int,EqpTypeId_NV int,
ModelId_NV int,Model_NV varchar(50) COLLATE DATABASE_DEFAULT,Site_NV varchar(50) COLLATE DATABASE_DEFAULT
PRIMARY KEY(ProjTaskId))
 
INSERT INTO #z_ProjTaskSel(ProjTaskId,EqpPlan,ParentTaskId,FleetId_NV,Fleet_NV,EqpPlanId_NV,EqpTypeId_NV,
ModelId_NV,Model_NV,Site_NV)

SELECT PT.ProjTaskId,EH.EqpPlan,PT.ParentTaskId,EH.FleetId AS FleetId_NV,EH.Fleet AS Fleet_NV,EH.EqpPlanId AS EqpPlanId_NV,
EH.Equipment_Type_Id AS EqpTypeId_NV,EH.ModelId AS ModelId_NV,EH.Model AS Model_NV,EH.Site AS Site_NV
FROM 
EQUIPMENT_HIERARCHY_V EH
	INNER JOIN
tblProjTasks PT
	ON EH.EqpProjId=PT.EqpProjId
	INNER JOIN
tblComponentCodes CC
	ON PT.ComponentCodeId=CC.ComponentCodeId
	INNER JOIN
tblSubSystems SS
	ON CC.SubSystemId=SS.SubSystemId

WHERE
(@EquipmentTypeId='' OR EH.Equipment_Type_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EquipmentTypeId))) AND
(@BranchId='' OR EH.BranchId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@BranchId))) AND
(@SiteId='' OR EH.SiteId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@SiteId))) AND
(@FleetId='' OR EH.FleetId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@FleetId))) AND
(@EqpPlanId='' OR EH.EqpPlanId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EqpPlanId))) AND
(@ModelId='' OR EH.ModelId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@ModelId))) AND
(@RegionId='' OR EH.Region_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@RegionId))) AND
(@DivisionId='' OR EH.Division_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@DivisionId))) AND
(@EqpCriticalityId='' OR EH.Eqp_Criticality_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EqpCriticalityId))) AND
(@EqpClassId='' OR EH.Eqp_Class_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EqpClassId))) AND
(@EqpGroupId='' OR EH.Equipment_Group_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EqpGroupId))) AND
(@EqpCategoryId='' OR EH.Eqp_Category_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EqpCategoryId))) AND
(@EqpCostCentreId='' OR EH.CostCentreID IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EqpCostCentreId))) AND
(@CostResponsibilityId='' OR EH.Cost_Responsibility_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@CostResponsibilityId))) AND
(@ProjectionHeaderId='' OR EH.ProjHeaderId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@ProjectionHeaderId))) AND
(@ParentEquipmentId='' OR EH.EqpPlanId IN (SELECT EqpPlanId FROM dbo.EQP_SIBLINGS_F(@ParentEquipmentId))) AND
(@EqpLocationId='' OR EH.Eqp_Location_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EqpLocationId))) AND
(@ContractTypeID='' OR EH.ContractTypeID IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@ContractTypeID))) AND	--AL: 31/03/09

--TaskFilters
(@SystemId='' OR SS.SystemId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@SystemId))) AND
(@SubSystemId='' OR SS.SubSystemId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@SubSystemId))) AND
(@ComponentCodeId='' OR CC.ComponentCodeId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@ComponentCodeId))) AND
(@TaskTypeId='' OR PT.TaskTypeId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@TaskTypeId))) AND
(@TaskHeaderId='' OR PT.Task_Header_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@TaskHeaderId))) AND
(@PlanningTask=0 OR (@PlanningTask=1 AND PT.Planning_Task=1)) AND
(@NonPlanningTask=0 OR (@NonPlanningTask=1 AND PT.Planning_Task=0)) AND
(@UnassignedTask=0 OR (@UnassignedTask=1 AND PT.Unscheduled<>0)) AND
(@PrimaryPartNumberID='' OR ISNULL(PT.Part_Id,-1) IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@PrimaryPartNumberID))) AND
(@ApplicationCodeId='' OR PT.ApplicationCodeId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@ApplicationCodeId)))AND 
(@ModifierId='' OR PT.ModifierId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@ModifierId))) 


--drop table z_ProjTaskSel
--select * into z_ProjTaskSel from #z_ProjTaskSel return


IF @EditJob=1
BEGIN
	CREATE TABLE #z_Cost_Allocation(ProjTaskAmtId int,JobCodeId int,CostCentreId int,WorkGroupId int,
	PCostExpenseId int,LCostExpenseId int,MCostExpenseId int,LabourActivityId int, CostBearerId int PRIMARY KEY(ProjTaskAmtId))

	INSERT INTO #z_Cost_Allocation(ProjTaskAmtId,WorkGroupId,CostCentreId,PCostExpenseId,LCostExpenseId,
	MCostExpenseId,CostBearerId,LabourActivityId,JobCodeId)
	SELECT PTA.ProjTaskAmtId,
	CASE COUNT(DISTINCT ISNULL(CAD.Work_Group_Id,0)) WHEN 1 THEN MAX(CAD.Work_Group_Id) ELSE -1 END AS WorkGroupId, 
	CASE COUNT(DISTINCT ISNULL(CAD.Cost_Centre_Id,0)) WHEN 1 THEN MAX(CAD.Cost_Centre_Id) ELSE -1 END AS CostCentreId,
	CASE COUNT(DISTINCT ISNULL(CAD.Parts_Cost_Expense_Id,0)) WHEN 1 THEN MAX(CAD.Parts_Cost_Expense_Id) ELSE -1 END  AS PCostExpenseId,
	CASE COUNT(DISTINCT ISNULL(CAD.Labour_Cost_Expense_Id,0)) WHEN 1 THEN MAX(CAD.Labour_Cost_Expense_Id) ELSE -1 END  AS LCostExpenseId, 
	CASE COUNT(DISTINCT ISNULL(CAD.Misc_Cost_Expense_Id,0)) WHEN 1 THEN MAX(CAD.Misc_Cost_Expense_Id) ELSE -1 END  AS MCostExpenseId, 
	CASE COUNT(DISTINCT ISNULL(CAD.Cost_Bearer_Id,0)) WHEN 1 THEN MAX(CAD.Cost_Bearer_Id) ELSE -1 END  AS CostBearerId, 
	CASE COUNT(DISTINCT ISNULL(CAD.Labour_Activity_Id,0)) WHEN 1 THEN MAX(CAD.Labour_Activity_Id) ELSE -1 END  AS LabourActivityId, 
	CASE COUNT(DISTINCT ISNULL(CAD.Job_Code_Id,0)) WHEN 1 THEN MAX(CAD.Job_Code_Id) ELSE -1 END  AS JobCodeId
	FROM
	#z_ProjTaskSel PT
		INNER JOIN
	tblProjTaskOpts PTO
		ON PT.ProjTaskId=PTO.ProjTaskId
		INNER JOIN
	tblProjTaskAmts PTA
		ON PTO.ProjTaskOptId=PTA.ProjTaskOptId
		INNER JOIN
	COST_ALLOCATION CA
		ON PTA.ProjTaskAmtId=CA.Proj_Task_Amt_Id
		INNER JOIN
	COST_ALLOCATION_DETAIL CAD
		ON CA.Cost_Allocation_Id=CAD.Cost_Allocation_Id
	GROUP BY PTA.ProjTaskAmtId

	--drop table z_Cost_Allocation
	--select * into z_Cost_Allocation from #z_Cost_Allocation return

	CREATE TABLE #z_ProjJobs(ProjTaskId int,ProjTaskAmtId int,
	Job_Code varchar(100) COLLATE DATABASE_DEFAULT,
	Currency varchar(100) COLLATE DATABASE_DEFAULT,
	Cost_Source varchar(100) COLLATE DATABASE_DEFAULT,
	Cost_Bearer varchar(100) COLLATE DATABASE_DEFAULT,
	Cost_Centre varchar(100) COLLATE DATABASE_DEFAULT,
	Work_Group varchar(100) COLLATE DATABASE_DEFAULT,
	Part_Type varchar(100) COLLATE DATABASE_DEFAULT,
	[OH&S] varchar(100) COLLATE DATABASE_DEFAULT,
	Pricing_Date datetime,
	Consumable_Qty float, 
	[Consumable_Top_Up_%] float, 
	Consumable_Price float,
	Job_Parts_Cost float,
	Job_Labour_Cost float, 
	Job_Misc_Cost float,
	Parts_Exp_Element varchar(100) COLLATE DATABASE_DEFAULT,
	Labour_Exp_Element varchar(100) COLLATE DATABASE_DEFAULT,
	Misc_Exp_Element varchar(100) COLLATE DATABASE_DEFAULT,
	Parts_EDC varchar(100) COLLATE DATABASE_DEFAULT, 
	Labour_EDC varchar(100) COLLATE DATABASE_DEFAULT, 
	Misc_EDC varchar(100) COLLATE DATABASE_DEFAULT,
	Labour_Type varchar(100) COLLATE DATABASE_DEFAULT,
	Job_Labour_Hours float,
	Labour_Activity varchar(100) COLLATE DATABASE_DEFAULT,
	Job_Duration float ,
	Standard_Job varchar(500) COLLATE DATABASE_DEFAULT
	PRIMARY KEY(ProjTaskId,ProjTaskAmtId))

	INSERT INTO #z_ProjJobs(ProjTaskId,ProjTaskAmtId,Job_Code,Currency,Cost_Source,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,
	[OH&S],Pricing_Date,Consumable_Qty, [Consumable_Top_Up_%],Consumable_Price,Job_Parts_Cost,Job_Labour_Cost, Job_Misc_Cost,
	Parts_Exp_Element,Labour_Exp_Element,Misc_Exp_Element,Parts_EDC, Labour_EDC, Misc_EDC,Labour_Type,Job_Labour_Hours,
	Labour_Activity,Job_Duration,Standard_Job)

	SELECT PT.ProjTaskId,PTA.ProjTaskAmtId,
	ISNULL(JC.Code+' - '+JC.Description,@CA+CASE WHEN CA.JobCodeId<0 THEN @Multiple ELSE JCA.Code+' - '+JCA.Description END) AS Job_Code,
	C.CurrencyDesc AS Currency,
	dbo.COST_SOURCE_DESC_GET_F(PTA.PricedJobId,CA.ProjTaskAmtId,PTA.Consumable,PT.ParentTaskId) AS Cost_Source,
	ISNULL(CB.CostBearer,@CA+CASE WHEN CA.CostBearerId<0 THEN @Multiple ELSE CBA.CostBearer END ) AS Cost_Bearer,
	ISNULL(CC.Cost_Centre_Code+' - '+CC.Cost_Centre_Desc,@CA+CASE WHEN CA.CostCentreId<0 THEN @Multiple ELSE CCA.Cost_Centre_Code+' - '+CCA.Cost_Centre_Desc END ) AS Cost_Centre,
	ISNULL(WG.Description,@CA+CASE WHEN CA.WorkgroupId<0 THEN @Multiple ELSE WGA.Description END) AS Work_Group,
	PTY.PartType + ' - ' + PTY.PartTypeDesc AS Part_Type,
	HS.Health_Safety AS [OH&S],
	CASE WHEN PTA.PricedJobId>0 THEN NULL ELSE PTA.Pricing_Date END AS Pricing_Date,

	CASE PTA.Consumable WHEN 1 THEN PTA.QtyVolume ELSE NULL END AS Consumable_Qty, 
	CASE PTA.Consumable WHEN 1 THEN PTA.PercentTopUp ELSE NULL END AS [Consumable_Top_Up_%], 
	CASE PTA.Consumable WHEN 1 THEN PTA.UnitPrice ELSE NULL END AS Consumable_Price,
	PTA.PartsCost AS Job_Parts_Cost,PTA.LaborCost AS Job_Labour_Cost, PTA.MiscCost AS Job_Misc_Cost,
	ISNULL(CEP.Cost_Expense_Code+' - '+CEP.Cost_Expense_Desc,@CA+CASE WHEN CA.PCostExpenseId<0 THEN @Multiple ELSE CEPA.Cost_Expense_Code+' - '+CEPA.Cost_Expense_Desc END) AS Parts_Exp_Element,
	ISNULL(CEL.Cost_Expense_Code+' - '+CEL.Cost_Expense_Desc,@CA+CASE WHEN CA.LCostExpenseId<0 THEN @Multiple ELSE CELA.Cost_Expense_Code+' - '+CELA.Cost_Expense_Desc END) AS Labour_Exp_Element,
	ISNULL(CEM.Cost_Expense_Code+' - '+CEM.Cost_Expense_Desc,@CA+CASE WHEN CA.MCostExpenseId<0 THEN @Multiple ELSE CEMA.Cost_Expense_Code+' - '+CEMA.Cost_Expense_Desc END) AS Misc_Exp_Element,
	EDCP.EDC_Id + ' - ' + EDCP.Journal_Description + ' : ' + EDCP.Debit_Account + '.' + EDCP.Debit_Account_Suffix AS Parts_EDC, 
	EDCL.EDC_Id + ' - ' + EDCL.Journal_Description + ' : ' + EDCL.Debit_Account + '.' + EDCL.Debit_Account_Suffix AS Labour_EDC, 
	EDCM.EDC_Id + ' - ' + EDCM.Journal_Description + ' : ' + EDCM.Debit_Account + '.' + EDCM.Debit_Account_Suffix AS Misc_EDC,
	CASE PTA.Labour_Hrs_Field WHEN 1 THEN 'Field' ELSE 'Shop' END AS Labour_Type,
	PTA.LaborHours AS Job_Labour_Hours,
	ISNULL(LA.ActivityCode+' - '+LA.LabourActivity,@CA+CASE WHEN CA.LabourActivityId<0 THEN @Multiple ELSE LAA.ActivityCode+' - '+LAA.LabourActivity END) AS Labour_Activity,
	PTA.Duration AS Job_Duration,
	SJ.StdJob AS Standard_Job

	FROM
	#z_ProjTaskSel PT
		INNER JOIN
	tblProjTaskOpts PTO
		ON PT.ProjTaskId=PTO.ProjTaskId
		INNER JOIN
	tblProjTaskAmts PTA
		ON PTO.ProjTaskOptId=PTA.ProjTaskOptId
	INNER JOIN 
	tblCurrencies C
		ON PTA.CurrencyId=C.CurrencyId	
		LEFT OUTER JOIN
	tblPartTypes PTY
		ON PTA.PartTypeId=PTY.PartTypeId
		LEFT OUTER JOIN 
	tblJobCodes JC
		ON PTA.JobCodeId=JC.JobCodeId
		LEFT OUTER JOIN 
	tblCostBearers CB
		ON PTA.Cost_Bearer_Id=CB.CostBearerid
		LEFT OUTER JOIN
	tblLabourActivities LA
		ON PTA.Labour_Activity_Id=LA.LabourActivityId
		LEFT OUTER JOIN
	COST_EXPENSE CEP
		ON PTA.Parts_Cost_Expense_ID=CEP.Cost_Expense_Id
		LEFT OUTER JOIN
	COST_EXPENSE CEL
		ON PTA.Labour_Cost_Expense_ID=CEL.Cost_Expense_Id
		LEFT OUTER JOIN
	COST_EXPENSE CEM
		ON PTA.Misc_Cost_Expense_ID=CEM.Cost_Expense_Id
		LEFT OUTER JOIN
	COST_CENTRE CC
		ON PTA.Cost_Centre_Id=CC.Cost_Centre_Id
		LEFT OUTER JOIN
	WORK_GROUP WG
		ON PTA.Work_Group_Id=WG.Work_Group_Id
		LEFT OUTER JOIN
	HEALTH_SAFETY HS
		ON PTA.Health_Safety_Id=HS.Health_Safety_Id
		LEFT OUTER JOIN
	ENTRY_DISTRIBUTION_CODE EDCM 
		ON PTA.Misc_EDC_ID = EDCM.Id 
		LEFT OUTER JOIN
	ENTRY_DISTRIBUTION_CODE EDCL 
		ON PTA.Labour_EDC_ID = EDCL.Id 
		LEFT OUTER JOIN
	ENTRY_DISTRIBUTION_CODE EDCP 
		ON PTA.Parts_EDC_ID = EDCP.Id

		LEFT OUTER JOIN
	#z_Cost_Allocation CA
		ON PTA.ProjTaskAmtId=CA.ProjTaskAmtId
		LEFT OUTER JOIN 
	tblJobCodes JCA
		ON CA.JobCodeId=JCA.JobCodeId
		LEFT OUTER JOIN 
	tblCostBearers CBA
		ON CA.CostBearerId=CBA.CostBearerid
		LEFT OUTER JOIN
	tblLabourActivities LAA
		ON CA.LabourActivityId=LAA.LabourActivityId
		LEFT OUTER JOIN
	COST_EXPENSE CEPA
		ON CA.PCostExpenseID=CEPA.Cost_Expense_Id
		LEFT OUTER JOIN
	COST_EXPENSE CELA
		ON CA.LCostExpenseID=CELA.Cost_Expense_Id
		LEFT OUTER JOIN
	COST_EXPENSE CEMA
		ON CA.MCostExpenseID=CEMA.Cost_Expense_Id
		LEFT OUTER JOIN
	COST_CENTRE CCA
		ON CA.CostCentreId=CCA.Cost_Centre_Id
		LEFT OUTER JOIN
	WORK_GROUP WGA
		ON CA.WorkGroupId=WGA.Work_Group_Id 
		LEFT OUTER JOIN
	tblPricedJobs PJ ON PJ.PricedJobId = PTA.PricedJobId
	LEFT OUTER JOIN tblStdJobs SJ ON SJ.StdJobId = PJ.StdJobId

	WHERE 
	--(@JobCodeId='' OR ISNULL(PTA.JobCodeId,CA.JobCodeId) IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@JobCodeId))) AND
	(@JobCodeId='' OR PTA.JobCodeId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@JobCodeId))) AND
	(@CurrencyId='' OR PTA.CurrencyId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@CurrencyId))) AND
	 (@CSStdJob=0 OR (@CSStdJob=1 AND PTA.PricedJobId>0)) AND
	 (@CSCA=0 OR (@CSCA=1 AND CA.ProjTaskAmtId>0)) AND
	 (@CSCons=0 OR (@CSCons=1 AND PTA.Consumable=1)) AND
	 (@CSMan=0 OR (@CSMan=1 AND PTA.PricedJobId IS NULL AND CA.ProjTaskAmtId IS NULL AND PTA.Consumable=0 AND PT.ParentTaskId IS NULL))

	DROP TABLE #z_Cost_Allocation
END

IF @TaskFields<>'' SET @TaskFields='TEF.'+REPLACE(@TaskFields,',',',TEF.')

SET @OrderBy='
ORDER BY PT.EqpPlan, TEF.Component_Code, TEF.Modifier_Code, TEF.Task_Type, TEF.Task_Counter'+ 
	CASE WHEN @TaskFields<>'' THEN ','+@TaskFields ELSE '' END

IF @TaskFields<>'' SET @TaskFields=@TaskFields+','

SET @Select='TEF.ProjTaskId,PT.EqpPlan, TEF.Component_Code, TEF.Modifier_Code, TEF.Task_Type, TEF.Task_Counter,'+@TaskFields+ 'TEF.Task_Cost'

SET @From=' FROM
MULTI_TASK_EDITOR_TASK_V TEF
	INNER JOIN
#z_ProjTaskSel PT
	ON TEF.ProjTaskId=PT.ProjTaskId'

IF @EditJob=1
BEGIN

	IF @JobFields<>'' SET @JobFields='J.'+REPLACE(@JobFields,',',',J.')

	SET @OrderBy=@OrderBy+',J.Job_Code,J.Currency,J.Cost_Source'+ CASE WHEN @JobFields<>'' THEN ','+@JobFields ELSE '' END

	IF @JobFields<>'' SET @JobFields=@JobFields+','

	SET @Select=@Select+',J.Job_Code,J.Currency,J.Cost_Source,'+@JobFields+'J.ProjTaskAmtId '
	SET @From=@From+'
	LEFT JOIN
#z_ProjJobs J
	ON PT.ProjTaskId=J.ProjTaskId'
	
END

--VV Added this because of the bug in SQL2005 - without this "where"
--an error pops up "The query processor could not produce a query plan." 
--SET @From=@From+'
--WHERE TEF.ProjTaskId IN (SELECT ProjTaskId FROM #z_ProjTaskSel) '

--drop table z_ProjTaskSel
--select * into z_ProjTaskSel from #z_ProjTaskSel

/*
print('SELECT TEF.SystemId_NV,TEF.System_NV,TEF.SubSystemId_NV,TEF.SubSystem_NV,PT.ModelId_NV,PT.Model_NV,PT.Site_NV,
PT.FleetId_NV,PT.Fleet_NV,PT.EqpPlanId_NV,PT.EqpTypeId_NV,TEF.ComponentCodeId_NV,TEF.ModifierId_NV,TEF.TaskTypeId_NV,
TEF.QUOMId_NV,TEF.QUOM_NV,TEF.ApplicationCodeId_NV,'+
@Select+@From+ @OrderBy)
*/

EXEC('SELECT TEF.SystemId_NV,TEF.System_NV,TEF.SubSystemId_NV,TEF.SubSystem_NV,PT.ModelId_NV,PT.Model_NV,PT.Site_NV,
PT.FleetId_NV,PT.Fleet_NV,PT.EqpPlanId_NV,PT.EqpTypeId_NV,TEF.ComponentCodeId_NV,TEF.ModifierId_NV,TEF.TaskTypeId_NV,
TEF.QUOMId_NV,TEF.QUOM_NV,TEF.ApplicationCodeId_NV,/*VV E316*/TEF.PartRatingId_NV,'+
@Select+@From+ @OrderBy)


DROP TABLE #z_ProjTaskSel

IF @EditJob=1 
BEGIN
	DROP TABLE #z_ProjJobs

	SET @Select=REPLACE(@Select,',J.ProjTaskAmtId','')
END

SET @Select=REPLACE(@Select,'TEF.ProjTaskId,','')
SET @Select=REPLACE(@Select,'PT.','')
SET @Select=REPLACE(@Select,'TEF.','')
SET @Select=REPLACE(@Select,'J.','')

--print 'SELECT '+@Select+' FROM dbo.MULTI_TASK_EDITOR_FLD_FORMAT_F()'
EXEC('SELECT '+@Select+' FROM dbo.MULTI_TASK_EDITOR_FLD_FORMAT_F()')

SET @From='
FROM
MULTI_TASK_EDITOR_TASK_FLD_ID_V TEF
	CROSS JOIN
MULTI_TASK_EDITOR_JOB_FLD_ID_V J'



SET @Select=REPLACE(@Select,'EqpPlan,','')
SET @Select=REPLACE(@Select,'Task_Cost,','')


--print ('SELECT  '+@Select+@From)
EXEC('SELECT  '+@Select+@From)

SELECT 'Component_Code' AS Component_Code, 'Modifier_Code_MTE' AS Modifier_Code, 'Task_Type' AS Task_Type, 
'Task_Counter_MTE' AS Task_Counter, 'Operational_Criticality_MTE' AS Operational_Criticality, 
'TEManufacturer' AS Manufacturer, 'Primary_Part_Number_MTE' AS Primary_Part_Number, 'QUOM_MTE' AS UOM,
'Job_Code_MTE' AS Job_Code, 'Currency' AS Currency,  'CostBearer' AS Cost_Bearer, 'CostCentre_MTE' AS Cost_Centre, 
'Work_Group_MTE' AS Work_Group, 'Part_Type_MTE' AS Part_Type,'HealthSafety_MTE' AS [OH&S],  'CostExpense_MTE' AS Parts_Exp_Element, 
'CostExpense_MTE' AS Labour_Exp_Element, 'CostExpense_MTE' AS Misc_Exp_Element, 'LabourActivity_MTE' AS Labour_Activity,
'EDC_MTE' AS Parts_EDC, 'EDC_MTE' AS Labour_EDC, 'EDC_MTE' AS Misc_EDC,
'PerformanceStrategy' AS  Performance_Strategy,
'ComponentStructure' AS Component_Structure,/*VV E316*/'PartRating' AS PartRating,
--'Task_Mode' AS Task_Mode,
/*E781*/'Site' AS DefaultLocationForRebuild, 'PartClassification' AS PartClassification

/*VV CR8604
IF @Filter_Std_Job_Model = 1 */
IF @GetModel=1
	SELECT ModelId , Model FROM tblModels WHERE ModelId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@ModelId))
--DROP TABLE z_ProjJobs
--select * into z_ProjJobs from #z_ProjJobs
--drop table z_Cost_Allocation
--select * into z_Cost_Allocation from #z_Cost_Allocation return
--drop table z_ProjTaskSel
--select * into z_ProjTaskSel from #z_ProjTaskSel return





GO 




/****** Object:  StoredProcedure [dbo].[RPT_WORKORDER_AUTHORISATION_GET_P]    Script Date: 12/08/2011 13:30:53 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[KIRD_EXPORT_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[KIRD_EXPORT_P]
GO


CREATE PROCEDURE [dbo].[KIRD_EXPORT_P]
/******************************************************************************
	
	Name: KIRD_EXPORT_P

	Called By: 

	Desc: 

	Auth: 	Sergey Ivanov
	Date: 	30 June 2005
*******************************************************************************
		Change History
*******************************************************************************
Date:		Author:		Description:
--------	--------	----------------------------------------
20 Aug 2009	V Vasylyeva	CR8375	Increasing Modifier Code to 50 char
14 Apr 09	V Vasylyeva	CR7985. Changed application code from 10 to 50 char
10 Dec 08	KN			Modified the length of Model from 10 to 20
15 May 08	YS			Removed requirement for Simulation Reference
						Changed lengths of varchars in temp tables to match their respective tables
21-Jul-07	KN			Fixed - Collation and tempDB Conflicts
24 Nov 06	KN		Assign Default Job Code if Job Code is Null
14 Nov 06	SI		Changed to support date based tasks
01 Aug 06 	SI		Changed the size of Std_Job_Header_ID from 50 to 500
18.08.05	SI		Substituted quom.SAPQUOM by Short_Desc
25 Mar 2011 GD		Changed the length of Application_Code from 50 to 100
16 Apr 2012 TW		#3738 handler dodger data in description
*******************************************************************************/
	/* Param List */
@mode int=0, -- 0-export, 1-generate tables for UI, 2-export from Projections
@isCodeMap bit=0,
--FILTERS !!!
@Branch varchar(50)='',
@Price_Group varchar(50)='',
@Model varchar(20)='',
@ComponentCode varchar(10)='',
@JobCode varchar(10)='',
@Currency varchar(3)='',
@SimulationRef varchar(175)='', -- CAN BE EMPTY
@isLive int=0, -- 0-fixed, 1-Live, CONNOT BE Both(2)!!!
@System_Source varchar(10)='',
@isDummy int=2, -- 0-NoDummy, 1-Dummy, 2-All
@JobIDs text='', -- IDs of jobs to import ('01','03','12')
-- New Values
@NewSimulationRef varchar(175)='',
@NRecords int = 0 OUTPUT

AS
/*
DECLARE @ComponentCode varchar(10)
SET @ComponentCode='';
IF @ComponentCodeId>=0
	SELECT @ComponentCode=Code FROM tblComponentCodes WHERE ComponentCodeID=@ComponentCodeId
*/
CREATE TABLE #I_STD_JOB_HEADER (
	StdJobId int NOT NULL,
	Std_Job_Header_ID varchar (500) COLLATE database_default NOT NULL CHECK (LTRIM(RTRIM(Std_Job_Header_ID)) <> ''), --PRIMARY KEY CLUSTERED,
	Std_Job_Description varchar (500) COLLATE database_default NOT NULL ,
	Model varchar (20) COLLATE database_default NOT NULL CHECK (LTRIM(RTRIM(Model)) <> ''),
	Serial_No_Prefix varchar (50) COLLATE database_default NULL ,
	Serial_No_Start varchar (50) COLLATE database_default NULL ,
	Serial_No_End varchar (50) COLLATE database_default NULL ,
	Live_Job bit NULL DEFAULT 1,
	Dummy_Job bit NULL DEFAULT 0,
	System_Source varchar (20) COLLATE database_default NOT NULL CHECK (LTRIM(RTRIM(System_Source)) <> ''),
	Component_Code varchar (50) COLLATE database_default NOT NULL CHECK (LTRIM(RTRIM(Component_Code)) <> ''),
	/*VV CR8375*/
	Modifier_Code varchar (50) COLLATE database_default NULL ,
	Job_Code varchar (50) COLLATE database_default NOT NULL CHECK (LTRIM(RTRIM(Job_Code)) <> ''),
	Task_Type varchar (10) COLLATE database_default NULL ,
	Occurrence_Type varchar (10) COLLATE database_default NULL ,
	Option_Pobability float NULL ,
	Job_Default_Option bit NULL DEFAULT 1,
	--GD 25-Mar-2011 Changed application code to 100 char
	--Application_Code varchar (50) COLLATE database_default NULL ,
	Application_Code varchar (100) COLLATE database_default NULL ,
	Work_Application varchar (5) COLLATE database_default NULL ,
	Job_Condition varchar (50) COLLATE database_default NULL ,
	Cab_Type varchar (5) COLLATE database_default NULL ,
	Job_Location varchar (50) COLLATE database_default NULL ,
	Pricing_Branch varchar (50) COLLATE database_default NULL ,
	Price_Group varchar (50) COLLATE database_default NULL ,
	Currency varchar (3) COLLATE database_default NOT NULL CHECK (LTRIM(RTRIM(Currency)) <> ''),
	Overwrite_Costs bit NULL DEFAULT 0,
	Job_Quantity int NULL DEFAULT 1,
	Parts_Usage_Factor float NULL DEFAULT 1,
	Parts_Cost float NOT NULL ,
	Labour_Cost float NOT NULL ,
	Misc_Cost float NOT NULL ,
	Labour_Hrs float NOT NULL ,
	Simulation_Reference varchar (175) COLLATE database_default NOT NULL CHECK (LTRIM(RTRIM(Simulation_Reference)) <> ''),
	Simulation_Description varchar (500) COLLATE database_default NULL ,
	Group_No varchar (50) COLLATE database_default NULL ,
	Use_Rotable bit NULL DEFAULT 0,
	Supplier varchar (20) COLLATE database_default NULL ,
	Rotable_Part_Number varchar (50) COLLATE database_default NULL ,
	Default_First float NULL DEFAULT 0,
	Default_Interval float NULL DEFAULT 0,
	Unit_Of_Measure varchar (50) COLLATE database_default NULL ,
	Company varchar (50) COLLATE database_default NULL ,
	Branch varchar (50) COLLATE database_default NULL ,
	Site varchar (50) COLLATE database_default NULL ,
	Fleet varchar (50) COLLATE database_default NULL ,
	Equipment varchar (50) COLLATE database_default NULL ,
	Serial_Number varchar (50) COLLATE database_default NULL ,
	Projection_Type varchar (50) COLLATE database_default NULL ,
	Planning_Task bit NOT NULL ,
	Lead_Time_Days float NULL ,
	Not_After float NULL ,
	Last_Change_Date datetime NULL ,
	Last_Change_Usage float NULL ,
	Use_Std_Job bit NULL ,
	Pricing_Date datetime DEFAULT (getdate()) ,
	Part_Type varchar (50) COLLATE database_default NULL ,
	Labour_Activity varchar (50) COLLATE database_default NULL
)
CREATE TABLE #I_STD_JOB_OPERATION (
	--StdJobOperationId int NOT NULL,
	Std_Job_Operation_ID varchar (50) COLLATE database_default NOT NULL CHECK (LTRIM(RTRIM(Std_Job_Operation_ID)) <> '') PRIMARY KEY CLUSTERED,
	Std_Job_Header_ID varchar (500) COLLATE database_default NOT NULL CHECK (LTRIM(RTRIM(Std_Job_Header_ID)) <> ''), --REFERENCES #I_STD_JOB_HEADER (Std_Job_Header_ID),
	Name varchar (500) COLLATE database_default NULL ,
	Component_Code varchar (50) COLLATE database_default NULL,
	Job_Code varchar (50) COLLATE database_default NULL,
	Duration_Hours float NULL DEFAULT (0),
	Group_No varchar (50) COLLATE database_default NULL 
)
CREATE TABLE #I_STD_JOB_PARTS (
	Std_Job_Operation_ID varchar (50) COLLATE database_default NOT NULL CHECK (LTRIM(RTRIM(Std_Job_Operation_ID)) <> ''), --REFERENCES #I_STD_JOB_OPERATION(Std_Job_Operation_ID),
	Part_Number varchar (50) COLLATE database_default NOT NULL CHECK (LTRIM(RTRIM(Part_Number)) <> ''),
	Part_Source_Of_Supply varchar (10) COLLATE database_default NOT NULL CHECK (LTRIM(RTRIM(Part_Source_Of_Supply)) <> ''),
	Part_Description varchar (50) COLLATE database_default NULL ,
	Part_Type varchar (10) COLLATE database_default NOT NULL CHECK (LTRIM(RTRIM(Part_Type)) <> ''),
	Part_Unit_Cost float NULL,
	Part_Unit_Sell float NULL,
	Part_Quantity float NULL DEFAULT (0),
	Part_Probability float NULL DEFAULT (100),
	Core_Credit varchar (10) COLLATE database_default NULL DEFAULT 'PARTIAL',
	Full_Credit_Cost float NULL ,
	Full_Credit_Sell float NULL ,
	Partial_Credit_Cost float NULL ,
	Partial_Credit_Sell float NULL 
)
CREATE TABLE #I_STD_JOB_LABOUR (
	Std_Job_Operation_ID varchar (50) COLLATE database_default NOT NULL CHECK (LTRIM(RTRIM(Std_Job_Operation_ID)) <> ''), --REFERENCES #I_STD_JOB_OPERATION(Std_Job_Operation_ID),
	Labour_Activity varchar (50) COLLATE database_default NULL ,
	Description varchar (50) COLLATE database_default NULL ,
	Cost_Rate float NULL ,
	Sell_Rate float NULL ,
	Hours float NULL DEFAULT (0)
)
CREATE TABLE #I_STD_JOB_MISC (
	Std_Job_Operation_ID varchar (50) COLLATE database_default NOT NULL CHECK (LTRIM(RTRIM(Std_Job_Operation_ID)) <> ''), --REFERENCES #I_STD_JOB_OPERATION(Std_Job_Operation_ID),
	Description varchar (50) COLLATE database_default NULL ,
	Cost float NULL DEFAULT (0),
	Sell float NULL DEFAULT (0)
)

---------------------------------------------------------------
-- getting default values
DECLARE @gccDefcc varchar(10)
SELECT TOP 1 @gccDefcc=Global_Component_Code FROM GLOBAL_COMPONENT_CODES WHERE Default_Record<>0

DECLARE @DefJobCode varchar(10)
DECLARE @DefGlobalJobCode varchar(10)
SELECT     TOP 1 @DefGlobalJobCode = GLOBAL_JOB_CODES.Global_Job_Code, @DefJobCode =  tblJobCodes.Code
FROM         tblJobCodes INNER JOIN
                      GLOBAL_JOB_CODES ON tblJobCodes.Global_Job_Code_Id = GLOBAL_JOB_CODES.Global_Job_Id
WHERE     (tblJobCodes.Default_Record = 1)

----------------------------------------------------------------

	INSERT #I_STD_JOB_HEADER
	SELECT 
		sjh.StdJobId,
		sjh.Std_Job_Ref as Std_Job_Header_ID,
		sjh.StdJob as Std_Job_Description,
		mod.Model,
		sjh.Serial_No_Prefix,
		sjh.Serial_No_Start,
		sjh.Serial_No_End,
		sjh.Live_Job,
		sjh.Dummy_Job,
		ss.System_Source_Code as System_Source,
		CASE WHEN @isCodeMap=0 THEN cc.Code ELSE (CASE WHEN gcc.Global_Component_Code IS NULL THEN @gccDefcc ELSE gcc.Global_Component_Code END) END as Component_Code,
		mc.Code as Modifier_Code,
		CASE WHEN @isCodeMap=0 THEN ISNULL(jc.Code,@DefJobCode) ELSE ISNULL(gjc.Global_Job_Code,@DefGlobalJobCode) END as Job_Code,
		tt.Code as Task_Type,
		ot.OccurrenceType as Occurrence_Type,
		sjh.Option_Pobability,
		sjh.Job_Default_Option,
		ac.Code as Application_Code,
		wa.Work_Application_Code as Work_Application,
		jcon.Job_Condition_Code as Job_Condition,
		ct.Cab_Type_Code as Cab_Type,
		jl.Job_Location_Code as Job_Location,
		br.Branch as Pricing_Branch,
		pg.Price_Group,
		cur.Currency,
		sjh.Overwrite_Costs,
		sjh.Job_Quantity,
		sjh.Parts_Usage_Factor,
		pj.PartsCost as Parts_Cost,
		pj.LabourCost as Labour_Cost,
		pj.MiscCost as Misc_Cost,
		pj.LabourHours as Labour_Hrs,
		sjh.Simulation_Reference,
		sjh.Simulation_Description,
		sjh.Group_No,
		sjh.Use_Rotable,
		man.Manufacturer, --sjh.Supplier,
		CASE WHEN sjh.Use_Rotable=1 THEN rp.Part_Number ELSE p.Part END as Rotable_Part_Number,
		sjh.Default_First,
		sjh.Default_Interval,
		CASE WHEN sjh.QUOM_ID IS NULL THEN 'Days' ELSE quom.Short_Desc END as Unit_Of_Measure,
		dl.Dealer as Company,
		br.Branch,
		sjh.Site,
		sjh.Fleet,
		sjh.Equipment,
		sjh.Serial_Number,
		CASE WHEN prtp.Projection_Type_Name IS NULL THEN '' ELSE prtp.Projection_Type_Name END,
		sjh.Planning_Task,
		sjh.Lead_Days,
		sjh.Not_After,
		sjh.Last_Change_Date,
		sjh.Last_Change_Usage,
		sjh.Use_Std_Job,
		sjh.Pricing_Date,
		CASE WHEN @isCodeMap=0 THEN pt.PartType ELSE gpt.Global_Part_Type END as Part_Type,
		la.ActivityCode as Labour_Activity
	FROM tblStdJobs sjh
		LEFT JOIN tblModels mod ON sjh.ModelId=mod.ModelId
		LEFT JOIN tblCurrencies cur ON sjh.Currency_ID=cur.CurrencyID
		LEFT JOIN tblQUOMs quom ON sjh.QUOM_ID=quom.QUOMId
		LEFT JOIN SYSTEM_SOURCE ss ON sjh.System_Source_ID=ss.System_Source_ID
		LEFT JOIN tblComponentCodes cc ON sjh.ComponentCodeId=cc.ComponentCodeID
		LEFT JOIN GLOBAL_COMPONENT_CODE_LINK gccl ON gccl.AMT_Component_Code_Id=cc.ComponentCodeID
		LEFT JOIN GLOBAL_COMPONENT_CODES gcc ON gccl.Global_Component_Code_Id=gcc.Global_ID
		LEFT JOIN tblModifierCodes mc ON sjh.ModifierCodeId=mc.ModifierID
		LEFT JOIN tblJobCodes jc ON sjh.JobCodeId=jc.JobCodeID
		LEFT JOIN GLOBAL_JOB_CODES gjc ON jc.Global_Job_Code_Id=gjc.Global_Job_Id
		LEFT JOIN tblTaskTypes tt ON sjh.TaskTypeId=tt.TaskTypeID
		LEFT JOIN tblApplicationCodes ac ON sjh.ApplicationCodeID=ac.ApplicationCodeID
		LEFT JOIN tblOccurrenceTypes ot ON sjh.Occurrence_Type_Id=ot.OccurrenceTypeId
		LEFT JOIN JOB_LOCATION jl ON sjh.Job_Location_ID=jl.Job_Location_ID
		LEFT JOIN WORK_APPLICATION wa ON sjh.Work_Application_ID=wa.Work_Application_ID
		LEFT JOIN JOB_CONDITION jcon ON sjh.Job_Condition_ID=jcon.Job_Condition_ID
		LEFT JOIN CAB_TYPE ct ON sjh.Cab_Type_ID=ct.Cab_Type_ID
		LEFT JOIN PROJECTION_TYPE prtp ON prtp.Projection_Type_ID=sjh.Projection_Type
		LEFT JOIN tblPartTypes pt ON sjh.Part_Type_ID=pt.PartTypeId
		LEFT JOIN GLOBAL_PART_TYPES gpt ON pt.Global_Part_Type_Id=gpt.Global_Part_Type_Id
		LEFT JOIN tblLabourActivities la ON sjh.Labour_Activity_ID=la.LabourActivityId
		LEFT JOIN tblManufacturers man ON sjh.Manufacturer_Id=man.ManufacturerId
		LEFT JOIN ROTABLE_PART rp ON sjh.Rotable_Part_Id=rp.Rotable_Part_Id
		LEFT JOIN tblParts p ON sjh.Rotable_Part_Id=p.PartId
		LEFT JOIN tblPricedJobs pj ON pj.StdJobId=sjh.StdJobId
		LEFT JOIN PRICE_GROUP pg ON pg.Price_Group_ID=pj.Price_Group_ID
		LEFT JOIN tblBranches br ON br.BranchId=pj.BranchId
		LEFT JOIN tblDealers dl ON dl.DealerId=br.DealerId

DELETE #I_STD_JOB_HEADER
	WHERE
		-- Filters
		    (Branch<>@Branch AND ISNULL(@Branch,'')<>'')
		OR (Price_Group<>@Price_Group AND ISNULL(@Price_Group,'')<>'')
		OR (Model<>@Model AND ISNULL(@Model,'')<>'')
		OR (Component_Code<>@ComponentCode AND ISNULL(@ComponentCode,'')<>'')
		OR (Job_Code<>@JobCode AND ISNULL(@JobCode,'')<>'')
		OR (Currency<>@Currency AND ISNULL(@Currency,'')<>'')
		OR (Simulation_Reference<>@SimulationRef AND ISNULL(@SimulationRef,'')<>'')
		OR (Live_Job<>@isLive)
		OR (System_Source<>@System_Source AND ISNULL(@System_Source,'')<>'')
		OR (NOT (Dummy_Job=0 AND @isDummy=0) AND NOT (Dummy_Job=1 AND @isDummy=1) AND NOT @isDummy=2)

--SELECT * FROM #I_STD_JOB_HEADER
--return

-- generate tables for UI
IF @mode=1
BEGIN
	SELECT Std_Job_Header_ID, Branch, Price_Group, Std_Job_Description, Model, Component_Code, 
		Modifier_Code, Job_Code, Labour_Hrs, Parts_Cost+Labour_Cost+Misc_Cost as Total_Cost, Currency, System_Source
	FROM #I_STD_JOB_HEADER isjh
	ORDER BY 2,3,5,6,7,8

	RETURN
END
--#3738
IF (@mode<>1) AND (@JobIDs IS NOT NULL) AND (@JobIDs NOT LIKE '')
	--EXEC ('DELETE #I_STD_JOB_HEADER WHERE Std_Job_Header_ID NOT IN ('+@JobIDs+')')
	DELETE H FROM #I_STD_JOB_HEADER H LEFT JOIN [LIST_TO_TABLE_3_F](SUBSTRING(@JobIDs, 2, DATALENGTH(@JobIDs)-2), ''',''') L 
	ON H.Std_Job_Header_ID = L.list_item
	WHERE L.List_item is Null
	

SELECT @NRecords=count(*) FROM #I_STD_JOB_HEADER

IF (ISNULL(@Branch,'')='')
BEGIN
	RAISERROR ('You must specify a filter for Branch', 16, 1)		
	RETURN
END
IF (ISNULL(@Price_Group,'')='')
BEGIN
	RAISERROR ('You must specify a filter for Price Group', 16, 1)		
	RETURN
END
--IF (ISNULL(@SimulationRef,'')='')
--BEGIN
--	RAISERROR ('You must specify a filter for Simulation Reference', 16, 1)		
--	RETURN
--END
IF (@isLive<0 OR @isLive>1)
BEGIN
	RAISERROR ('You can choose only Fixed or Live status (not both)', 16, 1)
	RETURN
END

IF ISNULL(@NewSimulationRef,'')<>''
	UPDATE #I_STD_JOB_HEADER
	SET Simulation_Reference=@NewSimulationRef

INSERT #I_STD_JOB_OPERATION
SELECT
	--sjo.Std_Job_Operation_Ref as Std_Job_Operation_ID,
	sjo.StdJobOperationId as Std_Job_Operation_ID,
	isjh.Std_Job_Header_ID as Std_Job_Header_ID,
	sjo.StdJobOperation as Name,
	CASE WHEN @isCodeMap=0 THEN cc.Code ELSE gcc.Global_Component_Code END as Component_Code,
	CASE WHEN @isCodeMap=0 THEN jc.Code ELSE gjc.Global_Job_Code END as Job_Code,
	sjo.DurationHours,
	sjo.Group_No
FROM tblStdJobOperations sjo
		LEFT JOIN #I_STD_JOB_HEADER isjh ON isjh.StdJobId=sjo.StdJobId
		LEFT JOIN tblComponentCodes cc ON sjo.ComponentCodeId=cc.ComponentCodeID
		LEFT JOIN GLOBAL_COMPONENT_CODE_LINK gccl ON gccl.AMT_Component_Code_Id=cc.ComponentCodeID
		LEFT JOIN GLOBAL_COMPONENT_CODES gcc ON gccl.Global_Component_Code_Id=gcc.Global_ID
		LEFT JOIN tblModifierCodes mc ON sjo.ModifierCodeId=mc.ModifierID
		LEFT JOIN tblJobCodes jc ON sjo.JobCodeId=jc.JobCodeID
		LEFT JOIN GLOBAL_JOB_CODES gjc ON jc.Global_Job_Code_Id=gjc.Global_Job_Id
		LEFT JOIN tblApplicationCodes ac ON sjo.ApplicationCodeID=ac.ApplicationCodeID
WHERE isjh.Std_Job_Header_ID IS NOT NULL

INSERT #I_STD_JOB_PARTS
SELECT 
	--sjo.Std_Job_Operation_Ref as Std_Job_Operation_ID,
	sjo.StdJobOperationId as Std_Job_Operation_ID,
	p.Part as Part_Number,
	sos.Sos_Code as Part_Source_Of_Supply,
	p.PartDescription as Part_Description,
	pt.PartType as Part_Type,
	pp.Part_Cost as Part_Unit_Cost,
	pp.Part_Sell as Part_Unit_Sell,
	sjop.Quantity as Part_Quantity,
	sjop.Probability as Part_Probability,
	CASE WHEN Use_Credit_Price=0 THEN 'NONE' WHEN Use_Credit_Price=1 AND Full_Credit=0 THEN 'PARTIAL' ELSE 'FULL' END as Core_Credit,
	pp.Full_Credit_Cost,
	pp.Full_Credit_Sell,
	pp.Partial_Credit_Cost,
	pp.Partial_Credit_Sell
FROM tblStdJobOperationParts sjop
		LEFT JOIN tblParts p ON p.PartId=sjop.PartId
		LEFT JOIN tblPartTypes pt ON pt.PartTypeId=p.Part_Type_ID
		LEFT JOIN SOURCE_OF_SUPPLY sos ON sos.Source_Of_Supply_ID=p.Source_Of_Supply_ID
		LEFT JOIN tblStdJobOperations sjo ON sjo.StdJobOperationId=sjop.StdJobOperationId
		LEFT JOIN #I_STD_JOB_HEADER isjh ON isjh.StdJobId=sjo.StdJobId
		LEFT JOIN PRICE_GROUP pg ON pg.Price_Group=isjh.Price_Group
		LEFT JOIN tblCurrencies cur ON cur.Currency=isjh.Currency
		LEFT JOIN tblPartPrices pp ON pp.PartId=p.PartId AND pp.CurrencyId=cur.CurrencyID AND pp.Price_Group_ID=pg.Price_Group_ID
WHERE isjh.Std_Job_Header_ID IS NOT NULL

INSERT #I_STD_JOB_LABOUR
SELECT 
	--sjo.Std_Job_Operation_Ref as Std_Job_Operation_ID,
	sjo.StdJobOperationId as Std_Job_Operation_ID,
	la.ActivityCode as Labour_Activity,
	sjol.Std_Job_Operation_Labour_Desc as Description,
	sjol.Cost_Rate,
	sjol.Sell_Rate,
	sjol.Labour_Hrs as Hours
FROM STD_JOB_OPERATION_LABOUR sjol
		LEFT JOIN tblStdJobOperations sjo ON sjo.StdJobOperationId=sjol.Std_Job_Operation_ID
		LEFT JOIN #I_STD_JOB_HEADER isjh ON isjh.StdJobId=sjo.StdJobId
		LEFT JOIN tblLabourActivities la ON sjol.Labour_Activity_ID=la.LabourActivityId
WHERE isjh.Std_Job_Header_ID IS NOT NULL

INSERT #I_STD_JOB_MISC
SELECT 
	--sjo.Std_Job_Operation_Ref as Std_Job_Operation_ID,
	sjo.StdJobOperationId as Std_Job_Operation_ID,
	sjom.Std_Job_Operation_Misc_Desc as Description,
	sjom.Cost,
	sjom.Sell
FROM STD_JOB_OPERATION_MISC sjom
		LEFT JOIN tblStdJobOperations sjo ON sjo.StdJobOperationId=sjom.Std_Job_Operation_ID
		LEFT JOIN #I_STD_JOB_HEADER isjh ON isjh.StdJobId=sjo.StdJobId
WHERE isjh.Std_Job_Header_ID IS NOT NULL

-- Parse to XML
SELECT 	Std_Job_Header_ID, Std_Job_Description, Model, Serial_No_Prefix, Serial_No_Start, Serial_No_End, Live_Job,
		Dummy_Job, System_Source, Component_Code, Modifier_Code, Job_Code, Task_Type, Occurrence_Type,
		Option_Pobability, Job_Default_Option, Application_Code, Work_Application, Job_Condition, Cab_Type,
		Job_Location, Pricing_Branch, Price_Group, Currency, Overwrite_Costs, Job_Quantity, Parts_Usage_Factor,
		Parts_Cost, Labour_Cost, Misc_Cost, Labour_Hrs, Simulation_Reference, Simulation_Description,
		Group_No, Use_Rotable, Supplier, Rotable_Part_Number, Default_First, Default_Interval, Unit_Of_Measure,
		Company, Branch, Site, Fleet, Equipment, Serial_Number, Projection_Type, Planning_Task,	Lead_Time_Days,
		Not_After, Last_Change_Date, Last_Change_Usage, Use_Std_Job, Pricing_Date, Part_Type, Labour_Activity 
FROM #I_STD_JOB_HEADER I_STD_JOB_HEADER
FOR XML AUTO, ELEMENTS 
SELECT * FROM #I_STD_JOB_OPERATION I_STD_JOB_OPERATION
FOR XML AUTO, ELEMENTS 
SELECT * FROM #I_STD_JOB_PARTS I_STD_JOB_PARTS
FOR XML AUTO, ELEMENTS 
SELECT * FROM #I_STD_JOB_LABOUR I_STD_JOB_LABOUR
FOR XML AUTO, ELEMENTS 
SELECT * FROM #I_STD_JOB_MISC I_STD_JOB_MISC
FOR XML AUTO, ELEMENTS 

GO



/****** Object:  StoredProcedure [dbo].[RPT_CHANGEOUT_ANALYSIS_P]    Script Date: 04/26/2012 09:13:54 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[RPT_CHANGEOUT_ANALYSIS_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[RPT_CHANGEOUT_ANALYSIS_P]
GO

/****** Object:  StoredProcedure [dbo].[RPT_CHANGEOUT_ANALYSIS_P]    Script Date: 04/26/2012 09:13:54 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE  PROCEDURE [dbo].[RPT_CHANGEOUT_ANALYSIS_P]  
/******************************************************************************  
 File:   
 Name: RPT_CHANGEOUT_ANALYSIS_P  
  
 Called By:   
  
 Desc:  
               
  
 Auth: Patrick Joy  
 Date: 21-Sep-2005  
*******************************************************************************  
  Change History  
*******************************************************************************  
Date:  Author:  Description:  
-------- -------- ----------------------------------------  
12-Apr-12   G Dhillon   E782 and E783  
  
--OLD COMMENTS  
14-Dec-05 P Joy  Removed changeout restriction  
30-Jan-05 P Joy  Changed test for NULL  
24-May-06 P Joy  Exclude YTS work orders  
04-Oct-06 A Lass.  Revamped to allow for Component Changeout Analysis Report  
18-Dec-06 A Lass.  remove 2 ms to end date  
08-Jan-07 SI   Added description for CC, MC, TT  
21-Jul-07 KN   Fixed - Collation and tempDB Conflicts  
03-Jan-08 AL   Enh 353: add 5 new Analyse by options + max of 5 + filters  
04-Jan-08 AL   Modified Part Number caption  
21-Jan-08 AL   Provide default values  
24-Apr-08   YS   Changed Projection_Type_Id to Projection_Header_Id  
06-Jun-08 YS   Set NULL occs to 0  
23-Oct-08 KN   Fixed Serial Number appearing twice  
23-Oct-08 AL   CR7530: Provide AnalyseByName even when filling up empty periods  
21-Sep-09 TAS   CR8389: Added UserID  
19-Aug-10 VV   #351 Error Attempt to fetch logical page (1:160) in database 2 failed.   
      It belongs to allocation unit 196608 not to 3963167674299645952.  
12-Apr-11   GD   Issue:1418 Added @OccurrenceTypeID to filter data  
06-May-11   GD   Issue:1418 Added @OccurrenceTypeID to first where condition  
17 Jun 11   GD          Fixed Issue #1657 for cross tab  
04 Jul 11   GD          Fixed issue #2031 to have @ParentEquipmentID  
19 Aug 11   GD          Fixed issue #2305  
24 Aug 11 VV   #2355 - incorrect number of occurrencies  
*******************************************************************************/  
 /* Param List */  
  
@Branch Varchar(MAX)='',  
@Site Varchar(MAX)='',  
@Fleet Varchar(MAX)='',  
@EqpPlanId Varchar(MAX)='',  
@ModifierCodeId Varchar(MAX)='',  
@ModelId Varchar(MAX)='',  
@TaskTypeId Varchar(MAX)='',  
@CostTypeId Varchar(MAX)='',  
@ComponentCodeId Varchar(MAX)='',  
@Proj_Type_Id Varchar(MAX)='',  
@SystemId Varchar(MAX)='',  
@SubSystemId Varchar(MAX)='',  
@StartDate datetime,  
@EndDate datetime,  
@AnalyseBy varchar(50)='',  
@entire_Term int,  
@plan_To_month int,  
@StrategyTaskID Varchar(MAX)='',  
@RegionId Varchar(MAX)='',  
@DivisionId Varchar(MAX)='',  
@CostResponsibilityID Varchar(MAX)='',  
@EqpLocationId Varchar(MAX)='',  
@UserID INT=0,  
@OccurrenceTypeID Varchar(MAX)='',  
@IsCrosstab BIT=0,  
@ParentEquipmentID VARCHAR(MAX) = '',  
@ProjTaskDescId VARCHAR(MAX) = '',  
/*GD 12/04/12 E782 & E783*/  
@PartClassificationId Varchar(MAX) = ''  ,  
@PartRatingId Varchar(MAX) = ''  ,  
@PrimaryPartNumberId Varchar(MAX) = ''  ,  
@RebuildLocationId Varchar(MAX) = ''  ,  
@ReviewStatusId Varchar(MAX) = ''  ,  
@SalesStatusId Varchar(MAX) = ''   
  
AS  
  
  
SET NOCOUNT ON  
  
DECLARE  @SQL Varchar(MAX)  
DECLARE  @Select1 Varchar(MAX),@Select2 Varchar(MAX)  
DECLARE  @Where1 Varchar(MAX), @Where2 Varchar(MAX)  
DECLARE  @GroupBy Varchar(MAX)  
  
 --Create a temporary table  
  CREATE TABLE #aa_ChangeoutAnalysis(  
  AnalyseByVal1 varchar(200) COLLATE database_default,  
  AnalyseByName1 varchar(50) COLLATE database_default,  
  AnalyseByVal2 varchar(200) COLLATE database_default,  
  AnalyseByName2 varchar(50) COLLATE database_default,  
  AnalyseByVal3 varchar(200) COLLATE database_default,  
  AnalyseByName3 varchar(50) COLLATE database_default,  
  AnalyseByVal4 varchar(200) COLLATE database_default,  
  AnalyseByName4 varchar(50) COLLATE database_default,  
  AnalyseByVal5 varchar(200) COLLATE database_default,  
  AnalyseByName5 varchar(50) COLLATE database_default,  
  PeriodVal int,  
  PeriodDesc varchar(50) COLLATE database_default,  
  Occs int)
  
  create table #ProjTaskOcc1 (ProjTaskId int, NextOccDate DateTime )
  
    
 --******************************************  
 --Change Start  
 --Tas 21-Sep-09  
  SET @UserId=ISNULL(@UserId,0)  
  DECLARE @Level int  
  SELECT @Level=User_Access_Level_Id From USER_LEVEL_PERMISSION where AMT_User_Id = @UserId  
  SET @Level=ISNULL(@Level,0)  
  
   /*  
   0 -ALL  
   1-Branch,  
   2-Site  
   */  
 --Change End  
 --******************************************  
  
if @Branch = '' SET @Branch = NULL  
if @Site = '' SET @Site = NULL  
if @Fleet = '' SET @Fleet = NULL  
if @EqpPlanId = '' SET @EqpPlanId = NULL  
if @ModifierCodeId = '' SET @ModifierCodeId = NULL  
if @ModelId = '' SET @ModelId = NULL  
if @TaskTypeId = '' SET @TaskTypeId = NULL  
if @CostTypeId = '' SET @CostTypeId = NULL  
if @ComponentCodeId = '' SET @ComponentCodeId = NULL  
if @Proj_Type_Id = '' SET @Proj_Type_Id = '1'  
if @SystemId = '' SET @SystemId = NULL  
if @SubSystemId = '' SET @SubSystemId = NULL  
if @StrategyTaskID = '' SET @StrategyTaskID = NULL  
if @RegionId = '' SET @RegionId = NULL  
if @DivisionId = '' SET @DivisionId = NULL  
if @CostResponsibilityID = '' SET @CostResponsibilityID = NULL  
if @EqpLocationId = '' SET @EqpLocationId = NULL  
IF @ParentEquipmentID = '' SET @ParentEquipmentID = NULL  
IF @PartClassificationId = '' SET @PartClassificationId = NULL  
IF @PartRatingId = '' SET @PartRatingId = NULL  
IF @PrimaryPartNumberId = '' SET @PrimaryPartNumberId = NULL  
IF @RebuildLocationId = '' SET @RebuildLocationId = NULL  
IF @ReviewStatusId = '' SET @ReviewStatusId = NULL  
IF @SalesStatusId = '' SET @SalesStatusId = NULL  
  
IF @AnalyseBy<>''  
 IF RIGHT(@AnalyseBy,1)<>',' SET @AnalyseBy=@AnalyseBy+','  
  
if @entire_Term = 1 Begin   
   SET @StartDate = '1900-01-01'   
   SET @EndDate = '2100-01-01'  
  End  
  
if @Plan_To_month = 1 Begin   
   SET @StartDate = '1900-01-01'   
   SET @EndDate = GetDate()  
  End  
  
--AL: 18/12/06  
SET @EndDate=DATEADD(ms,-2,@EndDate)   
  
SET @Select1=''  
SET @Select2=''  
SET @GroupBy=''  
  
  
DECLARE @Counter int,@Column varchar(10),@pointer int  
SET @pointer=0  
SET @Counter=CHARINDEX(',',@AnalyseBy)  
  
DECLARE @SelectListCrossTab VARCHAR(MAX)  
DECLARE @OrderByCrossTab Varchar(Max)  
set @SelectListCrossTab =''  
SET @OrderByCrossTab =''  
   
WHILE @Counter>0 AND @AnalyseBy<>''  
BEGIN  
 --Retrieve GroupBy  
 SET @Column=LEFT(@AnalyseBy,@Counter-1)  
 SET @AnalyseBy=RIGHT(@AnalyseBy,LEN(@AnalyseBy)-@Counter)  
 SET @pointer=@pointer + 1  
  
 if @Column = 'BRAN'  
  BEGIN  
   SET @Select1 = @Select1 +  ' ,tblBranches.Branch '  
   SET @Select2 = @Select2 +  ' ,''Branch'' '  
   SET @GroupBy = @GroupBy +  ' ,tblBranches.Branch '  
   SET @SelectListCrossTab = @SelectListCrossTab + 'AnalyseByVal' + CAST(@pointer AS VARCHAR) + ' AS Branch ,'  
   SET @OrderByCrossTab = @OrderByCrossTab + 'Branch,'  
  END  
   
 else if @Column = 'SITE'  
  BEGIN  
   SET @Select1 = @Select1 +  ' ,tblSites.Site '  
   SET @Select2 = @Select2 +  ' ,''Site'' '  
   SET @GroupBy = @GroupBy +  ' ,tblSites.Site '  
   SET @SelectListCrossTab = @SelectListCrossTab + 'AnalyseByVal' + CAST(@pointer AS VARCHAR) + ' AS Site,'  
   SET @OrderByCrossTab = @OrderByCrossTab + 'Site,'  
  END  
   
 else if @Column = 'FLEE'  
  BEGIN  
   SET @Select1 = @Select1 +  ' ,tblFleets.Fleet '  
   SET @Select2 = @Select2 +  ' ,''Fleet'' '  
   SET @GroupBy = @GroupBy +  ' ,tblFleets.Fleet '  
   SET @SelectListCrossTab = @SelectListCrossTab + 'AnalyseByVal' + CAST(@pointer AS VARCHAR) + ' AS Fleet,'  
   SET @OrderByCrossTab = @OrderByCrossTab + 'Fleet,'  
  END  
   
 else if @Column = 'MODL'  
  BEGIN  
   SET @Select1 = @Select1 +  ' ,tblModels.Model '  
   SET @Select2 = @Select2 +  ' ,''Model'' '  
   SET @GroupBy = @GroupBy +  ' ,tblModels.Model '  
   SET @SelectListCrossTab = @SelectListCrossTab + 'AnalyseByVal' + CAST(@pointer AS VARCHAR) + ' AS Model,'  
   SET @OrderByCrossTab = @OrderByCrossTab + 'Model,'  
  END  
   
 else if @Column = 'SYST'  
  BEGIN  
   SET @Select1 = @Select1 +  ' ,tblSystems.System '  
   SET @Select2 = @Select2 +  ' ,''System'' '  
   SET @GroupBy = @GroupBy +  ' ,tblSystems.System '  
   SET @SelectListCrossTab = @SelectListCrossTab + 'AnalyseByVal' + CAST(@pointer AS VARCHAR) + ' AS System,'  
   SET @OrderByCrossTab = @OrderByCrossTab + 'System,'  
  END  
   
 else if @Column = 'SUBS'  
  BEGIN  
   SET @Select1 = @Select1 +  ' ,tblSubSystems.SubSystem '  
   SET @Select2 = @Select2 +  ' ,''SubSystem'' '  
   SET @GroupBy = @GroupBy +  ' ,tblSubSystems.SubSystem '  
   SET @SelectListCrossTab = @SelectListCrossTab + 'AnalyseByVal'+ CAST(@pointer AS VARCHAR) +' AS ''Sub System''' + ','  
   SET @OrderByCrossTab = @OrderByCrossTab + '''Sub System''' + ','  
  END  
    
 else if @Column = 'EVCC'  
  BEGIN  
   SET @Select1 = @Select1 +  ' ,tblComponentCodes.Code+''-''+tblComponentCodes.Description '  
   SET @Select2 = @Select2 +  ' ,''Component'' '  
   SET @GroupBy = @GroupBy +  ' ,tblComponentCodes.Code+''-''+tblComponentCodes.Description '  
   SET @SelectListCrossTab = @SelectListCrossTab + 'AnalyseByVal' + CAST(@pointer AS VARCHAR) + ' AS Component,'  
   SET @OrderByCrossTab = @OrderByCrossTab  + 'Component,'  
  END  
   
 else if @Column = 'EVTT'  
  BEGIN  
   SET @Select1 = @Select1 +  ' ,tblTaskTypes.Code+''-''+tblTaskTypes.Description '  
   SET @Select2 = @Select2 +  ' ,''Task Type'' '  
   SET @GroupBy = @GroupBy +  ' ,tblTaskTypes.Code+''-''+tblTaskTypes.Description '  
   SET @SelectListCrossTab = @SelectListCrossTab + 'AnalyseByVal' + CAST(@pointer AS VARCHAR) + ' AS ''Task Type''' + ','  
   SET @OrderByCrossTab = @OrderByCrossTab + '''Task Type'','  
  END  
   
 else if @Column = 'EQPL'  
  BEGIN  
   SET @Select1 = @Select1 +  ' ,tblEqpPlans.EqpPlan '  
   SET @Select2 = @Select2 +  ' ,''Equipment'' '  
   SET @GroupBy = @GroupBy +  ' ,tblEqpPlans.EqpPlan '  
   SET @SelectListCrossTab = @SelectListCrossTab + 'AnalyseByVal' + CAST(@pointer AS VARCHAR) + ' AS Equipment,'  
   SET @OrderByCrossTab = @OrderByCrossTab + 'Equipment,'  
  END  
   
 else if @Column = 'MDCO'  
  BEGIN  
   SET @Select1 = @Select1 +  ' ,tblModifierCodes.Code+''-''+tblModifierCodes.Description '  
   SET @Select2 = @Select2 +  ' ,''Modifier Code'' '  
   SET @GroupBy = @GroupBy +  ' ,tblModifierCodes.Code+''-''+tblModifierCodes.Description '  
   SET @SelectListCrossTab = @SelectListCrossTab + 'AnalyseByVal' + CAST(@pointer AS VARCHAR) + ' AS ''Modifier Code''' + ','  
   SET @OrderByCrossTab = @OrderByCrossTab + '''Modifier Code''' + ','  
  END  
   
 else if @Column = 'CTTY'  
  BEGIN  
   SET @Select1 = @Select1 +  ' ,tblCostTypes.CostType '  
   SET @Select2 = @Select2 +  ' ,''Cost Type'' '  
   SET @GroupBy = @GroupBy +  ' ,tblCostTypes.CostType '  
   SET @SelectListCrossTab = @SelectListCrossTab + 'AnalyseByVal' + CAST(@pointer AS VARCHAR) + ' AS ''Cost Type''' + ','  
   SET @OrderByCrossTab = @OrderByCrossTab + '''Cost Type''' + ','  
  END  
   
 else if @Column = 'PRTA'  
  BEGIN  
   SET @Select1 = @Select1 +  ' ,TASK_HEADER.Description '  
   SET @Select2 = @Select2 +  ' ,''Task'' '  
   SET @GroupBy = @GroupBy +  ' ,TASK_HEADER.Description '  
   SET @SelectListCrossTab = @SelectListCrossTab + 'AnalyseByVal' + CAST(@pointer AS VARCHAR) + ' AS ''Task Header''' + ','  
   SET @OrderByCrossTab = @OrderByCrossTab + '''Task Header''' + ','  
  END  
 else if @Column = 'PRDE'  
  BEGIN  
   SET @Select1 = @Select1 +  ' ,dbo.TASK_DESCRIPTION_F(tblProjTasks.Task_Description,TASK_HEADER.Component_Code,TASK_HEADER.Modifier_Code,TASK_HEADER.Task_Type,TASK_HEADER.Application_Code,TASK_HEADER.Description) AS StrategyTaskDescription '  
   SET @Select2 = @Select2 +  ' ,''Strategy Task Description'' '  
   SET @GroupBy = @GroupBy +  ' ,dbo.TASK_DESCRIPTION_F(tblProjTasks.Task_Description,TASK_HEADER.Component_Code,TASK_HEADER.Modifier_Code,TASK_HEADER.Task_Type,TASK_HEADER.Application_Code,TASK_HEADER.Description) '  
   SET @SelectListCrossTab = @SelectListCrossTab + 'AnalyseByVal' + CAST(@pointer AS VARCHAR) + ' AS ''Strategy Task Description''' + ','  
   SET @OrderByCrossTab = @OrderByCrossTab + '''Strategy Task Description''' + ','  
  END  
   
 --AL: 03/01/08 - ENH 353: add new analyse by options CRSP,DEVI,LCTN,PRPN,REGN  
 else if @Column = 'CRSP'  
  BEGIN  
   SET @Select1 = @Select1 +  ' ,COST_RESPONSIBILITY.Cost_Responsibility_Code+''-''+COST_RESPONSIBILITY.Cost_Responsibility_Desc '  
   SET @Select2 = @Select2 +  ' ,''Cost Resp.'' '  
   SET @GroupBy = @GroupBy +  ' ,COST_RESPONSIBILITY.Cost_Responsibility_Code+''-''+COST_RESPONSIBILITY.Cost_Responsibility_Desc '  
   SET @SelectListCrossTab = @SelectListCrossTab + 'AnalyseByVal' + CAST(@pointer AS VARCHAR) + ' AS ''Cost Responsibility''' + ','  
   SET @OrderByCrossTab = @OrderByCrossTab + '''Cost Responsibility''' + ','  
  END  
 else if @Column = 'DEVI'  
  BEGIN  
   SET @Select1 = @Select1 +  ' ,DIVISION.Division_Code+''-''+DIVISION.Division_Desc '  
   SET @Select2 = @Select2 +  ' ,''Division'' '  
   SET @GroupBy = @GroupBy +  ' ,DIVISION.Division_Code+''-''+DIVISION.Division_Desc '  
   SET @SelectListCrossTab = @SelectListCrossTab + 'AnalyseByVal' + CAST(@pointer AS VARCHAR) + ' AS Division,'  
   SET @OrderByCrossTab = @OrderByCrossTab + 'Division' + ','  
  END  
 else if @Column = 'LCTN'  
  BEGIN  
   SET @Select1 = @Select1 +  ' ,EQP_LOCATION.Eqp_Location_Code+''-''+EQP_LOCATION.Eqp_Location_Desc '  
   SET @Select2 = @Select2 +  ' ,''Eqp Location'' '  
   SET @GroupBy = @GroupBy +  ' ,EQP_LOCATION.Eqp_Location_Code+''-''+EQP_LOCATION.Eqp_Location_Desc '  
   SET @SelectListCrossTab = @SelectListCrossTab + 'AnalyseByVal' + CAST(@pointer AS VARCHAR) + ' AS ''Equipment Location''' + ','  
   SET @OrderByCrossTab = @OrderByCrossTab + '''Equipment Location''' + ','  
  END   
 else if @Column = 'PRPN'  
  BEGIN  
   SET @Select1 = @Select1 +  ' ,CASE WHEN tblProjTasks.Rotable_Part_Id > 0 THEN dbo.ROTABLE_PART.Part_Number  ELSE CASE WHEN tblProjTaskOccs.OccDate = NEXTOCC.NextOccDate THEN ISNULL(NextDueParts.Part , tblParts.Part) ELSE tblParts.Part END END '  
   SET @Select2 = @Select2 +  ' ,''Primary Part No.'' '  
   SET @GroupBy = @GroupBy +  ' ,CASE WHEN tblProjTasks.Rotable_Part_Id > 0 THEN dbo.ROTABLE_PART.Part_Number  ELSE CASE WHEN tblProjTaskOccs.OccDate = NEXTOCC.NextOccDate THEN ISNULL(NextDueParts.Part , tblParts.Part) ELSE tblParts.Part END END'  
   SET @SelectListCrossTab = @SelectListCrossTab + 'AnalyseByVal' + CAST(@pointer AS VARCHAR) + ' AS ''Primary Part''' + ','  
   SET @OrderByCrossTab = @OrderByCrossTab + '''Primary Part No.''' + ','  
  END  
 else if @Column = 'REGN'  
  BEGIN  
   SET @Select1 = @Select1 +  ' ,REGION.Region_Code+''-''+REGION.Region_Desc '  
   SET @Select2 = @Select2 +  ' ,''Region'' '  
   SET @GroupBy = @GroupBy +  ' ,REGION.Region_Code+''-''+REGION.Region_Desc '  
    SET @SelectListCrossTab = @SelectListCrossTab + 'AnalyseByVal' + CAST(@pointer AS VARCHAR) + ' AS Region,'  
   SET @OrderByCrossTab = @OrderByCrossTab + 'Region' + ','  
  END  
 else if @Column = 'SRNO'  
  BEGIN  
--   SET @Select1 = @Select1 +  ' ,tblEquipment.SerialNumber+''-''+tblEquipment.SerialNumber '  
--   SET @Select2 = @Select2 +  ' ,''Serial Number'' '  
--   SET @GroupBy = @GroupBy +  ' ,tblEquipment.SerialNumber+''-''+tblEquipment.SerialNumber '  
   SET @Select1 = @Select1 +  ' ,tblEquipment.SerialNumber '  
   SET @Select2 = @Select2 +  ' ,''Serial Number'' '  
   SET @GroupBy = @GroupBy +  ' ,tblEquipment.SerialNumber '  
   SET @SelectListCrossTab = @SelectListCrossTab + 'AnalyseByVal' + CAST(@pointer AS VARCHAR) + ' AS ''Serial Number''' + ','  
   SET @OrderByCrossTab = @OrderByCrossTab + '''Serial Number''' + ','  
  END  
 else if @Column = 'PACL'  
  BEGIN  
   SET @Select1 = @Select1 +  ' ,CASE WHEN tblProjTaskOccs.OccDate = NEXTOCC.NextOccDate THEN ISNULL(NextDuePartCl.PartClassification , PC.PartClassification) ELSE PC.PartClassification END '  
   SET @Select2 = @Select2 +  ' ,''Part Classification'' '  
   SET @GroupBy = @GroupBy +  ' ,CASE WHEN tblProjTaskOccs.OccDate = NEXTOCC.NextOccDate THEN ISNULL(NextDuePartCl.PartClassification , PC.PartClassification) ELSE PC.PartClassification END '  
    SET @SelectListCrossTab = @SelectListCrossTab + 'AnalyseByVal' + CAST(@pointer AS VARCHAR) + ' AS ''Part Classification''' + ','  
   SET @OrderByCrossTab = @OrderByCrossTab + '''Part Classification''' + ','  
  END  
 else if @Column = 'PARA'  
  BEGIN  
   SET @Select1 = @Select1 +  ' ,REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''''),''[NONE]''),'' - '',''-''),''-'','' - ''),''(NONE)'',''[NONE]'')'  
   SET @Select2 = @Select2 +  ' ,''Part Rating'' '  
   SET @GroupBy = @GroupBy +  ' ,REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''''),''[NONE]''),'' - '',''-''),''-'','' - ''),''(NONE)'',''[NONE]'')'  
    SET @SelectListCrossTab = @SelectListCrossTab + 'AnalyseByVal' + CAST(@pointer AS VARCHAR) + ' AS ''Part Rating''' + ','  
   SET @OrderByCrossTab = @OrderByCrossTab + '''Part Rating''' + ','  
  END  
 else if @Column = 'RELO'  
  BEGIN  
   SET @Select1 = @Select1 +  ' ,CASE WHEN tblProjTaskOccs.OccDate = NEXTOCC.NextOccDate THEN ISNULL(NextDueRL.Site , BaseDetailsRL.Site) ELSE BaseDetailsRL.Site END '  
   SET @Select2 = @Select2 +  ' ,''Rebuild Location'' '  
   SET @GroupBy = @GroupBy +  ' ,CASE WHEN tblProjTaskOccs.OccDate = NEXTOCC.NextOccDate THEN ISNULL(NextDueRL.Site , BaseDetailsRL.Site) ELSE BaseDetailsRL.Site END'  
    SET @SelectListCrossTab = @SelectListCrossTab + 'AnalyseByVal' + CAST(@pointer AS VARCHAR) + ' AS ''Rebuild Location'' ' + ','  
   SET @OrderByCrossTab = @OrderByCrossTab + '''Rebuild Location''' + ','  
  END  
 else if @Column = 'REST'  
  BEGIN  
   SET @Select1 = @Select1 +  ' ,REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''''),''[NONE]''),'' - '',''-''),''-'','' - ''),''(NONE)'',''[NONE]'') '  
   SET @Select2 = @Select2 +  ' ,''Review Status'' '  
   SET @GroupBy = @GroupBy +  ' ,REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''''),''[NONE]''),'' - '',''-''),''-'','' - ''),''(NONE)'',''[NONE]'') '  
    SET @SelectListCrossTab = @SelectListCrossTab + 'AnalyseByVal' + CAST(@pointer AS VARCHAR) + ' AS ''Review Status''' + ','  
   SET @OrderByCrossTab = @OrderByCrossTab + '''Review Status''' + ','  
  END  
else if @Column = 'SAST'  
  BEGIN  
   SET @Select1 = @Select1 +  ' ,REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''''),''[NONE]''),'' - '',''-''),''-'','' - ''),''(NONE)'',''[NONE]'')'  
   SET @Select2 = @Select2 +  ' ,''Sales Status'' '  
   SET @GroupBy = @GroupBy +  ' ,REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''''),''[NONE]''),'' - '',''-''),''-'','' - ''),''(NONE)'',''[NONE]'')'  
    SET @SelectListCrossTab = @SelectListCrossTab + 'AnalyseByVal' + CAST(@pointer AS VARCHAR) + ' AS ''Sales Status '''+','  
   SET @OrderByCrossTab = @OrderByCrossTab + 'Sales Status' + ','  
  END  
  
 else   
  BEGIN  
   SET @Select1 = @Select1 +  ' ,'''' '  
   SET @Select2 = @Select2 +  ' ,'''' '  
  END  
END  
WHILE @pointer<5  
BEGIN  
 SET @Select1 = @Select1 +  ' ,'''' '  
 SET @Select2 = @Select2 +  ' ,'''' '  
 SET @pointer=@pointer+1  
END  
  
SET @SQL = ' FROM  
	tblSites INNER JOIN  
	tblBranches ON dbo.tblSites.BranchId = tblBranches.BranchId INNER JOIN  
	tblFleets ON tblSites.SiteId = tblFleets.SiteId INNER JOIN  
	tblEqpPlans ON tblFleets.FleetId = tblEqpPlans.FleetId INNER JOIN  
	tblSubSystems INNER JOIN  
	tblSystems ON tblSubSystems.SystemID = tblSystems.SystemID INNER JOIN  
	tblComponentCodes ON tblSubSystems.SubSystemID = tblComponentCodes.SubSystemID INNER JOIN  
	tblProjTasks ON tblComponentCodes.ComponentCodeID = tblProjTasks.ComponentCodeId INNER JOIN  
	tblEqpProjs ON tblProjTasks.EqpProjId = tblEqpProjs.EqpProjId ON tblEqpPlans.EqpPlanId = tblProjTasks.EqpPlanId INNER JOIN  
	tblEquipment ON tblEqpPlans.EquipmentId = tblEquipment.EquipmentId INNER JOIN  
	tblModels ON tblEquipment.ModelId = tblModels.ModelId INNER JOIN  
	tblModifierCodes ON tblModifierCodes.ModifierID = tblProjTasks.ModifierId INNER JOIN  
	tblCostTypes ON tblCostTypes.CostTypeID = tblSystems.CostTypeID INNER JOIN  
	tblTaskTypes ON tblTaskTypes.TaskTypeID = tblProjTasks.TaskTypeId INNER JOIN  
	tblProjTaskOccs ON tblProjTasks.ProjTaskId = tblProjTaskOccs.ProjTaskId INNER JOIN  
	CALENDAR_DATES ON CALENDAR_DATES.Calendar_Date = CONVERT(datetime, CONVERT(char(10), tblProjTaskOccs.OccDate, 101)) INNER JOIN  
	TASK_HEADER ON tblProjTasks.Task_Header_Id = TASK_HEADER.Task_Header_Id LEFT OUTER JOIN  
	ROTABLE_PART ON tblProjTasks.Rotable_Part_Id = ROTABLE_PART.Rotable_Part_Id LEFT OUTER JOIN  
	tblParts ON tblProjTasks.Part_Id = tblParts.PartId LEFT OUTER JOIN  
	EQP_LOCATION ON tblEqpPlans.Eqp_Location_Id = EQP_LOCATION.Eqp_Location_Id LEFT OUTER JOIN  
	COST_RESPONSIBILITY ON tblEqpPlans.Cost_Responsibility_ID = COST_RESPONSIBILITY.Cost_Responsibility_ID LEFT OUTER JOIN  
	REGION ON tblEqpPlans.Region_Id = REGION.Region_Id LEFT OUTER JOIN   
	DIVISION ON tblEqpPlans.Division_Id = DIVISION.Division_Id  LEFT JOIN   
	dbo.PART_CLASSIFICATION PC ON dbo.tblProjTasks.PartClassificationId = PC.PartClassificationId LEFT JOIN   
	dbo.NEXT_OCC_STRATEGY ON tblProjTasks.ProjTaskId = NEXT_OCC_STRATEGY.Proj_Task_Id LEFT JOIN   
	dbo.PART_RATING PR ON PR.PartRatingId = tblProjTasks.PartRatingId LEFT JOIN       
	dbo.REVIEW_STATUS RS ON RS.ReviewStatusID = dbo.tblProjTasks.ReviewStatusID LEFT JOIN  
	dbo.SALES_STATUS SS ON SS.SalesStatusId = dbo.NEXT_OCC_STRATEGY.SalesStatusId LEFT JOIN   
	tblParts NextDueParts ON dbo.NEXT_OCC_STRATEGY.PEXPartId = NextDueParts.PartId LEFT JOIN  
	dbo.tblSites NextDueRL ON NextDueRL.SiteId = dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId  LEFT JOIN 
	dbo.PART_CLASSIFICATION NextDuePartCl ON  NextDuePartCl.PartClassificationId = dbo.NEXT_OCC_STRATEGY.PEXPartTypeId LEFT JOIN
	dbo.tblSites BaseDetailsRL ON  BaseDetailsRL.SiteId = dbo.tblProjTasks.DefaultLocationForRebuild'/*VV #2355 INNER JOIN  
  tblWorkOrderProjs ON tblProjTasks.ProjTaskId = tblWorkOrderProjs.ProjTaskId INNER JOIN  
  tblWorkOrders ON tblWorkOrderProjs.WorkOrderId = tblWorkOrders.WorkOrderId'*/  
SET @Where2=''  
  
 --*******************************************  
 --Change Start  
 --Tas 21-Sep-09  
 SET @Where2 = @Where2 + ' AND ('+CAST(@Level AS varchar(50))+'<>1 OR tblSites.branchId In (SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = '+CAST(@UserId AS varchar(50))+'))'  
 SET @Where2 =@Where2 + ' AND ('+CAST(@Level AS varchar(50))+'<>2 OR tblSites.SiteId IN(SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = '+CAST(@UserId AS varchar(50))+'))'  
   
 --Change End  
 --*******************************************  
  
IF @Branch IS NOT NULL SET @Where2 = @Where2 + ' AND tblSites.branchId IN ( ' +  @Branch + ') '  
IF @Site IS NOT NULL SET @Where2 = @Where2 + ' AND tblSites.SiteId IN ( ' +  @Site + ') '  
IF @Fleet IS NOT NULL SET @Where2 = @Where2 + ' AND tblFleets.FleetId IN ( ' +  @Fleet + ') '  
IF @EqpPlanId IS NOT NULL SET @Where2 = @Where2 + ' AND tblEqpPlans.eqpplanid IN ( ' +  @EqpPlanId + ') '  
IF @ModifierCodeId IS NOT NULL SET @Where2 = @Where2 + ' AND tblModifierCodes.ModifierId IN ( ' +  @ModifierCodeId + ') '  
IF @ModelId IS NOT NULL SET @Where2 = @Where2 + ' AND tblModels.ModelId IN ( ' +  @ModelId + ') '  
IF @TaskTypeId IS NOT NULL SET @Where2 = @Where2 + ' AND tblTaskTypes.TaskTypeId IN ( ' +  @TaskTypeId + ') '  
IF @CostTypeId IS NOT NULL SET @Where2 = @Where2 + ' AND tblSystems.CostTypeId IN ( ' +  @CostTypeId + ') '  
IF @ComponentCodeId IS NOT NULL SET @Where2 = @Where2 + ' AND tblComponentCodes.componentcodeid IN (' + @ComponentCodeId + ') '  
IF @SystemId IS NOT NULL SET @Where2 = @Where2 + ' AND tblSystems.SystemId IN (' + @SystemId + ') '  
IF @SubSystemId IS NOT NULL SET @Where2 = @Where2 + ' AND tblSubSystems.SubSystemId IN (' + @SubSystemId + ') '  
IF @StrategyTaskID IS NOT NULL SET @Where2 = @Where2 + ' AND TASK_HEADER.Task_Header_Id IN (' + @StrategyTaskID + ') '  
IF @RegionId IS NOT NULL SET @Where2 = @Where2 + ' AND tblEqpPlans.Region_Id IN (' + @RegionId + ') '  
IF @DivisionId IS NOT NULL SET @Where2 = @Where2 + ' AND tblEqpPlans.Division_Id IN (' + @DivisionId + ') '  
IF @CostResponsibilityID IS NOT NULL SET @Where2 = @Where2 + ' AND tblEqpPlans.Cost_Responsibility_ID IN (' + @CostResponsibilityID + ') '  
IF @EqpLocationId IS NOT NULL SET @Where2 = @Where2 + ' AND tblEqpPlans.Eqp_Location_Id IN (' + @EqpLocationId + ') '  
IF @ParentEquipmentID IS NOT NULL SET @Where2 = @Where2 + ' AND tblEqpPlans.EqpPlanID IN (SELECT EqpPlanID FROM dbo.EQP_SIBLINGS_F('+@ParentEquipmentID+')) '  
IF @PartRatingId IS NOT NULL SET @Where2 = @Where2 + ' AND tblProjTasks.PartRatingId IN ( ' +  @PartRatingId + ') '  
IF @PrimaryPartNumberId IS NOT NULL SET @Where2 = @Where2 + ' AND dbo.tblProjTasks.Part_Id IN ( ' +  @PrimaryPartNumberId + ') '  
IF @ReviewStatusId IS NOT NULL SET @Where2 = @Where2 + ' AND dbo.tblProjTasks.ReviewStatusID IN ( ' +  @ReviewStatusId + ') '  
IF @SalesStatusId IS NOT NULL SET @Where2 = @Where2 + ' AND dbo.NEXT_OCC_STRATEGY.SalesStatusId IN ( ' +  @SalesStatusId + ') '  
IF @RebuildLocationId IS NOT NULL SET @Where2 = @Where2 + ' AND ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,dbo.tblProjTasks.DefaultLocationForRebuild) IN ( ' +  @RebuildLocationId + ') '  
IF @PartClassificationId IS NOT NULL SET @Where2 = @Where2 + ' AND tblProjTasks.PartClassificationId IN ( ' +  @PartClassificationId + ') '  
  
  
  
  
IF @ProjTaskDescId <>''  
BEGIN  
  SET @Where2 = @Where2 + ' AND dbo.TASK_DESCRIPTION_F(tblProjTasks.Task_Description,TASK_HEADER.Component_Code,TASK_HEADER.Modifier_Code,TASK_HEADER.Task_Type,TASK_HEADER.Application_Code,TASK_HEADER.Description) IN ( '  
  SET @Where2 = @Where2 + ' SELECT DISTINCT dbo.TASK_DESCRIPTION_F(PT.Task_Description,TH.Component_Code,TH.Modifier_Code,TH.Task_Type,TH.Application_Code,TH.Description) as Task_Description '  
  SET @Where2 = @Where2 + ' FROM tblProjTasks PT '  
  SET @Where2 = @Where2 + ' INNER JOIN TASK_HEADER TH ON TH.Task_Header_Id = PT.Task_Header_Id '  
  SET @Where2 = @Where2 + ' WHERE PT.ProjTaskId IN (' + @ProjTaskDescId + ') ) '  
  
END  
  
  
-- Insert projected changeouts  
SET @Where1 = ' WHERE ( ' + ''''+ CONVERT(CHAR(10), @StartDate,120) + ''''+ ' <= OccDate AND ' +'''' + CONVERT(CHAR(10), @EndDate,120) +'''' + ' >= OccDate) AND Projection_Header_Id IN (' + @Proj_Type_Id + ') '  
--print 'INSERT INTO #aa_ChangeoutAnalysis(PeriodVal,PeriodDesc,Occs,AnalyseByVal1,AnalyseByVal2,AnalyseByVal3,AnalyseByVal4,AnalyseByVal5,AnalyseByName1,AnalyseByName2,AnalyseByName3,AnalyseByName4,AnalyseByName5) SELECT CALENDAR_DATES.Calendar_Period, right(convert(varchar,convert(datetime,convert(varchar,CALENDAR_DATES.Calendar_Period) + ''01'',112),106),8),Count(*) ' + @Select1 + @Select2 + @SQL  + @Where1 + @Where2 + ' Group By CALENDAR_DATES.Calendar_Period' + @GroupBy  
 
/*VV #2355   
--Include @OccurrenceTypeID If Not Null  
BEGIN   
 IF @occurrenceTypeID <>''   
  SET @Where1=@Where1+'AND tblWorkOrders.AMTOccurrenceTypeId  IN (' + @OccurrenceTypeID + ')'  
END  
*/  

EXEC ('INSERT INTO #ProjTaskOcc1 SELECT distinct tblProjTaskOccs.ProjTaskId,MIN(tblProjTaskOccs.OccDate) AS NextOccDate  '+@SQL  +  @Where2 +'Group By tblProjTaskOccs.ProjTaskId ')

SET @SQL = @SQL + '  INNER JOIN #ProjTaskOcc1 NEXTOCC ON NEXTOCC.ProjTaskId = tblProjTasks.ProjTaskId '


EXEC('INSERT INTO #aa_ChangeoutAnalysis(PeriodVal,PeriodDesc,Occs,AnalyseByVal1,AnalyseByVal2,AnalyseByVal3,AnalyseByVal4,AnalyseByVal5,AnalyseByName1,AnalyseByName2,  
AnalyseByName3,AnalyseByName4,AnalyseByName5) SELECT CALENDAR_DATES.Calendar_Period, right(convert(varchar,convert(datetime,convert(varchar,CALENDAR_DATES.Calendar_Period) +   
''01'',112),106),8),isnull(Count(*),0) ' + @Select1 + @Select2 + @SQL  + @Where1 + @Where2 + ' Group By CALENDAR_DATES.Calendar_Period' + @GroupBy)  
  
-- Insert previous changouts  
SET @SQL = ' FROM   
	tblSites INNER JOIN  
	tblBranches ON tblSites.BranchId = tblBranches.BranchId INNER JOIN  
	tblFleets ON tblSites.SiteId = tblFleets.SiteId INNER JOIN  
	tblEqpPlans ON tblFleets.FleetId = tblEqpPlans.FleetId INNER JOIN  
	tblSubSystems INNER JOIN  
	tblSystems ON tblSubSystems.SystemID = tblSystems.SystemID INNER JOIN  
	tblComponentCodes ON tblSubSystems.SubSystemID = tblComponentCodes.SubSystemID INNER JOIN  
	tblProjTasks ON tblComponentCodes.ComponentCodeID = tblProjTasks.ComponentCodeId INNER JOIN  
	tblEqpProjs ON tblProjTasks.EqpProjId = tblEqpProjs.EqpProjId ON tblEqpPlans.EqpPlanId = tblProjTasks.EqpPlanId INNER JOIN  
	tblEquipment ON tblEqpPlans.EquipmentId = tblEquipment.EquipmentId INNER JOIN  
	tblModels ON tblEquipment.ModelId = tblModels.ModelId INNER JOIN  
	tblModifierCodes ON tblModifierCodes.ModifierID = tblProjTasks.ModifierId INNER JOIN  
	tblCostTypes ON tblCostTypes.CostTypeID = tblSystems.CostTypeID INNER JOIN  
	tblTaskTypes ON tblTaskTypes.TaskTypeID = tblProjTasks.TaskTypeId INNER JOIN  
	tblWorkOrderProjs ON tblProjTasks.ProjTaskId = tblWorkOrderProjs.ProjTaskId INNER JOIN  
	tblWorkOrders ON tblWorkOrderProjs.WorkOrderId = tblWorkOrders.WorkOrderId INNER JOIN  
	CALENDAR_DATES ON CALENDAR_DATES.Calendar_Date = CONVERT(datetime, CONVERT(char(10), tblWorkOrders.AMTStartDate, 101)) INNER JOIN  
	TASK_HEADER ON tblProjTasks.Task_Header_Id = TASK_HEADER.Task_Header_Id LEFT OUTER JOIN  
	ROTABLE_PART ON tblProjTasks.Rotable_Part_Id = ROTABLE_PART.Rotable_Part_Id LEFT OUTER JOIN  
	tblParts ON tblProjTasks.Part_Id = tblParts.PartId LEFT OUTER JOIN  
	EQP_LOCATION ON tblEqpPlans.Eqp_Location_Id = EQP_LOCATION.Eqp_Location_Id LEFT OUTER JOIN  
	DIVISION ON tblEqpPlans.Division_Id = DIVISION.Division_Id LEFT OUTER JOIN  
	REGION ON tblEqpPlans.Region_Id = REGION.Region_Id LEFT OUTER JOIN  
	COST_RESPONSIBILITY ON tblEqpPlans.Cost_Responsibility_ID = COST_RESPONSIBILITY.Cost_Responsibility_ID LEFT JOIN   
	dbo.PART_CLASSIFICATION PC ON dbo.tblProjTasks.PartClassificationId = PC.PartClassificationId LEFT JOIN   
	dbo.PART_RATING PR ON PR.PartRatingId = tblProjTasks.PartRatingId LEFT JOIN  
	dbo.NEXT_OCC_STRATEGY ON tblProjTasks.ProjTaskId = NEXT_OCC_STRATEGY.Proj_Task_Id LEFT JOIN          
	dbo.REVIEW_STATUS RS ON RS.ReviewStatusID = dbo.tblProjTasks.ReviewStatusID  LEFT JOIN   
	dbo.tblSites RL ON RL.SiteId = ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,dbo.tblProjTasks.DefaultLocationForRebuild )LEFT JOIN  
	dbo.SALES_STATUS SS ON SS.SalesStatusId = dbo.NEXT_OCC_STRATEGY.SalesStatusId LEFT JOIN   
	tblParts NextDueParts ON dbo.NEXT_OCC_STRATEGY.PEXPartId = NextDueParts.PartId LEFT JOIN  
	dbo.tblSites NextDueRL ON NextDueRL.SiteId = dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId  LEFT JOIN 
	dbo.PART_CLASSIFICATION NextDuePartCl ON  NextDuePartCl.PartClassificationId = dbo.NEXT_OCC_STRATEGY.PEXPartTypeId LEFT JOIN
	dbo.tblSites BaseDetailsRL ON  BaseDetailsRL.SiteId = dbo.tblProjTasks.DefaultLocationForRebuild LEFT JOIN  
	tblProjTaskOccs ON tblProjTasks.ProjTaskId = tblProjTaskOccs.ProjTaskId INNER JOIN #ProjTaskOcc1 NEXTOCC ON NEXTOCC.ProjTaskId = tblProjTasks.ProjTaskId '  
SET @Where1 = ' WHERE ( ' + '''' + CONVERT(CHAR(10), @StartDate,120) + '''' + '  <= AMTStartDate AND ' + '''' + CONVERT(CHAR(10), @EndDate,120) + '''' + ' >= AMTStartDate) AND Projection_Header_Id  IN (' + @Proj_Type_Id + ') AND tblWorkOrders.AMTJobStatus_Id <> 3 '  
--print 'INSERT INTO #aa_ChangeoutAnalysis(PeriodVal,PeriodDesc,Occs,AnalyseByVal1,AnalyseByVal2,AnalyseByVal3,AnalyseByVal4,AnalyseByVal5,AnalyseByName1,AnalyseByName2,AnalyseByName3,AnalyseByName4,AnalyseByName5) SELECT CALENDAR_DATES.Calendar_Period, right(convert(varchar,convert(datetime,convert(varchar,CALENDAR_DATES.Calendar_Period) + ''01'',112),106),8),Count(*) ' + @Select1 + @Select2 + @SQL  + @Where1 + @Where2 + ' Group By CALENDAR_DATES.Calendar_Period' + @GroupBy  

--Include @OccurrenceTypeID If Not Null  
BEGIN   
 IF @occurrenceTypeID <>''   
  SET @Where1=@Where1+'AND tblWorkOrders.AMTOccurrenceTypeId  IN (' + @OccurrenceTypeID + ')'  
END  
  

EXEC('INSERT INTO #aa_ChangeoutAnalysis(PeriodVal,PeriodDesc,Occs,AnalyseByVal1,AnalyseByVal2,AnalyseByVal3,AnalyseByVal4,AnalyseByVal5,AnalyseByName1,AnalyseByName2,AnalyseByName3,AnalyseByName4,AnalyseByName5) SELECT CALENDAR_DATES.Calendar_Period, right(convert(varchar,convert(datetime,convert(varchar,CALENDAR_DATES.Calendar_Period) + ''01'',112),106),8),isnull(Count(*),0) ' + @Select1 + @Select2 + @SQL  + @Where1 + @Where2 + ' Group By CALENDAR_DATES.Calendar_Period' + @GroupBy)  
-- Min,Max Period Val  
  
  
DECLARE @MinPeriod int  
DECLARE @MaxPeriod int  
  
SELECT @MinPeriod=MIN(PeriodVal), @MaxPeriod=MAX(PeriodVal) FROM #aa_ChangeoutAnalysis  
  
--select @MinPeriod as MinPeriod,@MaxPeriod as MaxPeriod  
  
--select * into aa_ChangeoutAnalysis from #aa_ChangeoutAnalysis return  
  
/*VV #351*/  
select AnalyseByVal1,AnalyseByVal2,AnalyseByVal3,AnalyseByVal4,AnalyseByVal5,  
AnalyseByName1,AnalyseByName2,AnalyseByName3,AnalyseByName4,AnalyseByName5  
INTO #B_aa_ChangeoutAnalysis  
from #aa_ChangeoutAnalysis  
group by AnalyseByVal1,AnalyseByVal2,AnalyseByVal3,AnalyseByVal4,AnalyseByVal5,  
AnalyseByName1,AnalyseByName2,AnalyseByName3,AnalyseByName4,AnalyseByName5  
  
  
insert into #aa_ChangeoutAnalysis(PeriodVal,PeriodDesc,Occs,AnalyseByVal1,AnalyseByVal2,AnalyseByVal3,AnalyseByVal4,AnalyseByVal5,  
AnalyseByName1,AnalyseByName2,AnalyseByName3,AnalyseByName4,AnalyseByName5)  
  
--AL: 23/10/08  
select FP.CalenderPeriod,right(convert(varchar,convert(datetime,convert(varchar,FP.CalenderPeriod) + '01',112),106),8),0 as Occs,  
  AnalyseByVal1,AnalyseByVal2,AnalyseByVal3,AnalyseByVal4,AnalyseByVal5,  
  AnalyseByName1,AnalyseByName2,AnalyseByName3,AnalyseByName4,AnalyseByName5  
from  
 /*VV #351 (select AnalyseByVal1,AnalyseByVal2,AnalyseByVal3,AnalyseByVal4,AnalyseByVal5,  
   AnalyseByName1,AnalyseByName2,AnalyseByName3,AnalyseByName4,AnalyseByName5  
 from #aa_ChangeoutAnalysis  
 group by AnalyseByVal1,AnalyseByVal2,AnalyseByVal3,AnalyseByVal4,AnalyseByVal5,  
   AnalyseByName1,AnalyseByName2,AnalyseByName3,AnalyseByName4,AnalyseByName5) A */  
 #B_aa_ChangeoutAnalysis A  
   CROSS JOIN   
 tblFinancialPeriods FP  
where FP.CalenderPeriod BETWEEN @MinPeriod AND @MaxPeriod  
  
/*VV #351*/  
DROP TABLE #B_aa_ChangeoutAnalysis  
  print @OrderByCrossTab
  
--GD #1657 if Cross tab  
If(@IsCrossTab='true')  
BEGIN  
DECLARE @ListCol VARCHAR(MAX)  
DECLARE @Query VARCHAR(MAX)  
 CREATE TABLE [#temp](  
      [AnalyseByVal1] [varchar](max) COLLATE DATABASE_DEFAULT NULL,  
      [AnalyseByName1] [varchar](max) COLLATE DATABASE_DEFAULT NULL,  
      [AnalyseByVal2] [varchar](max) COLLATE DATABASE_DEFAULT NULL,  
      [AnalyseByName2] [varchar](max) COLLATE DATABASE_DEFAULT NULL,  
      [AnalyseByVal3] [varchar](max) COLLATE DATABASE_DEFAULT NULL,  
      [AnalyseByName3] [varchar](max) COLLATE DATABASE_DEFAULT NULL,  
      [AnalyseByVal4] [varchar](max) COLLATE DATABASE_DEFAULT NULL,  
      [AnalyseByName4] [varchar](max) COLLATE DATABASE_DEFAULT NULL,  
      [AnalyseByVal5] [varchar](max) COLLATE DATABASE_DEFAULT NULL,  
      [AnalyseByName5] [varchar](max) COLLATE DATABASE_DEFAULT NULL,  
      [PeriodVal] [varchar](max) COLLATE DATABASE_DEFAULT NULL,  
      [PeriodDesc] [varchar](max) COLLATE DATABASE_DEFAULT NULL,        
      [Occs] [int] NULL        
     ) ON [PRIMARY]  

 INSERT INTO #temp      
    SELECT AnalyseByVal1,AnalyseByName1,NULLIF(AnalyseByVal2,'')as AnalyseByVal2,AnalyseByName2,NULLIF(AnalyseByVal3,'')as AnalyseByVal3,  
    AnalyseByName3,NULLIF(AnalyseByVal4,'')as AnalyseByVal4,AnalyseByName4,NULLIF(AnalyseByVal5,'')as AnalyseByVal5,AnalyseByName5,  
    PeriodVal,PeriodDesc,SUM(Occs) as Occs  
    FROM #aa_ChangeoutAnalysis  
    GROUP BY AnalyseByVal1 , AnalyseByName1, AnalyseByVal2, AnalyseByVal2, AnalyseByName2, AnalyseByVal3, AnalyseByVal3,  
    AnalyseByName3,  AnalyseByVal4, AnalyseByVal4, AnalyseByName4, AnalyseByVal5, AnalyseByVal5, AnalyseByName5 ,  
    PeriodVal , PeriodDesc  
    ORDER BY AnalyseByVal1, AnalyseByVal2, AnalyseByVal3, AnalyseByVal4, AnalyseByVal5, PeriodVal  

 SELECT  @ListCol = STUFF(( SELECT DISTINCT  '],[' + PeriodVal  FROM  #temp ORDER BY '],[' + PeriodVal  FOR XML PATH('') ), 1, 2, '') + ']'  
  
 SET @Query =  'SELECT * FROM ( SELECT '+@SelectListCrossTab +'PeriodVal,Occs from #temp WHERE Occs!=0 ) tmp PIVOT (SUM(Occs) for PeriodVal in('+@ListCol+')) AS pvt  ORDER BY '+SUBSTRING(@OrderByCrossTab,1,LEN(@OrderByCrossTab)-1)  
        
 EXECUTE (@Query)  
    
END  
ELSE  
 BEGIN  
select AnalyseByVal1,AnalyseByName1,NULLIF(AnalyseByVal2,'')as AnalyseByVal2,AnalyseByName2,NULLIF(AnalyseByVal3,'')as AnalyseByVal3,  
  AnalyseByName3,NULLIF(AnalyseByVal4,'')as AnalyseByVal4,AnalyseByName4,NULLIF(AnalyseByVal5,'')as AnalyseByVal5,AnalyseByName5,  
  PeriodVal,PeriodDesc,SUM(Occs) as Occs  
from #aa_ChangeoutAnalysis  
group by AnalyseByVal1,AnalyseByName1,AnalyseByVal2, AnalyseByVal2,AnalyseByName2,AnalyseByVal3, AnalyseByVal3,  
  AnalyseByName3,AnalyseByVal4, AnalyseByVal4,AnalyseByName4,AnalyseByVal5, AnalyseByVal5,AnalyseByName5,  
  PeriodVal,PeriodDesc  
order by AnalyseByVal1,AnalyseByVal2,AnalyseByVal3,AnalyseByVal4,AnalyseByVal5,PeriodVal  
END  
drop table #aa_ChangeoutAnalysis  
  

GO

if exists (select * from dbo.sysobjects where id = object_id(N'AMT_VAR_MERGING_RULE_P') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure AMT_VAR_MERGING_RULE_P
GO

CREATE PROCEDURE AMT_VAR_MERGING_RULE_P
/******************************************************************************
	Name: AMT_VAR_MERGING_RULE_P

	Called By: Amt.Data

	DESC: returns single VALUE

	Auth: Sergey Ivanov
	Date: 16-Sep-2005
*******************************************************************************
		Change History
*******************************************************************************
Date:		Author:		Description:
--------	--------	----------------------------------------

*******************************************************************************/
/* Param List */
@res int output
AS
DECLARE @theMax int
SELECT @theMax = MAX(amt_var_id) FROM AMT_VARIABLE
SELECT
	@res = ISNULL(Merging_Rule,0)
FROM
	AMT_VARIABLE
WHERE
	amt_var_id = @theMax



GO


if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[PROJ_TASK_SUMMARY_GET_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[PROJ_TASK_SUMMARY_GET_P]
GO

create PROCEDURE [dbo].[PROJ_TASK_SUMMARY_GET_P]
/******************************************************************************
	File: 
	Name: PROJ_TASK_SUMMARY_GET_P

	Called By: Projected Task Editor

	Desc: Returns data for projected task editor
             

	Auth: Darryl
	Date: 27-Sep-2004
*******************************************************************************
		Change History
*******************************************************************************
Date:		Author:		Description:
--------	--------	----------------------------------------
13 Apr 12   SD			E789: PEX Fields for Strategy Task Editor
 1 Sep 11	V Vasylyeva E621: Rebuild workorder
15 Aug 11	VVasylyeva	E611: new fields in next occ
21 Jul 11	V Vasylyeva	E602: Serialised Component
21 Feb 11	V Vasylyeva	E316: TagId and rating
15-Feb-11	DS			Added EWT's linked to this Strategy Task
07-Jul-10   VS          CR9019: Added CBD Strategy Task
22-Oct-09	AL			CR8414: Added StartingSerialNo
21-Jul-09	V Vasylyeva	CR8323: ExtDocUseClientCredentials
28-Apr-09	V Vasylyeva	CR8035: Library Documents
30-Mar-09	AL			CR7965: added new fields
03-Feb-2009	K Nagarajan	Added Last Performed WO
29-Jan-2009	V Vasylyeva	Changed Rotable In use to not return duplicate records
17/09/08	AL			removed links to tblqualifier and tbluoms
12 Jun 08	AL			Changed Repair Description size
20 May 08	V Vaylyeva	Changed component structure desc
15 Apr 08	V Vasylyeva	Modified query
 8 Apr 08	V Vasylyeva	Added Model
 4 Apr 08	V Vasylyeva	Added rounding to costs. The form asks for the changes to be saved if the numbers are not
						rounded. They are shown rounded in the form. 
					
31 Mar 08	V Vasylyeva	Added field names to COST_ALLOCATION_CONFIGURATION, Collation
19 Mar 08	V Vasylyeva	Added Sort order to the jobs
 6 Mar 08	V Vasylyeva	Changed cost allocation description
29 Feb 08	AL			Added ReviewStatus and ReviewUser
21 Feb 08	AL			Changed PlanDateLocked to ReviewStatusID
 7 Jan 08	V Vasylyeva	proj task enhancements
11 Dec 07	V Vasylyeva	Added new fields for component structure link
13 Aug 07	KN			Modified Life Used
27 Jun 07	KN			Added InspectionTaskType, InspectionOffset
07 Jun 07	K Nagarajan	Added SchedulingGroupSubTypeId
30 Jan 07	V Vasylyeva	Changed CostAllocationRef=ISNULL(Cost_allocation_Id,0)
15 Jan 07	SI		Fixed a bug with FinalChangeDate
27 Oct 06	V Vasylyeva	Changed for a task with 0 codes (0.0.0.0 - NONE)
23 Oct 06	A Lassauniere	Changed Date based First + Final
20 Oct 06	A Lassauniere	Changed used of FirstDate - now always eqpPlan startDate
16 Sep 06	V Vasylyeva	Changed to use PROJ_TASK_SUMMARY_1_V
12 Sep 06	V Vasylyeva	Changes in spec
24 Feb 06	K Nagarajan	Added Cost Centre
09 Feb 06	K Nagarajan	Added EDC Defaults
01 Dec 05	P Joy		Added Manufacturer
09 Nov 05	V Vasylyeva	Mod
02 Nov 05	V Vasylyeva	Deleted Labour_Hrs_Shop
31 Oct 05	V Vasylyeva	New fields Crane_Cost, Pct_Freight, 
				Avg_Daily_Work_Hrs, Avg_No_People, 
              			Avg_Travel_Hrs, Travel_Distance, 
				Travel_Recovery_Rate_L, Misc_Trip_Cost, 
				Labour_Hrs_Field, Labour_Hrs_Shop,
				CPE.CumPartsEscalation,CE.CumMiscEscalation, 
				CE.CumLaborEscalation,Travel_Recovery_Rate_V
23 Sep 05	S Ivanov	Added SchedulingTaskId and SchedulingTask fields
15 Sep 05	V Vasylyeva	Added Parts Cost expense fields
29 Mar 05	V Vasylyeva Moved SQL to PROJ_TASK_SUMMARY_V
24 Mar 05	V Vasylyeva	Removed AltModifierId from the Join
12 Nov 04	Darryl		Added JobCodeId
04 Apr 11	GW			Add AutoGenerateWOS
30 May 11   GD          Fixed #1826
11 Jan 12   GD          Fixed 3292
*******************************************************************************/

/* Param List */  
@projTaskId int=NULL,  
@ParentTaskId int=NULL,  
@EqpProjID int=NULL,  
@EqpPlanId int=NULL,  
@ProjHeaderId int=NULL  
  
AS  
  
DECLARE @UseSchedulingSystemLastOcc bit  
DECLARE @Projection_Type_Id int  
DECLARE @EndUsage float  
DECLARE @UsageQUOMId int  
DECLARE @CurrentUsage float  
DECLARE @FinalChangeUsage float  
DECLARE @EndDate datetime  
DECLARE @ProjTypeCurrent int  
DECLARE @Repair_Description varchar(MAX) --AL: 12/06/08  
DECLARE @Next_Occ_Strategy_Id int  
DECLARE @Planning_Task bit  
DECLARE @Strategy_Reschedule bit  
DECLARE @Pct_Frequency_Reschedule float  
DECLARE @CurrencyId int  
DECLARE @ProjTypeAlternate int  
DECLARE @ProjTypeCentreline int  
DECLARE @TaskTypeRR int  
DECLARE @ModelId int  
DECLARE @CostSourceId int  
DECLARE @Use_Distribution_Codes bit  
DECLARE @Currency varchar(50)  
DECLARE @SystemSourceAMT int  
DECLARE @ExternalDocumentSystem bit /*VV 28-Apr-2009*/  
DECLARE @ExtDocUseClientCredentials bit/*VV CR8323*/  

--#GD issue #1826
DECLARE @ModifierIdD int
DECLARE @TaskTypeIdD int
DECLARE @ComponentCodeIdD int
DECLARE @TaskCounterIdD int

/*VV E621*/
DECLARE @CnangeoutWorkorderId int, @RebuildSite varchar(1000)
  
  
SET @ProjTypeCurrent=1  
SET @ProjTypeAlternate=3  
SET @ProjTypeCentreline=5  
  
SET @SystemSourceAMT=1  
DECLARE @ScheduleTypeLPUOM int  
DECLARE @ScheduleTypeLPD int  
  
SET @ScheduleTypeLPUOM=1  
SET @ScheduleTypeLPD=3  
  
   
SELECT @UseSchedulingSystemLastOcc=UseSchedulingSystemLastOcc,@Strategy_Reschedule=Strategy_Reschedule,  
@Pct_Frequency_Reschedule=Pct_Frequency_Reschedule,@Use_Distribution_Codes=Use_Distribution_Codes  
FROM AMT_VARIABLE  
  
SELECT @CurrencyId=CurrencyId,@Currency=CurrencyDesc FROM tblCurrencies WHERE PrimaryCurr>0 OR PrimaryCurr<0  
  
SELECT @ModifierIdD =modifierid from tblModifierCodes where Default_Record=1
SELECT @TaskTypeIdD =tasktypeid from tblTaskTypes where Default_Record=1
SELECT @ComponentCodeIdD=componentcodeId from tblComponentCodes where Default_Record=1
SELECT @TaskCounterIdD=applicationcodeid from tblApplicationCodes where Default_Record=1
  
--AL: 30/03/09  
DECLARE @PartsDemandAnalysis bit  
  
SELECT @PartsDemandAnalysis=Feature_Enabled FROM AMT_FEATURE WHERE Feature_ID=15  
  
/*VV 27-Apr-2009*/  
EXEC AMT_TYPED_VARIABLE_GET_P @Value_Name='ExternalDocumentSystem',  @Varchar_Value=@ExternalDocumentSystem OUTPUT  
  
SET @ExternalDocumentSystem=ISNULL(@ExternalDocumentSystem,0)  
  
/*VV CR8323*/  
EXEC AMT_TYPED_VARIABLE_GET_P @Value_Name='ExtDocUseClientCredentials',  @Varchar_Value=@ExtDocUseClientCredentials OUTPUT  
SET @ExtDocUseClientCredentials=ISNULL(@ExtDocUseClientCredentials,0)  
  
CREATE TABLE #z_PROJ_TASK_SUMMARY(  
 ProjTaskId int ,  
 EqpPlanId int ,  
 EqpProjId int ,  
 ComponentCodeId int ,  
 ModifierId int ,  
 TaskTypeId int ,  
 ApplicationCodeId int ,  
 ManufacturerId int ,  
 UsageQUOMId int,  
 LastOcc float,  
 LastOccDate datetime,  
 PlanUseCalc bit ,  
 NextOcc float,  
 NextOccDate datetime,  
 PlanStatus tinyint ,  
 --PlanDateLocked bit, AL: 21/02/08  
 Unscheduled smallint ,  
 LastModifiedDate datetime,  
 Last_Change_Usage float ,  
 Last_Change_Date datetime ,  
 Task_Header_Id int ,  
 Rotable_Part_Id int,  
 Group_Number varchar(50) COLLATE DATABASE_DEFAULT,  
 Part_Id int,  
 Planning_Task bit ,  
 Planning_Lead_Time int,  
 SchedulingTaskId int,  
 Schedule_Type_Id int ,  
 Scheduling_Group_Id int,  
 Scheduling_Group_Counter int,  
 Operational_Criticality_Id int,  
 Warranty_Period_Usage float ,  
 Warranty_Period_Days float ,  
 Maintenance_Strategy_Id int,  
 Changeout_Guidelines varchar(1000) COLLATE DATABASE_DEFAULT,  
 Task_Description varchar(100) COLLATE DATABASE_DEFAULT,  
 Last_Mod_Date datetime ,  
 ExternalIdentifier varchar(100)/*3292*/ COLLATE DATABASE_DEFAULT,  
 InspectionTaskTypeId int,  
 InspectionOffset float,  
 PerformanceStrategyReason varchar(200) COLLATE DATABASE_DEFAULT,  
 RCMComponentStructureId int,  
 ParentTaskId int,  
 AutomaticUpdate bit,  
 [First] float ,  
 Frequency float ,  
 ProjTaskOptId int ,  
 Last_Perf_Occ float,  
 Last_Sched_Occ float,  
 Last_Perf_Date datetime,  
 Last_Sched_Date datetime,  
 Final float,  
 --AL: 21/02/08  
 ReviewStatusID int,  
 ReviewUserID int,  
 ReviewDate datetime,  
 LastPerformedWO varchar(100) COLLATE DATABASE_DEFAULT,  
  
 --AL: 30/03/09  
 PctPurchasePart float,  
 PctPurchaseLabour float,  
 PctPurchaseMisc float,  
 PctPurchaseNewPart float,  
 SalesResponsibilityID int,  
 /*VV E602*/
 StartingSerialNoId int,  
 CBDTask bit, -- CR9019 VS  
 /*VV E316*/
 TagId varchar(50) COLLATE DATABASE_DEFAULT,
 PartRatingId int,
 AutoGenerateWOS bit /*GW*/,
 /*VV E611*/
 PEXRebuildLocationId int,
 PEXPartId int,
 PEXPartTypeId int,
 /*E789*/
 PartClassificationId int,
 DefaultLocationForRebuild int
 PRIMARY KEY(ProjTaskId,ProjTaskOptId)  
)   
  
CREATE TABLE #z_PTA(  
ProjTaskAmtId int,  
ProjTaskOptId int,  
PricedJobId int,  
JobCodeId int,  
PerformedAtSiteId int,  
LaborShare float,  
PartTypeId int,  
CurrencyId int,  
LaborCost float,  
PartsCost float,  
MiscCost float,  
Duration float,  
Rotable_Repair_Strategy bit,  
Action_Required_Id int,  
Rebuild_Location_Id int,  
Pricing_Date datetime,  
Labour_Activity_Id int,  
Misc_Cost_Expense_ID int,  
Labour_Cost_Expense_ID int,  
Cost_Bearer_ID int,  
Parts_Cost_Expense_ID int,  
Crane_Cost float,  
Pct_Freight float,  
Avg_Daily_Work_Hrs float,  
Avg_No_People float,  
Avg_Travel_Hrs float,  
Travel_Distance float,  
Travel_Recovery_Rate_L float,  
Misc_Trip_Cost float,  
LaborHours float,  
Labour_Hrs_Field bit,  
Travel_Recovery_Rate_V float,  
Parts_EDC_ID int,  
Labour_EDC_ID int,  
Misc_EDC_ID int,  
Cost_Centre_ID int,  
Work_Group_Id int,  
Health_Safety_Id int,  
QtyVolume float,  
PercentTopUp float,  
UnitPrice float,  
Consumable bit,  
CostSourceId int,  
System_Source_Id int  
PRIMARY KEY(ProjTaskAmtId,ProjTaskOptId)  
)   
  
  
--If @ParentTaskId is supplied - it is the defaults for RR task  
IF @ParentTaskId>0  
BEGIN  
  
 SELECT @TaskTypeRR=TaskTypeId FROM tblTaskTypes WHERE Code='RR'  
  
 INSERT INTO #z_PROJ_TASK_SUMMARY( ProjTaskId, EqpPlanId, EqpProjId, ComponentCodeId, ModifierId, TaskTypeId,   
 ApplicationCodeId,  
 ManufacturerId, UsageQUOMId, LastOcc, LastOccDate, PlanUseCalc, NextOcc, NextOccDate, PlanStatus,   
 --PlanDateLocked, AL: 21/02/08  
 Unscheduled,   
 LastModifiedDate, Last_Change_Usage, Last_Change_Date, Task_Header_Id, Rotable_Part_Id, Group_Number,   
 Part_Id, Planning_Task,   
 Planning_Lead_Time, SchedulingTaskId, Schedule_Type_Id, Scheduling_Group_Id, Scheduling_Group_Counter,   
 Operational_Criticality_Id, Warranty_Period_Usage, Warranty_Period_Days, Maintenance_Strategy_Id,   
 Changeout_Guidelines,   
 Task_Description, Last_Mod_Date, ExternalIdentifier, InspectionTaskTypeId, InspectionOffset,   
 PerformanceStrategyReason,   
 RCMComponentStructureId, ParentTaskId, AutomaticUpdate, First, Frequency, ProjTaskOptId, Last_Perf_Occ,   
 Last_Sched_Occ,   
 Last_Perf_Date, Last_Sched_Date,Final,  
 --AL: 21/02/08  
 ReviewStatusID,ReviewUserID,ReviewDate,  
 --AL: 30/03/09  
 PctPurchasePart,PctPurchaseLabour,PctPurchaseMisc,PctPurchaseNewPart,SalesResponsibilityID,StartingSerialNoId ,  
    CBDTask,
 --GW 31/3/11 
 AutoGenerateWOS,
  /*E789*/ PartClassificationId, DefaultLocationForRebuild
) 
-- CR9019  VS  
  
 SELECT       
 0 AS ProjTaskId,  
 PT.EqpPlanId, PT.EqpProjId, PT.ComponentCodeId, PT.ModifierId, @TaskTypeRR AS TaskTypeId, PT.ApplicationCodeId,   
 PT.ManufacturerId,   
 PT.UsageQUOMId,   
 NULL AS LastOcc, NULL LastOccDate, 1 AS PlanUseCalc, NULL AS NextOcc, NULL AS NextOccDate, 0 AS PlanStatus,   
 --0 AS PlanDateLocked, AL: 21/02/08  
 0 AS Unscheduled, GETDATE() AS LastModifiedDate, 0 AS Last_Change_Usage, NULL AS Last_Change_Date,   
 PT.Task_Header_Id,   
 NULL AS Rotable_Part_Id,   
 NULL AS Group_Number, NULL AS Part_Id, 0 AS Planning_Task, 0 AS Planning_Lead_Time,   
 NULL AS SchedulingTaskId, PT.Schedule_Type_Id,   
 NULL AS Scheduling_Group_Id, NULL AS Scheduling_Group_Counter, PT.Operational_Criticality_Id, 0 AS Warranty_Period_Usage,   
 0 AS Warranty_Period_Days, NULL AS Maintenance_Strategy_Id, NULL AS Changeout_Guidelines, NULL AS Task_Description,   
 GETDATE() AS Last_Mod_Date,   
 NULL AS ExternalIdentifier, NULL AS InspectionTaskTypeId, 0 AS InspectionOffset,   
 NULL AS PerformanceStrategyReason, NULL AS RCMComponentStructureId,   
 @ParentTaskId AS ParentTaskId, 1 AS AutomaticUpdate,   
 dbo.RR_FREQUENCY_F(PTO.Frequency) AS First,dbo.RR_FREQUENCY_F(PTO.Frequency) AS Frequency,  
 0 AS ProjTaskOptId,  
 NULL AS Last_Perf_Occ,  
 NULL AS Last_Sched_Occ,  
 NULL AS Last_Perf_Date,  
 NULL AS Last_Sched_Date,  
 0 AS Final,  
 --AL: 21/02/08  
 1 AS ReviewStatusID,  
 NULL AS ReviewUserID,  
 NULL AS ReviewDate,  
 --AL: 30/03/09  
 100 AS PctPurchasePart,  
 100 AS PctPurchaseLabour,  
 100 AS PctPurchaseMisc,  
 100 AS PctPurchaseNewPart,  
 NULL AS SalesResponsibilityID,  
 NULL AS StartingSerialNoId,  
 0 As CBDTask, -- CR9019 VS 
 PT.AutoGenerateWOS /*GW*/,
 /*E789*/ PT.PartClassificationId, PT.DefaultLocationForRebuild  
 FROM           
 tblProjTasks PT   
  INNER JOIN  
 tblProjTaskOpts PTO   
  ON PT.ProjTaskId = PTO.ProjTaskId  
 WHERE PT.ProjTaskId=@ParentTaskId  
  
  
  
END  
ELSE IF @projTaskId>0  
BEGIN  
 --Task details @ProjtaskId is supplied  
 INSERT INTO #z_PROJ_TASK_SUMMARY( ProjTaskId, EqpPlanId, EqpProjId, ComponentCodeId, ModifierId, TaskTypeId, ApplicationCodeId,  
 ManufacturerId, UsageQUOMId, LastOcc, LastOccDate, PlanUseCalc, NextOcc, NextOccDate, PlanStatus,   
 --PlanDateLocked, --AL: 21/02/08  
 Unscheduled,   
 LastModifiedDate, Last_Change_Usage, Last_Change_Date, Task_Header_Id, Rotable_Part_Id, Group_Number, Part_Id, Planning_Task,   
 Planning_Lead_Time, SchedulingTaskId, Schedule_Type_Id, Scheduling_Group_Id, Scheduling_Group_Counter,   
 Operational_Criticality_Id, Warranty_Period_Usage, Warranty_Period_Days, Maintenance_Strategy_Id, Changeout_Guidelines,   
 Task_Description, Last_Mod_Date, ExternalIdentifier, InspectionTaskTypeId, InspectionOffset, PerformanceStrategyReason,   
 RCMComponentStructureId, ParentTaskId, AutomaticUpdate, First, Frequency, ProjTaskOptId, Last_Perf_Occ, Last_Sched_Occ,   
 Last_Perf_Date, Last_Sched_Date,Final,  
 --AL: 21/02/08  
 ReviewStatusID,ReviewUserID,ReviewDate, LastPerformedWO,  
 --AL: 30/03/09  
 PctPurchasePart,PctPurchaseLabour,PctPurchaseMisc,  
 PctPurchaseNewPart,SalesResponsibilityID,StartingSerialNoId,  
 CBDTask,/*VV E316*/TagId,PartRatingId,AutoGenerateWOS/*GW*/,
 /*VV E611*/ PEXRebuildLocationId, PEXPartId, PEXPartTypeId,
  /*E789*/ PartClassificationId, DefaultLocationForRebuild
  )   
   
 SELECT       
 PT.ProjTaskId,  
 PT.EqpPlanId, PT.EqpProjId, PT.ComponentCodeId, PT.ModifierId, PT.TaskTypeId, PT.ApplicationCodeId,   
 PT.ManufacturerId,   
 PT.UsageQUOMId,   
 PT.LastOcc, PT.LastOccDate, PT.PlanUseCalc, PT.NextOcc, PT.NextOccDate, PT.PlanStatus,   
 --PT.PlanDateLocked, 21/02/08  
 PT.Unscheduled, PT.LastModifiedDate, PT.Last_Change_Usage, PT.Last_Change_Date, PT.Task_Header_Id,   
 PT.Rotable_Part_Id,   
 PT.Group_Number, PT.Part_Id, PT.Planning_Task, PT.Planning_Lead_Time,   
 PT.SchedulingTaskId, PT.Schedule_Type_Id,   
 PT.Scheduling_Group_Id, PT.Scheduling_Group_Counter, PT.Operational_Criticality_Id, PT.Warranty_Period_Usage,   
 PT.Warranty_Period_Days, PT.Maintenance_Strategy_Id, PT.Changeout_Guidelines, PT.Task_Description, PT.Last_Mod_Date,   
 PT.ExternalIdentifier, PT.InspectionTaskTypeId, PT.InspectionOffset, PT.PerformanceStrategyReason, PT.RCMComponentStructureId,   
 PT.ParentTaskId, PT.AutomaticUpdate, PTO.First, PTO.Frequency,  
 PTO.ProjTaskOptId,  
 CASE WHEN @UseSchedulingSystemLastOcc =1 AND SchedulingTaskId>0 THEN Ext_Last_Occ ELSE AMT_WO_Last_Occ END AS Last_Perf_Occ,  
 CASE WHEN @UseSchedulingSystemLastOcc =1 AND SchedulingTaskId>0 THEN Ext_Last_Sched_Occ ELSE AMT_Last_Sched_Occ END AS Last_Sched_Occ,  
 CASE WHEN @UseSchedulingSystemLastOcc =1 AND SchedulingTaskId>0 THEN Ext_Last_Occ_Date ELSE AMT_WO_Last_Occ_Date END AS Last_Perf_Date,  
 CASE WHEN @UseSchedulingSystemLastOcc =1 AND SchedulingTaskId>0 THEN Ext_Last_Sched_Date ELSE AMT_Last_Sched_Date END AS Last_Sched_Date,  
 PT.Final,  
 --AL: 21/02/08  
 PT.ReviewStatusID,PT.ReviewUserID,PT.ReviewDate,  
 -- KN : 02/02/09  
 WO.WorkorderNumber,  
 --AL: 30/03/09  
 PT.PctPurchasePart,PT.PctPurchaseLabour,PT.PctPurchaseMisc,PT.PctPurchaseNewPart,  
 PT.SalesResponsibilityID,PT.StartingSerialNoId,  
 PT.CBDTask/*CR9019 VS*/,/*VV E316*/PT.TagId,PT.PartRatingId,
 --GW 31/3/11
 PT.AutoGenerateWOS,
 /*VV E611*/ N.PEXRebuildLocationId, N.PEXPartId, N.PEXPartTypeId,
 /*E789*/ PartClassificationId, DefaultLocationForRebuild 
 FROM           
 tblProjTasks PT   
  INNER JOIN  
 tblProjTaskOpts PTO   
  ON PT.ProjTaskId = PTO.ProjTaskId  
 LEFT JOIN PROJ_TASK_LAST_OCC_V LO ON LO.ProjTaskId = PT.ProjTaskId  
 LEFT JOIN tblWorkorders WO ON WO.WorkOrderId = LO.WorkOrderId 
 /*VV E611*/  
 LEFT JOIN NEXT_OCC_STRATEGY N ON PT.ProjTaskId=N.Proj_Task_Id
	
 WHERE PT.ProjTaskId=@projTaskId  
  
END  
ELSE  
 BEGIN  
 --Task defaults @ProjtaskId,@ParenttaskId are not supplied  
 DECLARE @Task_Header_Id as int  
  
 DECLARE @z_tblEqpProjs TABLE(EqpProjId int,   
   EqpPlanId int,  
   EndQUOMId int,  
   EqpProjName varchar(50) COLLATE DATABASE_DEFAULT,  
   Pricing_Date datetime,  
   Projection_Type_ID int  
   PRIMARY KEY(EqpProjId))  
  IF @EqpProjId>0  
  BEGIN  
   INSERT INTO @z_tblEqpProjs(EqpProjId,EqpPlanId,EndQUOMId,EqpProjName,Pricing_Date,Projection_Type_ID)  
   SELECT EqpProjId,EqpPlanId,EndQUOMId,EqpProjName,Pricing_Date,Projection_Type_ID FROM tblEqpProjs WHERE EqpProjId=@EqpProjId  
  END  
  ELSE  
  BEGIN  
   INSERT INTO @z_tblEqpProjs(EqpProjId,EqpPlanId,EndQUOMId,EqpProjName,Pricing_Date,Projection_Type_ID)  
   SELECT EqpProjId,EqpPlanId,EndQUOMId,EqpProjName,Pricing_Date,Projection_Type_ID FROM tblEqpProjs WHERE EqpPlanId=@EqpPlanId AND Projection_Header_Id=@ProjHeaderId  
  END  
  
 EXEC TASK_HEADER_MANAGER_P  @ComponentCodeIdD,  @ModifierIdD,  @TaskTypeIdD,  @TaskCounterIdD, @Task_Header_Id output  
  
 INSERT INTO #z_PROJ_TASK_SUMMARY( ProjTaskId, EqpPlanId, EqpProjId, ComponentCodeId, ModifierId, TaskTypeId,   
 ApplicationCodeId,  
 ManufacturerId, UsageQUOMId, LastOcc, LastOccDate, PlanUseCalc, NextOcc, NextOccDate, PlanStatus,   
 --PlanDateLocked, AL: 21/02/08  
 Unscheduled,   
 LastModifiedDate, Last_Change_Usage, Last_Change_Date, Task_Header_Id, Rotable_Part_Id, Group_Number,   
 Part_Id, Planning_Task,   
 Planning_Lead_Time, SchedulingTaskId, Schedule_Type_Id, Scheduling_Group_Id, Scheduling_Group_Counter,   
 Operational_Criticality_Id, Warranty_Period_Usage, Warranty_Period_Days, Maintenance_Strategy_Id,   
 Changeout_Guidelines,   
 Task_Description, Last_Mod_Date, ExternalIdentifier, InspectionTaskTypeId, InspectionOffset,   
 PerformanceStrategyReason,   
 RCMComponentStructureId, ParentTaskId, AutomaticUpdate, First, Frequency, ProjTaskOptId, Last_Perf_Occ,   
 Last_Sched_Occ,   
 Last_Perf_Date, Last_Sched_Date,Final,  
 --AL: 21/02/08  
 ReviewStatusID,ReviewUserID,ReviewDate,  
 --AL: 30/03/09  
 PctPurchasePart,PctPurchaseLabour,PctPurchaseMisc,PctPurchaseNewPart,SalesResponsibilityID,
 /*VV E602*/StartingSerialNoId,
 CBDTask,AutoGenerateWOS/*GW*/,
  /*E789*/ PartClassificationId, DefaultLocationForRebuild ) -- CR9019 VS
  
 SELECT       
 0 AS ProjTaskId,  
 EPR.EqpPlanId, EPR.EqpProjId, @ComponentCodeIdD AS ComponentCodeId, @ModifierIdD AS ModifierId, @TaskTypeIdD AS TaskTypeId, @TaskCounterIdD AS ApplicationCodeId,   
 E.ManufacturerId, EPR.EndQUOMId AS UsageQUOMId,   
 NULL AS LastOcc, NULL LastOccDate, 1 AS PlanUseCalc, NULL AS NextOcc, NULL AS NextOccDate, 0 AS PlanStatus,   
 --0 AS PlanDateLocked, AL: 21/02/08  
 0 AS Unscheduled, GETDATE() AS LastModifiedDate, 0 AS Last_Change_Usage, NULL AS Last_Change_Date,   
 @Task_Header_Id AS Task_Header_Id,   
 NULL AS Rotable_Part_Id,   
 NULL AS Group_Number, NULL AS Part_Id, 0 AS Planning_Task, 0 AS Planning_Lead_Time,   
 NULL AS SchedulingTaskId,   
 CASE WHEN EPR.EndQUOMId>0 THEN @ScheduleTypeLPUOM ELSE @ScheduleTypeLPD END AS Schedule_Type_Id,   
 NULL AS Scheduling_Group_Id, NULL AS Scheduling_Group_Counter,   
 NULL AS Operational_Criticality_Id, 0 AS Warranty_Period_Usage,   
 0 AS Warranty_Period_Days, NULL AS Maintenance_Strategy_Id, NULL AS Changeout_Guidelines, NULL AS Task_Description,   
 GETDATE() AS Last_Mod_Date,   
 NULL AS ExternalIdentifier, NULL AS InspectionTaskTypeId, 0 AS InspectionOffset,   
 NULL AS PerformanceStrategyReason, NULL AS RCMComponentStructureId,   
 NULL AS ParentTaskId, 0 AS AutomaticUpdate,   
 0 AS First,0 AS Frequency,  
 0 AS ProjTaskOptId,  
 NULL AS Last_Perf_Occ,  
 NULL AS Last_Sched_Occ,  
 NULL AS Last_Perf_Date,  
 NULL AS Last_Sched_Date,  
 0 AS Final,  
 --AL: 21/02/08  
 1 AS ReviewStatusID,  
 NULL AS ReviewUserID,  
 NULL AS ReviewDate,  
 --AL: 30/03/09  
 100 AS PctPurchasePart,  
 100 AS PctPurchaseLabour,  
 100 AS PctPurchaseMisc,  
 100 AS PctPurchaseNewPart,  
 NULL AS SalesResponsibilityID, 
 /*VV E602*/ 
 NULL AS StartingSerialNoId,
 0 As CBDTask, -- CR9019 VS
 0 As AutoGenerateWOS/*GW*/,
  /*E789*/NULL AS PartClassificationId, NULL AS DefaultLocationForRebuild 
  
 FROM           
 @z_tblEqpProjs EPR   
  INNER JOIN  
 tblEqpPlans EP  
  ON EPR.EqpPlanId=EP.EqpPlanId  
  INNER JOIN  
 tblEquipment E   
  ON EP.EquipmentId = E.EquipmentId  
    
   
END  
  
  
IF @ParentTaskId>0  
BEGIN  
   
 SET @CostSourceId=dbo.COST_SOURCE_GET_F(0,0,0,@ParentTaskId)   
  
 INSERT INTO #z_PTA(  
 ProjTaskAmtId, ProjTaskOptId, PricedJobId, JobCodeId, PerformedAtSiteId, LaborShare, PartTypeId, CurrencyId, LaborCost,   
 PartsCost, MiscCost,   Duration, Rotable_Repair_Strategy, Action_Required_Id, Rebuild_Location_Id, Pricing_Date,   
 Labour_Activity_Id, Misc_Cost_Expense_ID, Labour_Cost_Expense_ID, Cost_Bearer_ID, Parts_Cost_Expense_ID, Crane_Cost,   
 Pct_Freight, Avg_Daily_Work_Hrs, Avg_No_People, Avg_Travel_Hrs, Travel_Distance, Travel_Recovery_Rate_L, Misc_Trip_Cost,   
 LaborHours, Labour_Hrs_Field, Travel_Recovery_Rate_V, Parts_EDC_ID, Labour_EDC_ID, Misc_EDC_ID, Cost_Centre_ID,   
 Work_Group_Id, Health_Safety_Id, QtyVolume, PercentTopUp, UnitPrice, Consumable,CostSourceId,System_Source_Id )   
 SELECT       
 -1 AS ProjTaskAmtId, 0 AS ProjTaskOptId, NULL AS PricedJobId,   
 CASE WHEN COUNT(DISTINCT(PTA.JobCodeId))>1 THEN NULL ELSE MAX(PTA.JobCodeId) END AS JobCodeId,   
 NULL AS PerformedAtSiteId, 100 AS LaborShare, NULL AS PartTypeId,   
 @CurrencyId AS CurrencyId,   
  
 /* Use escalation in current/alternate/centreline only for the tasks in current/alternate/centrelines  
 In all other cases the pricing date is at the projection level and the costs are not escalated*/  
  
 SUM(PTA.TotalLabourCost * CASE WHEN EPR.Projection_Type_ID IN (@ProjTypeCurrent,@ProjTypeAlternate,@ProjTypeCentreline)  
 THEN CE.CumLaborEscalation ELSE 1 END * PTO.Probability / 100/ ERC.ExRate  
 /NULLIF(PTO.Frequency,0)*dbo.RR_FREQUENCY_F(PTO.Frequency))*CS.LabourFactor AS LaborCost,   
  
 SUM(PTA.PartsCost * CASE WHEN EPR.Projection_Type_ID IN (@ProjTypeCurrent,@ProjTypeAlternate,@ProjTypeCentreline)   
 THEN CPE.CumPartsEscalation ELSE 1 END *   
 PTO.Probability / 100/ ERC.ExRate/NULLIF(PTO.Frequency,0)*dbo.RR_FREQUENCY_F(PTO.Frequency))*CS.PartFactor  
 AS PartsCost,   
  
 SUM(PTA.TotalMiscCost * CASE WHEN EPR.Projection_Type_ID IN (@ProjTypeCurrent,@ProjTypeAlternate,@ProjTypeCentreline)  
 THEN CE.CumMiscEscalation ELSE 1 END * PTO.Probability / 100/ ERC.ExRate  
 /NULLIF(PTO.Frequency,0)*dbo.RR_FREQUENCY_F(PTO.Frequency))*CS.PartFactor AS MiscCost,   
    
 SUM(PTA.Duration* PTO.Probability / 100/NULLIF(PTO.Frequency,0)*dbo.RR_FREQUENCY_F(PTO.Frequency))*  
 CS.DurationFactor  AS Duration,   
  
 0 AS Rotable_Repair_Strategy, NULL AS Action_Required_Id, NULL AS Rebuild_Location_Id,  
 /*If projection is current/alt/centreline set pricing date to the currenct date, in all other cases the pricing date is  
 from projection*/  
 CASE WHEN EPR.Projection_Type_ID IN (@ProjTypeCurrent,@ProjTypeAlternate,@ProjTypeCentreline) THEN GETDATE()  
 ELSE EPR.Pricing_Date END AS Pricing_Date,  
   
 CASE WHEN COUNT(DISTINCT(PTA.Labour_Activity_Id))>1 THEN NULL ELSE MAX(PTA.Labour_Activity_Id) END AS Labour_Activity_Id,    
 CASE WHEN COUNT(DISTINCT(PTA.Misc_Cost_Expense_ID))>1 THEN NULL ELSE MAX(PTA.Misc_Cost_Expense_ID) END AS Misc_Cost_Expense_ID,   
 CASE WHEN COUNT(DISTINCT(PTA.Labour_Cost_Expense_ID))>1 THEN NULL ELSE MAX(PTA.Labour_Cost_Expense_ID) END AS Labour_Cost_Expense_ID,   
 CASE WHEN COUNT(DISTINCT(PTA.Cost_Bearer_ID))>1 THEN NULL ELSE MAX(PTA.Cost_Bearer_ID) END AS Cost_Bearer_ID,   
 CASE WHEN COUNT(DISTINCT(PTA.Parts_Cost_Expense_ID))>1 THEN NULL ELSE MAX(PTA.Parts_Cost_Expense_ID) END AS Parts_Cost_Expense_ID,   
 0 AS Crane_Cost, 0 AS Pct_Freight, 0 AS Avg_Daily_Work_Hrs, 0 AS Avg_No_People, 0 AS Avg_Travel_Hrs, 0 AS Travel_Distance,   
 0 AS Travel_Recovery_Rate_L, 0 AS Misc_Trip_Cost,   
  
 SUM(PTA.LaborHours* PTO.Probability / 100/NULLIF(PTO.Frequency,0)*dbo.RR_FREQUENCY_F(PTO.Frequency))*  
 CS.LabourHrsFactor AS LaborHours,  
 1 AS Labour_Hrs_Field, 0 AS Travel_Recovery_Rate_V,   
 CASE WHEN COUNT(DISTINCT(PTA.Parts_EDC_ID))>1 THEN NULL ELSE MAX(PTA.Parts_EDC_ID) END AS Parts_EDC_ID,   
 CASE WHEN COUNT(DISTINCT(PTA.Labour_EDC_ID))>1 THEN NULL ELSE MAX(PTA.Labour_EDC_ID) END AS Labour_EDC_ID,   
 CASE WHEN COUNT(DISTINCT(PTA.Misc_EDC_ID))>1 THEN NULL ELSE MAX(PTA.Misc_EDC_ID) END AS Misc_EDC_ID,   
 CASE WHEN COUNT(DISTINCT(PTA.Cost_Centre_ID))>1 THEN NULL ELSE MAX(PTA.Cost_Centre_ID) END AS Cost_Centre_ID,   
 CASE WHEN COUNT(DISTINCT(PTA.Work_Group_Id))>1 THEN NULL ELSE MAX(PTA.Work_Group_Id) END AS Work_Group_Id,   
 CASE WHEN COUNT(DISTINCT(PTA.Health_Safety_Id))>1 THEN NULL ELSE MAX(PTA.Health_Safety_Id) END AS Health_Safety_Id,   
 0 AS QtyVolume, 0 AS PercentTopUp, 0 AS UnitPrice,0 AS Consumable,@CostSourceId AS CostSourceId,NULL AS System_Source_Id 
 --PT.CBDTask -- CR9019 VS 
   
 FROM   
 tblProjTasks PT     
  INNER JOIN  
 tblProjTaskOpts PTO   
  ON PT.ProjTaskId = PTO.ProjTaskId  
  INNER JOIN   
 PROJ_TASK_AMT_COST_1_V PTA  
  ON PTA.ProjTaskOptId = PTO.ProjTaskOptId  
  INNER JOIN   
 tblCostEscalations CE  
  ON PTA.Pricing_Date >= CE.EscalationDate AND PTA.Pricing_Date < CE.EndDate  
  INNER JOIN   
 tblCostPartsEscalations CPE  
  ON CE.CostEscalationId = CPE.CostEscalationId AND CPE.ManufacturerId = PT.ManufacturerId  
  INNER JOIN   
 tblEqpProjs EPR  
  ON PT.EqpProjId = EPR.EqpProjId  
  INNER JOIN   
 tblExRates ER  
  ON EPR.ExchangeRateId = ER.ExRateID  
  INNER JOIN   
 tblExRateCurrencies ERC  
  ON ERC.ExRateID = ER.ExRateID AND ERC.CurrencyID = PTA.CurrencyID  
  INNER JOIN  
 RCM_COMPONENT_STRUCTURE CS  
  ON PT.RCMComponentStructureId=CS.RCMComponentStructureId  
 WHERE PT.ProjTaskId=@ParentTaskId  
 GROUP BY PT.ProjTaskId,  
 CASE WHEN EPR.Projection_Type_ID IN (@ProjTypeCurrent,@ProjTypeAlternate,@ProjTypeCentreline) THEN GETDATE() ELSE EPR.Pricing_Date END,  
 CS.PartFactor,CS.LabourFactor,CS.MiscFactor,CS.LabourHrsFactor,CS.DurationFactor,  
 PT.CBDTask -- CBDTask  
  
END  
ELSE IF @projTaskId>0  
BEGIN  
 --@projTaskId is supplied  
 INSERT INTO #z_PTA(  
 ProjTaskAmtId, ProjTaskOptId, PricedJobId, JobCodeId, PerformedAtSiteId, LaborShare, PartTypeId, CurrencyId, LaborCost,   
 PartsCost, MiscCost,   Duration, Rotable_Repair_Strategy, Action_Required_Id, Rebuild_Location_Id, Pricing_Date,   
 Labour_Activity_Id, Misc_Cost_Expense_ID, Labour_Cost_Expense_ID, Cost_Bearer_ID, Parts_Cost_Expense_ID, Crane_Cost,   
 Pct_Freight, Avg_Daily_Work_Hrs, Avg_No_People, Avg_Travel_Hrs, Travel_Distance, Travel_Recovery_Rate_L, Misc_Trip_Cost,   
 LaborHours, Labour_Hrs_Field, Travel_Recovery_Rate_V, Parts_EDC_ID, Labour_EDC_ID, Misc_EDC_ID, Cost_Centre_ID,   
 Work_Group_Id, Health_Safety_Id, QtyVolume, PercentTopUp, UnitPrice, Consumable,CostSourceId,System_Source_Id)  
 SELECT       
 ProjTaskAmtId, PTA.ProjTaskOptId, PricedJobId, JobCodeId, PerformedAtSiteId, LaborShare, PartTypeId, CurrencyId, LaborCost,   
 PartsCost, MiscCost,   Duration, Rotable_Repair_Strategy, Action_Required_Id, Rebuild_Location_Id, Pricing_Date,   
 Labour_Activity_Id, Misc_Cost_Expense_ID, Labour_Cost_Expense_ID, Cost_Bearer_ID, Parts_Cost_Expense_ID, Crane_Cost,   
 Pct_Freight, Avg_Daily_Work_Hrs, Avg_No_People, Avg_Travel_Hrs, Travel_Distance, Travel_Recovery_Rate_L, Misc_Trip_Cost,   
 LaborHours, Labour_Hrs_Field, Travel_Recovery_Rate_V, Parts_EDC_ID, Labour_EDC_ID, Misc_EDC_ID, Cost_Centre_ID,   
 Work_Group_Id, Health_Safety_Id, QtyVolume, PercentTopUp, UnitPrice, Consumable,  
 dbo.COST_SOURCE_GET_F(PTA.PricedJobId,CA.Cost_Allocation_Id,PTA.Consumable,PT.ParentTaskId) AS CostSourceId,  
 CA.System_Source_Id AS System_Source_Id  
 FROM           
 tblProjTaskAmts PTA  
  INNER JOIN  
 #z_PROJ_TASK_SUMMARY PT  
  ON PTA.ProjTaskOptId=PT.ProjTaskOptId  
  LEFT OUTER JOIN  
 COST_ALLOCATION CA  
  ON PTA.ProjTaskAmtId=CA.Proj_Task_Amt_Id  
END  
ELSE   
BEGIN  
 --Task defaults  
 DECLARE @PartTypeID int  
 DECLARE @Parts_EDC_ID int  
 DECLARE @Labour_EDC_ID int  
 DECLARE @Misc_EDC_ID int  
  
 SELECT @PartTypeID=PartTypeId FROM tblPartTypes WHERE PartTypeDefault<>0  
  
 SELECT @Parts_EDC_ID = EDC.[ID]   
 FROM ENTRY_DISTRIBUTION_CODE EDC   
 WHERE EDC.Parts_Default = 1  
  
 SELECT @Labour_EDC_ID = EDC.[ID]   
 FROM ENTRY_DISTRIBUTION_CODE EDC   
 WHERE EDC.Labour_Default = 1  
  
 SELECT @Misc_EDC_ID = EDC.[ID]  
 FROM ENTRY_DISTRIBUTION_CODE EDC   
 WHERE EDC.Misc_Default = 1  
  
  
  
 INSERT INTO #z_PTA(  
 ProjTaskAmtId, ProjTaskOptId, PricedJobId, JobCodeId, PerformedAtSiteId, LaborShare, PartTypeId, CurrencyId, LaborCost,   
 PartsCost, MiscCost,   Duration, Rotable_Repair_Strategy, Action_Required_Id, Rebuild_Location_Id, Pricing_Date,   
 Labour_Activity_Id, Misc_Cost_Expense_ID, Labour_Cost_Expense_ID, Cost_Bearer_ID, Parts_Cost_Expense_ID, Crane_Cost,   
 Pct_Freight, Avg_Daily_Work_Hrs, Avg_No_People, Avg_Travel_Hrs, Travel_Distance, Travel_Recovery_Rate_L, Misc_Trip_Cost,   
 LaborHours, Labour_Hrs_Field, Travel_Recovery_Rate_V, Parts_EDC_ID, Labour_EDC_ID, Misc_EDC_ID, Cost_Centre_ID,   
 Work_Group_Id, Health_Safety_Id, QtyVolume, PercentTopUp, UnitPrice, Consumable,CostSourceId,System_Source_Id)  
 SELECT       
 -1 AS ProjTaskAmtId, 0 AS ProjTaskOptId, NULL AS PricedJobId,   
 0 AS JobCodeId, NULL AS PerformedAtSiteId, 100 AS LaborShare, @PartTypeID AS PartTypeId, @CurrencyId AS CurrencyId,   
 0 AS LaborCost, 0 AS PartsCost, 0 AS MiscCost, 0 AS Duration, 0 AS Rotable_Repair_Strategy,   
 NULL AS Action_Required_Id, NULL AS Rebuild_Location_Id,   
 /*If projection is current/alt/centreline set pricing date to the currenct date, in all other cases the pricing date is  
 from projection*/  
 CASE WHEN EPR.Projection_Type_ID IN (@ProjTypeCurrent,@ProjTypeAlternate,@ProjTypeCentreline) THEN GETDATE()  
 ELSE EPR.Pricing_Date END AS Pricing_Date,   
 NULL AS Labour_Activity_Id, NULL AS Misc_Cost_Expense_ID, NULL AS Labour_Cost_Expense_ID,   
 EP.Default_Cost_Bearer_ID AS Cost_Bearer_ID, NULL AS Parts_Cost_Expense_ID, 0 AS Crane_Cost,   
 0 AS Pct_Freight, 0 AS Avg_Daily_Work_Hrs, 0 AS Avg_No_People, 0 AS Avg_Travel_Hrs, 0 AS Travel_Distance,   
 0 AS Travel_Recovery_Rate_L, 0 AS Misc_Trip_Cost, 0 AS LaborHours, 1 AS Labour_Hrs_Field,   
 0 AS Travel_Recovery_Rate_V, @Parts_EDC_ID AS Parts_EDC_ID, @Labour_EDC_ID AS Labour_EDC_ID,   
 @Misc_EDC_ID AS Misc_EDC_ID, EP.Cost_Centre_ID AS Cost_Centre_ID,   
 NULL AS Work_Group_Id, NULL AS Health_Safety_Id, 0 AS QtyVolume, 0 AS PercentTopUp, 0 AS UnitPrice, 0 AS Consumable,  
 dbo.COST_SOURCE_GET_F(0,0,0,0) AS CostSourceId,  
 NULL AS System_Source_Id  
 FROM           
 @z_tblEqpProjs EPR   
  INNER JOIN  
 tblEqpPlans EP  
  ON EPR.EqpPlanId=EP.EqpPlanId  
END  
  
/*drop table z_PROJ_TASK_SUMMARY  
select * into z_PROJ_TASK_SUMMARY from #z_PROJ_TASK_SUMMARY   
return*/  
  
  
--Check if we need to show strategy details  
  
SELECT @Projection_Type_Id=EPR.Projection_Type_Id, @UsageQUOMId=PT.UsageQUOMId,@EqpProjId=PT.EqpProjId,   
@EndDate=EPR.EndDate,  
@EndUsage=CASE WHEN ISNULL(EPR.EndQUOMId,0)=ISNULL(PT.UsageQUOMId,0) THEN EPR.EndUsage ELSE 0 END,  
@Planning_Task=PT.Planning_Task,@ModelId=E.ModelId  
FROM   
tblEquipment E  
 INNER JOIN  
tblEqpPlans EP  
 ON E.EquipmentId=EP.EquipmentId  
 INNER JOIN  
#z_PROJ_TASK_SUMMARY PT  
 ON EP.EqpPlanId=PT.EqpPlanId  
 INNER JOIN  
tblEqpProjs EPR  
 ON PT.EqpProjId=EPR.EqpProjId  
  
IF @Projection_Type_Id=@ProjTypeCurrent AND @Planning_Task=1 
BEGIN  
	--Final change usage  
	SELECT @FinalChangeUsage=MAX(OccUsage) FROM tblProjTaskOccs WHERE ProjTaskId=@ProjTaskId  

	--End Usage  
	IF @EndUsage=0  
	BEGIN  
	SET @EndUsage=dbo.GET_EQP_PROJ_END_USAGE_F(@EqpProjId, @UsageQUOMID,@EndDate)  
	END  

	--Current Usage  
	SET @CurrentUsage=dbo.GET_USAGE_FROM_DATE_F(@EqpProjId,@UsageQUOMID,GETDATE())  

	EXEC NEXT_OCC_STRATEGY_DEFAULT_ADD_P @ProjTaskId=@projTaskId  

	SELECT @Next_Occ_Strategy_Id=Next_Occ_Strategy_Id,@Repair_Description=Repair_Description FROM NEXT_OCC_STRATEGY WHERE Proj_Task_Id=@projTaskId  
	
	/*VV E621*/	
	SELECT @CnangeoutWorkorderId=dbo.CHANGEOUT_WORKORDER_ID_GET_F(@ProjTaskId)
	
	IF(ISNULL(@CnangeoutWorkorderId,0)>0) 
	BEGIN
		SELECT @RebuildSite=S.Site
		FROM
		TASK C
			INNER JOIN
		TASK R
			ON C.RebuildTaskId=R.Task_ID
			INNER JOIN
		tblSites S
			ON R.Site_Id=S.SiteId
		WHERE C.Task_ID=@CnangeoutWorkorderId
	END
	
END  
  
--Cost allocations  
SELECT * INTO #z_COST_ALLOCATIONS FROM dbo.COST_ALLOCATIONS_F('',0,0,0,0,0,@ProjTaskId)  
  
CREATE TABLE #z_PTCost(ProjTaskId int,PartsCost float,LabourCost float,MiscCost float,Duration float,  
LaborHours float,CCost_Bearer_Id int,Cost_Bearer_Id int PRIMARY KEY (ProjTaskId))  
  
IF @ParentTaskId>0  
BEGIN  
 INSERT INTO #z_PTCost(ProjTaskId,PartsCost,LabourCost,MiscCost,Duration,LaborHours,CCost_Bearer_Id,Cost_Bearer_Id)  
 SELECT 0 AS ProjTaskId,PTA.PartsCost,PTA.LaborCost,PTA.MiscCost,PTA.Duration,PTA.LaborHours,  
 1 AS CCost_Bearer_Id,PTA.Cost_Bearer_Id  
 FROM  
 #z_PROJ_TASK_SUMMARY PT  
  INNER JOIN  
 #z_PTA PTA  
  ON PT.ProjTaskOptId=PTA.ProjTaskOptId    
  INNER JOIN   
 tblCostEscalations CE  
  ON PTA.Pricing_Date >= CE.EscalationDate AND PTA.Pricing_Date < CE.EndDate  
  INNER JOIN   
 tblCostPartsEscalations CPE  
  ON CE.CostEscalationId = CPE.CostEscalationId AND CPE.ManufacturerId = PT.ManufacturerId  
  INNER JOIN   
 tblEqpProjs EPR  
  ON PT.EqpProjId = EPR.EqpProjId  
  INNER JOIN   
 tblExRates ER  
  ON EPR.ExchangeRateId = ER.ExRateID  
  INNER JOIN   
 tblExRateCurrencies ERC  
  ON ERC.ExRateID = ER.ExRateID AND ERC.CurrencyID = PTA.CurrencyID  
   
END  
ELSE IF @ProjTaskId>0  
BEGIN  
 INSERT INTO #z_PTCost(ProjTaskId,PartsCost,LabourCost,MiscCost,Duration,LaborHours,CCost_Bearer_Id,Cost_Bearer_Id)  
 SELECT PT.ProjTaskId,  
 SUM(PTA.PartsCost * CPE.CumPartsEscalation/ ERC.ExRate/* *PTO.Probability / 100*/) AS PartsCost,  
 SUM(PTA.TotalLabourCost * CE.CumLaborEscalation/ ERC.ExRate/* *PTO.Probability / 100*/) AS LabourCost,  
 SUM(PTA.TotalMiscCost * CE.CumMiscEscalation/ ERC.ExRate/* *PTO.Probability / 100*/) AS MiscCost,  
 SUM(PTA.Duration /** PTO.Probability / 100*/)  AS Duration,   
 SUM(PTA.LaborHours /** PTO.Probability / 100*/) AS LaborHours,  
 COUNT(DISTINCT PTA.Cost_Bearer_Id) AS CCost_Bearer_Id,MAX(PTA.Cost_Bearer_Id) AS Cost_Bearer_Id  
 FROM  
 #z_PROJ_TASK_SUMMARY PT  
  INNER JOIN  
 #z_PTA A  
  ON PT.ProjTaskOptId=A.ProjTaskOptId  
  INNER JOIN  
 PROJ_TASK_AMT_COST_1_V PTA  
  ON A.ProjTaskAmtId=PTA.ProjTaskAmtId  
  INNER JOIN   
 tblCostEscalations CE  
  ON PTA.Pricing_Date >= CE.EscalationDate AND PTA.Pricing_Date < CE.EndDate  
  INNER JOIN   
 tblCostPartsEscalations CPE  
  ON CE.CostEscalationId = CPE.CostEscalationId AND CPE.ManufacturerId = PT.ManufacturerId  
  INNER JOIN   
 tblEqpProjs EPR  
  ON PT.EqpProjId = EPR.EqpProjId  
  INNER JOIN   
 tblExRates ER  
  ON EPR.ExchangeRateId = ER.ExRateID  
  INNER JOIN   
 tblExRateCurrencies ERC  
  ON ERC.ExRateID = ER.ExRateID AND ERC.CurrencyID = PTA.CurrencyID  
 GROUP BY PT.ProjTaskId  
END  
ELSE  
BEGIN  
 INSERT INTO #z_PTCost(ProjTaskId,PartsCost,LabourCost,MiscCost,Duration,LaborHours,CCost_Bearer_Id,Cost_Bearer_Id)  
 SELECT 0 AS ProjTaskId,PTA.PartsCost,PTA.LaborCost,PTA.MiscCost,PTA.Duration,PTA.LaborHours,  
 1 AS CCost_Bearer_Id,PTA.Cost_Bearer_Id  
 FROM  
 #z_PTA PTA  
END  
/*  
drop table z_PROJ_TASK_SUMMARY,z_PTA,z_COST_ALLOCATIONS,z_PTCost  
Select * into z_PROJ_TASK_SUMMARY from #z_PROJ_TASK_SUMMARY  
select * into z_PTA from  #z_PTA  
select * into z_COST_ALLOCATIONS from #z_COST_ALLOCATIONS  
select * into z_PTCost from #z_PTCost  
return  
*/  
  
SELECT     PT.ProjTaskId, CC.Code + ' - ' + CC.Description AS Component_Code, MC.Code + ' - ' + MC.Description AS Modifier_Code,   
 TT.Code + ' - ' + TT.Description AS Task_Type, AC.Code + ' - ' + AC.Description AS Task_Counter, PT.Planning_Task, PT.Planning_Lead_Time,   
 PT.UsageQUOMId, PT.First, PT.Frequency, PT.Final,   
 PT.SchedulingTaskId, ST.SchedulingTask + ', ' + CAST(ST.Interval AS varchar(10)) AS SchedulingTask,   
 PT.ProjTaskOptId,   
 PT.ComponentCodeId, PT.ModifierId, PT.TaskTypeId, PT.ApplicationCodeId,   
 CASE WHEN PT.UsageQUOMId IS NULL   
 THEN 'Days' ELSE QUOM.UOMShortDesc END AS UsageQUOM,    
 PT.LastOcc, PT.LastOccDate,   
 PT.Last_Change_Usage,   
 --VV RR task defaults have Last_Change_Date=NULL  
 ISNULL(PT.Last_Change_Date, EP.StartDate) AS Last_Change_Date,  
 PT.ManufacturerId, PT.Part_Id, PT.Group_Number, PT.Rotable_Part_Id,     
 EPR.Projection_Type_ID, EPR.EqpProjName, EP.EqpPlan, TH.Description AS ProjTaskDesc, CC.SubSystemID, PT.EqpPlanId, EPR.EqpProjId,   
 EQP.ModelId, EP.FleetId, EPR.Projection_Header_ID, PT.Task_Header_Id, EP.Equipment_Type_Id, EPR.Pricing_Date AS ProjPricingDate,   
 MA.Manufacturer, EPR.EndUsage,    
 PT.NextOcc, PT.NextOccDate,   
 PT.Schedule_Type_Id, PT.Scheduling_Group_Id, PT.Scheduling_Group_Counter, SCHT.Schedule_Type, PTSG.Scheduling_Group,   
 PTSG.Scheduling_Group_Type, PTSG.Suppression_Tolerance_Hours,    
 PT.Operational_Criticality_Id,   
 OC.Operational_Criticality, PT.Warranty_Period_Usage, PT.Warranty_Period_Days, PT.Maintenance_Strategy_Id, MS.Maintenance_Strategy,   
 PT.Changeout_Guidelines, PT.Task_Description,   
 P.Part + ' - ' + P.PartDescription AS Part, EPR.EndDate,  PT.PlanUseCalc,   
 --PT.PlanDateLocked, AL: 21/02/08  
 PT.PlanStatus,   
 EP.Utilisation_Method_Id, PT.Last_Mod_Date, EP.StartDate, PTSG.SchedulingGroupSubtypeId, PT.InspectionTaskTypeId,   
 ITT.Code + ' - ' + ITT.Description AS InspectionTaskType, PT.InspectionOffset, PT.PerformanceStrategyReason, PT.RCMComponentStructureId,   
 PT.ParentTaskId, PT.AutomaticUpdate,  
 EPR.EndDate, EPR.EndQUOMId,EPR.EndUsage,PT.Unscheduled,  
 @CurrentUsage AS CurrentUsage,ISNULL(ISNULL(@FinalChangeUsage,PT.LastOcc),PT.[First]) AS FinalChangeUsage,  
 CASE WHEN PT.UsageQUOMId IS NULL   
  THEN dbo.GET_DATE_FROM_USAGE_F(PT.EqpProjId, PT.UsageQUOMID, ISNULL(ISNULL(@FinalChangeUsage,PT.LastOcc),PT.[First]))  
  ELSE NULL  
 END AS FinalChangeDate,  
 100.00*((PT.Frequency-(@EndUsage - ISNULL(ISNULL(@FinalChangeUsage,PT.LastOcc),PT.[First])) )/NULLIF(PT.Frequency,0)) AS RiskLifeLeft,  
 @CurrentUsage-ISNULL(PT.Last_Perf_Occ,ISNULL(PT.Last_Change_Usage,0)) AS LifeUsed,   
 (@CurrentUsage-ISNULL(PT.Last_Perf_Occ,ISNULL(PT.Last_Change_Usage,0)))/NULLIF(PT.Frequency,0)*100 AS LifeUsedPct,  
 @Repair_Description AS Repair_Description,@Next_Occ_Strategy_Id AS Next_Occ_Strategy_Id,PT.Group_Number,  
 RP.Part_Number AS Rotable_Part,RP.Reman_Part_Number,  
 RP.Group_Number AS Rotable_Group_Number,  
 RI.Rotable_Item_Id,RI.Manufacturer_Serial_Number,RIU.Partial_Life_Pct,0 AS TurnsToDate,0 AS LifeToDate,  
 ISNULL(QUOM_1.UOMShortDesc,'') AS EqpQUOM,TH_1.Description AS ParentTask,  
 PT.ExternalIdentifier,  
 RRJ.Action_Required_Id,AR.Description AS Action_Required,  
 RRJ.Rebuild_Location_Id,S.Site AS Rebuild_Location,  
 RRJ.ProjTaskAmtId AS RRJobId,ISNULL(JC.Code+' - '+JC.Description,CA.Job_Code) AS RRJob,  
 PTCost.PartsCost ,PTCost.LabourCost,PTCost.MiscCost,  
 PTCost.Duration,PTCost.LaborHours,CASE WHEN PTCost.CCost_Bearer_Id=1 THEN CB.CostBearer ELSE 'Mixed' END AS CostBearer,  
 @Currency AS PrimCurrency,M.Model + ':' + CC_1.Code + ':' + MC_1.Code + ':' + TT_1.Code + ':' + AC_1.Code + ':' + ISNULL(CS.[Group], '') AS CompStruct,  
 PT.PlanUseCalc AS SysCalc,  
 --PT.PlanDateLocked AS Locked, AL: 29/02/08  
 PT.PlanStatus,EP.Utilisation_Method_Id,  
 Last_Perf_Occ, Last_Sched_Occ, Last_Perf_Date, Last_Sched_Date,  
 CASE WHEN PT.UsageQUOMId>0 THEN NULL ELSE DATEADD(day,PT.[Final],EP.StartDate) END AS FinalDate,  
 CONVERT(varchar(25), PT.Last_Mod_Date, 21) as LastModDate,EP.StartDate AS FirstDate,  
 @Strategy_Reschedule AS Strategy_Reschedule,@Pct_Frequency_Reschedule AS Pct_Frequency_Reschedule,  
 @Use_Distribution_Codes AS Use_Distribution_Codes,  
 --AL: 21/02/08  
 PT.ReviewStatusID,PT.ReviewUserID,PT.ReviewDate,  
 --AL: 29/02/08  
 RS.ReviewStatusDesc as ReviewStatus, AU.AMT_User_Name as ReviewUser,EQPM.Model,  
 PT.LastPerformedWO,  
 --AL: 30/03/09  
 ISNULL(@PartsDemandAnalysis,0) AS PartsDemandAnalysis,  
 PT.PctPurchasePart,PT.PctPurchaseLabour,PT.PctPurchaseMisc,PT.PctPurchaseNewPart,  
 PT.SalesResponsibilityID,E.Surname + ', ' + E.First_Name AS SalesResponsibility,  
 /*VV 28-Apr-2009*/@ExternalDocumentSystem AS ExternalDocumentSystem,  
 /*VV CR8323*/  
 @ExtDocUseClientCredentials AS ExtDocUseClientCredentials,  
 /*VV E602*/
 PT.StartingSerialNoId,  CSER.ComponentSerialNo AS StartingSerialNo,
 PT.CBDTask/*CR9019 VS */,
 /*VV E316*/PT.TagId,PT.PartRatingId,PRA.PartRating,
  PT.AutoGenerateWOS/*GW*/,
  /*VV E611*/N.PEXRebuildLocationId,SNO.Site AS PEXRebuildLocation,
  N.PEXPartId,PNO.Part + ' - ' + PNO.PartDescription AS PEXPart,
  /*E789*/ N.PEXPartTypeId AS NextDuePartClassificationId,PTCLASS.PartClassification AS NextDuePartClassification,
  @RebuildSite AS RebuildSite,
   /*E789*/ 
   PT.PartClassificationId, 
   PCBASEDETAIL.PartClassification AS BaseDetailPartClassification,
   PT.DefaultLocationForRebuild, 
   DEFLOCRBLDSITE.Site AS DefaultLocationForRebuildSiteDesc
FROM    
#z_PTCost PTCost   
 INNER JOIN    
#z_PROJ_TASK_SUMMARY PT   
 ON PTCost.ProjTaskId=PT.ProjTaskId  
 INNER JOIN  
tblComponentCodes CC   
 ON PT.ComponentCodeId = CC.ComponentCodeID   
 INNER JOIN  
tblModifierCodes MC   
 ON PT.ModifierId = MC.ModifierID   
 INNER JOIN  
tblTaskTypes TT   
 ON PT.TaskTypeId = TT.TaskTypeID   
 INNER JOIN  
tblApplicationCodes AC   
 ON PT.ApplicationCodeId = AC.ApplicationCodeID   
 INNER JOIN  
tblEqpProjs EPR   
 ON PT.EqpProjId = EPR.EqpProjId   
 INNER JOIN  
tblEqpPlans EP   
 ON EPR.EqpPlanId = EP.EqpPlanId   
 INNER JOIN  
tblEquipment EQP   
 ON EP.EquipmentId=EQP.EquipmentId   
 INNER JOIN  
tblModels EQPM  
 ON EQP.ModelId=EQPM.ModelId  
 INNER JOIN  
tblManufacturers MA   
 ON PT.ManufacturerId = MA.ManufacturerId   
 INNER JOIN  
TASK_HEADER TH ON PT.Task_Header_Id = TH.Task_Header_Id 
	/*VV E602*/ 
	LEFT JOIN
COMPONENT_SERIALISED CSER
	ON PT.StartingSerialNoId=CSER.ComponentSerialisedId
	/*VV E316*/
	LEFT JOIN
PART_RATING PRA
	ON PT.PartRatingId=PRA.PartRatingId
 LEFT OUTER JOIN  
SCHEDULING_TASK ST   
 ON PT.SchedulingTaskId = ST.SchedulingTaskId   
 LEFT OUTER JOIN  
tblTaskTypes ITT   
 ON PT.InspectionTaskTypeId = ITT.TaskTypeID   
 LEFT OUTER JOIN  
tblQUOMs QUOM  
 ON PT.UsageQUOMId = QUOM.QUOMId   
 LEFT OUTER JOIN  
tblQUOMs QUOM_1  
 ON EPR.EndQUOMId = QUOM_1.QUOMId   
 LEFT OUTER JOIN  
PROJ_TASK_SCHEDULING_GROUP PTSG   
 ON PT.Scheduling_Group_Id = PTSG.Scheduling_Group_Id   
 LEFT OUTER JOIN  
OPERATIONAL_CRITICALITY OC   
 ON PT.Operational_Criticality_Id = OC.Operational_Criticality_Id   
 LEFT OUTER JOIN  
SCHEDULE_TYPE SCHT ON PT.Schedule_Type_Id = SCHT.Schedule_Type_Id   
 LEFT OUTER JOIN  
MAINTENANCE_STRATEGY MS   
 ON PT.Maintenance_Strategy_Id = MS.Maintenance_Strategy_Id  
 LEFT OUTER JOIN  
tblParts P ON PT.Part_Id = P.PartId   
 LEFT OUTER JOIN  
tblProjTasks RRPT  
 ON PT.ParentTaskId=RRPT.ProjTaskId  
 LEFT OUTER JOIN  
TASK_HEADER TH_1  
 ON RRPT.Task_Header_Id=TH_1.Task_Header_Id  
 LEFT OUTER JOIN  
ROTABLE_PART RP  
 ON PT.Rotable_Part_Id=RP.Rotable_Part_Id  
 LEFT OUTER JOIN  
/*VV 29-Jan-2009 ROTABLE_INUSE RIU*/  
(  
 ROTABLE_INUSE riu  
 INNER JOIN   
 ROTABLE_ITEM_LATEST_STATUS_V riul   
 ON riul.Rotable_Item_Id = riu.Rotable_Item_Id AND   
 riul.StartDate = riu.Start_Date  
)   
 ON PT.ProjTaskId=RIU.Proj_Task_Id  
 LEFT OUTER JOIN  
ROTABLE_ITEM RI  
 ON PT.Rotable_Part_Id=RI.Rotable_Part_Id AND RIU.Rotable_Item_Id=RI.Rotable_Item_Id  
 LEFT OUTER JOIN  
(SELECT ProjTaskOptId,ProjTaskAmtId,JobCodeId,Action_Required_Id,Rebuild_Location_Id FROM #z_PTA  
WHERE Rotable_Repair_Strategy=1) RRJ  
 ON PT.ProjTaskOptId=RRJ.ProjTaskOptId  
 LEFT OUTER JOIN  
tblSites S  
 ON RRJ.Rebuild_Location_Id=S.SiteId  
 LEFT OUTER JOIN  
ACTION_REQUIRED AR  
 ON RRJ.Action_Required_Id=AR.Action_Required_Id  
 LEFT OUTER JOIN  
tblJobCodes JC  
 ON RRJ.JobCodeId=JC.JobCodeId  
 LEFT OUTER JOIN  
#z_COST_ALLOCATIONS CA  
 ON RRJ.ProjTaskAmtId=CA.Proj_Task_Amt_Id  
 LEFT OUTER JOIN  
RCM_COMPONENT_STRUCTURE CS  
 ON PT.RCMComponentStructureId=CS.RCMComponentStructureId  
 LEFT OUTER JOIN  
tblModels M   
 ON CS.ModelId=M.ModelId  
 LEFT OUTER JOIN  
tblComponentCodes CC_1  
 ON CS.ComponentCodeId=CC_1.ComponentCodeId  
 LEFT OUTER JOIN  
tblModifierCodes MC_1  
 ON CS.ModifierCodeId=MC_1.ModifierId  
 LEFT OUTER JOIN  
tblTaskTypes TT_1  
 ON CS.TaskTypeId=TT_1.TaskTypeId  
 LEFT OUTER JOIN  
tblApplicationCodes AC_1  
 ON CS.ApplicationCodeId=AC_1.ApplicationCodeId  
 LEFT OUTER JOIN  
tblCostBearers CB   
 ON CB.CostBearerId=PTCost.Cost_Bearer_Id     
--AL: 29/02/08  
 LEFT OUTER JOIN  
REVIEW_STATUS RS   
 ON PT.ReviewStatusID = RS.ReviewStatusID   
 LEFT OUTER JOIN  
AMT_USER AU   
 ON PT.ReviewUserID = AU.AMT_User_ID  
 LEFT OUTER JOIN  
EMPLOYEE E   
 ON E.Employee_ID=PT.SalesResponsibilityID  
	/*VV E611*/  
	LEFT JOIN 
NEXT_OCC_STRATEGY N 
	ON PT.ProjTaskId=N.Proj_Task_Id
	LEFT JOIN
tblSites SNO
	ON N.PEXRebuildLocationId=SNO.SiteId
	LEFT JOIN
tblParts PNO
	ON N.PEXPartId=PNO.PartId
	LEFT JOIN
PART_CLASSIFICATION PTCLASS
	ON N.PEXPartTypeId=PTCLASS.PartClassificationId
	/*E789*/
	LEFT JOIN PART_CLASSIFICATION PCBASEDETAIL ON PCBASEDETAIL.PartClassificationId = PT.PartClassificationId
	LEFT JOIN tblSites DEFLOCRBLDSITE ON DEFLOCRBLDSITE.SiteId = PT.DefaultLocationForRebuild
 
SELECT   
ROUND(PTA.LaborHours,1) AS LaborHours, ROUND(PTA.Duration,1) AS Duration, PTA.Pricing_Date,   
ROUND(PTA.MiscCost,2) AS MiscCost,   
ROUND(PTA.PartsCost,2) AS PartsCost, ROUND(PTA.LaborCost,2) AS LaborCost, PTA.ProjTaskOptId, PTA.ProjTaskAmtId,   
ISNULL(PTA.JobCodeId,CA.Job_Code_Id) AS JobCodeId,  
ISNULL(PTA.Cost_Bearer_Id, CA.Cost_Bearer_Id) AS CostBearerId,  
ISNULL(PTA.Labour_Activity_Id,CA.Labour_Activity_Id) AS LabourActivityId,PTA.PricedJobId,   
ISNULL(PTA.Misc_Cost_Expense_ID,CA.Misc_Cost_Expense_Id) AS Misc_Cost_Expense_Id,  
ISNULL(PTA.Labour_Cost_Expense_ID, CA.Labour_Cost_Expense_Id) AS Labour_Cost_Expense_Id,  
ISNULL(PTA.Parts_Cost_Expense_ID,CA.Parts_Cost_Expense_Id) AS Parts_Cost_Expense_Id,  
PTA.LaborShare, PTA.CurrencyId,     
PTA.Crane_Cost, PTA.Pct_Freight, PTA.Avg_Daily_Work_Hrs, PTA.Avg_No_People, PTA.Avg_Travel_Hrs, PTA.Travel_Distance,   
PTA.Travel_Recovery_Rate_L, PTA.Misc_Trip_Cost, PTA.Labour_Hrs_Field,   
PTA.Travel_Recovery_Rate_V,   
PTA.Parts_EDC_ID, PTA.Labour_EDC_ID, PTA.Misc_EDC_ID,  
ISNULL(PTA.Cost_Centre_ID, CA.Cost_Centre_Id) AS CostCentreID,  
ISNULL(PTA.Work_Group_Id,CA.Work_Group_Id) AS Work_Group_Id,    
PTA.Health_Safety_Id,   
PTA.PerformedAtSiteId, PTA.Rotable_Repair_Strategy,   
PTA.Action_Required_Id, PTA.Rebuild_Location_Id,    
CA.Cost_Allocation_Id,   
  
CA.Cost_Allocation_Ref+':'+ACC.Code+':'+AMC.Code AS Cost_Allocation_Des,  
   
ISNULL(CA.Cost_Allocation_Id,0) AS Cost_Allocation_Ref,  
PTA.PartTypeId,PT.PartType + ' - ' + PT.PartTypeDesc AS Part_Type,  
ISNULL(JC.Code+' - '+JC.Description,CA.Job_Code) AS Job_Code,  
ISNULL(CB.CostBearer,CA.CostBearer) AS CostBearer,  
ISNULL(LA.ActivityCode+' - '+LA.LabourActivity,CA.LabourActivity) AS Labour_Activity,  
ISNULL(CEP.Cost_Expense_Code+' - '+CEP.Cost_Expense_Desc,CA.P_Cost_Expense ) AS Parts_Cost_Expense,  
ISNULL(CEL.Cost_Expense_Code+' - '+CEL.Cost_Expense_Desc, CA.L_Cost_Expense) AS Labour_Cost_Expense,  
ISNULL(CEM.Cost_Expense_Code+' - '+CEM.Cost_Expense_Desc, CA.M_Cost_Expense) AS Misc_Cost_Expense,  
C.CurrencyDesc AS Currency,ISNULL(CC.Cost_Centre_Code+' - '+CC.Cost_Centre_Desc,CA.Cost_Centre) AS CostCentre,  
ISNULL(WG.Description,CA.Work_Group) AS WorkGroup,HS.Health_Safety,  
EDCP.EDC_Id + ' - ' + EDCP.Journal_Description + ' : ' + EDCP.Debit_Account + '.' + EDCP.Debit_Account_Suffix AS Parts_EDC_Description,   
EDCL.EDC_Id + ' - ' + EDCL.Journal_Description + ' : ' + EDCL.Debit_Account + '.' + EDCL.Debit_Account_Suffix AS Labour_EDC_Description,   
EDCM.EDC_Id + ' - ' + EDCM.Journal_Description + ' : ' + EDCM.Debit_Account + '.' + EDCM.Debit_Account_Suffix AS Misc_EDC_Description,  
ROUND(PTA.QtyVolume,2) AS QtyVolume, ROUND(PTA.PercentTopUp,1) AS PercentTopUp, ROUND(PTA.UnitPrice,2) AS UnitPrice,  
PTA.Consumable,  
CASE WHEN ISNULL(PTA.JobCodeId,CASE WHEN CA.Job_Code<>'CA - Multiple' THEN ABS(CA.Job_Code_Id) ELSE -1 END)  
 IN(  
 SELECT WSJ.Job_Code_Id  
 FROM  
 WORK_SCOPE_JOB WSJ  
  INNER JOIN  
 #z_PROJ_TASK_SUMMARY PT   
  ON WSJ.Component_Code_Id=PT.ComponentCodeId AND WSJ.Task_Type_Id=PT.TaskTypeId   
  /*INNER JOIN  
 #z_PTA PTA  
  ON PT.ProjTaskOptId=PTA.ProjTaskOptId  
  LEFT OUTER JOIN  
 #z_COST_ALLOCATIONS CA  
  ON PTA.ProjTaskAmtId=CA.Proj_Task_Amt_Id*/  
 WHERE WSJ.Model_Id=@ModelId)  
THEN 1 ELSE 0 END AS LibraryLink,  
PTA.CostSourceId,CS.CostSource,C.Currency AS CurrencyCode,SJ.StdJob,  
PTA.System_Source_Id,  
'CA - '+ CASE PTA.System_Source_Id WHEN @SystemSourceAMT THEN 'Manual' ELSE SS.System_Source_Code END AS System_Source,  
CASE PTA.System_Source_Id WHEN @SystemSourceAMT THEN 1 ELSE 0 END AS CAManual  
  
FROM   
#z_PTA PTA  
 INNER JOIN   
tblCurrencies C  
 ON PTA.CurrencyId=C.CurrencyId   
 INNER JOIN  
dbo.COST_SOURCE_F() CS  
 ON PTA.CostSourceId=CS.CostSourceId  
 LEFT OUTER JOIN  
#z_COST_ALLOCATIONS CA  
 ON PTA.ProjTaskAmtId=CA.Proj_Task_Amt_Id  
 LEFT OUTER JOIN  
COST_ALLOCATION A  
 ON CA.Cost_Allocation_Id=A.Cost_Allocation_Id  
 LEFT OUTER JOIN  
tblComponentCodes ACC  
 ON A.Component_Code_Id=ACC.ComponentCodeId  
 LEFT OUTER JOIN  
tblModifierCodes AMC   
 ON A.ModifierId=AMC.ModifierId  
 LEFT OUTER JOIN  
tblPricedJobs PJ  
 ON PTA.PricedJobId=PJ.PricedJobId  
 LEFT OUTER JOIN  
tblStdJobs SJ  
 ON PJ.StdJobId=SJ.StdJobId  
 LEFT OUTER JOIN  
tblPartTypes PT  
 ON PTA.PartTypeId=PT.PartTypeId  
 LEFT OUTER JOIN   
tblJobCodes JC  
 ON JC.JobCodeId=PTA.JobCodeId  
 LEFT OUTER JOIN   
tblCostBearers CB  
 ON PTA.Cost_Bearer_Id=CB.CostBearerid  
 LEFT OUTER JOIN  
tblLabourActivities LA  
 ON PTA.Labour_Activity_Id=LA.LabourActivityId  
 LEFT OUTER JOIN  
COST_EXPENSE CEP  
 ON PTA.Parts_Cost_Expense_ID=CEP.Cost_Expense_Id  
 LEFT OUTER JOIN  
COST_EXPENSE CEL  
 ON PTA.Labour_Cost_Expense_ID=CEL.Cost_Expense_Id  
 LEFT OUTER JOIN  
COST_EXPENSE CEM  
 ON PTA.Misc_Cost_Expense_ID=CEM.Cost_Expense_Id  
 LEFT OUTER JOIN  
COST_CENTRE CC  
 ON PTA.Cost_Centre_Id=CC.Cost_Centre_Id  
 LEFT OUTER JOIN  
WORK_GROUP WG  
 ON PTA.Work_Group_Id=WG.Work_Group_Id  
 LEFT OUTER JOIN  
HEALTH_SAFETY HS  
 ON PTA.Health_Safety_Id=HS.Health_Safety_Id  
 LEFT OUTER JOIN  
ENTRY_DISTRIBUTION_CODE EDCM   
 ON PTA.Misc_EDC_ID = EDCM.Id   
 LEFT OUTER JOIN  
ENTRY_DISTRIBUTION_CODE EDCL   
 ON PTA.Labour_EDC_ID = EDCL.Id   
 LEFT OUTER JOIN  
ENTRY_DISTRIBUTION_CODE EDCP   
 ON PTA.Parts_EDC_ID = EDCP.Id  
 LEFT OUTER JOIN  
SYSTEM_SOURCE SS  
 ON PTA.System_Source_Id=SS.System_Source_Id  
ORDER BY C.Currency,ISNULL(JC.Code+' - '+JC.Description,CA.Job_Code)  
   
   
SELECT CostAllocationConfigurationId, WorkGroup, CostCentre, PartsCostExpense, LabourCostExpense, MiscCostExpense,   
CostBearer, LabourActivity, JobCode  
FROM COST_ALLOCATION_CONFIGURATION  
  
--VV 28-Apr-2009  
EXEC PROJ_TASK_DOCUMENTS_GET_P @ProjTaskId=@projTaskId  
  
DROP TABLE #z_COST_ALLOCATIONS,#z_PTA,#z_PROJ_TASK_SUMMARY,#z_PTCost  
    
 
--DS 2011-02-15
EXEC EWT_STRATEGY_TASK_LIST_GET_P @ProjTaskId = @projTaskId
      
  
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Update_Task]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Update_Task]
GO

create        Procedure [dbo].[usp_Update_Task]
/******************************************************************************
	File: usp_Update_Task.sql
	Name: usp_Update_Task

	Called By: - When save after ADD/EDIT tasks

	Desc: First checks that record is valid to update 
		Then updates, then calls re-calc plan which calls re-project

	Auth:Robbie Feyder
	Date: 07-JUNE-2002
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	13 Apr 12   SD			E789: PEX Fields for Strategy Task Editor	
	16 Apr 12	JW			3972 If no PlanningLeadTime Provide for planning task, take the default value
	16 Aug 11	V Vasylyeva	E611: PEX fields
	21 Jul 11	VV	E602: Serialised Component
	01 Apr 11   GW Add AutoGenerateWOS tag
	22-Feb-11	V Vasylyeva	E316: added tagid, partratingid
	28-Aug-10	K Nagarajan	#288: Allow zero counter
	 8-Jul-10	V Vasylyeva	CR8964: Took out the check for las mod date
	07-Jul-10   VS          CR9019: Added CBD Strategy Task
	22-Oct-09	AL			CR8414: Added StartingSerialNo
	 1-May-09	V Vasylyeva	CR8035: Library Documents
	30 Mar 09	AL			CR7965: Added new fields
	12 Jan 09	V Vasylyeva	CR7825 Repair Reserve task is not deleted if parent task performance strategy is set 
							to blank.
	16 Sep 08	AL			Removed @UsageUOMID
	12 Jun 08	AL			Changed Repair Description size
	18 Apr 08	VV			Moved code to unlink EQS tasks into TASK_UNLINK_FROM_STRATEGY_TASK_P
	15 Apr 08	VV			Moved code to update task history into UPDATE_STRATEGY_TASK_HISTORY_P
	 1 Apr 08	VV			Removed a temporary table for projtaskopts 
	20 Mar 08	AL			Removed ReviewStatus related parameters
    21 Feb 08	AL			Changed PlanDateLocked to ReviewStatusID
	19-Sep-2006	ID		Commented the inserting records into tblUnlinkedWO table 
	07 Apr 05	V Vasylyeva	Usage method is always "U" from Amt 7.2

	03 Dec 04	V Vasylyeva	Added transactions, last_mod_date in task update, Strategy_Repair_Description=''
    15 Apr 04	H Singh		Planning task fix (moved to tblProjtasks table)
    7 June 02		R Feyder		Fix issue with FromStdJob a smallint type rather than a bit.
	9 Jun 02		R Feyder		Fix relinking of workorders so that only links to new task created and 
							does relinking of unassigned task
	10 Jun 02		R Feyder		Change flage to ForceCalc (rather than don't calc)
	12 Jun 02		D Smith		Added code to remove Mnt Plan Ids from Task Opts when @fromStdJobs=false
	13 Jun 02		R Feyder		Recalc Costs when the Manufacturer has changed
	27 Jun 02		R Feyder		CR 475 Update Last Occ in Task if QUOM changed, 
							also relink workorders for the task if QUOM changed for a current Projection
							- NOTE relinking will update the last occurence!
	10 Feb 03		D Smith		Changed to set flags for new recalc routine
	10 Jun 03		H Singh		two new parameters added @LastChangeUsage, @LastChangeDate
   	18 Jul 03	HS			call to add Task Header id
   	10 Sep 03	HS			Rotable Item changes, Pricing Date Changes
   	28 Nov 03	HS			Rotable Repair Strategy field in Amounts table is updated
   	11 Dec 03	HS			Save for action required is corrected
   	04 May 04	HS			setting strategy details to null in TASK table
	28 Apr 05	SI			We set DirtyUsage=1 instead of executing usp_Update_RepProjCosts
	23 Sep 05	SI			Added @SchedulingTaskId
	13 Dec 05	SI			Added @ProjTaskId parameter for SCHEDULING_TASK_TO_PROJ_TASK_P 		
	10 Jul 06	V Vasylyeva	Added relinking to EQS tasks
	08 Sep 06	SI			Removed usp_Plan_Run_Calc_Task call
	11 Sep 06	V Vasylyeva		Changes in spec
	23 Oct 06	D Smith			Assume scheduling type 1 (last UOM) - temporary, so SP runs for detailed mode!!!
	23 Oct 06	D Smith?		TODO: when run in detailed mode, should not "overwrite" fields saved in simple mode?
	05 Jan 06	V Vasylyeva	Added @Message, @RaiseError
					Last_Mod_Date=GETDATE()
	27-Jun-07	K Nagarajan	Added InspectionTaskType, InspectionOffset
	06-Jul-07	K Nagarajan	Added Planning Parameter and Checked Where Scheduled Task is a Planned Task
	14-Jul-7	SI & KN		Strategy + Scheduling Task Reset for non planning tasks.
	15 Jul 07	KN	Added ExternalIdentifier
	13 Dec 07	VV	Added @PerformanceStrategyReason,@RCMComponentStructureId, @ParentTaskId,@AutomaticUpdate
	18 Jan 08	VV	Modified External identifier
	16 Sep 08	KN	Set Next Occ = NULL If not a Planning Task.
*******************************************************************************/
	/* Param List */
	@projTaskId int,
	@componentCodeId int,
	@modifierId int,
	@taskTypeId int,
	@applicationCodeId int,
	@manufacturerId int,
	@usageMethod char(1),
	@usageQUOMId int,
	--@usageUOMId int,	AL: 16/09/08
	@FinalOcc float, 
	@pricingDate datetime,  -- TO REMOVE
	@fromStdJobs smallint=0,  -- TO REMOVE
	@RunPlanning bit = 0,
	@RecalcCosts bit = 0,
	@ForceCalc bit = 0,
	@LastChangeUsage float, 
	@LastChangeDate datetime,
	@RotablePartId int, 
	@GroupNumber varchar(50), 
	@PartId int,
	@PlanningTask bit,
	@PlanningLeadTime int,
	@SchedulingTaskId int=NULL,	
	@FinalDate datetime=NULL, 	
	@Schedule_Type_Id int=1, --DS: assume scheduling type 1? (last UOM)?
	@Scheduling_Group_Id int=NULL, 
	@Scheduling_Group_Counter int=NULL, 
    @Operational_Criticality_Id int=NULL, 
	@Warranty_Period_Usage float=0, 
	@Warranty_Period_Days int=0, 
	@Maintenance_Strategy_Id int=NULL, 
	@Changeout_Guidelines varchar(1000)=NULL, 
	@Task_Description varchar(100)=NULL, 
    @Show_Strategy bit=0,	
	@LastModDate varchar(25)=NULL,
	@Next_Occ_Strategy_Id int=NULL,
	@Repair_Description varchar(MAX)=NULL,	--AL: 12/06/08
	@Message varchar(8000)='' OUTPUT,
	@RaiseError bit=1,
	@InspectionTaskTypeId int = NULL,
	@InspectionOffset float = NULL,
	@ExternalIdentifier varchar(50) = NULL,
	@PerformanceStrategyReason varchar(200)=NULL,
	@RCMComponentStructureId int =NULL, 
	@ParentTaskId int =NULL, 
	@AutomaticUpdate bit =NULL,
	--AL: 21/02/08
--	@ReviewStatusID int=1,
--	@ReviewUserID int=NULL,
--	@ReviewDate datetime=NULL,
	--VV: 6 Mar 08
	@UpdateHistory bit=0,
	--AL: 30/03/09
	@PctPurchasePart float = 100,
	@PctPurchaseLabour float = 100,
	@PctPurchaseMisc float = 100,
	@PctPurchaseNewPart float = 100,
	@SalesResponsibilityID int = NULL,
	@libDocXML text='',
	/*VV E602*/
	@StartingSerialNo int, 
	@CBDTask bit = 0,  -- CR9019 VS
	/*E316*/
	@TagId varchar(50)=NULL,
	@PartRatingId int=NULL,
	@AutoGenerateWOS bit=0,/*GW*/
	/*E611*/
	@PEXRebuildLocationId int=NULL,
	@PEXPartId int=NULL,
	@NextDuePartClassificationId int=NULL, /*E789*/
	@UpdateNextOccFields bit=0,
	/*E789*/ 
	@PartClassificationId int = NULL, 
	@DefaultLocationForRebuild int = NULL
AS

DECLARE @EqpProjID int
DECLARE @OldComponentCodeId int
DECLARE @OldModifierId int
DECLARE @OldTaskTypeId int
DECLARE @OldApplicationCodeId int
DECLARE @OldRotablePartId int
DECLARE @OldMaintenanceStrategyId int


DECLARE @UnassignedTask int
DECLARE @EqpPlanId int	
DECLARE @ProjTypeCurr int
DECLARE @ProjTypeAlt int
DECLARE @Task_Header_Id as int
DECLARE @return_status int 
DECLARE @OldSchedule_Type_Id int
DECLARE @UseSchedulingSystemLastOcc bit
DECLARE @SchT_LastPerformedUOM int
DECLARE @SchT_LastScheduledUOM int
DECLARE @SchT_LastPerformedDate int
DECLARE @SchT_LastScheduledDate int
DECLARE @Projection_Type_Id int
DECLARE @SQL1 varchar(4000)
DECLARE @SQL2 varchar(4000)
DECLARE @Where varchar(4000)
DECLARE @OldLast_Change_Usage float
DECLARE @OldLast_Change_Date datetime
DECLARE @PerfStratOnCondition int
DECLARE @RRTaskId int
DECLARE @ProjTaskUpdate varchar(50)

DECLARE @ProjTaskOptId int


SET @SchT_LastPerformedUOM=1
SET @SchT_LastScheduledUOM=2
SET @SchT_LastPerformedDate=3
SET @SchT_LastScheduledDate=4

SET @PerfStratOnCondition=1

SET @Message=''

IF ISNULL(@RotablePartId,0)>0
	SET @StartingSerialNo=NULL

/*VV CR8964
--Check that the task has not been chenged by the other user

IF (@LastModDate Is Not Null)
BEGIN
	EXEC @return_status = PROJ_TASK_CHECK_P @ProjTaskId=@ProjTaskId,	
						@LastModDate=@LastModDate,    
						@Message=@Message OUTPUT
	
	IF @return_status<>1 
	BEGIN	
		IF @RaiseError=1 RAISERROR (@Message, 16, 1)
		RETURN	
	END	
END

*/
	
SET @ProjTypeCurr=1
SET @ProjTypeAlt=3

IF @RotablePartId = 0 SET @RotablePartId = null
IF @GroupNumber = '' SET @GroupNumber = null
IF @PartId = 0 SET @PartId = null
SET @SchedulingTaskId =NULLIF(@SchedulingTaskId,0)	
SET @Scheduling_Group_Id =NULLIF(@Scheduling_Group_Id,0)
SET @Scheduling_Group_Counter=NULLIF(@Scheduling_Group_Counter,-1)
SET @Operational_Criticality_Id=NULLIF(@Operational_Criticality_Id,0)
SET @Warranty_Period_Usage=ISNULL(@Warranty_Period_Usage,0)
SET @Warranty_Period_Days=ISNULL(@Warranty_Period_Days,0)
SET @Maintenance_Strategy_Id=NULLIF(@Maintenance_Strategy_Id,0)
SET @Changeout_Guidelines=NULLIF(@Changeout_Guidelines,'')
SET @Task_Description=NULLIF(@Task_Description,'')
SET @UsageQUOMId=NULLIF(@UsageQUOMId,0)
SET @InspectionTaskTypeId=NULLIF(@InspectionTaskTypeId,0)
SET @InspectionOffset=ISNULL(@InspectionOffset,0)
SET @PerformanceStrategyReason=NULLIF(@PerformanceStrategyReason,'')
SET @RCMComponentStructureId=NULLIF(@RCMComponentStructureId,0)
SET @ParentTaskId=NULLIF(@ParentTaskId,0) 
SET @AutomaticUpdate=ISNULL(@AutomaticUpdate,0)
SET @SalesResponsibilityID=NULLIF(@SalesResponsibilityID,0)

--VV 12-Jan-2009
IF ISNULL(@Maintenance_Strategy_Id,0)<>@PerfStratOnCondition SET @RCMComponentStructureId=NULL

IF @PlanningTask = 1 AND @PlanningLeadTime = 0
	SELECT @PlanningLeadTime = Varchar_Value FROM AMT_TYPED_VARIABLE WHERE Value_Name = 'PlanningDaysDefault'
ELSE IF @PlanningTask = 0
	SET @PlanningLeadTime = 0

-- Get OLD Codes
SELECT  @EqpProjID = PT.EqpProjID,
	@Projection_Type_Id=EPR.Projection_Type_Id,
	@EqpPlanId=PT.EqpPlanId,
	@OldComponentCodeId =  PT.ComponentCodeId, 
	@OldModifierId = PT.ModifierId, 
	@OldTaskTypeId =PT.TaskTypeId,
	@OldApplicationCodeId = PT.ApplicationCodeId,
	@OldRotablePartId=PT.Rotable_Part_Id,
	@OldMaintenanceStrategyId=PT.Maintenance_Strategy_Id
	
FROM  tblProjTasks PT INNER JOIN
	tblEqpProjs EPR ON PT.EqpProjId=EPR.EqpProjId 	
WHERE ProjTaskId = @projTaskID

EXEC PROJ_TASK_BUSINESS_RULES_P @EqpProjId =@EqpProjId,
				@ComponentCodeId =@ComponentCodeId,
				@ModifierId =@ModifierId,
				@TaskTypeId =@TaskTypeId,
				@ApplicationCodeId =@ApplicationCodeId,	
				@Message =@Message OUTPUT,
				@Schedule_Type_Id =@Schedule_Type_Id OUTPUT, 
				@Scheduling_Group_Id =@Scheduling_Group_Id  OUTPUT, 
				@Scheduling_Group_Counter =@Scheduling_Group_Counter  OUTPUT, 
				@usageQUOMId =@usageQUOMId,
				@ProjTaskId =@ProjTaskId,
				@LastChangeDate=@LastChangeDate  OUTPUT,
				@LastChangeUsage =@LastChangeUsage OUTPUT,
				@UsageMethod =@UsageMethod OUTPUT,
				@FinalDate=@FinalDate ,
				@FinalOcc =@FinalOcc OUTPUT,
				@InspectionTaskTypeId = @InspectionTaskTypeId OUTPUT,
				@InspectionOffset = @Inspectionoffset OUTPUT,
				@PlanningTask = @PlanningTask,
				@ParentTaskId=@ParentTaskId,
				@SchedulingTaskId=@SchedulingTaskId OUTPUT,
				@ExternalIdentifier=@ExternalIdentifier OUTPUT


IF @Message<>''
BEGIN
	IF @RaiseError=1 RAISERROR (@Message, 16, 1)
	RETURN
END

SELECT @UseSchedulingSystemLastOcc=UseSchedulingSystemLastOcc FROM AMT_VARIABLE


EXEC TASK_HEADER_MANAGER_P   @componentCodeId,  @modifierId,  @taskTypeId,  @applicationCodeId, @Task_Header_Id output


SET XACT_ABORT ON

BEGIN TRANSACTION

UPDATE tblProjTasks SET 

PlanTaskOptId =CASE @PlanningTask WHEN 0 THEN NULL ELSE PlanTaskOptId END,
PlanStatus = CASE @PlanningTask WHEN 0 THEN 0 ELSE PlanStatus END, 
--PlanDateLocked=CASE @PlanningTask WHEN 0 THEN 0 ELSE PlanDateLocked END, AL: 21/02/08
PlanUseCalc=CASE @PlanningTask WHEN 0 THEN 1 ELSE PlanUseCalc END,
ComponentCodeId = @componentCodeId, 
ModifierId =@modifierId,
TaskTypeId = @taskTypeId, 
applicationCodeId =@applicationCodeId, 
ManufacturerId =@manufacturerId, 
UsageMethod = @usageMethod,
UsageQUOMId = @usageQUOMId, 
Final = @finalOcc, 
AddNotComplete = 0, 
Last_Change_Usage = @LastChangeUsage, 
Last_Change_Date = @LastChangeDate, 
Task_Header_Id = @Task_Header_Id,
Rotable_Part_Id = @RotablePartId,
Group_Number = @GroupNumber,
Part_Id = @PartId,
Planning_Task = @PlanningTask, 
Planning_Lead_Time = @PlanningLeadTime,	
SchedulingTaskId=@SchedulingTaskId,
Schedule_Type_Id=@Schedule_Type_Id, 
Scheduling_Group_Id=@Scheduling_Group_Id,
Scheduling_Group_Counter=@Scheduling_Group_Counter, 
Operational_Criticality_Id=@Operational_Criticality_Id, 
Warranty_Period_Usage=@Warranty_Period_Usage, 
Warranty_Period_Days=@Warranty_Period_Days, 
Maintenance_Strategy_Id=@Maintenance_Strategy_Id, 
Changeout_Guidelines=@Changeout_Guidelines, 
Task_Description=@Task_Description, 
InspectionTaskTypeId=@InspectionTaskTypeId, 
InspectionOffset=@InspectionOffset, 
ExternalIdentifier= @ExternalIdentifier,
PerformanceStrategyReason=@PerformanceStrategyReason,
RCMComponentStructureId= @RCMComponentStructureId,
ParentTaskId= @ParentTaskId,
AutomaticUpdate=@AutomaticUpdate, 
LastOcc=CASE WHEN @OldSchedule_Type_Id=@Schedule_Type_Id THEN LastOcc
		ELSE
			CASE WHEN @UseSchedulingSystemLastOcc = 1 AND @SchedulingTaskId > 0 THEN
				CASE WHEN @Schedule_Type_Id IN (@SchT_LastPerformedUOM,@SchT_LastPerformedDate) THEN Ext_Last_Occ ELSE Ext_Last_Sched_Occ END
			ELSE
				CASE WHEN @Schedule_Type_Id IN (@SchT_LastPerformedUOM,@SchT_LastPerformedDate) THEN AMT_WO_Last_Occ ELSE AMT_Last_Sched_Occ END	
			END
		END,

LastOccDate=CASE WHEN @OldSchedule_Type_Id=@Schedule_Type_Id THEN LastOccDate
			ELSE
				CASE WHEN @UseSchedulingSystemLastOcc = 1 AND @SchedulingTaskId > 0 THEN
					CASE WHEN @Schedule_Type_Id IN (@SchT_LastPerformedUOM,@SchT_LastPerformedDate) THEN Ext_Last_Occ_Date ELSE Ext_Last_Sched_Date END
				ELSE
					CASE WHEN @Schedule_Type_Id IN (@SchT_LastPerformedUOM,@SchT_LastPerformedDate) THEN AMT_WO_Last_Occ_Date ELSE AMT_Last_Sched_Date END
				END
			END,

Last_Mod_Date= GETDATE(),
ReviewStatusID=CASE @PlanningTask WHEN 0 THEN 1 ELSE ReviewStatusID END,
ReviewUserID=CASE @PlanningTask WHEN 0 THEN NULL ELSE ReviewUserID END,
ReviewDate=CASE @PlanningTask WHEN 0 THEN NULL ELSE ReviewDate END,
NextOcc = CASE @PlanningTask WHEN 0 THEN NULL ELSE NextOcc END,
NextOccDate = CASE @PlanningTask WHEN 0 THEN NULL ELSE NextOccDate END,
PctPurchasePart=ISNULL(@PctPurchasePart,100),
PctPurchaseLabour=ISNULL(@PctPurchaseLabour,100),
PctPurchaseMisc=ISNULL(@PctPurchaseMisc,100),
PctPurchaseNewPart=ISNULL(@PctPurchaseNewPart,100),
SalesResponsibilityID=@SalesResponsibilityID,
/*VV E602*/
StartingSerialNoId=NULLIF(@StartingSerialNo,0),
CBDTask = @CBDTask, -- CR9019 VS
/*VV E316*/
TagId=NULLIF(@TagId,''),
PartRatingId=NULLIF(@PartRatingId,0),
AutoGenerateWOS = @AutoGenerateWOS/*GW*/,
/*E789*/ 
PartClassificationId = NULLIF(@PartClassificationId, 0), 
DefaultLocationForRebuild = NULLIF(@DefaultLocationForRebuild, 0) 
WHERE ProjTaskId=@ProjTaskId



IF DATALENGTH(@libDocXML)>0
BEGIN
	EXEC PROJ_TASK_DOCUMENTS_UPDATE_P @ProjTaskId=@ProjTaskId,@libDocXML=@libDocXML,@Message=@Message OUTPUT

	IF @Message<>''
	BEGIN
		IF @RaiseError=1 RAISERROR (@Message, 16, 1)
		RETURN
	END
END

IF @OldRotablePartId>0 AND @RotablePartId is null
	BEGIN
		
		UPDATE pta
		SET pta.Rotable_Repair_Strategy = 0, 
			pta.Action_Required_Id = null, 
			pta.Rebuild_Location_Id = null
		FROM tblProjTaskOpts pto INNER JOIN
		     tblProjTaskAmts pta ON pto.ProjTaskOptId = pta.ProjTaskOptId
		WHERE
			pto.ProjTaskId = @projTaskId
		
	END 


--HS 28 Nov 2003 update Rotable_repair_strategy for max cost
-- VV 13 Feb 2008 Moved the code into UPDATE_ROTABLE_JOB_P
IF @RotablePartId>0
BEGIN
	EXEC UPDATE_ROTABLE_JOB_P @projTaskId=@projTaskId,@Message=@Message OUTPUT
END

--Delete Repair Reserve task
--VV 12-Jan-2009 
IF (ISNULL(@OldMaintenanceStrategyId,0)<>ISNULL(@Maintenance_Strategy_Id,0) AND 
ISNULL(@OldMaintenanceStrategyId,0)=@PerfStratOnCondition) OR
	(ISNULL(@Maintenance_Strategy_Id,0)=@PerfStratOnCondition AND ISNULL(@RCMComponentStructureId,0)=0)
BEGIN
	SELECT @RRTaskId=ProjTaskId FROM tblProjTasks WHERE ParentTaskId=@ProjTaskId
	
	IF ISNULL(@RRTaskId,0)>0
	BEGIN
		EXEC usp_Delete_Proj_Task @projTaskID =@RRTaskId,
				@forceDelete =0,
				@eqpProjId =null,
				@multiDelete =0,
				@Message =@Message OUTPUT,
				@RaiseError =@RaiseError,
				@DeleteLinkedCostAllocation = 1

		IF @Message<>'' RETURN
	END
END

--EQS tasks


if (@OldComponentCodeId <> @componentCodeId
    OR @OldModifierId <> @modifierId
    OR @OldTaskTypeId <> @taskTypeId
    OR @OldApplicationCodeId <> @applicationCodeId) AND (@Projection_Type_Id=@projTypeCurr)
BEGIN

	SET @ProjTaskUpdate=CAST(@ProjTaskId AS varchar)

	IF @UpdateHistory=1
	BEGIN
		
		SET @ProjTaskUpdate=CAST(@ProjTaskId AS varchar)

		EXEC UPDATE_STRATEGY_TASK_HISTORY_P @projTaskId=@ProjTaskUpdate

	END
	ELSE
	BEGIN
		/*Unlink EQS tasks*/

		EXEC TASK_UNLINK_FROM_STRATEGY_TASK_P @ProjTaskId=@ProjTaskUpdate

		/*SELECT @ProjTaskOptId=ProjTaskOptId FROM tblProjTaskOpts WHERE ProjTaskId = @ProjTaskId

		--Check that the proj task is for the current projection
		UPDATE
			TASK
		SET 	Planned_Proj_Task_Opt_ID = NULL,
			Strategy_Proj_Task_Opt_ID = NULL, 
			Strategy_Locked = 0,
			Strategy_QUOM_ID = NULL,
			Strategy_Usage = NULL, 
			Strategy_Date = NULL,
			Strategy_Repair_Description='',
			Last_Mod_Date=GetDate()
		WHERE 
			Strategy_Proj_Task_Opt_ID =@ProjTaskOptId
		OR	Planned_Proj_Task_Opt_ID =@ProjTaskOptId
		*/
		
	END
	

	--Relink EQS tasks
	IF EXISTS(SELECT Task_Id FROM TASK WHERE Eqp_Plan_Id=@EqpPlanId AND Task_Header_Id=@Task_Header_Id AND Strategy_Proj_Task_Opt_ID IS NULL)
	BEGIN
		EXEC STRATEGY_TASK_LINK_TO_EQS_TASK_P @ProjTaskId=@projTaskId
	END
	
END

/*VV E611*/
IF @PlanningTask=1 AND @UpdateNextOccFields=1
BEGIN
	IF ISNULL(@Next_Occ_Strategy_Id,0)=0 EXEC NEXT_OCC_STRATEGY_DEFAULT_ADD_P @ProjTaskId=@ProjTaskId  

	UPDATE NEXT_OCC_STRATEGY SET 
	Repair_Description=@Repair_Description,
	PEXRebuildLocationId=NULLIF(@PEXRebuildLocationId,0),
	PEXPartId=NULLIF(@PEXPartId,0),
	PEXPartTypeId=NULLIF(@NextDuePartClassificationId,0) /*E789*/
	WHERE Proj_Task_Id=@projTaskId
	
END

-- update the values from the linked SCHEDULING_TASK
EXEC SCHEDULING_TASK_TO_PROJ_TASK_P @ProjTaskId=@projTaskId



COMMIT TRANSACTION

RETURN

GO


if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[SITE_DELETE_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[SITE_DELETE_P]
GO




CREATE       PROCEDURE SITE_DELETE_P
/******************************************************************************
	File: 
	Name: SITE_DELETE_P

	Called By: 

	Desc: Delete Site. 
	Site cannot be deleted if there are data in the tables:
		TblFleets
		
		Set tblProjTaskAmts. PerformedAtSiteId=Null

	      
             

	Auth: V Vasylyeva
	Date: 18-Mar-2003
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:			Description:
	--------	--------		----------------------------------------
	16-Apr-2012 SD              E789 - PEX Site references: tblProjTasks.DefaultLocationForRebuild and NEXT_OCC_STRATEGY.PEXRebuildLocationId
	18-Feb-2003	M Lam			Delete ROTABLE_SAFETY_STOCK where deleting Site
	10-Apr-2003	V Vasylyeva		Delete from USER_LEVEL_PERMISSION
	24-Jun-2005	D Smith			Modified deletion of level permissions
	13-Dec-2006	K Nagarajan		Added further Checks & Deletion
	06-Feb-2007	A Lassauniere	Added Checks for work groups and employees
*******************************************************************************/
	
	@SiteID int,
 	@Error_Number int = 0 OUTPUT,
    	@Message varchar(2000)=Null OUTPUT
AS
DECLARE @ERR_SAVE int
DECLARE @Site varchar(50)
DECLARE @User_Access_Level_Site int

SET @ERR_SAVE=12 -- Comes from EQS32.modConstants
SET @User_Access_Level_Site=2

--Get the Site name
SELECT @Site=Site FROM tblSites WHERE SiteID=@SiteID

--Check if the site has equipment fleets
IF EXISTS (SELECT * FROM tblFleets WHERE SiteId=@SiteID)
	BEGIN
		SET @Error_Number=@ERR_SAVE
		SET @Message='Site ' + @Site +
			' cannot be deleted. It has Fleets linked to it.'
		RETURN
	END

--CHECK ROTABLE_BACKLOG
IF EXISTS (SELECT TOP 1 * FROM ROTABLE_BACKLOG WHERE Site_Id=@SiteID)
	BEGIN
		SET @Error_Number=@ERR_SAVE
		SET @Message='Site ' + @Site +
			' cannot be deleted. It has Rotable Backlog linked to it.'
		RETURN
	END

--CHECK ROTABLE_INVENTORY
IF EXISTS (SELECT TOP 1 * FROM ROTABLE_INVENTORY WHERE Site_Id=@SiteID)
	BEGIN
		SET @Error_Number=@ERR_SAVE
		SET @Message='Site ' + @Site +
			' cannot be deleted. It has Rotable Inventory linked to it.'
		RETURN
	END

--CHECK ROTABLE_LEFT_PROGRAM
IF EXISTS (SELECT TOP 1 * FROM ROTABLE_LEFT_PROGRAM WHERE Site_Id=@SiteID)
	BEGIN
		SET @Error_Number=@ERR_SAVE
		SET @Message='Site ' + @Site +
			' cannot be deleted. It has Rotable Left Program linked to it.'
		RETURN
	END

--CHECK ROTABLE_ONORDER
IF EXISTS (SELECT TOP 1 * FROM ROTABLE_ONORDER WHERE Destination_Site_Id=@SiteID)
	BEGIN
		SET @Error_Number=@ERR_SAVE
		SET @Message='Site ' + @Site +
			' cannot be deleted. It has Rotable on order linked to it.'
		RETURN
	END
--CHECK  ROTABLE_REBUILD
IF EXISTS (SELECT TOP 1 * FROM ROTABLE_REBUILD WHERE Site_Id=@SiteID)
	BEGIN
		SET @Error_Number=@ERR_SAVE
		SET @Message='Site ' + @Site +
			' cannot be deleted. It has Rotable Rebuild linked to it.'
		RETURN
	END

--CHECK  ROTABLE_REMOVE
IF EXISTS (SELECT TOP 1 * FROM ROTABLE_REMOVE WHERE Rebuild_Location_Id=@SiteID)
	BEGIN
		SET @Error_Number=@ERR_SAVE
		SET @Message='Site ' + @Site +
			' cannot be deleted. It has Rotable Remove linked to it.'
		RETURN
	END

--CHECK  ROTABLE_TRANSIT
IF EXISTS (SELECT TOP 1 * FROM ROTABLE_TRANSIT WHERE Destination_Site_Id=@SiteID)
	BEGIN
		SET @Error_Number=@ERR_SAVE
		SET @Message='Site ' + @Site +
			' cannot be deleted. It has Rotable Transit linked to it.'
		RETURN
	END

--CHECK  SAFETY_COMMENT
IF EXISTS (SELECT TOP 1 * FROM SAFETY_COMMENT WHERE Site_Id=@SiteID)
	BEGIN
		SET @Error_Number=@ERR_SAVE
		SET @Message='Site ' + @Site +
			' cannot be deleted. It has Safety Comment linked to it.'
		RETURN
	END

--CHECK  WORK_GROUP
IF EXISTS (SELECT TOP 1 * FROM WORK_GROUP WHERE Site_Id=@SiteID)
	BEGIN
		SET @Error_Number=@ERR_SAVE
		SET @Message='Site ' + @Site +
			' cannot be deleted. It has work groups linked to it.'
		RETURN
	END

--CHECK  EMPLOYEE
IF EXISTS (SELECT TOP 1 * FROM EMPLOYEE WHERE Site_Id=@SiteID)
	BEGIN
		SET @Error_Number=@ERR_SAVE
		SET @Message='Site ' + @Site +
			' cannot be deleted. It has employees linked to it.'
		RETURN
	END

BEGIN TRANSACTION

--Delete the data from the dependent tables

--WORK_LOCATION
DELETE FROM WORK_LOCATION WHERE Site_Id=@SiteID
IF @@ERROR<>0
	BEGIN
		SET @Error_Number=@ERR_SAVE
		SET @Message='Site ' + @Site +
			'. Error in WORK_LOCATION delete.'
		ROLLBACK TRANSACTION
		RETURN
	END

--WORK_GROUP
DELETE FROM WORK_GROUP WHERE Site_Id=@SiteID
IF @@ERROR<>0
	BEGIN
		SET @Error_Number=@ERR_SAVE
		SET @Message='Site ' + @Site +
			'. Error in WORK_GROUP delete.'
		ROLLBACK TRANSACTION
		RETURN
	END

--EMPLOYEE
DELETE FROM EMPLOYEE WHERE Site_Id=@SiteID
IF @@ERROR<>0
	BEGIN
		SET @Error_Number=@ERR_SAVE
		SET @Message='Site ' + @Site +
			'. Error in EMPLOYEE delete.'
		ROLLBACK TRANSACTION
		RETURN
	END
--TblProjTaskAmts
UPDATE tblProjTaskAmts SET PerformedAtSiteId=NULL WHERE PerformedAtSiteId=@SiteID
IF @@ERROR<>0
	BEGIN
		SET @Error_Number=@ERR_SAVE
		SET @Message='Site ' + @Site +
			'. Error in tblProjTaskAmts update.'
		ROLLBACK TRANSACTION
		RETURN
	END
--TblProjTaskAmts
UPDATE PTA
SET PTA.Rebuild_Location_Id =F.SiteId
FROM         tblProjTaskAmts PTA INNER JOIN
                      tblProjTaskOpts PTO ON PTA.ProjTaskOptId = PTO.ProjTaskOptId INNER JOIN
                      tblProjTasks PT ON PTO.ProjTaskId = PT.ProjTaskId INNER JOIN
                      tblEqpPlans E ON PT.EqpPlanId = E.EqpPlanId INNER JOIN
                      tblFleets F ON E.FleetId = F.FleetId
WHERE PTA.Rebuild_Location_Id = @SiteID


-- UPDATE NEXT_OCC_STRATEGY TABLE - Rebuild Location Id
UPDATE NOS SET
NOS.Site_Id = F.SiteId 
FROM         NEXT_OCC_STRATEGY NOS INNER JOIN
                      tblProjTasks PT ON NOS.Proj_Task_Id = PT.ProjTaskId INNER JOIN
                      tblEqpPlans S ON PT.EqpPlanId = S.EqpPlanId INNER JOIN
                      tblFleets F ON S.FleetId = F.FleetId
WHERE NOS.Site_Id = @SiteID 
IF @@ERROR<>0
	BEGIN
		SET @Error_Number=@ERR_SAVE
		SET @Message='Site ' + @Site +
			'. Error in Next Occ Strategy update.'
		ROLLBACK TRANSACTION
		RETURN
	END

-- UPDATE NEXT_OCC_STRATEGY TABLE - Rebuild Location Id
UPDATE NOS SET
NOS.Rebuild_Location_Id = F.SiteId 
FROM         NEXT_OCC_STRATEGY NOS INNER JOIN
                      tblProjTasks PT ON NOS.Proj_Task_Id = PT.ProjTaskId INNER JOIN
                      tblEqpPlans S ON PT.EqpPlanId = S.EqpPlanId INNER JOIN
                      tblFleets F ON S.FleetId = F.FleetId
WHERE NOS.Rebuild_Location_Id = @SiteID

IF @@ERROR<>0
	BEGIN
		SET @Error_Number=@ERR_SAVE
		SET @Message='Site ' + @Site +
			'. Error in Next Occ Strategy update.'
		ROLLBACK TRANSACTION
		RETURN
	END
	
/*E789*/
UPDATE NEXT_OCC_STRATEGY 
SET PEXRebuildLocationId = NULL
WHERE PEXRebuildLocationId = @SiteID

IF @@ERROR<>0
	BEGIN
		SET @Error_Number=@ERR_SAVE
		SET @Message='Site ' + @Site +
			'. Error in Next Occ Strategy PEX Rebuild Location update.'
		ROLLBACK TRANSACTION
		RETURN
	END
	
/*E789*/
UPDATE tblProjTasks 
SET DefaultLocationForRebuild = NULL
WHERE DefaultLocationForRebuild = @SiteID

IF @@ERROR<>0
	BEGIN
		SET @Error_Number=@ERR_SAVE
		SET @Message='Site ' + @Site +
			'. Error in Projected Tasks Default Location For Rebuild update.'
		ROLLBACK TRANSACTION
		RETURN
	END

--DELETE REP_GROUP 
DELETE FROM REP_GROUP WHERE Site_Id=@SiteID
IF @@ERROR<>0
	BEGIN
		SET @Error_Number=@ERR_SAVE
		SET @Message='Site ' + @Site +
			'. Error in REP_GROUP delete.'
		ROLLBACK TRANSACTION
		RETURN
	END
--DELETE REP_GROUP 
DELETE FROM INCIDENT WHERE Site_Id=@SiteID
IF @@ERROR<>0
	BEGIN
		SET @Error_Number=@ERR_SAVE
		SET @Message='Site ' + @Site +
			'. Error in INCIDENT delete.'
		ROLLBACK TRANSACTION
		RETURN
	END

--Delete the user permissions for the Site
DELETE FROM USER_LEVEL_PERMISSION
WHERE
	AMT_Object_ID=@SiteID
AND
	User_Access_Level_ID=@User_Access_Level_Site

IF @@ERROR<>0
	BEGIN
		--There are equipment plans for this fleet
		SET @Error_Number=@ERR_SAVE
		SET @Message='Site ' + @Site +
			'. Error in USER_LEVEL_PERMISSION delete.'
		ROLLBACK TRANSACTION
		RETURN
	END

--ROTABLE_SAFETY_STOCK
DELETE FROM ROTABLE_SAFETY_STOCK WHERE Site_Id=@SiteID
IF @@ERROR<>0
	BEGIN
		SET @Error_Number=@ERR_SAVE
		SET @Message='Site ' + @Site +
			'. Error in ROTABLE_SAFETY_STOCK delete.'
		ROLLBACK TRANSACTION
		RETURN
	END

--Delete the site
DELETE FROM tblSites WHERE SiteID=@SiteID
IF @@ERROR<>0
	BEGIN
		SET @Error_Number=@ERR_SAVE
		SET @Message='Site ' + @Site +
			'. Error in tblSites delete.'
		ROLLBACK TRANSACTION
		RETURN
	END
COMMIT TRANSACTION

GO

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[COMPONENT_CHANGEOUT_GRID_GET_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[COMPONENT_CHANGEOUT_GRID_GET_P]
GO

create  Procedure [dbo].[COMPONENT_CHANGEOUT_GRID_GET_P]
/******************************************************************************
	File: 
	Name: COMPONENT_CHANGEOUT_GRID_GET_P


	Desc: Selects data for component changeout grid
	      
             

	Auth: Veronika Vasylyeva
	Date: 19 Sep 2011
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	17-APR-12   SD          E798 - tblProjTasks.PEXPartTypeId and TASK.RebuildPartTypeId now FKs to PART_CLASSIFICATION
    22-Nov-11	V Vasylyeva	#2870 added customer contacted by, customer contacted date,
							customer contacted comments
*******************************************************************************/
	
@BranchID varchar(MAX)='',
@SiteID varchar(MAX)='',
@FleetID varchar(MAX)='',
@ModelID varchar(MAX)='',
@EqpPlanID varchar(MAX)='',
@RegionID varchar(MAX)='',
@DivisionID varchar(MAX)='',
@EqpLocationID varchar(MAX)='',
@EqpCategoryID varchar(MAX)='',
@EqpCostCentreID varchar(MAX)='',
@CostResponsibilityID varchar(MAX)='',
@ParentEqpPlanID varchar(MAX)='',
@ComponentCodeID varchar(MAX)='',
@TaskTypeID varchar(MAX)='',
@WorkGroupID varchar(MAX)='',
@CompCondRatingID varchar(MAX)='',
@CompCondReviewStatusID varchar(MAX)='',
@SalesResponsibilityId varchar(max)='',
@RebuildLocationId varchar(max)='',
@CustomerId varchar(max)='',
@To DateTime,
@TaskReviewStatusID varchar(MAX)='',
@Overdue int=2,				--0: No, 1: Yes, 2: All
@OutSidePlanWindow bit=1,	-- exclude items outside planning window if 0, include if 1
@isGetAnyway bit=0,
@UserID int=0,
@ShowAllTasks bit=0
    
AS

DECLARE @MaxRecords int,@MaxRecordsWarning int, @TaskCount int
DECLARE @UseSchedulingSystemLastOcc BIT

SELECT TOP 1 @MaxRecords=Max_Records,@MaxRecordsWarning=Max_Records_Warning,
@UseSchedulingSystemLastOcc = UseSchedulingSystemLastOcc FROM AMT_VARIABLE

SET @MaxRecords=ISNULL(@MaxRecords,10000)
SET @MaxRecordsWarning=ISNULL(@MaxRecordsWarning,2000)


SET @To=convert(varchar,@To,112)		--start of the day

SET @UserId=ISNULL(@UserId,0)  
DECLARE @Level int  
  
SELECT @Level=User_Access_Level_Id From USER_LEVEL_PERMISSION where AMT_User_Id = @UserId  
  
SET @Level=ISNULL(@Level,0) /*0 -ALL, 1-Branch,2-Site*/  


CREATE TABLE #z_EqpProj(EqpProjId int PRIMARY KEY(EqpProjId))
INSERT INTO #z_EqpProj(EqpProjId)
SELECT EqpProjId
FROM
EQUIPMENT_HIERARCHY_V
WHERE
(Projection_Type_Id=1) AND
(@BranchId='' OR BranchId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@BranchId))) AND
(@SiteId='' OR SiteId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@SiteId))) AND
(@FleetId='' OR FleetId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@FleetId))) AND
(@EqpPlanId='' OR EqpPlanId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EqpPlanId))) AND
(@ModelId='' OR ModelId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@ModelId))) AND
(@RegionId='' OR Region_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@RegionId))) AND
(@DivisionId='' OR Division_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@DivisionId))) AND
(@EqpLocationId='' OR Eqp_Location_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EqpLocationId))) AND
(@EqpCategoryId='' OR Eqp_Category_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EqpCategoryId))) AND
(@EqpCostCentreId='' OR CostCentreID IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EqpCostCentreId))) AND
(@CostResponsibilityId='' OR Cost_Responsibility_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@CostResponsibilityId))) AND
(@ParentEqpPlanID='' OR EqpPlanId IN (SELECT EqpPlanId FROM dbo.EQP_SIBLINGS_F(@ParentEqpPlanID))) AND
(@Level<>1 OR BranchId IS NULL OR BranchId IN(SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = @UserId)) AND  
(@Level<>2 OR SiteId IS NULL OR SiteId IN(SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = @UserId))  AND
(@CustomerId='' OR CustomerId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@CustomerId)))

IF @@ROWCOUNT=0 RETURN

CREATE TABLE #z_ProjTasks(ProjTaskId int,ChangeoutWOId int,EqpProjId int,RCMComponentStructureId int PRIMARY KEY(ProjTaskId))

INSERT INTO #z_ProjTasks(ProjTaskId,EqpProjId,RCMComponentStructureId)
SELECT PT.ProjTaskId,PT.EqpProjId,PT.RCMComponentStructureId
FROM
PLAN_TASK_GET_V PT
	LEFT JOIN
NEXT_OCC_STRATEGY N
	ON PT.ProjTaskId=N.Proj_Task_Id
WHERE
(PT.EqpProjId IN (SELECT EqpProjId FROM #z_EqpProj)) AND
(@ComponentCodeId='' OR PT.ComponentCodeId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@ComponentCodeId))) AND
(@TaskTypeId='' OR PT.TaskTypeId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@TaskTypeId))) AND
(dbo.CHECK_TASKOPTION_WORKGROUP_F(ProjTaskOptId,ISNULL(@WorkGroupID, ''))<>0)	AND
(@CompCondRatingID = '' OR dbo.GET_COMPONENT_CONDITION_F(PT.ProjTaskId,1) IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@CompCondRatingID)))  AND
(@CompCondReviewStatusID = '' OR dbo.GET_COMPONENT_CONDITION_F(PT.ProjTaskId,0) IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@CompCondReviewStatusID)))  AND
(@TaskReviewStatusID= '' OR PT.ReviewStatusID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@TaskReviewStatusID)))  AND
(@SalesResponsibilityId= '' OR N.SalesResponsibilityId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@SalesResponsibilityId)))  AND
(@OutSidePlanWindow=1 OR PlanStatus <> 0) AND
(NextOccDate <= @To OR @ShowAllTasks=1) AND 
FinalDate>=getdate() AND
(@Overdue=2 OR CASE WHEN NextOccDate < getdate() THEN 1 ELSE 0 END=@Overdue)

IF @@ROWCOUNT=0 RETURN

DROP TABLE #z_EqpProj

UPDATE PT SET ChangeoutWOId=A.ChangeoutWOId
FROM
#z_ProjTasks PT
	INNER JOIN
(SELECT S.ProjTaskId,MIN(T.Task_Id) AS ChangeoutWOId
FROM
#z_ProjTasks S
	INNER JOIN
tblProjTaskOpts PTO
	ON S.ProjTaskId=PTO.ProjTaskId
	INNER JOIN
TASK T
	ON PTO.ProjTaskOptId=T.Strategy_Proj_Task_Opt_ID
	
WHERE T.Task_Status_ID IN(1,6) AND T.RebuildTaskId>0
GROUP BY S.ProjTaskId) A
	ON PT.ProjTaskId=A.ProjTaskId
	
IF @RebuildLocationId<>''
BEGIN
	DELETE #z_ProjTasks WHERE ProjTaskId NOT IN(
		SELECT PT.ProjTaskId
		FROM
		#z_ProjTasks PT
			INNER JOIN
		TASK CWO
			ON PT.ChangeoutWOId=CWO.Task_ID
			INNER JOIN
		TASK RWO
			ON CWO.RebuildTaskId=RWO.Task_ID
			
		WHERE RWO.Site_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@RebuildLocationId)))
END

SELECT @TaskCount = COUNT(ProjTaskId) FROM #z_ProjTasks

IF @TaskCount=0 RETURN


IF ISNULL(@isGetAnyway,0)=0 AND (@MaxRecords>0 OR @MaxRecordsWarning>0)
BEGIN
      IF @TaskCount>@MaxRecords AND @MaxRecords>0
      BEGIN
            SELECT @MaxRecords AS MaxRecords
            RETURN
      END
      ELSE IF @TaskCount>@MaxRecordsWarning AND @MaxRecordsWarning>0
      BEGIN
            SELECT @TaskCount AS Warning
            RETURN
      END
END

CREATE TABLE #FailureModes
(
	FailureModeID int identity(1,1),
	ProjTaskId int, 
	RCMConditionMonitoringId int
	PRIMARY KEY (FailureModeID,ProjTaskId,RCMConditionMonitoringId)
)
CREATE TABLE #FailureModeAssessments
(
	FailureModeID int,
	ProjTaskId int, 
	RCMConditionMonitoringId int ,
	CBMFailureModeAssessmentId int, 
	MessageRatingId int, 
	CBMReviewStatusId int
	PRIMARY KEY (FailureModeID,ProjTaskId,RCMConditionMonitoringId,CBMFailureModeAssessmentId)
)

IF EXISTS(SELECT RCMComponentStructureId FROM #z_ProjTasks WHERE RCMComponentStructureId>0)
BEGIN
	INSERT INTO #FailureModes(ProjTaskId, RCMConditionMonitoringId)	
	SELECT	PT.ProjTaskId,CM.RCMConditionMonitoringId
	FROM         
	#z_ProjTasks PT
		INNER JOIN
	RCM_COMPONENT_STRUCTURE CS 
		ON PT.RCMComponentStructureId = CS.RCMComponentStructureId 
		INNER JOIN
	RCM_FAILURE_MODE FM 
		ON CS.RCMComponentStructureId = FM.RCMComponentStructureId 
		INNER JOIN
	RCM_CONDITION_MONITORING CM 
		ON FM.RCMFailureModeId = CM.RCMFailureModeId

	INSERT INTO #FailureModeAssessments(
	FailureModeID,ProjTaskId, RCMConditionMonitoringId,CBMFailureModeAssessmentId, 
	MessageRatingId, CBMReviewStatusId)	

	SELECT	FM.FailureModeID,FM.ProjTaskId,FM.RCMConditionMonitoringId, FMA.CBMFailureModeAssessmentId, 
	FMA.MessageRatingId, FMA.CBMReviewStatusId
	FROM         
	#FailureModes FM 
		CROSS APPLY
	(SELECT TOP 1 * FROM CBM_FAILURE_MODE_ASSESSMENT
	WHERE	RCMConditionMonitoringId = FM.RCMConditionMonitoringId AND ProjTaskId = FM.ProjTaskId
	ORDER BY CBMFailureModeAssessmentId DESC)FMA
END	

        
SELECT EH.Customer,EH.Branch,EH.Site,EH.Fleet,EH.EqpPlan,EH.Model,SS.SubSystem,PT.CompCode,
PT.MCode AS ModifierCode,PT.TaskType,PT.Application_Code,PT.ComponentCode AS TaskDesc,
PT.JobCost,PT.Frequency,
PT.CurrentUsage-ISNULL(ISNULL(CASE WHEN @UseSchedulingSystemLastOcc =1 AND PT.SchedulingTaskId>0 THEN PT.Ext_Last_Occ ELSE PT.AMT_WO_Last_Occ END,PT.Last_Change_Usage),0)
AS LifeToDate,
/*If past the NOT AFTER show as NULL (unless the NEXT has been set manually, 
in which case then show the NEXT)*/

CASE WHEN PT.NextOccDate>PT.NotAfter AND PT.PlanUseCalc=1 THEN NULL ELSE PT.NextOccDate END AS NextOccDate, 
CASE WHEN PT.NextOccDate>PT.NotAfter AND PT.PlanUseCalc=1 THEN NULL ELSE PT.NextOcc END AS NextOcc, 

CASE B.CBMReviewStatusId WHEN 2 THEN 'R' WHEN 3 THEN 'C' WHEN 1 THEN 'X' ELSE NULL END AS CBMReviewStatus,
PT.ReviewStatus,LEFT(E.First_Name,1) + '. ' + E.Surname AS SalesResponsibility,
isnull(PT.CustomerContacted,0) AS CustomerContacted,
/*VV #2870*/
LEFT(E2.First_Name,1) + '. ' + E2.Surname AS CustomerContactedEmployee,
PT.CustomerContactedDate,PT.CustomerContactedComments,

S.SalesStatus,PT.SalesStatusLastModDate,PT.PONumber,R.SalesLostReason,PT.Comments,
/*E798*/pc.PartClassification AS DefRebuildPartClassification, 
/*E798*/rebuildpc.PartClassification AS RebuildPartClassification, 
P.Part+' - '+P.PartDescription AS DefRebuildPart,
PR.Part+' - '+PR.PartDescription AS RebuildPart,
SI.Site AS DefRebuildLocation,SIT.Site AS RebuildLocation,
CAST((CASE WHEN RWO.Task_ID>0 THEN 1 ELSE 0 END) AS bit) AS RebuildWO,B.MessageRatingId,PT.PlanStatus,
EH.EndDate,PT.ProjTaskId


FROM
#z_ProjTasks Z
	INNER JOIN
EQUIPMENT_HIERARCHY_V EH
	ON Z.EqpProjId=EH.EqpProjId
	INNER JOIN
PLAN_TASK_GET_V PT
	ON Z.ProjTaskId=PT.ProjTaskId
	INNER JOIN
tblSubSystems SS
	ON PT.SubSystemID=SS.SubSystemID
	LEFT JOIN
EMPLOYEE E
	ON PT.SalesResponsibilityID=E.Employee_ID
	LEFT JOIN
EMPLOYEE E2
	ON PT.CustomerContactedEmployeeId=E2.Employee_ID
	LEFT JOIN
SALES_STATUS S
	ON PT.SalesStatusId=S.SalesStatusId
	LEFT JOIN
SALES_LOST_REASON R
	ON PT.SalesLostReasonId=R.SalesLostReasonId
	/*E798*/
	LEFT JOIN 
PART_CLASSIFICATION pc
	ON PT.PEXPartTypeId = pc.PartClassificationId
	LEFT JOIN
tblParts P
	ON PT.PEXPartId=P.PartId
	LEFT JOIN
tblSites SI
	ON 	PT.PEXRebuildLocationId=SI.SiteId
	LEFT JOIN
TASK CWO
	ON Z.ChangeoutWOId=CWO.Task_ID
	LEFT JOIN
TASK RWO
	ON CWO.RebuildTaskId=RWO.Task_ID
	LEFT JOIN
tblSites SIT
	ON RWO.Site_Id=SIT.SiteId
	/*E798*/
	LEFT JOIN 
PART_CLASSIFICATION rebuildpc
	ON RWO.RebuildPartTypeId = rebuildpc.PartClassificationId
	LEFT JOIN
tblParts PR
	ON RWO.RebuildPartId=PR.PartId
	OUTER APPLY
(SELECT TOP 1 * FROM #FailureModeAssessments WHERE ProjTaskId=PT.ProjTaskId ORDER BY MessageRatingId DESC) B
ORDER BY EH.Branch,EH.Site,EH.Fleet,EH.EqpPlan,EH.Model,SS.SubSystem,PT.CompCode,
PT.MCode,PT.TaskType,PT.Application_Code
	
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[TASK_GET_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[TASK_GET_P]
GO

create   PROCEDURE [dbo].[TASK_GET_P]   
/******************************************************************************  
 File:   
 Name: TASK_GET_P  
  
 Called By:   
  
 Desc: 1. Selects  equipment status task details   
               
  
 Auth: Veronika Vasylyeva  
 Date: 13-SEP-2002  
*******************************************************************************  
  Change History  
*******************************************************************************  
 Date:  Author:  Description:  
   
 -------- -------- ----------------------------------------  
 17 APR 2012 SD    E797 - TASK.RebuildPartTypeId now FK to PART_CLASSIFICATION
 23 Mar 2012 TW  #3793  Fix changeout reason issue  
 23 Aug 2011 V Vasylyeva E621: Rebuild workorder  
 19 Jul 11 V Vasylyeva E602: Serialised Component  
 03 Jun 2011 GW   #560  
 28 Apr 2011 RJ   #1188  
 16 Nov 2010 VS          #751: Performed_By_Date  
 29-Sep-2010 V Vasylyeva #516: Rotables in use do not show  
 10-Aug-2010 DS   Added CreatePOModeAllowCreateERPWO  
 23-Jun-2010 V Vasylyeva Changed LastNotified  
 31-Mar-2010 AL   CR8869: Added new JR fields  
 29-Mar-2010 AL   CR8865: Added HealthSafetyAuditable and LastNotified  
 18-Feb-2010 V Vasylyeva CR8789: Uncommented lines  
  7-Mar-2007 V Vasylyeva Changes for the new planning module. Added task operation,  
       task operation parts, task operation misc  
 24-May-2007 ID   Added new columns to Purchase Order select  
 25-May-2007 ID   Added "PO.SupplierBusinessContactFax" to Purchase Order select  
 28 May 2007 V Vasylyeva Moved new purchase order fields to the end if select  
  1 Aug 2007 V Vasylyeva Added SET @TaskStatusYTS=6  
 17 Aug 2007 ID   CR6389: Changed the Rotable Data Retrieval query  
  4 Sep 2007 VV   CR6896 : Changed Linked flag  
 08 Oct 2007 KN   Added "LifeConfirmed","ChangeoutCategory"  
 31 Mar 2008 DS   Enhancement 211: Added Event Up Time  
 21 Apr 2008 KN   Added OverwriteLife fields  
 06 May 2008 KN   Added TotalLife Field  
 22-May-2008 A Lass.  changed @Planning_Notes to be varchar(MAX)  
 12 Jun 08 AL   Changed Repair Description size  
 29 Aug 08 AL   Added WarrantyParts  
 17/09/08 AL   removed links to tblqualifier and tbluoms  
 11 Oct 08 DS   Added WOCreateFromPO  
 14 Nov 08 D Smith  In PO mode, change display of Supplier  
 22-Dec-08 AL    CR7798: Changed TASK.RaisedByID  
 03-Feb-09 AL   CR7843: Added WO Closure info  
 03-Feb-09 AL   CR7844: Added Task Authorisation info  
 06-Feb-09 AL   Changed ManualWOClosure to ACWManualWOClosure  
    09-Feb-09 AL   provide planned cost info  
 09-Feb-09 AL   add Eqp Description  
 10 Feb 09 AL   CR7845: change size of symptom, cause and repair desc + planning_notes to 8,000  
 10 Feb 09 AL   CR7846: added feedback fields  
 11 Feb 09 AL   CR7844: added @AuthorisationTolerancePct + ExpressAddTaskInstruction  
 13 Feb 09 AL   CR7874: added missing Task update fields  
 09 Mar 09 AL   CR7933: added new AMT_TYPED_VARIABLEs   
 10 Mar 09 AL   CR7933: added new AMT_TYPED_VARIABLEs   
 11-Mar-09 AL   CR7933: removed OpEditionLabourWG  
 17 Mar 09 AL   CR7933: added new AMT_TYPED_VARIABLEs + POCounter on PO grid  
  2-Apr-09 V Vasylyeva Added attached documents  
 03 Apr 09 AL   CR7933: added new fields  
 04 Apr 09 AL   CR7933: ManualEntryActuals* as int  
 22 Apr 09 AL   CR8013: Added PricingGroup and PrimaryCurrency  
 27 Apr 09 VV   CR8035: Link documents  
 29 Apr 09 VV   CR8035: ExtDocUseClientCredentials  
 26 Aug 09 KN   Added ConditionMonitoringIntervention  
 21 Oct 09 AL   CR8414: added StrategyRotable  
 21 Oct 09 KN   Added   FailedPartListPosition,FailedPartListGroup,FailedPartLifeAchieved,  
         PartSerialNoRemoved,PartSerialNoInstalled,WarrantyClaimByUserId,WarrantyClaimSystemDate  
 20 Nov 09 VV   CR8449: Added Create_By_User_Id,Create_Date  
 15 Dec 09 AL   CR8638: Added showOPParts_PartsBookLookup  
  7 Dec 11   GD          Fixed 3063  
*******************************************************************************/  
 /* Param List */  
 @Task_Id int,  
 @EventId int=0  
AS  
  
  
DECLARE @POMode INT  
DECLARE @ACWManualWOClosure BIT   
DECLARE @AuthorisationMode INT   
DECLARE @FeedbackPartsTab bit   
DECLARE @FeedbackLabourTab bit   
DECLARE @FeedbackMiscTab bit   
DECLARE @AuthorisationTolerancePct float   
DECLARE @ExternalDocumentSystem bit   
DECLARE @ExtDocUseClientCredentials bit  
DECLARE @AutoLookupPartsReadyStatus bit  
  
SET @POMode = 0  
  
SELECT TOP 1 @POMode = WOCreateFromPO,  
 @ACWManualWOClosure=ACWManualWOClosure,  
 @AuthorisationMode=AuthorisationMode,  
 @AuthorisationTolerancePct=AuthorisationTolerancePct,  
 @FeedbackPartsTab=FeedbackPartsTab,   
 @FeedbackLabourTab=FeedbackLabourTab,  
 @FeedbackMiscTab=FeedbackMiscTab  
FROM AMT_VARIABLE  
  
EXEC AMT_TYPED_VARIABLE_GET_P @Value_Name='ExternalDocumentSystem',  @Varchar_Value=@ExternalDocumentSystem OUTPUT  
  
EXEC AMT_TYPED_VARIABLE_GET_P @Value_Name='ExtDocUseClientCredentials',  @Varchar_Value=@ExtDocUseClientCredentials OUTPUT  
  
EXEC AMT_TYPED_VARIABLE_GET_P @Value_Name='AutoLookupPartsReadyStatus',  @Varchar_Value=@AutoLookupPartsReadyStatus OUTPUT  
  
SET @ExternalDocumentSystem=ISNULL(@ExternalDocumentSystem,0)  
SET @ExtDocUseClientCredentials=ISNULL(@ExtDocUseClientCredentials,0)  
  
DECLARE @ManualEntryActualsParts INT  
DECLARE @ManualEntryActualsLabour INT  
DECLARE @ManualEntryActualsMisc INT  
DECLARE @OpEditionPartsStockCode BIT  
DECLARE @OpEditionPartsCB INT  
DECLARE @OpEditionPartsCC INT  
DECLARE @OpEditionPartsEE INT  
DECLARE @OpEditionPartsWG INT  
DECLARE @OpEditionLabourCB INT  
DECLARE @OpEditionLabourCC INT  
DECLARE @OpEditionLabourEE INT  
DECLARE @OpEditionMiscCB INT  
DECLARE @OpEditionMiscCC INT  
DECLARE @OpEditionMiscEE INT  
DECLARE @OpEditionMiscWG INT  
DECLARE @ShowOPParts_LookupPartsDetails BIT  
DECLARE @ShowOPParts_SearchPurchaseHistory BIT  
DECLARE @ShowOPParts_AssignSupplier BIT  
DECLARE @ShowOPParts_InventorySearch BIT  
DECLARE @ShowOPParts_InventoryValidation BIT  
DECLARE @ShowOPParts_PartsBookLookup BIT   
DECLARE @ShowPOAssignNo BIT   
DECLARE @ShowPOActions BIT  
DECLARE @OpEditionPlanStatus INT  
/*VV E621*/  
DECLARE @EqpSite varchar(1000),@EqpCustomer varchar(1000),@ChangeoutStrategyDate datetime  
DECLARE @ChangeoutPlannedDate datetime,@ChangeoutActualDate datetime,@ChangeoutLifeAchived float  
DECLARE @ChangeoutSerialNoOut varchar(1000),@ParentTaskId int  
  
EXEC TASK_OPERATION_CONFIGURATION_GET_P  
 @ManualEntryActualsParts=@ManualEntryActualsParts OUTPUT,  
 @ManualEntryActualsLabour=@ManualEntryActualsLabour OUTPUT,  
 @ManualEntryActualsMisc=@ManualEntryActualsMisc OUTPUT,  
 @OpEditionPartsStockCode=@OpEditionPartsStockCode OUTPUT,  
 @OpEditionPartsCB=@OpEditionPartsCB OUTPUT,  
 @OpEditionPartsCC=@OpEditionPartsCC OUTPUT,  
 @OpEditionPartsEE=@OpEditionPartsEE OUTPUT,  
 @OpEditionPartsWG=@OpEditionPartsWG OUTPUT,  
 @OpEditionLabourCB=@OpEditionLabourCB OUTPUT,  
 @OpEditionLabourCC=@OpEditionLabourCC OUTPUT,  
 @OpEditionLabourEE=@OpEditionLabourEE OUTPUT,  
 @OpEditionMiscCB=@OpEditionMiscCB OUTPUT,  
 @OpEditionMiscCC=@OpEditionMiscCC OUTPUT,  
 @OpEditionMiscEE=@OpEditionMiscEE OUTPUT,  
 @OpEditionMiscWG=@OpEditionMiscWG OUTPUT,  
 @ShowOPParts_LookupPartsDetails=@ShowOPParts_LookupPartsDetails OUTPUT,  
 @ShowOPParts_SearchPurchaseHistory=@ShowOPParts_SearchPurchaseHistory OUTPUT,  
 @ShowOPParts_AssignSupplier=@ShowOPParts_AssignSupplier OUTPUT,  
 @ShowOPParts_InventorySearch=@ShowOPParts_InventorySearch OUTPUT,  
 @ShowOPParts_InventoryValidation=@ShowOPParts_InventoryValidation OUTPUT,  
 @ShowOPParts_PartsBookLookup=@ShowOPParts_PartsBookLookup OUTPUT,  
 @ShowPOAssignNo=@ShowPOAssignNo OUTPUT,  
 @ShowPOActions=@ShowPOActions OUTPUT,  
 @OpEditionPlanStatus=@OpEditionPlanStatus OUTPUT  
  
DECLARE @CreatePOModeAllowCreateERPWO bit  
EXEC AMT_TYPED_VARIABLE_GET_P @Value_Name='CreatePOModeAllowCreateERPWO',  @Varchar_Value=@CreatePOModeAllowCreateERPWO OUTPUT  
  
  
--For a new event to get task table structure  
IF @Task_Id<0  
BEGIN  
 SELECT       
 Task_ID, Event_ID, Description, Eqp_Plan_ID, Task_Type_ID, Component_Code_ID, Modifier_ID, Application_Code_ID, Occurrence_Type_Id,   
 Priority_ID, Source_ID, Task_Status_ID, CAST('' AS varchar(25)) AS Date_Notified, Component_ID, Symptom_ID, Symptom_Notes, Cause_ID, Cause_Notes, Repair_Notes,   
 Group_No, Part_No, EMI_Ref, Redo, Task_Planned_Time_ID, Customer_Ref, Employee_ID, Expected_Duration, Expected_Labor_Hours,   
 Planning_Notes, Work_Order, Actual_Duration, Actual_Labor_Hrs, Primary_Cause, Notes, Task_Mode_ID, --Parts_Resources_Identified,   
 PartsStatusRequired, PartsStatusOrdered, PartsStatusReady,   
 RaisedByID,  
 Work_Order_ID, Strategy_Usage, Work_Group_ID,   
 Strategy_QUOM_ID, Strategy_Proj_Task_Opt_ID, Planned_Proj_Task_Opt_ID, CAST('' AS varchar(25)) AS Strategy_Date, Strategy_Locked, Create_By_User_ID, Repair_Code_Id,   
 EM_Issue_Id, Part_Description, Group_Description, SIMS_Code_Id, Rotable_Remove_Id, Rotable_Inuse_Id, Strategy_Repair_Description, Sort_Order,   
 CAST('' AS varchar(25)) AS WO_Create_Date, CAST('' AS varchar(25)) AS Performed_By_Date, WO_Counter, Work_Order_Number_External, Cost_Bearer_ID,   
 Task_Warranty, Redo_Work_Order_ID, View_Warranty, Break_Down, Health_Safety_Id,   
 CAST('' AS varchar(25)) AS Planned_Down_Time, CAST('' AS varchar(25)) AS Planned_Up_Time, CAST(NULL AS varchar(25))Actual_Down_Time,   
 Planned_Offset,   
 Site_Id, Work_Location, Cost_Centre_Id, Branch_Id, Customer_Id, Part_Entry_Distribution_Code_Id, Def_Work_Group_Id, Parts_Cost_Expense_Id,   
 Labour_Cost_Expense_Id, Misc_Cost_Expense_Id, Specific_Operation_Codes, CAST('' AS varchar(25)) AS Work_Order_Date, Warranty_Claimable, Reviewed_Employee_Id,   
 Warranty_Notes, Warranty_Days, Warranty_Usage, Warranty_Days_Archived, Warranty_Usage_Acrhived, Warranty_Supplier_Id, Claim_Ref,   
 Supplier_Ref, Summary_Description, Claim_Status_Id, Claimed_By_Employee_Id, CAST('' AS varchar(25)) AS Claime_Date, Claim_Description, Job_Parts_Cost,   
 Job_Labour_Cost, Job_Misc_Cost, Claimed_Parts_Cost, Claimed_Labour_Cost, Claimed_Misc_Cost, Rec_Parts_Cost, Rec_Labour_Cost,   
 Rec_Misc_Cost, Labour_Entry_Distribution_Code_Id, Misc_Entry_Distribution_Code_Id, Supplier_Contact, Task_Authorised, Task_Authorised_By_Id,   
 CAST('' AS varchar(25)) AS Task_Authorised_Date, ActualOffset, AMTPlanningModeId, CAST(0 as int) AS ProjTaskId,  
 CAST('' AS varchar(25)) AS Last_Mod_Date,CAST(0 AS bit) AS CreateWO,CAST(0 AS bit) AS WarrantyParts,  
 Task_Authorised_Amount,Task_Authorised_TolerancePct,'' AS ExpressAddTaskInstruction,  
 ChangeoutCategoryId,LifeConfirmed, OriginalPartTypeId,/*VV E602*/SerialNoInId,SerialNoOutId,IsOverwriteLife, OverwriteLifeAchieved, CAST(0 AS bit) AS WOClosed,  
 @ManualEntryActualsParts AS ManualEntryActualsParts,  
 @ManualEntryActualsLabour AS ManualEntryActualsLabour,  
 @ManualEntryActualsMisc AS ManualEntryActualsMisc,  
 @OpEditionPartsStockCode AS OpEditionPartsStockCode,  
 @OpEditionPartsCB AS OpEditionPartsCB,  
 @OpEditionPartsCC AS OpEditionPartsCC,  
 @OpEditionPartsEE AS OpEditionPartsEE,  
 @OpEditionPartsWG AS OpEditionPartsWG,  
 @OpEditionLabourCB AS OpEditionLabourCB,  
 @OpEditionLabourCC AS OpEditionLabourCC,  
 @OpEditionLabourEE AS OpEditionLabourEE,  
 @OpEditionMiscCB AS OpEditionMiscCB,  
 @OpEditionMiscCC AS OpEditionMiscCC,  
 @OpEditionMiscEE AS OpEditionMiscEE,  
 @OpEditionMiscWG AS OpEditionMiscWG,  
 @ShowOPParts_LookupPartsDetails AS ShowOPParts_LookupPartsDetails,  
 @ShowOPParts_SearchPurchaseHistory AS ShowOPParts_SearchPurchaseHistory,  
 @ShowOPParts_AssignSupplier AS ShowOPParts_AssignSupplier,  
 @ShowOPParts_InventorySearch AS ShowOPParts_InventorySearch,  
 @ShowOPParts_InventoryValidation AS ShowOPParts_InventoryValidation,  
 @ShowOPParts_PartsBookLookup AS ShowOPParts_PartsBookLookup,  
 @ShowPOAssignNo AS ShowPOAssignNo,  
 @ShowPOActions AS ShowPOActions,  
 @OpEditionPlanStatus AS OpEditionPlanStatus,  
 @ExternalDocumentSystem AS ExternalDocumentSystem,  
 @ExtDocUseClientCredentials AS ExtDocUseClientCredentials,  
 ConditionMonitoringIntervention,  
 Create_Date,  
 0 as HealthSafetyAuditable,CAST('' AS varchar(25)) AS LastNotified,  
 @AutoLookupPartsReadyStatus AS AutoLookupPartsReadyStatus,  
 AuthorisationRequestByID,NULL AS AuthorisationRequestBy,AuthorisationRequestDate,  
 ResourceStatusReady,  
 @CreatePOModeAllowCreateERPWO AS CreatePOModeAllowCreateERPWO,  
 /*E621*/  
 0 AS RebuildWO  
   
   
 FROM TASK WHERE Task_Id=@Task_Id  
END  
  
DECLARE @Has_Records_In_Holding_Event bit  
  
DECLARE @TaskStatusYTS int,/*VV E621*/@TaskStatusIP int,@TaskStatusC int,@TaskStatusA int  
  
DECLARE @CompanyCode varchar(50)  
DECLARE @EVPlannedDownTime datetime  
DECLARE @TaskStatusId int  
DECLARE @PlannedOffset float  
DECLARE @TPlannedDownTime datetime  
DECLARE @OpNum int  
DECLARE @ChooseWODate bit  
DECLARE @WOCreationDateFutureONLY bit  
DECLARE @WOCreateFromPO bit  
DECLARE @ElectronicWorkscopeLinked bit /*GW E560*/  
Set @ElectronicWorkscopeLinked=0  
  
SET @Has_Records_In_Holding_Event=0  
SET @TaskStatusYTS=6  
SET @TaskStatusIP=2  
SET @TaskStatusC=3  
SET @TaskStatusA=5  
  
SELECT @ChooseWODate=Choose_WO_Date, @WOCreationDateFutureONLY=WO_CreationDate_FutureONLY  
FROM AMT_VARIABLE  
  
  
  
SELECT TOP 1 @WOCreateFromPO = WOCreateFromPO FROM AMT_VARIABLE  
  
  
  
/*GW E560*/  
if EXISTS( SELECT    EW_WORKORDER.EWWorkorderId  
   FROM      TASK   
   INNER JOIN TASK_OPERATION ON TASK.Task_ID = TASK_OPERATION.Task_Id   
   INNER JOIN EW_WORKORDER ON TASK_OPERATION.Task_Operation_Id = EW_WORKORDER.TaskOperationId  
   WHERE TASK.Task_ID = @Task_Id)  
 BEGIN  
  SET @ElectronicWorkscopeLinked=1  
 END     
   
DECLARE @z_TASK TABLE(  
 Task_ID int,  
 Event_ID int,  
 Description varchar(500),  
 Eqp_Plan_ID int,  
 Task_Type_ID int,  
 Component_Code_ID int,  
 Modifier_ID int,  
 Application_Code_ID int,  
 Occurrence_Type_Id int,  
 Priority_ID int,  
 Source_ID int,  
 Task_Status_ID int,  
 Date_Notified datetime,  
 Component_ID varchar(100),  
 Symptom_ID int,  
 Symptom_Notes varchar(8000),  
 Cause_ID int,  
 Cause_Notes varchar(8000),  
 Repair_Notes varchar(8000),  
 Group_No varchar(50),  
 Part_No varchar(50),  
 EMI_Ref varchar(50),  
 Redo bit,  
 Task_Planned_Time_ID int,  
 Customer_Ref varchar(100),  
 Employee_ID int,  
 Expected_Duration float,  
 Expected_Labor_Hours float,  
 Planning_Notes varchar(8000),  
 Work_Order varchar(50),  
 Actual_Duration float,  
 Actual_Labor_Hrs float,  
 Primary_Cause bit,  
 Notes varchar(1000),  
 Task_Mode_ID int,  
 PartsStatusRequired bit,  
 PartsStatusOrdered bit,  
 PartsStatusReady bit,   
 RaisedByID int,  
 Work_Order_ID int,  
 Strategy_Usage real,  
 Work_Group_ID int,  
 Strategy_QUOM_ID int,  
 Strategy_Proj_Task_Opt_ID int,  
 Planned_Proj_Task_Opt_ID int,  
 IsPlanningTask bit,  
 Strategy_Date datetime,  
 Strategy_Locked bit,  
 Last_Mod_By_User_ID int,  
 Last_Mod_Date datetime,  
 Create_By_User_ID int,  
 Create_Date datetime,  
 Repair_Code_Id int,  
 EM_Issue_Id int,  
 Task_Header_Id int,  
 --RJ   
 Part_Description varchar(1000),  
 Group_Description varchar(1000),  
 SIMS_Code_Id int,  
 Rotable_Remove_Id int,  
 Rotable_Inuse_Id int,  
 Strategy_Repair_Description varchar(1000),  
 Sort_Order int,  
 WO_Create_Date datetime,  
 Performed_By_Date datetime,  
 WO_Counter int,  
 Work_Order_Number_External varchar(50),  
 Cost_Bearer_ID int,  
 Task_Warranty bit,  
 Redo_Work_Order_ID int,  
 View_Warranty bit,  
 Health_Safety_Id int,  
 Break_Down bit,  
 Planned_Down_Time datetime,  
 Planned_Up_Time datetime,  
 Actual_Down_Time datetime,  
 Planned_Offset float,  
 Final_Change float,  
 Risk_Life_Left float,  
 Strategy_Frequency float,  
 Last_Performed float,  
 Last_Scheduled float,  
 Last_Performed_Date datetime,  
 Last_Scheduled_Date datetime,  
 Site_Id int,  
 Work_Location varchar(100),  
 Cost_Centre_Id int,  
 Branch_Id int,  
 Customer_Id int,  
 Part_Entry_Distribution_Code_Id int,  
 Def_Work_Group_Id int,  
 Parts_Cost_Expense_Id int,  
 Labour_Cost_Expense_Id int,  
 Misc_Cost_Expense_Id int,  
 Specific_Operation_Codes bit,  
 Work_Order_Date datetime,  
 Warranty_Claimable bit,  
 Reviewed_Employee_Id int,  
 Warranty_Notes varchar(500),  
 Warranty_Days float,  
 Warranty_Usage float,  
 Warranty_Days_Archived float,  
 Warranty_Usage_Acrhived float,  
 Warranty_Supplier_Id int,  
 Claim_Ref varchar(20),  
 Supplier_Ref varchar(20),  
 Summary_Description varchar(200),  
 Claim_Status_Id int,  
 Claimed_By_Employee_Id int,  
 Claime_Date datetime,  
 Claim_Description varchar(1000),  
 Job_Parts_Cost float,  
 Job_Labour_Cost float,  
 Job_Misc_Cost float,  
 Claimed_Parts_Cost float,  
 Claimed_Labour_Cost float,  
 Claimed_Misc_Cost float,  
 Rec_Parts_Cost float,  
 Rec_Labour_Cost float,  
 Rec_Misc_Cost float,  
 Labour_Entry_Distribution_Code_Id int,  
 Misc_Entry_Distribution_Code_Id int,  
 Supplier_Contact varchar(100),  
 Task_Authorised bit,  
 Task_Authorised_By_Id int,  
 Task_Authorised_Date datetime,  
 ActualOffset float,  
 AMTPlanningModeId int,  
 ChangeoutCategoryId int,  
 LifeConfirmed bit,  
 OriginalPartTypeId int,  
 /*VV E602*/  
 SerialNoInId int,  
 SerialNoOutId int,  
 IsOverwriteLife bit,  
 OverwriteLifeAchieved float ,  
 WOCreateFromPO bit,  
 Task_Authorised_Amount float,  
 Task_Authorised_TolerancePct float,  
 ConditionMonitoringIntervention bit,  
 FailedPartListPosition varchar(100),  
 FailedPartListGroup  varchar(100),  
 FailedPartLifeAchieved float,  
 PartSerialNoRemoved  varchar(100),  
 PartSerialNoInstalled  varchar(100),  
 WarrantyClaimByUserId int,  
 WarrantyClaimSystemDate datetime,  
 LastNotified datetime,  
 AuthorisationRequestByID int,  
 AuthorisationRequestDate datetime,  
 ResourceStatusReady bit,  
 ElectronicWorkscopeLinked bit/*GW E560*/,  
 /*VV E621*/  
 RebuildWO bit,  
 RebuildJobNumber varchar(50) COLLATE DATABASE_DEFAULT,  
 ReceiptedIntoStock bit,  
 RebuildPartTypeId int,  
 RebuildPartId int,  
 DeliveryToWorkshop float,  
 WaitingForRebuild float,  
 RebuildTime float,  
 DeliveryToWarehouse float,  
 RebuildTaskId int  
   
PRIMARY KEY(Task_Id))  
  
INSERT INTO @z_TASK(  
Task_ID, Event_ID, Description, Eqp_Plan_ID, Task_Type_ID, Component_Code_ID, Modifier_ID, Application_Code_ID,   
Occurrence_Type_Id, Priority_ID, Source_ID, Task_Status_ID, Date_Notified, Component_ID, Symptom_ID,   
Symptom_Notes, Cause_ID, Cause_Notes, Repair_Notes, Group_No, Part_No, EMI_Ref, Redo, Task_Planned_Time_ID,   
Customer_Ref, Employee_ID, Expected_Duration, Expected_Labor_Hours, Planning_Notes, Work_Order, Actual_Duration,   
Actual_Labor_Hrs, Primary_Cause, Notes, Task_Mode_ID,   
PartsStatusRequired, PartsStatusOrdered, PartsStatusReady,  
RaisedByID,  
Work_Order_ID, Strategy_Usage, Work_Group_ID,   
Strategy_QUOM_ID, Strategy_Proj_Task_Opt_ID, Planned_Proj_Task_Opt_ID,   
IsPlanningTask,   
Strategy_Date, Strategy_Locked,   
Last_Mod_By_User_ID, Last_Mod_Date, Repair_Code_Id, EM_Issue_Id, Task_Header_Id, Part_Description,   
Group_Description, SIMS_Code_Id, Rotable_Remove_Id, Rotable_Inuse_Id, Strategy_Repair_Description, Sort_Order,   
WO_Create_Date, Performed_By_Date, WO_Counter,   
Work_Order_Number_External, Cost_Bearer_ID, Task_Warranty, Redo_Work_Order_ID, View_Warranty, Health_Safety_Id,   
Break_Down, Planned_Down_Time, Actual_Down_Time, Planned_Offset, Final_Change, Risk_Life_Left,   
Strategy_Frequency, Last_Performed, Last_Scheduled, Last_Performed_Date, Last_Scheduled_Date, Site_Id,   
Work_Location, Cost_Centre_Id, Branch_Id, Customer_Id, Part_Entry_Distribution_Code_Id,   
Def_Work_Group_Id, Parts_Cost_Expense_Id, Labour_Cost_Expense_Id, Misc_Cost_Expense_Id,   
Specific_Operation_Codes, Work_Order_Date, Warranty_Claimable, Reviewed_Employee_Id, Warranty_Notes,   
Warranty_Days, Warranty_Usage, Warranty_Days_Archived,   
Warranty_Usage_Acrhived, Warranty_Supplier_Id, Claim_Ref, Supplier_Ref, Summary_Description, Claim_Status_Id,   
Claimed_By_Employee_Id, Claime_Date, Claim_Description, Job_Parts_Cost, Job_Labour_Cost, Job_Misc_Cost,   
Claimed_Parts_Cost, Claimed_Labour_Cost, Claimed_Misc_Cost, Rec_Parts_Cost, Rec_Labour_Cost, Rec_Misc_Cost,   
Labour_Entry_Distribution_Code_Id, Misc_Entry_Distribution_Code_Id, Supplier_Contact,  
Task_Authorised,Task_Authorised_By_Id,Task_Authorised_Date,ActualOffset,AMTPlanningModeId, ChangeoutCategoryId,  
LifeConfirmed, OriginalPartTypeId,/*VV E602*/ SerialNoInId, SerialNoOutId,IsOverwriteLife,OverwriteLifeAchieved, WOCreateFromPO,  
Task_Authorised_Amount,Task_Authorised_TolerancePct,ConditionMonitoringIntervention,  
FailedPartListPosition,FailedPartListGroup,FailedPartLifeAchieved,PartSerialNoRemoved,PartSerialNoInstalled,WarrantyClaimByUserId,WarrantyClaimSystemDate,  
/*VV CR8449*/ Create_By_User_ID,Create_Date,LastNotified,AuthorisationRequestByID,AuthorisationRequestDate,  
ResourceStatusReady,ElectronicWorkscopeLinked,  
/*VV E621*/RebuildWO,RebuildJobNumber,ReceiptedIntoStock,RebuildPartTypeId,RebuildPartId,  
DeliveryToWorkshop,WaitingForRebuild,RebuildTime,DeliveryToWarehouse,RebuildTaskId)  
  
SELECT       
Task_ID,   
CASE WHEN Event_ID>0 THEN Event_ID   
     WHEN @EventId<0 THEN @EventId   
     ELSE Event_ID  END AS Event_ID,   
Description, Eqp_Plan_ID, Task_Type_ID, Component_Code_ID, Modifier_ID, Application_Code_ID,   
Occurrence_Type_Id, Priority_ID, Source_ID,   
CASE WHEN @EventId<0 THEN @TaskStatusYTS ELSE Task_Status_ID END,   
Date_Notified, Component_ID, Symptom_ID,   
Symptom_Notes, Cause_ID, Cause_Notes, Repair_Notes,Group_No, Part_No, EMI_Ref, Redo, Task_Planned_Time_ID,   
Customer_Ref, Employee_ID, Expected_Duration, Expected_Labor_Hours, Planning_Notes, Work_Order, Actual_Duration,   
Actual_Labor_Hrs, Primary_Cause, Notes, Task_Mode_ID,   
PartsStatusRequired, PartsStatusOrdered, PartsStatusReady,  
RaisedByID,  
Work_Order_ID, Strategy_Usage, Work_Group_ID,   
Strategy_QUOM_ID, Strategy_Proj_Task_Opt_ID, Planned_Proj_Task_Opt_ID,   
CASE WHEN (O.ProjTaskOptId > 0 OR PT.Planning_Task = 1) THEN 1 ELSE 0 END , -- 751  
Strategy_Date, Strategy_Locked,   
TASK.Last_Mod_By_User_ID, TASK.Last_Mod_Date, Repair_Code_Id, EM_Issue_Id, TASK.Task_Header_Id, Part_Description,   
Group_Description, SIMS_Code_Id, Rotable_Remove_Id, Rotable_Inuse_Id,
TASK.Strategy_Repair_Description, 
Sort_Order,   
WO_Create_Date, Performed_By_Date, WO_Counter,   
Work_Order_Number_External, Cost_Bearer_ID, Task_Warranty, Redo_Work_Order_ID, View_Warranty, Health_Safety_Id,   
Break_Down, Planned_Down_Time, Actual_Down_Time, Planned_Offset, Final_Change, Risk_Life_Left,   
Strategy_Frequency, Last_Performed, Last_Scheduled, Last_Performed_Date, Last_Scheduled_Date, TASK.Site_Id,   
Work_Location, Cost_Centre_Id, Branch_Id, Customer_Id, Part_Entry_Distribution_Code_Id,   
Def_Work_Group_Id, Parts_Cost_Expense_Id, Labour_Cost_Expense_Id, Misc_Cost_Expense_Id,   
Specific_Operation_Codes, Work_Order_Date, Warranty_Claimable, Reviewed_Employee_Id, Warranty_Notes,   
Warranty_Days, Warranty_Usage, Warranty_Days_Archived,   
Warranty_Usage_Acrhived, Warranty_Supplier_Id, Claim_Ref, Supplier_Ref, Summary_Description, Claim_Status_Id,   
Claimed_By_Employee_Id, Claime_Date, Claim_Description, Job_Parts_Cost, Job_Labour_Cost, Job_Misc_Cost,   
Claimed_Parts_Cost, Claimed_Labour_Cost, Claimed_Misc_Cost, Rec_Parts_Cost, Rec_Labour_Cost, Rec_Misc_Cost,   
Labour_Entry_Distribution_Code_Id, Misc_Entry_Distribution_Code_Id, Supplier_Contact,  
Task_Authorised,Task_Authorised_By_Id,Task_Authorised_Date,ActualOffset,AMTPlanningModeId,ChangeoutCategoryId,  
LifeConfirmed, OriginalPartTypeId,/*VV E602*/ SerialNoInId, SerialNoOutId,IsOverwriteLife,OverwriteLifeAchieved, @WOCreateFromPO,  
Task_Authorised_Amount,Task_Authorised_TolerancePct,ConditionMonitoringIntervention,  
FailedPartListPosition,FailedPartListGroup,FailedPartLifeAchieved,FailedGroupListPosition AS PartSerialNoRemoved,FailedGroupPartsListGroup AS PartSerialNoInstalled,WarrantyClaimByUserId,WarrantyClaimSystemDate,  
TASK.Create_By_User_ID,TASK.Create_Date,  
TASK.LastNotified,  
TASK.AuthorisationRequestByID,  
TASK.AuthorisationRequestDate,  
TASK.ResourceStatusReady,@ElectronicWorkscopeLinked as ElectronicWorkscopeLinked/*GW E560*/,  
/*VV E621*/TASK.RebuildWO,TASK.RebuildJobNumber,TASK.ReceiptedIntoStock,TASK.RebuildPartTypeId,  
TASK.RebuildPartId,TASK.DeliveryToWorkshop,TASK.WaitingForRebuild,TASK.RebuildTime,  
TASK.DeliveryToWarehouse,TASK.RebuildTaskId  
  
FROM TASK   
LEFT JOIN tblProjTaskOpts O  
 ON TASK.Strategy_Proj_Task_Opt_ID = O.ProjTaskOptId   
LEFT JOIN tblProjTasks PT  
 ON O.ProjTaskId = PT.ProjTaskId    


WHERE Task_Id=@task_ID  
  
  
DECLARE @z_EVENT TABLE (Event_Id int, Eqp_Plan_Id int, Actual_Down_Time datetime,Planned_Down_Time datetime,Planned_Up_Time datetime,  
Break_Down bit,Linked bit,EventDescription varchar(500) Primary Key(Event_Id))  
  
-- Check that the task is not deferred in the event  
  
IF @EventId>0   
BEGIN  
 IF EXISTS(SELECT Task_Id,Event_Id FROM DEFERRED_TASK WHERE Task_Id=@Task_Id AND Event_Id=@EventId)  
 BEGIN  
  -- the task is retreived for the event and it is deferred in the Event  
  UPDATE T  
  SET T.Event_Id=@EventId,  
  T.Task_Status_Id=DT.Task_Status_Id,  
  T.Primary_Cause=DT.Primary_Cause  
  FROM  
  @z_Task T  
   INNER JOIN  
  DEFERRED_TASK DT  
   ON T.Task_Id=DT.Task_Id AND DT.Event_Id=@EventId  
 END  
END  
  
--Check if Task is in Event  
SELECT @EventId=ISNULL(Event_Id,0) FROM @z_TASK  
  
IF @EventId>0  
BEGIN  
 --Check whether the Event has records in HOLDING_EVENT  
 IF EXISTS(SELECT * FROM HOLDING_EVENT WHERE Event_ID=@EventId) SET @Has_Records_In_Holding_Event=1  
  
 INSERT INTO @z_EVENT(Event_Id ,Eqp_Plan_Id, Actual_Down_Time,Planned_Down_Time,Planned_Up_Time,Break_Down,Linked,EventDescription)  
 SELECT EV.Event_Id,EV.Eqp_Plan_Id,EV.Actual_Down_Time,EV.Planned_Down_Time,Planned_Up_Time,EV.Break_Down,  
 @Has_Records_In_Holding_Event AS Linked,[Description] AS EventDescription  
 FROM EVENT EV   
 WHERE EV.Event_Id=@EventId   
END  
  
  
-- Rotable details. This was copied from EVENT_TASKS_GET_P.   
-- The logic is taken from ROTABLE_RECORD_TASK_GET_V.   
-- Temp table @z_ROTABLE_RECORD_TASK_GET_V contains values   
-- for rotable details from ROTABLE_RECORD_TASK_GET_V  
DEclare @z_ROTABLE_RECORD_TASK_GET_V TABLE   
 (  
 Task_ID int ,  
 RotIdIn varchar (50)  ,  
 PartNumIn varchar (50)  ,  
 GroupNumIn varchar (50)  ,  
 RemanPartNumIn varchar (50)  ,  
 RotIdRemove varchar (50)  ,  
 PartNumRemove varchar (50)  ,  
 GroupNumRemove varchar (50)  ,  
 ActReqId int  ,  
 ActReq varchar (50)  ,  
 RebuildLocId int  ,  
 RebuildLoc varchar (50)  ,  
 Event_ID int  ,  
 Eqp_Plan_ID int,  
 RotableInuseId int  ,  
 RotableRemoveId int  ,  
 AvailForRebuild bit  ,  
 RemanIn bit   
 PRIMARY KEY  (Task_ID)  
)   
  
/*ROTABLE_RECORD_TASK_GET_V (0)  
 (1) ROTABLE_TASK_GET_V  
  (1.1) ROTABLE_INUSE_REMOVE_GET_V  
   (1.1.1) ROTABLE_INUSE_REGISTERED_V - leave  
   (1.1.2) ROTABLE_IN_USE_PREV_03_V   
    (1.1.2.1) ROTABLE_IN_USE_PREV_01_V  
           (1.1.2.2) ROTABLE_IN_USE_PREV_02_V  
     (1.1.2.2.1) ROTABLE_IN_USE_PREV_01_V (same view (1.1.2.1) and used to find max prev)  
 (2) ROTABLE_TASK_GET_2_V  
  
*/  
  
IF @EventId>=0  
BEGIN  
 --(1)  
 INSERT INTO @z_ROTABLE_RECORD_TASK_GET_V  
  
/* SELECT       
 T.Task_ID, RI_IU.Rotable_Item_Id AS RotIdIn, RP_IU.Part_Number AS PartNumIn, RP_IU.Group_Number AS GroupNumIn,   
 RP_IU.Reman_Part_Number AS RemanPartNumIn, ISNULL(RM.Rotable_Item_Id, Prev_IU.Rotable_Item_Id) AS RotIdRemove,   
 ISNULL(RP_RM.Part_Number, RP_PrevIU.Part_Number) AS PartNumRemove, ISNULL(RP_RM.Group_Number, RP_PrevIU.Group_Number)   
 AS GroupNumRemove, RM.Action_Required_Id AS ActReqId, AR.Description AS ActReq, RM.Rebuild_Location_Id AS RebuildLocId,   
 RL.Site AS RebuildLoc, T.Event_ID, T.Eqp_Plan_ID, IU.Rotable_Inuse_Id AS RotableInuseId, RM.Rotable_Remove_Id AS RotableRemoveId,   
 CAST(CASE WHEN IU.To_Remain = 1 AND IU.To_Be_Scrapped = 0 THEN 1 ELSE 0 END AS bit) AS AvailForRebuild,   
 CAST(CASE WHEN ISNULL(RP_IU.Reman_Part_Number, '') <> '' THEN 1 ELSE 0 END AS bit) AS RemanIn  
 FROM           
 ROTABLE_PART RP_RM INNER JOIN  
 ROTABLE_REMOVE RM INNER JOIN  
 ROTABLE_ITEM RI_RM ON RM.Rotable_Item_Id = RI_RM.Rotable_Item_Id ON RP_RM.Rotable_Part_Id = RI_RM.Rotable_Part_Id INNER JOIN  
 ACTION_REQUIRED AR ON RM.Action_Required_Id = AR.Action_Required_Id INNER JOIN  
 tblSites RL ON RM.Rebuild_Location_Id = RL.SiteId RIGHT OUTER JOIN  
 ROTABLE_INUSE IU INNER JOIN  
 ROTABLE_ITEM RI_IU ON IU.Rotable_Item_Id = RI_IU.Rotable_Item_Id INNER JOIN  
 ROTABLE_PART RP_IU ON RI_IU.Rotable_Part_Id = RP_IU.Rotable_Part_Id RIGHT OUTER JOIN  
 @z_TASK T INNER JOIN  
  
 (SELECT       
 PTO.ProjTaskId, E.Eqp_Plan_ID, E.Actual_Down_Time, T.Task_ID, T.Rotable_Remove_Id, ISNULL(RIUP.Prev_Rotable_InUse_ID,   
        RIUR.Rotable_Inuse_Id) AS Prev_Inuse_Id, E.Event_ID  
 FROM           
 @z_TASK T INNER JOIN  
 tblProjTaskOpts PTO ON T.Planned_Proj_Task_Opt_ID = PTO.ProjTaskOptId INNER JOIN  
 @z_EVENT E ON T.Event_ID = E.Event_ID INNER JOIN  
 ROTABLE_INUSE RIU ON PTO.ProjTaskId = RIU.Proj_Task_Id LEFT OUTER JOIN  
  
 ROTABLE_INUSE_REGISTERED_V RIUR ON PTO.ProjTaskId = RIUR.Proj_Task_Id LEFT OUTER JOIN  
  
 (SELECT       
 RIUP1.Event_ID, RIUP1.Task_ID, RIUP1.ProjTaskId, RIUP1.Eqp_Plan_ID, RIUP1.Rotable_Inuse_Id,   
 RIUP1.Actual_Down_Time, RIUP1.Prev_TaskID, RIUP1.Prev_DownTime, RIUP1.Prev_Rotable_InUse_ID  
 FROM           
 (SELECT       
 T.Task_ID,MAX(PrevEvent.Actual_Down_Time) AS Max_PrevDowntime  
 FROM           
 EVENT PrevEvent INNER JOIN  
 tblProjTaskOpts PrevPTO INNER JOIN  
 TASK PrevTask ON PrevPTO.ProjTaskOptId = PrevTask.Strategy_Proj_Task_Opt_ID ON PrevEvent.Event_ID = PrevTask.Event_ID INNER JOIN  
 @z_TASK T INNER JOIN  
 @z_EVENT E ON T.Event_ID = E.Event_ID ON PrevEvent.Actual_Down_Time < E.Actual_Down_Time INNER JOIN  
 tblProjTaskOpts PTO ON T.Strategy_Proj_Task_Opt_ID = PTO.ProjTaskOptId AND PrevPTO.ProjTaskId = PTO.ProjTaskId  
 WHERE   
 T.rotable_inuse_id * T.rotable_remove_id IS NULL and  
 PrevTask.Rotable_Inuse_Id > 0  
 GROUP BY T.Task_ID) RIUP2 /*ROTABLE_IN_USE_PREV_02_V*/INNER JOIN   
  
 (SELECT      
 E.Event_ID, T.Task_ID, PrevPTO.ProjTaskId, E.Eqp_Plan_ID, E.Actual_Down_Time, PrevTask.Task_ID AS Prev_TaskID,   
 PrevEvent.Actual_Down_Time AS Prev_DownTime, PrevTask.Rotable_Inuse_Id AS Prev_Rotable_InUse_ID, T.Rotable_Inuse_Id  
 FROM           
 EVENT PrevEvent INNER JOIN  
 tblProjTaskOpts PrevPTO INNER JOIN  
 TASK PrevTask ON PrevPTO.ProjTaskOptId = PrevTask.Strategy_Proj_Task_Opt_ID ON PrevEvent.Event_ID = PrevTask.Event_ID INNER JOIN  
 @z_TASK T INNER JOIN  
 @z_EVENT E ON T.Event_ID = E.Event_ID ON PrevEvent.Actual_Down_Time < E.Actual_Down_Time INNER JOIN  
 tblProjTaskOpts PTO ON T.Strategy_Proj_Task_Opt_ID = PTO.ProjTaskOptId AND PrevPTO.ProjTaskId = PTO.ProjTaskId  
 WHERE   
 T.rotable_inuse_id * T.rotable_remove_id IS NULL and  
 PrevTask.Rotable_Inuse_Id > 0) RIUP1 /*ROTABLE_IN_USE_PREV_01_V*/  
  
  ON RIUP2.Task_ID = RIUP1.Task_ID AND RIUP2.Max_PrevDowntime = RIUP1.Prev_DownTime  
  
  
 ) RIUP /*ROTABLE_IN_USE_PREV_03_V*/  
  
  
 ON T.Task_ID = RIUP.Task_ID  
  
 WHERE T.rotable_inuse_id * T.rotable_remove_id IS NULL  
  
 GROUP BY PTO.ProjTaskId,   
 E.Eqp_Plan_ID, E.Actual_Down_Time, T.Task_ID, T.Rotable_Remove_Id,   
 ISNULL(RIUP.Prev_Rotable_InUse_ID, T.Rotable_Inuse_Id),  
 E.Event_ID, ISNULL(RIUP.Prev_Rotable_InUse_ID, RIUR.Rotable_Inuse_Id)  
  
  
  
  
 ) RIRG /*ROTABLE_INUSE_REMOVE_GET_V*/  
  
  ON T.Task_ID = RIRG.Task_ID ON IU.Rotable_Inuse_Id = T.Rotable_Inuse_Id LEFT OUTER JOIN  
  
 ROTABLE_PART RP_PrevIU INNER JOIN  
 ROTABLE_ITEM RI_PrevIU ON RP_PrevIU.Rotable_Part_Id = RI_PrevIU.Rotable_Part_Id INNER JOIN  
 ROTABLE_INUSE Prev_IU ON RI_PrevIU.Rotable_Item_Id = Prev_IU.Rotable_Item_Id ON RIRG.Prev_Inuse_Id = Prev_IU.Rotable_Inuse_Id ON   
 RM.Rotable_Remove_Id = RIRG.Rotable_Remove_Id  
 WHERE T.rotable_inuse_id * T.rotable_remove_id IS NULL  
*/  
 SELECT     T.Task_ID, RI_IU.Rotable_Item_Id AS RotIdIn, RP_IU.Part_Number AS PartNumIn, RP_IU.Group_Number AS GroupNumIn,   
                      RP_IU.Reman_Part_Number AS RemanPartNumIn, ISNULL(RM.Rotable_Item_Id, Prev_IU.Rotable_Item_Id) AS RotIdRemove,   
                      ISNULL(RP_RM.Part_Number, RP_PrevIU.Part_Number) AS PartNumRemove, ISNULL(RP_RM.Group_Number, RP_PrevIU.Group_Number)   
                      AS GroupNumRemove, RM.Action_Required_Id AS ActReqId, AR.Description AS ActReq, RM.Rebuild_Location_Id AS RebuildLocId,   
                      RL.Site AS RebuildLoc, T.Event_ID, T.Eqp_Plan_ID, IU.Rotable_Inuse_Id AS RotableInuseId, RM.Rotable_Remove_Id AS RotableRemoveId,   
                      CAST(CASE WHEN IU.To_Remain = 1 AND IU.To_Be_Scrapped = 0 THEN 1 ELSE 0 END AS bit) AS AvailForRebuild,   
                      CAST(CASE WHEN ISNULL(RP_IU.Reman_Part_Number, '') <> '' THEN 1 ELSE 0 END AS bit) AS RemanIn  
 /* VV #516 */  
    FROM         dbo.ROTABLE_PART AS RP_PrevIU INNER JOIN  
                      dbo.ROTABLE_ITEM AS RI_PrevIU ON RP_PrevIU.Rotable_Part_Id = RI_PrevIU.Rotable_Part_Id INNER JOIN  
                      dbo.ROTABLE_INUSE AS Prev_IU ON RI_PrevIU.Rotable_Item_Id = Prev_IU.Rotable_Item_Id RIGHT OUTER JOIN  
                      dbo.ROTABLE_INUSE AS IU INNER JOIN  
                      dbo.ROTABLE_ITEM AS RI_IU ON IU.Rotable_Item_Id = RI_IU.Rotable_Item_Id INNER JOIN  
                      dbo.ROTABLE_PART AS RP_IU ON RI_IU.Rotable_Part_Id = RP_IU.Rotable_Part_Id RIGHT OUTER JOIN  
                      dbo.tblSites AS RL RIGHT OUTER JOIN  
                          (SELECT     PTO.ProjTaskId, E.Eqp_Plan_Id, E.Actual_Down_Time, T.Task_ID, T.Rotable_Remove_Id, ISNULL(RIUP.Prev_Rotable_InUse_ID,   
                                                   RIUR.Rotable_Inuse_Id) AS Prev_Inuse_Id, E.Event_Id  
                            FROM          @z_Task AS T INNER JOIN  
                                                   dbo.tblProjTaskOpts AS PTO ON T.Planned_Proj_Task_Opt_ID = PTO.ProjTaskOptId INNER JOIN  
                                                   @z_EVENT AS E ON T.Event_ID = E.Event_Id INNER JOIN  
                                                   dbo.ROTABLE_INUSE AS RIU ON PTO.ProjTaskId = RIU.Proj_Task_Id LEFT OUTER JOIN  
                                                   dbo.ROTABLE_INUSE_REGISTERED_V AS RIUR ON PTO.ProjTaskId = RIUR.Proj_Task_Id LEFT OUTER JOIN  
                                                       (SELECT     RIUP1.Event_Id, RIUP1.Task_ID, RIUP1.ProjTaskId, RIUP1.Eqp_Plan_Id, RIUP1.Rotable_Inuse_Id,   
                                                                                RIUP1.Actual_Down_Time, RIUP1.Prev_TaskID, RIUP1.Prev_DownTime, RIUP1.Prev_Rotable_InUse_ID  
                                                         FROM          (SELECT     T.Task_ID, MAX(PrevEvent.Actual_Down_Time) AS Max_PrevDowntime  
                                                                                 FROM          dbo.EVENT AS PrevEvent INNER JOIN  
                                                                                                        dbo.tblProjTaskOpts AS PrevPTO INNER JOIN  
                                                                                                        dbo.TASK AS PrevTask ON PrevPTO.ProjTaskOptId = PrevTask.Strategy_Proj_Task_Opt_ID ON   
                                                                                                        PrevEvent.Event_ID = PrevTask.Event_ID INNER JOIN  
                                                                                                        @z_Task AS T INNER JOIN  
                                                                                                        @z_EVENT AS E ON T.Event_ID = E.Event_Id ON   
                                                                                                        PrevEvent.Actual_Down_Time < E.Actual_Down_Time INNER JOIN  
                                                                                                        dbo.tblProjTaskOpts AS PTO ON T.Strategy_Proj_Task_Opt_ID = PTO.ProjTaskOptId AND   
                                                                                                        PrevPTO.ProjTaskId = PTO.ProjTaskId  
                                                                                 WHERE      (T.Rotable_Inuse_Id * T.Rotable_Remove_Id IS NULL) AND (PrevTask.Rotable_Inuse_Id > 0)  
                                                                                 GROUP BY T.Task_ID) AS RIUP2 INNER JOIN  
                                                                      (SELECT     E.Event_Id, T.Task_ID, PrevPTO.ProjTaskId, E.Eqp_Plan_Id, E.Actual_Down_Time,   
                                                                                                             PrevTask.Task_ID AS Prev_TaskID, PrevEvent.Actual_Down_Time AS Prev_DownTime,   
                                                                                                             PrevTask.Rotable_Inuse_Id AS Prev_Rotable_InUse_ID, T.Rotable_Inuse_Id  
                                                                                      FROM          dbo.EVENT AS PrevEvent INNER JOIN  
                                                                                                             dbo.tblProjTaskOpts AS PrevPTO INNER JOIN  
                                                                                                             dbo.TASK AS PrevTask ON PrevPTO.ProjTaskOptId = PrevTask.Strategy_Proj_Task_Opt_ID ON   
                                                                                                             PrevEvent.Event_ID = PrevTask.Event_ID INNER JOIN  
                                                                                                             @z_Task AS T INNER JOIN  
                                                                                                             @z_EVENT AS E ON T.Event_ID = E.Event_Id ON   
                                                                                                             PrevEvent.Actual_Down_Time < E.Actual_Down_Time INNER JOIN  
                                                                                                             dbo.tblProjTaskOpts AS PTO ON T.Strategy_Proj_Task_Opt_ID = PTO.ProjTaskOptId AND   
                                                                                                             PrevPTO.ProjTaskId = PTO.ProjTaskId  
                                                                                      WHERE      (T.Rotable_Inuse_Id * T.Rotable_Remove_Id IS NULL) AND (PrevTask.Rotable_Inuse_Id > 0)) AS RIUP1 ON   
                                                                                RIUP2.Task_ID = RIUP1.Task_ID AND RIUP2.Max_PrevDowntime = RIUP1.Prev_DownTime) AS RIUP ON   
                                                   T.Task_ID = RIUP.Task_ID  
                            WHERE      (T.Rotable_Inuse_Id * T.Rotable_Remove_Id IS NULL)  
                            GROUP BY PTO.ProjTaskId, E.Eqp_Plan_Id, E.Actual_Down_Time, T.Task_ID, T.Rotable_Remove_Id, ISNULL(RIUP.Prev_Rotable_InUse_ID,   
                                                   T.Rotable_Inuse_Id), E.Event_Id, ISNULL(RIUP.Prev_Rotable_InUse_ID, RIUR.Rotable_Inuse_Id)) AS RIRG RIGHT OUTER JOIN  
                      @z_TASK AS T LEFT OUTER JOIN  
                      dbo.ROTABLE_PART AS RP_RM INNER JOIN  
                      dbo.ROTABLE_REMOVE AS RM INNER JOIN  
                      dbo.ROTABLE_ITEM AS RI_RM ON RM.Rotable_Item_Id = RI_RM.Rotable_Item_Id ON RP_RM.Rotable_Part_Id = RI_RM.Rotable_Part_Id ON   
                      T.Rotable_Remove_Id = RM.Rotable_Remove_Id ON RIRG.Task_ID = T.Task_ID LEFT OUTER JOIN  
                      dbo.ACTION_REQUIRED AS AR ON RM.Action_Required_Id = AR.Action_Required_Id ON RL.SiteId = RM.Rebuild_Location_Id ON   
                      IU.Rotable_Inuse_Id = T.Rotable_Inuse_Id ON Prev_IU.Rotable_Inuse_Id = RIRG.Prev_Inuse_Id  
 WHERE     (T.Rotable_Inuse_Id * T.Rotable_Remove_Id IS NULL)  
  
 UNION  
  
 --(2)  
  
  
 /*SELECT     
 RTG2.Task_ID, RTG2.RotIdIn, RTG2.PartNumIn, RTG2.GroupNumIn, RTG2.RemanPartNumIn, RTG2.RotIdRemove,   
 RTG2.PartNumRemove, RTG2.GroupNumRemove,RTG2.ActReqId, RTG2.ActReq, RTG2.RebuildLocId,RTG2.RebuildLoc,   
 RTG2.Event_ID, RTG2.Eqp_Plan_ID, RTG2.RotableInuseId, RTG2.RotableRemoveId,   
 RTG2.AvailForRebuild, RTG2.RemanIn  
 FROM           
 ROTABLE_TASK_GET_2_V RTG2 inner join  
  @z_TASK T On RTG2.Task_Id=T.Task_Id*/  
    
  
 --ROTABLE_TASK_GET_2_V  
  
 SELECT       
 T.Task_ID, RIU.Rotable_Item_Id AS RotIdIn, RP_IU.Part_Number AS PartNumIn, RP_IU.Group_Number AS GroupNumIn,   
 RP_IU.Reman_Part_Number AS RemanPartNumIn, RR.Rotable_Item_Id AS RotIdRemove, RP_RM.Part_Number AS PartNumRemove,   
 RP_RM.Group_Number AS GroupNumRemove, AR.Action_Required_Id AS ActReqId, AR.Description AS ActReq, S.SiteId AS RebuildLocId,   
 S.Site AS RebuildLoc, E.Event_ID, E.Eqp_Plan_ID, T.Rotable_Inuse_Id AS RotableInuseId, T.Rotable_Remove_Id AS RotableRemoveId,   
 CAST(CASE WHEN RIU_1.To_Be_Scrapped = 0 AND ISNULL(RIU_1.To_Remain, 0) = 1 THEN 1 ELSE 0 END AS bit) AS AvailForRebuild,   
 CAST(ISNULL(RIU_1.To_Remain, 0) AS bit) AS RemanIn  
 FROM           
 ROTABLE_PART RP_RM INNER JOIN  
 ROTABLE_ITEM RI_RM ON RP_RM.Rotable_Part_Id = RI_RM.Rotable_Part_Id INNER JOIN  
 @z_TASK T INNER JOIN  
 ROTABLE_INUSE RIU ON T.Rotable_Inuse_Id = RIU.Rotable_Inuse_Id INNER JOIN  
 ROTABLE_REMOVE RR ON T.Rotable_Remove_Id = RR.Rotable_Remove_Id INNER JOIN  
 ROTABLE_ITEM RI_IU ON RIU.Rotable_Item_Id = RI_IU.Rotable_Item_Id INNER JOIN  
 ROTABLE_PART RP_IU ON RI_IU.Rotable_Part_Id = RP_IU.Rotable_Part_Id ON RI_RM.Rotable_Item_Id = RR.Rotable_Item_Id LEFT OUTER JOIN  
 tblSites S ON RR.Rebuild_Location_Id = S.SiteId INNER JOIN  
 @z_EVENT E ON T.Event_ID = E.Event_ID INNER JOIN  
 ROTABLE_INUSE RIU_1 ON RR.Rotable_InUse_Id = RIU_1.Rotable_Inuse_Id LEFT OUTER JOIN  
 ACTION_REQUIRED AR ON RR.Action_Required_Id = AR.Action_Required_Id  
END  
  
SELECT       
@CompanyCode=D.Company_Code,  
/*VV E621*/@EqpSite=S.Site,@EqpCustomer=ISNULL(CUE.Customer,CU.Customer)  
FROM   
@z_TASK T INNER JOIN   
tblEqpPlans AS EP ON EP.EqpPlanId=T.Eqp_Plan_Id INNER JOIN  
tblFleets AS F ON EP.FleetId = F.FleetId INNER JOIN  
tblSites AS S ON F.SiteId = S.SiteId INNER JOIN  
tblDealers AS D INNER JOIN  
tblBranches AS B ON D.DealerId = B.DealerId ON S.BranchId = B.BranchId  
/*VV E621*/  
 LEFT JOIN  
tblContracts C  
 ON EP.ContractId=C.ContractId  
 LEFT JOIN  
tblCustomers CU  
 ON C.CustomerId=CU.CustomerId  
 LEFT JOIN  
tblCustomers CUE  
 ON EP.Customer_Id=CUE.CustomerId   
  
SET @OpNum=(SELECT COUNT(Task_Operation_Id) FROM TASK_OPERATION WHERE Task_Id=@Task_id)  
  
/*VV E621*/  
SELECT   
@ChangeoutStrategyDate=CASE WHEN T.Strategy_Proj_Task_Opt_ID>0 THEN T.Strategy_Date ELSE NULL END,   
@ChangeoutPlannedDate= CASE WHEN T.Task_Status_ID IN(@TaskStatusYTS,@TaskStatusIP,@TaskStatusC,@TaskStatusA) THEN   
 dbo.WO_DOWN_TIME_F(ISNULL(E.Planned_Down_Time,T.Planned_Down_Time),T.Planned_Offset)   
ELSE NULL END,  
@ChangeoutActualDate= CASE WHEN T.Task_Status_ID IN(@TaskStatusIP,@TaskStatusC) THEN  
dbo.WO_DOWN_TIME_F(ISNULL(E.Actual_Down_Time,T.Actual_Down_Time),T.ActualOffset) END,  
@ChangeoutLifeAchived= WPROJ.TotalLife,@ChangeoutSerialNoOut=C.ComponentSerialNo,  
@ParentTaskId=T.Task_Id  
FROM  
@z_TASK Z  
 INNER JOIN  
TASK T  
 ON Z.Task_ID=T.RebuildTaskId  
 LEFT JOIN  
EVENT E  
 ON T.Event_ID=E.Event_ID  
 LEFT JOIN  
tblProjTaskOpts PTO ON  
 T.Strategy_Proj_Task_Opt_Id=PTO.ProjTaskOptId  
 LEFT JOIN  
tblProjTasks PT  
 ON PTO.ProjTaskId=PT.ProjTaskId  
 LEFT JOIN   
tblWOrkOrderProjs WPROJ   
 ON WPROJ.ProjTaskId = PT.ProjTaskId AND WPROJ.WorkOrderId = T.Work_Order_ID  
 LEFT JOIN   
COMPONENT_SERIALISED C  
 ON T.SerialNoOutId=C.ComponentSerialisedId  
   
  
DECLARE @WarrantyParts bit  
DECLARE @count int  
  
SELECT @count=COUNT(*)  
FROM    PARTS_POTENTIAL_WARRANTY AS PPW INNER JOIN  
        (SELECT W.PureWONumber AS WorkorderNo, REPLACE(REPLACE(W.WorkOrderNumber, W.PureWONumber, ''), '-', '') AS SegmentNo--,P.Part_Number  
         FROM TASK AS T INNER JOIN  
                tblWorkOrders AS W ON T.Work_Order_ID = W.WorkOrderId   
         WHERE      (T.Task_ID = @Task_id)) AS A ON PPW.WorkorderNo = A.WorkorderNo   
             AND PPW.SegmentNo = A.SegmentNo    
  
SET @WarrantyParts=CASE WHEN ISNULL(@count,0)=0 THEN 0 ELSE 1 END  
  
--Task details  
SELECT      
T.Task_ID, T.Primary_Cause AS PC, TT.Code + ' - ' + TT.Description AS [Task Type],   
CC.Code + ' - ' + CC.Description AS [Component Code],   
MC.Code + ' - ' + MC.Description AS [Modifier Code],   
T.Description AS [Backlog Description],   
TS.Description AS [Task Status],   
PR.Description AS Priority, LEFT(EM.First_Name, 1)   
+ '. ' + EM.Surname AS Employee,   
T.Task_Status_ID, T.Event_ID, T.Eqp_Plan_ID,   
T.Task_Type_ID, T.Component_Code_ID, T.Modifier_ID, T.Application_Code_ID, T.Occurrence_Type_Id,   
T.Priority_ID, T.Source_ID, T.Date_Notified, T.Component_ID, T.Symptom_ID, T.Symptom_Notes,   
T.Cause_ID, T.Cause_Notes, T.Repair_Code_Id, T.Repair_Notes, T.Group_No, T.Part_No,   
T.EMI_Ref, T.Redo, T.Task_Planned_Time_ID, T.Customer_Ref, T.Employee_ID,   
T.Expected_Duration, T.Expected_Labor_Hours, T.Planning_Notes,   
CASE WHEN T.Work_Order_ID IS NULL AND   
WO_Create_Date IS NOT NULL THEN ISNULL(T.Work_Order_Number_External, '') + '<DUE>'   
ELSE T.Work_Order END AS Work_Order,   
T.Actual_Duration, T.Actual_Labor_Hrs, T.Notes, T.Task_Mode_ID,   
T.PartsStatusRequired, T.PartsStatusOrdered, T.PartsStatusReady,  
T.RaisedByID, RBEM.Surname + ', ' + RBEM.First_Name AS RaisedBy,  
T.Last_Mod_By_User_ID,   
CONVERT(varchar(25), T.Last_Mod_Date, 21) AS Last_Mod_Date,    
AC.Code + ' - ' + AC.Description AS Application_Code,   
C.Description AS Cause, EP.EqpPlan,   
OT.OccurrenceType + ' - ' + OT.OccurrenceTypeDesc AS Occurrence_Type,   
JC.Code+' - '+JC.Description AS Repair_Code,   
S.Description AS Source, SY.Description AS Symptom,   
TPT.Description AS Task_Planned_Time, T.Work_Group_ID,   
WG.Description AS WorkGroupDisplay, T.Strategy_Usage, T.Strategy_QUOM_ID,   
T.Strategy_Proj_Task_Opt_ID, T.Planned_Proj_Task_Opt_ID, T.Strategy_Date, T.Strategy_Locked,   
CASE WHEN T.Strategy_Proj_Task_Opt_ID>0 AND T.Strategy_QUOM_ID IS NULL THEN 'Days' ELSE QUOMS.UOMShortDesc END AS QUOM_Display,   
T.Work_Order_ID,EV.Actual_Down_Time AS Event_Actual_Down_Time, T.EM_Issue_Id AS EMIssueId,   
E.ModelId, M.Model, T.Part_Description, T.Group_Description,   
T.SIMS_Code_Id, SIMS.SIMS_Code + ' - ' + SIMS.Description AS SIMS_Code,  
T.Strategy_Repair_Description,rot.RemanIn, rot.RotIdIn, rot.PartNumIn, rot.GroupNumIn,   
rot.RemanPartNumIn, rot.RotIdRemove, rot.PartNumRemove, rot.GroupNumRemove, rot.AvailForRebuild, rot.ActReqId, rot.ActReq,   
rot.RebuildLocId, rot.RebuildLoc, rot.RotableInuseId, rot.RotableRemoveId,   
T.Sort_Order, T.WO_Create_Date,  
 ISNULL(P.Part, RP.Part_Number) AS Strategy_Part_Num,   
CASE WHEN (T.Strategy_Proj_Task_Opt_ID <=0 AND PT.Planning_Task = 0) THEN   
 T.Performed_By_Date ELSE ISNULL(Strategy_Date,T.Performed_By_Date) END AS Performed_By_Date,-- 751  
T.WO_Counter, T.Work_Order_Number_External, T.Cost_Bearer_ID, CB.CostBearer,   
T.Task_Warranty, T.Redo_Work_Order_ID AS RedoWorkOrderID, WO.WorkOrderNumber AS RedoWorkOrder,  
T.View_Warranty, T.Health_Safety_Id, HS.Health_Safety,  
ISNULL(EV.Break_Down,T.Break_Down) AS Break_Down,T.Planned_Down_Time,  
T.Actual_Down_Time, T.Planned_Offset, T.Final_Change, T.Risk_Life_Left, T.Strategy_Frequency,   
T.Last_Performed, T.Last_Scheduled, T.Last_Performed_Date, T.Last_Scheduled_Date,   
T.Site_Id, SI.Site,T.Work_Location, T.Cost_Centre_Id,   
COC.Cost_Centre_Code+' - '+COC.Cost_Centre_Desc AS Cost_Centre,  
T.Branch_Id, B.Branch,T.Customer_Id, CU.Customer,  
T.Part_Entry_Distribution_Code_Id,   
EDC.EDC_Id + ' - ' + EDC.Journal_Description + ' : ' + EDC.Debit_Account + '.' + EDC.Debit_Account_Suffix AS Parts_EDC,  
T.Def_Work_Group_Id, DWG.Description AS Def_Work_Group,  
T.Parts_Cost_Expense_Id, CEP.Cost_Expense_Code+' - '+CEP.Cost_Expense_Desc AS Parts_Cost_Expense,  
T.Labour_Cost_Expense_Id, CEL.Cost_Expense_Code+' - '+CEL.Cost_Expense_Desc AS Labour_Cost_Expense,  
T.Misc_Cost_Expense_Id, CEM.Cost_Expense_Code+' - '+CEM.Cost_Expense_Desc AS Misc_Cost_Expense,  
T.Specific_Operation_Codes, T.Work_Order_Date, T.Warranty_Claimable,   
T.Reviewed_Employee_Id, LEFT(REM.First_Name, 1) + '. ' + REM.Surname AS Reviewed_Employee,  
T.Warranty_Notes, T.Warranty_Days, T.Warranty_Usage,   
T.Warranty_Days_Archived, T.Warranty_Usage_Acrhived,   
T.Warranty_Supplier_Id, SU.Supplier_Name AS Warranty_Supplier,T.Claim_Ref, T.Supplier_Ref,   
T.Summary_Description, T.Claim_Status_Id, CS.Claim_Status,  
  
T.Claimed_By_Employee_Id, LEFT(CBEM.First_Name, 1) + '. ' + CBEM.Surname AS Claimed_By_Employee,  
  
T.Claime_Date, T.Claim_Description, T.Job_Parts_Cost, T.Job_Labour_Cost, T.Job_Misc_Cost,   
T.Claimed_Parts_Cost, T.Claimed_Labour_Cost, T.Claimed_Misc_Cost, T.Rec_Parts_Cost, T.Rec_Labour_Cost,   
T.Rec_Misc_Cost, T.Labour_Entry_Distribution_Code_Id,   
LEDC.EDC_Id + ' - ' + LEDC.Journal_Description + ' : ' + LEDC.Debit_Account + '.' + LEDC.Debit_Account_Suffix AS Labour_EDC,  
T.Misc_Entry_Distribution_Code_Id,   
MEDC.EDC_Id + ' - ' + MEDC.Journal_Description + ' : ' + MEDC.Debit_Account + '.' + MEDC.Debit_Account_Suffix AS Misc_EDC,  
T.Supplier_Contact,T.Task_Authorised,T.Task_Authorised_By_Id,  
TAE.Amt_User_Name AS Task_Authorised_By,Task_Authorised_Date,  
PT.ProjTaskId,TH.Description AS StrategyTask,WOT.AmtStartDate AS SettlementDate,  
AWOS.AmtWorkOrderStatus,  
EV.Planned_Down_Time AS Event_Planned_Down_Time,   
EV.Planned_Up_Time AS Event_Planned_Up_Time,   
CASE T.Primary_Cause WHEN 1 THEN EV.Linked ELSE 0 END AS EventLinked,   
EV.EventDescription,  
T.ActualOffset,@CompanyCode AS CompanyCode,@OpNum AS OpNum,T.AMTPlanningModeId,  
@ChooseWODate AS ChooseWODate,@WOCreationDateFutureONLY AS WOCreationDateFutureONLY,  
T.ChangeoutCategoryId,CHC.Code as ChangeoutCategory,T.LifeConfirmed, T.OriginalPartTypeId,OPT.PartType + ' ' + OPT.PartTypeDesc AS OriginalPartType,  
/*VV E602*/  
T.SerialNoInId, T.SerialNoOutId,  
CIN.ComponentSerialNo AS SerialNoIn,  
COUT.ComponentSerialNo AS SerialNoOut,  
T.IsOverwriteLife,  
T.OverwriteLifeAchieved,  
WPROJ.TotalLife AS TotalLife,  
@WarrantyParts AS WarrantyParts,  
@WOCreateFromPO AS WOCreateFromPO,  
CONVERT(BIT,CASE WHEN WOT.AMTStatusId=2 THEN 1 ELSE 0 END) AS WOClosed,  
WOT.ClosedDate AS WOClosedDate,WOT.ClosedByUserID AS WOClosedByID,WOAU.Amt_User_Name AS WOClosedBy,  
@ACWManualWOClosure AS ManualWOClosure,  
  
T.Task_Authorised_Amount,T.Task_Authorised_TolerancePct,  
@AuthorisationMode AS AuthorisationMode,  
@AuthorisationTolerancePct AS AuthorisationTolerancePct,  
PCT.PlanPartsCost,PCT.PlanLabourCost,PCT.PlanMiscCost,  
  
EP.Description AS EqpDescription,  
  
@FeedbackPartsTab AS FeedbackPartsTab,   
@FeedbackLabourTab AS FeedbackLabourTab,   
@FeedbackMiscTab AS FeedbackMiscTab,  
@ManualEntryActualsParts AS ManualEntryActualsParts,  
@ManualEntryActualsLabour AS ManualEntryActualsLabour,  
@ManualEntryActualsMisc AS ManualEntryActualsMisc,  
@OpEditionPartsStockCode AS OpEditionPartsStockCode,  
@OpEditionPartsCB AS OpEditionPartsCB,  
@OpEditionPartsCC AS OpEditionPartsCC,  
@OpEditionPartsEE AS OpEditionPartsEE,  
@OpEditionPartsWG AS OpEditionPartsWG,  
@OpEditionLabourCB AS OpEditionLabourCB,  
@OpEditionLabourCC AS OpEditionLabourCC,  
@OpEditionLabourEE AS OpEditionLabourEE,  
@OpEditionMiscCB AS OpEditionMiscCB,  
@OpEditionMiscCC AS OpEditionMiscCC,  
@OpEditionMiscEE AS OpEditionMiscEE,  
@OpEditionMiscWG AS OpEditionMiscWG,  
@ShowOPParts_LookupPartsDetails AS ShowOPParts_LookupPartsDetails,  
@ShowOPParts_SearchPurchaseHistory AS ShowOPParts_SearchPurchaseHistory,  
@ShowOPParts_AssignSupplier AS ShowOPParts_AssignSupplier,  
@ShowOPParts_InventorySearch AS ShowOPParts_InventorySearch,  
@ShowOPParts_InventoryValidation AS ShowOPParts_InventoryValidation,  
@ShowOPParts_PartsBookLookup AS ShowOPParts_PartsBookLookup,  
@ShowPOAssignNo AS ShowPOAssignNo,  
@ShowPOActions AS ShowPOActions,  
@OpEditionPlanStatus AS OpEditionPlanStatus,  
PG.Price_Group_ID AS PriceGroupID,PG.Price_Group AS PriceGroup,  
CUR.CurrencyID AS PrimaryCurrencyID,CUR.CurrencyDesc AS PrimaryCurrency,  
@ExternalDocumentSystem AS ExternalDocumentSystem,  
@ExtDocUseClientCredentials AS ExtDocUseClientCredentials,  
T.ConditionMonitoringIntervention,   
CONVERT(BIT,CASE WHEN PT.Rotable_Part_Id IS NULL THEN 0 ELSE 1 END) AS StrategyRotable,  
T.FailedPartListPosition,  
T.FailedPartListGroup,  
T.FailedPartLifeAchieved,  
T.PartSerialNoRemoved,  
T.PartSerialNoInstalled,  
T.WarrantyClaimByUserId,  
WARCLAIM.Amt_User_Name AS WarrantyClaimByUser,  
T.WarrantyClaimSystemDate,  
T.Create_By_User_ID,CRU.Amt_User_Name AS Create_By_User,T.Create_Date,  
HS.AuditableRecord as HealthSafetyAuditable,T.LastNotified,  
@AutoLookupPartsReadyStatus AS AutoLookupPartsReadyStatus,  
T.AuthorisationRequestByID,RAU.Amt_User_Name AS AuthorisationRequestBy,T.AuthorisationRequestDate,  
T.ResourceStatusReady,  
@CreatePOModeAllowCreateERPWO AS CreatePOModeAllowCreateERPWO,  
IsPlanningTask As IsPlanningTask,   
T.ElectronicWorkscopeLinked/*GW E560*/,  
/*VV E621*/T.RebuildWO,T.RebuildJobNumber,T.ReceiptedIntoStock,  
/*E797*/ T.RebuildPartTypeId,pc.PartClassification AS RebuildPartClassification,   
T.RebuildPartId,REP.Part+' - '+REP.PartDescription AS RebuildPart,   
T.DeliveryToWorkshop,T.WaitingForRebuild,T.RebuildTime,  
T.DeliveryToWarehouse,T.RebuildTaskId,E.SerialNumber,  
@EqpSite AS EqpSite,@EqpCustomer AS EqpCustomer,@ChangeoutStrategyDate AS ChangeoutStrategyDate,   
@ChangeoutPlannedDate AS ChangeoutPlannedDate,@ChangeoutActualDate AS ChangeoutActualDate,  
@ChangeoutLifeAchived AS ChangeoutLifeAchived,@ChangeoutSerialNoOut AS ChangeoutSerialNoOut,  
@ParentTaskId AS ParentTaskId  
FROM   
@z_TASK T  
 INNER JOIN  
tblTaskTypes TT  
 ON T.Task_Type_Id=TT.TaskTypeId  
 INNER JOIN  
tblComponentCodes CC  
 ON T.Component_Code_Id=CC.ComponentCodeId  
 INNER JOIN  
tblModifierCodes MC  
 ON T.Modifier_ID = MC.ModifierID  
 INNER JOIN  
TASK_STATUS TS  
 ON T.Task_Status_ID=TS.Task_Status_ID  
 INNER JOIN  
PRIORITY PR  
 ON T.Priority_Id=PR.Priority_Id  
 INNER JOIN  
tblOccurrenceTypes OT  
 ON T.Occurrence_Type_Id=OT.OccurrenceTypeId  
 INNER JOIN  
tblApplicationCodes AC  
 ON T.Application_Code_Id=AC.ApplicationCodeId  
 INNER JOIN  
CAUSE C  
 ON T.Cause_Id=C.Cause_Id  
 INNER JOIN  
tblEqpPlans EP  
 ON T.Eqp_Plan_Id=EP.EqpPlanId  
 INNER JOIN  
tblEquipment E  
 ON EP.EquipmentId=E.EquipmentId  
 INNER JOIN  
tblModels M  
 ON E.ModelId=M.ModelId  
 INNER JOIN  
tblJobCodes JC  
 ON T.Repair_Code_Id=JC.JobCodeId  
 INNER JOIN  
SYMPTOM SY  
 ON T.Symptom_Id=SY.Symptom_Id  
 LEFT OUTER JOIN  
ENTRY_DISTRIBUTION_CODE EDC  
 ON T.Part_Entry_Distribution_Code_Id=EDC.Id  
 LEFT OUTER JOIN  
ENTRY_DISTRIBUTION_CODE LEDC  
 ON T.Labour_Entry_Distribution_Code_Id=LEDC.Id  
 LEFT OUTER JOIN  
ENTRY_DISTRIBUTION_CODE MEDC  
 ON T.Misc_Entry_Distribution_Code_Id=MEDC.Id  
 LEFT OUTER JOIN  
COST_EXPENSE CEP  
 ON T.Parts_Cost_Expense_Id=CEP.Cost_Expense_Id  
 LEFT OUTER JOIN  
COST_EXPENSE CEL  
 ON T.Labour_Cost_Expense_Id=CEL.Cost_Expense_Id  
 LEFT OUTER JOIN  
COST_EXPENSE CEM  
 ON T.Misc_Cost_Expense_Id=CEM.Cost_Expense_Id  
 LEFT OUTER JOIN  
tblBranches B  
 ON T.Branch_Id=B.BranchId  
 LEFT OUTER JOIN  
tblCustomers CU  
 ON T.Customer_Id=CU.CustomerId  
 LEFT OUTER JOIN  
COST_CENTRE COC  
 ON T.Cost_Centre_Id=COC.Cost_Centre_Id  
 LEFT OUTER JOIN  
tblSites SI  
 ON T.Site_Id=SI.SiteId  
 LEFT OUTER JOIN  
HEALTH_SAFETY HS  
 ON T.Health_Safety_Id=HS.Health_Safety_Id   
 LEFT OUTER JOIN  
tblProjTaskOpts PTO ON  
 T.Strategy_Proj_Task_Opt_Id=PTO.ProjTaskOptId  
 LEFT OUTER JOIN  
tblProjTasks PT  
 ON PTO.ProjTaskId=PT.ProjTaskId  
 LEFT OUTER JOIN  
tblParts P  
 ON PT.Part_Id=P.PartId  
 LEFT OUTER JOIN  
ROTABLE_PART RP  
 ON PT.Rotable_Part_Id=RP.Rotable_Part_Id  
 LEFT OUTER JOIN  
TASK_HEADER TH  
 ON PT.Task_Header_Id=TH.Task_Header_Id   
 LEFT OUTER JOIN  
tblCostBearers CB  
 ON T.Cost_Bearer_Id=CB.CostBearerId  
 LEFT OUTER JOIN  
tblWorkOrders WO  
 ON T.Redo_Work_Order_ID=WO.WorkOrderId  
 LEFT OUTER JOIN  
tblWorkOrders WOT  
 ON T.Work_Order_ID=WOT.WorkOrderId  
 LEFT OUTER JOIN  
tblAMTWorkOrderStatus AWOS  
 ON WOT.AmtStatusId=AWOS.AmtWorkOrderStatusId  
 LEFT OUTER JOIN  
EMPLOYEE EM  
 ON T.Employee_Id=EM.Employee_Id  
 LEFT OUTER JOIN  
SOURCE S  
 ON T.Source_Id=S.Source_Id  
 LEFT OUTER JOIN  
TASK_PLANNED_TIME TPT  
 ON T.Task_Planned_Time_Id=TPT.Task_Planned_Time_Id  
 LEFT OUTER JOIN  
WORK_GROUP WG  
 ON T.Work_Group_Id=WG.Work_Group_Id  
 LEFT OUTER JOIN  
@z_EVENT EV  
 ON T.Event_Id=EV.Event_Id  
 LEFT OUTER JOIN  
SIMS_CODE SIMS  
 ON T.SIMS_Code_Id=SIMS.SIMS_Code_Id  
 LEFT OUTER JOIN  
WORK_GROUP DWG  
 ON T.Def_Work_Group_Id=DWG.Work_Group_Id  
 LEFT OUTER JOIN  
EMPLOYEE REM  
 ON T.Reviewed_Employee_Id=REM.Employee_Id  
 LEFT OUTER JOIN  
SUPPLIER SU  
 ON T.Warranty_Supplier_Id=SU.Supplier_Id  
 LEFT OUTER JOIN  
CLAIM_STATUS CS  
 ON T.Claim_Status_Id=CS.Claim_Status_Id  
 LEFT OUTER JOIN  
EMPLOYEE CBEM  
 ON T.Claimed_By_Employee_Id=CBEM.Employee_Id  
 LEFT OUTER JOIN  
@z_ROTABLE_RECORD_TASK_GET_V rot   
 ON T.Task_ID = rot.Task_ID  
 LEFT OUTER JOIN  
AMT_USER TAE  
 ON T.Task_Authorised_By_Id=TAE.Amt_User_Id   
 LEFT OUTER JOIN  
AMT_USER CRU  
 ON T.Create_By_User_ID=CRU.Amt_User_Id  
 LEFT OUTER JOIN  
tblQUOMs QUOMS  
 ON  T.Strategy_QUOM_ID=QUOMS.QUOMId  
 /*VV E602*/  
 LEFT OUTER JOIN  
COMPONENT_SERIALISED CIN  
 ON T.SerialNoInId=CIN.ComponentSerialisedId  
 LEFT OUTER JOIN  
COMPONENT_SERIALISED COUT  
 ON T.SerialNoOutId=COUT.ComponentSerialisedId   
 LEFT OUTER JOIN  
CHANGEOUT_CATEGORY CHC  
 ON T.ChangeoutCategoryId = CHC.ChangeoutCategoryId  
  LEFT OUTER JOIN  
tblPartTypes OPT  
 ON T.OriginalPartTypeId = OPT.PartTypeId  
 LEFT OUTER JOIN   
tblWOrkOrderProjs WPROJ   
 ON WPROJ.ProjTaskId = ISNULL(PT.ProjTaskId,0) AND WPROJ.WorkOrderId = ISNULL(T.Work_Order_ID,0)  
 --AL: 22/12/08  
 LEFT OUTER JOIN  
EMPLOYEE RBEM  
 ON T.RaisedByID=RBEM.Employee_Id  
 --AL: 03/02/09  
 LEFT OUTER JOIN  
AMT_USER WOAU  
 ON WOT.ClosedByUSerID=WOAU.Amt_User_ID  
 --KN: 20102009  
 LEFT OUTER JOIN  
AMT_USER WARCLAIM  
 ON T.WarrantyClaimByUserId=WARCLAIM.Amt_User_ID  
 /*VV E621*/  
/*E797*/
 LEFT JOIN  
PART_CLASSIFICATION pc  
 ON T.RebuildPartTypeId=pc.PartClassificationId
 LEFT JOIN  
tblParts REP  
 ON T.RebuildPartId=REP.PartId  
 --AL: 06/02/09  
 LEFT OUTER JOIN  
 (SELECT Task_ID, ISNULL(SUM(PlanPartsCost),0) AS PlanPartsCost ,  
    ISNULL(SUM(PlanLabourCost),0) AS PlanLabourCost ,ISNULL(SUM(PlanMiscCost),0) AS PlanMiscCost   
  FROM  
   (SELECT T.Task_ID,   
       ISNULL(SUM([TOP].Planned_Qty * [TOP].Planned_Unit_Price),0) AS PlanPartsCost,  
       0 AS PlanLabourCost,0 AS PlanMiscCost  
     FROM           
       TASK T INNER JOIN  
       TASK_OPERATION [TO] ON T.Task_ID = [TO].Task_Id INNER JOIN  
       TASK_OPERATION_PART [TOP] ON [TO].Task_Operation_Id = [TOP].Task_Operation_Id  
     GROUP BY T.Task_ID  
   UNION ALL  
   SELECT T.Task_ID, 0,  
       ISNULL(SUM(TOL.Planned_Labour_Hrs * TOL.Planned_Labour_Rate),0) ,0  
     FROM           
       TASK T INNER JOIN  
       TASK_OPERATION [TO] ON T.Task_ID = [TO].Task_Id INNER JOIN  
       TASK_OPERATION_LABOUR TOL ON [TO].Task_Operation_Id = TOL.Task_Operation_Id   
     GROUP BY T.Task_ID  
   UNION ALL  
   SELECT T.Task_ID, 0,0,  
       ISNULL(SUM(TOM.Planned_Sell),0)   
     FROM           
       TASK T INNER JOIN  
       TASK_OPERATION [TO] ON T.Task_ID = [TO].Task_Id  INNER JOIN  
       TASK_OPERATION_MISC TOM ON [TO].Task_Operation_Id = TOM.Task_Operation_Id  
     GROUP BY T.Task_ID)A  
  GROUP BY Task_ID) AS PCT ON T.Task_ID = PCT.Task_ID  
 --AL: 31/03/10  
 LEFT OUTER JOIN  
AMT_USER RAU  
 ON T.AuthorisationRequestByID=RAU.AMT_User_ID     
 --AL: 22/04/09  
 INNER JOIN  
tblFleets F   
 ON EP.FleetID=F.FleetID  
 INNER JOIN  
PRICE_GROUP PG  
 ON F.Price_Group_ID=PG.Price_Group_ID  
 CROSS JOIN  
 (SELECT TOP 1 CurrencyID,CurrencyDesc FROM tblCurrencies WHERE PrimaryCurr<>0) AS CUR  
  
  
--Library documents  
EXEC TASK_DOCUMENTS_GET_P @Task_Id=@Task_Id  
  
--VV 2-Apr-2009  
--Attached Documents  
SELECT [FileName] FROM ATTACHED_DOCUMENT_TASK WHERE TaskId=@Task_Id  
  
  
--Task operations  
SELECT @TaskStatusId=Task_Status_Id,@PlannedOffset=Planned_Offset,  
 @TPlannedDownTime=Planned_Down_Time FROM @z_TASK  
  
IF @EventId>0  
BEGIN  
 SELECT @EVPlannedDownTime=Planned_Down_Time FROM @z_EVENT  
END  
  
  
EXEC TASK_OPERATIONS_GET_P  
 @TaskId =@Task_Id,  
 @EventID =@EventId,  
 @EVPlannedDownTime =@EVPlannedDownTime,  
 @TaskStatusId =@TaskStatusId,  
 @PlannedOffset =@PlannedOffset,  
 @TPlannedDownTime =@TPlannedDownTime,  
 @OpNum=@OpNum  
 --GD 7/12/11 Fixed 3063  
 --@CheckMaxRec =1  
  
--Task purchase orders  
  
IF @POMode = 0  
 SELECT     
 PO.POCounter,  
 PO.Purchase_Order_Number,S.InternalRequisition,  
 S.Supplier_Name AS Supplier,  
 PO.Supplier_Contact,PO.Contact_Phone,PO.Date_Raised,  
 LEFT(ECC.First_Name, 1) + '. ' + ECC.Surname AS Company_Contact,  
 LEFT(EAU.First_Name, 1) + '. ' + EAU.Surname AS Authorised_By,  
 PO.Delivery_Date,PO.Delivery_Location,PO.Delivery_Street,  
 PO.Purchase_Notes,PO.Order_Printed,PO.Order_E_Mailed,  
 CASE WHEN PO.ExportDate IS NULL THEN CONVERT(BIT,0) ELSE CONVERT(BIT,1) END AS Order_Exported,  
  
 PO.Purchase_Order_Id, PO.Supplier_Id, PO.Company_Contact_Id,     
 PO.Task_Id, PO.Authorised_By_Id,  
 CONVERT(varchar(25), PO.Last_Mod_Date, 21) AS Last_Mod_Date,  
 S.SupplierABN, S.SupplierBranch, S.SupplierStreetAddress, S.SupplierSuburb,   
 S.SupplierStateAndCode,PO.SupplierPhone, PO.SupplierFax,   
 S.SupplierPostalAddressPOBoxAndStreet, S.SupplierPostalAddressSuburb,  
 S.SupplierPostalAddressStateAndCode,   
 PO.SupplierBusinessContactFax, PO.SupplierBusinessContactEmail,  
 PO.SupplierBusinessContactNotes,   
 PO.CompanyContactPhone, PO.CompanyContactEmail, PO.CompanyContactFax,   
 PO.AuthorisedDate,   
  PO.DeliverySuburb, PO.DeliveryStateAndCode,  
 PO.DeliveryContactPerson, PO.DeliveryContactPersonPhone,   
 PO.DeliveryForwardVia   
  
 FROM           
 PURCHASE_ORDER PO   
  INNER JOIN  
 @z_TASK T   
  ON PO.Task_Id = T.Task_ID  
  LEFT OUTER JOIN  
 SUPPLIER S  
  ON PO.Supplier_Id=S.Supplier_Id  
  LEFT OUTER JOIN  
 EMPLOYEE ECC  
  ON PO.Company_Contact_Id=ECC.Employee_Id  
  LEFT OUTER JOIN  
 EMPLOYEE EAU  
  ON PO.Authorised_By_Id=EAU.Employee_Id  
ELSE  
 SELECT     
 PO.POCounter,  
 PO.Purchase_Order_Number,S.InternalRequisition,  
 CASE WHEN LEN(SupplyDescription) > 0 THEN Supplier_Name + ' - ' + SupplyDescription ELSE Supplier_Name END AS Supplier,  
 PO.Supplier_Contact,PO.Contact_Phone,PO.Date_Raised,  
 LEFT(ECC.First_Name, 1) + '. ' + ECC.Surname AS Company_Contact,  
 LEFT(EAU.First_Name, 1) + '. ' + EAU.Surname AS Authorised_By,  
 PO.Delivery_Date,PO.Delivery_Location,PO.Delivery_Street,  
 PO.Purchase_Notes,PO.Order_Printed,PO.Order_E_Mailed,  
 CASE WHEN PO.ExportDate IS NULL THEN CONVERT(BIT,0) ELSE CONVERT(BIT,1) END AS Order_Exported,  
  
 PO.Purchase_Order_Id, PO.Supplier_Id, PO.Company_Contact_Id,     
 PO.Task_Id, PO.Authorised_By_Id,  
 CONVERT(varchar(25), PO.Last_Mod_Date, 21) AS Last_Mod_Date,  
 S.SupplierABN, S.SupplierBranch, S.SupplierStreetAddress, S.SupplierSuburb,   
 S.SupplierStateAndCode,PO.SupplierPhone, PO.SupplierFax,   
 S.SupplierPostalAddressPOBoxAndStreet, S.SupplierPostalAddressSuburb,  
 S.SupplierPostalAddressStateAndCode,   
 PO.SupplierBusinessContactFax, PO.SupplierBusinessContactEmail,  
 PO.SupplierBusinessContactNotes,   
 PO.CompanyContactPhone, PO.CompanyContactEmail, PO.CompanyContactFax,   
 PO.AuthorisedDate,   
  PO.DeliverySuburb, PO.DeliveryStateAndCode,  
 PO.DeliveryContactPerson, PO.DeliveryContactPersonPhone,   
 PO.DeliveryForwardVia   
  
 FROM           
 PURCHASE_ORDER PO   
  INNER JOIN  
 @z_TASK T   
  ON PO.Task_Id = T.Task_ID  
  LEFT OUTER JOIN  
 SUPPLIER S  
  ON PO.Supplier_Id=S.Supplier_Id  
  LEFT OUTER JOIN  
 EMPLOYEE ECC  
  ON PO.Company_Contact_Id=ECC.Employee_Id  
  LEFT OUTER JOIN  
 EMPLOYEE EAU  
  ON PO.Authorised_By_Id=EAU.Employee_Id  
  
  

GO

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TASK_DEFAULT_ADD_GET_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[TASK_DEFAULT_ADD_GET_P]
GO

create Procedure [dbo].[TASK_DEFAULT_ADD_GET_P]
/******************************************************************************
	File: 
	Name: TASK_DEFAULT_ADD_GET_P

	Called By: 

	Desc: Get Task defaults, Task Operation defaults, Task Operation parts, labour, misc,
	      purchase orders,
		  Add a task with the default values.
	      

	Auth: Veronika Vasylyeva
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	17 APR 12   SD          E797  Replace Rebuild Part Type join with Part classification
	07 Dec 11   G Dhillon   #3061 error while importing standard job and editing
	01 Dec 11	V Vasylyeva	#3000 Defaults for rebuild workorder not linked to
							changeout workorder
	01 Dec 11   G Dhillon   #3014 return default FinPeriod to be 0 for Parts/Lab/Misc
	31 Oct 11	V Vasylyeva	#2730 Rebuild Part Number
	 1 Sep 11	V Vasylyeva	E621: Rebuild workorder
	26 Aug 11	V Vasylyeva	#2351: Set occurrence type to the default
	10 Feb 10	V Vasylyeva	AmtMobile: Add Checksheets when create from std jobs or strategy tasks
	06 OCt 10	K Nagarajan	#603: Inventory Validation Error adding parts to work order from standard job
	25 Aug 10	K Nagarajan	#317: Error Message After Parts Selected from Inventory
	18 Aug 10	V Vasylyeva	#261: Primary key on identiy field (-1,-1)
							 Msg 4819 Cannot bulk load. The bulk data stream was incorrectly 
							 specified as sorted or the data violates a uniqueness constraint 
							 imposed by the target table. Sort order incorrect for the following two rows: 
							 primary key of first row: (-1), primary key of second row: (-2).
							 Error 4819 Microsoft is going to adress in the future
							 
	12 Aug 10	V Vasylyeva	#40 Task types are not transferring to work orders from a standard job.
	10 Aug 10	DS			Added CreatePOModeAllowCreateERPWO
	08 Apr 10	AL			CR8869: TASK_PARTS_READY_STATUS_UPDATE_P only for qty >0
	06 Apr 10	AL			CR8869: implemented logic from TASK_PARTS_READY_STATUS_UPDATE_P
	31-Mar-2010	AL			CR8869: Added new JR fields in defaults
	29 Mar 10	AL			CR8865: provide Health_Safety_ID in defaults, + HealthSafetyAuditable and LastNotified
	15 Dec 09	AL			CR8638: Added showOPParts_PartsBookLookup
	 1 Dec 09	V Vasylyeva	CR8498: Importing a std job to an existing work order asks "do you want 
									 to over-ride operations from standard job" 
									 but replaces the Cost Centre and Cost Bearer with blanks because the std job 
									 doesn't have thes fields in the operation. 

	26 Nov 09	V Vasylyeva CR8449: removed createbyuser
	25 Nov 09	AL			CR8449: Added missing createByuser to returned dataset
	23 Nov 2009	V Vasylyeva	CR8449: Save createByuser
	10-Sep-2009	AL			CR8387: always have parts required set	
	03 Sep 09	K Nagarajan Added Detailed Description (CBM Enhancements)
	01 Jul 09	AL			CR8301: set some parts values to null if equal to ''
	30 Jun 09	V Vasylyeva	CR8294 When a new Workorder is CREATED from a Standard Job, the Cost Bearer, 
							Expense Element, Cost Centre and Workgroup fields are not populated. 
							This is also the case when a Workorder is CREATED automatically from a 
							Strategy Task that is linked to Standard Job(s).

	26 May 09	AL			CR8041: put table columns in the same order as TASK_GET_P
	13 May 09	V Vasylyeva	CR8036: If NextOccDate is null - take the earliest occurrence date for the strategy task 
								(tblProjTaskOccs). 	if there are no future occurrencies - set the end date of equipment
	12-May-09	V Vasylyeva			CR8096: tblLabourRates -->LABOUR_RATE_DEF_V
	 6 May 09	VV			External documents
	30 Apr 09	VV			CR8035: Library Documents
	27-Apr-09	VV			CR8035: Library Link
	22 Apr 09	AL			CR8013: Added PricingGroup and PrimaryCurrency
	08 Apr 09	AL			CR7933: fixed finperiod
	07 Apr 09	AL			CR7933: populate TO P/L/M finperiod and currencyID + exchangeRate
	04 Apr 09	AL			CR7933: ManualEntryActuals* as int
	03 Apr 09	AL			CR7933: added new fields
	27-Mar-09	AL			CR7932: ACW changes: place checks before call AND any creation to branch out before (backlogs from EMI not in transaction)
	26-Mar-09	AL			CR7932: ACW changes: have checks before call 
	24 Mar 09	AL			CR7932: Tasks created from std job change
	24 Mar 09	AL			CR7932: remove branch out if no operation in @add=1
	23 Mar 09	AL			CR7932: expected_duration cannot be null
	23 Mar 09	AL			CR7932: Tasks created from std job get task type from std job + check if it is not 0 for ACW
	19 Mar 09	AL			CR7932: ACW changes
	17 Mar 09	AL			CR7933: added new AMT_TYPED_VARIABLEs
	16-Mar-09	AL			CR7933: added InvNotFound + SOSDescription 
	11-Mar-09	AL			CR7933: removed OpEditionLabourWG
	10-Mar-09	AL			CR7933: Added new fields 
	20-Feb-09	AL			CR7896: set task's planned duration against std job's header duration
	11-Feb-09	AL			CR7845: do not authorise unplanned sched tasks added to event
	11-Feb-09	AL			CR7846: added feedback info 
	10-Feb-09	AL			CR7845: Planning_Notes and Operation_Instructions to be varchar(8000)
	09-Feb-09	AL			CR7845: Always have 1 operation and labour
	06-Feb-09	AL			Changed ManualWOClosure to ACWManualWOClosure
	03-Feb-09	AL			CR7844: Added Task Authorisation info + removed DefaultTaskAuthorised
	20 Jan 08	V Vasylyeva	CR7835 Changes to task description for the strategy tasks
	12 Dec 08	VV			CR7787 If Job code is empty for strategy task and cost allocation
							the task operation will not be created
	23 Oct 08	VV			CR7244 Changed linking of the library documents
	11 Oct 08	DS			Added WOCreateFromPO
	17/09/08	AL			removed links to tblqualifier and tbluoms
	29 Aug 08	AL			Added WarrantyParts
	12 Jun 08	AL			Changed Repair Description size
	22-May-2008	A Lass.		changed Planning_Notes and Operation_Instructions to be varchar(MAX)
	21 Apr 2008	KN			Added "OverwriteLifeAchieved","IsOverwriteLife"
	10 Apr 2008	K Nagarajan	Added ForWOCreate Parameter which returns only the Task Defaults.
    21 Feb 2008	AL			Changed PlanDateLocked to ReviewStatusID
	13 Feb 2008	K Nagarajan	Added Default CBM Alert Task Counter for CBM Tasks.
	11 Feb 2008	K Nagarajan	Added @RCMConditionMonitoringId,@RCMRuleId 
	 1 Nov 2007	V Vasylyeva	Added default work groups
	18 Oct 2007	V Vasylyeva	Added Task_header_Id if created from std job or workorder
	15 Oct 2007 KN			Added WorkOrderId
	08 Oct 2007	KN			Added "LifeConfirmed","ChangeoutCategory"
	20 Aug 07	V Vasylyeva	Added Warranty days and warranty usage into task creation
	18 Jul 07	V Vasylyeva	Added SourceOfSupplyId,COLLATE database_default
    02 Jul 07	V Vasylyeva	Added system settings for task_authorised
	05 Dec 11   T Patel     Issue 3030 : Can Edit Financial period even when system setting says can not
*******************************************************************************/
	/* Param List */
@Eqp_Plan_ID int,
@EventId int=0, 
@Proj_Task_Opt_Id int =NULL,
@Std_Job_Id int=NULL,
@PricedJobId int=NULL,
@TaskDefaults bit=1, 
@Add bit=0,
@UserId int=0,
@TaskId int=0 OUTPUT,
@WorkOrderId INT = 0,
@RCMConditionMonitoringId INT = 0,
@RCMRuleId INT = NULL,
@IsPrimaryTask BIT = 0,
@ForWOCreate BIT = 0,
@Message varchar(max)='' OUTPUT ,
@TaskDesc VARCHAR(MAX)  = '',
@WOSymptoms VARCHAR(MAX) = '',
@RCMProjTaskId INT = 0,
@CopyEWTemplateFiles bit=0 OUTPUT,
/*VV E621 @ChangeoutProjTaskId =-1 for rebuild workorder not linked to
a strategy task*/
@ChangeoutProjTaskId int=0

AS

-- IF @TaskDefaults=1 select defaults for TASK and operations
-- IF @TaskDefaults=0 select defaults for operations only

--If @Add=0 - select defaults
--If @Add=1 - add task with default values to the database

DECLARE @Description varchar(500)
DECLARE @Task_Type_ID int
DECLARE @Component_Code_ID int
DECLARE @Modifier_ID int
DECLARE @Application_Code_ID int
DECLARE @Occurrence_Type_Id int
DECLARE @Task_Status_ID int
DECLARE @Symptom_ID int
DECLARE @Cause_ID int
DECLARE @Repair_Code_ID int
DECLARE @Priority_ID int
DECLARE @Task_Mode_ID int
DECLARE @Source_ID int 
DECLARE @PartsStatusRequired bit
DECLARE @PartsStatusOrdered bit
DECLARE @PartsStatusReady bit
DECLARE @ExtDocUseClientCredentials bit/*VV 30-Apr-2009*/
DECLARE @Cost_Bearer_ID int
DECLARE @Cost_Centre_ID int
DECLARE @Part_Entry_Distribution_Code_Id int
DECLARE @Labour_Entry_Distribution_Code_Id int
DECLARE @Misc_Entry_Distribution_Code_Id int
DECLARE @Expected_Duration float
DECLARE @Expected_Labor_Hours float
DECLARE @Strategy_Usage real
DECLARE @Strategy_QUOM_ID int
DECLARE @Strategy_Date datetime
DECLARE @Strategy_Locked bit
DECLARE @Task_Header_Id int
DECLARE @Strategy_Repair_Description varchar(MAX)
DECLARE @Final_Change float
DECLARE @Risk_Life_Left float
DECLARE @Strategy_Frequency float
DECLARE @Last_Performed float
DECLARE @Last_Scheduled float
DECLARE @Last_Performed_Date datetime
DECLARE @Last_Scheduled_Date datetime
DECLARE @Site_Id int
DECLARE @Branch_Id int
DECLARE @Customer_Id int
DECLARE @Entry_Distribution_Code_Id int
DECLARE @Parts_Cost_Expense_Id int
DECLARE @Labour_Cost_Expense_Id int
DECLARE @Misc_Cost_Expense_Id int
DECLARE @Warranty_Days float
DECLARE @Warranty_Usage float
DECLARE @ProjTaskId int
DECLARE @LastOcc float
DECLARE @First float
DECLARE @EndUsage float
DECLARE @EndDate datetime
DECLARE @Frequency float
DECLARE @Task_Mode_GT int
DECLARE @Task_Mode_AW int
DECLARE @Component varchar(50)
DECLARE @UseSchedulingSystemLastOcc bit
DECLARE @DefDescription varchar(50)
DECLARE @PrimCurrencyId int
DECLARE @Price_Group_ID int
DECLARE @FleetId int
DECLARE @ManufacturerId int
DECLARE @Def_Misc_Category_Id int
DECLARE @Counter int
DECLARE @Site varchar(50)
DECLARE @Branch varchar(50)
DECLARE @Strategy_Part_Num varchar(50)
DECLARE @IsEditable bit
DECLARE @CompanyCode varchar(50)
DECLARE @AMTPlanningModeId int

DECLARE @Task_Status_OUS int
DECLARE @Task_Status_YTS int
DECLARE @TaskStatusIP int
DECLARE @TaskStatusC int
DECLARE @TaskStatusA int
DECLARE @SJBranchId int
DECLARE @SJPriceGroupId int
DECLARE @ModelId int
DECLARE @TaskOperationId int
DECLARE @WorkGroupId int
DECLARE @Health_Safety_ID int
DECLARE @OpCount int
DECLARE @ChooseWODate bit
DECLARE @WOCreationDateFutureONLY bit
DECLARE @LifeConfirmed bit
/*VV E621*/
DECLARE @RebuildPartTypeId int,@RebuildPartId int,@ChangeoutWorkorderId int
DECLARE @EqpSite varchar(1000),@EqpCustomer varchar(1000),@ChangeoutStrategyDate datetime
DECLARE @ChangeoutPlannedDate datetime,@ChangeoutActualDate datetime,@ChangeoutLifeAchived float
DECLARE @ChangeoutSerialNoOut varchar(1000), @AmtPlanningModeStandard int


SET @LifeConfirmed = 1
SET @AmtPlanningModeStandard=2

DECLARE @ChangeoutCategoryId INT
SELECT @ChangeoutCategoryId = ChangeoutCategoryId FROM CHANGEOUT_CATEGORY WHERE DefaultRecord = 1

DECLARE @IsOverwriteLife bit
SET @IsOverwriteLife = 0

DECLARE @ExternalDocumentSystem bit /*VV 27-Apr-2009*/

SET @Task_Status_OUS=1
SET @Task_Status_YTS=6
SET @TaskStatusIP =2
SET @TaskStatusC =3
SET @TaskStatusA =5

DECLARE @PartsAvailableFromERP bit
DECLARE @WOCreateFromPO bit
DECLARE @ACWManualWOClosure BIT	
DECLARE @AuthorisationMode INT	
DECLARE @AuthorisationTolerancePct FLOAT	

DECLARE @FeedbackPartsTab bit
DECLARE @FeedbackLabourTab bit
DECLARE @FeedbackMiscTab bit

/*VV E621*/
SET @ChangeoutProjTaskId=ISNULL(@ChangeoutProjTaskId,0)

IF @ChangeoutProjTaskId>0 AND EXISTS(SELECT EP.EqpPlanId FROM tblProjTasks PT INNER JOIN tblEqpPlans EP 
ON PT.EqpPlanId=EP.EqpPlanId WHERE PT.ProjTaskId=@ChangeoutProjTaskId AND EP.Advanced_Planning<>0 )
BEGIN
	SELECT @ChangeoutWorkorderId=dbo.CHANGEOUT_WORKORDER_ID_GET_F(@ChangeoutProjTaskId)
	
	IF ISNULL(@ChangeoutWorkorderId,0)=0
	BEGIN
		SET @Message='The Strategy Workorder has not been created. Please ensure there is a Strategy Workorder for this Strategy Task and try again.'
		RETURN
	END
	
	IF EXISTS (SELECT Task_ID FROM TASK WHERE Task_ID=@ChangeoutWorkorderId AND RebuildTaskId>0)
	BEGIN
		SET @Message='Rebuild Workorder has already been created.'
		RETURN
	END
END


SELECT TOP 1 @WOCreateFromPO = WOCreateFromPO,
	@PartsAvailableFromERP=Parts_Available_From_ERP,
	@ChooseWODate=Choose_WO_Date,
	@WOCreationDateFutureONLY=WO_CreationDate_FutureONLY,
	@ACWManualWOClosure=ACWManualWOClosure,
	@AuthorisationMode=AuthorisationMode,
	@AuthorisationTolerancePct=AuthorisationTolerancePct,
	@FeedbackPartsTab=FeedbackPartsTab,	
	@FeedbackLabourTab=FeedbackLabourTab,
	@FeedbackMiscTab=FeedbackMiscTab

FROM AMT_VARIABLE

DECLARE @AuthModeNone int, @AuthModeSimple int, @AuthModeAdvanced int
SET @AuthModeNone=0
SET @AuthModeSimple=1
SET @AuthModeAdvanced=2

DECLARE @ManualEntryActualsParts INT
DECLARE @ManualEntryActualsLabour INT
DECLARE @ManualEntryActualsMisc INT
DECLARE @OpEditionPartsStockCode BIT
DECLARE @OpEditionPartsCB INT
DECLARE @OpEditionPartsCC INT
DECLARE @OpEditionPartsEE INT
DECLARE @OpEditionPartsWG INT
DECLARE @OpEditionLabourCB INT
DECLARE @OpEditionLabourCC INT
DECLARE @OpEditionLabourEE INT
DECLARE @OpEditionMiscCB INT
DECLARE @OpEditionMiscCC INT
DECLARE @OpEditionMiscEE INT
DECLARE @OpEditionMiscWG INT
DECLARE @ShowOPParts_LookupPartsDetails BIT
DECLARE @ShowOPParts_SearchPurchaseHistory BIT
DECLARE @ShowOPParts_AssignSupplier BIT
DECLARE @ShowOPParts_InventorySearch BIT
DECLARE @ShowOPParts_InventoryValidation BIT
DECLARE @ShowOPParts_PartsBookLookup BIT
DECLARE @ShowPOAssignNo BIT 
DECLARE	@ShowPOActions BIT
DECLARE @OpEditionPlanStatus INT

EXEC TASK_OPERATION_CONFIGURATION_GET_P
	@ManualEntryActualsParts=@ManualEntryActualsParts OUTPUT,
	@ManualEntryActualsLabour=@ManualEntryActualsLabour OUTPUT,
	@ManualEntryActualsMisc=@ManualEntryActualsMisc OUTPUT,
	@OpEditionPartsStockCode=@OpEditionPartsStockCode OUTPUT,
	@OpEditionPartsCB=@OpEditionPartsCB OUTPUT,
	@OpEditionPartsCC=@OpEditionPartsCC OUTPUT,
	@OpEditionPartsEE=@OpEditionPartsEE OUTPUT,
	@OpEditionPartsWG=@OpEditionPartsWG OUTPUT,
	@OpEditionLabourCB=@OpEditionLabourCB OUTPUT,
	@OpEditionLabourCC=@OpEditionLabourCC OUTPUT,
	@OpEditionLabourEE=@OpEditionLabourEE OUTPUT,
	@OpEditionMiscCB=@OpEditionMiscCB OUTPUT,
	@OpEditionMiscCC=@OpEditionMiscCC OUTPUT,
	@OpEditionMiscEE=@OpEditionMiscEE OUTPUT,
	@OpEditionMiscWG=@OpEditionMiscWG OUTPUT,
	@ShowOPParts_LookupPartsDetails=@ShowOPParts_LookupPartsDetails OUTPUT,
	@ShowOPParts_SearchPurchaseHistory=@ShowOPParts_SearchPurchaseHistory OUTPUT,
	@ShowOPParts_AssignSupplier=@ShowOPParts_AssignSupplier OUTPUT,
	@ShowOPParts_InventorySearch=@ShowOPParts_InventorySearch OUTPUT,
	@ShowOPParts_InventoryValidation=@ShowOPParts_InventoryValidation OUTPUT,
	@ShowOPParts_PartsBookLookup=@ShowOPParts_PartsBookLookup OUTPUT,
	@ShowPOAssignNo=@ShowPOAssignNo OUTPUT,
	@ShowPOActions=@ShowPOActions OUTPUT,
	@OpEditionPlanStatus=@OpEditionPlanStatus OUTPUT

DECLARE @AutoLookupPartsReadyStatus bit
EXEC AMT_TYPED_VARIABLE_GET_P @Value_Name='AutoLookupPartsReadyStatus',  @Varchar_Value=@AutoLookupPartsReadyStatus OUTPUT

DECLARE @CreatePOModeAllowCreateERPWO bit
EXEC AMT_TYPED_VARIABLE_GET_P @Value_Name='CreatePOModeAllowCreateERPWO',  @Varchar_Value=@CreatePOModeAllowCreateERPWO OUTPUT


SET @DefDescription='Various'

SET @Task_Mode_GT =1
SET @Task_Mode_AW=2

SET @EventId=ISNULL(@EventId,0)


SET @Proj_Task_Opt_Id=ISNULL(@Proj_Task_Opt_Id,0)
SET @Std_Job_Id=ISNULL(@Std_Job_Id,0)
SET @PricedJobId=ISNULL(@PricedJobId,0)
SET @WorkOrderId = ISNULL(@WorkOrderId, 0)

SET @IsPrimaryTask = ISNULL(@IsPrimaryTask,0)

IF @Proj_Task_Opt_Id>0 OR @Std_Job_Id>0  OR @PricedJobId>0
BEGIN
	SET @IsEditable=0
END
ELSE
BEGIN
	SET @IsEditable=1
END

IF @Proj_Task_Opt_Id >0 OR @Std_Job_Id>0 OR @PricedJobId>0
BEGIN
	SELECT @PrimCurrencyId=CurrencyID FROM tblCurrencies WHERE PrimaryCurr<>0
END

--If Priced job is supplied take std job, price group, branch from
--tblPricedjobs

IF @PricedJobId>0
BEGIN
	SELECT @Std_Job_Id=StdJobId,@SJBranchId=BranchId,@SJPriceGroupId=Price_Group_Id
	FROM tblPricedJobs WHERE PricedJobId=@PricedJobId
END

If @Proj_Task_Opt_Id >0
BEGIN

	--AMT variables
	SELECT @UseSchedulingSystemLastOcc=UseSchedulingSystemLastOcc FROM AMT_VARIABLE

	SELECT @Def_Misc_Category_Id=Misc_Category_Id FROM MISC_CATEGORY WHERE Default_Record=1

	--Select strategy defaults
	SELECT @Symptom_ID=Symptom_ID FROM SYMPTOM WHERE Strategy_Default = 1	
		
	SELECT @Cause_ID=Cause_ID FROM CAUSE WHERE Strategy_Default = 1	
	
	SELECT 
	@Repair_Code_Id=CASE COUNT(ProjTaskAmtId) WHEN 1 THEN MAX(JobCodeId) ELSE NULL END,
	@Expected_Labor_Hours=SUM(LaborHours),
	@Expected_Duration=SUM(Duration)
	FROM PROJ_TASK_AMT_COST_1_V
	WHERE ProjTaskOptId=@Proj_Task_Opt_Id

	SELECT	
	@ProjTaskId=PT.ProjTaskId,
	@Description=/*VV 20-Jan-09*/ISNULL(PT.Task_Description,TH.Description),
	@Task_Type_ID=PT.TaskTypeId,
	@Component_Code_ID=PT.ComponentCodeId,
	@Modifier_ID=PT.ModifierId,
	@Application_Code_ID=PT.ApplicationCodeId,
	/*VV #2351 @Occurrence_Type_Id=PTO.OccurrenceTypeId,	*/
	@Strategy_Usage =PT.NextOcc,
	@Strategy_QUOM_ID=PT.UsageQUOMId,
	@Strategy_Date =PT.NextOccDate,
	@Strategy_Locked =CASE WHEN PT.ReviewStatusID=3 THEN CONVERT(BIT,1) ELSE CONVERT(BIT,0) END,
	@Task_Header_Id=PT.Task_Header_Id,
	@Strategy_Repair_Description =NOS.Repair_Description,	
	@Strategy_Frequency =PTO.Frequency,
	@Last_Performed =CASE WHEN @UseSchedulingSystemLastOcc =1 AND SchedulingTaskId>0 THEN Ext_Last_Occ ELSE AMT_WO_Last_Occ END,
	@Last_Scheduled =CASE WHEN @UseSchedulingSystemLastOcc =1 AND SchedulingTaskId>0 THEN Ext_Last_Sched_Occ ELSE AMT_Last_Sched_Occ END,
	@Last_Performed_Date=CASE WHEN @UseSchedulingSystemLastOcc =1 AND SchedulingTaskId>0 THEN Ext_Last_Occ_Date ELSE AMT_WO_Last_Occ_Date END,
	@Last_Scheduled_Date=CASE WHEN @UseSchedulingSystemLastOcc =1 AND SchedulingTaskId>0 THEN Ext_Last_Sched_Date ELSE AMT_Last_Sched_Date END, 
	@LastOcc=PT.LastOcc,
	@First=PTO.[First],
	@EndUsage=CASE WHEN ISNULL(EPR.EndQUOMId,0)=ISNULL(PT.UsageQUOMId,0) THEN EPR.EndUsage 
			       ELSE dbo.GET_EQP_PROJ_END_USAGE_F(EPR.EqpProjId, PT.UsageQUOMID,EPR.EndDate) END,
	@EndDate=EPR.EndDate,/*VV CR8036*/
	@Warranty_Days=PT.Warranty_Period_Days,
	@Warranty_Usage=PT.Warranty_Period_Usage,
	@ManufacturerId=PT.ManufacturerId,
	@Strategy_Part_Num=ISNULL(P.Part, RP.Part_Number) 
	FROM
	TASK_HEADER TH
		INNER JOIN
	tblProjTasks PT
		ON TH.Task_Header_Id=PT.Task_Header_Id
		INNER JOIN
	tblEqpProjs EPR
		ON PT.EqpProjId=EPR.EqpProjId
		INNER JOIN
	tblProjTaskOpts PTO
		ON PT.ProjtaskId=PTO.ProjTaskId
		LEFT OUTER JOIN
	NEXT_OCC_STRATEGY NOS
		ON PT.ProjTaskId=NOS.Proj_Task_Id
		LEFT OUTER JOIN
	tblParts P 
		ON PT.Part_Id=P.PartId
		LEFT OUTER JOIN
	ROTABLE_PART RP
		ON PT.Rotable_Part_Id=RP.Rotable_Part_Id		
	WHERE PTO.ProjTaskOptId=@Proj_Task_Opt_Id		
	

	--Final change usage
	SELECT @Final_Change=MAX(OccUsage) FROM tblProjTaskOccs WHERE ProjTaskId=@ProjTaskId

	SET @Final_Change=ISNULL(ISNULL(@Final_Change,@LastOcc),@First)

	/*SET @Risk_Life_Left =100.00*(@Frequency-(@EndUsage - @Final_Change ))/NULLIF(@Frequency,0)*/
	SET @Risk_Life_Left=dbo.RISK_LIFE_LEFT_F(@Frequency,@EndUsage,@Final_Change)

	/*VV CR8036*/
	IF @Strategy_Date IS NULL
	BEGIN
		/*If NextOccDate is null - take the earliest occurrence date for the strategy task (tblProjTaskOccs) 
		if there are no future occurrencies - set the end date.*/
		SELECT @Strategy_Date=MIN(OC.OccDate),@Strategy_Usage=MIN(OC.OccUsage )
		FROM 
		tblProjTaskOccs OC
			INNER JOIN
		tblProjTaskOpts PTO
			ON OC.ProjTaskId=PTO.ProjTaskId
		WHERE PTO.ProjTaskOptId=@Proj_Task_Opt_Id
	END

	SET @Strategy_Date=ISNULL(@Strategy_Date,@EndDate)
	SET @Strategy_Usage=ISNULL(@Strategy_Usage,@EndUsage)
END

IF @Std_Job_Id>0
BEGIN
	SELECT @Description=LEFT(StdJob,500), 
	@Component_Code_ID=ComponentCodeId, 
	@Modifier_ID=ModifierCodeId, 
	@Repair_Code_ID=JobCodeId,
	@Expected_Duration=Duration_Hrs,
	@Task_Type_ID=TaskTypeId

	FROM tblStdJobs WHERE StdJobId=@Std_Job_Id

	SELECT @Application_Code_ID=ApplicationCodeID FROM tblApplicationCodes WHERE Default_Record = 1

	EXEC TASK_HEADER_MANAGER_P @Comp_Code_id=@Component_Code_ID,
								@Mod_Code_id=@Modifier_ID,
								@Task_Type_id =@Task_Type_ID,
								@Application_Code_id=@Application_Code_ID,
								@Task_Header_Id=@Task_Header_Id OUTPUT
END

IF @WorkOrderId > 0
BEGIN
	SELECT
		@Component_Code_ID = AMTComponentCodeId, 
		@Modifier_ID = AMTModifierId, 
		@Task_Type_ID = AMTTaskTypeId, 
		@Application_Code_ID = AMTApplicationCodeId, 
		@Occurrence_Type_Id = AMTOccurrenceTypeId,
		@Strategy_Date=AMTStartDate,
		@Task_Header_Id=Task_Header_Id
	FROM    
		tblWorkOrders
	WHERE
		WorkOrderId = @WorkOrderId
END
/*VV E621*/
IF @ChangeoutProjTaskId>0 AND ISNULL(@ChangeoutWorkorderId,0)=0
BEGIN
	SELECT @Eqp_Plan_ID=EqpPlanId, @Component_Code_ID=ComponentCodeId,@Modifier_ID = ModifierId,
	@Application_Code_ID = ApplicationCodeId
	FROM tblProjTasks WHERE ProjTaskId=@ChangeoutProjTaskId
END

/*VV E621*/
IF @ChangeoutWorkorderId>0
BEGIN
	SELECT @Component_Code_ID=T.Component_Code_ID,@Modifier_ID=T.Modifier_ID, 
	@Application_Code_ID=T.Application_Code_ID,@Eqp_Plan_ID=T.Eqp_Plan_ID,
	@ChangeoutStrategyDate=CASE WHEN T.Strategy_Proj_Task_Opt_ID>0 THEN T.Strategy_Date ELSE NULL END, 
	@ChangeoutPlannedDate= CASE WHEN T.Task_Status_ID IN(@Task_Status_YTS,@TaskStatusIP,@TaskStatusC,@TaskStatusA) THEN 
		dbo.WO_DOWN_TIME_F(ISNULL(E.Planned_Down_Time,T.Planned_Down_Time),T.Planned_Offset) 
	ELSE NULL END,
	@ChangeoutActualDate= CASE WHEN T.Task_Status_ID IN(@TaskStatusIP,@TaskStatusC) THEN
	dbo.WO_DOWN_TIME_F(ISNULL(E.Actual_Down_Time,T.Actual_Down_Time),T.ActualOffset) END,
	@ChangeoutLifeAchived= WPROJ.TotalLife,@ChangeoutSerialNoOut=C.ComponentSerialNo,
	@RebuildPartTypeId =N.PEXPartTypeId,/*VV #2730*/@RebuildPartId=N.PEXPartId,
	@Site_Id=N.PEXRebuildLocationId,
	@Site=S.Site,
	@Branch_Id=S.BranchId, 
	@Branch=B.Branch,
	@Cost_Bearer_ID=EP.Default_Cost_Bearer_ID, 
	@Cost_Centre_ID=EP.Cost_Centre_ID, 
	@Part_Entry_Distribution_Code_Id=EP.Parts_Entry_Distribution_Code_Id, 
	@Labour_Entry_Distribution_Code_Id=EP.Labour_Entry_Distribution_Code_Id, 
	@Misc_Entry_Distribution_Code_Id=EP.Misc_Entry_Distribution_Code_Id,
	@Customer_id=EP.Customer_Id,
	@Task_Mode_ID=CASE B.Enable_Auto_WO_Create WHEN 1 THEN @Task_Mode_AW ELSE @Task_Mode_GT END,
	@Price_Group_ID=F.Price_Group_ID,
	@FleetId=EP.FleetId,
	@AMTPlanningModeId=@AmtPlanningModeStandard,
	@ModelId=EQ.ModelId
	FROM 
	TASK T 
		INNER JOIN      
	tblEqpPlans AS EP 
		ON T.Eqp_Plan_ID=EP.EqpPlanId
		INNER JOIN
	tblEquipment EQ
		ON EP.EquipmentId=EQ.EquipmentId
		INNER JOIN
	tblFleets F
		ON EP.FleetId=F.FleetId
		LEFT JOIN
	EVENT E
		ON T.Event_ID=E.Event_ID
		LEFT JOIN
	tblProjTaskOpts PTO ON
		T.Strategy_Proj_Task_Opt_Id=PTO.ProjTaskOptId
		LEFT JOIN
	tblProjTasks PT
		ON PTO.ProjTaskId=PT.ProjTaskId
		LEFT JOIN 
	tblWOrkOrderProjs WPROJ 
		ON WPROJ.ProjTaskId = PT.ProjTaskId AND WPROJ.WorkOrderId = T.Work_Order_ID
		LEFT JOIN 
	COMPONENT_SERIALISED C
		ON T.SerialNoOutId=C.ComponentSerialisedId
		LEFT JOIN
	NEXT_OCC_STRATEGY N
		ON PT.ProjTaskId=N.Proj_Task_Id
		LEFT JOIN
	tblSites S
		On N.PEXRebuildLocationId=S.SiteId
		LEFT JOIN
	tblBranches B
		ON S.BranchId=B.BranchId
	WHERE T.Task_ID=@ChangeoutWorkorderId

END
ELSE/*VV E621*/
BEGIN
	SELECT   
		@Site_Id=S.SiteId,
		@Site=S.Site,
		@Branch_Id=S.BranchId, 
		@Branch=B.Branch,
		@Cost_Bearer_ID=EP.Default_Cost_Bearer_ID, 
		@Cost_Centre_ID=EP.Cost_Centre_ID, 
		@Part_Entry_Distribution_Code_Id=EP.Parts_Entry_Distribution_Code_Id, 
		@Labour_Entry_Distribution_Code_Id=EP.Labour_Entry_Distribution_Code_Id, 
		@Misc_Entry_Distribution_Code_Id=EP.Misc_Entry_Distribution_Code_Id,
		@Customer_id=EP.Customer_Id,
		@Task_Mode_ID=CASE B.Enable_Auto_WO_Create WHEN 1 THEN @Task_Mode_AW ELSE @Task_Mode_GT END,
		@Price_Group_ID=F.Price_Group_ID,
		@FleetId=EP.FleetId,
		/*VV E621*/
		@AMTPlanningModeId=CASE WHEN @ChangeoutProjTaskId<>0 THEN @AmtPlanningModeStandard ELSE EP.Advanced_Planning END,
		@ModelId=E.ModelId/*VV E621,
		@WorkGroupId=WG.Work_Group_Id*/
	FROM   
	tblEquipment E
		INNER JOIN      
	tblEqpPlans AS EP 
		ON E.EquipmentId=EP.EquipmentId
		INNER JOIN
	tblFleets F
		ON EP.FleetId=F.FleetId
		INNER JOIN
	tblSites S
		ON F.SiteId=S.SiteId
		INNER JOIN
	tblBranches B
		ON S.BranchId=B.BranchId
		/*VV E621 LEFT OUTER JOIN
	WORK_GROUP WG
		ON S.SiteId=WG.Site_Id*/
	WHERE EP.EqpPlanId=@Eqp_Plan_Id
	/*VV E621 AND (WG.Default_Record=1 OR WG.Default_Record IS NULL)*/
	
	/*VV #3000*/
	IF @ChangeoutProjTaskId<>0 
	BEGIN
		SELECT @Site_Id=N.PEXRebuildLocationId,	@Site=S.Site,
		@RebuildPartTypeId =N.PEXPartTypeId,@RebuildPartId=N.PEXPartId,
		@Branch_Id=S.BranchId, @Branch=B.Branch
		FROM
		NEXT_OCC_STRATEGY N
			LEFT JOIN
		tblSites S
			On N.PEXRebuildLocationId=S.SiteId
			LEFT JOIN
		tblBranches B
			ON S.BranchId=B.BranchId
		WHERE N.Proj_Task_Id=@ChangeoutProjTaskId
	END  

END

IF @ChangeoutProjTaskId<>0 SELECT @Task_Type_ID=TaskTypeID FROM tblTaskTypes Where Rebuild=1



SELECT @WorkGroupId=Work_Group_Id FROM WORK_GROUP WHERE Site_Id=@Site_Id AND Default_Record=1

SET @SJBranchId=@Branch_Id
SET @SJPriceGroupId=@Price_Group_Id

IF ISNULL(@RCMRuleId,0) > 0 AND ISNULL(@RCMConditionMonitoringId,0) > 0
BEGIN

	/*KN: TODO Select the default Task Counter.*/

	DECLARE @DefaultCBMAlertTaskCounterId INT
	SELECT @DefaultCBMAlertTaskCounterId = CAST(Varchar_Value AS INT) FROM AMT_TYPED_VARIABLE WHERE Value_Name = 'DefaultCBMAlertTaskCounterId'
 	
	SET @DefaultCBMAlertTaskCounterId = ISNULL(@DefaultCBMAlertTaskCounterId,-1)


	SELECT 
		@Component_Code_ID = PT.ComponentCodeId,
		@Modifier_ID = PT.ModifierId,
		@Task_Type_ID = PT.TaskTypeId,
		@Application_Code_ID = ISNULL(AC.ApplicationCodeId, RCS.ApplicationCodeId),
		@Occurrence_Type_Id = FM.OccurrenceTypeId,
		@Description = R.PlanningTaskMsg + ISNULL(@TaskDesc ,'') 
	FROM
		RCM_RULE R
		LEFT JOIN RCM_CONDITION_MONITORING RCM ON R.RCMConditionMonitoringId = RCM.RCMConditionMonitoringId
		LEFT JOIN RCM_FAILURE_MODE FM 	 ON RCM.RCMFailureModeId = FM.RCMFailureModeId
		LEFT JOIN RCM_COMPONENT_STRUCTURE RCS ON FM.RCMComponentStructureId = RCS.RCMComponentStructureId
		LEFT JOIN tblApplicationCodes AC ON AC.ApplicationCodeId = @DefaultCBMAlertTaskCounterId
		LEFT JOIN tblProjTasks PT ON PT.ProjTaskId = @RCMProjTaskId
	WHERE  R.RCMConditionMonitoringId = @RCMConditionMonitoringId AND R.RCMRuleId = @RCMRuleId
 
 
END

IF @TaskDefaults=1
BEGIN
	IF @Symptom_ID IS NULL SELECT @Symptom_ID=Symptom_ID FROM SYMPTOM WHERE Default_Record = 1

	IF @Cause_ID IS NULL SELECT @Cause_ID=Cause_ID FROM CAUSE WHERE Default_Record = 1

	IF @Repair_Code_ID IS NULL SELECT @Repair_Code_ID=Repair_Code_ID FROM REPAIR_CODE WHERE Default_Record = 1
	 
	IF @Task_Type_ID IS NULL SELECT @Task_Type_ID=TaskTypeID FROM tblTaskTypes WHERE Default_Record = 1
	
	IF @Component_Code_ID IS NULL SELECT @Component_Code_ID=ComponentCodeID FROM tblComponentCodes WHERE Default_Record = 1

	IF @Modifier_ID IS NULL SELECT @Modifier_ID=ModifierID FROM tblModifierCodes WHERE Default_Record = 1

	IF @Application_Code_ID IS NULL SELECT @Application_Code_ID=ApplicationCodeID FROM tblApplicationCodes WHERE Default_Record = 1

	IF @Occurrence_Type_Id IS NULL SELECT @Occurrence_Type_Id=OccurrenceTypeId FROM tblOccurrenceTypes WHERE Default_Record = 1
	
	IF @Health_Safety_ID IS NULL SELECT @Health_Safety_ID=Health_Safety_ID FROM HEALTH_SAFETY WHERE DefaultRecord <> 0

	SELECT @Source_Id= Source_Id FROM SOURCE where Default_Record = 1
	SELECT @Priority_ID=Priority_ID FROM PRIORITY WHERE Default_Record = 1

	SET @PartsStatusRequired=1
	SET @PartsStatusOrdered=0
	SET @PartsStatusReady=0

	
	DECLARE @z_TASK TABLE(
	Task_ID int ,
	Description varchar(500) COLLATE database_default,
	Eqp_Plan_ID int  ,
	Task_Type_ID int  ,
	Component_Code_ID int  ,
	Modifier_ID int  ,
	Application_Code_ID int  ,
	Occurrence_Type_Id int  ,
	Priority_ID int  ,
	Source_ID int,
	Task_Status_ID int ,
	Symptom_ID int  ,
	Cause_ID int  ,
	Expected_Duration float  ,
	Expected_Labor_Hours float,
	Planning_Notes varchar(8000) COLLATE database_default,	--AL: 22/05/08, 10/02/09
	Work_Order varchar(50) COLLATE database_default,
	Actual_Duration float  ,
	Actual_Labor_Hrs float  ,
	Primary_Cause bit  ,
	Notes varchar(1000) COLLATE database_default,
	Task_Mode_ID int ,
	PartsStatusRequired bit  ,
	PartsStatusOrdered bit  ,
	PartsStatusReady bit  ,
	Strategy_Usage real,
	Strategy_QUOM_ID int,
	Strategy_Proj_Task_Opt_ID int,
	Planned_Proj_Task_Opt_ID int,
	Strategy_Date datetime,
	Strategy_Locked bit  ,
	Repair_Code_Id int  ,
	Task_Header_Id int  ,
	Strategy_Repair_Description varchar(MAX) COLLATE database_default,	--AL: 12/06/08
	Cost_Bearer_ID int,
	Task_Warranty bit  ,
	Redo_Work_Order_ID int,
	View_Warranty bit  ,
	Health_Safety_Id int,
	Break_Down bit  ,
	Planned_Down_Time datetime,
	Actual_Down_Time datetime,
	Planned_Offset float  ,
	Final_Change float  ,
	Risk_Life_Left float  ,
	Strategy_Frequency float  ,
	Last_Performed float ,
	Last_Scheduled float,
	Last_Performed_Date datetime,
	Last_Scheduled_Date datetime,
	Site_Id int,
	Cost_Centre_Id int,
	Branch_Id int,
	Customer_Id int,
	Part_Entry_Distribution_Code_Id int,
	Part_Cost_Expense_Id int,
	Labour_Cost_Expense_Id int,
	Misc_Cost_Expense_Id int,
	Warranty_Days float  ,
	Warranty_Usage float,
	Strategy_Part_Num varchar(50) COLLATE database_default,
	Labour_Entry_Distribution_Code_Id int,
	Misc_Entry_Distribution_Code_Id int,
	AMTPlanningModeId int,
	Specific_Operation_Codes bit DEFAULT 1,
	ChangeoutCategoryId int,
	Work_Group_Id int,
	Def_Work_Group_Id int,
	WOCreateFromPO bit,
	LastNotified datetime,
	AuthorisationRequestByID int,
	AuthorisationRequestDate datetime,
	ResourceStatusReady bit,
	/*VV E621*/
	RebuildPartTypeId int,
	RebuildPartId int
	PRIMARY KEY(Task_Id))

	INSERT INTO @z_TASK(
	Task_ID, Description, Eqp_Plan_ID, Task_Type_ID, Component_Code_ID, Modifier_ID, Application_Code_ID, 
	Occurrence_Type_Id, Priority_ID, Source_ID, Task_Status_ID, Symptom_ID, Cause_ID, Expected_Duration, 
	Expected_Labor_Hours, Task_Mode_ID, --Parts_Resources_Identified,
	PartsStatusRequired, PartsStatusOrdered, PartsStatusReady,  
	Strategy_Usage,  Strategy_QUOM_ID, 
	Strategy_Proj_Task_Opt_ID, Planned_Proj_Task_Opt_ID, Strategy_Date, Strategy_Locked, 
	Repair_Code_Id, Task_Header_Id, Strategy_Repair_Description,Cost_Bearer_ID, Final_Change, Risk_Life_Left, 
	Strategy_Frequency, Last_Performed, Last_Scheduled, Last_Performed_Date, Last_Scheduled_Date, Site_Id, 
	Cost_Centre_Id, Branch_Id, Customer_Id, Part_Entry_Distribution_Code_Id, Part_Cost_Expense_Id, 
	Labour_Cost_Expense_Id, Misc_Cost_Expense_Id, Warranty_Days, Warranty_Usage,Strategy_Part_Num,
	Labour_Entry_Distribution_Code_Id, Misc_Entry_Distribution_Code_Id,AMTPlanningModeId,ChangeoutCategoryId,
	Work_Group_Id,Def_Work_Group_Id, WOCreateFromPO,
	Health_Safety_ID,/*VV E621*/RebuildPartTypeId,RebuildPartId)

	SELECT
	0 AS Task_ID ,
	@Description AS Description,
	@Eqp_Plan_ID As Eqp_Plan_ID,
	@Task_Type_ID as Task_Type_ID,
	@Component_Code_ID AS Component_Code_ID,
	@Modifier_ID AS Modifier_ID,
	@Application_Code_ID AS Application_Code_ID,
	@Occurrence_Type_Id AS Occurrence_Type_Id,
	@Priority_ID AS Priority_ID,
	@Source_ID AS Source_ID,
	CASE @EventId WHEN 0 THEN @Task_Status_OUS ELSE @Task_Status_YTS END AS Task_Status_ID,
	@Symptom_ID AS Symptom_ID,
	@Cause_ID AS Cause_ID,
	ISNULL(@Expected_Duration,0) AS Expected_Duration,
	@Expected_Labor_Hours AS Expected_Labor_Hours,
	@Task_Mode_ID AS Task_Mode_ID,
	@PartsStatusRequired AS PartsStatusRequired,
	@PartsStatusOrdered AS PartsStatusOrdered,
	@PartsStatusReady AS PartsStatusReady,
	@Strategy_Usage AS Strategy_Usage,
	@Strategy_QUOM_ID AS Strategy_QUOM_ID,
	@Proj_Task_Opt_ID AS Strategy_Proj_Task_Opt_ID,
	@Proj_Task_Opt_ID AS Planned_Proj_Task_Opt_ID,
	@Strategy_Date AS Strategy_Date,
	ISNULL(@Strategy_Locked,0) AS Strategy_Locked,
	@Repair_Code_Id AS Repair_Code_Id,
	@Task_Header_Id AS Task_Header_Id,
	@Strategy_Repair_Description AS Strategy_Repair_Description,
	@Cost_Bearer_ID AS Cost_Bearer_ID,
	@Final_Change AS Final_Change,
	@Risk_Life_Left AS Risk_Life_Left,
	@Strategy_Frequency AS Strategy_Frequency,
	@Last_Performed AS Last_Performed,
	@Last_Scheduled AS Last_Scheduled,
	@Last_Performed_Date AS Last_Performed_Date,
	@Last_Scheduled_Date AS Last_Scheduled_Date,
	@Site_Id AS Site_Id,
	@Cost_Centre_Id AS Cost_Centre_Id,
	@Branch_Id AS Branch_Id,
	@Customer_Id AS Customer_Id,
	@Part_Entry_Distribution_Code_Id AS Parts_Entry_Distribution_Code_Id,
	@Parts_Cost_Expense_Id AS Parts_Cost_Expense_Id,
	@Labour_Cost_Expense_Id AS Labour_Cost_Expense_Id,
	@Misc_Cost_Expense_Id AS Misc_Cost_Expense_Id,
	@Warranty_Days AS Warranty_Days,
	@Warranty_Usage AS Warranty_Usage,
	@Strategy_Part_Num AS Strategy_Part_Num,
	@Labour_Entry_Distribution_Code_Id AS Labour_Entry_Distribution_Code_Id,
	@Misc_Entry_Distribution_Code_Id AS Misc_Entry_Distribution_Code_Id,
	@AMTPlanningModeId AS AMTPlanningModeId,
	@ChangeoutCategoryId AS ChangeoutCategoryId,
	@WorkGroupId AS Work_Group_Id,
	@WorkGroupId AS Def_Work_Group_Id,
	@WOCreateFromPO AS WOCreateFromPO,
	@Health_Safety_ID AS Health_Safety_ID,
	/*VV E621*/
	@RebuildPartTypeId AS RebuildPartTypeId,@RebuildPartId AS RebuildPartId

	DECLARE @z_TASK_DOCUMENT TABLE(Work_Scope_Document_Id int PRIMARY KEY (Work_Scope_Document_Id))

	IF @Proj_Task_Opt_id>0
	BEGIN
		 
		--VV 23-Oct-2008
		CREATE TABLE #z_Jobs(JobCodeId int)

		INSERT INTO #z_Jobs(JobCodeId)
		SELECT DISTINCT 
		ISNULL(PTA.JobCodeId,CASE WHEN CA.Job_Code<>'CA - Multiple' THEN ABS(CA.Job_Code_Id) ELSE -1 END) AS JobCodeId
		FROM
		tblProjTaskAmts PTA
			LEFT JOIN
		dbo.COST_ALLOCATIONS_F('',0,0,0,0,0,@ProjTaskId) CA
			ON PTA.ProjTaskAmtId=CA.Proj_Task_Amt_Id
		WHERE PTA.ProjTaskOptId=@Proj_Task_Opt_id
			

		INSERT INTO @z_TASK_DOCUMENT(Work_Scope_Document_Id)
		
		SELECT DISTINCT WSJD.Document_Id AS Work_Scope_Document_Id
		FROM
		WORK_SCOPE_JOB WSJ
			INNER JOIN
		WORK_SCOPE_JOB_DOCUMENT WSJD
			ON WSJ.Work_Scope_Job_Id=WSJD.Work_Scope_Job_Id
		WHERE
			Component_Code_Id = @Component_Code_ID
		AND Task_Type_Id = @Task_Type_Id
		AND Model_Id = @ModelId
		AND WSJ.Job_Code_Id IN (SELECT JobCodeId FROM #z_Jobs)

		DROP TABLE #z_Jobs

		--VV CR8035
		INSERT INTO @z_TASK_DOCUMENT(Work_Scope_Document_Id)
		SELECT DISTINCT PTD.WorkScopeDocumentId
		FROM
		PROJ_TASK_DOCUMENT PTD
			INNER JOIN
		tblProjTaskOpts PTO
			ON PTO.ProjTaskOptId=@Proj_Task_Opt_Id AND PTD.ProjTaskId=PTO.ProjTaskId
			LEFT JOIN
		@z_TASK_DOCUMENT TD
			ON PTD.WorkScopeDocumentId=TD.Work_Scope_Document_Id
		WHERE TD.Work_Scope_Document_Id IS NULL
	END

	IF @ForWOCreate = 1
		BEGIN
			SELECT * FROM @z_TASK
			RETURN
		END
END --IF @TaskDefaults=1

--Task Operations
DECLARE @z_TASK_OPERATION TABLE(
	Task_Operation_Id int IDENTITY(-1,-1),
	Task_Id int DEFAULT 0,	
	Task_Operation varchar(200) COLLATE database_default,
	Component_Code_Id int,
	Modifier_Code_Id int,
	Job_Code_Id int,
	Work_Group_Id int,
	Health_Safety_Id int,
	Planned_Duration float,
	Actual_Duration float DEFAULT 0,
	Operation_Instructions varchar(8000) COLLATE database_default,	--AL: 22/05/08, 10/02/09
	/*Ignore_Operation bit DEFAULT 0,*/

	Cost_Bearer_Id int,
	Cost_Centre_Id int,
	Parts_Cost_Expense_Id int,
	Labour_Cost_Expense_Id int,
	Misc_Cost_Expense_Id int,
	Parts_Entry_Distribution_Code_Id int,
	Labour_Entry_Distribution_Code_Id int,
	Misc_Entry_Distribution_Code_Id int,
	Proj_Task_Amt_Id int,
	Priced_Job_id int,
	Std_Job_Op_Id int,
	Parts_Cost float,
	Labour_Cost float,
	Misc_Cost float,
	Labour_Hrs float,
	Labour_Activity_Id int,
	Overwrite_Costs bit DEFAULT 0,
	Std_Job_Id int,
	Parts_Usage_Factor float,
	OperationOffset float DEFAULT 0,
	SortOrder int,
	Last_Mod_Date datetime DEFAULT GETDATE(),
	NewTaskOpId int,
	/*VV #261 PRIMARY KEY(Task_Operation_Id)*/
	/*VV AmtMobile*/
	UniqueKey varchar(50) COLLATE DATABASE_DEFAULT DEFAULT NEWID())

--Task Operation Parts
DECLARE @z_TASK_OPERATION_PART TABLE(
Task_Operation_Part_Id int IDENTITY(-1,-1), 
Task_Operation_Id int, 
Part_Id int, 
Strategy_Qty float, 
Pct_Strategy_Probability float, 
Strategy_Unit_Price float, 
Include_In_Total bit, 
Proj_Task_Amt_Id int, 
Std_Job_Op_Id int,
Use_Credit_Price bit,
Full_Credit bit,
Supplier_Id int,
SourceOfSupplyId int,
--AL: 03/04/09
PartAvailabilityStatusId int,
/*VV CR8294*/
CostBearerID int,
CostCentreID int,
ExpenseElementID int,
WorkGroupID int
/*VV #261 PRIMARY KEY(Task_Operation_Part_Id)*/)

--Task operation labour
DECLARE @z_TASK_OPERATION_LABOUR TABLE(
Task_Operation_Labour_Id int IDENTITY(-1,-1),
Task_Operation_Id int ,
Work_Group_Id int,
Labour_Activity_Id int,
Labour_Activity varchar(50) COLLATE database_default,
Include_In_Total bit,
Strategy_Labour_Hrs float  ,
Strategy_Labour_Rate float,
/*VV CR8294*/
CostBearerID int,
CostCentreID int,
ExpenseElementID int
/*VV #261 PRIMARY KEY(Task_Operation_Labour_Id)*/) 

--Task operation misc
DECLARE @z_TASK_OPERATION_MISC TABLE(
Task_Operation_Misc_Id int IDENTITY(-1,-1),
Task_Operation_Id int,
Task_Operation_Misc_Desc varchar(200) COLLATE database_default,
Misc_Category_Id int,
Strategy_Sell float,
Include_In_Total bit,
Supplier_Id int,
/*VV CR8294*/
CostBearerID int,
CostCentreID int,
ExpenseElementID int,
WorkGroupID int
/*VV #261 PRIMARY KEY(Task_Operation_Misc_Id)*/)

/*VV AmtMobile*/
CREATE TABLE #z_EW_WORKORDER(EWWorkorderId int IDENTITY(-1,-1),TaskOperationId int,
EWTitle	varchar(200) COLLATE DATABASE_DEFAULT, UniqueKey varchar(50) COLLATE DATABASE_DEFAULT,
EWTemplateId int)

CREATE TABLE #z_EW_WORKSTEP(
	EWWorkstepId int IDENTITY(-1,-1),
	EWWorkorderId int,
	EWStepTemplateId int,
	Sequence int,
	EWWorkstepTitle varchar(200) COLLATE DATABASE_DEFAULT,
	ComponentCodeId int,
	CMCodeId int,
	Instructions varchar(1000) COLLATE DATABASE_DEFAULT,
	DocumentGUID varchar(50) COLLATE DATABASE_DEFAULT,
	DocumentExt varchar(50) COLLATE DATABASE_DEFAULT,
	Safety bit,
	Environmental bit,
	UniqueKey varchar(50) COLLATE DATABASE_DEFAULT
	)
	
--Create a temp table to hold the details from strategy task
IF @Proj_Task_Opt_Id>0
BEGIN
	--Select proj task documents

	DECLARE @z_ProjTaskAmt TABLE(
	ProjTaskAmtId int,
	Cost_Allocation_Id int,
	PricedJobId int, 
	JobCodeId int, 
	Duration float, 
	Work_Group_Id int, 
	Health_Safety_Id int, 
	Misc_Cost_Expense_ID int, 
    Labour_Cost_Expense_ID int, 
	Cost_Bearer_ID int, 
	Parts_Cost_Expense_ID int, 
	Parts_EDC_ID int, 
	Labour_EDC_ID int, 
	Misc_EDC_ID int,
	Cost_Centre_Id int,
	Parts_Cost float,
	Labour_Cost float,
	Misc_Cost float,
	Labour_Hrs float,
	Labour_Activity_Id int
	PRIMARY KEY (ProjTaskAmtId,Cost_Allocation_Id))

	INSERT INTO @z_ProjTaskAmt(
	ProjTaskAmtId,Cost_Allocation_Id,PricedJobId, JobCodeId, Duration, Work_Group_Id, Health_Safety_Id,  
	Misc_Cost_Expense_ID, Labour_Cost_Expense_ID, Cost_Bearer_ID, Parts_Cost_Expense_ID, Parts_EDC_ID, Labour_EDC_ID, 
	Misc_EDC_ID,Cost_Centre_Id,Parts_cost,Labour_Cost,Misc_Cost,Labour_Hrs,Labour_Activity_Id)
	SELECT ProjTaskAmtId,
	ISNULL(PTA.Cost_Allocation_Details_Id,0) AS Cost_Allocation_Id,	
	PricedJobId, JobCodeId, Duration, 
	/*1/11/07 VV*/ 
	ISNULL(Work_Group_Id,@WorkGroupId) AS Work_Group_Id, 
	Health_Safety_Id,  
	Misc_Cost_Expense_ID, Labour_Cost_Expense_ID, Cost_Bearer_ID, Parts_Cost_Expense_ID, Parts_EDC_ID, Labour_EDC_ID, 
	Misc_EDC_ID,Cost_Centre_Id,	
	PTA.PartsCost* CPE.CumPartsEscalation/ ERC.ExRate AS Parts_Cost,
	PTA.TotalLabourCost * CE.CumLaborEscalation/ ERC.ExRate AS Labour_Cost,
	PTA.TotalMiscCost * CE.CumMiscEscalation / ERC.ExRate AS Misc_Cost,
	LaborHours,Labour_Activity_Id

	FROM 
	PROJ_TASK_AMT_COST_1_V PTA
		INNER JOIN 
	tblCostEscalations CE
			ON PTA.Pricing_Date >= CE.EscalationDate AND PTA.Pricing_Date < CE.EndDate
			INNER JOIN 
	tblCostPartsEscalations CPE
			ON CE.CostEscalationId = CPE.CostEscalationId AND CPE.ManufacturerId = @ManufacturerId			
			INNER JOIN 
	tblExRateCurrencies ERC
			ON ERC.ExRateID = 0 AND ERC.CurrencyID = PTA.CurrencyID

	WHERE ProjTaskOptId=@Proj_Task_Opt_Id

	IF EXISTS(SELECT ProjTaskAmtId FROM @z_ProjTaskAmt WHERE PricedJobId IS NULL)
	BEGIN
		SELECT @Component=Description FROM tblComponentCodes WHERE ComponentCodeId=@Component_Code_Id

		--Proj jobs not liked to the std jobs
		INSERT INTO @z_TASK_OPERATION(	Task_Operation,
		Component_Code_Id,Modifier_Code_Id,Job_Code_Id,Work_Group_Id,Health_Safety_Id,Planned_Duration,		
		Cost_Bearer_Id,	Cost_Centre_Id,	Parts_Cost_Expense_Id,
		Labour_Cost_Expense_Id,	Misc_Cost_Expense_Id,Parts_Entry_Distribution_Code_Id,Labour_Entry_Distribution_Code_Id,
		Misc_Entry_Distribution_Code_Id,Proj_Task_Amt_Id,Parts_cost,Labour_Cost,Misc_Cost,Labour_Hrs,
		Labour_Activity_Id)
		SELECT @Component +/*VV 12-Dec-08*/ISNULL(' - '+JC.Description,'') AS Task_Operation,
		@Component_Code_Id AS Component_Code_Id,@Modifier_Id AS Modifier_Code_Id,
		PTA.JobCodeId,
		/*VV 1/10/2007*/
		ISNULL(CASE WHEN COUNT(DISTINCT ISNULL(Work_Group_Id,0))=1 THEN MAX(Work_Group_Id) ELSE NULL END,@WorkGroupId) AS Work_Group_Id,		
		Health_Safety_Id,SUM(Duration) AS Planned_Duration,
		CASE WHEN COUNT(DISTINCT ISNULL(Cost_Bearer_Id,0))=1 THEN MAX(Cost_Bearer_Id) ELSE NULL END AS Cost_Bearer_Id,	
		CASE WHEN COUNT(DISTINCT ISNULL(Cost_Centre_Id,0))=1 THEN MAX(Cost_Centre_Id) ELSE NULL END AS Cost_Centre_Id,	
		CASE WHEN COUNT(DISTINCT ISNULL(Parts_Cost_Expense_Id,0))=1 THEN MAX(Parts_Cost_Expense_Id) ELSE NULL END AS Parts_Cost_Expense_Id,
		CASE WHEN COUNT(DISTINCT ISNULL(Labour_Cost_Expense_Id,0))=1 THEN MAX(Labour_Cost_Expense_Id) ELSE NULL END AS Labour_Cost_Expense_Id,	
		CASE WHEN COUNT(DISTINCT ISNULL(Misc_Cost_Expense_Id,0))=1 THEN MAX(Misc_Cost_Expense_Id) ELSE NULL END AS Misc_Cost_Expense_Id,	
		CASE WHEN COUNT(DISTINCT ISNULL(Parts_EDC_ID,0))=1 THEN MAX(Parts_EDC_ID) ELSE NULL END AS Parts_Entry_Distribution_Code_Id,	
		CASE WHEN COUNT(DISTINCT ISNULL(Labour_EDC_ID,0))=1 THEN MAX(Labour_EDC_ID) ELSE NULL END AS Labour_Entry_Distribution_Code_Id,	
		CASE WHEN COUNT(DISTINCT ISNULL(Misc_EDC_ID,0))=1 THEN MAX(Misc_EDC_ID) ELSE NULL END AS Misc_Entry_Distribution_Code_Id,
		ProjTaskAmtId,SUM(Parts_Cost) AS Parts_Cost,SUM(Labour_Cost) AS Labour_Cost,SUM(Misc_Cost) AS Misc_Cost,
		SUM(Labour_Hrs) AS Labour_Hrs,Labour_Activity_Id
		FROM 
		@z_ProjTaskAmt PTA
			/*VV 12-Dec-2008*/
			LEFT JOIN
		tblJobCodes JC
			ON PTA.JobCodeId=JC.JobCodeId
		WHERE PricedJobId IS NULL
		GROUP BY PTA.JobCodeId,Health_Safety_Id,ProjTaskAmtId,JC.Description,Labour_Activity_Id
	END
	
	--Jobs which are linked to std jobs
	IF EXISTS(SELECT ProjTaskAmtId FROM @z_ProjTaskAmt WHERE PricedJobId>0)
	BEGIN
		INSERT INTO @z_TASK_OPERATION(Task_Id,Task_Operation,
		Component_Code_Id,Modifier_Code_Id,Job_Code_Id,Work_Group_Id,Health_Safety_Id,Planned_Duration,
		Cost_Bearer_Id,	Cost_Centre_Id,	Parts_Cost_Expense_Id,
		Labour_Cost_Expense_Id,	Misc_Cost_Expense_Id,
		Parts_Entry_Distribution_Code_Id,
		Labour_Entry_Distribution_Code_Id,Misc_Entry_Distribution_Code_Id,Proj_Task_Amt_Id,
		Priced_Job_id,Std_Job_Op_Id, 
		Overwrite_Costs,Parts_cost,Labour_Cost,Misc_Cost,Labour_Hrs,Std_Job_Id,Parts_Usage_Factor)
		SELECT 0 AS Task_Id,    
		SJO.StdJobOperation AS Task_Operation, SJO.ComponentCodeId as Component_Code_Id, 
		SJO.ModifierCodeId AS Modifier_Code_Id,	SJO.JobCodeId AS Job_Code_Id, 
		PTA.Work_Group_Id,PTA.Health_Safety_Id, 
		CASE SJ.Overwrite_Costs  WHEN 1 THEN Duration_Hrs ELSE SJO.DurationHours END AS Planned_Duration,
		PTA.Cost_Bearer_Id,	PTA.Cost_Centre_Id,	PTA.Parts_Cost_Expense_Id,
		PTA.Labour_Cost_Expense_Id,	PTA.Misc_Cost_Expense_Id,
		PTA.Parts_EDC_ID AS Parts_Entry_Distribution_Code_Id,
		PTA.Labour_EDC_ID AS Labour_Entry_Distribution_Code_Id,
		PTA.Misc_EDC_ID AS Misc_Entry_Distribution_Code_Id,
		PTA.ProjTaskAmtId AS Proj_Task_Amt_Id,PTA.PricedJobId AS Priced_Job_id,SJO.StdJobOperationId,
		SJ.Overwrite_Costs,
		(CASE SJ.Overwrite_Costs  WHEN 1 THEN SJ.Parts_Cost ELSE 0 END)/ERC.ExRate AS Parts_Cost , 
		(CASE SJ.Overwrite_Costs  WHEN 1 THEN SJ.Labour_Cost ELSE 0 END)/ERC.ExRate AS Labour_Cost, 		
		(CASE SJ.Overwrite_Costs  WHEN 1 THEN SJ.Misc_Cost ELSE 0 END)/ERC.ExRate AS Misc_Cost,
		CASE SJ.Overwrite_Costs  WHEN 1 THEN SJ.Labour_Hrs ELSE 0 END AS Labour_Hrs ,
		SJ.StdJobId AS Std_Job_Id,SJ.Parts_Usage_Factor		
		FROM  
		@z_ProjTaskAmt AS PTA 			
			INNER JOIN
		tblPricedJobs AS PJ 
			ON PTA.PricedJobId = PJ.PricedJobId 
			INNER JOIN
		tblStdJobs AS SJ 
			ON PJ.StdJobId = SJ.StdJobId 
			INNER JOIN
		tblStdJobOperations AS SJO 
			ON SJ.StdJobId = SJO.StdJobId
			INNER JOIN 
		tblExRateCurrencies ERC
			ON ERC.ExRateID = 0 AND ERC.CurrencyID = SJ.Currency_ID
	END

	/*drop table z_TASK_OPERATION
	select * into z_TASK_OPERATION from @z_TASK_OPERATION 
	return*/

	--Task operation parts from strategy tasks not linked to the std jobs
	INSERT INTO @z_TASK_OPERATION_PART(
	Task_Operation_Id, Part_Id, Strategy_Qty, Pct_Strategy_Probability, 
	Strategy_Unit_Price, Include_In_Total, Proj_Task_Amt_Id, Std_Job_Op_Id,Use_Credit_Price,Full_Credit,
	--AL: 03/04/09
	PartAvailabilityStatusId)
	SELECT     
	Task_Operation_Id, 
	NULL AS Part_Id, 1 AS Strategy_Qty, 100 AS Pct_Strategy_Probability, 
	Parts_Cost AS Strategy_Unit_Price, 1 AS Include_In_Total, Proj_Task_Amt_Id, Std_Job_Op_Id,
	0 AS Use_Credit_Price,0 AS Full_Credit,
	--AL: 03/04/09
	1 AS PartAvailabilityStatusId
	FROM @z_TASK_OPERATION
	WHERE (Parts_Cost>0 OR Parts_Cost<0) AND (Std_Job_Op_Id IS NULL) 

	--Task Operation labour from strategy tasks not linked to std jobs
	INSERT INTO @z_TASK_OPERATION_LABOUR(
	Task_Operation_Id,Work_Group_Id,Labour_Activity_Id,Strategy_Labour_Hrs,Strategy_Labour_Rate,Include_In_Total)
	SELECT TOPR.Task_Operation_Id,PTA.Work_Group_Id,PTA.Labour_Activity_Id,SUM(PTA.Labour_Hrs) AS Labour_Hrs,
	ISNULL(SUM(PTA.Labour_Cost)/NULLIF(SUM(PTA.Labour_Hrs),0),0) AS Strategy_Labour_Rate,1 AS Include_In_Total
	FROM
	(SELECT JobCodeId,Health_Safety_Id,ProjTaskAmtId,Work_Group_Id,
	Labour_Activity_Id,SUM(Labour_Hrs) AS Labour_Hrs,SUM(Labour_Cost) AS Labour_Cost
	FROM @z_ProjTaskAmt WHERE PricedJobId IS NULL
	GROUP BY JobCodeId,Health_Safety_Id,ProjTaskAmtId,Labour_Activity_Id,Work_Group_Id) PTA
		INNER JOIN
	@z_TASK_OPERATION TOPR
		ON PTA.ProjTaskAmtId=TOPR.Proj_Task_Amt_Id AND
		   PTA.JobCodeId=TOPR.Job_Code_Id AND
		   ISNULL(PTA.Health_Safety_Id,0)=ISNULL(TOPR.Health_Safety_Id,0) AND
		   ISNULL(PTA.Labour_Activity_Id,0)=ISNULL(TOPR.Labour_Activity_Id,0)
	WHERE TOPR.Std_Job_Op_Id IS NULL
	GROUP BY TOPR.Task_Operation_Id,PTA.Work_Group_Id,PTA.Labour_Activity_Id

	--Task Operation Misc from strategy task not linked to a std job
	INSERT INTO @z_TASK_OPERATION_MISC(
	Task_Operation_Id,Task_Operation_Misc_Desc,Misc_Category_Id,Strategy_Sell,Include_In_Total)
	SELECT
	TOPR.Task_Operation_Id,Task_Operation AS Task_Operation_Misc_Desc,
	@Def_Misc_Category_Id AS Misc_Category_Id,Misc_Cost AS Strategy_Sell,
	1 AS Include_In_Total
	FROM
	@z_TASK_OPERATION TOPR
	WHERE Std_Job_Op_Id IS NULL
	
END

ELSE IF @Std_Job_Id>0 OR @PricedJobId>0
BEGIN
	
	
	INSERT INTO @z_TASK_OPERATION(Task_Operation,
		Component_Code_Id,Modifier_Code_Id,Job_Code_Id,Planned_Duration,		
		Std_Job_Op_Id,
		Overwrite_Costs,Parts_cost,Labour_Cost,Misc_Cost,Labour_Hrs,Std_Job_Id,Parts_Usage_Factor,
		/*VV 1/11/2007*/Work_Group_Id)
		SELECT     
		SJO.StdJobOperation AS Task_Operation, SJO.ComponentCodeId as Component_Code_Id, 
		SJO.ModifierCodeId AS Modifier_Code_Id,	SJO.JobCodeId AS Job_Code_Id,

		CASE SJ.Overwrite_Costs  WHEN 1 THEN Duration_Hrs ELSE SJO.DurationHours END AS Planned_Duration,

		SJO.StdJobOperationId,
		SJ.Overwrite_Costs,
		(CASE SJ.Overwrite_Costs  WHEN 1 THEN SJ.Parts_Cost ELSE 0 END)/ERC.ExRate AS Parts_Cost , 
		(CASE SJ.Overwrite_Costs  WHEN 1 THEN SJ.Labour_Cost ELSE 0 END)/ERC.ExRate AS Labour_Cost, 		
		(CASE SJ.Overwrite_Costs  WHEN 1 THEN SJ.Misc_Cost ELSE 0 END)/ERC.ExRate AS Misc_Cost,
		CASE SJ.Overwrite_Costs  WHEN 1 THEN SJ.Labour_Hrs ELSE 0 END AS Labour_Hrs ,
		@Std_Job_Id AS Std_Job_Id,SJ.Parts_Usage_Factor,
		/*VV 1/11/2007*/
		@WorkGroupId AS Work_Group_Id
		FROM 		
		tblStdJobOperations SJO 
			INNER JOIN
		tblStdJobs SJ
			ON SJO.StdJobId=SJ.StdJobId
			INNER JOIN 
		tblExRateCurrencies ERC
			ON ERC.ExRateID = 0 AND ERC.CurrencyID = SJ.Currency_ID		
		WHERE SJO.StdJobId=@Std_Job_Id
END

--Duplicate descriptions
WHILE EXISTS(SELECT COUNT(Task_Operation_Id) FROM @z_TASK_OPERATION GROUP BY Task_Operation HAVING COUNT(Task_Operation_Id)>1)
BEGIN
	
	UPDATE TOPR
	SET TOPR.Task_Operation=TOPR.Task_Operation+'('+CAST(CTask_Operation AS varchar)+')'
	FROM 
	@z_TASK_OPERATION TOPR
		INNER JOIN
	(SELECT MAX(Task_Operation_Id) AS Task_Operation_Id,COUNT(Task_Operation_Id)-1 AS CTask_Operation
	FROM @z_TASK_OPERATION 
	GROUP BY Task_Operation 
	HAVING COUNT(Task_Operation_Id)>1) A 
		ON TOPR.Task_Operation_Id=A.Task_Operation_Id
END

IF EXISTS(SELECT Std_Job_Op_Id FROM @z_TASK_OPERATION WHERE Std_Job_Op_Id>0)
BEGIN
	--Task operation parts from std jobs
	INSERT INTO @z_TASK_OPERATION_PART(
	Task_Operation_Id, Part_Id, Strategy_Qty, Pct_Strategy_Probability, 
	Include_In_Total, Proj_Task_Amt_Id, Std_Job_Op_Id,Use_Credit_Price,Full_Credit,
	--AL: 03/04/09
	PartAvailabilityStatusId)

	SELECT  
	TOPR.Task_Operation_Id, SJOP.PartId, SJOP.Quantity AS Strategy_Qty, 
	SJOP.Probability AS Pct_Strategy_Probability, 
	CASE TOPR.Overwrite_Costs WHEN 1 THEN 0 ELSE 1 END AS Include_In_Total, 
	TOPR.Proj_Task_Amt_Id, TOPR.Std_Job_Op_Id,
	SJOP.Use_Credit_Price, SJOP.Full_Credit,
	--AL: 03/04/09
	1 AS PartAvailabilityStatusId
	FROM         
	tblStdJobOperationParts AS SJOP 
		INNER JOIN
	tblStdJobOperations AS SJO 
		ON SJOP.StdJobOperationId = SJO.StdJobOperationId 
		INNER JOIN
	@z_TASK_OPERATION AS TOPR 
		ON SJO.StdJobOperationId = TOPR.Std_Job_Op_Id

	SET @Counter=@@ROWCOUNT	
	
	--Only std jobs have partid
	IF @Counter>0
	BEGIN	
		UPDATE TOPP SET 
		Strategy_Unit_Price=(CASE WHEN TOPP.Use_Credit_Price = 0 THEN PP.Part_Sell 
								 WHEN TOPP.Full_credit = 1 THEN PP.Part_Sell - PP.Full_Credit_Sell 
								 ELSE PP.Part_Sell- PP.Partial_Credit_Sell END) * TOPR.Parts_Usage_Factor*PPA.Part_Price_Adjustment_Factor,
		SourceOfSupplyId=P.Source_Of_Supply_Id
		FROM
		@z_TASK_OPERATION TOPR
			INNER JOIN
		@z_TASK_OPERATION_PART TOPP
			ON TOPR.Task_Operation_Id=TOPP.Task_Operation_Id
			INNER JOIN	
		tblParts P 
			ON TOPP.Part_Id = P.PartId 
			INNER JOIN
		tblPartPrices PP 
			ON P.PartId = PP.PartId
			INNER JOIN
		PART_PRICE_ADJUSTMENT PPA
			ON P.Part_Type_Id=PPA.Part_Type_ID
		WHERE PP.Price_Group_ID=@SJPriceGroupID AND 
		PP.CurrencyId=@PrimCurrencyId AND 
		PPA.Fleet_ID=@FleetId

	END

	--Task Operation labour std jobs
	INSERT INTO @z_TASK_OPERATION_LABOUR(
	Task_Operation_Id,Work_Group_Id,Labour_Activity_Id,Labour_Activity,Strategy_Labour_Hrs,Strategy_Labour_Rate,
	Include_In_Total)
	SELECT TOPR.Task_Operation_Id,TOPR.Work_Group_Id,SJOL.Labour_Activity_Id,SJOL.Std_Job_Operation_Labour_Desc,
	SUM(SJOL.Labour_Hrs) AS Labour_Hrs,
	SUM(ISNULL(LR.LabourRatePerHour, SJOL.Sell_Rate)) AS Strategy_Labour_Rate,
	CASE TOPR.Overwrite_Costs WHEN 1 THEN 0 ELSE 1 END AS Include_In_Total
	FROM
	@z_TASK_OPERATION TOPR
		INNER JOIN
	STD_JOB_OPERATION_LABOUR SJOL
		ON TOPR.Std_Job_Op_Id=SJOL.Std_Job_Operation_ID
		LEFT OUTER JOIN
	LABOUR_RATE_DEF_V LR
		ON SJOL.Labour_Activity_Id=LR.LabourActivityId AND
		   LR.BranchId=@SJBranchId AND LR.CurrencyId=@PrimCurrencyId
	GROUP BY TOPR.Task_Operation_Id, TOPR.Work_Group_Id,
	SJOL.Labour_Activity_ID,Std_Job_Operation_Labour_Desc,TOPR.Overwrite_Costs

	--Task Operation Misc from std jobs
	INSERT INTO @z_TASK_OPERATION_MISC(
	Task_Operation_Id,Task_Operation_Misc_Desc,Misc_Category_Id,Strategy_Sell,Include_In_Total)
	SELECT
	TOPR.Task_Operation_Id,SJOM.Std_Job_Operation_Misc_Desc AS Task_Operation_Misc_Desc,
	SJOM.Misc_Category_Id AS Misc_Category_Id,SUM(SJOM.Sell) AS Strategy_Sell,
	CASE TOPR.Overwrite_Costs WHEN 1 THEN 0 ELSE 1 END AS Include_In_Total
	FROM
	@z_TASK_OPERATION TOPR
		INNER JOIN
	STD_JOB_OPERATION_MISC SJOM
		ON TOPR.Std_Job_Op_Id=SJOM.Std_Job_Operation_ID
	GROUP BY TOPR.Task_Operation_Id,Std_Job_Operation_Misc_Desc,
	SJOM.Misc_Category_Id,TOPR.Overwrite_Costs

	--Task operation parts from std jobs with overwrite costs set
	-- Add 1 line to the 1st operation
	IF EXISTS(SELECT Task_Operation_Id FROM @z_TASK_OPERATION WHERE Std_Job_Op_Id>0 AND Overwrite_Costs=1)
	BEGIN
		INSERT INTO @z_TASK_OPERATION_PART(
		Task_Operation_Id, Part_Id, Strategy_Qty, Pct_Strategy_Probability, 
		Include_In_Total, Proj_Task_Amt_Id, Std_Job_Op_Id,Use_Credit_Price,Full_Credit,
		Strategy_Unit_Price,
		--AL: 13/04/09
		PartAvailabilityStatusId)
		SELECT
		TOPR.Task_Operation_Id, NULL AS Part_Id, 1 AS Strategy_Qty, 
		100 AS Pct_Strategy_Probability, 1 AS Include_In_Total, 
		TOPR.Proj_Task_Amt_Id, TOPR.Std_Job_Op_Id,0 AS Use_Credit_Price,0 AS Full_Credit,
		TOPR.Parts_Cost,
		--AL: 13/04/09
		1 AS PartAvailabilityStatusId
		FROM
		@z_TASK_OPERATION TOPR
			INNER JOIN
		(SELECT  
		MIN(Task_Operation_Id) AS Task_Operation_Id
		FROM  
		@z_TASK_OPERATION 	
		WHERE Overwrite_Costs=1 AND Std_Job_Op_Id>0
		GROUP BY Std_Job_Id,Proj_Task_Amt_Id) A
			ON TOPR.Task_Operation_Id=A.Task_Operation_Id

		INSERT INTO @z_TASK_OPERATION_LABOUR(
		Task_Operation_Id,Work_Group_Id,Labour_Activity_Id,Labour_Activity,Strategy_Labour_Hrs,Strategy_Labour_Rate,
		Include_In_Total)
		SELECT
		TOPR.Task_Operation_Id,NULL AS Work_Group_Id,NULL AS Labour_Activity_Id,
		NULL AS Labour_Activity,1 AS Strategy_Labour_Hrs,TOPR.Labour_Cost AS Strategy_Labour_Rate,
		1 AS Include_In_Total
		FROM
		@z_TASK_OPERATION TOPR
			INNER JOIN
		(SELECT  
		MIN(Task_Operation_Id) AS Task_Operation_Id
		FROM  
		@z_TASK_OPERATION 	
		WHERE Overwrite_Costs=1 AND Std_Job_Op_Id>0
		GROUP BY Std_Job_Id,Proj_Task_Amt_Id) A
			ON TOPR.Task_Operation_Id=A.Task_Operation_Id

		INSERT INTO @z_TASK_OPERATION_MISC(
		Task_Operation_Id,Task_Operation_Misc_Desc,Misc_Category_Id,Strategy_Sell,Include_In_Total)
		SELECT
		TOPR.Task_Operation_Id,TOPR.Task_Operation AS Task_Operation_Misc_Desc,
		@Def_Misc_Category_Id AS Misc_Category_Id,TOPR.Misc_Cost AS Strategy_Sell,
		1 AS Include_In_Total
		FROM
		@z_TASK_OPERATION TOPR
			INNER JOIN
		(SELECT  
		MIN(Task_Operation_Id) AS Task_Operation_Id
		FROM  
		@z_TASK_OPERATION 	
		WHERE Overwrite_Costs=1 AND Std_Job_Op_Id>0
		GROUP BY Std_Job_Id,Proj_Task_Amt_Id) A
			ON TOPR.Task_Operation_Id=A.Task_Operation_Id
	END

END

/*VV AmtMobile 
Add checksheets for the operations created from standard jobs
*/
IF EXISTS(SELECT Task_Operation_Id FROM @z_TASK_OPERATION WHERE Std_Job_Op_Id>0)
BEGIN
	
	INSERT INTO #z_EW_WORKORDER(TaskOperationId,EWTitle,UniqueKey,EWTemplateId)
	SELECT O.Task_Operation_Id AS TaskOperationId, E.EWTitle,NEWID() AS UniqueKey,
	E.EWTemplateId 
	FROM 
	EW_TEMPLATE E
		INNER JOIN
	STD_JOB_OPERATION_EW_TEMPLATE J
		ON E.EWTemplateId=J.EWTemplateId
		INNER JOIN
	@z_TASK_OPERATION O
		ON J.StdJobOperationId=O.Std_Job_Op_Id
	
END

/* VV AmtMobile
Add checksheets from ew templates attached to the strategy task jobs. If there are standard
jobs attached to the strategy task jobs, add checksheets from strategy jobs only to the first
operation for the strategy task job
*/
IF EXISTS(SELECT Task_Operation_Id FROM @z_TASK_OPERATION WHERE Proj_Task_Amt_Id>0)
BEGIN
INSERT INTO #z_EW_WORKORDER(TaskOperationId,EWTitle,UniqueKey,EWTemplateId)
	SELECT O.Task_Operation_Id AS TaskOperationId, E.EWTitle,NEWID() AS UniqueKey,
	E.EWTemplateId 
	FROM 
	EW_TEMPLATE E
		INNER JOIN
	STRATEGY_TASK_JOB_EW_TEMPLATE STJ
		ON E.EWTemplateId=STJ.EWTemplateId
		INNER JOIN
	(SELECT Proj_Task_Amt_Id,MIN(Task_Operation_Id) AS Task_Operation_Id 
	FROM @z_TASK_OPERATION WHERE Proj_Task_Amt_Id>0 GROUP BY Proj_Task_Amt_Id) O
		ON STJ.ProjTaskAmtId=O.Proj_Task_Amt_Id
END
	
INSERT INTO #z_EW_WORKSTEP(EWWorkorderId,EWStepTemplateId,Sequence,EWWorkstepTitle,
ComponentCodeId,CMCodeId,Instructions,DocumentGUID,DocumentExt,Safety,Environmental,
UniqueKey)	

SELECT E.EWWorkorderId,S.EWStepTemplateId,S.Sequence,S.EWStepTitle AS EWWorkstepTitle,
S.ComponentCodeId,S.CMCodeId,S.Instructions,
CASE ISNULL(S.DocumentGUID,'') WHEN '' THEN NULL ELSE NEWID() END AS DocumentGUID,
S.DocumentExt,S.Safety,
S.Enviromental,NEWID() AS UniqueKey
FROM
EW_WORKSTEP_TEMPLATE S
	INNER JOIN
#z_EW_WORKORDER E
	ON S.EWTemplateId=E.EWTemplateId


IF @TaskDefaults=1
BEGIN
	--Update Task with codes from the first operation
	SELECT @TaskOperationId=MIN(Task_Operation_Id) FROM @z_Task_Operation

	IF ISNULL(@TaskOperationId,0)<>0
	BEGIN
		UPDATE T
		SET T.Cost_Bearer_Id=ISNULL(O.Cost_Bearer_Id,@Cost_Bearer_id),
		T.Cost_Centre_Id=ISNULL(O.Cost_Centre_Id,@Cost_Centre_Id),
		T.Part_Cost_Expense_Id=ISNULL(O.Parts_Cost_Expense_Id,@Parts_Cost_Expense_Id),
		T.Labour_Cost_Expense_Id=ISNULL(O.Labour_Cost_Expense_Id,@Labour_Cost_Expense_Id),
		T.Misc_Cost_Expense_Id=ISNULL(O.Misc_Cost_Expense_Id,@Misc_Cost_Expense_Id),
		T.Part_Entry_Distribution_Code_Id=ISNULL(O.Parts_Entry_Distribution_Code_Id,@Part_Entry_Distribution_Code_Id),
		T.Labour_Entry_Distribution_Code_Id=ISNULL(O.Labour_Entry_Distribution_Code_Id,@Labour_Entry_Distribution_Code_Id),
		T.Misc_Entry_Distribution_Code_Id=ISNULL(O.Misc_Entry_Distribution_Code_Id,@Misc_Entry_Distribution_Code_Id),
		/*VV 1/11/2007*/
		T.Work_Group_Id=ISNULL(O.Work_Group_Id,@WorkGroupId),
		T.Def_Work_Group_Id=ISNULL(O.Work_Group_Id,@WorkGroupId)
		FROM
		@z_TASK T
			CROSS JOIN
		(SELECT Cost_Bearer_Id,Cost_Centre_Id,Parts_Cost_Expense_Id,Labour_Cost_Expense_Id,Misc_Cost_Expense_Id,
		Parts_Entry_Distribution_Code_Id,Labour_Entry_Distribution_Code_Id,Misc_Entry_Distribution_Code_Id,
		/*VV 1/11/2007*/Work_Group_Id
		FROM @z_Task_Operation WHERE Task_Operation_Id=@TaskOperationId) O
	END
END

/*VV CR8294*/
UPDATE O SET
O.Work_Group_Id=ISNULL(ISNULL(O.Work_Group_Id,T.Work_Group_Id),/*VV CR8498*/@WorkGroupId),
O.Cost_Bearer_Id =ISNULL(ISNULL(O.Cost_Bearer_Id,T.Cost_Bearer_Id),/*VV CR8498*/@Cost_Bearer_id),
O.Cost_Centre_Id =ISNULL(ISNULL(O.Cost_Centre_Id,T.Cost_Centre_Id),/*VV CR8498*/@Cost_Centre_Id),
O.Parts_Cost_Expense_Id  =ISNULL(ISNULL(O.Parts_Cost_Expense_Id ,T.Part_Cost_Expense_Id),/*VV CR8498*/@Parts_Cost_Expense_Id),
O.Labour_Cost_Expense_Id =ISNULL(ISNULL(O.Labour_Cost_Expense_Id,T.Labour_Cost_Expense_Id),/*VV CR8498*/@Labour_Cost_Expense_Id),
O.Misc_Cost_Expense_Id=ISNULL(ISNULL(O.Misc_Cost_Expense_Id,T.Misc_Cost_Expense_Id),/*VV CR8498*/@Misc_Cost_Expense_Id)
FROM
@z_TASK_OPERATION O
	LEFT JOIN
@z_TASK T
	ON O.Task_Id=T.Task_Id

UPDATE L SET
L.CostBearerID=ISNULL(L.CostBearerID,O.Cost_Bearer_Id),
L.CostCentreID =ISNULL(L.CostCentreID,O.Cost_Centre_Id),
L.ExpenseElementID =ISNULL(L.ExpenseElementID,O.Labour_Cost_Expense_Id ),
L.Work_Group_ID =ISNULL(L.Work_Group_ID,O.Work_Group_Id)
FROM
@z_TASK_OPERATION_LABOUR L
	INNER JOIN
@z_TASK_OPERATION O
	ON L.Task_Operation_Id=O.Task_Operation_Id

UPDATE P SET
P.CostBearerID=ISNULL(P.CostBearerID,O.Cost_Bearer_Id),
P.CostCentreID =ISNULL(P.CostCentreID,O.Cost_Centre_Id),
P.ExpenseElementID =ISNULL(P.ExpenseElementID,O.Parts_Cost_Expense_Id),
P.WorkGroupID =ISNULL(P.WorkGroupID,O.Work_Group_Id)
FROM
@z_TASK_OPERATION_PART P
	INNER JOIN
@z_TASK_OPERATION O
	ON P.Task_Operation_Id=O.Task_Operation_Id

UPDATE M SET
M.CostBearerID=ISNULL(M.CostBearerID,O.Cost_Bearer_Id),
M.CostCentreID =ISNULL(M.CostCentreID,O.Cost_Centre_Id),
M.ExpenseElementID =ISNULL(M.ExpenseElementID,O.Misc_Cost_Expense_Id),
M.WorkGroupID =ISNULL(M.WorkGroupID,O.Work_Group_Id)
FROM
@z_TASK_OPERATION_MISC M
	INNER JOIN
@z_TASK_OPERATION O
	ON M.Task_Operation_Id=O.Task_Operation_Id


--AL: 06/04/10
DECLARE @PartCount int

IF ISNULL(@AutoLookupPartsReadyStatus,0)<>0
BEGIN
	SELECT @PartCount=COUNT(*)
	FROM
		(SELECT CAST(CASE WHEN Pct_Strategy_Probability<100.00 THEN 0.00 
				ELSE Strategy_Qty END AS float) *
				CAST(Include_In_Total AS float) AS Planned_Qty
		FROM @z_TASK_OPERATION_PART)P
	WHERE Planned_Qty>0
	
	UPDATE @z_TASK
	SET PartsStatusRequired=CASE WHEN ISNULL(@PartCount,0)=0 THEN 0 ELSE 1 END
END


IF @Add=1
BEGIN
	IF @Task_Mode_Id=@Task_Mode_AW
		BEGIN
		IF ISNULL(@Component_Code_ID,0)=0
			SET @Message='Component Code is required for work order to be linked to a task.'
		ELSE IF ISNULL(@Task_Type_ID,0)=0
			SET @Message='Task Type is required for work order to be linked to a task.'
		ELSE 
		BEGIN
			DECLARE @TotalSell float,@PartsQty float,@LabourHrs float

			--AL: 03/04/09
			SELECT	@TotalSell=ISNULL(SUM(TOOP.ActualTotalSell), 0)+
						ISNULL(SUM(TOOL.ActualTotalSell),0)+ 
						ISNULL(SUM(TOOM.Actual_Sell), 0), 
--					@TotalSell=ISNULL(SUM(TOOP.Actual_Qty * TOOP.Actual_Unit_Price), 0)+
--						ISNULL(SUM(TOOL.Actual_Labour_Hrs * TOOL.Actual_Labour_Rate),0)+ 
--						ISNULL(SUM(TOOM.Actual_Sell), 0), 
					@PartsQty=ISNULL(SUM(TOOP.Actual_Qty), 0),
					@LabourHrs=ISNULL(SUM(TOOL.Actual_Labour_Hrs), 0)
			FROM         
					TASK AS T LEFT OUTER JOIN
					TASK_OPERATION AS TOO ON T.Task_ID = TOO.Task_Id LEFT OUTER JOIN
					TASK_OPERATION_PART AS TOOP ON TOO.Task_Operation_Id = TOOP.Task_Operation_Id LEFT OUTER JOIN
					TASK_OPERATION_MISC AS TOOM ON TOO.Task_Operation_Id = TOOM.Task_Operation_Id LEFT OUTER JOIN
					TASK_OPERATION_LABOUR AS TOOL ON TOO.Task_Operation_Id = TOOL.Task_Operation_Id
			WHERE  
					(T.Task_ID = @TaskId)

			IF @Task_Status_ID=5 AND (ISNULL(@TotalSell,0)<>0 OR ISNULL(@PartsQty,0)<>0 OR ISNULL(@LabourHrs,0)<>0)
				SET @Message='Cannot Abandon Task if there are Actual costs, labour hours or parts'
		END

		IF ISNULL(@Message,'')<>''	
			RETURN

	END



	SET XACT_ABORT ON
	BEGIN TRANSACTION 

	--Add Task
	INSERT INTO TASK(
	Description, 		
	Task_Status_ID, 
	Eqp_Plan_ID, 
	Event_Id,
	Task_Type_ID, 
	Component_Code_ID, 
	Modifier_ID, 
	Application_Code_ID, 
	Occurrence_Type_Id, 
	Priority_ID, 
	Source_ID, 
	Task_Mode_ID, 
	PartsStatusRequired, 		
	PartsStatusOrdered, 		
	PartsStatusReady, 		
	Strategy_Usage, 
	Strategy_QUOM_ID, 
	Strategy_Proj_Task_Opt_ID, 
	Planned_Proj_Task_Opt_ID, 
	Strategy_Date, 
	Strategy_Locked, 		 
	Strategy_Repair_Description, 
	Cost_Bearer_ID, 		
	Cause_Id,
	Symptom_Id,		
	Repair_Code_Id,
	Final_Change,
	Risk_Life_Left, 
	Strategy_Frequency,
	Last_Performed, 
	Last_Scheduled, 
	Last_Performed_Date,
	Last_Scheduled_Date,
	Site_Id,
	Cost_Centre_Id, 
	Branch_Id,
	Part_Entry_Distribution_Code_Id, 
	Labour_Entry_Distribution_Code_Id, 
	Misc_Entry_Distribution_Code_Id,
	Task_Authorised,
	Customer_Id,
	Parts_Cost_Expense_Id, 
	Labour_Cost_Expense_Id, 
	Misc_Cost_Expense_Id, 
	AMTPlanningModeId,
	Specific_Operation_Codes,
	Warranty_Days,
	Warranty_Usage,
	ChangeoutCategoryId,
	/*VV 1/11/2007*/
	Work_Group_Id,
	Def_Work_Group_Id,
	Primary_Cause,
	--AL: 20/02/09
	Expected_Duration,
	Symptom_Notes,
	ConditionMonitoringIntervention,
	/*VV CR8449*/
	Last_Mod_By_User_ID,
	Last_Mod_Date,
	Create_By_User_ID,
	Create_Date,
	--AL: 29/03/10
	Health_Safety_ID,LastNotified
	)

	SELECT
	T.Description, 		
	T.Task_Status_ID, 
	T.Eqp_Plan_ID,
	NULLIF(@EventId,0), 
	T.Task_Type_ID, 
	T.Component_Code_ID, 
	T.Modifier_ID, 
	T.Application_Code_ID, 
	T.Occurrence_Type_Id, 
	T.Priority_ID, 
	T.Source_ID, 
	T.Task_Mode_ID, 
	T.PartsStatusRequired,
	T.PartsStatusOrdered,
	T.PartsStatusReady,
	T.Strategy_Usage, 
	T.Strategy_QUOM_ID, 
	NULLIF(T.Strategy_Proj_Task_Opt_ID,0) AS Strategy_Proj_Task_Opt_ID,
	NULLIF(T.Planned_Proj_Task_Opt_ID,0) AS  Planned_Proj_Task_Opt_ID,
	T.Strategy_Date, 
	ISNULL(T.Strategy_Locked, 0) AS Strategy_Locked,	 
	ISNULL(T.Strategy_Repair_Description,''),
	T.Cost_Bearer_ID, 		
	T.Cause_Id,
	T.Symptom_Id,		
	T.Repair_Code_Id,
	ISNULL(@Final_Change,0) AS Final_Change,
	ISNULL(@Risk_Life_Left,0) AS Risk_Life_Left, 
	ISNULL(@Strategy_Frequency,0) AS Strategy_Frequency,
	@Last_Performed AS  Last_Performed, 
	@Last_Scheduled AS Last_Scheduled, 
	@Last_Performed_Date AS Last_Performed_Date,
	@Last_Scheduled_Date AS Last_Scheduled_Date,
	@Site_Id AS Site_Id,
	T.Cost_Centre_Id, 
	@Branch_Id AS Branch_Id,
	T.Part_Entry_Distribution_Code_Id, 
	T.Labour_Entry_Distribution_Code_Id, 
	T.Misc_Entry_Distribution_Code_Id,

	--AL: 03/02/09
	CASE @AuthorisationMode
		WHEN @AuthModeNone THEN 1
		WHEN @AuthModeAdvanced THEN 0
		ELSE CASE WHEN ISNULL(T.Strategy_Proj_Task_Opt_ID,0)>0 AND ISNULL(@EventId,0)<1 THEN 1 ELSE 0 END --AL: 11/02/09
	END AS Task_Authorised,

	T.Customer_Id,
	T.Part_Cost_Expense_Id AS Parts_Cost_Expense_Id, 
	T.Labour_Cost_Expense_Id, 
	T.Misc_Cost_Expense_Id, 
	T.AMTPlanningModeId,
	T.Specific_Operation_Codes,
	ISNULL(T.Warranty_Days,0) AS Warranty_Days,
	ISNULL(T.Warranty_Usage,0) AS Warranty_Usage,
	@ChangeoutCategoryId AS ChangeoutCategoryId,
	/*VV 1/11/2007*/
	T.Work_Group_Id,
	T.Def_Work_Group_Id,
	/*KN 12 Feb 2007*/
	@IsPrimaryTask,
	--AL: 20/02/09
	T.Expected_Duration,
	@WOSymptoms,
	CASE WHEN ISNULL(@RCMRuleId,0) > 0 AND ISNULL(@RCMConditionMonitoringId,0) > 0 THEN 1 ELSE 0 END,
	/*VV CR8449*/
	@UserId AS Last_Mod_By_User_ID,
	GETDATE() AS Last_Mod_Date,
	@UserId AS Create_By_User_ID,
	GETDATE() AS Create_Date,
	--AL: 29/03/10
	T.Health_Safety_ID,GETDATE()
	
	FROM @z_TASK T

	SET @TaskId=SCOPE_IDENTITY()

	--Library documents
	IF EXISTS(SELECT Work_Scope_Document_Id FROM @z_TASK_DOCUMENT)
	BEGIN
		INSERT INTO TASK_DOCUMENT(Task_Id,Work_Scope_Document_Id)
		SELECT @TaskId AS Task_Id,Work_Scope_Document_Id
		FROM @z_TASK_DOCUMENT
	END

	--VV CR8035
	IF EXISTS(SELECT PTED.ProjTaskExternalDocumentId FROM 
		PROJ_TASK_EXTERNAL_DOCUMENT PTED
			INNER JOIN
		tblProjTaskOpts PTO
			ON PTO.ProjTaskOptId=@Proj_Task_Opt_Id AND PTED.ProjTaskId=PTO.ProjTaskId)
	BEGIN
		INSERT INTO TASK_EXTERNAL_DOCUMENT(TaskId,DocumentLink,DocumentName)
		SELECT @TaskId AS TaskId, PTED.DocumentLink,PTED.DocumentName FROM
		PROJ_TASK_EXTERNAL_DOCUMENT PTED
			INNER JOIN
		tblProjTaskOpts PTO
			ON PTO.ProjTaskOptId=@Proj_Task_Opt_Id AND PTED.ProjTaskId=PTO.ProjTaskId
	END


	--Check if we need to add operations
	SELECT @OpCount=COUNT(Task_Operation_Id) FROM @z_TASK_OPERATION

	SET @OpCount=ISNULL(@OpCount,0)

	IF @OpCount>0 
	BEGIN

		--Add Operations
		INSERT INTO TASK_OPERATION(
		Task_Id, SortOrder,
		Task_Operation,Operation_Instructions,Planned_Duration,
		Actual_Duration,Cost_Bearer_Id,Cost_Centre_Id, 
		Parts_Cost_Expense_Id, Labour_Cost_Expense_Id, Misc_Cost_Expense_Id,
		Parts_Entry_Distribution_Code_Id,Labour_Entry_Distribution_Code_Id,
		Misc_Entry_Distribution_Code_Id,Component_Code_Id, 
		Modifier_Code_Id,Job_Code_Id, Work_Group_Id, Health_Safety_Id, 
		Proj_Task_Amt_Id,Std_Job_Op_Id,/*VV AmtMobile*/UniqueKey)
		SELECT     
		@TaskId AS Task_Id, ABS(O.Task_Operation_Id) AS SortOrder,
		O.Task_Operation,O.Operation_Instructions,O.Planned_Duration,
		O.Actual_Duration,O.Cost_Bearer_Id,O.Cost_Centre_Id, 
		O.Parts_Cost_Expense_Id, O.Labour_Cost_Expense_Id, O.Misc_Cost_Expense_Id,
		O.Parts_Entry_Distribution_Code_Id,O.Labour_Entry_Distribution_Code_Id,
		O.Misc_Entry_Distribution_Code_Id,O.Component_Code_Id, 
		O.Modifier_Code_Id,O.Job_Code_Id, O.Work_Group_Id, O.Health_Safety_Id, 
		O.Proj_Task_Amt_Id,O.Std_Job_Op_Id,/*VV AmtMobile*/O.UniqueKey
		FROM @z_TASK_OPERATION O
		
		--select @TaskId return
		--Update the temp table for task operations with the new id
		UPDATE Z
		SET NewTaskOpId=O.Task_Operation_Id
		FROM
		@z_TASK_OPERATION Z 
			INNER JOIN
		TASK_OPERATION O 
			ON O.Task_Id=@TaskId AND -Z.Task_Operation_Id=O.SortOrder

		--select * FROM @z_TASK_OPERATION return

		--AL: 07/04/09
		DECLARE @PrimaryCurrencyId int,@FinPeriod int
		SELECT TOP 1 @PrimaryCurrencyId = CurrencyId FROM tblCurrencies WHERE ISNULL(PrimaryCurr, 0) <> 0
		SET	@FinPeriod=dbo.TASK_JOBDATE_F(@TaskId,0,2)	--AL: 08/04/09

		IF EXISTS(SELECT Task_Operation_Part_id FROM @z_TASK_OPERATION_PART)	
		BEGIN

			INSERT INTO TASK_OPERATION_PART(Task_Operation_Id,Part_Number,
			Part_Description,Strategy_Qty, Pct_Strategy_Probability, 
			Strategy_Unit_Price,Planned_Qty,Planned_Unit_Price,Supplier_Id, Include_In_Total,		
			IsEditable,Last_Mod_By_User_ID,Last_Mod_Date,Create_By_User_ID,
			Create_Date,SourceOfSupplyId,
			--AL: 03/04/09
			ActualTotalSell,
			ActualTotalCost,
			--AL: 07/04/09
			FinPeriod,CurrencyId,ExchangeRate,
			/*VV CR8294*/
			CostBearerID,CostCentreID ,ExpenseElementID ,WorkGroupID )

			SELECT     
			O.NewTaskOpId AS Task_Operation_Id,PA.Part AS Part_Number,
			ISNULL(PA.PartDescription,@DefDescription) AS Part_Description,
			P.Strategy_Qty, P.Pct_Strategy_Probability, P.Strategy_Unit_Price,	
			CAST(CASE WHEN P.Pct_Strategy_Probability<100.00 THEN 0.00 
			ELSE P.Strategy_Qty END AS float) *
			CAST(P.Include_In_Total AS float) AS Planned_Qty,
			Strategy_Unit_Price AS Planned_Unit_Price,	
			P.Supplier_Id, P.Include_In_Total,		
			@IsEditable AS IsEditable,
			@UserId AS Last_Mod_By_User_ID,GETDATE() AS Last_Mod_Date, 
			@UserId AS Create_By_User_ID,GETDATE() AS Create_Date,
			P.SourceOfSupplyId,
			--AL: 03/04/09
			0 AS TotalActualSell,
			CASE WHEN ISNULL(@ManualEntryActualsParts,1)=3 THEN NULL ELSE 0 END AS ActualTotalCost,
			--AL: 07/04/09
			@FinPeriod,@PrimaryCurrencyId,1,
			/*VV CR8294*/
			P.CostBearerID,P.CostCentreID ,P.ExpenseElementID ,P.WorkGroupID

			FROM   	 
			@z_TASK_OPERATION O 		
				INNER JOIN
			@z_TASK_OPERATION_PART P 
				ON O.Task_Operation_Id = P.Task_Operation_Id
				LEFT OUTER JOIN
			tblParts PA
				ON P.Part_Id=PA.PartId
				
			
		END	

		--Operation labour
		IF EXISTS(SELECT Task_Operation_Labour_id FROM @z_TASK_OPERATION_LABOUR)	
		BEGIN
			INSERT INTO TASK_OPERATION_LABOUR(
			Task_Operation_Id, Labour_Activity,Strategy_Labour_Hrs,
			Strategy_Labour_Rate,
			Labour_Qty,Planned_Labour_Hrs,
			Planned_Labour_Rate,
			Work_Group_Id,Labour_Activity_Id, Include_In_Total, 
			Create_By_User_Id,Create_Date,
			Last_Mod_By_User_Id,Last_Mod_Date,
			IsEditable,
			--AL: 03/04/09
			ActualTotalSell,
			ActualTotalCost,
			--AL: 07/04/09
			FinPeriod,CurrencyId,ExchangeRate,
			/*VV CR8294*/
			CostBearerID,CostCentreID ,ExpenseElementID)

			SELECT
			O.NewTaskOpId AS Task_Operation_Id, L.Labour_Activity,L.Strategy_Labour_Hrs,
			L.Strategy_Labour_Rate,
			1 AS Planned_Qty,
			L.Strategy_Labour_Hrs *
			CAST(L.Include_In_Total As float) AS Planned_Labour_Hrs,
			L.Strategy_Labour_Rate AS Planned_Labour_Rate,
			L.Work_Group_Id,L.Labour_Activity_Id, L.Include_In_Total, 
			@UserId AS Create_By_User_Id,GETDATE() AS Create_Date,
			@UserId AS Last_Mod_By_User_Id,GETDATE() AS Last_Mod_Date,
			@IsEditable AS IsEditable,
			--AL: 03/04/09
			0 AS TotalActualSell,
			CASE WHEN ISNULL(@ManualEntryActualsLabour,1)=3 THEN NULL ELSE 0 END AS ActualTotalCost,
			--AL: 07/04/09
			@FinPeriod,@PrimaryCurrencyId,1,
			/*VV 8294*/
			L.CostBearerID,L.CostCentreID ,L.ExpenseElementID

			FROM 
			@z_TASK_OPERATION O 		
				INNER JOIN
			@z_TASK_OPERATION_LABOUR L
				ON O.Task_Operation_Id = L.Task_Operation_Id
		END
		--Operation misc
		IF EXISTS(SELECT Task_Operation_Misc_Id FROM @z_TASK_OPERATION_MISC)	
		BEGIN
			INSERT INTO TASK_OPERATION_MISC(
			Task_Operation_Id,Task_Operation_Misc_Desc,Strategy_Sell,
			Planned_Sell,Misc_Category_Id,Include_In_Total, Supplier_Id, IsEditable,
			--AL: 03/04/09
			Actual_Sell,ActualCost,
			--AL: 07/04/09
			FinPeriod,CurrencyId,ExchangeRate,
			/*VV 8294*/
			CostBearerID,CostCentreID ,ExpenseElementID ,WorkGroupID)

			SELECT
			O.NewTaskOpId AS Task_Operation_Id,
			M.Task_Operation_Misc_Desc,
			M.Strategy_Sell,
			M.Strategy_Sell*CAST(M.Include_In_Total AS float) AS Planned_Sell,
			M.Misc_Category_Id, M.Include_In_Total, M.Supplier_Id, 
			@IsEditable AS IsEditable,
			--AL: 03/04/09
			0 AS Actual_Sell,
			CASE WHEN ISNULL(@ManualEntryActualsMisc,1)=3 THEN NULL ELSE 0 END AS ActualCost,
			--AL: 07/04/09
			@FinPeriod,@PrimaryCurrencyId,1,
			/*VV 8294*/
			M.CostBearerID,M.CostCentreID ,M.ExpenseElementID ,M.WorkGroupID

			FROM 
			@z_TASK_OPERATION O 		
				INNER JOIN
			@z_TASK_OPERATION_MISC m
				ON O.Task_Operation_Id = M.Task_Operation_Id
		END
		
		/*VV AmtMobile*/
		IF EXISTS(SELECT * FROM #z_EW_WORKORDER)
		BEGIN
			INSERT INTO EW_WORKORDER(TaskOperationId,EWTitle,UniqueKey,LastModByUserId,LastModDate)
			SELECT O.Task_Operation_Id AS TaskOperationId,E.EWTitle,E.UniqueKey,
			@UserId AS LastModByUserId, GETDATE() AS LastModDate 
			FROM 
			#z_EW_WORKORDER E
				INNER JOIN
			@z_TASK_OPERATION Z
				ON E.TaskOperationId=Z.Task_Operation_Id
				INNER JOIN
			TASK_OPERATION O
				ON Z.UniqueKey=O.UniqueKey
				
			
			INSERT INTO EW_WORKSTEP(EWWorkorderId,EWStepTemplateId,Sequence,EWWorkstepTitle,
			ComponentCodeId,CMCodeId,Instructions,DocumentGUID,DocumentExt,Safety,Environmental,
			UniqueKey,LastModByUserId,LastModDate)
			SELECT EW.EWWorkorderId,S.EWStepTemplateId,S.Sequence,S.EWWorkstepTitle,S.ComponentCodeId,
			S.CMCodeId,S.Instructions,S.DocumentGUID,S.DocumentExt,S.Safety,S.Environmental,
			S.UniqueKey,@UserId AS LastModByUserId, GETDATE() AS LastModDate 
			FROM 
			#z_EW_WORKSTEP S
				INNER JOIN
			#z_EW_WORKORDER E
				ON S.EWWorkorderId=E.EWWorkorderId
				INNER JOIN
			EW_WORKORDER EW
				ON E.UniqueKey=EW.UniqueKey
				
			SET @CopyEWTemplateFiles=1
		END
	END
	
	--AL: 09/02/09
	EXEC TASK_OPERATION_CHECK_ADD_P @TaskID=@TaskID,@IsEditable=@IsEditable,@UserId=@UserId

	--AL: 19/03/09
	IF @Task_Mode_Id=@Task_Mode_AW
		EXEC TASK_AUTO_CREATE_WO_P @TaskID =@TaskID,@Message=@Message OUTPUT

	COMMIT TRANSACTION 
	--Note: if there is a problem, AMTData will abort the transaction

END--IF @Add=1

IF @Add=0
BEGIN
	/*VV 27-Apr-2009*/
	EXEC AMT_TYPED_VARIABLE_GET_P @Value_Name='ExternalDocumentSystem',  @Varchar_Value=@ExternalDocumentSystem OUTPUT
	/*VV 30-Apr-2009*/
	EXEC AMT_TYPED_VARIABLE_GET_P @Value_Name='ExtDocUseClientCredentials',  @Varchar_Value=@ExtDocUseClientCredentials OUTPUT
	
	IF @TaskDefaults=1
	BEGIN
		SELECT     
		@CompanyCode=D.Company_Code,
		/*VV E621*/@EqpSite=S.Site,@EqpCustomer=ISNULL(CUE.Customer,CU.Customer)
		FROM 
		@z_TASK T INNER JOIN 
		tblEqpPlans AS EP ON EP.EqpPlanId=T.Eqp_Plan_Id INNER JOIN
		tblFleets AS F ON EP.FleetId = F.FleetId INNER JOIN
		tblSites AS S ON F.SiteId = S.SiteId INNER JOIN
		tblDealers AS D INNER JOIN
		tblBranches AS B ON D.DealerId = B.DealerId ON S.BranchId = B.BranchId
		/*VV E621*/
			LEFT JOIN
		tblContracts C
			ON EP.ContractId=C.ContractId
			LEFT JOIN
		tblCustomers CU
			ON C.CustomerId=CU.CustomerId
			LEFT JOIN
		tblCustomers CUE
			ON EP.Customer_Id=CUE.CustomerId	

		DECLARE @WarrantyParts bit
		DECLARE @count int

		SELECT	@count=COUNT(*)
		FROM    PARTS_POTENTIAL_WARRANTY AS PPW INNER JOIN
				(SELECT	W.PureWONumber AS WorkorderNo, REPLACE(REPLACE(W.WorkOrderNumber, W.PureWONumber, ''), '-', '') AS SegmentNo--,P.Part_Number
				 FROM	TASK AS T INNER JOIN
						tblWorkOrders AS W ON T.Work_Order_ID = W.WorkOrderId 
				 WHERE      (T.Task_ID = @Taskid)) AS A ON PPW.WorkorderNo = A.WorkorderNo 
															AND PPW.SegmentNo = A.SegmentNo  

		SET @WarrantyParts=CASE WHEN ISNULL(@count,0)=0 THEN 0 ELSE 1 END


		SELECT
		T.Task_ID, TT.Code + ' - ' + TT.Description AS [Task Type], 
		CC.Code + ' - ' + CC.Description AS [Component Code], 
		MC.Code + ' - ' + MC.Description AS [Modifier Code], T.Description AS [Backlog Description], 
		TS.Description AS [Task Status], P.Description AS Priority, 
		T.Task_Status_ID, 
		T.Eqp_Plan_ID, 
		T.Task_Type_ID, T.Component_Code_ID, T.Modifier_ID, T.Application_Code_ID, 
		T.Occurrence_Type_Id, 
		T.Priority_ID, T.Source_ID, 
		T.Task_Mode_ID,
		T.PartsStatusRequired,
		T.PartsStatusOrdered,
		T.PartsStatusReady,
		AC.Code + ' - ' + AC.Description AS Application_Code, C.Description AS Cause, 
		EP.EqpPlan, 
		OT.OccurrenceType + ' - ' + OT.OccurrenceTypeDesc AS Occurrence_Type, 
		JC.Code+' - '+JC.Description AS Repair_Code, S.Description AS Source, 
		SY.Description AS Symptom,
		T.Strategy_Usage, T.Strategy_QUOM_ID, 
		CONVERT(varchar,ROUND(T.Strategy_Usage, 0)) + ' ' + CASE WHEN T.Strategy_QUOM_ID IS NULL THEN 'Days' 
		ELSE QUOMS.UOMShortDesc END AS StrategyUsageDisplay, 
		T.Strategy_Proj_Task_Opt_ID, T.Planned_Proj_Task_Opt_ID, 
		T.Strategy_Date,
		T.Strategy_Locked,
		CASE WHEN T.Strategy_QUOM_ID IS NULL THEN 'Days' ELSE QUOMS.UOMShortDesc END AS QUOM_Display, 
		E.ModelId, M.Model, 
		T.Strategy_Repair_Description, 
		T.Strategy_Part_Num,
		T.Cost_Bearer_ID, 
		CB.CostBearer, 
		T.Cause_Id,T.Symptom_Id,
		C.Description AS Cause,SY.Description AS Symptom,
		T.Repair_Code_Id,JC.Code+' - '+JC.Description AS Repair_Code, 
		ISNULL(@Final_Change,0) AS Final_Change,ISNULL(@Risk_Life_Left,0) AS Risk_Life_Left, 
		ISNULL(@Strategy_Frequency,0) AS Strategy_Frequency,@Last_Performed AS  Last_Performed, 
		@Last_Scheduled AS Last_Scheduled, @Last_Performed_Date AS Last_Performed_Date,
		@Last_Scheduled_Date AS Last_Scheduled_Date,@Site_Id AS Site_Id,@Site AS Site,
		T.Cost_Centre_Id, Cost_Centre_Code+' - '+Cost_Centre_Desc AS Cost_Centre,
		@Branch_Id AS Branch_Id,@Branch AS Branch,
		T.Part_Entry_Distribution_Code_Id, 
		EDC.EDC_Id + ' - ' + EDC.Journal_Description + ' : ' + EDC.Debit_Account + '.' + EDC.Debit_Account_Suffix AS Parts_EDC,
		T.Labour_Entry_Distribution_Code_Id, 
		LEDC.EDC_Id + ' - ' + LEDC.Journal_Description + ' : ' + LEDC.Debit_Account + '.' + LEDC.Debit_Account_Suffix AS Labour_EDC,
		T.Misc_Entry_Distribution_Code_Id,
		MEDC.EDC_Id + ' - ' + MEDC.Journal_Description + ' : ' + MEDC.Debit_Account + '.' + MEDC.Debit_Account_Suffix AS Misc_EDC,
		CASE @AuthorisationMode
			WHEN @AuthModeNone THEN 1
			WHEN @AuthModeAdvanced THEN 0
			ELSE CASE WHEN T.Strategy_Proj_Task_Opt_ID>0 THEN 1 ELSE 0 END 
		END AS Task_Authorised,
		ISNULL(@ProjTaskId,0) AS ProjTaskId, 
		CASE WHEN ISNULL(@ProjTaskId,0)>0 THEN @Description ELSE '' END AS StrategyTask,
		@PartsAvailableFromERP AS PartsAvailableFromERP,
		T.Customer_Id,CU.Customer,
		T.Part_Cost_Expense_Id AS Parts_Cost_Expense_Id, CEP.Cost_Expense_Code+' - '+CEP.Cost_Expense_Desc AS Parts_Cost_Expense,
		T.Labour_Cost_Expense_Id, CEL.Cost_Expense_Code+' - '+CEL.Cost_Expense_Desc AS Labour_Cost_Expense,
		T.Misc_Cost_Expense_Id, 
		CEM.Cost_Expense_Code+' - '+CEM.Cost_Expense_Desc AS Misc_Cost_Expense,
		@CompanyCode AS CompanyCode,T.AMTPlanningModeId,T.Specific_Operation_Codes,
		@ChooseWODate AS ChooseWODate,@WOCreationDateFutureONLY AS WOCreationDateFutureONLY,
		T.ChangeoutCategoryId, CHC.Code as ChangeoutCategory, @LifeConfirmed AS LifeConfirmed,
		T.Work_Group_Id,WG1.Description AS WorkGroupDisplay,T.Def_Work_Group_Id,WG2.Description AS Def_Work_Group,
		@IsOverwriteLife As IsOverwriteLife,
		@WarrantyParts AS WarrantyParts,
		@WOCreateFromPO AS WOCreateFromPO,
		@ACWManualWOClosure AS ManualWOClosure,
		@AuthorisationMode AS AuthorisationMode,
		@AuthorisationTolerancePct AS AuthorisationTolerancePct,
		@FeedbackPartsTab AS FeedbackPartsTab,
		@FeedbackLabourTab AS FeedbackLabourTab,
		@FeedbackMiscTab AS FeedbackMiscTab,
		T.Expected_Duration,
		@ManualEntryActualsParts AS ManualEntryActualsParts,
		@ManualEntryActualsLabour AS ManualEntryActualsLabour,
		@ManualEntryActualsMisc AS ManualEntryActualsMisc,
		@OpEditionPartsStockCode AS OpEditionPartsStockCode,
		@OpEditionPartsCB AS OpEditionPartsCB,
		@OpEditionPartsCC AS OpEditionPartsCC,
		@OpEditionPartsEE AS OpEditionPartsEE,
		@OpEditionPartsWG AS OpEditionPartsWG,
		@OpEditionLabourCB AS OpEditionLabourCB,
		@OpEditionLabourCC AS OpEditionLabourCC,
		@OpEditionLabourEE AS OpEditionLabourEE,
		@OpEditionMiscCB AS OpEditionMiscCB,
		@OpEditionMiscCC AS OpEditionMiscCC,
		@OpEditionMiscEE AS OpEditionMiscEE,
		@OpEditionMiscWG AS OpEditionMiscWG, 
		@ShowOPParts_LookupPartsDetails AS ShowOPParts_LookupPartsDetails,
		@ShowOPParts_SearchPurchaseHistory AS ShowOPParts_SearchPurchaseHistory,
		@ShowOPParts_AssignSupplier AS ShowOPParts_AssignSupplier,
		@ShowOPParts_InventorySearch AS ShowOPParts_InventorySearch,
		@ShowOPParts_InventoryValidation AS ShowOPParts_InventoryValidation,
		@ShowOPParts_PartsBookLookup AS ShowOPParts_PartsBookLookup,
		@ShowPOAssignNo AS ShowPOAssignNo,
		@ShowPOActions AS ShowPOActions,
		@OpEditionPlanStatus AS OpEditionPlanStatus,
		PG.Price_Group_ID AS PriceGroupID,PG.Price_Group AS PriceGroup,
		CUR.CurrencyID AS PrimaryCurrencyID,CUR.CurrencyDesc AS PrimaryCurrency,
		@ExternalDocumentSystem AS ExternalDocumentSystem,
		@ExtDocUseClientCredentials AS ExtDocUseClientCredentials,
		T.Health_Safety_ID,HS.Health_Safety,HS.AuditableRecord as HealthSafetyAuditable, GETDATE() AS LastNotified,
		@AutoLookupPartsReadyStatus AS AutoLookupPartsReadyStatus,
		AuthorisationRequestByID,NULL AS AuthorisationRequestBy,AuthorisationRequestDate,
		CONVERT(BIT,0) AS ResourceStatusReady,
		@CreatePOModeAllowCreateERPWO AS CreatePOModeAllowCreateERPWO,
		/*VV E621*/
		CASE WHEN @ChangeoutProjTaskId<>0 THEN 1 ELSE 0 END AS RebuildWO,
		
		T.RebuildPartTypeId,
		/*E797*/ pc.PartClassification AS RebuildPartClassification, 
		T.RebuildPartId,RPT.Part+' - '+RPT.PartDescription AS RebuildPart, 
		E.SerialNumber,
		@EqpSite AS EqpSite,@EqpCustomer AS EqpCustomer,@ChangeoutStrategyDate AS ChangeoutStrategyDate, 
		@ChangeoutPlannedDate AS ChangeoutPlannedDate,@ChangeoutActualDate AS ChangeoutActualDate,
		@ChangeoutLifeAchived AS ChangeoutLifeAchived,@ChangeoutSerialNoOut AS ChangeoutSerialNoOut,
		@ChangeoutWorkorderId AS ParentTaskId
		FROM         
		@z_TASK T
			INNER JOIN
		tblEqpPlans EP
			ON T.Eqp_Plan_Id=EP.EqpPlanId
			INNER JOIN
		tblEquipment E
			ON EP.EquipmentId=E.EquipmentId
			INNER JOIN
		tblModels M
			ON E.ModelId=M.ModelId
			INNER JOIN
		tblTaskTypes TT
			ON T.Task_Type_Id=TT.TaskTypeId
			INNER JOIN
		tblComponentCodes CC
			ON T.Component_Code_Id=CC.ComponentCodeId
			INNER JOIN
		tblModifierCodes MC
			ON T.Modifier_ID=MC.ModifierId
			INNER JOIN
		tblApplicationCodes AC
			ON T.Application_Code_ID=AC.ApplicationCodeId
			INNER JOIN
		tblOccurrenceTypes OT
			ON T.Occurrence_Type_Id=OT.OccurrenceTypeId
			INNER JOIN
		PRIORITY P
			ON T.Priority_ID=P.Priority_ID	
			INNER JOIN
		TASK_STATUS TS
			ON T.Task_Status_ID=TS.Task_Status_ID
			INNER JOIN
		SYMPTOM SY
			ON T.Symptom_ID=SY.Symptom_ID
			INNER JOIN
		CAUSE C
			ON T.Cause_ID=C.Cause_ID
			INNER JOIN
		tblJobCodes JC
			ON T.Repair_Code_Id=JC.JobCodeId	
			LEFT OUTER JOIN
		SOURCE S
			ON T.Source_ID=S.Source_ID
			LEFT OUTER JOIN
		COST_CENTRE COC
			ON T.Cost_Centre_Id=COC.Cost_Centre_Id
			LEFT OUTER JOIN
		tblCostBearers CB
			ON T.Cost_Bearer_Id=CB.CostBearerId
			LEFT OUTER JOIN
		ENTRY_DISTRIBUTION_CODE EDC
			ON T.Part_Entry_Distribution_Code_Id=EDC.Id
			LEFT OUTER JOIN
		ENTRY_DISTRIBUTION_CODE LEDC
			ON T.Labour_Entry_Distribution_Code_Id=LEDC.Id
			LEFT OUTER JOIN
		ENTRY_DISTRIBUTION_CODE MEDC
			ON T.Misc_Entry_Distribution_Code_Id=MEDC.Id
			LEFT OUTER JOIN
		COST_EXPENSE CEP
			ON T.Part_Cost_Expense_Id=CEP.Cost_Expense_Id
			LEFT OUTER JOIN
		COST_EXPENSE CEL
			ON T.Labour_Cost_Expense_Id=CEL.Cost_Expense_Id
			LEFT OUTER JOIN
		COST_EXPENSE CEM
			ON T.Misc_Cost_Expense_Id=CEM.Cost_Expense_Id
			LEFT OUTER JOIN
		tblCustomers CU
			ON T.Customer_Id=CU.CustomerId
			LEFT OUTER JOIN
		WORK_GROUP WG1
			ON T.Work_Group_id=WG1.Work_Group_Id
			LEFT OUTER JOIN
		WORK_GROUP WG2
			ON T.Def_Work_Group_id=WG2.Work_Group_Id
			LEFT OUTER JOIN
		tblQUOMs QUOMS
			ON  T.Strategy_QUOM_ID=QUOMS.QUOMId
			LEFT OUTER JOIN
		CHANGEOUT_CATEGORY CHC
			ON T.ChangeoutCategoryId = CHC.ChangeoutCategoryId
			LEFT OUTER JOIN
		HEALTH_SAFETY HS
			ON T.Health_Safety_Id = HS.Health_Safety_Id
			INNER JOIN
		tblFleets F 
			ON EP.FleetID=F.FleetID
			INNER JOIN
		PRICE_GROUP PG
			ON F.Price_Group_ID=PG.Price_Group_ID
			CROSS JOIN
			(SELECT TOP 1 CurrencyID,CurrencyDesc FROM tblCurrencies WHERE PrimaryCurr<>0) AS CUR
		/*VV E621*/
			LEFT JOIN
		tblParts RPT
			ON T.RebuildPartId=RPT.PartId
		/*E797*/ 
			LEFT JOIN 
		PART_CLASSIFICATION pc
			ON T.RebuildPartTypeId = pc.PartClassificationId
			

	--Library

	SELECT
	WSD.Work_Scope_Document_Id,dbo.DOCUMENT_SOURCE_F(1) AS Source,
	WSD.Document_Name, WSD.Document_File_Name,1 AS SourceId
	FROM
	@z_TASK_DOCUMENT TD
		INNER JOIN
	WORK_SCOPE_DOCUMENT WSD
		ON TD.Work_Scope_Document_Id=WSD.Work_Scope_Document_Id

	/*VV CR8035*/
	UNION ALL
	
	SELECT 0 AS Work_Scope_Document_Id,dbo.DOCUMENT_SOURCE_F(0) AS Source,
		PTED.DocumentName AS Document_Name, PTED.DocumentLink AS Document_File_Name,0 AS SourceId
	FROM 
	PROJ_TASK_EXTERNAL_DOCUMENT PTED
		INNER JOIN
	tblProjTaskOpts PTO
		ON PTO.ProjTaskOptId=@Proj_Task_Opt_Id AND PTED.ProjTaskId=PTO.ProjTaskId


	--VV 2-Apr-2009 added attached documents
	SELECT [FileName] FROM 
	ATTACHED_DOCUMENT_TASK ADT
		INNER JOIN
	@z_TASK T
		ON ADT.TaskId=T.Task_Id
		

	END --IF @TaskDefaults=1


	--Task Operations

	SELECT
	ABS(TOPR.Task_Operation_Id) AS SortOrder,TOPR.Task_Operation,CC.Code + ' - ' + CC.Description AS Component_Code,
	MC.Code + ' - ' + MC.Description AS Modifier_Code,JC.Code+' - '+JC.Description AS Job_Code ,
	WG.Description AS Work_Group,HS.Health_Safety,TOPR.Operation_Instructions,
	CAST(0 AS float) AS OperationOffset,CAST(NULL AS datetime) AS StartTime,
	CAST(NULL AS datetime) AS EndTime,
	TOPR.Planned_Duration,ISNULL(A.LabourDuration,0) AS LabourDuration,
	TOPR.Actual_Duration,
	CAST((CASE WHEN EXISTS(SELECT P.Task_Operation_Id FROM @z_TASK_OPERATION_PART P
	WHERE P.Task_Operation_Id=TOPR.Task_Operation_Id AND P.Strategy_Qty>0) THEN 1 
	ELSE 0 END) AS bit) AS P,
	CAST((CASE WHEN A.LabourDuration IS NOT NULL THEN 1 ELSE 0 END) AS bit) AS L,
	CAST((CASE WHEN EXISTS(SELECT M.Task_Operation_Id FROM @z_TASK_OPERATION_MISC M
	WHERE M.Task_Operation_Id=TOPR.Task_Operation_Id) THEN 1 ELSE 0 END) AS bit) AS M,
	CAST(0 AS float) AS TotalLH,CB.CostBearer,
	COC.Cost_Centre_Code+' - '+COC.Cost_Centre_Desc AS Cost_Centre,
	CEP.Cost_Expense_Code+' - '+CEP.Cost_Expense_Desc AS Parts_Cost_Expense,
	CEL.Cost_Expense_Code+' - '+CEL.Cost_Expense_Desc AS Labour_Cost_Expense,
	CEM.Cost_Expense_Code+' - '+CEM.Cost_Expense_Desc AS Misc_Cost_Expense, 
	EDCP.EDC_Id + ' - ' + EDCP.Journal_Description + ' : ' + EDCP.Debit_Account + '.' + EDCP.Debit_Account_Suffix AS Parts_EDC,
	EDCL.EDC_Id + ' - ' + EDCL.Journal_Description + ' : ' + EDCL.Debit_Account + '.' + EDCL.Debit_Account_Suffix AS Labour_EDC,
	EDCM.EDC_Id + ' - ' + EDCM.Journal_Description + ' : ' + EDCM.Debit_Account + '.' + EDCM.Debit_Account_Suffix AS Misc_EDC, 
	CAST(0 AS float) AS TotalP,CAST(0 AS float) AS TotalL,
	CAST(0 AS float) AS TotalM,CAST(0 AS float) AS TotalPLM,
	TOPR.Task_Operation_Id, 
	TOPR.Cost_Bearer_Id, 
	TOPR.Cost_Centre_Id, 
	TOPR.Parts_Cost_Expense_Id, TOPR.Labour_Cost_Expense_Id, TOPR.Misc_Cost_Expense_Id,
	TOPR.Parts_Entry_Distribution_Code_Id, 
	TOPR.Labour_Entry_Distribution_Code_Id,
	TOPR.Misc_Entry_Distribution_Code_Id,
	TOPR.Task_Id,TOPR.Component_Code_Id, 
	TOPR.Modifier_Code_Id,  
	TOPR.Job_Code_Id, TOPR.Work_Group_Id, TOPR.Health_Safety_Id, TOPR.Proj_Task_Amt_Id,
	TOPR.Std_Job_Op_Id,CONVERT(varchar(25), TOPR.Last_Mod_Date, 21) AS Last_Mod_Date
	FROM  
	@z_TASK_OPERATION TOPR
		INNER JOIN
	tblComponentCodes CC
		ON TOPR.Component_Code_Id=CC.ComponentCodeId
		INNER JOIN
	tblModifierCodes MC
		ON TOPR.Modifier_Code_Id=MC.ModifierId
		/*VV 12-Dec-2008*/
		LEFT JOIN
	tblJobCodes JC
		ON TOPR.Job_Code_Id=JC.JobCodeId	
		LEFT OUTER JOIN
	WORK_GROUP WG
		ON TOPR.Work_Group_Id=WG.Work_Group_Id
		LEFT OUTER JOIN
	HEALTH_SAFETY HS
		ON TOPR.Health_Safety_Id=HS.Health_Safety_Id
		LEFT OUTER JOIN
	tblCostBearers CB
		ON TOPR.Cost_Bearer_Id=CB.CostBearerId
		LEFT OUTER JOIN
	COST_CENTRE COC
		ON TOPR.Cost_Centre_Id=COC.Cost_Centre_Id
		LEFT OUTER JOIN
	COST_EXPENSE CEP
		ON TOPR.Parts_Cost_Expense_Id=CEP.Cost_Expense_Id
		LEFT OUTER JOIN
	COST_EXPENSE CEL
		ON TOPR.Labour_Cost_Expense_Id=CEL.Cost_Expense_Id
		LEFT OUTER JOIN
	COST_EXPENSE CEM
		ON TOPR.Misc_Cost_Expense_Id=CEM.Cost_Expense_Id
		LEFT OUTER JOIN
	ENTRY_DISTRIBUTION_CODE EDCP
		ON TOPR.Parts_Entry_Distribution_Code_Id=EDCP.Id
		LEFT OUTER JOIN
	ENTRY_DISTRIBUTION_CODE EDCL
		ON TOPR.Labour_Entry_Distribution_Code_Id=EDCL.Id
		LEFT OUTER JOIN
	ENTRY_DISTRIBUTION_CODE EDCM
		ON TOPR.Misc_Entry_Distribution_Code_Id=EDCM.Id	
		LEFT OUTER JOIN
	(SELECT TOLA.Task_Operation_Id,SUM(Planned_Labour_Hrs) AS LabourDuration
	FROM 
	TASK_OPERATION_LABOUR TOLA
		INNER JOIN 
	@z_TASK_OPERATION TOPE
		ON TOLA.Task_Operation_Id=TOPE.Task_Operation_Id
	GROUP BY TOLA.Task_Operation_Id) A
		ON TOPR.Task_Operation_Id=A.Task_Operation_Id


	--Task Operation Part
	SELECT     
	P.Part AS Part_Number,
	NULLIF(ISNULL(P.PartDescription,@DefDescription),'') AS Part_Description,
	SOS.Sos_Code+' - '+SOS.Sos_description AS Source_Of_Supply,
	'' AS StockCode,	--AL: 10/03/09
	TOPA.Strategy_Qty, TOPA.Pct_Strategy_Probability, TOPA.Strategy_Unit_Price,
	CAST(TOPA.Include_In_Total AS float)*TOPA.Strategy_Qty*TOPA.Pct_Strategy_Probability*
	TOPA.Strategy_Unit_Price/100.00 AS StrategyTotal,
	CAST('' AS varchar(50)) AS POCounter,	--AL: 10/03/09
	CAST('' AS varchar(20)) AS Purchase_Order_Number,
	NULLIF(S.Supplier_Name,'') AS Supplier,
	CAST(CASE WHEN TOPA.Pct_Strategy_Probability<100.00 THEN 0.00 
	ELSE TOPA.Strategy_Qty END AS float)*
	CAST(TOPA.Include_In_Total AS float) AS Planned_Qty,
	TOPA.Strategy_Unit_Price AS Planned_Unit_Price,
	CAST(NULL AS INT) AS FinPeriod,
	CASE WHEN TOPA.Pct_Strategy_Probability<100.00 THEN 0 ELSE TOPA.Strategy_Qty END *
	CAST(TOPA.Include_In_Total AS float)*
	TOPA.Strategy_Unit_Price AS PlannedTotal,
	CAST('' AS varchar(25)) AS PlanStatus,
	--AL: 03/04/09
	CAST(1 AS int) AS PartAvailabilityStatusId,PAS.PartAvailabilityStatus,
	CAST(NULL AS datetime) AS ExpectedAvailabilityDate,
	CAST(0 AS bit) AS Reserved,
	
	CAST('' AS varchar(500)) AS Notes, CAST(0 AS float) AS Actual_Qty, 
	CAST(0 AS float) AS Actual_Unit_Price,
	CAST(0 AS float) AS ActualTotal,
	/* VV CR8294
	CAST('' AS varchar(100)) AS OPCostBearer,		--AL: 10/03/09
	CAST('' AS varchar(100)) AS OPCostCentre,		--AL: 10/03/09
	CAST('' AS varchar(100)) AS OPExpenseElement,	--AL: 10/03/09
	CAST('' AS varchar(100)) AS OPWorkGroup,		--AL: 10/03/09
	*/
	CB.CostBearer AS OPCostBearer,	
	CC.Cost_Centre_Code + ' - ' + CC.Cost_Centre_Desc AS OPCostCentre,		
	EE.Cost_Expense_Code + ' - ' + EE.Cost_Expense_Desc AS OPExpenseElement,		
	WG.Description AS OPWorkGroup,

	TOPA.Task_Operation_Part_Id, TOPA.Task_Operation_Id,
	TOPA.Supplier_Id, TOPA.Include_In_Total,
	CONVERT(varchar(25), GETDATE(), 21) AS Last_Mod_Date,


	@IsEditable AS IsEditable,
	CAST(NULL AS datetime) AS Delivery_Date,
	TOPR.Proj_Task_Amt_Id,TOPR.Std_Job_Op_Id,
	TOPA.SourceOfSupplyId,
	
	/* VV CR8294
	--AL: 10/03/09
	CAST(NULL AS INT) AS OPCostBearerID,CAST(NULL AS INT) AS OPCostCentreID,
	CAST(NULL AS INT) AS OPExpenseElementID,CAST(NULL AS INT) AS OPWorkGroupID,
	*/

	TOPA.CostBearerID AS OPCostBearerID,TOPA.CostCentreID AS OPCostCentreID,
	TOPA.ExpenseElementID AS OPExpenseElementID,TOPA.WorkGroupID AS OPWorkGroupID,

	'' AS PartsOrderDetails,

	--AL: 16/03/09
	CAST(0 AS bit) AS InvNotFound,SOS.Sos_description AS SOSDescription,

	CAST(0 as int) AS PlanStatusId

	FROM   
	@z_TASK_OPERATION TOPR
		INNER JOIN      
	@z_TASK_OPERATION_PART TOPA	
		ON TOPR.Task_Operation_Id=TOPA.Task_Operation_Id
		LEFT OUTER JOIN
	tblParts P
		ON TOPA.Part_Id=P.PartId
		LEFT OUTER JOIN
	SUPPLIER S
		ON TOPA.Supplier_Id=S.Supplier_Id
		LEFT OUTER JOIN
	SOURCE_OF_SUPPLY SOS
		ON TOPA.SourceOfSupplyId=SOS.Source_Of_Supply_Id
	--AL: 03/04/09
		LEFT OUTER JOIN
	PART_AVAILABILITY_STATUS PAS
		ON TOPA.PartAvailabilityStatusId=PAS.PartAvailabilityStatusId
		/*VV CR8294*/
		LEFT OUTER JOIN
	tblCostBearers CB 
		ON TOPA.CostBearerID=CB.CostBearerID
		LEFT OUTER JOIN
	COST_CENTRE CC
		ON TOPA.CostCentreID=CC.Cost_Centre_ID
		LEFT OUTER JOIN
	COST_EXPENSE EE
		ON TOPA.ExpenseElementID=EE.Cost_Expense_ID
		LEFT OUTER JOIN
	WORK_GROUP WG
		ON TOPA.WorkGroupID=WG.Work_Group_ID

	--Task operation Labour

	SELECT  
	WG.Description AS Work_Group,
	LA.ActivityCode+' - '+LA.LabourActivity AS LabourActivityDesc,
	TOL.Labour_Activity,TOL.Strategy_Labour_Hrs,TOL.Strategy_Labour_Rate,
	TOL.Strategy_Labour_Hrs*TOL.Strategy_Labour_Rate*
	CAST(TOL.Include_In_Total AS float) AS StrategyTotal,
	CAST(1 AS float) AS Planned_Qty,
	CAST('' AS varchar(100)) AS Employee,
	TOL.Strategy_Labour_Hrs AS Planned_Labour_Hrs,
	CAST(0 AS float) AS Labour_Offset, 
	CAST(NULL AS datetime) AS StartTime,
	CAST(NULL AS datetime) AS EndTime,
	CAST('' AS varchar(500)) AS Instructions,
	TOL.Strategy_Labour_Rate AS Planned_Labour_Rate,
	CAST(NULL AS INT) AS FinPeriod,
	TOL.Strategy_Labour_Hrs*TOL.Strategy_Labour_Rate*
	CAST(TOL.Include_In_Total AS float) AS PlannedTotal,
	CAST(0 AS float) AS Actual_Labour_Hrs,CAST(0 AS float) AS Actual_Labour_Rate,
	CAST(0 AS float) AS ActualTotal,
	/* VV CR8294
	CAST('' AS varchar(100)) AS OPCostBearer,		--AL: 10/03/09
	CAST('' AS varchar(100)) AS OPCostCentre,		--AL: 10/03/09
	CAST('' AS varchar(100)) AS OPExpenseElement,	--AL: 10/03/09
	--CAST('' AS varchar(100)) AS OPWorkGroup,		--AL: 10/03/09
	*/
	CB.CostBearer AS OPCostBearer,	
	CC.Cost_Centre_Code + ' - ' + CC.Cost_Centre_Desc AS OPCostCentre,		
	EE.Cost_Expense_Code + ' - ' + EE.Cost_Expense_Desc AS OPExpenseElement,
	TOL.Task_Operation_Labour_Id, TOL.Task_Operation_Id, 
	TOL.Work_Group_Id, 
	TOL.Labour_Activity_Id, 
	TOL.Include_In_Total,    
	CAST(0 AS int) AS Employee_Id,   
	CONVERT(varchar(25), GETDATE(), 21) AS Last_Mod_Date,
	@IsEditable AS IsEditable,TOPR.Proj_Task_Amt_Id,TOPR.Std_Job_Op_Id,
	CAST(0 AS bit) AS S_Conf,
	/* VV CR8294
	--AL: 10/03/09
	CAST(NULL AS INT) AS OPCostBearerID,CAST(NULL AS INT) AS OPCostCentreID,
	CAST(NULL AS INT) AS OPExpenseElementID--,CAST(NULL AS INT) AS OPWorkGroupID	
	*/
	TOL.CostBearerID AS OPCostBearerID,TOL.CostCentreID AS OPCostCentreID,
	TOL.ExpenseElementID AS OPExpenseElementID
	FROM 
	@z_TASK_OPERATION TOPR
		INNER JOIN  
	@z_TASK_OPERATION_LABOUR TOL
		ON TOPR.Task_Operation_Id=TOL.Task_Operation_Id
		LEFT OUTER JOIN
	WORK_GROUP WG
		ON TOL.Work_Group_Id=WG.Work_Group_Id
		LEFT OUTER JOIN
	tblLabourActivities LA
		ON TOL.Labour_Activity_Id=LA.LabourActivityId
		/*VV CR8294*/
		LEFT OUTER JOIN
	tblCostBearers CB 
		ON TOL.CostBearerID=CB.CostBearerID
		LEFT OUTER JOIN
	COST_CENTRE CC
		ON TOL.CostCentreID=CC.Cost_Centre_ID
		LEFT OUTER JOIN
	COST_EXPENSE EE
		ON TOL.ExpenseElementID=EE.Cost_Expense_ID

	-- Task Operation Misc
	SELECT  
	TOPM.Task_Operation_Misc_Desc,MC.Misc_Category,
	TOPM.Strategy_Sell*CAST(TOPM.Include_In_Total AS float) AS StrategyTotal,
	CAST('' AS varchar(50)) AS POCounter,	--AL: 10/03/09
	CAST('' AS varchar(20)) AS Purchase_Order_Number,S.Supplier_Name AS Supplier,
	TOPM.Strategy_Sell*CAST(TOPM.Include_In_Total AS float) AS PlannedTotal,
	CAST(NULL AS INT) AS FinPeriod,
	CAST('' AS varchar(1000)) AS Notes,
	CAST(0 AS float) AS ActualTotal,

	/* VV CR8294
	CAST('' AS varchar(100)) AS OPCostBearer,		--AL: 10/03/09
	CAST('' AS varchar(100)) AS OPCostCentre,		--AL: 10/03/09
	CAST('' AS varchar(100)) AS OPExpenseElement,	--AL: 10/03/09
	CAST('' AS varchar(100)) AS OPWorkGroup,		--AL: 10/03/09
	*/
	CB.CostBearer AS OPCostBearer,	
	CC.Cost_Centre_Code + ' - ' + CC.Cost_Centre_Desc AS OPCostCentre,		
	EE.Cost_Expense_Code + ' - ' + EE.Cost_Expense_Desc AS OPExpenseElement,		
	WG.Description AS OPWorkGroup,
	TOPM.Task_Operation_Misc_Id, TOPM.Task_Operation_Id,
	TOPM.Misc_Category_Id, TOPM.Include_In_Total, TOPM.Supplier_Id, 
	CONVERT(varchar(25), GETDATE(), 21) AS Last_Mod_Date,
	@IsEditable AS IsEditable,TOPR.Proj_Task_Amt_Id,TOPR.Std_Job_Op_Id,

	/* VV CR8294
	--AL: 10/03/09
	CAST(NULL AS INT) AS OPCostBearerID,CAST(NULL AS INT) AS OPCostCentreID,
	CAST(NULL AS INT) AS OPExpenseElementID,CAST(NULL AS INT) AS OPWorkGroupID	
	*/
	TOPM.CostBearerID AS OPCostBearerID,TOPM.CostCentreID AS OPCostCentreID,
	TOPM.ExpenseElementID AS OPExpenseElementID,TOPM.WorkGroupID AS OPWorkGroupID
	FROM   
	@z_TASK_OPERATION TOPR
		INNER JOIN        
	@z_TASK_OPERATION_MISC TOPM
		ON TOPR.Task_Operation_Id=TOPM.Task_Operation_Id
		LEFT OUTER JOIN
	MISC_CATEGORY MC
		ON TOPM.Misc_Category_Id=MC.Misc_Category_Id
		LEFT OUTER JOIN
	SUPPLIER S
		ON TOPM.Supplier_Id=S.Supplier_Id
		/*VV CR8294*/
		LEFT OUTER JOIN
	tblCostBearers CB 
		ON TOPM.CostBearerID=CB.CostBearerID
		LEFT OUTER JOIN
	COST_CENTRE CC
		ON TOPM.CostCentreID=CC.Cost_Centre_ID
		LEFT OUTER JOIN
	COST_EXPENSE EE
		ON TOPM.ExpenseElementID=EE.Cost_Expense_ID
		LEFT OUTER JOIN
	WORK_GROUP WG
		ON TOPM.WorkGroupID=WG.Work_Group_ID
		
END 

GO




/****** Object:  StoredProcedure [dbo].[OVERHEAD_ACTUAL_BILLING_IMPORT_P]    Script Date: 04/18/2012 11:12:39 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[OVERHEAD_ACTUAL_BILLING_IMPORT_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[OVERHEAD_ACTUAL_BILLING_IMPORT_P]
GO

/****** Object:  StoredProcedure [dbo].[OVERHEAD_ACTUAL_BILLING_IMPORT_P]    Script Date: 04/18/2012 11:12:39 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE OVERHEAD_ACTUAL_BILLING_IMPORT_P
/******************************************************************************  
   
 Name: OVERHEAD_ACTUAL_BILLING_IMPORT_P  
  
 Called By:   
  
 Desc:   
  
 Auth:  Sergey Ivanov  
 Date:  5 August 2005  
*******************************************************************************  
  Change History  
*******************************************************************************  
Date:       Author:  Description:  
--------   -------- ----------------------------------------  
17 Apr 12  GD       E784

--OLD COMMENTS

21-Jul-07 KN   Fixed - Collation and tempDB Conflicts  
20-May-2009 KN  Fixed declaring explicit Constraint Names  
*******************************************************************************/  
 /* Param List */  
@doc text,  
@nRecInserted int = 0 OUTPUT,  
@nRecUpdated int = 0 OUTPUT,  
@nRecRejected int = 0 OUTPUT,
@InterfaceSource INT = 0,
@ImportBatchName varchar(1000) = '' 
  
AS  


DECLARE @TypeVarchar int
DECLARE @ErrParsing int
DECLARE @TypeInt int
DECLARE @TypeFloat int
DECLARE @ErrBusinessRules int

SET @ErrBusinessRules = 3
SET @ErrParsing = 1 
SET @TypeVarchar = 1
SET @TypeInt = 2
SET @TypeFloat = 3
CREATE TABLE #I_OVERHEAD_ACTUAL_BILLING  
(
 Line_Num int IDENTITY(1,1) ,  
 Overhead_ERP_Id varchar (1000) COLLATE database_default ,  
 Invoice_Number varchar (1000) COLLATE database_default ,  
 Calendar_Period varchar (1000) COLLATE database_default  ,  
 Overhead_Billing varchar (1000) COLLATE database_default ,  
 Currency varchar (1000) COLLATE database_default ,  
 Exchange_Rate varchar (1000) COLLATE database_default,  
 System_Source varchar (1000) COLLATE database_default,
 PRIMARY KEY(Line_Num)   
 --PRIMARY KEY (Overhead_ERP_Id, Invoice_Number /*, Calendar_Period*/)  
)  
DECLARE @idoc int  
  
EXEC sp_xml_preparedocument @idoc OUTPUT, @doc  
  
 INSERT #I_OVERHEAD_ACTUAL_BILLING  
 SELECT  
 NULLIF(LTRIM(RTRIM(Overhead_ERP_Id)),'') AS Overhead_ERP_Id,  
 NULLIF(LTRIM(RTRIM(Invoice_Number)),'') AS Invoice_Number ,  
 NULLIF(LTRIM(RTRIM(Calendar_Period)),'') AS Calendar_Period ,  
 NULLIF(LTRIM(RTRIM(Overhead_Billing)),'') AS Overhead_Billing ,  
 NULLIF(LTRIM(RTRIM(Currency)),'') AS Currency ,  
 NULLIF(LTRIM(RTRIM(Exchange_Rate)),'') AS Exchange_Rate ,  
 NULLIF(LTRIM(RTRIM(System_Source)),'') AS System_Source   
 FROM OPENXML (@idoc, '/I_OVERHEAD_ACTUAL_BILLINGs/I_OVERHEAD_ACTUAL_BILLING',2) WITH #I_OVERHEAD_ACTUAL_BILLING ioab  


--Create table for error messages records	
CREATE TABLE #z_Message(MessageId int IDENTITY(1,1),Line_No int,
ErrorDescription varchar(5000) COLLATE DATABASE_DEFAULT,
EqpPlanId int,ProjectId int,ErrorType int,ImportRecord VARCHAR(MAX)
PRIMARY KEY(MessageId))



--Check data type
INSERT INTO #z_Message(Line_No,ErrorDescription,ErrorType,ImportRecord)
SELECT Line_Num, CASE  WHEN Overhead_ERP_Id IS NULL THEN 'Missing Required Filed:Overhead_ERP_Id' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Overhead_ERP_Id',50,Overhead_ERP_Id,0) END +
	CASE  WHEN Invoice_Number IS NULL THEN 'Missing Required Filed:Invoice_Number' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Invoice_Number', 50,Invoice_Number,0) END +
	CASE  WHEN Calendar_Period IS NULL THEN 'Missing Required Filed:Calendar_Period' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeInt,'Calendar_Period', 0,Calendar_Period,0) END+
	CASE  WHEN Overhead_Billing IS NULL THEN 'Missing Required Filed:Overhead_Billing' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Overhead_Billing', 0,Overhead_Billing,0) END+
	CASE  WHEN Currency IS NULL THEN 'Missing Required Filed:Currency' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Currency', 3,Currency,0) END+
	CASE  WHEN Exchange_Rate IS NULL THEN 'Missing Required Filed:Exchange_Rate' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Exchange_Rate', 0,Exchange_Rate,0) END+
	CASE  WHEN System_Source IS NULL THEN 'Missing Required Filed:System_Source' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'System_Source', 10,System_Source,0)END
    AS ErrorDescription,@ErrParsing AS ErrorType,
    CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Overhead_ERP_Id,Invoice_Number,Calendar_Period,Overhead_Billing,Currency ,Exchange_Rate,System_Source FROM  #I_OVERHEAD_ACTUAL_BILLING TEMPOVERBILL WHERE TEMPOVERBILL.Line_Num = #I_OVERHEAD_ACTUAL_BILLING.Line_Num FOR XML PATH('I_OVERHEAD_ACTUAL_BILLING'),ROOT('I_OVERHEAD_ACTUAL_BILLINGs')) END
  AS ImportRecord
FROM
#I_OVERHEAD_ACTUAL_BILLING

--Delete lines without any error message	
DELETE #z_Message WHERE ErrorDescription=''	
----Delete records having some data type errors
IF EXISTS(SELECT Line_No FROM #z_Message)
BEGIN
SET @nRecInserted = 0 
SET @nRecUpdated  = 0   
SET @nRecRejected = (SELECT COUNT(*) FROM #I_OVERHEAD_ACTUAL_BILLING)
GOTO FINISH
END

IF EXISTS(SELECT * FROM #I_OVERHEAD_ACTUAL_BILLING GROUP BY Overhead_ERP_Id,Invoice_Number HAVING COUNT(*)>1)
BEGIN 

INSERT INTO #z_Message(Line_No,ErrorDescription,ErrorType,ImportRecord)
SELECT NULL , 'Duplicate records having same Overhead_ERP_Id and Invoice_Number ',@ErrBusinessRules AS ErrorType
,CASE WHEN @InterfaceSource = 1 THEN 
		(
		SELECT TEMPOVERBILL.Overhead_ERP_Id,TEMPOVERBILL.Invoice_Number,Calendar_Period,Overhead_Billing,Currency ,Exchange_Rate,System_Source FROM  #I_OVERHEAD_ACTUAL_BILLING TEMPOVERBILL 
		INNER JOIN (SELECT Overhead_ERP_Id,Invoice_Number FROM #I_OVERHEAD_ACTUAL_BILLING
													GROUP BY Overhead_ERP_Id,Invoice_Number
													HAVING COUNT(*)>1) TEMP
													ON TEMPOVERBILL.Overhead_ERP_Id=TEMP.Overhead_ERP_Id  FOR XML PATH('I_OVERHEAD_ACTUAL_BILLING'),ROOT('I_OVERHEAD_ACTUAL_BILLINGs')) END  AS ImportRecord 
SET @nRecInserted = 0 
SET @nRecUpdated  = 0   
SET @nRecRejected = (SELECT COUNT(*) FROM #I_OVERHEAD_ACTUAL_BILLING)
GOTO FINISH
												
END

IF EXISTS(SELECT * FROM #I_OVERHEAD_ACTUAL_BILLING ioab LEFT JOIN tblCurrencies cur ON cur.Currency=ioab.Currency WHERE  cur.CurrencyID IS NULL)
BEGIN 
		INSERT INTO #z_Message(Line_No,ErrorDescription,ErrorType,ImportRecord)
		SELECT Line_Num , 'Currency does not exist ',@ErrBusinessRules AS ErrorType,
		CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT TEMPOVERBILL.Overhead_ERP_Id,TEMPOVERBILL.Invoice_Number,TEMPOVERBILL.Calendar_Period,TEMPOVERBILL.Overhead_Billing,TEMPOVERBILL.Currency ,TEMPOVERBILL.Exchange_Rate,TEMPOVERBILL.System_Source FROM  #I_OVERHEAD_ACTUAL_BILLING TEMPOVERBILL WHERE  TEMPOVERBILL.Line_Num = ioab.Line_Num FOR XML PATH('I_OVERHEAD_ACTUAL_BILLING'),ROOT('I_OVERHEAD_ACTUAL_BILLINGs')) END
		AS ImportRecord 
	FROM #I_OVERHEAD_ACTUAL_BILLING ioab
	LEFT JOIN tblCurrencies cur ON cur.Currency=ioab.Currency WHERE  cur.CurrencyID IS NULL
	
SET @nRecInserted = 0 
SET @nRecUpdated  = 0   
SET @nRecRejected = (SELECT COUNT(*) FROM #I_OVERHEAD_ACTUAL_BILLING)
GOTO FINISH
												
END


IF EXISTS(SELECT * FROM #I_OVERHEAD_ACTUAL_BILLING ioab LEFT JOIN tblFinancialPeriods per ON per.CalenderPeriod=ioab.Calendar_Period WHERE  per.FinancialPeriodID IS NULL)
BEGIN 
	INSERT INTO #z_Message(Line_No,ErrorDescription,ErrorType,ImportRecord)
		SELECT Line_Num , 'Calender period does not exist',@ErrBusinessRules AS ErrorType,
		CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT TEMPOVERBILL.Overhead_ERP_Id,TEMPOVERBILL.Invoice_Number,TEMPOVERBILL.Calendar_Period,TEMPOVERBILL.Overhead_Billing,TEMPOVERBILL.Currency ,TEMPOVERBILL.Exchange_Rate,TEMPOVERBILL.System_Source FROM  #I_OVERHEAD_ACTUAL_BILLING TEMPOVERBILL WHERE  TEMPOVERBILL.Line_Num = ioab.Line_Num FOR XML PATH('I_OVERHEAD_ACTUAL_BILLING'),ROOT('I_OVERHEAD_ACTUAL_BILLINGs')) END
		AS ImportRecord 
	FROM #I_OVERHEAD_ACTUAL_BILLING ioab
	LEFT JOIN tblFinancialPeriods per ON per.CalenderPeriod=ioab.Calendar_Period
SET @nRecInserted = 0 
SET @nRecUpdated  = 0   
SET @nRecRejected = (SELECT COUNT(*) FROM #I_OVERHEAD_ACTUAL_BILLING)
GOTO FINISH
												
END



 DELETE ioab 
 FROM #I_OVERHEAD_ACTUAL_BILLING ioab  
  LEFT JOIN tblCurrencies cur ON cur.Currency=ioab.Currency  
  LEFT JOIN tblFinancialPeriods per ON per.CalenderPeriod=ioab.Calendar_Period  
 WHERE  cur.CurrencyID IS NULL  
  OR per.FinancialPeriodID IS NULL  
  
SET @nRecRejected=@@ROWCOUNT 


----Delete records having some data type errors
IF EXISTS(SELECT Line_No FROM #z_Message)
BEGIN
	DELETE #I_OVERHEAD_ACTUAL_BILLING WHERE Line_Num IN(SELECT Line_No FROM #z_Message)
END

IF NOT EXISTS(SELECT Line_Num FROM #I_OVERHEAD_ACTUAL_BILLING) GOTO FINISH
 
  
-- Add System_Source if it's a new one  
   INSERT SYSTEM_SOURCE  
 (System_Source_Code, Last_Mod_By_User_ID, Last_Mod_Date,   
 Create_By_User_ID, Create_Date)  
 SELECT DISTINCT ioab.System_Source, 0, GETDATE(), 0, GETDATE()  
 FROM #I_OVERHEAD_ACTUAL_BILLING ioab  
 WHERE ioab.System_Source NOT IN (SELECT System_Source_Code FROM SYSTEM_SOURCE)  
  
  
--=============================================================  
--================  Updating physical table  ==================  
--=============================================================  
  
 UPDATE oab  
 SET   
  oab.Overhead_ERP_Id=ioab.Overhead_ERP_Id,  
  oab.Invoice_Number=ioab.Invoice_Number,  
  oab.Calendar_Period_Id=per.FinancialPeriodID,  
  oab.Overhead_Billing=ioab.Overhead_Billing,  
  oab.Currency_Id=cur.CurrencyID,  
  oab.Exchange_Rate=ioab.Exchange_Rate,  
  oab.System_Source_Id=ss.System_Source_ID,  
  oab.LastModDate=GETDATE()  
 FROM #I_OVERHEAD_ACTUAL_BILLING ioab  
  LEFT JOIN tblCurrencies cur ON cur.Currency=ioab.Currency  
  LEFT JOIN tblFinancialPeriods per ON per.CalenderPeriod=ioab.Calendar_Period  
  LEFT JOIN SYSTEM_SOURCE ss ON ss.System_Source_Code=ioab.System_Source  
  LEFT JOIN OVERHEAD_ACTUAL_BILLING oab ON oab.Overhead_ERP_Id=ioab.Overhead_ERP_Id   
    AND oab.Invoice_Number=ioab.Invoice_Number   
    --AND oab.Calendar_Period=ioab.Calendar_Period  
 WHERE oab.Billing_Id IS NOT NULL  
  
SET @nRecUpdated=@@ROWCOUNT   
  
 INSERT OVERHEAD_ACTUAL_BILLING  
  (Overhead_ERP_Id,  
  Invoice_Number,  
  Calendar_Period_Id,  
  Overhead_Billing,  
  Currency_Id,  
  Exchange_Rate,  
  System_Source_Id,  
  LastModDate,  
  CreateDate)  
 SELECT  
  ioab.Overhead_ERP_Id,  
  ioab.Invoice_Number,  
  per.FinancialPeriodID,  
  ioab.Overhead_Billing,  
  cur.CurrencyID,  
  ioab.Exchange_Rate,  
  ss.System_Source_ID,  
  GETDATE(),  
  GETDATE()  
 FROM #I_OVERHEAD_ACTUAL_BILLING ioab  
  LEFT JOIN tblCurrencies cur ON cur.Currency=ioab.Currency  
  LEFT JOIN tblFinancialPeriods per ON per.CalenderPeriod=ioab.Calendar_Period  
  LEFT JOIN SYSTEM_SOURCE ss ON ss.System_Source_Code=ioab.System_Source  
  LEFT JOIN OVERHEAD_ACTUAL_BILLING oab ON oab.Overhead_ERP_Id=ioab.Overhead_ERP_Id   
    AND oab.Invoice_Number=ioab.Invoice_Number   
    --AND oab.Calendar_Period=ioab.Calendar_Period  
 WHERE oab.Billing_Id IS NULL  
  
SET @nRecInserted=@@ROWCOUNT   
  
-- Fix the date range of all Overhead_Headers  
EXEC OVERHEAD_FIX_DATE_RANGE_P  
-- Add to OVERHEAD_DETAIL_xxx if we changed the date range  
EXEC OVERHEAD_DETAIL_FIX_P  

FINISH:
IF @InterfaceSource=0 AND EXISTS(SELECT ImportFileName FROM IMPORT_ERROR WHERE ImportFileName=@ImportBatchName)
BEGIN
	DELETE IMPORT_ERROR WHERE ImportFileName=@ImportBatchName
END
	

IF EXISTS(SELECT MessageId FROM #z_Message)
BEGIN
	INSERT INTO IMPORT_ERROR(ImportFileName,Line_No,ErrorDescription,ImportErrorTypeId,LastModDate,ImportRecord,ImportSourceId)
	SELECT @ImportBatchName AS ImportFileName,CASE WHEN @InterfaceSource = 0 THEN Line_No END,ErrorDescription,
	ISNULL(ErrorType,@ErrBusinessRules) AS ImportErrorTypeId, 
	GETDATE() AS LastModDate,CONVERT(VARCHAR(MAX),ImportRecord),@InterfaceSource
	FROM #z_Message
END	
DROP TABLE #I_OVERHEAD_ACTUAL_BILLING
DROP TABLE #z_Message

GO


if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[BUDGET_EXPORT_DETAILS_PUT_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[BUDGET_EXPORT_DETAILS_PUT_P]
GO


create Procedure [dbo].[BUDGET_EXPORT_DETAILS_PUT_P]
/******************************************************************************
	File: 
	Name: BUDGET_EXPORT_DETAILS_PUT_P

	Called By: 

	Desc: 

	Auth: Koushik.Nagarajan
	Date: 21-Apr-2006
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	18-Apr-12   SD      E801 - Add Summary Costs With Period
	11-Sep-07	SI		Changed the order of Cost_Centre/Cost_Category for overhead cost export
	08-Jul-07	KN		Added Cost_Category to Summary Interface
	21-Jul-07	KN			Fixed - Collation and tempDB Conflicts
	20 Jul 07	KN		Added MovementType to HeadCount Export
	08 Jun 07	SI		Changed to support new SummaryCost(OPEX) export
	13 Nov 06	SI		Changed to support date based tasks
	10-Jul-2006	KN		Fixed the Type Flag of the CAPEX
	06-Jul-2006	KN		Fixed the Occ Qty occured in the same month.
	26-Jun-2006	KN		Removed the Duplicate Values created by Actuals and Projected
	14-Jun-2006	KN		Round(2) of Period Availability
	02-Jun-2006	KN		Enhancement to put Overheads text in the Projected_Task Column
	31-May-2006	KN		Fixed the Occ Qty 
	30-May-2006	KN		Applied ROUND(2) For all the values.
	26-May-2006	KN		Included Overhead Cost in the Cost Export
	26-May-2006	KN		Restriced the Usages to Primary QUOM of the Equipment
	18-May-2006	KN		Fixed the Manpower Results.(Removed EquipmentName)
	18-May-2006	KN		Changed the Labour Activity With Code
	18-May-2006	KN		Rounded Equipment Usages and RVIC
	16-May-2006	KN		Excluded the Equipment where IgnoreCost = 1
	15-May-2006	KN		Fixed the Residual_Value
	12-May-2006	KN		Updated the Ext_Scenario Name and Version in the Budget_Header Table
	09-May-2006	KN		Added Component Hierachy Interface 
	09-May-2006	KN		Added CAPEX Interface 
	08-May-2006	KN		Modified the cost centre, cost expense, tasktype codes
	14-Apr-2009	VV		CR7985 - increased application code to 50 char
	20 Aug 2009	V Vasylyeva	CR8375	Increasing Modifier Code to 50 char
	23 Aug 2011	V Vasylyeva	#2318 - do not export the negative availability
*******************************************************************************/
	/* Param List */
    
@Budget_Header_Id	INT,
@Ext_Scenario_Name	VARCHAR(50),
@Ext_Scenario_Version	VARCHAR(50),
@IsEntireTerm	BIT,
@StartPeriod	INT,
@EndPeriod	INT,
@Cost	INT,
@EquipmentUsagesInterface	BIT,
@CostsInterface	BIT,
@SummaryCostInterface BIT,
@HeadcountInterface	BIT,
@CapexInterface	BIT,
@ComponentHierInterface	BIT,
@SummaryCostWithPeriodsInterface BIT

AS

IF @IsEntireTerm = 1 
	BEGIN
		SELECT @StartPeriod = Start_Period , @EndPeriod = End_Period FROM BUDGET_HEADER WHERE Budget_Header_Id = @Budget_Header_Id
	END

DECLARE @IsActualCost BIT

IF @Cost = 1
	SET @IsActualCost = 1
ELSE IF @Cost = 2
	SET @IsActualCost = 0
ELSE
	SET @IsActualCost = NULL


/*  EQUIPMENT USAGES INTERFACE */

IF @EquipmentUsagesInterface = 1 
BEGIN	


	SELECT
		BP.Calendar_Period,      
		@Ext_Scenario_Name AS Scenario, 
		@Ext_Scenario_Version AS Version, 
		BE.Equipment_Name AS Equipment_Name, 		
		ROUND(/*VV #2318*/CASE WHEN SUM(BP.Availability)<0 THEN 0 ELSE SUM(BP.Availability) END,2)  AS Period_Availability, 
		SUM(BP.Baseline_Downtime + BP.Task_Downtime) AS Downtime_Hours, 
                      	ROUND(SUM(BPU.Period_End_Usage - BPU.Period_Start_Usage),2) AS Period_Usage, 
		ROUND(SUM(BPU.Period_End_Usage),2) AS Cumulative_Usage,
		CASE WHEN BPU.QUOM_Id IS NULL THEN 'Days'
			ELSE tblQUOMs.Short_Desc 
		END AS UOM,
		ROUND(SUM(BP.RVIC * BE.Component_Value ),2) AS Residual_Value, 
		ROUND(SUM(BP.RVIC),3) AS Residual_Value_Percent 
	FROM         BUDGET_EQUIPMENT BE INNER JOIN
                      BUDGET_HEADER BH ON BE.Budget_Header_Id = BH.Budget_Header_Id INNER JOIN
                      BUDGET_PERIOD BP ON BE.Budget_Equipment_Id = BP.Budget_Equipment_Id INNER JOIN
                      BUDGET_PERIOD_USAGE BPU ON BP.Budget_Period_Id = BPU.Budget_Period_Id AND  ISNULL(BPU.Quom_Id,0) = ISNULL(BE.End_QUOM_Id,0) 
                      LEFT JOIN tblQUOMs ON BPU.QUOM_Id = tblQUOMs.QUOMId
	WHERE
		BP.Calendar_Period BETWEEN @StartPeriod AND @EndPeriod
		AND BH.Budget_Header_Id = @Budget_Header_Id AND BE.Ignore_Cost <> 1
	GROUP BY BE.Equipment_Name, BP.Calendar_Period, 
		CASE WHEN BPU.QUOM_Id IS NULL THEN 'Days' ELSE tblQUOMs.Short_Desc END

END

/*  MAINTENANCE COST INTERFACE */
IF @CostsInterface = 1 OR @SummaryCostInterface = 1 OR @SummaryCostWithPeriodsInterface = 1 /*E801*/
BEGIN	
	
	CREATE TABLE #z_ExportCost(
		Period INT,
		Scenario VARCHAR(50) COLLATE database_default,
		Version VARCHAR(50) COLLATE database_default,
		Equipment_Name VARCHAR(50) COLLATE database_default NULL,
		Cost_Centre VARCHAR(50) COLLATE database_default NULL,
		Cost_Category VARCHAR(50) COLLATE database_default NULL,
		CC_Location VARCHAR(50) COLLATE database_default NULL,
		Cost_Expense VARCHAR(50) COLLATE database_default NULL,
		/*14-Apr-2009 Increased application code to varchar(50)*/
		--Projected_Task VARCHAR(50) COLLATE database_default NULL,
		/*20 Aug 2009	VV	CR8375	Increasing Modifier Code to 50 char*/
		Projected_Task VARCHAR(1000) COLLATE database_default NULL,
		Prime_Amount FLOAT NULL,
		Qty INT NULL,
		Budget_Occ_Id	INT NULL
	) 
	
	-- EQUIPMENT COSTS
	INSERT INTO #z_ExportCost (Period, Scenario, Version,  Equipment_Name,  Cost_Centre, Cost_Category, CC_Location,  Cost_Expense,  Projected_Task,  Prime_Amount, Qty, Budget_Occ_Id)
	SELECT     
		CAST(CONVERT(VARCHAR(6), BUDGET_OCC.Cost_Date, 112) AS INT) AS Period, 
		@Ext_Scenario_Name AS Scenario, 
		@Ext_Scenario_Version AS Version,  
		BUDGET_EQUIPMENT.Equipment_Name AS Equipment_Name, 
		COST_CENTRE.Cost_Centre_Code AS Cost_Centre,
		EQP_CATEGORY.Eqp_Category_Code AS Cost_Category,
		COST_CENTRE.CC_Location,
		COST_EXPENSE.Cost_Expense_Code AS Cost_Expense, 
		tblComponentCodes.Code + '.' + tblModifierCodes.Code + '.' + tblTaskTypes.Code + '.' + tblApplicationCodes.Code AS Projected_Task, 
		ROUND(SUM(BUDGET_COST.Sell),2) AS Prime_Amount, 
		(BUDGET_OCC.Occ_Qty) AS Qty,
		BUDGET_OCC.Budget_Occ_Id
	FROM	BUDGET_EQUIPMENT INNER JOIN
			BUDGET_HEADER ON BUDGET_EQUIPMENT.Budget_Header_Id = BUDGET_HEADER.Budget_Header_Id INNER JOIN
			BUDGET_TASK ON BUDGET_EQUIPMENT.Budget_Equipment_Id = BUDGET_TASK.Budget_Equipment_Id INNER JOIN
			BUDGET_OCC ON BUDGET_TASK.Budget_Task_Id = BUDGET_OCC.Budget_Task_Id INNER JOIN
			BUDGET_COST ON BUDGET_OCC.Budget_Occ_Id = BUDGET_COST.Budget_Occ_Id INNER JOIN
			tblComponentCodes ON BUDGET_TASK.Component_Code_Id = tblComponentCodes.ComponentCodeID INNER JOIN
			tblModifierCodes ON BUDGET_TASK.Modifier_Id = tblModifierCodes.ModifierID INNER JOIN
			tblTaskTypes ON BUDGET_TASK.Task_Type_Id = tblTaskTypes.TaskTypeID INNER JOIN
			tblApplicationCodes ON BUDGET_TASK.Application_Code_Id = tblApplicationCodes.ApplicationCodeID LEFT OUTER JOIN
			COST_EXPENSE ON BUDGET_COST.Cost_Expense_Id = COST_EXPENSE.Cost_Expense_ID LEFT OUTER JOIN
			COST_CENTRE ON BUDGET_COST.Cost_Centre_Id = COST_CENTRE.Cost_Centre_ID LEFT OUTER JOIN
			EQP_CATEGORY ON BUDGET_COST.Eqp_Category_Id = EQP_CATEGORY.Eqp_Category_Id
	WHERE
		CAST(CONVERT(VARCHAR(6), BUDGET_OCC.Cost_Date, 112) AS INT)  BETWEEN @StartPeriod AND @EndPeriod
		AND BUDGET_OCC.Is_Actual_Cost = ISNULL(@IsActualCost, BUDGET_OCC.Is_Actual_Cost)
		AND BUDGET_HEADER.Budget_Header_Id = @Budget_Header_Id AND BUDGET_EQUIPMENT.Ignore_Cost <> 1
	GROUP BY BUDGET_EQUIPMENT.Equipment_Name, 
			BUDGET_TASK.Proj_Task_Id, 
			CAST(CONVERT(VARCHAR(6), BUDGET_OCC.Cost_Date, 112) AS INT), 
			BUDGET_COST.Cost_Expense_Id, 
			BUDGET_COST.Cost_Centre_Id, 
			COST_CENTRE.Cost_Centre_Code, 
			EQP_CATEGORY.Eqp_Category_Code,
			COST_CENTRE.CC_Location,
			COST_EXPENSE.Cost_Expense_Code,
			BUDGET_OCC.Occ_Qty, 
			tblComponentCodes.Code + '.' + tblModifierCodes.Code + '.' + tblTaskTypes.Code + '.' + tblApplicationCodes.Code,
			BUDGET_OCC.Budget_Occ_Id
	ORDER BY CAST(CONVERT(VARCHAR(6), BUDGET_OCC.Cost_Date, 112) AS INT)

	-- OVERHEAD COSTS
	INSERT INTO #z_ExportCost (Period, Scenario, Version,  Equipment_Name,  Cost_Centre, Cost_Category, CC_Location,  Cost_Expense,  Projected_Task,  Prime_Amount, Qty,Budget_Occ_Id)
	SELECT     
		FP.CalenderPeriod AS Period, 
		@Ext_Scenario_Name AS Scenario, 
		@Ext_Scenario_Version AS Version,  
		BOC.Overhead_Cost_Code AS Equipment_Name, 
		CC.Cost_Centre_Code AS Cost_Centre, 
		BOC.Overhead_Cost_Code AS Cost_Category, 
		CC.CC_Location,
        CE.Cost_Expense_Code AS Cost_Expense, 
		'Overheads' AS Projected_Task,
		ROUND(SUM(BOCOST.Amount),2) AS Prime_Amount,
		0 AS Qty,
		0 AS Budget_Occ_Id
	FROM         
		BUDGET_OVERHEAD BO INNER JOIN
        BUDGET_OVERHEAD_CATEGORY BOC ON BO.Budget_Overhead_Id = BOC.Budget_Overhead_Id INNER JOIN
		BUDGET_OVERHEAD_COST BOCOST ON BOC.Budget_Overhead_Category_Id = BOCOST.Budget_Overhead_Category_Id INNER JOIN
		tblFinancialPeriods FP ON BOCOST.Calendar_Period_Id = FP.FinancialPeriodID INNER JOIN
		COST_CENTRE CC ON BOC.Cost_Centre_Id = CC.Cost_Centre_ID INNER JOIN
		COST_EXPENSE CE ON BOC.Cost_Expense_Id = CE.Cost_Expense_ID
	WHERE     
		(BO.Budget_Header_Id = @Budget_Header_Id) AND 
		 FP.CalenderPeriod BETWEEN @StartPeriod AND @EndPeriod AND
		CONVERT(bit, CASE WHEN FP.CalenderPeriod < CONVERT(int, LEFT(CONVERT(varchar, BO.Create_Date, 112), 6)) THEN 1 ELSE 0 END) =  ISNULL(@IsActualCost, CONVERT(bit, CASE WHEN FP.CalenderPeriod < CONVERT(int, LEFT(CONVERT(varchar, BO.Create_Date, 112), 6)) THEN 1 ELSE 0 END))
		AND BOCOST.Amount <> 0
	GROUP BY 
		FP.CalenderPeriod, 
		BOC.Overhead_Cost_Code, 
		CC.Cost_Centre_Code, 
		CC.CC_Location,
		CE.Cost_Expense_Code


	IF @CostsInterface = 1
		SELECT Period, Scenario, Version, Equipment_Name, Cost_Centre, Cost_Expense, Projected_Task, SUM(Prime_Amount) AS Prime_Amount , SUM(Qty) AS Qty
		FROM #z_ExportCost
		GROUP BY Period, Scenario ,Version ,Equipment_Name,Cost_Centre ,Cost_Expense,Projected_Task

	--OPEX interface
	IF @SummaryCostInterface = 1
		SELECT	Period, Scenario, Version, Cost_Centre, Cost_Category, CC_Location, Cost_Expense, SUM(Prime_Amount) AS Prime_Amount
		FROM	#z_ExportCost
		GROUP BY Period, Scenario, Version, Cost_Centre,Cost_Category, CC_Location, Cost_Expense
	
	-- Ouput Summary Cost With Periods Result
	IF @SummaryCostWithPeriodsInterface = 1
	BEGIN
		DECLARE @cols VARCHAR(max)
		DECLARE @SQL VARCHAR(max)

		-- Generate a column list from period data. Period to be formatted YYYY-MM
		SELECT  @cols = STUFF(( SELECT DISTINCT TOP 100 PERCENT
										'],[' /* + 'P'*/ + SUBSTRING(CONVERT(varchar, e.Period),1,4) + '-' + SUBSTRING(CONVERT(varchar, e.Period),5,2)
								FROM    #z_ExportCost AS e
								ORDER BY '],[' /* + 'P'*/ + SUBSTRING(CONVERT(varchar, e.Period),1,4) + '-' + SUBSTRING(CONVERT(varchar, e.Period),5,2)
								FOR XML PATH('')
							  ), 1, 2, '') + ']'
		
		-- Dynamic SQL needed due to variable period columns
		
		SET @SQL =
		'SELECT Scenario, Version, 
			Cost_Centre AS [Cost Centre], 
			Cost_Centre_Desc AS [Cost Centre Description],
			Cost_Expense AS [Expense Element], 
			Cost_Expense_Desc AS [Expense Element Description],
			' + @cols + '
		FROM 
		(
			SELECT	
					/* ''P'' + */ SUBSTRING(CONVERT(varchar, e.Period),1,4) + ''-'' + SUBSTRING(CONVERT(varchar, e.Period),5,2) AS Period, 
					e.Scenario, e.Version, 
					e.Cost_Centre, cc.Cost_Centre_Desc, 
					e.Cost_Expense, ce.Cost_Expense_Desc,
					SUM(e.Prime_Amount) AS Prime_Amount
			FROM	#z_ExportCost e
			left join COST_EXPENSE ce on e.Cost_Expense = ce.Cost_Expense_Code 
			left join COST_CENTRE cc on e.Cost_Centre = cc.Cost_Centre_Code
			GROUP BY Period, Scenario, Version, 
					e.Cost_Centre, cc.Cost_Centre_Desc, 
					e.Cost_Expense, ce.Cost_Expense_Desc
		) p
		PIVOT (SUM (Prime_Amount) FOR Period IN (' + @cols + ')) AS pvt'
		
		EXEC(@SQL)
		
	END

	DROP TABLE #z_ExportCost
END

/*  MANPOWER FORECAST INTERFACE */
IF @HeadcountInterface = 1 
BEGIN	
	SELECT     
		BHC.Period, 
		@Ext_Scenario_Name AS Scenario, 
		@Ext_Scenario_Version AS Version, 
		CC.Cost_Centre_Code AS Cost_Centre,
		LA.ActivityCode AS Position_Code,
		MMT.Code AS Movement_Type,		
		BHC.Labour_Quantity   AS Headcount
	FROM   BUDGET_HEADER BH INNER JOIN
	                      BUDGET_HEADCOUNT BHC ON BH.Budget_Header_Id = BHC.Budget_Header_Id INNER JOIN
	                      COST_CENTRE CC ON BHC.Cost_Centre_Id = CC.Cost_Centre_ID INNER JOIN
	                      tblLabourActivities LA ON BHC.Labour_Activity_Id = LA.LabourActivityId INNER JOIN
						  MANPOWER_MOVEMENT_TYPE MMT ON BHC.ManpowerMovementTypeId = MMT.ManpowerMovementTypeId
	WHERE
		BHC.Period  BETWEEN @StartPeriod AND @EndPeriod
		AND BH.Budget_Header_Id = @Budget_Header_Id
		AND BHC.Labour_Quantity > 0
	ORDER BY BHC.Period, BHC.Labour_Activity_Id, CC.Cost_Centre_Code,LA.ActivityCode, MMT.Code
	
END

/*  CAPITAL EXPENDITURE INTERFACE */
IF @CapexInterface = 1 
BEGIN	

	SELECT 
		CAST(CONVERT(VARCHAR(6),  BE.Equipment_Start_Date, 112) AS INT) AS Period, 
		@Ext_Scenario_Name AS Scenario, 
		@Ext_Scenario_Version AS Version, 
	 	BE.Equipment_Name AS Equipment_Name,
		CC.Cost_Centre_Code AS Cost_Centre,
		ROUND(BE.Purchase_Price,2) As Purchase_Price,
		0  As Disposal_Price,
		CASE 
			WHEN  ISNULL(BE.Replace_Equipment_Name,'') <> '' THEN 'R'
			ELSE  'N'
		END As Type_Flag
	FROM         
		BUDGET_EQUIPMENT BE  INNER JOIN
	        	BUDGET_HEADER BH ON BH.Budget_Header_Id = BE.Budget_Header_Id INNER JOIN
	        	COST_CENTRE CC ON BE.Cost_Centre_Id = CC.Cost_Centre_ID
	WHERE CAST(CONVERT(VARCHAR(6),  BE.Equipment_Start_Date, 112) AS INT)  BETWEEN @StartPeriod AND @EndPeriod
		AND BH.Budget_Header_Id = @Budget_Header_Id AND BE.Ignore_Cost <> 1 AND (BE.New_Equipment = 1 )
	UNION
	SELECT 
		CAST(CONVERT(VARCHAR(6),  BE.End_Date, 112) AS INT) AS Period, 
		@Ext_Scenario_Name AS Scenario, 
		@Ext_Scenario_Version AS Version, 
	 	BE.Equipment_Name AS Equipment_Name,
		CC.Cost_Centre_Code AS Cost_Centre,
		0 As Purchase_Price,
		ROUND(BE.Equipment_Sale_Price,2) As Disposal_Price,
		CASE 
			WHEN  BE.Equipment_Sale_Price > 0 THEN 'D'		
		END As Type_Flag
	FROM         
		BUDGET_EQUIPMENT BE  INNER JOIN
	        BUDGET_HEADER BH ON BH.Budget_Header_Id = BE.Budget_Header_Id INNER JOIN
	        COST_CENTRE CC ON BE.Cost_Centre_Id = CC.Cost_Centre_ID
	WHERE   CAST(CONVERT(VARCHAR(6),  BE.End_Date, 112) AS INT)  BETWEEN @StartPeriod AND @EndPeriod
		AND BH.Budget_Header_Id = @Budget_Header_Id AND BE.Ignore_Cost <> 1 AND (BE.Equipment_Sale_Price > 0 )

END

/*  COMPONENT HIERACHY INTERFACE */

IF @ComponentHierInterface = 1 
BEGIN	
	SELECT     
		S.[System] AS [System], 
		SS.SubSystem AS Sub_System, 
		CC.Code AS Component_Code, 
		CC.[Description] AS Component_Code_Description, 
	        	CC.Code + '.' + MC.Code + '.' + TT.Code + '.' + AC.Code AS Projected_Task_Code, 
	        	CC.Code + '.' + MC.Code + '.' + TT.Code + '.' + AC.Code + ' ' + CC.[Description] AS Projected_Task_Description
	FROM         BUDGET_HEADER BH INNER JOIN
	                      BUDGET_EQUIPMENT BE ON BH.Budget_Header_Id = BE.Budget_Header_Id INNER JOIN
	                      BUDGET_TASK BT ON BE.Budget_Equipment_Id = BT.Budget_Equipment_Id INNER JOIN
	                      tblComponentCodes CC ON BT.Component_Code_Id = CC.ComponentCodeID INNER JOIN
	                      tblSubSystems SS ON CC.SubSystemID = SS.SubSystemID INNER JOIN
	                      tblSystems S ON SS.SystemID = S.SystemID INNER JOIN
	                      tblTaskTypes TT ON BT.Task_Type_Id = TT.TaskTypeID INNER JOIN
	                      tblModifierCodes MC ON BT.Modifier_Id = MC.ModifierID INNER JOIN
	                      tblApplicationCodes AC ON BT.Application_Code_Id = AC.ApplicationCodeID
	WHERE BH.Budget_Header_Id = @Budget_Header_Id AND BE.Ignore_Cost <> 1
	GROUP BY S.[System], SS.SubSystem, CC.Code, CC.[Description], CC.Code + '.' + MC.Code + '.' + TT.Code + '.' + AC.Code, 
	                      CC.Code + '.' + MC.Code + '.' + TT.Code + '.' + AC.Code + ' ' + CC.[Description]
	ORDER BY S.[System], SS.SubSystem, CC.Code
END


/* UPDATE  BUDGET_HEADER TABLE*/
UPDATE BUDGET_HEADER
SET 
	Last_Mod_Date = getdate(),
	is_Exported = 1,
	Ext_Scenario_Name = @Ext_Scenario_Name,
	Ext_Version_No = @Ext_Scenario_Version,
	Budget_Status_Id = 2
WHERE Budget_Header_Id = @Budget_Header_Id

RETURN



GO



if exists (select * from dbo.sysobjects where id = object_id(N'OVERHEAD_ACTUAL_COST_IMPORT_P') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure OVERHEAD_ACTUAL_COST_IMPORT_P
GO

CREATE PROCEDURE OVERHEAD_ACTUAL_COST_IMPORT_P
/******************************************************************************
	
	Name: OVERHEAD_ACTUAL_COST_IMPORT_P

	Called By: 

	Desc: 

	Auth: 	Sergey Ivanov
	Date: 	5 August 2005
*******************************************************************************
		Change History
*******************************************************************************
Date:		Author:		Description:
--------	--------	----------------------------------------
17 Apr 12   GD          E785

--OLD COMMENTS

05 Apr 06	SI		Added Cost_Centre and Expense_Element
01 Sep 05	SI		Allows to import records for the equipment that does not exists
27 Oct 06	KN		If there are more than one Equipment matches with the Serial Number and Model, 
				then the Overhead cost will be assigned to the Equipment which has greater End Date
21-Jul-07	KN			Fixed - Collation and tempDB Conflicts
20-May-2009	KN		Fixed declaring explicit Constraint Names
*******************************************************************************/
	/* Param List */

@doc text,
@nRecInserted int = 0 OUTPUT,
@nRecUpdated int = 0 OUTPUT,
@nRecRejected int = 0 OUTPUT,
--GD 18/04/12 E785
@InterfaceSource INT = 0,
@ImportBatchName varchar(1000) = '' 

AS
DECLARE @TypeVarchar int
DECLARE @ErrParsing int
DECLARE @TypeInt int
DECLARE @TypeFloat int
DECLARE @ErrBusinessRules int

SET @ErrBusinessRules = 3
SET @ErrParsing = 1 
SET @TypeVarchar = 1
SET @TypeInt = 2
SET @TypeFloat = 3


--Create table for error messages records	
CREATE TABLE #z_Message(MessageId int IDENTITY(1,1),Line_No int,
ErrorDescription varchar(5000) COLLATE DATABASE_DEFAULT,
EqpPlanId int,ProjectId int,ErrorType int,ImportRecord VARCHAR(MAX)
PRIMARY KEY(MessageId))

CREATE TABLE #I_OVERHEAD_ACTUAL_COST
(
	Line_Num int IDENTITY(1,1) ,
	Model VARCHAR (1000) COLLATE database_default  ,
	Serial_Number VARCHAR (1000) COLLATE database_default ,
	Calendar_Period VARCHAR (1000)COLLATE database_default ,
	Cost_Centre VARCHAR (1000) COLLATE database_default ,
	Expense_Element VARCHAR (1000) COLLATE database_default ,
	Overhead_Category VARCHAR (1000) COLLATE database_default,
	Overhead_Cost VARCHAR (1000) COLLATE database_default ,
	Currency VARCHAR (1000) COLLATE database_default ,
	Exchange_Rate VARCHAR (1000)COLLATE database_default,
	System_Source VARCHAR (1000) COLLATE database_default 
	--CONSTRAINT ID_UN UNIQUE (Model, Serial_Number, Calendar_Period, Cost_Centre, Expense_Element, Overhead_Category, Currency)
)

DECLARE @idoc int

EXEC sp_xml_preparedocument @idoc OUTPUT, @doc

	INSERT #I_OVERHEAD_ACTUAL_COST
	SELECT
	NULLIF(LTRIM(RTRIM(Model)),'') AS Model,
	NULLIF(LTRIM(RTRIM(Serial_Number)),'') AS Serial_Number,
	NULLIF(LTRIM(RTRIM(Calendar_Period)),'') AS Calendar_Period,
	NULLIF(LTRIM(RTRIM(Cost_Centre)),'') AS Cost_Centre,
	NULLIF(LTRIM(RTRIM(Expense_Element)),'') AS Expense_Element,
	NULLIF(LTRIM(RTRIM(Overhead_Category)),'') AS Overhead_Category,
	NULLIF(LTRIM(RTRIM(Overhead_Cost)),'') AS Overhead_Cost,
	NULLIF(LTRIM(RTRIM(Currency)),'') AS Currency,
	NULLIF(LTRIM(RTRIM(Exchange_Rate)),'') AS Exchange_Rate,
	NULLIF(LTRIM(RTRIM(System_Source)),'') AS System_Source		
	FROM OPENXML (@idoc, '/I_OVERHEAD_ACTUAL_COSTs/I_OVERHEAD_ACTUAL_COST',2) WITH #I_OVERHEAD_ACTUAL_COST ioac
	
 --Check data type
INSERT INTO #z_Message(Line_No,ErrorDescription,ErrorType,ImportRecord)
SELECT Line_Num, CASE  WHEN Model IS NULL THEN 'Missing Required Filed:Model' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Model',20,Model,0) END +
	CASE  WHEN Serial_Number IS NULL THEN 'Missing Required Filed:Serial_Number' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Serial_Number', 50,Serial_Number,0) END +
	CASE  WHEN Calendar_Period IS NULL THEN 'Missing Required Filed:Calendar_Period' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeInt,'Calendar_Period', 3,Calendar_Period,0) END +
	CASE  WHEN Cost_Centre IS NULL THEN 'Missing Required Filed:Cost_Centre' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Cost_Centre', 30,Cost_Centre,0) END +
	CASE  WHEN Expense_Element IS NULL THEN 'Missing Required Filed:Expense_Element'   ELSE dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Expense_Element', 10,Expense_Element,0) END +
	CASE  WHEN Overhead_Category IS NULL THEN 'Missing Required Filed:Overhead_Category' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Overhead_Category', 10,Overhead_Category,0) END +
	CASE  WHEN Currency IS NULL THEN 'Missing Required Filed:Currency' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Currency', 3,Currency,0)END +
	CASE  WHEN Overhead_Cost IS NULL THEN 'Missing Required Filed:Overhead_Cost' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Overhead_Cost', 0,Overhead_Cost,0)END +
	CASE  WHEN Exchange_Rate IS NULL THEN 'Missing Required Filed:Exchange_Rate' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Exchange_Rate', 0,Exchange_Rate,0)END +
	CASE  WHEN System_Source IS NULL THEN 'Missing Required Filed:System_Source' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'System_Source', 10,System_Source,0)END
    AS ErrorDescription,@ErrParsing AS ErrorType,
    CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Model, Serial_Number, Calendar_Period, Cost_Centre, Expense_Element, Overhead_Category, Currency, Overhead_Cost ,Exchange_Rate ,System_Source FROM  #I_OVERHEAD_ACTUAL_COST TEMPOVERBILL WHERE TEMPOVERBILL.Line_Num = #I_OVERHEAD_ACTUAL_COST.Line_Num FOR XML PATH('I_OVERHEAD_ACTUAL_COST'),ROOT('I_OVERHEAD_ACTUAL_COSTs')) END
  AS ImportRecord
FROM
#I_OVERHEAD_ACTUAL_COST

--Delete lines without any error message	
DELETE #z_Message WHERE ErrorDescription=''	
----Reject the whole file
IF EXISTS(SELECT Line_No FROM #z_Message)
	BEGIN
		SET @nRecInserted = 0 
		SET @nRecUpdated  = 0   
		SET @nRecRejected = (SELECT COUNT(*) FROM #I_OVERHEAD_ACTUAL_COST)
		GOTO FINISH
	END
	
	
IF EXISTS(SELECT * FROM #I_OVERHEAD_ACTUAL_COST GROUP BY Model, Serial_Number, Calendar_Period, Cost_Centre, Expense_Element, Overhead_Category, Currency HAVING COUNT(*)>1)
BEGIN 

INSERT INTO #z_Message(Line_No,ErrorDescription,ErrorType,ImportRecord)
SELECT NULL , 'Duplicate record having same Model, Serial_Number, Calendar_Period, Cost_Centre, Expense_Element, Overhead_Category, Currency',@ErrBusinessRules AS ErrorType
,CASE WHEN @InterfaceSource = 1 THEN 
		(
		SELECT TEMPOVERCOST.Model, TEMPOVERCOST.Serial_Number, TEMPOVERCOST.Calendar_Period, TEMPOVERCOST.Cost_Centre, TEMPOVERCOST.Expense_Element, TEMPOVERCOST.Overhead_Category, TEMPOVERCOST.Currency,TEMPOVERCOST.Overhead_Cost ,TEMPOVERCOST.Exchange_Rate ,TEMPOVERCOST.System_Source FROM  #I_OVERHEAD_ACTUAL_COST TEMPOVERCOST 
		INNER JOIN (SELECT Model, Serial_Number, Calendar_Period, Cost_Centre, Expense_Element, Overhead_Category, Currency FROM #I_OVERHEAD_ACTUAL_COST
													GROUP BY Model, Serial_Number, Calendar_Period, Cost_Centre, Expense_Element, Overhead_Category, Currency
													HAVING COUNT(*)>1) TEMP
													ON TEMPOVERCOST.Model=TEMP.Model AND 
													TEMPOVERCOST.Model=TEMP.Model AND
													TEMPOVERCOST.Serial_Number=TEMP.Serial_Number AND
													TEMPOVERCOST.Calendar_Period=TEMP.Calendar_Period AND
													TEMPOVERCOST.Cost_Centre=TEMP.Cost_Centre AND
													TEMPOVERCOST.Expense_Element=TEMP.Expense_Element AND
													TEMPOVERCOST.Overhead_Category=TEMP.Overhead_Category AND 
													TEMPOVERCOST.Currency=TEMP.Currency 												
													FOR XML PATH('I_OVERHEAD_ACTUAL_COST'),ROOT('I_OVERHEAD_ACTUAL_COSTs')) END  AS ImportRecord 
SET @nRecInserted = 0 
SET @nRecUpdated  = 0   
SET @nRecRejected = (SELECT COUNT(*) FROM #I_OVERHEAD_ACTUAL_COST)
GOTO FINISH
												
END
 
IF EXISTS (SELECT * FROM #I_OVERHEAD_ACTUAL_COST ioac WHERE  CONVERT(Float,Exchange_Rate)<0)
BEGIN 
	INSERT INTO #z_Message(Line_No,ErrorDescription,ErrorType,ImportRecord)
		SELECT Line_Num , 'Exchange Rate can not be negative',@ErrBusinessRules AS ErrorType,
		CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT TEMPOVERCOST.Model, TEMPOVERCOST.Serial_Number, TEMPOVERCOST.Calendar_Period, TEMPOVERCOST.Cost_Centre, TEMPOVERCOST.Expense_Element, TEMPOVERCOST.Overhead_Category, TEMPOVERCOST.Currency ,TEMPOVERCOST.Overhead_Cost ,TEMPOVERCOST.Exchange_Rate ,TEMPOVERCOST.System_Source FROM  #I_OVERHEAD_ACTUAL_COST TEMPOVERCOST 
													 WHERE  TEMPOVERBILL.Line_Num = ioac.Line_Num FOR XML PATH('I_OVERHEAD_ACTUAL_COST'),ROOT('I_OVERHEAD_ACTUAL_COSTs')) END AS ImportRecord 
	    FROM #I_OVERHEAD_ACTUAL_COST ioac WHERE  CONVERT(Float,Exchange_Rate)<0
SET @nRecInserted = 0 
SET @nRecUpdated  = 0   
SET @nRecRejected = (SELECT COUNT(*) FROM #I_OVERHEAD_ACTUAL_BILLING)
GOTO FINISH
												
END



IF EXISTS (SELECT * FROM #I_OVERHEAD_ACTUAL_COST ioac LEFT JOIN tblCurrencies cur ON cur.Currency=ioac.Currency	WHERE cur.CurrencyID IS NULL)
BEGIN
	INSERT INTO #z_Message(Line_No,ErrorDescription,ErrorType,ImportRecord)
		SELECT Line_Num , 'Currency does not exist ',@ErrBusinessRules AS ErrorType,
		CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT TEMPOVERCOST.Model, TEMPOVERCOST.Serial_Number, TEMPOVERCOST.Calendar_Period, TEMPOVERCOST.Cost_Centre, TEMPOVERCOST.Expense_Element, TEMPOVERCOST.Overhead_Category, TEMPOVERCOST.Currency ,TEMPOVERCOST.Overhead_Cost ,TEMPOVERCOST.Exchange_Rate ,TEMPOVERCOST.System_Source FROM  #I_OVERHEAD_ACTUAL_COST TEMPOVERCOST WHERE  TEMPOVERCOST.Line_Num = ioac.Line_Num FOR XML PATH('I_OVERHEAD_ACTUAL_COST'),ROOT('I_OVERHEAD_ACTUAL_COSTs')) END
		AS ImportRecord 
		FROM #I_OVERHEAD_ACTUAL_COST ioac
		LEFT JOIN tblCurrencies cur ON cur.Currency=ioac.Currency WHERE  cur.CurrencyID IS NULL
		
		SET @nRecInserted = 0 
		SET @nRecUpdated  = 0   
		SET @nRecRejected = (SELECT COUNT(*) FROM #I_OVERHEAD_ACTUAL_COST)
		GOTO FINISH
END

  
  
  	
IF EXISTS (SELECT * FROM #I_OVERHEAD_ACTUAL_COST ioac LEFT JOIN tblFinancialPeriods per ON per.CalenderPeriod=ioac.Calendar_Period	WHERE per.FinancialPeriodID IS NULL)
BEGIN
		INSERT INTO #z_Message(Line_No,ErrorDescription,ErrorType,ImportRecord)
		SELECT Line_Num , 'Currency does not exist ',@ErrBusinessRules AS ErrorType,
		CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT TEMPOVERCOST.Model, TEMPOVERCOST.Serial_Number, TEMPOVERCOST.Calendar_Period, TEMPOVERCOST.Cost_Centre, TEMPOVERCOST.Expense_Element, TEMPOVERCOST.Overhead_Category, TEMPOVERCOST.Currency ,TEMPOVERCOST.Overhead_Cost ,TEMPOVERCOST.Exchange_Rate ,TEMPOVERCOST.System_Source FROM  #I_OVERHEAD_ACTUAL_COST TEMPOVERCOST WHERE  TEMPOVERCOST.Line_Num = ioac.Line_Num FOR XML PATH('I_OVERHEAD_ACTUAL_COST'),ROOT('I_OVERHEAD_ACTUAL_COSTs')) END
		AS ImportRecord 
		FROM #I_OVERHEAD_ACTUAL_COST ioac
		LEFT JOIN tblFinancialPeriods per ON per.CalenderPeriod=ioac.Calendar_Period	WHERE per.FinancialPeriodID IS NULL

		SET @nRecInserted = 0 
		SET @nRecUpdated  = 0   
		SET @nRecRejected = (SELECT COUNT(*) FROM #I_OVERHEAD_ACTUAL_COST)
		GOTO FINISH
END
  

	DELETE ioac
	FROM #I_OVERHEAD_ACTUAL_COST ioac
		LEFT JOIN AMT_VARIABLE vr ON vr.amt_var_id=1
		LEFT JOIN tblModels mod ON ioac.Model=mod.Model
		LEFT JOIN tblEquipment eqp ON eqp.ModelId=mod.ModelId 
			AND ( (ISNULL(vr.ModelSerialSeparator,'')='' AND eqp.SerialNumber=ioac.Serial_Number)
			   OR (ISNULL(vr.ModelSerialSeparator,'')<>'' AND ioac.Model+vr.ModelSerialSeparator+ioac.Serial_Number=eqp.SerialNumber) )
		LEFT JOIN tblCurrencies cur ON cur.Currency=ioac.Currency
		LEFT JOIN tblFinancialPeriods per ON per.CalenderPeriod=ioac.Calendar_Period
	WHERE 	--mod.ModelId IS NULL
		--OR eqp.EquipmentId IS NULL
		--OR 
		cur.CurrencyID IS NULL
		OR per.FinancialPeriodID IS NULL

SET @nRecRejected=@@ROWCOUNT 

-- Add System_Source if it's a new one
   INSERT SYSTEM_SOURCE
	(System_Source_Code, Last_Mod_By_User_ID, Last_Mod_Date, 
	Create_By_User_ID, Create_Date)
	SELECT DISTINCT ioac.System_Source, 0, GETDATE(), 0, GETDATE()
	FROM #I_OVERHEAD_ACTUAL_COST ioac
	WHERE ioac.System_Source NOT IN (SELECT System_Source_Code FROM SYSTEM_SOURCE)

-- Add Cost Centre if it's a new one
   INSERT COST_CENTRE
	(Cost_Centre_Code, Cost_Centre_Desc, Last_Mod_By_User_ID, Last_Mod_Date, 
	Create_By_User_ID, Create_Date)
	SELECT DISTINCT ioac.Cost_Centre, ioac.Cost_Centre, 0, GETDATE(), 0, GETDATE()
	FROM #I_OVERHEAD_ACTUAL_COST ioac
	WHERE ioac.Cost_Centre NOT IN (SELECT Cost_Centre_Code FROM COST_CENTRE)

-- Add Cost Expense if it's a new one
   INSERT COST_EXPENSE
	(Cost_Expense_Code, Cost_Expense_Desc, Last_Mod_By_User_ID, Last_Mod_Date, 
	Create_By_User_ID, Create_Date)
	SELECT DISTINCT ioac.Expense_Element, ioac.Expense_Element, 0, GETDATE(), 0, GETDATE()
	FROM #I_OVERHEAD_ACTUAL_COST ioac
	WHERE ioac.Expense_Element NOT IN (SELECT Cost_Expense_Code FROM COST_EXPENSE)

-- Add Overhead Category if it's a new one
   INSERT OVERHEAD_COST_CATEGORIES
	(Cost_Centre_ID, Cost_Expense_ID, Overhead_Cost_Code, Overhead_Cost_Description, COS_Overhead, Created_Date, Last_Mod_Date)
	SELECT DISTINCT cc.Cost_Centre_ID, ce.Cost_Expense_ID, ioac.Overhead_Category, ioac.Overhead_Category, 0, GETDATE(), GETDATE()
	FROM #I_OVERHEAD_ACTUAL_COST ioac
		LEFT JOIN COST_CENTRE cc ON ioac.Cost_Centre = cc.Cost_Centre_Code
		LEFT JOIN COST_EXPENSE ce ON ioac.Expense_Element = ce.Cost_Expense_Code
		LEFT JOIN OVERHEAD_COST_CATEGORIES ohc ON ohc.Overhead_Cost_Code = ioac.Overhead_Category AND ISNULL(cc.Cost_Centre_ID,0) = ISNULL(ohc.Cost_Centre_ID,0) AND ISNULL(ce.Cost_Expense_ID,0) = ISNULL(ohc.Cost_Expense_ID,0)
	WHERE ohc.Overhead_Category_Id IS NULL

--=============================================================
--================  Updating physical table  ==================
--=============================================================

	UPDATE oac
	SET	
		-- Do not change the Equipment if the work order is being reimported and already assigned to an Equipment
		oac.Equipment_Id=CASE WHEN ISNULL(oac.Equipment_Id,0)  < 1 THEN  
						ISNULL(eqp.EquipmentId,-1) 
					ELSE
						oac.Equipment_Id
					END ,
		oac.Model=ioac.Model,
		oac.SerialNumber=ioac.Serial_Number,
		oac.Calendar_Period_Id=per.FinancialPeriodID,
		oac.Overhead_Category_Id=oc.Overhead_Category_Id,
		oac.Overhead_Cost=ioac.Overhead_Cost,
		oac.Currency_Id=cur.CurrencyID,
		oac.Exchange_Rate=ioac.Exchange_Rate,
		oac.System_Source_Id=ss.System_Source_ID,
		oac.LastModDate=getdate()
	FROM #I_OVERHEAD_ACTUAL_COST ioac
		LEFT JOIN AMT_VARIABLE vr ON vr.amt_var_id=1
		LEFT JOIN tblModels mod ON ioac.Model=mod.Model
		LEFT JOIN tblEquipment eqp ON eqp.ModelId=mod.ModelId 
			AND ( (ISNULL(vr.ModelSerialSeparator,'')='' AND eqp.SerialNumber=ioac.Serial_Number)
			   OR (ISNULL(vr.ModelSerialSeparator,'')<>'' AND ioac.Model+vr.ModelSerialSeparator+ioac.Serial_Number=eqp.SerialNumber) )
		LEFT JOIN tblEqpPlans EP ON EP.EquipmentId = eqp.EquipmentId
		LEFT JOIN tblEqpProjs EPROJ ON EPROJ.EqpPlanId = EP.EqpPlanId AND EPROJ.Projection_Type_ID = 1
		INNER JOIN 
			(-- if serial number and model matches more than one equipment , then select the equipment which has greater End Date
				SELECT     MAX(dbo.tblEqpProjs.EndDate) AS EndDate, dbo.tblEquipment.SerialNumber, dbo.tblEquipment.ModelId
				FROM         dbo.tblEquipment INNER JOIN
							dbo.tblEqpPlans ON dbo.tblEquipment.EquipmentId = dbo.tblEqpPlans.EquipmentId INNER JOIN
												dbo.tblEqpProjs ON dbo.tblEqpPlans.EqpPlanId = dbo.tblEqpProjs.EqpPlanId
						WHERE     (dbo.tblEqpProjs.Projection_Type_ID = 1)
						GROUP BY dbo.tblEquipment.SerialNumber, dbo.tblEquipment.ModelId
			) EqpMaxEndDate
		ON EqpMaxEndDate.SerialNumber = eqp.SerialNumber AND EqpMaxEndDate.ModelId = eqp.ModelId AND EPROJ.EndDate = EqpMaxEndDate.EndDate	
		LEFT JOIN tblCurrencies cur ON cur.Currency=ioac.Currency
		LEFT JOIN tblFinancialPeriods per ON per.CalenderPeriod=ioac.Calendar_Period
		LEFT JOIN COST_CENTRE cc ON ioac.Cost_Centre = cc.Cost_Centre_Code
		LEFT JOIN COST_EXPENSE ce ON ioac.Expense_Element = ce.Cost_Expense_Code
		LEFT JOIN OVERHEAD_COST_CATEGORIES oc ON oc.Overhead_Cost_Code=ioac.Overhead_Category  AND ISNULL(cc.Cost_Centre_ID,0) = ISNULL(oc.Cost_Centre_ID,0) AND ISNULL(ce.Cost_Expense_ID,0) = ISNULL(oc.Cost_Expense_ID,0)
		LEFT JOIN SYSTEM_SOURCE ss ON ss.System_Source_Code=ioac.System_Source
		LEFT JOIN OVERHEAD_ACTUAL_COST oac ON oac.Model=ioac.Model AND oac.SerialNumber=ioac.Serial_Number --oac.Equipment_Id=eqp.EquipmentId 
				AND oac.Calendar_Period_Id=per.FinancialPeriodID 
				AND oac.Overhead_Category_Id=oc.Overhead_Category_Id 
				AND oac.Currency_Id=cur.CurrencyID
	WHERE oac.Cost_Id IS NOT NULL


SET @nRecUpdated=@@ROWCOUNT 

	INSERT OVERHEAD_ACTUAL_COST
		(Equipment_Id,
		Model,
		SerialNumber,
		Calendar_Period_Id,
		Overhead_Category_Id,
		Overhead_Cost,
		Currency_Id,
		Exchange_Rate,

		System_Source_Id,
		LastModDate,
		CreateDate)
	SELECT
		ISNULL(eqp.EquipmentId,-1),
		ioac.Model,
		ioac.Serial_Number,
		per.FinancialPeriodID,
		oc.Overhead_Category_Id,
		ioac.Overhead_Cost,
		cur.CurrencyID,
		ioac.Exchange_Rate,
		ss.System_Source_ID,
		getdate(),
		getdate()
	FROM #I_OVERHEAD_ACTUAL_COST ioac
		LEFT JOIN AMT_VARIABLE vr ON vr.amt_var_id=1
		LEFT JOIN tblModels mod ON ioac.Model=mod.Model
		LEFT JOIN tblEquipment eqp ON eqp.ModelId=mod.ModelId 
			AND ( (ISNULL(vr.ModelSerialSeparator,'')='' AND eqp.SerialNumber=ioac.Serial_Number)
			   OR (ISNULL(vr.ModelSerialSeparator,'')<>'' AND ioac.Model+vr.ModelSerialSeparator+ioac.Serial_Number=eqp.SerialNumber) )
		LEFT JOIN tblEqpPlans EP ON EP.EquipmentId = eqp.EquipmentId
		LEFT JOIN tblEqpProjs EPROJ ON EPROJ.EqpPlanId = EP.EqpPlanId AND EPROJ.Projection_Type_ID = 1
		INNER JOIN 
			(-- if serial number and model matches more than one equipment , then select the equipment which has greater End Date
				SELECT     MAX(dbo.tblEqpProjs.EndDate) AS EndDate, dbo.tblEquipment.SerialNumber, dbo.tblEquipment.ModelId
				FROM         dbo.tblEquipment INNER JOIN
							dbo.tblEqpPlans ON dbo.tblEquipment.EquipmentId = dbo.tblEqpPlans.EquipmentId INNER JOIN
												dbo.tblEqpProjs ON dbo.tblEqpPlans.EqpPlanId = dbo.tblEqpProjs.EqpPlanId
						WHERE     (dbo.tblEqpProjs.Projection_Type_ID = 1)
						GROUP BY dbo.tblEquipment.SerialNumber, dbo.tblEquipment.ModelId
			) EqpMaxEndDate
		ON EqpMaxEndDate.SerialNumber = eqp.SerialNumber AND EqpMaxEndDate.ModelId = eqp.ModelId AND EPROJ.EndDate = EqpMaxEndDate.EndDate	
		LEFT JOIN tblCurrencies cur ON cur.Currency=ioac.Currency
		LEFT JOIN tblFinancialPeriods per ON per.CalenderPeriod=ioac.Calendar_Period
		LEFT JOIN COST_CENTRE cc ON ioac.Cost_Centre = cc.Cost_Centre_Code
		LEFT JOIN COST_EXPENSE ce ON ioac.Expense_Element = ce.Cost_Expense_Code
		LEFT JOIN OVERHEAD_COST_CATEGORIES oc ON oc.Overhead_Cost_Code=ioac.Overhead_Category  AND ISNULL(cc.Cost_Centre_ID,0) = ISNULL(oc.Cost_Centre_ID,0) AND ISNULL(ce.Cost_Expense_ID,0) = ISNULL(oc.Cost_Expense_ID,0)
		LEFT JOIN SYSTEM_SOURCE ss ON ss.System_Source_Code=ioac.System_Source
		LEFT JOIN OVERHEAD_ACTUAL_COST oac ON oac.Model=ioac.Model AND oac.SerialNumber=ioac.Serial_Number --oac.Equipment_Id=eqp.EquipmentId 
				AND oac.Calendar_Period_Id=per.FinancialPeriodID
				AND oac.Overhead_Category_Id=oc.Overhead_Category_Id 
				AND oac.Currency_Id=cur.CurrencyID
	WHERE oac.Cost_Id IS NULL

SET @nRecInserted=@@ROWCOUNT 

-- Fix the date range of all Overhead_Headers
EXEC OVERHEAD_FIX_DATE_RANGE_P
-- Add to OVERHEAD_DETAIL_xxx if we add the new Overhead_Cost_Category or changed the date range
EXEC OVERHEAD_DETAIL_FIX_P

FINISH:
IF @InterfaceSource=0 AND EXISTS(SELECT ImportFileName FROM IMPORT_ERROR WHERE ImportFileName=@ImportBatchName)
BEGIN
	DELETE IMPORT_ERROR WHERE ImportFileName=@ImportBatchName
END
	

IF EXISTS(SELECT MessageId FROM #z_Message)
BEGIN
	INSERT INTO IMPORT_ERROR(ImportFileName,Line_No,ErrorDescription,ImportErrorTypeId,LastModDate,ImportRecord,ImportSourceId)
	SELECT @ImportBatchName AS ImportFileName,CASE WHEN @InterfaceSource = 0 THEN Line_No END,ErrorDescription,
	ISNULL(ErrorType,@ErrBusinessRules) AS ImportErrorTypeId, 
	GETDATE() AS LastModDate,CONVERT(VARCHAR(MAX),ImportRecord),@InterfaceSource
	FROM #z_Message
END	
DROP TABLE #I_OVERHEAD_ACTUAL_COST
DROP TABLE #z_Message
GO


if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[AMT_DICTIONARY_UPDATE_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[AMT_DICTIONARY_UPDATE_P]
GO






CREATE     PROCEDURE  AMT_DICTIONARY_UPDATE_P
/******************************************************************************
	
	Name: AMT_DICTIONARY_UPDATE_P

	Called By: Amt.Data.PutDictionary

	Desc: saves the dictionary for a given language
             		returns LMD to save in registry

	Auth: Alex Lassauniere
	Date: 29/08/06
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	20/04/12    SD			4034 remove usage of "_" in English_Sentence and Other_Language_Sentence
	28/04/09	AL			CR8011: revamped for 8.3
	22/05/09	AL			CR8144: replaced @sentencesXML declaration to Ntext
*******************************************************************************/
	/* Param List */


	@otherLanguageID INT,
	@sentencesXML Ntext,
	@LastModDate varchar(50)='' OUTPUT,
	@newOnly bit=1

AS

Set Nocount On

DECLARE @hDoc int
DECLARE @Error int
DECLARE @lmd datetime

SET @Error=0
SET @lmd=getdate()

CREATE TABLE #DIC(English_Sentence varchar(max) COLLATE DATABASE_DEFAULT, 
				Other_Language_ID int, 
				Other_Language_Sentence nvarchar(max) COLLATE DATABASE_DEFAULT)

--DECLARE @r nvarchar(1),@n nvarchar(1),@t nvarchar(1)
--SET @r=CHAR(10)
--SET @n=CHAR(13)
--SET @t=CHAR(9)


EXEC sp_xml_preparedocument @hDoc OUTPUT, @sentencesXML 

INSERT INTO #DIC(English_Sentence, Other_Language_ID, Other_Language_Sentence)
--SELECT	REPLACE(REPLACE(REPLACE(REPLACE(English_Sentence,' ','_'),@r,'/r'),@n,'/n'),@t,'/t'), 
--		@otherLanguageID,
--		ISNULL(REPLACE(REPLACE(REPLACE(REPLACE(Other_Language_Sentence,' ','_'),@r,'/r'),@n,'/n'),@t,'/t'),'')
SELECT	
		English_Sentence,/*BUG 4034*/
		@otherLanguageID,
		ISNULL(Other_Language_Sentence,'')/*BUG 4034*/
FROM  OPENXML (@hdoc,'/Dictionary/Sentence',2)  
WITH #DIC


EXEC sp_xml_removedocument @hDoc

--check if duplicates and if so delete the ones that have not been translated yet
DELETE B
FROM
	(SELECT	English_Sentence,Other_Language_ID
	FROM	#DIC
	GROUP BY English_Sentence,Other_Language_ID
	HAVING COUNT(*)>1)A CROSS APPLY

	(SELECT TOP 1 * 
	FROM	#DIC
	WHERE 
			Other_Language_ID=A.Other_Language_ID
			AND English_Sentence=A.English_Sentence
			AND Other_Language_Sentence='')B


/* whole thing should be in a transaction*/
BEGIN TRAN UpdateDictionary

IF ISNULL(@newOnly,1)=0
BEGIN
	UPDATE AD
	SET	Other_Language_Sentence=D.Other_Language_Sentence,
		Last_Mod_Date=@lmd
	FROM
		AMT_DICTIONARY AD INNER JOIN
		#DIC D ON AD.Other_Language_ID=D.Other_Language_ID 
				AND AD.English_Sentence=D.English_Sentence
				AND AD.Other_Language_Sentence<>D.Other_Language_Sentence
END
ELSE
BEGIN
	INSERT INTO AMT_DICTIONARY(English_Sentence, Other_Language_ID, Other_Language_Sentence,Create_Date,Last_Mod_Date)
	SELECT D.English_Sentence, D.Other_Language_ID,D.Other_Language_Sentence,@lmd,@lmd
	FROM  
		#DIC D LEFT OUTER JOIN
		AMT_DICTIONARY AD  ON 
				AD.Other_Language_ID=D.Other_Language_ID 
				AND AD.English_Sentence=D.English_Sentence
	WHERE
		AD.English_Sentence IS NULL
END

DROP TABLE #DIC
	
SET @Error=@@ERROR
		
IF @Error=0
	SET @LastModDate=CONVERT(Varchar,@lmd,120)
ELSE
BEGIN
	ROLLBACK TRANSACTION 
	SET @LastModDate=''
	RETURN
END

COMMIT TRAN UpdateDictionary

GO

/****** Object:  StoredProcedure [dbo].[RPT_PARTS_DEMAND_ANALYSIS_P]    Script Date: 04/24/2012 15:00:06 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[RPT_PARTS_DEMAND_ANALYSIS_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[RPT_PARTS_DEMAND_ANALYSIS_P]
GO


/****** Object:  StoredProcedure [dbo].[RPT_PARTS_DEMAND_ANALYSIS_P]    Script Date: 04/24/2012 15:00:06 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE Procedure [dbo].[RPT_PARTS_DEMAND_ANALYSIS_P]
/******************************************************************************
	File: RPT_PARTS_DEMAND_ANALYSIS_P.sql
	Name: RPT_PARTS_DEMAND_ANALYSIS_P

	Called By: 

	Desc: 

	Auth: Alex Lassauniere
	Date: 01 Apr 2009
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	16 Apr 12   GD          E792 additional analyse by
	
	--OLD COMMENTS
	02/06/09	AL			CR8218: fixed @ProjHeaderID
	14/04/11	GD			Fixed Issue 1459
	17/06/11	GD			Fixed isue 1657
	19/08/11    GD          Fixed issue #2305
*******************************************************************************/
	/* Param List */
	@StartDate int = 200904,
	@EndDate int = 201003,

	@GroupBy varchar(MAX)='',
	@AnalyseBy varchar(MAX)='',
	@CalculationOption int=0,	--0: Eqp, 1: Dealer, 2: Factory

	@BranchId varchar(MAX)='',
	@SiteID varchar(MAX)='',
	@FleetID varchar(MAX)='',
	@EqpClassId varchar(MAX)='',
	@EqpGroupId varchar(MAX)='',
	@ManufacturerId varchar(MAX)='',
	@ModelID varchar(MAX)='',
	@EqpPlanID varchar(MAX)='',
	@RegionId varchar(MAX)='',
	@DivisionId varchar(MAX)='',
	@EqpCriticalityId varchar(MAX)='',
	@EqpLocationId varchar(MAX)='',
	@EqpCategoryId varchar(MAX)='',
	@EqpCostCentreID varchar(MAX)='',
	@CostResponsibilityID varchar(MAX)='',
	@ContractID varchar(MAX)='',
	@ContractTypeID varchar(MAX)='',
	@ProjHeaderID varchar(MAX)='',
	@ParentEquipmentID varchar(MAX)='',

	@CostTypeID varchar(MAX)='',
	@SystemID varchar(MAX)='',
	@SubSystemID varchar(MAX)='',
	@TaskHeaderId varchar(MAX)='',
	@TaskTypeID varchar(MAX)='',
	@ComponentCodeID varchar(MAX)='',
	@modifierID varchar(MAX)='',
	@CostBearerID varchar(MAX)='',
	@PartTypeID varchar(MAX)='',
	@PartManufacturerID varchar(MAX)='',
	@PrimaryPartNoID varchar(MAX)='',
    @SalesResponsibilityID varchar(MAX)='',
    
    --GD #1657
    @IsCrossTab BIT=0,
    @PartClassificationId Varchar(MAX) = ''  ,
	@PartRatingId Varchar(MAX) = ''  ,
	@PrimaryPartNumberId Varchar(MAX) = ''  ,
	@RebuildLocationId Varchar(MAX) = ''  ,
	@ReviewStatusId Varchar(MAX) = ''  ,
	@SalesStatusId Varchar(MAX) = '' 
AS  
  
--1: get tasks and group bys  
DECLARE @GroupBy1 varchar(10),@GroupBy2 varchar(10),@GroupBy3 varchar(10),@GroupBy4 varchar(10),@Pos int,@Temp varchar(10)  
  
--GD  added to fix fixed issue #1657  
DECLARE @SelectQueryForCrossTab VARCHAR(Max)  
DECLARE @OrderByCrossTab VARCHAR(Max)  
  
SET @SelectQueryForCrossTab=''  
SET @OrderByCrossTab =''  
  
  
WHILE @GroupBy<>''  
BEGIN  
 SET @Pos=CHARINDEX(',',@GroupBy)  
 IF ISNULL(@Pos,0)=0  
 BEGIN  
  SET @Temp=@GroupBy  
  SET @GroupBy=''  
 END  
 ELSE  
 BEGIN  
  SET @Temp=LEFT(@GroupBy,@Pos-1)  
  SET @GroupBy=RIGHT(@GroupBy,LEN(@GroupBy)-@Pos)  
 END  
   
 IF @GroupBy1 IS NULL  
  SET @GroupBy1=@Temp  
 ELSE IF @GroupBy2 IS NULL  
  SET @GroupBy2=@Temp  
 ELSE IF @GroupBy3 IS NULL  
  SET @GroupBy3=@Temp  
 ELSE   
  SET @GroupBy4=@Temp  
   
END  
  
--SELECT @GroupBy1,@GroupBy2,@GroupBy3,@GroupBy4  
  
CREATE TABLE #TASK (ProjTaskID int Primary Key,EqpPlanID int,  
 PctPurchasePart float,PctPurchaseNewPart float,  
 GroupByID1 int, GroupBy1 varchar(100) COLLATE database_default,  
 GroupByID2 int, GroupBy2 varchar(100) COLLATE database_default,  
 GroupByID3 int, GroupBy3 varchar(100) COLLATE database_default,  
 GroupByID4 int, GroupBy4 varchar(100) COLLATE database_default)  


  
 --Next Due records 
INSERT INTO #TASK(ProjTaskID,EqpPlanID,PctPurchasePart,PctPurchaseNewPart,  
    GroupByID1, GroupBy1,GroupByID2, GroupBy2,  
    GroupByID3, GroupBy3,GroupByID4, GroupBy4)  
  SELECT -PT.ProjTaskId,EH.EqpPlanID,PT.PctPurchasePart/100,PT.PctPurchaseNewPart/100,  
  CASE @GroupBy1  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id)  --Primary Part No  
   WHEN 'PPDS' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part number     
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp 
   WHEN 'PACL' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId, PT.PartClassificationId) --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,PT.DefaultLocationForRebuild) --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status
   ELSE NULL  
  END AS GroupByID1,  
  CASE @GroupBy1  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.Part WHEN ISNULL(PT.Part_Id,0)>0 THEN P.Part ELSE '[NONE]' END  --Primary Part No     
   WHEN 'PPDS' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.PartDescription WHEN ISNULL(PT.Part_Id,0)>0 THEN P.PartDescription ELSE '[NONE]' END --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp
   
   WHEN 'PACL' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId,0)>0 THEN NextDuePCL.PartClassification WHEN ISNULL(PT.PartClassificationId,0)>0 THEN PC.PartClassification ELSE '[NONE]' END  --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,0)>0 THEN NextDueRL.Site WHEN ISNULL(PT.DefaultLocationForRebuild,0)>0 THEN RL.Site ELSE '[NONE]' END -- Rebuild Location --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status  
   ELSE NULL  
  END AS GroupBy1,  
  CASE @GroupBy2  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part No  
   WHEN 'PPDS' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part Description  
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp
   WHEN 'PACL' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId, PT.PartClassificationId) --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,PT.DefaultLocationForRebuild) --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status
   ELSE NULL  
  END AS GroupByID2,  
  CASE @GroupBy2  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.Part WHEN ISNULL(PT.Part_Id,0)>0 THEN P.Part ELSE '[NONE]' END   WHEN 'PPDS' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.PartDescription WHEN ISNULL(PT.Part_Id,0)>0 THEN P.PartDescription ELSE '[NONE]' END --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp
  WHEN 'PACL' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId,0)>0 THEN NextDuePCL.PartClassification WHEN ISNULL(PT.PartClassificationId,0)>0 THEN PC.PartClassification ELSE '[NONE]' END    --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,0)>0 THEN NextDueRL.Site WHEN ISNULL(PT.DefaultLocationForRebuild,0)>0 THEN RL.Site ELSE '[NONE]' END -- Rebuild Location --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status  
   ELSE NULL  
  END AS GroupBy2,  
  CASE @GroupBy3  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part No  
   WHEN 'PPDS' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part Description  
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp
    WHEN 'PACL' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId, PT.PartClassificationId) --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,PT.DefaultLocationForRebuild) --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status
   ELSE NULL  
  END AS GroupByID3,  
  CASE @GroupBy3  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.Part WHEN ISNULL(PT.Part_Id,0)>0 THEN P.Part ELSE '[NONE]' END
   WHEN 'PPDS' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.PartDescription WHEN ISNULL(PT.Part_Id,0)>0 THEN P.PartDescription ELSE '[NONE]' END --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp
       WHEN 'PACL' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId,0)>0 THEN NextDuePCL.PartClassification WHEN ISNULL(PT.PartClassificationId,0)>0 THEN PC.PartClassification ELSE '[NONE]' END    --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,0)>0 THEN NextDueRL.Site WHEN ISNULL(PT.DefaultLocationForRebuild,0)>0 THEN RL.Site ELSE '[NONE]' END -- Rebuild Location --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status  
   ELSE NULL  
  END AS GroupBy3,  
  CASE @GroupBy4  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part No  
   WHEN 'PPDS' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part Description  
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp
    WHEN 'PACL' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId, PT.PartClassificationId) --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,PT.DefaultLocationForRebuild) --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status  
   ELSE NULL  
  END AS GroupByID4,  
  CASE @GroupBy4  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.Part WHEN ISNULL(PT.Part_Id,0)>0 THEN P.Part ELSE '[NONE]' END --Primary Part No  
   WHEN 'PPDS' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.PartDescription WHEN ISNULL(PT.Part_Id,0)>0 THEN P.PartDescription ELSE '[NONE]' END --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp  
      WHEN 'PACL' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId,0)>0 THEN NextDuePCL.PartClassification WHEN ISNULL(PT.PartClassificationId,0)>0 THEN PC.PartClassification ELSE '[NONE]' END    --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,0)>0 THEN NextDueRL.Site WHEN ISNULL(PT.DefaultLocationForRebuild,0)>0 THEN RL.Site ELSE '[NONE]' END -- Rebuild Location --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status  
   ELSE NULL  
  END AS GroupBy4  
  
FROM           
  tblProjTaskOpts AS PTO LEFT OUTER JOIN  
  tblProjTaskAmts AS PTA ON PTO.ProjTaskOptId = PTA.ProjTaskOptId RIGHT OUTER JOIN  
  EQUIPMENT_HIERARCHY_V AS EH INNER JOIN  
  tblProjTasks AS PT ON EH.EqpProjId = PT.EqpProjId INNER JOIN  
  TASK_HEADER AS TH ON PT.Task_Header_ID=TH.Task_Header_ID INNER JOIN  
  COMPONENT_HIERARCHY_V AS CH ON PT.ComponentCodeId = CH.ComponentCodeID INNER JOIN  
  tblTaskTypes AS TT ON PT.TaskTypeId = TT.TaskTypeID INNER JOIN  
  tblModifierCodes AS MC ON PT.ModifierId = MC.ModifierID ON PTO.ProjTaskId = PT.ProjTaskId LEFT OUTER JOIN  
  tblManufacturers AS M ON PT.ManufacturerId = M.ManufacturerId LEFT OUTER JOIN  
  tblPartTypes AS PTY INNER JOIN  
  tblParts AS P ON PTY.PartTypeId = P.Part_Type_ID ON PT.Part_Id = P.PartId LEFT OUTER JOIN  
  EMPLOYEE E ON E.Employee_ID=PT.SalesResponsibilityID  LEFT JOIN
  dbo.NEXT_OCC_STRATEGY ON PT.ProjTaskId = NEXT_OCC_STRATEGY.Proj_Task_Id LEFT JOIN
  PART_CLASSIFICATION PC ON PC.PartClassificationId = PT.PartClassificationId LEFT JOIN 
  dbo.PART_RATING PR ON PR.PartRatingId = PT.PartRatingId LEFT JOIN 
  dbo.REVIEW_STATUS RS ON RS.ReviewStatusID = PT.ReviewStatusID LEFT JOIN
  dbo.SALES_STATUS SS ON SS.SalesStatusId = dbo.NEXT_OCC_STRATEGY.SalesStatusId LEFT JOIN                      
  dbo.tblParts NextDueParts ON dbo.NEXT_OCC_STRATEGY.PEXPartId = NextDueParts.PartId LEFT JOIN  
  dbo.tblSites RL ON RL.SiteId = ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,PT.DefaultLocationForRebuild) LEFT JOIN
  dbo.PART_CLASSIFICATION NextDuePCL ON NEXT_OCC_STRATEGY.PEXPartTypeId = NextDuePCL.PartClassificationId LEFT JOIN
  dbo.tblSites NextDueRL ON NextDueRL.SiteId = NEXT_OCC_STRATEGY.PEXRebuildLocationId
  
WHERE       
  (EH.ProjHeaderId = @ProjHeaderID) --AL: 02/06/09  
  AND (PT.Unscheduled=0)  
  AND (EH.BranchId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@BranchId)) OR ISNULL(@BranchId,'')='')  
  AND (EH.SiteId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@SiteID)) OR ISNULL(@SiteID,'')='')  
  AND (EH.FleetId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@FleetID)) OR ISNULL(@FleetID,'')='')  
  AND (EH.Eqp_Class_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpClassId)) OR ISNULL(@EqpClassId,'')='')  
  AND (EH.Equipment_Group_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpGroupId)) OR ISNULL(@EqpGroupId,'')='')  
  AND (EH.ManufacturerId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@ManufacturerId)) OR ISNULL(@ManufacturerId,'')='')  
  AND (EH.ModelId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@ModelID)) OR ISNULL(@ModelID,'')='')  
  AND (EH.EqpPlanId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpPlanID)) OR ISNULL(@EqpPlanID,'')='')  
  AND (EH.Region_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@RegionId)) OR ISNULL(@RegionId,'')='')  
  AND (EH.Division_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@DivisionId)) OR ISNULL(@DivisionId,'')='')  
  AND (EH.Eqp_Criticality_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpCriticalityId)) OR ISNULL(@EqpCriticalityId,'')='')  
  AND (EH.Eqp_Location_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpLocationId)) OR ISNULL(@EqpLocationId,'')='')  
  AND (EH.Eqp_Category_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpCategoryId)) OR ISNULL(@EqpCategoryId,'')='')  
  AND (EH.Cost_Centre_ID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpCostCentreID)) OR ISNULL(@EqpCostCentreID,'')='')  
  AND (EH.Cost_Responsibility_ID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@CostResponsibilityID)) OR ISNULL(@CostResponsibilityID,'')='')  
  AND (EH.ContractId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@ContractID)) OR ISNULL(@ContractID,'')='')  
  AND (EH.ContractTypeID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@ContractTypeID)) OR ISNULL(@ContractTypeID,'')='')  
  
  AND (EH.EqpPlanID IN (SELECT EqpPlanID FROM dbo.EQP_SIBLINGS_F(@ParentEquipmentID)) OR ISNULL(@ParentEquipmentID,'')='')  
  
  AND (CH.CostTypeID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@CostTypeID)) OR ISNULL(@CostTypeID,'')='')  
  AND (CH.SystemID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@SystemID)) OR ISNULL(@SystemID,'')='')  
  AND (CH.SubSystemID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@SubSystemID)) OR ISNULL(@SubSystemID,'')='')  
  AND (PT.Task_Header_ID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@TaskHeaderId)) OR ISNULL(@TaskHeaderId,'')='')  
  AND (PT.TaskTypeId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@TaskTypeID)) OR ISNULL(@TaskTypeID,'')='')  
  AND (PT.ComponentCodeId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@ComponentCodeID)) OR ISNULL(@ComponentCodeID,'')='')  
  AND (PT.ModifierId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@modifierID)) OR ISNULL(@modifierID,'')='')  
  AND (PTA.Cost_Bearer_ID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@CostBearerID)) OR ISNULL(@CostBearerID,'')='')  
  AND (P.Part_Type_ID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PartTypeID)) OR ISNULL(@PartTypeID,'')='')  
  AND (PT.ManufacturerId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PartManufacturerID)) OR ISNULL(@PartManufacturerID,'')='')  
  AND (PT.Part_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PrimaryPartNoID)) OR ISNULL(@PrimaryPartNoID,'')='')  
  AND (PT.SalesResponsibilityID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@SalesResponsibilityID)) OR ISNULL(@SalesResponsibilityID,'')='')  
  AND (PR.PartRatingId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PartRatingId)) OR ISNULL(@PartRatingId,'')='')  
  AND (PT.Part_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PrimaryPartNumberId)) OR ISNULL(@PrimaryPartNumberId,'')='')
  AND (RL.SiteId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@RebuildLocationId)) OR ISNULL(@RebuildLocationId,'')='')
  AND (RS.ReviewStatusID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@ReviewStatusId)) OR ISNULL(@ReviewStatusId,'')='')
  AND (SS.SalesStatusId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@SalesStatusId)) OR ISNULL(@SalesStatusId,'')='')
  AND (PT.PartClassificationId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PartClassificationId)) OR ISNULL(@PartClassificationId,'')='')
  

GROUP BY  
  PT.ProjTaskId,EH.EqpPlanID,PT.PctPurchasePart,PT.PctPurchaseNewPart,  
  CASE @GroupBy1  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part No  
   WHEN 'PPDS' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part Description  
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp
   WHEN 'PACL' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId, PT.PartClassificationId) --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,PT.DefaultLocationForRebuild) --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status   
   ELSE NULL  
  END,  
  CASE @GroupBy1  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.Part WHEN ISNULL(PT.Part_Id,0)>0 THEN P.Part ELSE '[NONE]' END  --Primary Part No  
   WHEN 'PPDS' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.PartDescription WHEN ISNULL(PT.Part_Id,0)>0 THEN P.PartDescription ELSE '[NONE]' END --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp
   WHEN 'PACL' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId,0)>0 THEN NextDuePCL.PartClassification WHEN ISNULL(PT.PartClassificationId,0)>0 THEN PC.PartClassification ELSE '[NONE]' END    --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,0)>0 THEN NextDueRL.Site WHEN ISNULL(PT.DefaultLocationForRebuild,0)>0 THEN RL.Site ELSE '[NONE]' END -- Rebuild Location --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status   
   ELSE NULL  
  END,  
  CASE @GroupBy2  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part No  
   WHEN 'PPDS' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part Description  
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp
   WHEN 'PACL' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId, PT.PartClassificationId) --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,PT.DefaultLocationForRebuild) --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status    
   ELSE NULL  
  END,  
  CASE @GroupBy2  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.Part WHEN ISNULL(PT.Part_Id,0)>0 THEN P.Part ELSE '[NONE]' END  --Primary Part No  
   WHEN 'PPDS' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.PartDescription WHEN ISNULL(PT.Part_Id,0)>0 THEN P.PartDescription ELSE '[NONE]' END --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp
   WHEN 'PACL' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId,0)>0 THEN NextDuePCL.PartClassification WHEN ISNULL(PT.PartClassificationId,0)>0 THEN PC.PartClassification ELSE '[NONE]' END    --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,0)>0 THEN NextDueRL.Site WHEN ISNULL(PT.DefaultLocationForRebuild,0)>0 THEN RL.Site ELSE '[NONE]' END -- Rebuild Location --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status  
   ELSE NULL  
  END,  
  CASE @GroupBy3  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part No  
   WHEN 'PPDS' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part Description  
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp
   WHEN 'PACL' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId, PT.PartClassificationId) --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,PT.DefaultLocationForRebuild) --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status    
   ELSE NULL  
  END,  
  CASE @GroupBy3  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.Part WHEN ISNULL(PT.Part_Id,0)>0 THEN P.Part ELSE '[NONE]' END  --Primary Part No  
   WHEN 'PPDS' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.PartDescription WHEN ISNULL(PT.Part_Id,0)>0 THEN P.PartDescription ELSE '[NONE]' END --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp
   WHEN 'PACL' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId,0)>0 THEN NextDuePCL.PartClassification WHEN ISNULL(PT.PartClassificationId,0)>0 THEN PC.PartClassification ELSE '[NONE]' END    --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,0)>0 THEN NextDueRL.Site WHEN ISNULL(PT.DefaultLocationForRebuild,0)>0 THEN RL.Site ELSE '[NONE]' END -- Rebuild Location --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status  
   ELSE NULL  
  END,  
  CASE @GroupBy4  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part No  
   WHEN 'PPDS' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part Description  
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp
   WHEN 'PACL' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId, PT.PartClassificationId) --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,PT.DefaultLocationForRebuild) --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status    
   ELSE NULL  
  END,  
  CASE @GroupBy4  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.Part WHEN ISNULL(PT.Part_Id,0)>0 THEN P.Part ELSE '[NONE]' END  --Primary Part No  
   WHEN 'PPDS' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.PartDescription WHEN ISNULL(PT.Part_Id,0)>0 THEN P.PartDescription ELSE '[NONE]' END --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp
   WHEN 'PACL' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId,0)>0 THEN NextDuePCL.PartClassification WHEN ISNULL(PT.PartClassificationId,0)>0 THEN PC.PartClassification ELSE '[NONE]' END    --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,0)>0 THEN NextDueRL.Site WHEN ISNULL(PT.DefaultLocationForRebuild,0)>0 THEN RL.Site ELSE '[NONE]' END -- Rebuild Location --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status  
    
   ELSE NULL  
  END  
  

--rest of the record  



INSERT INTO #TASK(ProjTaskID,EqpPlanID,PctPurchasePart,PctPurchaseNewPart,  
    GroupByID1, GroupBy1,GroupByID2, GroupBy2,  
    GroupByID3, GroupBy3,GroupByID4, GroupBy4)  
  SELECT PT.ProjTaskId,EH.EqpPlanID,PT.PctPurchasePart/100,PT.PctPurchaseNewPart/100,  
  CASE @GroupBy1  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN PT.Part_Id --Primary Part No  
   WHEN 'PPDS' THEN PT.Part_Id --Primary Part Description     
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp 
   WHEN 'PACL' THEN PC.PartClassificationId --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN PT.DefaultLocationForRebuild --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status
   ELSE NULL  
  END AS GroupByID1,  
  CASE @GroupBy1  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN P.Part --Primary Part No  
   WHEN 'PPDS' THEN P.PartDescription --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp
   WHEN 'PACL' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PC.PartClassification,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]')  --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RL.Site,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status  
   ELSE NULL  
  END AS GroupBy1,  
  CASE @GroupBy2  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN PT.Part_Id --Primary Part No  
   WHEN 'PPDS' THEN PT.Part_Id --Primary Part Description  
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp
   WHEN 'PACL' THEN PC.PartClassificationId --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN PT.DefaultLocationForRebuild --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status
   ELSE NULL  
  END AS GroupByID2,  
  CASE @GroupBy2  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN P.Part  --Primary Part No  
   WHEN 'PPDS' THEN P.PartDescription --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp
   WHEN 'PACL' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PC.PartClassification,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]')  --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RL.Site,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status  
   ELSE NULL  
  END AS GroupBy2,  
  CASE @GroupBy3  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN PT.Part_Id --Primary Part No  
   WHEN 'PPDS' THEN PT.Part_Id --Primary Part Description  
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp
   WHEN 'PACL' THEN PC.PartClassificationId --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN PT.DefaultLocationForRebuild --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status
   ELSE NULL  
  END AS GroupByID3,  
  CASE @GroupBy3  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN P.Part --Primary Part No  
   WHEN 'PPDS' THEN P.PartDescription --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp
    WHEN 'PACL' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PC.PartClassification,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]')  --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RL.Site,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status  
   ELSE NULL  
  END AS GroupBy3,  
  CASE @GroupBy4  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN PT.Part_Id --Primary Part No  
   WHEN 'PPDS' THEN PT.Part_Id --Primary Part Description  
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp
    WHEN 'PACL' THEN PC.PartClassificationId --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN PT.DefaultLocationForRebuild --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status  
   ELSE NULL  
  END AS GroupByID4,  
  CASE @GroupBy4  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN P.Part --Primary Part No  
   WHEN 'PPDS' THEN P.PartDescription --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp  
    WHEN 'PACL' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PC.PartClassification,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]')  --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RL.Site,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status  
   ELSE NULL  
  END AS GroupBy4  
  
FROM           
  tblProjTaskOpts AS PTO LEFT OUTER JOIN  
  tblProjTaskAmts AS PTA ON PTO.ProjTaskOptId = PTA.ProjTaskOptId RIGHT OUTER JOIN  
  EQUIPMENT_HIERARCHY_V AS EH INNER JOIN  
  tblProjTasks AS PT ON EH.EqpProjId = PT.EqpProjId INNER JOIN  
  TASK_HEADER AS TH ON PT.Task_Header_ID=TH.Task_Header_ID INNER JOIN  
  COMPONENT_HIERARCHY_V AS CH ON PT.ComponentCodeId = CH.ComponentCodeID INNER JOIN  
  tblTaskTypes AS TT ON PT.TaskTypeId = TT.TaskTypeID INNER JOIN  
  tblModifierCodes AS MC ON PT.ModifierId = MC.ModifierID ON PTO.ProjTaskId = PT.ProjTaskId LEFT OUTER JOIN  
  tblManufacturers AS M ON PT.ManufacturerId = M.ManufacturerId LEFT OUTER JOIN  
  tblPartTypes AS PTY INNER JOIN  
  tblParts AS P ON PTY.PartTypeId = P.Part_Type_ID ON PT.Part_Id = P.PartId LEFT OUTER JOIN  
  EMPLOYEE E ON E.Employee_ID=PT.SalesResponsibilityID  LEFT JOIN
  dbo.NEXT_OCC_STRATEGY ON PT.ProjTaskId = NEXT_OCC_STRATEGY.Proj_Task_Id LEFT JOIN
  PART_CLASSIFICATION PC ON PC.PartClassificationId = PT.PartClassificationId LEFT JOIN 
  dbo.PART_RATING PR ON PR.PartRatingId = PT.PartRatingId LEFT JOIN 
  dbo.REVIEW_STATUS RS ON RS.ReviewStatusID = PT.ReviewStatusID LEFT JOIN
  dbo.SALES_STATUS SS ON SS.SalesStatusId = dbo.NEXT_OCC_STRATEGY.SalesStatusId LEFT JOIN                      
  dbo.tblParts NextDueParts ON dbo.NEXT_OCC_STRATEGY.PEXPartId = NextDueParts.PartId LEFT JOIN  
  dbo.tblSites RL ON RL.SiteId = PT.DefaultLocationForRebuild
WHERE       
  (EH.ProjHeaderId = @ProjHeaderID) --AL: 02/06/09  
  AND (PT.Unscheduled=0)  
  AND (EH.BranchId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@BranchId)) OR ISNULL(@BranchId,'')='')  
  AND (EH.SiteId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@SiteID)) OR ISNULL(@SiteID,'')='')  
  AND (EH.FleetId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@FleetID)) OR ISNULL(@FleetID,'')='')  
  AND (EH.Eqp_Class_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpClassId)) OR ISNULL(@EqpClassId,'')='')  
  AND (EH.Equipment_Group_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpGroupId)) OR ISNULL(@EqpGroupId,'')='')  
  AND (EH.ManufacturerId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@ManufacturerId)) OR ISNULL(@ManufacturerId,'')='')  
  AND (EH.ModelId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@ModelID)) OR ISNULL(@ModelID,'')='')  
  AND (EH.EqpPlanId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpPlanID)) OR ISNULL(@EqpPlanID,'')='')  
  AND (EH.Region_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@RegionId)) OR ISNULL(@RegionId,'')='')  
  AND (EH.Division_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@DivisionId)) OR ISNULL(@DivisionId,'')='')  
  AND (EH.Eqp_Criticality_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpCriticalityId)) OR ISNULL(@EqpCriticalityId,'')='')  
  AND (EH.Eqp_Location_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpLocationId)) OR ISNULL(@EqpLocationId,'')='')  
  AND (EH.Eqp_Category_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpCategoryId)) OR ISNULL(@EqpCategoryId,'')='')  
  AND (EH.Cost_Centre_ID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpCostCentreID)) OR ISNULL(@EqpCostCentreID,'')='')  
  AND (EH.Cost_Responsibility_ID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@CostResponsibilityID)) OR ISNULL(@CostResponsibilityID,'')='')  
  AND (EH.ContractId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@ContractID)) OR ISNULL(@ContractID,'')='')  
  AND (EH.ContractTypeID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@ContractTypeID)) OR ISNULL(@ContractTypeID,'')='')  
  
  AND (EH.EqpPlanID IN (SELECT EqpPlanID FROM dbo.EQP_SIBLINGS_F(@ParentEquipmentID)) OR ISNULL(@ParentEquipmentID,'')='')  
  
  AND (CH.CostTypeID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@CostTypeID)) OR ISNULL(@CostTypeID,'')='')  
  AND (CH.SystemID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@SystemID)) OR ISNULL(@SystemID,'')='')  
  AND (CH.SubSystemID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@SubSystemID)) OR ISNULL(@SubSystemID,'')='')  
  AND (PT.Task_Header_ID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@TaskHeaderId)) OR ISNULL(@TaskHeaderId,'')='')  
  AND (PT.TaskTypeId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@TaskTypeID)) OR ISNULL(@TaskTypeID,'')='')  
  AND (PT.ComponentCodeId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@ComponentCodeID)) OR ISNULL(@ComponentCodeID,'')='')  
  AND (PT.ModifierId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@modifierID)) OR ISNULL(@modifierID,'')='')  
  AND (PTA.Cost_Bearer_ID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@CostBearerID)) OR ISNULL(@CostBearerID,'')='')  
  AND (P.Part_Type_ID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PartTypeID)) OR ISNULL(@PartTypeID,'')='')  
  AND (PT.ManufacturerId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PartManufacturerID)) OR ISNULL(@PartManufacturerID,'')='')  
  AND (PT.Part_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PrimaryPartNoID)) OR ISNULL(@PrimaryPartNoID,'')='')  
  AND (PT.SalesResponsibilityID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@SalesResponsibilityID)) OR ISNULL(@SalesResponsibilityID,'')='')  
  AND (PR.PartRatingId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PartRatingId)) OR ISNULL(@PartRatingId,'')='')  
  AND (PT.Part_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PrimaryPartNumberId)) OR ISNULL(@PrimaryPartNumberId,'')='')
  AND (RL.SiteId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@RebuildLocationId)) OR ISNULL(@RebuildLocationId,'')='')
  AND (RS.ReviewStatusID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@ReviewStatusId)) OR ISNULL(@ReviewStatusId,'')='')
  AND (SS.SalesStatusId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@SalesStatusId)) OR ISNULL(@SalesStatusId,'')='')
  AND (PT.PartClassificationId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PartClassificationId)) OR ISNULL(@PartClassificationId,'')='')
  
GROUP BY  
  PT.ProjTaskId,EH.EqpPlanID,PT.PctPurchasePart,PT.PctPurchaseNewPart,  
  CASE @GroupBy1  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN PT.Part_Id --Primary Part No  
   WHEN 'PPDS' THEN PT.Part_Id --Primary Part Description  
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp
   WHEN 'PACL' THEN PC.PartClassificationId --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN PT.DefaultLocationForRebuild --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status   
   ELSE NULL  
  END,  
  CASE @GroupBy1  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN P.Part  --Primary Part No  
   WHEN 'PPDS' THEN P.PartDescription --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp
   WHEN 'PACL' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PC.PartClassification,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]')  --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RL.Site,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status   
   ELSE NULL  
  END,  
  CASE @GroupBy2  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN PT.Part_Id --Primary Part No  
   WHEN 'PPDS' THEN PT.Part_Id --Primary Part Description  
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp
   WHEN 'PACL' THEN PC.PartClassificationId --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN PT.DefaultLocationForRebuild --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status    
   ELSE NULL  
  END,  
  CASE @GroupBy2  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN P.Part  --Primary Part No  
   WHEN 'PPDS' THEN P.PartDescription --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp
   WHEN 'PACL' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PC.PartClassification,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]')  --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RL.Site,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status  
   ELSE NULL  
  END,  
  CASE @GroupBy3  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN PT.Part_Id --Primary Part No  
   WHEN 'PPDS' THEN PT.Part_Id --Primary Part Description  
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp
   WHEN 'PACL' THEN PC.PartClassificationId --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN PT.DefaultLocationForRebuild --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status    
   ELSE NULL  
  END,  
  CASE @GroupBy3  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN P.Part  --Primary Part No  
   WHEN 'PPDS' THEN P.PartDescription --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp
   WHEN 'PACL' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PC.PartClassification,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]')  --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RL.Site,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status  
   ELSE NULL  
  END,  
  CASE @GroupBy4  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN PT.Part_Id --Primary Part No  
   WHEN 'PPDS' THEN PT.Part_Id --Primary Part Description  
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp
   WHEN 'PACL' THEN PC.PartClassificationId --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN PT.DefaultLocationForRebuild --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status    
   ELSE NULL  
  END,  
  CASE @GroupBy4  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN P.Part  --Primary Part No  
   WHEN 'PPDS' THEN P.PartDescription --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp
   WHEN 'PACL' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PC.PartClassification,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]')  --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RL.Site,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status  
    
   ELSE NULL  
  END  

IF @GroupBy1='PEQP' OR @GroupBy2='PEQP' OR @GroupBy3='PEQP' OR @GroupBy4='PEQP'  
BEGIN  
 --get parent Eqps for each eqp  
 --a: get IDs  
 CREATE TABLE #EQP  
 (  
  EqpPlanID int primary key,  
  ParentEqpPlanID int   
 )  
 CREATE NONCLUSTERED INDEX [IX_STRATEGY_TEMP] ON [#EQP] (EqpPlanID ASC,ParentEqpPlanID ASC)  
  
 INSERT INTO #EQP(EqpPlanID,ParentEqpPlanID)  
 SELECT EqpPlanId,NULL   
 FROM #TASK  
 GROUP BY EqpPlanId  
  
 DECLARE @selection varchar(max)  
 SET @selection= REPLACE(REPLACE((select DISTINCT EqpPlanId from #EQP for xml raw),'<row eqpplanid="',''),'"/>',',')  
  
 UPDATE #EQP   
 SET ParentEqpPlanID = dbo.GET_TOPMOST_PARENT_EQUIPMENT_F(EqpPlanId,@selection)     
  
 --b: get names and update #tasks  
 UPDATE T   
 SET  GroupByID1 = CASE @GroupBy1 WHEN 'PEQP' THEN E.ParentEqpPlanID ELSE GroupByID1 END,  
   GroupBy1 = CASE @GroupBy1 WHEN 'PEQP' THEN EP.EqpPlan ELSE GroupBy1 END,   
   GroupByID2 = CASE @GroupBy2 WHEN 'PEQP' THEN E.ParentEqpPlanID ELSE GroupByID2 END,  
   GroupBy2 = CASE @GroupBy2 WHEN 'PEQP' THEN EP.EqpPlan ELSE GroupBy2 END,   
   GroupByID3 = CASE @GroupBy3 WHEN 'PEQP' THEN E.ParentEqpPlanID ELSE GroupByID3 END,  
   GroupBy3 = CASE @GroupBy3 WHEN 'PEQP' THEN EP.EqpPlan ELSE GroupBy3 END,   
   GroupByID4 = CASE @GroupBy4 WHEN 'PEQP' THEN E.ParentEqpPlanID ELSE GroupByID4 END,  
   GroupBy4 = CASE @GroupBy4 WHEN 'PEQP' THEN EP.EqpPlan ELSE GroupBy4 END  
 FROM   
   #TASK T INNER JOIN  
   #EQP E ON T.EqpPlanID=E.EqpPlanID INNER JOIN  
   tblEqpPlans EP ON E.ParentEqpPlanID=EP.EqpPlanID  
  
 DROP TABLE #EQP  
END  
  
--Debug  
--SELECT * FROM #TASK  
  
--2: get tasks occs in period  
CREATE TABLE #OCC(ProjtaskID int,Period int,Occs int  
 PRIMARY KEY(ProjtaskID,Period) )  
  
INSERT INTO #OCC(ProjtaskID,Period,Occs)    
SELECT ProjtaskID,OccDate,SUM(Occs) AS Occs   
FROM    
 (  
 SELECT PTO.ProjtaskID  AS ProjtaskID , OccDate ,Count(*) AS Occs
 FROM    
   #TASK T INNER JOIN    
   ( 
     SELECT -PT.ProjTaskId AS ProjTaskId, YEAR(OccDate)*100+MONTH(OccDate) AS OccDate   FROM tblProjTasks PT INNER JOIN  
    (SELECT ProjTaskId, MIN(OccDate) AS OccDate  FROM tblProjTaskOccs
	GROUP BY tblProjTaskOccs.ProjTaskId) TEMP ON PT.ProjTaskId = TEMP.ProjTaskId 
	AND  PT.NextOccDate = TEMP.OccDate  
 
   )   
   PTO ON T.ProjtaskID=PTO.ProjtaskID   
 WHERE    
   (PTO.OccDate BETWEEN @StartDate AND @EndDate)  
      
 GROUP BY     
   PTO.ProjtaskID,PTO.OccDate  
    
 UNION ALL    
   
  
 --Fill in missing periods    
 SELECT T.ProjtaskID,FP.CalenderPeriod,0    
 FROM    
   #TASK T CROSS JOIN    
   tblFinancialPeriods FP    
 WHERE    
   FP.CalenderPeriod BETWEEN @StartDate AND @EndDate AND T.ProjTaskID>0  
    
  UNION ALL  
    
   SELECT  PTO.ProjtaskID,PTO.OccDate,Count(*) AS Occs  
  FROM    
   #TASK T INNER JOIN    
   (
   SELECT tblProjTaskOccs.ProjtaskID,YEAR(OccDate)*100+MONTH(OccDate) AS OccDate FROM tblProjTaskOccs  
   INNER JOIN  
   tblProjTasks PT ON PT.ProjTaskId = tblProjTaskOccs.ProjTaskId  
   WHERE PT.NextOccDate < tblProjTaskOccs.OccDate  
   ) PTO ON T.ProjtaskID=PTO.ProjtaskID    
 WHERE    
   PTO.OccDate BETWEEN @StartDate AND @EndDate    
 GROUP BY     
    PTO.ProjtaskID,PTO.OccDate   
 )A    
GROUP BY ProjtaskID,OccDate    
  
--Debug  
--SELECT * FROM #OCC  
  
  
--GD 1657 give cross tab results  
IF (@IsCrossTab = 'TRUE')  
BEGIN  
  
 --Set Column name in select query,No need to check if null as group by is mandatory so there must be at least 1 group by.  
 SELECT @SelectQueryForCrossTab = @SelectQueryForCrossTab + 'GroupBy1 AS ' +  
  CASE @GroupBy1  
   WHEN 'BRAN' THEN 'Branch'  
   WHEN 'SITE' THEN 'Site'  
   WHEN 'FLEE' THEN 'Fleet'  
   WHEN 'ECLS' THEN '''Equipment Class'''  
   WHEN 'EGRP' THEN '''Equipment Group'''  
   WHEN 'MANU' THEN 'Manufacturer'  
   WHEN 'MODL' THEN 'Model'  
   WHEN 'EQPL' THEN 'Equipment'  
   WHEN 'REGN' THEN 'Region'  
   WHEN 'DEVI' THEN 'Division'  
   WHEN 'CRIT' THEN '''Equipment Criticality'''  
   WHEN 'LCTN' THEN '''Equipment Location'''  
   WHEN 'CTGR' THEN '''Equipment Category'''  
   WHEN 'ECCT' THEN '''Equipment Cost Centre'''  
   WHEN 'CRSP' THEN 'Responsibility'  
   WHEN 'CNTT' THEN '''Contract Type'''  
   WHEN 'CONT' THEN 'Contract'  
   WHEN 'PEQP' THEN '''Parent Equipment'''  
   WHEN 'CTTY' THEN '''Cost Type'''  
   WHEN 'SYST' THEN 'System'  
   WHEN 'SUBS' THEN 'Sub System'  
   WHEN 'PRTA' THEN '''Strategy Task'''  
   WHEN 'EVTT' THEN '''Task Type'''  
   WHEN 'EVCC' THEN '''Component Code'''  
   WHEN 'MDCO' THEN '''Modifier Code'''  
   WHEN 'PRTY' THEN '''Part Type'''  
   WHEN 'PMAN' THEN '''Part Manufacturer'''  
   WHEN 'PART' THEN '''Primary Part No'''  
   WHEN 'PPDS' THEN '''Primary Part Description'''  
   WHEN 'SARP' THEN '''Sales Resp'''
   WHEN 'PACL' THEN '''Part Classification'''
   WHEN 'PARA' THEN '''Part Rating'''
   WHEN 'RELO' THEN '''Rebuild Location'''
   WHEN 'REST' THEN '''Review Status'''
   WHEN 'SAST' THEN '''Sales Status'''
  ELSE NULL  
 END   
IF( @GroupBy2 != NULL)  
 BEGIN  
  SELECT @SelectQueryForCrossTab = @SelectQueryForCrossTab + ', GroupBy2 AS ' +  
  CASE @GroupBy2  
   WHEN 'BRAN' THEN 'Branch'  
   WHEN 'SITE' THEN 'Site'  
   WHEN 'FLEE' THEN 'Fleet'  
   WHEN 'ECLS' THEN '''Equipment Class'''  
   WHEN 'EGRP' THEN '''Equipment Group'''  
   WHEN 'MANU' THEN 'Manufacturer'  
   WHEN 'MODL' THEN 'Model'  
   WHEN 'EQPL' THEN 'Equipment'  
   WHEN 'REGN' THEN 'Region'  
   WHEN 'DEVI' THEN 'Division'  
   WHEN 'CRIT' THEN '''Equipment Criticality'''  
   WHEN 'LCTN' THEN '''Equipment Location'''  
   WHEN 'CTGR' THEN '''Equipment Category'''  
   WHEN 'ECCT' THEN '''Equipment Cost Centre'''  
   WHEN 'CRSP' THEN 'Responsibility'  
   WHEN 'CNTT' THEN '''Contract Type'''  
   WHEN 'CONT' THEN 'Contract'  
   WHEN 'PEQP' THEN '''Parent Equipment'''  
   WHEN 'CTTY' THEN '''Cost Type'''  
   WHEN 'SYST' THEN 'System'  
   WHEN 'SUBS' THEN 'Sub System'  
   WHEN 'PRTA' THEN '''Strategy Task'''  
   WHEN 'EVTT' THEN '''Task Type'''  
   WHEN 'EVCC' THEN '''Component Code'''  
   WHEN 'MDCO' THEN '''Modifier Code'''  
   WHEN 'PRTY' THEN '''Part Type'''  
   WHEN 'PMAN' THEN '''Part Manufacturer'''  
   WHEN 'PART' THEN '''Primary Part No'''  
   WHEN 'PPDS' THEN '''Primary Part Description'''  
   WHEN 'SARP' THEN '''Sales Resp'''
   WHEN 'PACL' THEN '''Part Classification'''
   WHEN 'PARA' THEN '''Part Rating'''
   WHEN 'RELO' THEN '''Rebuild Location'''
   WHEN 'REST' THEN '''Review Status'''
   WHEN 'SAST' THEN '''Sales Status''' 
   ELSE NULL  
  END  
 END   
IF( @GroupBy3 != NULL )  
 BEGIN  
  SELECT @SelectQueryForCrossTab = @SelectQueryForCrossTab + ', GroupBy3 AS ' +  
  CASE @GroupBy3  
   WHEN 'BRAN' THEN 'Branch'  
   WHEN 'SITE' THEN 'Site'  
   WHEN 'FLEE' THEN 'Fleet'  
   WHEN 'ECLS' THEN '''Equipment Class'''  
   WHEN 'EGRP' THEN '''Equipment Group'''  
   WHEN 'MANU' THEN 'Manufacturer'  
   WHEN 'MODL' THEN 'Model'  
   WHEN 'EQPL' THEN 'Equipment'  
   WHEN 'REGN' THEN 'Region'  
   WHEN 'DEVI' THEN 'Division'  
   WHEN 'CRIT' THEN '''Equipment Criticality'''  
   WHEN 'LCTN' THEN '''Equipment Location'''  
   WHEN 'CTGR' THEN '''Equipment Category'''  
   WHEN 'ECCT' THEN '''Equipment Cost Centre'''  
   WHEN 'CRSP' THEN 'Responsibility'  
   WHEN 'CNTT' THEN '''Contract Type'''  
   WHEN 'CONT' THEN 'Contract'  
   WHEN 'PEQP' THEN '''Parent Equipment'''  
   WHEN 'CTTY' THEN '''Cost Type'''  
   WHEN 'SYST' THEN 'System'  
   WHEN 'SUBS' THEN 'Sub System'  
   WHEN 'PRTA' THEN '''Strategy Task'''  
   WHEN 'EVTT' THEN '''Task Type'''  
   WHEN 'EVCC' THEN '''Component Code'''  
   WHEN 'MDCO' THEN '''Modifier Code'''  
   WHEN 'PRTY' THEN '''Part Type'''  
   WHEN 'PMAN' THEN '''Part Manufacturer'''  
   WHEN 'PART' THEN '''Primary Part No'''  
   WHEN 'PPDS' THEN '''Primary Part Description'''  
   WHEN 'SARP' THEN '''Sales Resp'''
   WHEN 'PACL' THEN '''Part Classification'''
   WHEN 'PARA' THEN '''Part Rating'''
   WHEN 'RELO' THEN '''Rebuild Location'''
   WHEN 'REST' THEN '''Review Status'''
   WHEN 'SAST' THEN '''Sales Status''' 
  ELSE NULL  
  END  
END  
IF( @GroupBy4 != NULL)  
 BEGIN  
  SELECT @SelectQueryForCrossTab = @SelectQueryForCrossTab + ', GroupBy4 AS ' +  
  CASE @GroupBy4  
   WHEN 'BRAN' THEN 'Branch'  
   WHEN 'SITE' THEN 'Site'  
   WHEN 'FLEE' THEN 'Fleet'  
   WHEN 'ECLS' THEN '''Equipment Class'''  
   WHEN 'EGRP' THEN '''Equipment Group'''  
   WHEN 'MANU' THEN 'Manufacturer'  
   WHEN 'MODL' THEN 'Model'  
   WHEN 'EQPL' THEN 'Equipment'  
   WHEN 'REGN' THEN 'Region'  
   WHEN 'DEVI' THEN 'Division'  
   WHEN 'CRIT' THEN '''Equipment Criticality'''  
   WHEN 'LCTN' THEN '''Equipment Location'''  
   WHEN 'CTGR' THEN '''Equipment Category'''  
   WHEN 'ECCT' THEN '''Equipment Cost Centre'''  
   WHEN 'CRSP' THEN 'Responsibility'  
   WHEN 'CNTT' THEN '''Contract Type'''  
   WHEN 'CONT' THEN 'Contract'  
   WHEN 'PEQP' THEN '''Parent Equipment'''  
   WHEN 'CTTY' THEN '''Cost Type'''  
   WHEN 'SYST' THEN 'System'  
   WHEN 'SUBS' THEN 'Sub System'  
   WHEN 'PRTA' THEN '''Strategy Task'''  
   WHEN 'EVTT' THEN '''Task Type'''  
   WHEN 'EVCC' THEN '''Component Code'''  
   WHEN 'MDCO' THEN '''Modifier Code'''  
   WHEN 'PRTY' THEN '''Part Type'''  
   WHEN 'PMAN' THEN '''Part Manufacturer'''  
   WHEN 'PART' THEN '''Primary Part No'''  
   WHEN 'PPDS' THEN '''Primary Part Description'''  
   WHEN 'SARP' THEN '''Sales Resp'''
   WHEN 'PACL' THEN '''Part Classification'''
   WHEN 'PARA' THEN '''Part Rating'''
   WHEN 'RELO' THEN '''Rebuild Location'''
   WHEN 'REST' THEN '''Review Status'''
   WHEN 'SAST' THEN '''Sales Status'''  
  ELSE NULL  
 END  
END  
   
--Set Column name in order by query  
SELECT @OrderByCrossTab = @OrderByCrossTab +  
  CASE @GroupBy1  
   WHEN 'BRAN' THEN 'Branch'  
   WHEN 'SITE' THEN 'Site'  
   WHEN 'FLEE' THEN 'Fleet'  
   WHEN 'ECLS' THEN '''Equipment Class'''  
   WHEN 'EGRP' THEN '''Equipment Group'''  
   WHEN 'MANU' THEN 'Manufacturer'  
   WHEN 'MODL' THEN 'Model'  
   WHEN 'EQPL' THEN 'Equipment'  
   WHEN 'REGN' THEN 'Region'  
   WHEN 'DEVI' THEN 'Division'  
   WHEN 'CRIT' THEN '''Equipment Criticality'''  
   WHEN 'LCTN' THEN '''Equipment Location'''  
   WHEN 'CTGR' THEN '''Equipment Category'''  
   WHEN 'ECCT' THEN '''Equipment Cost Centre'''  
   WHEN 'CRSP' THEN 'Responsibility'  
   WHEN 'CNTT' THEN '''Contract Type'''  
   WHEN 'CONT' THEN 'Contract'  
   WHEN 'PEQP' THEN '''Parent Equipment'''  
   WHEN 'CTTY' THEN '''Cost Type'''  
   WHEN 'SYST' THEN 'System'  
   WHEN 'SUBS' THEN 'Sub System'  
   WHEN 'PRTA' THEN '''Strategy Task'''  
   WHEN 'EVTT' THEN '''Task Type'''  
   WHEN 'EVCC' THEN '''Component Code'''  
   WHEN 'MDCO' THEN '''Modifier Code'''  
   WHEN 'PRTY' THEN '''Part Type'''  
   WHEN 'PMAN' THEN '''Part Manufacturer'''  
   WHEN 'PART' THEN '''Primary Part No'''  
   WHEN 'PPDS' THEN '''Primary Part Description'''  
   WHEN 'SARP' THEN '''Sales Resp'''
   WHEN 'PACL' THEN '''Part Classification'''
   WHEN 'PARA' THEN '''Part Rating'''
   WHEN 'RELO' THEN '''Rebuild Location'''
   WHEN 'REST' THEN '''Review Status'''
   WHEN 'SAST' THEN '''Sales Status'''  
  ELSE NULL  
 END   
IF( @GroupBy2! = NULL )  
 BEGIN  
  SELECT @OrderByCrossTab = @OrderByCrossTab + ',' +  
  CASE @GroupBy2  
   WHEN 'BRAN' THEN 'Branch'  
   WHEN 'SITE' THEN 'Site'  
   WHEN 'FLEE' THEN 'Fleet'  
   WHEN 'ECLS' THEN '''Equipment Class'''  
   WHEN 'EGRP' THEN '''Equipment Group'''  
   WHEN 'MANU' THEN 'Manufacturer'  
   WHEN 'MODL' THEN 'Model'  
   WHEN 'EQPL' THEN 'Equipment'  
   WHEN 'REGN' THEN 'Region'  
   WHEN 'DEVI' THEN 'Division'  
   WHEN 'CRIT' THEN '''Equipment Criticality'''  
   WHEN 'LCTN' THEN '''Equipment Location'''  
   WHEN 'CTGR' THEN '''Equipment Category'''  
   WHEN 'ECCT' THEN '''Equipment Cost Centre'''  
   WHEN 'CRSP' THEN 'Responsibility'  
   WHEN 'CNTT' THEN '''Contract Type'''  
   WHEN 'CONT' THEN 'Contract'  
   WHEN 'PEQP' THEN '''Parent Equipment'''  
   WHEN 'CTTY' THEN '''Cost Type'''  
   WHEN 'SYST' THEN 'System'  
   WHEN 'SUBS' THEN 'Sub System'  
   WHEN 'PRTA' THEN '''Strategy Task'''  
   WHEN 'EVTT' THEN '''Task Type'''  
   WHEN 'EVCC' THEN '''Component Code'''  
   WHEN 'MDCO' THEN '''Modifier Code'''  
   WHEN 'PRTY' THEN '''Part Type'''  
   WHEN 'PMAN' THEN '''Part Manufacturer'''  
   WHEN 'PART' THEN '''Primary Part No'''  
   WHEN 'PPDS' THEN '''Primary Part Description'''  
   WHEN 'SARP' THEN '''Sales Resp'''
   WHEN 'PACL' THEN '''Part Classification'''
   WHEN 'PARA' THEN '''Part Rating'''
   WHEN 'RELO' THEN '''Rebuild Location'''
   WHEN 'REST' THEN '''Review Status'''
   WHEN 'SAST' THEN '''Sales Status''' 
  ELSE NULL  
 END  
END  
IF( @GroupBy3 != NULL)  
 BEGIN  
  SELECT @OrderByCrossTab = @OrderByCrossTab + ', ' +  
  CASE @GroupBy3  
   WHEN 'BRAN' THEN 'Branch'  
   WHEN 'SITE' THEN 'Site'  
   WHEN 'FLEE' THEN 'Fleet'  
   WHEN 'ECLS' THEN '''Equipment Class'''  
   WHEN 'EGRP' THEN '''Equipment Group'''  
   WHEN 'MANU' THEN 'Manufacturer'  
   WHEN 'MODL' THEN 'Model'  
   WHEN 'EQPL' THEN 'Equipment'  
   WHEN 'REGN' THEN 'Region'  
   WHEN 'DEVI' THEN 'Division'  
   WHEN 'CRIT' THEN '''Equipment Criticality'''  
   WHEN 'LCTN' THEN '''Equipment Location'''  
   WHEN 'CTGR' THEN '''Equipment Category'''  
   WHEN 'ECCT' THEN '''Equipment Cost Centre'''  
   WHEN 'CRSP' THEN 'Responsibility'  
   WHEN 'CNTT' THEN '''Contract Type'''  
   WHEN 'CONT' THEN 'Contract'  
   WHEN 'PEQP' THEN '''Parent Equipment'''  
   WHEN 'CTTY' THEN '''Cost Type'''  
   WHEN 'SYST' THEN 'System'  
   WHEN 'SUBS' THEN 'Sub System'  
   WHEN 'PRTA' THEN '''Strategy Task'''  
   WHEN 'EVTT' THEN '''Task Type'''  
   WHEN 'EVCC' THEN '''Component Code'''  
   WHEN 'MDCO' THEN '''Modifier Code'''  
   WHEN 'PRTY' THEN '''Part Type'''  
   WHEN 'PMAN' THEN '''Part Manufacturer'''  
   WHEN 'PART' THEN '''Primary Part No'''  
   WHEN 'PPDS' THEN '''Primary Part Description'''  
   WHEN 'SARP' THEN '''Sales Resp'''
   WHEN 'PACL' THEN '''Part Classification'''
   WHEN 'PARA' THEN '''Part Rating'''
   WHEN 'RELO' THEN '''Rebuild Location'''
   WHEN 'REST' THEN '''Review Status'''
   WHEN 'SAST' THEN '''Sales Status'''  
  ELSE NULL  
 END  
END  
IF(@GroupBy4!=NULL)  
 BEGIN  
 SELECT @OrderByCrossTab = @OrderByCrossTab + ','+  
  CASE @GroupBy4  
   WHEN 'BRAN' THEN 'Branch'  
   WHEN 'SITE' THEN 'Site'  
   WHEN 'FLEE' THEN 'Fleet'  
   WHEN 'ECLS' THEN '''Equipment Class'''  
   WHEN 'EGRP' THEN '''Equipment Group'''  
   WHEN 'MANU' THEN 'Manufacturer'  
   WHEN 'MODL' THEN 'Model'  
   WHEN 'EQPL' THEN 'Equipment'  
   WHEN 'REGN' THEN 'Region'  
   WHEN 'DEVI' THEN 'Division'  
   WHEN 'CRIT' THEN '''Equipment Criticality'''  
   WHEN 'LCTN' THEN '''Equipment Location'''  
   WHEN 'CTGR' THEN '''Equipment Category'''  
   WHEN 'ECCT' THEN '''Equipment Cost Centre'''  
   WHEN 'CRSP' THEN 'Responsibility'  
   WHEN 'CNTT' THEN '''Contract Type'''  
   WHEN 'CONT' THEN 'Contract'  
   WHEN 'PEQP' THEN '''Parent Equipment'''  
   WHEN 'CTTY' THEN '''Cost Type'''  
   WHEN 'SYST' THEN 'System'  
   WHEN 'SUBS' THEN 'Sub System'  
   WHEN 'PRTA' THEN '''Strategy Task'''  
   WHEN 'EVTT' THEN '''Task Type'''  
   WHEN 'EVCC' THEN '''Component Code'''  
   WHEN 'MDCO' THEN '''Modifier Code'''  
   WHEN 'PRTY' THEN '''Part Type'''  
   WHEN 'PMAN' THEN '''Part Manufacturer'''  
   WHEN 'PART' THEN '''Primary Part No'''  
   WHEN 'PPDS' THEN '''Primary Part Description'''  
   WHEN 'SARP' THEN '''Sales Resp'''  
   WHEN 'PACL' THEN '''Part Classification'''
   WHEN 'PARA' THEN '''Part Rating'''
   WHEN 'RELO' THEN '''Rebuild Location'''
   WHEN 'REST' THEN '''Review Status'''
   WHEN 'SAST' THEN '''Sales Status'''
  ELSE NULL  
 END   
END   
  
   CREATE TABLE [#temp](  
    [GroupByID1] [varchar](max)COLLATE DATABASE_DEFAULT  NULL,  
    [GroupBy1] [varchar](max) COLLATE DATABASE_DEFAULT NULL,  
    [GroupByID2] [varchar](max)COLLATE DATABASE_DEFAULT  NULL,  
    [GroupBy2] [varchar](max) COLLATE DATABASE_DEFAULT NULL,  
    [GroupByID3] [varchar](max) COLLATE DATABASE_DEFAULT NULL,  
    [GroupBy3] [varchar](max) COLLATE DATABASE_DEFAULT NULL,  
    [GroupByID4] [varchar](max) COLLATE DATABASE_DEFAULT NULL,  
    [GroupBy4] [varchar](max) COLLATE DATABASE_DEFAULT NULL,  
    [PeriodStr] [varchar](max) COLLATE DATABASE_DEFAULT NULL,  
    [Val] [varchar](max) COLLATE DATABASE_DEFAULT NULL,  
    [Period] [int] NULL,   
   ) ON [PRIMARY]  
  
   INSERT INTO #temp     
   SELECT GroupByID1,GroupBy1,  
     GroupByID2,GroupBy2,  
     GroupByID3,GroupBy3,  
     GroupByID4,GroupBy4,  
     CASE @AnalyseBy   
      WHEN 'YEAR' THEN CAST(Period/100 AS VARCHAR)  
      WHEN 'QRTR' THEN LEFT(Period,4) + '-Q' + CONVERT(varchar(1),((Right(Period,2)+2)/3))  
      ELSE  RIGHT(CONVERT(varchar, CONVERT(datetime, CONVERT(varchar,Period) + '01', 112), 6), 6)  
     END As PeriodStr,  
     CASE @AnalyseBy   
      WHEN 'YEAR' THEN Period/100  
      WHEN 'QRTR' THEN CAST(Left(Period,4) + CONVERT(varchar(1),((Right(Period,2)+2)/3)) AS int)  
      ELSE Period  
     END As Period,  
     NULLIF(SUM(Val),0) AS Val  
   FROM  
    (SELECT T.GroupByID1,T.GroupBy1,  
      T.GroupByID2,T.GroupBy2,  
      T.GroupByID3,T.GroupBy3,  
      T.GroupByID4,T.GroupBy4,  
      O.Period,  
      O.Occs * CASE @CalculationOption  
       WHEN 1 THEN T.PctPurchasePart  
       WHEN 2 THEN T.PctPurchasePart * T.PctPurchaseNewPart  
       ELSE 1 END AS Val  
    FROM  
     #TASK T INNER JOIN  
     #OCC O ON T.ProjtaskID=O.ProjtaskID  
    )A  
   GROUP BY  
     GroupByID1,GroupBy1,  
     GroupByID2,GroupBy2,  
     GroupByID3,GroupBy3,  
     GroupByID4,GroupBy4,  
     CASE @AnalyseBy   
      WHEN 'YEAR' THEN CAST(Period/100 AS VARCHAR)  
      WHEN 'QRTR' THEN LEFT(Period,4) + '-Q' + CONVERT(varchar(1),((Right(Period,2)+2)/3))  
      ELSE  RIGHT(CONVERT(varchar, CONVERT(datetime, CONVERT(varchar,Period) + '01', 112), 6), 6)  
     END,  
     CASE @AnalyseBy   
      WHEN 'YEAR' THEN Period/100  
      WHEN 'QRTR' THEN CAST(Left(Period,4) + CONVERT(varchar(1),((Right(Period,2)+2)/3)) AS int)  
      ELSE Period  
     END  
   ORDER BY  
     CASE @AnalyseBy   
      WHEN 'YEAR' THEN Period/100  
      WHEN 'QRTR' THEN CAST(Left(Period,4) + CONVERT(varchar(1),((Right(Period,2)+2)/3)) AS int)  
      ELSE Period  
     END  
       
  
   DECLARE @ListCol VARCHAR(MAX)  
   DECLARE @Query VARCHAR(MAX)  
  
   SELECT  @ListCol = STUFF(( SELECT DISTINCT  '],[' + Val  FROM   #temp ORDER BY '],[' + Val  FOR XML PATH('') ), 1, 2, '') + ']'  
  
   SET @Query =  'SELECT * FROM ( SELECT '+@SelectQueryForCrossTab+', Val,Period FROM #temp WHERE Period!=0 ) tmp PIVOT (SUM(Period) for Val in('+@ListCol+')) AS pvt  
       ORDER BY  '+ @OrderByCrossTab  
   EXECUTE (@Query)  
  
   DROP TABLE #temp  
  
   END  
ELSE  
   --3: Returned query  
   SELECT GroupByID1,GroupBy1,  
     GroupByID2,GroupBy2,  
     GroupByID3,GroupBy3,  
     GroupByID4,GroupBy4,  
     CASE @AnalyseBy   
      WHEN 'YEAR' THEN CAST(Period/100 AS VARCHAR)  
      WHEN 'QRTR' THEN LEFT(Period,4) + '-Q' + CONVERT(varchar(1),((Right(Period,2)+2)/3))  
      ELSE  RIGHT(CONVERT(varchar, CONVERT(datetime, CONVERT(varchar,Period) + '01', 112), 6), 6)  
     END As PeriodStr,  
     CASE @AnalyseBy   
      WHEN 'YEAR' THEN Period/100  
      WHEN 'QRTR' THEN CAST(Left(Period,4) + CONVERT(varchar(1),((Right(Period,2)+2)/3)) AS int)  
      ELSE Period  
     END As Period,  
     NULLIF(SUM(Val),0) AS Val  
   FROM  
    (SELECT T.GroupByID1,T.GroupBy1,  
      T.GroupByID2,T.GroupBy2,  
      T.GroupByID3,T.GroupBy3,  
      T.GroupByID4,T.GroupBy4,  
      O.Period,  
      O.Occs * CASE @CalculationOption  
       WHEN 1 THEN T.PctPurchasePart  
       WHEN 2 THEN T.PctPurchasePart * T.PctPurchaseNewPart  
       ELSE 1 END AS Val  
    FROM  
     #TASK T INNER JOIN  
     #OCC O ON T.ProjtaskID=O.ProjtaskID  
    )A  
   GROUP BY  
     GroupByID1,GroupBy1,  
     GroupByID2,GroupBy2,  
     GroupByID3,GroupBy3,  
     GroupByID4,GroupBy4,  
     CASE @AnalyseBy   
      WHEN 'YEAR' THEN CAST(Period/100 AS VARCHAR)  
      WHEN 'QRTR' THEN LEFT(Period,4) + '-Q' + CONVERT(varchar(1),((Right(Period,2)+2)/3))  
      ELSE  RIGHT(CONVERT(varchar, CONVERT(datetime, CONVERT(varchar,Period) + '01', 112), 6), 6)  
     END,  
     CASE @AnalyseBy   
      WHEN 'YEAR' THEN Period/100  
      WHEN 'QRTR' THEN CAST(Left(Period,4) + CONVERT(varchar(1),((Right(Period,2)+2)/3)) AS int)  
      ELSE Period  
     END  
   ORDER BY  
     CASE @AnalyseBy   
      WHEN 'YEAR' THEN Period/100  
      WHEN 'QRTR' THEN CAST(Left(Period,4) + CONVERT(varchar(1),((Right(Period,2)+2)/3)) AS int)  
      ELSE Period  
     END  
  
--4: cleanup  
DROP TABLE #TASK,#OCC  

GO  
  
GO

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[RPT_REBUILD_CENTRE_FORECAST_WORKLOAD_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[RPT_REBUILD_CENTRE_FORECAST_WORKLOAD_P]
GO

CREATE PROCEDURE [dbo].[RPT_REBUILD_CENTRE_FORECAST_WORKLOAD_P]
/******************************************************************************        
 File:         
 Name: RPT_REBUILD_CENTRE_FORECAST_WORKLOAD_P        
        
 Called By:         
        
 Desc:         
        
 Auth: Joel Wang        
 Date: 18-Apr-2012        
*******************************************************************************        
  Change History        
*******************************************************************************        
 Date:  Author:  Description:        
 -------- -------- ----------------------------------------  
 27 Apr 12	JW	Change the end of each interval to the end of that day and get next occ date from tblPorjtaskOccs    
        
*******************************************************************************/        
 /* Param List */        
 -- Add the parameters for the stored procedure here 
 @StartDay DATETIME, 
 @EndDay DATETIME,
 @AnalyseBy VARCHAR(MAX)='',
 @RebuildSiteId VARCHAR(MAX)='',
 @PartClassificationId VARCHAR(MAX)='',
 @PartRatingId VARCHAR(MAX)='',
 @PrimaryPartNumberId VARCHAR(MAX)='',
 @PartTypeId VARCHAR(MAX)='',
 @SourceOfSupplyId VARCHAR(MAX)='',
 @ComponentCodeID VARCHAR(MAX)='',
 @ReviewStatusId VARCHAR(MAX) = '',
 @SalesStatusId VARCHAR(MAX) = '',
 @SortBy INT='',
 @UserID INT='' 
 
 AS
 BEGIN 
 
 SET @EndDay = DATEADD(SECOND,-1, DATEADD(DAY,1,@EndDay));
 
 ; WITH DateRange AS 
 (
	SELECT @StartDay AS StartDate
	, CASE WHEN (DATEADD(DAY,6,@StartDay)>=@EndDay) THEN @EndDay ELSE DATEADD(SECOND,-1, DATEADD(DAY,7,@StartDay)) END AS EndDate
	UNION ALL
	SELECT DATEADD(WEEK,1,StartDate)
	, CASE WHEN (DATEADD(WEEK,1, EndDate)>= @EndDay) THEN @EndDay ELSE DATEADD(WEEK,1, EndDate) END FROM DateRange
	WHERE EndDate < @EndDay 
 ),
 FINAL AS(
 SELECT DATA.SiteId, S.Site AS RebuildLocation, DATA.PartId, P.Part AS PartNumber
 , CASE @AnalyseBy
	WHEN 'PACL' THEN PC.PartClassification
	WHEN 'PATY' THEN PTY.PartType
	WHEN 'PARA' THEN PR.PartRating
	WHEN 'CC'   THEN CC.Code + ' - ' + CC.Description
	WHEN 'PADE' THEN P.PartDescription
	END AS AnalyseBy
 , SUM(CASE WHEN (StartRebuild <= EndDate) AND (EndRebuild >= StartDate) 
	THEN (DATEDIFF(DAY,dbo.MAX_DATE_2_F(StartRebuild,StartDate),dbo.MIN_DATE_2_F(EndRebuild,EndDate))+1) * DATA.Quantity ELSE 0 END) AS Quantity
 , StartDate
 FROM DateRange AS T 
 CROSS JOIN 

 (
 /*Parts in Progress*/
 SELECT IP.RebuildSiteId AS SiteId
 , IP.PartId, NULL AS PartClassificationId
 , PTY.PartTypeId , P.DefaultPartRatingId AS PartRatingId
 , P.DefaultComponentCodeId AS ComponentCodeId
 , CAST(CAST(IP.ExpectedDeliveryDate AS FLOAT) - P.BudgetRebuildDuration AS DATETIME) AS StartRebuild
 , IP.ExpectedDeliveryDate AS EndRebuild
 , IP.QtyBeingRebuilt AS Quantity
 FROM INVENTORY_PART IP
 INNER JOIN 
 dbo.tblParts P ON IP.PartId = P.PartId
 INNER JOIN
 dbo.tblPartTypes PTY ON P.Part_Type_ID = PTY.PartTypeId
 WHERE
 CAST(CAST(IP.ExpectedDeliveryDate AS FLOAT) - P.BudgetRebuildDuration AS DATETIME) < @EndDay AND
 IP.ExpectedDeliveryDate > @StartDay AND
 IP.QtyBeingRebuilt > 0 AND
 (@RebuildSiteId = '' OR IP.RebuildSiteId IN (SELECT List_Item FROM LIST_TO_TABLE_F(@RebuildSiteId))) AND
 (@PartRatingId = '' OR P.DefaultPartRatingId IN (SELECT List_Item FROM LIST_TO_TABLE_F(@PartRatingId))) AND
 (@PrimaryPartNumberId = '' OR IP.PartId IN (SELECT List_Item FROM LIST_TO_TABLE_F(@PrimaryPartNumberId))) AND
 (@PartTypeId = '' OR PTY.PartTypeId IN (SELECT List_Item FROM LIST_TO_TABLE_F(@PartTypeId))) AND
 (@SourceOfSupplyId = '' OR P.Source_Of_Supply_ID IN (SELECT List_Item FROM LIST_TO_TABLE_F(@SourceOfSupplyId))) AND
 (@ComponentCodeID = '' OR P.DefaultComponentCodeId IN (SELECT List_Item FROM LIST_TO_TABLE_F(@ComponentCodeID)))
  
 
 
 
 /*Step 2 Parts from Changeout Forecast NextOCC*/  
 UNION ALL
 SELECT ISNULL(N.PEXRebuildLocationId, PT.DefaultLocationForRebuild) AS SiteId
 , ISNULL(N.PEXPartId, PT.Part_Id) AS PartId
 , ISNULL(N.PEXPartTypeId, PT.PartClassificationId) AS PartClassificationId
 , ISNULL(PTY_N.PartTypeId, PTY_PT.PartTypeId) AS PartTypeId
 , ISNULL(PT.PartRatingId, CASE WHEN P_N.PartId > 0 THEN P_N.DefaultPartRatingId ELSE P_PT.DefaultPartRatingId END) AS PartRatingId
 , ISNULL(P_N.DefaultComponentCodeId, P_PT.DefaultComponentCodeId) AS ComponentCodeId
 , CAST (CAST(PTO.OccDate AS FLOAT) + ISNULL(P_N.BudgetDeliveryTimeToWorkshop, P_PT.BudgetDeliveryTimeToWorkshop)+
   ISNULL(P_N.BudgetTimeWaitingForRebuild, P_PT.BudgetTimeWaitingForRebuild) AS DATETIME) AS StartRebuild
 , CAST (CAST(PTO.OccDate AS FLOAT) + ISNULL(P_N.BudgetDeliveryTimeToWorkshop, P_PT.BudgetDeliveryTimeToWorkshop)+
   ISNULL(P_N.BudgetTimeWaitingForRebuild, P_PT.BudgetTimeWaitingForRebuild)+ 
   ISNULL(P_N.BudgetRebuildDuration, P_PT.BudgetRebuildDuration) AS DATETIME) AS EndRebuild
 , 1 AS Quantity
 FROM dbo.tblProjtasks PT
 INNER JOIN 
 dbo.tblProjTaskOccs PTO ON PT.ProjTaskId = PTO.ProjTaskId AND PTO.OccDate = (SELECT MIN(O.OccDate) FROM dbo.tblProjTaskOccs O WHERE PT.ProjTaskId = O.ProjTaskId)
 LEFT JOIN 
 dbo.tblParts P_PT ON PT.Part_Id = P_PT.PartId
 LEFT JOIN 
 dbo.tblPartTypes PTY_PT ON P_PT.Part_Type_ID = PTY_PT.PartTypeId
 LEFT JOIN 
 SOURCE_OF_SUPPLY SOS_PT ON P_PT.Source_Of_Supply_ID = SOS_PT.Source_Of_Supply_ID
 LEFT JOIN
 NEXT_OCC_STRATEGY N ON PT.ProjTaskId = N.Proj_Task_Id
 LEFT JOIN
 dbo.tblParts P_N ON N.PEXPartId = P_N.PartId
 LEFT JOIN
 dbo.tblPartTypes PTY_N ON P_N.Part_Type_ID = PTY_N.PartTypeId
 LEFT JOIN 
 SOURCE_OF_SUPPLY SOS_N ON P_N.Source_Of_Supply_ID = SOS_N.Source_Of_Supply_ID
 LEFT JOIN 
 PART_CLASSIFICATION PC ON PT.PartClassificationId = PC.PartClassificationId
 INNER JOIN
 dbo.tblEqpProjs EP ON PT.EqpProjId = EP.EqpProjId
 WHERE 
 ISNULL(PEXPartId, PT.Part_Id)>0 AND PT.NextOccDate IS NOT NULL AND
 (PC.CoreRetained IS NULL OR PC.CoreRetained > 0) AND
 EP.Projection_Type_ID = 1 AND /*From Current Projection*/
 CAST (CAST(PTO.OccDate AS FLOAT) + ISNULL(P_N.BudgetDeliveryTimeToWorkshop, P_PT.BudgetDeliveryTimeToWorkshop)+
 ISNULL(P_N.BudgetTimeWaitingForRebuild, P_PT.BudgetTimeWaitingForRebuild) AS DATETIME) < @EndDay AND
 CAST (CAST(PTO.OccDate AS FLOAT) + ISNULL(P_N.BudgetDeliveryTimeToWorkshop, P_PT.BudgetDeliveryTimeToWorkshop)+
 ISNULL(P_N.BudgetTimeWaitingForRebuild, P_PT.BudgetTimeWaitingForRebuild)+ 
 ISNULL(P_N.BudgetRebuildDuration, P_PT.BudgetRebuildDuration) AS DATETIME) > @StartDay AND
 (@RebuildSiteId = '' OR ISNULL(N.PEXRebuildLocationId, PT.DefaultLocationForRebuild) IN (SELECT List_Item FROM LIST_TO_TABLE_F(@RebuildSiteId))) AND
 (@PartClassificationId = '' OR ISNULL(N.PEXPartTypeId, PT.PartClassificationId) IN (SELECT List_Item FROM LIST_TO_TABLE_F(@PartClassificationId)) ) AND
 (@PartRatingId = '' OR ISNULL(PT.PartRatingId, CASE WHEN P_N.PartId > 0 THEN P_N.DefaultPartRatingId ELSE P_PT.DefaultPartRatingId END) IN (SELECT List_Item FROM LIST_TO_TABLE_F(@PartRatingId))) AND
 (@PrimaryPartNumberId = '' OR ISNULL(N.PEXPartId, PT.Part_Id) IN (SELECT List_Item FROM LIST_TO_TABLE_F(@PrimaryPartNumberId))) AND
 (@PartTypeId = '' OR ISNULL(PTY_N.PartTypeId, PTY_PT.PartTypeId) IN (SELECT List_Item FROM LIST_TO_TABLE_F(@PartTypeId))) AND
 (@SourceOfSupplyId = '' OR ISNULL(SOS_N.Source_Of_Supply_ID,SOS_PT.Source_Of_Supply_ID) IN (SELECT List_Item FROM LIST_TO_TABLE_F(@SourceOfSupplyId))) AND
 (@ComponentCodeID = '' OR ISNULL(P_N.DefaultComponentCodeId, P_PT.DefaultComponentCodeId) IN (SELECT List_Item FROM LIST_TO_TABLE_F(@ComponentCodeID))) AND
 (@ReviewStatusId = '' OR PT.ReviewStatusID IN (SELECT List_Item FROM LIST_TO_TABLE_F(@ReviewStatusId))) AND
 (@SalesStatusId = '' OR N.SalesStatusId IN (SELECT List_Item FROM LIST_TO_TABLE_F(@SalesStatusId)))
 


 --/*Step 3 Parts from Changeout Forecast thereafter*/
 UNION ALL
 SELECT PT.DefaultLocationForRebuild AS SiteId
 , PT.Part_Id AS PartId
 , PT.PartClassificationId
 , PTY_PT.PartTypeId
 , ISNULL(PT.PartRatingId, P_PT.DefaultPartRatingId) AS PartRatingId
 , P_PT.DefaultComponentCodeId AS ComponentCodeId
 , CAST (CAST(PTO.OccDate AS FLOAT) + P_PT.BudgetDeliveryTimeToWorkshop + P_PT.BudgetTimeWaitingForRebuild AS DATETIME) AS StartRebuild
 , CAST (CAST(PTO.OccDate AS FLOAT) + P_PT.BudgetDeliveryTimeToWorkshop + P_PT.BudgetTimeWaitingForRebuild + P_PT.BudgetRebuildDuration AS DATETIME) AS EndRebuild
 , 1 AS Quantity
 FROM dbo.tblProjTasks PT
 INNER JOIN 
 dbo.tblParts P_PT ON PT.Part_Id = P_PT.PartId
 INNER JOIN 
 dbo.tblProjTaskOccs PTO ON PT.ProjTaskId = PTO.ProjTaskId AND PTO.OccDate > (SELECT MIN(O.OccDate) FROM dbo.tblProjTaskOccs O WHERE PT.ProjTaskId = O.ProjTaskId)
 INNER JOIN
 dbo.tblPartTypes PTY_PT ON P_PT.Part_Type_ID = PTY_PT.PartTypeId
 LEFT JOIN 
 SOURCE_OF_SUPPLY SOS_PT ON P_PT.Source_Of_Supply_ID = SOS_PT.Source_Of_Supply_ID
 LEFT JOIN 
 PART_CLASSIFICATION PC ON PT.PartClassificationId = PC.PartClassificationId 
 INNER JOIN 
 dbo.tblEqpProjs EP ON PT.EqpProjId = EP.EqpProjId
 WHERE 
 (PC.CoreRetained IS NULL OR PC.CoreRetained > 0) AND
 EP.Projection_Type_ID = 1 AND /*From Current Projection*/
 CAST (CAST(PTO.OccDate AS FLOAT) + P_PT.BudgetDeliveryTimeToWorkshop + P_PT.BudgetTimeWaitingForRebuild AS DATETIME) < @EndDay AND
 CAST (CAST(PTO.OccDate AS FLOAT) + P_PT.BudgetDeliveryTimeToWorkshop + P_PT.BudgetTimeWaitingForRebuild + P_PT.BudgetRebuildDuration AS DATETIME) > @StartDay AND
 (@RebuildSiteId = '' OR PT.DefaultLocationForRebuild IN (SELECT List_Item FROM LIST_TO_TABLE_F(@RebuildSiteId))) AND
 (@PartClassificationId = '' OR PT.PartClassificationId IN (SELECT List_Item FROM LIST_TO_TABLE_F(@PartClassificationId)) ) AND
 (@PartRatingId = '' OR ISNULL(PT.PartRatingId, P_PT.DefaultPartRatingId) IN (SELECT List_Item FROM LIST_TO_TABLE_F(@PartRatingId))) AND
 (@PrimaryPartNumberId = '' OR PT.Part_Id IN (SELECT List_Item FROM LIST_TO_TABLE_F(@PrimaryPartNumberId))) AND
 (@PartTypeId = '' OR PTY_PT.PartTypeId IN (SELECT List_Item FROM LIST_TO_TABLE_F(@PartTypeId))) AND
 (@SourceOfSupplyId = '' OR SOS_PT.Source_Of_Supply_ID IN (SELECT List_Item FROM LIST_TO_TABLE_F(@SourceOfSupplyId))) AND
 (@ComponentCodeID = '' OR PT.ComponentCodeId IN (SELECT List_Item FROM LIST_TO_TABLE_F(@ComponentCodeID))) AND
 (@ReviewStatusId = '' OR PT.ReviewStatusID IN (SELECT List_Item FROM LIST_TO_TABLE_F(@ReviewStatusId)))
 ) AS DATA
 
 LEFT JOIN dbo.tblSites S ON DATA.SiteId = S.SiteId
 INNER JOIN dbo.tblParts P ON DATA.PartId = P.PartId
 LEFT JOIN dbo.PART_CLASSIFICATION PC ON DATA.PartClassificationId = PC.PartClassificationId
 INNER JOIN dbo.tblPartTypes PTY ON DATA.PartTypeId = PTY.PartTypeId
 LEFT JOIN dbo.PART_RATING PR ON DATA.PartRatingId = PR.PartRatingId
 LEFT JOIN dbo.tblComponentCodes CC ON DATA.ComponentCodeId = CC.ComponentCodeID
 GROUP BY DATA.SiteId, S.Site, DATA.PartId, P.Part
 ,CASE @AnalyseBy 
	WHEN 'PACL' THEN DATA.PartClassificationId
	WHEN 'PATY' THEN DATA.PartTypeId
	WHEN 'PARA' THEN DATA.PartRatingId
	WHEN 'CC'   THEN DATA.ComponentCodeId
	END
,CASE @AnalyseBy 
	WHEN 'PACL' THEN PC.PartClassification
	WHEN 'PATY' THEN PTY.PartType
	WHEN 'PARA' THEN PR.PartRating
	WHEN 'CC'   THEN CC.Code + ' - ' + CC.Description
	WHEN 'PADE' THEN P.PartDescription
	END
 , StartDate
)
SELECT SiteId, RebuildLocation, PartId, PartNumber, AnalyseBy, StartDate, CEILING(Quantity/7.0) AS Quantity FROM FINAL 
ORDER BY 
 CASE @SortBy
	WHEN 1 THEN RebuildLocation
	WHEN 2 THEN PartNumber
	WHEN 3 THEN AnalyseBy END
OPTION (MAXRECURSION 0)
 END
 
 
 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[RPT_MTBS_MTBF_MTBUPS_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[RPT_MTBS_MTBF_MTBUPS_P]
GO

CREATE Procedure [dbo].[RPT_MTBS_MTBF_MTBUPS_P]
/******************************************************************************
	File: RPT_MTBS_MTBF_MTBUPS_P.sql
	Name: RPT_MTBS_MTBF_MTBUPS_P

	Called By: 

	Desc: 1. Get data set for downtime hours report
             

	Auth: Harpreet Singh
	Date: 1-Oct-2002
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	30 Apr 12   SD          4059 - Reports Taking too long : missing where criteria in temp table fill so
							re-code temp table 3 as a subquery
	
	
OLD HISTORY
-----------	
	
	17 Jan 07	VV		Discussed with RF: Use actual+projected usages for the report. 
					Usage in the current period is calculated only to the current date
					Use actual and projected usages to calculate utilisation for the last 12 months
	19/12/2006	A Lassauniere	do not include enddate in where clause (1st of next month)
	06/12/2006	A Lassauniere	Restricting event counting to within date period AND added Model filter in the usage query
	16/12/2003	H Singh   	Analyse by Model is fixed
    	6/09/2002	H Singh   	Date where clause is modified 
    	21/10/2002	H Singh   	Modified to support multiselector search control 
	13/11/2002	H Singh   	modified to get correct usage 
	17-Sep-09	TAS		CR8389: Added UserID
	19-Sep-11   TP		Issue 2419.  Increased the size of the @WhereClause variable.
	01-Nov-11	DA		E#658 - Adding datetime filter to MTBF/MTBS Report
	06-Dec-11	DA		2916 - Error when running MTBF analysis by Component code
*******************************************************************************/
 /* Param List */    
    @DealerID int = 1,    
    @BranchId varchar(MAX)='1',    
    @SiteID varchar(MAX)='1',    
    @FleetID varchar(MAX)='1',    
    @EqpPlanID varchar(MAX)='',    
    @ModelID varchar(MAX) = '',    
    @ResponsibilityID varchar(MAX) = '',    
    @TaskTypeID varchar(MAX) = '',    
    @CostTypeId varchar(MAX) = '',    
    @ComponentCodeID varchar(MAX) = '',    
    @Planned int = 1,    
    @Breakdown int = 2,    
    @SystemId varchar(MAX) = '',    
    @SubSystemId varchar(MAX) = '',    
    @StartDate datetime = 'May 15 1999 12:00:00:000AM',    
    @EndDate datetime = 'May 15 2003 12:00:00:000AM',     
    @AnalyseBy varchar(4) = 'CTTY',    
    @ShowTotalAs VARCHAR(10)  = 'SUM' OUTPUT,    
   @DateBased varchar(10) = 'False' OUTPUT,    
 @UserID INT=0    
     
    
    
AS    
SET NOCOUNT ON    
    
--BY KN    
    
IF @AnalyseBy in ('BRAN','SITE','FLEE','EQPL','MODL','DATE','MONH','QRTR','YEAR')    
         SET @ShowTotalAs = 'SUM'    
ELSE    
        SET @ShowTotalAs = 'AVG'    
    
    
SET  @DateBased= 'False'     
IF @AnalyseBy = 'MONH' OR @AnalyseBy = 'QRTR' OR @AnalyseBy = 'YEAR'      
 BEGIN    
  SET @DateBased = 'True'    
 END    
    
--******************************************    
--Change Start    
--Tas 16-Sep-2009    
 SET @UserId=ISNULL(@UserId,0)    
 DECLARE @Level int    
 SELECT @Level=User_Access_Level_Id From USER_LEVEL_PERMISSION where AMT_User_Id = @UserId    
 SET @Level=ISNULL(@Level,0)    
    
  /*    
  0 -ALL    
  1-Branch,    
  2-Site    
  */    
--Change End    
--******************************************    
    
    
DECLARE @sSQL as varchar(MAX)    
DECLARE @SelectClause as varchar(MAX)    
DECLARE @GroupClause as varchar(MAX)    
DECLARE @FromClause as varchar(MAX)    
DECLARE @WhereClause as varchar(MAX)    
DECLARE @OrderClause as varchar(4000)    
     
DECLARE @sTempTable as varchar(20)    
DECLARE @sTempTable2 as varchar(20)    
-- /* 4059 */ DECLARE @sTempTable3 as varchar(20)    
DECLARE @subQuery as varchar(MAX)     
    
SET @sTempTable = '##tmpMTBSMTBF' + CONVERT(CHAR(4), CONVERT(INT,RAND() * 8999) + 1000)    
SET @sTempTable2 = '##tmpUsages' + CONVERT(CHAR(4), CONVERT(INT,RAND() * 8999) + 1000)    
--/* 4059 */ SET @sTempTable3 = '##tmpUsages3' + CONVERT(CHAR(4), CONVERT(INT,RAND() * 8999) + 1000)    
    
SET @SelectClause = ''    
SET @GroupClause = ''    
SET @FromClause = ''    
SET @WhereClause = ''    
SET @OrderClause = ''    
    
    
 /*-------------------------*/    
 SET @GroupClause =    
 CASE @AnalyseBy     
  WHEN'MONH' THEN 'Left(Calendar_Period,4) + ' + CHAR(39) + '-' + CHAR(39) + ' + Right(Calendar_Period,2)'    
  WHEN'QRTR' THEN 'Left(Calendar_Period,4) + ' + CHAR(39) + '-Q' + CHAR(39) + ' + CONVERT(varchar(1),((Right(Calendar_Period,2)+2)/3))'    
  WHEN'YEAR' THEN 'LEFT(Calendar_Period,4) '    
  WHEN'BRAN' THEN 'Branch'    
  WHEN'SITE' THEN 'Site'    
  WHEN'FLEE' THEN 'Fleet'    
  WHEN'EQPL' THEN 'EqpPlan'    
  WHEN'MODL' THEN 'Model'    
  WHEN'RESP' THEN 'Responsibility'    
  WHEN'EVTT' THEN 'TaskType'    
  WHEN'CTTY' THEN 'CostType'    
  WHEN'EVCC' THEN 'CompCode'    
  WHEN'SYST' THEN 'System'    
  WHEN'SUBS' THEN 'SubSystem'    
 END     
 /*-------------------------*/    
    
 /*===========================*/    
 SET @SelectClause = 'SELECT ' + @GroupClause + ' AS Description,  '    
 SET @SelectClause = @SelectClause + ' COUNT(DISTINCT Event_Id) AS NOOfEvents'    
 /*===========================*/    
    
 /*-------------------------*/    
 IF @ResponsibilityID <> ''     
  SET @FromClause = ' INTO ' + @sTempTable + ' FROM RPT_MTBS_MTBF_MTBUPS_RESP_V '    
 ELSE    
  SET @FromClause = ' INTO ' + @sTempTable + ' FROM RPT_MTBS_MTBF_MTBUPS_V '    
 /*-------------------------*/    
     
 /*===========================*/    
 --DA E#658 - Convert varchar(10) to varchar so that it accepts datetime    
 SET @WhereClause = ' WHERE (Actual_Up_Time >= ' + CHAR(39) + CONVERT(varchar,@StartDate,121) + CHAR(39) + ' AND Actual_Down_Time < ' + CHAR(39) + CONVERT(varchar,@EndDate,121) + CHAR(39) + ')'    
 SET @WhereClause = @WhereClause + ' AND Calendar_Period BETWEEN '+convert(varchar,YEAR(@StartDate)*100+MONTH(@startDate))+' AND '+convert(varchar,YEAR(@EndDate)*100+MONTH(@EndDate)) --AL 06/12/06: to restrict counting WITHIN the defined period    
 If @EqpPlanID <> '' SET @WhereClause = @WhereClause + ' AND EqpPlanID IN (' + @EqpPlanID + ' )'    
 If @FleetID <> '' SET @WhereClause = @WhereClause + ' AND FleetID IN (' + @FleetID + ' )'    
 --*******************************************    
 --Change Start    
 --Tas 17-Sep-2009    
 SET @WhereClause = @WhereClause + ' AND ('+CAST(@Level AS varchar(50))+'<>1 OR BranchId In (SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = '+CAST(@UserId AS varchar(50))+'))'    
 SET @WhereClause =@WhereClause + ' AND ('+CAST(@Level AS varchar(50))+'<>2 OR SiteID IN(SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = '+CAST(@UserId AS varchar(50))+'))'    
     
 --Change End    
 --*******************************************    
    
 If @SiteID <> '' SET @WhereClause = @WhereClause + ' AND SiteID IN (' + @SiteID + ' )'    
 If @BranchId <> '' SET @WhereClause = @WhereClause + ' AND BranchId IN (' + @BranchId + ' )'    
 If @DealerId > 0 SET @WhereClause = @WhereClause + ' AND DealerId = ' + Convert(varchar, @DealerId)    
 IF @ModelID <> ''  SET @WhereClause = @WhereClause + ' AND ModelId IN (' + @ModelID + ')'    
 IF @ResponsibilityID <> ''  SET @WhereClause = @WhereClause + ' AND (Responsibility_Id IN (' + @ResponsibilityID + ') OR Responsibility_Id IS NULL)'    
 IF @TaskTypeID <> ''  SET @WhereClause = @WhereClause + ' AND Task_Type_Id IN (' + @TaskTypeID + ')'    
 IF @CostTypeID <> ''  SET @WhereClause = @WhereClause + ' AND CostTypeID IN (' + @CostTypeID + ')'    
 IF @ComponentCodeID <> ''  SET @WhereClause = @WhereClause + ' AND ComponentCodeId IN (' + @ComponentCodeID + ')'    
     
 SET @WhereClause =     
 CASE @Planned     
  WHEN 2 THEN @WhereClause + ' AND Planned <> 0'     
  WHEN 3 THEN @WhereClause + ' AND Planned = 0'    
  ELSE @WhereClause    
 END    
 SET @WhereClause =     
 CASE @Breakdown     
  WHEN 2 THEN @WhereClause + ' AND Break_Down <> 0'     
  WHEN 3 THEN @WhereClause + ' AND Break_Down = 0'    
  ELSE @WhereClause    
 END    
    
 IF @SystemId <> ''  SET @WhereClause = @WhereClause + ' AND SystemId IN (' + @SystemId + ')'    
 IF @SubSystemId <> ''  SET @WhereClause = @WhereClause + ' AND SubSystemId IN (' + @SubSystemId + ')'    
 /*===========================*/    
     
 /*-------------------------*/    
 SET @GroupClause = ' GROUP BY ' + @GroupClause     
 /*-------------------------*/     
    
 /*===========================*/    
 SET @OrderClause = ' ORDER BY ' +     
 CASE @AnalyseBy     
  WHEN 'MONH' THEN ' Description'    
  WHEN 'QRTR' THEN ' Description'    
  WHEN 'YEAR' THEN ' Description'    
  ELSE 'Description'   END    
 /*===========================*/    
    
    
 /*---------------------------*/    
 SET @sSQL = @SelectClause + @FromClause + @WhereClause + @GroupClause + @OrderClause    
 /*---------------------------*/    
    
--  PRINT '@GroupClause = ' + (@GroupClause)    
--  PRINT '@SelectClause = ' + (@SelectClause)     
--  PRINT '@FromClause = ' + (@FromClause)     
--  PRINT '@WhereClause = ' + (@WhereClause)      
--  PRINT '@OrderClause = ' + (@OrderClause)    
  --PRINT '@sSQL = ' + (@sSQL)    
     
--print @sSQL return    
 EXEC (@sSQL)    
    
-- drop table z_mtbs    
-- exec ('select * into z_mtbs from ' + @sTempTable)    
    
/* get usages*/    
SET @SelectClause = ''    
SET @GroupClause = ''    
SET @FromClause = ''    
SET @WhereClause = ''    
SET @OrderClause = ''    
    
    
 /*-------------------------*/    
 SET @GroupClause =    
 CASE @AnalyseBy     
  WHEN 'MONH' THEN 'Left(CalendarPeriod,4) + ' + CHAR(39) + '-' + CHAR(39) + ' + Right(CalendarPeriod,2)'    
  WHEN 'QRTR' THEN 'Left(CalendarPeriod,4) + ' + CHAR(39) + '-Q' + CHAR(39) + ' + CONVERT(varchar(1),((Right(CalendarPeriod,2)+2)/3))'    
  WHEN 'YEAR' THEN 'LEFT(CalendarPeriod,4) '    
  WHEN 'BRAN' THEN 'Branch'    
  WHEN 'MODL' THEN 'Model'    
  WHEN 'SITE' THEN 'Site'    
  WHEN 'FLEE' THEN 'Fleet'    
  WHEN 'EQPL' THEN 'EqpPlan'    
  ELSE 'Dummy'     
 END     
 /*-------------------------*/    
    
 /*===========================*/    
     
 SET @SelectClause = '    
 DECLARE @Start DATETIME, @End DATETIME, @currDate DATETIME' + CHAR(13) + '    
      
 SET @Start= ' + CHAR(39) + CONVERT(varchar,@StartDate,121)  + CHAR(39) + CHAR(13) + '    
 SET @End= ' + CHAR(39) + CONVERT(varchar,@EndDate, 121) +  CHAR(39) + CHAR(13) + '    
 SET @currDate = GETDATE()' + CHAR(13) + '    
      
 IF @Start>@currDate SET @Start=@currDate' + CHAR(13) + '    
 IF @End>@currDate SET @End=@currDate' + CHAR(13)    
     
 --/* 4059 */ SET @SelectClause = @SelectClause + '   
 SET @subQuery = ' 
 SELECT     EP.EqpPlan as EqpPlan, RU.PeriodStartDate AS PeriodStartDate, RU.PeriodEndDate as PeriodEndDate, B.Branch as Branch, S.Site as Site, F.Fleet as Fleet, RU.CalenderPeriod AS CalendarPeriod,       
          
    /*End Usage*/    
    dbo.GET_USAGE_FROM_DATE_F(EPR.EqpProjId, EPR.EndQUOMId, CASE WHEN @End<RU.PeriodEndDate THEN @End ELSE RU.PeriodEndDate End)    
    -    
    /*Start Usage*/    
    dbo.GET_USAGE_FROM_DATE_F(EPR.EqpProjId, EPR.EndQUOMId,CASE WHEN @Start>RU.PeriodStartDate THEN @Start ELSE RU.PeriodStartDate END) AS PeriodUsageCurr,    
    
   B.DealerId, B.BranchId, S.SiteId, F.FleetId, EP.EqpPlanId, CONVERT(varchar, NULL) AS [Dummy],       
   M.Model as Model, M.ModelId ' + --/* 4059 */    INTO  ' + @sTempTable3 + '     
  'FROM         dbo.tblEqpProjs EPR INNER JOIN      
          dbo.tblEqpPlans EP ON EPR.EqpPlanId = EP.EqpPlanId INNER JOIN      
          dbo.tblFleets F ON EP.FleetId = F.FleetId INNER JOIN      
          dbo.tblSites S ON F.SiteId = S.SiteId INNER JOIN      
          dbo.tblBranches B ON S.BranchId = B.BranchId INNER JOIN      
          dbo.tblRepUsages RU ON EPR.EqpProjId = RU.EqpProjID AND ISNULL(EPR.EndQUOMId, 0) = ISNULL(RU.QUOMID, 0) INNER JOIN      
          dbo.tblEquipment E ON EP.EquipmentId = E.EquipmentId INNER JOIN      
          dbo.tblModels M ON E.ModelId = M.ModelId      
   WHERE     (EPR.Projection_Type_ID = 1)      
   AND RU.CalenderPeriod>=year(@Start)*100+MONTH(@Start) and RU.CalenderPeriod<=year(@End)*100+MONTH(@End)' + CHAR(13)    
       
      
 SET @SelectClause = @SelectClause + 'SELECT ' + @GroupClause + ' AS Description, '    
     
 --VV 17/01/2007 Use actual+projected usages for the report. Usage in the current period is calculated only to the current date    
 SET @SelectClause = @SelectClause + ' SUM(PeriodUsageCurr) AS PeriodUsage'    
 --SET @SelectClause = @SelectClause + ' SUM(PeriodUsage) AS PeriodUsage'    
 /*===========================*/    
    
 /*-------------------------*/    
-- /* 4059 */ SET @FromClause = ' INTO ' + @sTempTable2 + ' FROM ' + @sTempTable3    
 SET @FromClause = ' INTO ' + @sTempTable2 + ' FROM (' + @subQuery + ') as sq1 '    
 /*-------------------------*/    
     
 /*===========================*/    
 --DA E#658 - Convert varchar(10) to varchar so that it accepts datetime    
 --SET @WhereClause = ' WHERE (PeriodStartDate >= ' + CHAR(39) + CONVERT(varchar,@StartDate,121) + CHAR(39) + ' AND PeriodEndDate <= ' + CHAR(39) + CONVERT(varchar,@EndDate,121) + CHAR(39) + ')'    
 --*******************************************    
 --Change Start    
 --Tas 17-Sep-2009    
 SET @WhereClause = ' WHERE ('+CAST(@Level AS varchar(50))+'<>1 OR BranchId In (SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = '+CAST(@UserId AS varchar(50))+'))'    
 SET @WhereClause =@WhereClause + ' AND ('+CAST(@Level AS varchar(50))+'<>2 OR SiteID IN(SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = '+CAST(@UserId AS varchar(50))+'))'    
     
 --Change End    
 --*******************************************    
 If @EqpPlanID <> '' SET @WhereClause = @WhereClause + 'AND EqpPlanID IN (' + @EqpPlanID + ' )'    
 If @FleetID <> '' SET @WhereClause = @WhereClause + ' AND FleetID IN (' + @FleetID + ' )'    
 If @SiteID <> '' SET @WhereClause = @WhereClause + ' AND SiteID IN (' + @SiteID + ' )'    
 If @BranchId <> '' SET @WhereClause = @WhereClause + ' AND BranchId IN (' + @BranchId + ' )'    
 If @DealerId > 0 SET @WhereClause = @WhereClause + ' AND DealerId = ' + Convert(varchar, @DealerId)    
 IF @ModelID <> ''  SET @WhereClause = @WhereClause + ' AND ModelId IN (' + @ModelID + ')' --AL 06/12/06    
     
 /*===========================*/    
     
 /*-------------------------*/    
 SET @GroupClause = ' GROUP BY ' + @GroupClause + ''    
 /*-------------------------*/     
    
 /*===========================*/    
 SET @OrderClause = ' ORDER BY ' +     
 CASE @AnalyseBy     
  WHEN 'MONH' THEN ' Description'    
  WHEN 'QRTR' THEN ' Description'    
  WHEN 'YEAR' THEN ' Description'    
  ELSE 'Description'    
 END    
 /*===========================*/    
    
    
 /*---------------------------*/    
 SET @sSQL = @SelectClause + @FromClause + @WhereClause + @GroupClause + @OrderClause    
 /*---------------------------*/    
    
--  PRINT '@GroupClause = ' + (@GroupClause)    
--  PRINT '@SelectClause = ' + (@SelectClause)     
--  PRINT '@FromClause = ' + (@FromClause)     
--  PRINT '@WhereClause = ' + (@WhereClause)      
--  PRINT '@OrderClause = ' + (@OrderClause)    
    --PRINT '@sSQL = ' + (@sSQL)    
     
    
 EXEC (@sSQL)    
    
    
-- drop table z_mtbs2    
-- exec ('select * into z_mtbs2 from ' + @sTempTable2 )    
    
 SET @sSQL =  ' SELECT ISNULL(ev.Description, usa.Description) AS Description, (SELECT us.PeriodUsage FROM ' + @sTempTable2 + ' us WHERE ISNULL(us.Description,usa.Description) = usa.Description or ISNULL(us.Description,usa.Description) is null) AS PeriodUsage, (ISNULL(ev.NOOfEvents,0)) AS NOOfEvents FROM ' + @sTempTable + ' ev FULL OUTER JOIN     
                      ' + @sTempTable2 + ' usa ON ev.Description = usa.Description WHERE ISNULL(ev.Description, usa.Description) IS NOT NULL ' --GROUP BY  ev.Description, usa.Description, NOOfEvents'    
    
 /*===========================*/    
 SET @sSQL = @sSQL + ' ORDER BY ' +     
 CASE @AnalyseBy     
  WHEN 'MONH' THEN ' Description'    
  WHEN 'QRTR' THEN ' Description'    
  WHEN 'YEAR' THEN ' Description'    
  ELSE ' CASE WHEN (ISNULL(ev.NOOfEvents,0)) = 0 THEN NULL ELSE (SELECT us.PeriodUsage FROM ' + @sTempTable2 + ' us WHERE ISNULL(us.Description,usa.Description) = usa.Description or ISNULL(us.Description,usa.Description) is null)/(ISNULL(ev.NOOfEvents,0))
  
 END'    
 END    
    
 --print(@sSQL)    
 EXEC (@sSQL)    
 /* 4059 */
 --SET @sSQL = 'SELECT * from ' + @sTempTable3    
 --EXEC(@sSQL)    
 EXEC('DROP TABLE ' + @sTempTable + '  DROP TABLE ' + @sTempTable2) --/* 4059 */ + ' DROP TABLE ' + @sTempTable3)    
    
SET NOCOUNT OFF    
    
GO



if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[RPT_MTBS_MTBF_MTBUPS_Line_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[RPT_MTBS_MTBF_MTBUPS_Line_P]
GO

CREATE PROCEDURE [dbo].[RPT_MTBS_MTBF_MTBUPS_Line_P]
/******************************************************************************
	File: RPT_MTBS_MTBF_MTBUPS_Line_P.sql
	Name: RPT_MTBS_MTBF_MTBUPS_Line_P

	Called By: 

	Desc: 1. Get data set for downtime hours report
             

	Auth: Tasawar Hussain
	Date: 14-Oct-2009
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	30 Apr 12   SD          4059 - Reports Taking too long : missing where criteria in temp table fill so
							re-code temp table 3 as a subquery	
	1-Nov-11	DA			Adding datetime filter to MTBF/MTBS
*******************************************************************************/
	/* Param List */  
    @DealerID int = 1,  
    @BranchId varchar(MAX)='1',  
    @SiteID varchar(MAX)='1',  
    @FleetID varchar(MAX)='1',  
    @EqpPlanID varchar(MAX)='',  
    @ModelID varchar(MAX) = '',  
    @ResponsibilityID varchar(MAX) = '',  
    @TaskTypeID varchar(MAX) = '',  
    @CostTypeId varchar(MAX) = '',  
    @ComponentCodeID varchar(MAX) = '',  
    @Planned int = 1,  
    @Breakdown int = 2,  
    @SystemId varchar(MAX) = '',  
    @SubSystemId varchar(MAX) = '',  
    @StartDate datetime = 'oct 15 2008 12:00:00:000AM',  
    @EndDate datetime = 'oct 15 2009 12:00:00:000AM',   
    @AnalyseBy varchar(4) = 'BRAN',  
    @ShowTotalAs VARCHAR(10)  = 'SUM' OUTPUT,  
    @DateBased varchar(10) = 'False' OUTPUT,  
 @UserID INT=0,  
 @Type varchar(10)='MTBS'  
   
  
AS  
SET NOCOUNT ON  
  
--BY KN  
  
IF @AnalyseBy in ('BRAN','SITE','FLEE','EQPL','MODL','DATE','MONH','QRTR','YEAR')  
         SET @ShowTotalAs = 'SUM'  
ELSE  
        SET @ShowTotalAs = 'AVG'  
  
  
SET  @DateBased= 'False'   
IF @AnalyseBy = 'MONH' OR @AnalyseBy = 'QRTR' OR @AnalyseBy = 'YEAR'    
 BEGIN  
  SET @DateBased = 'True'  
 END  
  
  
 SET @UserId=ISNULL(@UserId,0)  
 DECLARE @Level int  
 SELECT @Level=User_Access_Level_Id From USER_LEVEL_PERMISSION where AMT_User_Id = @UserId  
 SET @Level=ISNULL(@Level,0)  
  
  
  
DECLARE @sSQL as varchar(MAX)  
DECLARE @SQL as varchar(MAX)  
DECLARE @SelectClause as varchar(MAX)  
DECLARE @GroupClause as varchar(MAX)  
DECLARE @FromClause as varchar(MAX)  
DECLARE @WhereClause as varchar(4000)  
DECLARE @OrderClause as varchar(4000)  
-- /* 4059 */ DECLARE @sTempTable3 as varchar(20)    
DECLARE @subQuery as varchar(MAX)     
    
   
DECLARE @sTempTable as varchar(20)  
DECLARE @sTempTable2 as varchar(20)  
--/* 4059 */ DECLARE @sTempTable3 as varchar(20)  
   
--/* 4059 */ SET @sTempTable3 = '##tmpUsages3' + CONVERT(CHAR(4), CONVERT(INT,RAND() * 8999) + 1000)  
  
 CREATE TABLE #TempTable1(AnalyseById int,  
       Description nvarchar(50) COLLATE database_default    
      , NOOfEvents int  
      , CalendarPeriod Varchar(50)  COLLATE database_default        
       )  
  
 CREATE TABLE #TempTable2(  
       AnalyseById int  
      , Description nvarchar(50) COLLATE database_default  
      , PeriodUsage float,  
       CalendarPeriod Varchar(50) COLLATE database_default  
            
       )   
  
SET @SelectClause = ''  
SET @GroupClause = ''  
SET @FromClause = ''  
SET @WhereClause = ''  
SET @OrderClause = ''  
  
 SET @SelectClause = 'INSERT INTO #TempTable1 SELECT '+  
 Case @AnalyseBy  
    
   When 'BRAN' Then 'BranchId  AS AnalyseById '  
   When 'SITE' Then 'SiteId  AS AnalyseById '  
   When 'FLEE' Then 'FleetId   AS AnalyseById'  
   When 'EQPL' Then 'EqpPlanID   AS AnalyseById'  
   when 'TRGT' Then    '1  AS AnalyseById '  
  Else 'BranchId   '  
 END  
   
 SET @SelectClause = @SelectClause  +','+  
   
 CASE @AnalyseBy   
    
  WHEN 'BRAN' THEN 'Branch AS Description'  
  WHEN 'MODL' THEN 'Model AS Description'  
  WHEN 'SITE' THEN 'Site AS Description'  
  WHEN 'FLEE' THEN 'Fleet AS Description'  
  WHEN 'EQPL' THEN 'EqpPlan AS Description'  
  when 'TRGT' Then    '''Actual'' AS Description'  
  ELSE 'Branch AS Description'   
 END   
   
  
  
 SET @SelectClause = @SelectClause + ', COUNT(DISTINCT Event_Id)  '  
 SET @SelectClause = @SelectClause + ', Left(Calendar_Period,4) + ' + CHAR(39) + '-' + CHAR(39) + ' + Right(Calendar_Period,2)  '  
   
   
  
  
 IF @ResponsibilityID <> ''   
  SET @FromClause = ' FROM RPT_MTBS_MTBF_MTBUPS_RESP_V '  
 ELSE  
    
  SET @FromClause = ' FROM RPT_MTBS_MTBF_MTBUPS_V '  
 --DA E#658 - Convert varchar(10) to varchar so that it accepts datetime  
 SET @WhereClause = ' WHERE (Actual_Up_Time >= ' + CHAR(39) + CONVERT(varchar,@StartDate,121) + CHAR(39) + ' AND Actual_Down_Time < ' + CHAR(39) + CONVERT(varchar,@EndDate,121) + CHAR(39) + ')'  
 SET @WhereClause = @WhereClause + ' AND Calendar_Period BETWEEN '+convert(varchar,YEAR(@StartDate)*100+MONTH(@startDate))+' AND '+convert(varchar,YEAR(@EndDate)*100+MONTH(@EndDate)) --AL 06/12/06: to restrict counting WITHIN the defined period  
 If @EqpPlanID <> '' SET @WhereClause = @WhereClause + ' AND EqpPlanID IN (' + @EqpPlanID + ' )'  
 If @FleetID <> '' SET @WhereClause = @WhereClause + ' AND FleetID IN (' + @FleetID + ' )'  
  
 SET @WhereClause = @WhereClause + ' AND ('+CAST(@Level AS varchar(50))+'<>1 OR BranchId In (SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = '+CAST(@UserId AS varchar(50))+'))'  
 SET @WhereClause =@WhereClause + ' AND ('+CAST(@Level AS varchar(50))+'<>2 OR SiteID IN(SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = '+CAST(@UserId AS varchar(50))+'))'  
   
  
  
 If @SiteID <> '' SET @WhereClause = @WhereClause + ' AND SiteID IN (' + @SiteID + ' )'  
 If @BranchId <> '' SET @WhereClause = @WhereClause + ' AND BranchId IN (' + @BranchId + ' )'  
 If @DealerId > 0 SET @WhereClause = @WhereClause + ' AND DealerId = ' + Convert(varchar, @DealerId)  
 IF @ModelID <> ''  SET @WhereClause = @WhereClause + ' AND ModelId IN (' + @ModelID + ')'  
 IF @ResponsibilityID <> ''  SET @WhereClause = @WhereClause + ' AND (Responsibility_Id IN (' + @ResponsibilityID + ') OR Responsibility_Id IS NULL)'  
 IF @TaskTypeID <> ''  SET @WhereClause = @WhereClause + ' AND Task_Type_Id IN (' + @TaskTypeID + ')'  
 IF @CostTypeID <> ''  SET @WhereClause = @WhereClause + ' AND CostTypeID IN (' + @CostTypeID + ')'  
 IF @ComponentCodeID <> ''  SET @WhereClause = @WhereClause + ' AND ComponentCodeId IN (' + @ComponentCodeID + ')'  
   
 SET @WhereClause =   
 CASE @Planned   
  WHEN 2 THEN @WhereClause + ' AND Planned <> 0'   
  WHEN 3 THEN @WhereClause + ' AND Planned = 0'  
  ELSE @WhereClause  
 END  
 SET @WhereClause =   
 CASE @Breakdown   
  WHEN 2 THEN @WhereClause + ' AND Break_Down <> 0'   
  WHEN 3 THEN @WhereClause + ' AND Break_Down = 0'  
  ELSE @WhereClause  
 END  
  
 IF @SystemId <> ''  SET @WhereClause = @WhereClause + ' AND SystemId IN (' + @SystemId + ')'  
 IF @SubSystemId <> ''  SET @WhereClause = @WhereClause + ' AND SubSystemId IN (' + @SubSystemId + ')'  
  
 SET @GroupClause = @GroupClause +' Group By'  
 SET @GroupClause = @GroupClause+  
  
  
      Case @AnalyseBy  
    
       When 'BRAN' Then ' Left(Calendar_Period,4) + ' + CHAR(39) + '-' + CHAR(39) + ' + Right(Calendar_Period,2),BranchId  '  
       When 'SITE' Then  ' Left(Calendar_Period,4) + ' + CHAR(39) + '-' + CHAR(39) + ' + Right(Calendar_Period,2),SiteId '  
       When 'FLEE' Then ' Left(Calendar_Period,4) + ' + CHAR(39) + '-' + CHAR(39) + ' + Right(Calendar_Period,2),FleetId '  
       When 'EQPL' Then ' Left(Calendar_Period,4) + ' + CHAR(39) + '-' + CHAR(39) + ' + Right(Calendar_Period,2),EqpPlanId '  
       when 'TRGT' Then    ' Left(Calendar_Period,4) + ' + CHAR(39) + '-' + CHAR(39) + ' + Right(Calendar_Period,2)'  
      Else 'BranchId  '  
      END  
  
   SET @GroupClause =@GroupClause +','+  
      Case @AnalyseBy  
        When 'BRAN' Then 'Branch  '  
        When 'SITE' Then 'Site '  
        When 'FLEE' Then 'Fleet '  
        When 'EQPL' Then 'EqpPlan '  
       when 'TRGT' Then    ' Left(Calendar_Period,4) + ' + CHAR(39) + '-' + CHAR(39) + ' + Right(Calendar_Period,2)'  
      Else 'Branch '  
      End    
  
  
 SET @OrderClause = ' ORDER BY ' + ' Left(Calendar_Period,4) + ' + CHAR(39) + '-' + CHAR(39) + ' + Right(Calendar_Period,2)  '  
  
 SET @sSQL = @SelectClause + @FromClause + @WhereClause + @GroupClause + @OrderClause  
  
  
 EXEC (@sSQL)  
  
  
SET @SelectClause = ''  
SET @GroupClause = ''  
SET @FromClause = ''  
SET @WhereClause = ''  
SET @OrderClause = ''  
 /* DA E# 658 - Adding datetime filter to MTBF/MTBS */  
SET @SelectClause = '  
 DECLARE @Start DATETIME, @End DATETIME, @currDate DATETIME' + CHAR(13) + '  
    
 SET @Start= ' + CHAR(39) + CONVERT(varchar,@StartDate,121)  + CHAR(39) + CHAR(13) + '  
 SET @End= ' + CHAR(39) + CONVERT(varchar,@EndDate, 121) +  CHAR(39) + CHAR(13) + '  
 SET @currDate = GETDATE()' + CHAR(13) + '  
    
 IF @Start>@currDate SET @Start=@currDate' + CHAR(13) + '  
 IF @End>@currDate SET @End=@currDate' + CHAR(13)  
   
 --/* 4059 */ SET @SelectClause = @SelectClause + ' 
 SET @subQuery =' 
 SELECT     EP.EqpPlan as EqpPlan, B.Branch as Branch, S.Site as Site, F.Fleet as Fleet, RU.CalenderPeriod AS CalendarPeriod,     
       

    /*End Usage*/  
    dbo.GET_USAGE_FROM_DATE_F(EPR.EqpProjId, EPR.EndQUOMId, CASE WHEN @End<RU.PeriodEndDate THEN @End ELSE RU.PeriodEndDate End)  
    -  
    /*Start Usage*/  
    dbo.GET_USAGE_FROM_DATE_F(EPR.EqpProjId, EPR.EndQUOMId,CASE WHEN @Start>RU.PeriodStartDate THEN @Start ELSE RU.PeriodStartDate END) AS PeriodUsageCurr,  
    
   B.DealerId, B.BranchId, S.SiteId, F.FleetId, EP.EqpPlanId,     
   M.Model as Model, M.ModelId ' + --/* 4059 */    INTO  ' + @sTempTable3 + '   
  'FROM         dbo.tblEqpProjs EPR INNER JOIN    
          dbo.tblEqpPlans EP ON EPR.EqpPlanId = EP.EqpPlanId INNER JOIN    
          dbo.tblFleets F ON EP.FleetId = F.FleetId INNER JOIN    
          dbo.tblSites S ON F.SiteId = S.SiteId INNER JOIN    
          dbo.tblBranches B ON S.BranchId = B.BranchId INNER JOIN    
          dbo.tblRepUsages RU ON EPR.EqpProjId = RU.EqpProjID AND ISNULL(EPR.EndQUOMId, 0) = ISNULL(RU.QUOMID, 0) INNER JOIN    
          dbo.tblEquipment E ON EP.EquipmentId = E.EquipmentId INNER JOIN    
          dbo.tblModels M ON E.ModelId = M.ModelId    
   WHERE     (EPR.Projection_Type_ID = 1)    
   AND RU.CalenderPeriod>=year(@Start)*100+MONTH(@Start) and RU.CalenderPeriod<=year(@End)*100+MONTH(@End)' + CHAR(13)  
     
  
  
 SET @SelectClause = @SelectClause + 'INSERT INTO #TempTable2 SELECT '+  
 Case @AnalyseBy  
    
   When 'BRAN' Then 'BranchId  AS AnalyseById '  
   When 'SITE' Then 'SiteId  AS AnalyseById '  
   When 'FLEE' Then 'FleetId   AS AnalyseById'  
   When 'EQPL' Then 'EqpPlanID   AS AnalyseById'  
   when 'TRGT' Then    '1  AS AnalyseById '  
  Else 'BranchId   '  
 END  
   
 SET @SelectClause = @SelectClause  +','+  
   
 CASE @AnalyseBy   
    
  WHEN 'BRAN' THEN 'Branch AS Description'  
  WHEN 'MODL' THEN 'Model AS Description'  
  WHEN 'SITE' THEN 'Site AS Description'  
  WHEN 'FLEE' THEN 'Fleet AS Description'  
  WHEN 'EQPL' THEN 'EqpPlan AS Description'  
  when 'TRGT' Then    '''Actual'' AS Description'  
  ELSE 'Branch AS Description'   
 END   
   
  
 SET @SelectClause = @SelectClause + ' ,SUM(PeriodUsageCurr) AS PeriodUsage'  
 SET @SelectClause = @SelectClause + ', Left(CalendarPeriod,4) + ' + CHAR(39) + '-' + CHAR(39) + ' + Right(CalendarPeriod,2)  '  
   
 --/* 4059 */ SET @FromClause = ' FROM ' + @sTempTable3  
 SET @FromClause = ' FROM (' + @subQuery + ') as sq1 '    

 --SET @WhereClause = ' WHERE (PeriodStartDate >= ' + CHAR(39) + CONVERT(varchar,@StartDate,121) + CHAR(39) + ' AND PeriodEndDate <= ' + CHAR(39) + CONVERT(varchar,@EndDate,121) + CHAR(39) + ')'  
  
 SET @WhereClause = ' WHERE ('+CAST(@Level AS varchar(50))+'<>1 OR BranchId In (SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = '+CAST(@UserId AS varchar(50))+'))'  
 SET @WhereClause =@WhereClause + ' AND ('+CAST(@Level AS varchar(50))+'<>2 OR SiteID IN(SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = '+CAST(@UserId AS varchar(50))+'))'  
   
 If @EqpPlanID <> '' SET @WhereClause = @WhereClause + ' AND EqpPlanID IN (' + @EqpPlanID + ' )'  
 If @FleetID <> '' SET @WhereClause = @WhereClause + ' AND FleetID IN (' + @FleetID + ' )'  
 If @SiteID <> '' SET @WhereClause = @WhereClause + ' AND SiteID IN (' + @SiteID + ' )'  
 If @BranchId <> '' SET @WhereClause = @WhereClause + ' AND BranchId IN (' + @BranchId + ' )'  
 If @DealerId > 0 SET @WhereClause = @WhereClause + ' AND DealerId = ' + Convert(varchar, @DealerId)  
 IF @ModelID <> ''  SET @WhereClause = @WhereClause + ' AND ModelId IN (' + @ModelID + ')' --AL 06/12/06  
   
 SET @GroupClause = @GroupClause +' Group By'  
 SET @GroupClause = @GroupClause+  
  
      Case @AnalyseBy  
    
       When 'BRAN' Then ' Left(CalendarPeriod,4) + ' + CHAR(39) + '-' + CHAR(39) + ' + Right(CalendarPeriod,2),BranchId  '  
       When 'SITE' Then  ' Left(CalendarPeriod,4) + ' + CHAR(39) + '-' + CHAR(39) + ' + Right(CalendarPeriod,2),SiteId '  
       When 'FLEE' Then ' Left(CalendarPeriod,4) + ' + CHAR(39) + '-' + CHAR(39) + ' + Right(CalendarPeriod,2),FleetId '  
       When 'EQPL' Then ' Left(CalendarPeriod,4) + ' + CHAR(39) + '-' + CHAR(39) + ' + Right(CalendarPeriod,2),EqpPlanId '  
       when 'TRGT' Then    ' Left(CalendarPeriod,4) + ' + CHAR(39) + '-' + CHAR(39) + ' + Right(CalendarPeriod,2)'  
      Else 'BranchId  '  
      END  
  
   SET @GroupClause =@GroupClause +','+  
      Case @AnalyseBy  
        When 'BRAN' Then 'Branch  '  
        When 'SITE' Then 'Site '  
        When 'FLEE' Then 'Fleet '  
        When 'EQPL' Then 'EqpPlan '  
       when 'TRGT' Then    ' Left(CalendarPeriod,4) + ' + CHAR(39) + '-' + CHAR(39) + ' + Right(CalendarPeriod,2)'  
      Else 'Branch '  
      End    
  
  
 SET @OrderClause = ' ORDER BY ' + ' Left(CalendarPeriod,4) + ' + CHAR(39) + '-' + CHAR(39) + ' + Right(CalendarPeriod,2)  '  
 SET @sSQL = @SelectClause + @FromClause + @WhereClause + @GroupClause + @OrderClause  
   
  
 EXEC (@sSQL)  
  
   DECLARE @G float  
   DECLARE @N float  
   DECLARE @P float  
  
   DECLARE @G_A float  
   DECLARE @N_A float  
   DECLARE @P_A float  
   
  
--Default KPI for MTBS,MTBF  
  
  SELECT    @G=  
      CASE  WHEN  @Type='MTBS'  THEN ISNULL(Mean_Time_Btwn_Stop,0)   
      WHEN  @Type='MTBF' THEN ISNULL(Mean_Time_Btwn_Failure,0)   
      ELSE 0  
       END  
  FROM KPI_DEFAULT WHERE Kpi_Target_Level='G'   
    
  SELECT    @N=  
      CASE  WHEN  @Type='MTBS'  THEN ISNULL(Mean_Time_Btwn_Stop,0)   
      WHEN  @Type='MTBF' THEN ISNULL(Mean_Time_Btwn_Failure,0)   
      ELSE 0  
       END  
  FROM KPI_DEFAULT WHERE Kpi_Target_Level='N'   
    
  SELECT    @P=  
      CASE  WHEN  @Type='MTBS'  THEN ISNULL(Mean_Time_Btwn_Stop,0)   
      WHEN @Type='MTBF' THEN ISNULL(Mean_Time_Btwn_Failure,0)   
      ELSE 0  
       END  
  FROM KPI_DEFAULT WHERE Kpi_Target_Level='P'   
  
--Target KPI for MTBS,MTBF  
     
   SELECT @G_A= CASE WHEN @Type='MTBS' THEN AVG(ISNULL(Mean_Time_Btwn_Stop,@G))  
         WHEN @Type='MTBF' THEN AVG(ISNULL(Mean_Time_Btwn_Failure,@G))  
       ELSE 0   
       END  
        
   FROM  
   EQUIPMENT_HIERARCHY_V EH  
    LEFT JOIN  
   KPI_TARGET K  
    ON EH.FleetId=K.Fleet_Id AND EH.Projection_Type_Id =1  
   WHERE  
   (@BranchId='' OR EH.BranchId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@BranchId))) AND  
   (@SiteId='' OR EH.SiteId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@SiteId))) AND  
   (@FleetId='' OR EH.FleetId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@FleetId))) AND  
   (@EqpPlanId='' OR EH.EqpPlanId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EqpPlanId))) AND  
   (@ModelId='' OR EH.ModelId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@ModelId)))  
   AND  Kpi_Target_Level='G'  
     
   SELECT @N_A= CASE WHEN @Type='MTBS' THEN AVG(ISNULL(Mean_Time_Btwn_Stop,@N))  
         WHEN @Type='MTBF' THEN AVG(ISNULL(Mean_Time_Btwn_Failure,@N))  
      ELSE 0  
      END  
        
   FROM  
       
   EQUIPMENT_HIERARCHY_V EH  
    LEFT JOIN  
   KPI_TARGET K  
    ON EH.FleetId=K.Fleet_Id AND EH.Projection_Type_Id =1  
   WHERE  
   (@BranchId='' OR EH.BranchId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@BranchId))) AND  
   (@SiteId='' OR EH.SiteId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@SiteId))) AND  
   (@FleetId='' OR EH.FleetId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@FleetId))) AND  
   (@EqpPlanId='' OR EH.EqpPlanId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EqpPlanId))) AND  
   (@ModelId='' OR EH.ModelId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@ModelId)))  
   AND  Kpi_Target_Level='N'  
    
   SELECT @P_A= CASE WHEN @Type='MTBS' THEN AVG(ISNULL(Mean_Time_Btwn_Stop,@P))  
         WHEN @Type='MTBF' THEN AVG(ISNULL(Mean_Time_Btwn_Failure,@P))  
      ELSE 0  
       END  
   FROM  
     
   EQUIPMENT_HIERARCHY_V EH  
    LEFT JOIN  
   KPI_TARGET K  
    ON EH.FleetId=K.Fleet_Id AND EH.Projection_Type_Id =1  
   WHERE  
   (@BranchId='' OR EH.BranchId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@BranchId))) AND  
   (@SiteId='' OR EH.SiteId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@SiteId))) AND  
   (@FleetId='' OR EH.FleetId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@FleetId))) AND  
   (@EqpPlanId='' OR EH.EqpPlanId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EqpPlanId))) AND  
   (@ModelId='' OR EH.ModelId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@ModelId)))  
   AND  Kpi_Target_Level='P'  
  
  
 SET @SelectClause=''  
  
   SET @SelectClause = @SelectClause + '  
  
     SELECT     
      t1.AnalyseById AS AnalyseById  
     , ISNULL(t2.Description,t1.Description) AS AnalyseByName  
     , t1.CalendarPeriod AS CalendarPeriod  
     , CASE WHEN NOOfEvents>0  
       THEN ISNULL(PeriodUsage/NOOfEvents,0)   
      ELSE 0  
      END AS KPI  
    FROM #TempTable2 t1  
    LEFT JOIN #TempTable1 t2 on t1.AnalyseById=isnull(t2.AnalyseById,t1.AnalyseById)  
    AND t1.CalendarPeriod=ISNULL(t2.CalendarPeriod,t1.CalendarPeriod)'  
  
 If @AnalyseBy = 'TRGT'    
  
   Begin  
   SET @SelectClause = @SelectClause + ' UNION ALL '  
   SET @SelectClause = @SelectClause +' SELECT '   
     
   
-----------KPI Good  
      
     SET @SelectClause = @SelectClause +   ' 2 AS AnalyseById ,'  
     SET @SelectClause = @SelectClause +   '''Good'' AS AnalyseByName,'  
     SET @SelectClause = @SelectClause +  'RMV.Month,'  
     SET @SelectClause = @SelectClause +  '' + CHAR(39) + CONVERT(varchar,@G_A) + CHAR(39) + ' '  
   
     SET @SelectClause = @SelectClause +'   
     FROM  
     REPORT_MONTH_V RMV  
     WHERE RMV.Calendar_Period>=YEAR(' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' )*100+MONTH(' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' ) AND   
     RMV.Calendar_Period<=YEAR(' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' )*100+MONTH(' + CHAR(39) + CONVERT(varchar,@ENDDate) + CHAR(39) + ' )'  
  
  
  SET @SelectClause = @SelectClause + ' UNION ALL '  
   SET @SelectClause = @SelectClause +' SELECT '   
     
    
------------KPI Poor  
     
     SET @SelectClause = @SelectClause +   ' 3 AS AnalyseById ,'  
     SET @SelectClause = @SelectClause +   '''Poor'' AS AnalyseByName,'  
     SET @SelectClause = @SelectClause +  'RMV.Month,'  
     SET @SelectClause = @SelectClause +  '' + CHAR(39) + CONVERT(varchar,@P_A) + CHAR(39) + ' '  
   
     SET @SelectClause = @SelectClause +'   
     FROM  
     REPORT_MONTH_V RMV  
     WHERE RMV.Calendar_Period>=YEAR(' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' )*100+MONTH(' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' ) AND   
     RMV.Calendar_Period<=YEAR(' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' )*100+MONTH(' + CHAR(39) + CONVERT(varchar,@ENDDate) + CHAR(39) + ' )'  
    
   SET @SelectClause = @SelectClause + ' UNION ALL '  
   SET @SelectClause = @SelectClause +' SELECT '   
     
    
------------KPI Normal  
      
     SET @SelectClause = @SelectClause +   ' 4 AS AnalyseById ,'  
     SET @SelectClause = @SelectClause +   '''Normal'' AS AnalyseByName,'  
     SET @SelectClause = @SelectClause +  'RMV.Month,'  
     SET @SelectClause = @SelectClause +  '' + CHAR(39) + CONVERT(varchar,@N_A) + CHAR(39) + ' '  
   
     SET @SelectClause = @SelectClause +'   
     FROM  
     REPORT_MONTH_V RMV  
     WHERE RMV.Calendar_Period>=YEAR(' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' )*100+MONTH(' + CHAR(39) + CONVERT(varchar,@StartDate) + CHAR(39) + ' ) AND   
     RMV.Calendar_Period<=YEAR(' + CHAR(39) + CONVERT(varchar,@EndDate) + CHAR(39) + ' )*100+MONTH(' + CHAR(39) + CONVERT(varchar,@ENDDate) + CHAR(39) + ' )'  
  
   END  
  
EXEC (@SelectClause)  
  
 DROP TABLE #TempTable1  
 DROP TABLE #TempTable2  
 --/* 4059 */ EXEC('DROP TABLE ' + @sTempTable3)  
  
  
GO



/****** Object:  StoredProcedure [dbo].[USAGE_PROFILE_UOM_IMPORT_P]    Script Date: 12/13/2011 16:35:54 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[USAGE_PROFILE_UOM_IMPORT_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[USAGE_PROFILE_UOM_IMPORT_P]
GO


/****** Object:  StoredProcedure [dbo].[USAGE_PROFILE_UOM_IMPORT_P]    Script Date: 12/13/2011 16:35:54 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


create  PROCEDURE [dbo].[USAGE_PROFILE_UOM_IMPORT_P]
/******************************************************************************  
 File:   
 Name: USAGE_PROFILE_UOM_IMPORT_P  
 Desc: 1. USAGE_PROFILE_UOM_IMPORT_P  
  
 Auth: Gurdeep Dhillon  
 Date: 12-Dec-2011  
*******************************************************************************  
  Change History  
*******************************************************************************  
 Date:  Author:  Description:  
 -------- -------- ----------------------------------------  
 11 May 12   GD     Fixed 4172
 1  May 12   RJ		Mod 4094
 15 Mar 12   GD     Enhan 753,fixed 3741
 
 --OLD COMMENTS
 05 Jan 12   GD     Fixed 3260, 3266  
 13 Jan 12   GD     Fixed 3309  
 13 Feb 12   GD     Fixed 3449    
*******************************************************************************/  
  /* Param List */  
 @XMLDocument XML,  
 @InterfaceSource INT = 1,  
 @ImportBatchName varchar(1000) = ''  
   
AS  
  
DECLARE @docHandle  INT  
DECLARE @TypeVarchar INT  
DECLARE @TypeFloat INT  
DECLARE @ErrParsing INT  
DECLARE @ErrBusinessRules INT  
DECLARE @CurrDate datetime  
  
SET @TypeVarchar =1  
SET @TypeFloat = 3  
SET @ErrParsing = 1  
SET @ErrBusinessRules = 3  
SET @CurrDate = GETDATE()  
  
  
EXEC sp_xml_preparedocument @docHandle OUTPUT, @xmlDocument  
  
--create table for XML data  
CREATE TABLE #z_Import_UOM(Line_Num int IDENTITY(1,1) NOT NULL,  
UsageProfileID INT,  
UsageProfile VARCHAR(1000) COLLATE DATABASE_DEFAULT,  
UOM VARCHAR(1000) COLLATE DATABASE_DEFAULT,  
UOMDescription varchar(1000) COLLATE DATABASE_DEFAULT,  
AnnualUsage VARCHAR(1000) COLLATE DATABASE_DEFAULT)  
  
  
--Create table for error messages records   
CREATE TABLE #z_Message(MessageId INT IDENTITY(1,1),Line_No INT,  
ErrorDescription VARCHAR(5000) COLLATE DATABASE_DEFAULT,  
ErrorType INT,ImportRecord VARCHAR(MAX) COLLATE DATABASE_DEFAULT  
PRIMARY KEY(MessageId))  
  
--create table for calculating amount  
 CREATE TABLE #UsageProfileAmts (  
 UsageProfileId int NOT NULL,/*VV CR8833*/  
 UsageStepId INT NOT NULL,  
 UsageQUOMId INT NULL,   
 StartDate DATETIME NOT NULL,  
 UsagePerCalYear FLOAT NOT NULL,  
 Usage FLOAT NOT NULL ,  
 CumStartUsage FLOAT NULL,  
 CumEndUsage FLOAT NULL  
 )  
   
  CREATE INDEX #UsageProfileAmts_IDX ON #UsageProfileAmts(UsageStepId, UsageQUOMId)  
  
--create table to hold unique Quoms from the input file  
CREATE TABLE #tempUOM(Short_Desc VARCHAR(1000) COLLATE DATABASE_DEFAULT,UOMShortDesc VARCHAR(1000) COLLATE DATABASE_DEFAULT,  
UOMLongDesc varchar(1000) COLLATE DATABASE_DEFAULT)  
    
  
INSERT INTO #z_Import_UOM(UsageProfile,UOM, UOMDescription , AnnualUsage)  
SELECT   
NULLIF(LTRIM(RTRIM(UsageProfile)),'') AS UsageProfile,  
NULLIF(LTRIM(RTRIM(UOM)),'') AS UOM,  
NULLIF(LTRIM(RTRIM(UOMDescription)),'') AS UOMDescription,  
NULLIF(LTRIM(RTRIM(AnnualUsage)),'') AS AnnualUsage  
FROM OPENXML(@docHandle, N'/UsageProfileUOMs/UsageProfileUOM',2) WITH #z_Import_UOM  

IF EXISTS(SELECT UsageProfile,UOM FROM #z_Import_UOM GROUP BY UsageProfile,UOM HAVING COUNT(*)>1)
BEGIN 
		--Log duplicate rows having same usage profile and UOM
		INSERT INTO #z_Message(ErrorDescription,ErrorType,ImportRecord)
		SELECT 'Duplicate Entry of UOM for Usage Profile ' AS ErrorDescription, @ErrParsing AS ErrorType
		,CASE WHEN @InterfaceSource = 1 THEN 
		(
		SELECT TEMPUOMIMPORT.UsageProfile,TEMPUOMIMPORT.UOM,TEMPUOMIMPORT.UOMDescription,TEMPUOMIMPORT.AnnualUsage FROM  #z_Import_UOM TEMPUOMIMPORT 
		INNER JOIN (SELECT UsageProfile,UOM FROM #z_Import_UOM
													GROUP BY UsageProfile,UOM
													HAVING COUNT(*)>1) TEMP
													ON TEMPUOMIMPORT.UsageProfile=TEMP.UsageProfile  FOR XML PATH('UsageProfileUOM'),ROOT('UsageProfileUOMs')) END  AS ImportRecord 

		--Delete duplicate rows having same usage profile and UOM
		DELETE FROM #z_Import_UOM WHERE Line_Num IN (
													SELECT I.Line_Num
													FROM 
													#z_Import_UOM I
														INNER JOIN
													(SELECT UsageProfile,UOM FROM #z_Import_UOM
													GROUP BY UsageProfile,UOM
													HAVING COUNT(*)>1) TEMP
													ON I.UsageProfile=TEMP.UsageProfile											
													 )
		IF NOT EXISTS(SELECT Line_Num FROM #z_Import_UOM) GOTO FINISH  
END
  
--Check data type  
INSERT INTO #z_Message(Line_No,ErrorDescription,ErrorType,ImportRecord)  
SELECT Line_Num AS Line_No,   
CASE  WHEN UsageProfile IS NULL THEN 'Missing Required Filed:UsageProfile ' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'UsageProfile',50,UsageProfile,0) END +  
CASE  WHEN UOM IS NULL THEN 'Missing Required Filed :UOM ' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'UOM', 50,UOM,0) END +  
dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'UOMDescription', 50,UOMDescription,0)+  
CASE  WHEN AnnualUsage IS NULL THEN 'Missing Required Filed :AnnualUsage ' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'AnnualUsage', 50,AnnualUsage,0) END   
--4094
+ CASE WHEN CAST(AnnualUsage AS FLOAT) = 0 THEN 'Annual Usage can not be zero ' ELSE '' END AS ErrorDescription ,@ErrParsing AS ErrorType,  
CASE WHEN @InterfaceSource = 1 THEN (SELECT UsageProfile,UOM,UOMDescription,AnnualUsage FROM  #z_Import_UOM TEMPUOMIMPORT WHERE TEMPUOMIMPORT.Line_Num = #z_Import_UOM.Line_Num FOR XML PATH('UsageProfileUOM'),ROOT('UsageProfileUOMs')) END  AS ImportRecord 
 
FROM #z_Import_UOM  
  
  
--Delete lines without any error message   
DELETE #z_Message WHERE ErrorDescription = ''   
  
----Delete records having some data type errors  
IF EXISTS(SELECT Line_No FROM #z_Message)  
BEGIN  
 DELETE #z_Import_UOM WHERE Line_Num IN(SELECT Line_No FROM #z_Message)  
END  
  
--If there is no record to process   
IF NOT EXISTS(SELECT Line_Num FROM #z_Import_UOM) GOTO FINISH  
  
-- check that usage profile exist and are not archieved  
UPDATE #z_Import_UOM SET UsageProfileID = UP.UsageProfileId  
FROM #z_Import_UOM  INNER JOIN  
( SELECT usageprofileId, UsageProfile from tblUsageProfiles where tblUsageProfiles.UsageProfile = UsageProfile AND tblUsageProfiles.Archived IS NULL ) UP  
ON #z_Import_UOM.UsageProfile = UP.UsageProfile  
  
--Check data type  
INSERT INTO #z_Message(Line_No,ErrorDescription,ErrorType,ImportRecord)  
SELECT Line_Num AS Line_No,'Usage Profile ' + UsageProfile + ' does not exist ' AS ErrorDescription  
,@ErrBusinessRules AS ErrorType,  
CASE WHEN @InterfaceSource = 1 THEN (SELECT UsageProfile,UOM,UOMDescription,AnnualUsage FROM  #z_Import_UOM TEMPUOMIMPORT WHERE TEMPUOMIMPORT.Line_Num = #z_Import_UOM.Line_Num FOR XML PATH('UsageProfileUOM'),ROOT('UsageProfileUOMs')) END  AS ImportRecord 
 
FROM #z_Import_UOM  
WHERE UsageProfileID IS NULL  
  
--Delete lines without any error message   
DELETE #z_Message WHERE ErrorDescription = ''   
  
----Delete records having some data type errors  
IF EXISTS(SELECT Line_No FROM #z_Message)  
BEGIN  
 DELETE #z_Import_UOM WHERE Line_Num IN(SELECT Line_No FROM #z_Message)  
END  
  
--If there is no record to process   
IF NOT EXISTS(SELECT Line_Num FROM #z_Import_UOM) GOTO FINISH  
  
--get the list of unique Quoms from the file  
INSERT INTO #tempUOM  
SELECT UOM AS Short_Desc,UOM AS UOMShortDesc,CASE WHEN UOMDescription IS NULL THEN UOM ELSE UOMDescription END AS UOMLongDesc  
FROM #z_Import_UOM  
GROUP BY UOM,UOMDescription   
  
--Insert the missing UOMs  
INSERT INTO tblQUOMs(Short_Desc,UOMShortDesc,UOMLongDesc,LastModByUserId,LastModDate,CreateByUserId,CreateDate,QUOMDefault)  
SELECT Short_Desc,UOMShortDesc,UOMLongDesc,  
0 AS LastModByUserId,@CurrDate AS LastModDate,0 AS CreateByUserId, @CurrDate AS CreateDate,0 AS QUOMDefault  
FROM #tempUOM WHERE Short_Desc NOT IN (SELECT Short_Desc FROM tblQUOMs)  

--GD 15/03/12 E753 Update Usage Rate for Current Period From SAP
 UPDATE tblUsageStepRels
 SET ChildUsagePerParentUOM = IUOM.AnnualUsage
 FROM #z_Import_UOM IUOM
 INNER JOIN tblUsageProfiles UP ON IUOM.UsageProfileId = UP.UsageProfileId     
 INNER JOIN tblUsageSteps US ON UP.UsageProfileId = US.UsageProfileId
 INNER JOIN tblQUOMs QUOM ON IUOM.UOM = QUOM.Short_Desc 
 WHERE US.StartDate<=GETDATE() AND us.EndDate>=GETDATE() AND tblUsageStepRels.ParentQUOMId IS NULL 
 AND tblUsageStepRels.ChildQUOMId = QUOM.QUOMId AND  US.UsageStepId = tblUsageStepRels.UsageStepId 
  
--Ignore usage profile already having UOMs  
DELETE FROM #z_Import_UOM WHERE Line_Num IN(SELECT Line_Num FROM #z_Import_UOM INNER JOIN  
(SELECT Distinct(UOM.UsageProfileId), UOM.UsageProfile, tblQUOMs.Short_Desc   
from tblUsageStepRels  USR  
INNER JOIN tblUsageSteps US ON USR.UsageStepId = US.UsageStepId  
INNER JOIN #z_Import_UOM UOM ON UOM.UsageProfileId = US.UsageProfileId  
INNER JOIN tblQUOMs ON tblQUOMs.QUOMId = ChildQUOMId   
WHERE ChildQUOMId IN (SELECT QUOMId FROM tblQUOMs WHERE tblQUOMs.Short_Desc = UOM.UOM )) TEMPQUOM  
ON #z_Import_UOM.UsageProfileId = TEMPQUOM.UsageProfileId   
AND #z_Import_UOM.UOM = TEMPQUOM.Short_Desc  
)  
  
----Delete records having some data type errors  
IF EXISTS(SELECT Line_No FROM #z_Message)  
BEGIN  
 DELETE #z_Import_UOM WHERE Line_Num IN(SELECT Line_No FROM #z_Message)  
END  
  
--If there is no record to process   
IF NOT EXISTS(SELECT Line_Num FROM #z_Import_UOM) GOTO FINISH  
  
--Add UOM to Usage profile if they do not exist (IN tblUsageStepRels table)  
INSERT INTO tblUsageStepRels(UsageStepId, ParentQUOMId, ChildQUOMId, ChildUsagePerParentUOM, EntryLevel)    
 SELECT   
 US.UsageStepId,    
 NULL AS ParentQUOMId,    
 QUOM.QUOMId AS ChildQUOMId,    
 IUOM.AnnualUsage AS ChildUsagePerParentUOM,    
 1 AS EntryLevel    
 FROM #z_Import_UOM IUOM  
  INNER JOIN tblUsageProfiles UP ON IUOM.UsageProfileId = UP.UsageProfileId   
  INNER JOIN tblUsageSteps US ON UP.UsageProfileId = US.UsageProfileId  
  INNER JOIN tblQUOMs QUOM ON IUOM.UOM = QUOM.Short_Desc  
  WHERE QUOM.QUOMId NOT IN (  
  SELECT ChildQUOMId from tblUsageStepRels  USR1  
  INNER JOIN tblUsageSteps US1 ON USR1.UsageStepId = US.UsageStepId    
  )     
  
  
--usagestep amts  
;WITH UsageStepAmts_CTE(UsageProfileId,UsageStepId,ParentQUOMId,ChildQUOMId,ChildUsagePerParentUOM)  
AS  
(  
 SELECT     
 UP.UsageProfileId,    
 USR.UsageStepId,    
 USR.ParentQUOMId,  
 USR.ChildQUOMId,    
 USR.ChildUsagePerParentUOM      
     
 FROM           
  #z_Import_UOM AS UP   
  INNER JOIN tblUsageSteps AS US ON UP.UsageProfileId = US.UsageProfileId  
  INNER JOIN tblUsageStepRels AS USR ON USR.UsageStepId = US.UsageStepId  
    
 WHERE  
  USR.ParentQUOMId IS NULL  
 UNION ALL  
 SELECT   
  M.UsageProfileId,  
  USRE.UsageStepId,    
  USRE.ParentQUOMId,   
  USRE.ChildQUOMId,      
  USRE.ChildUsagePerParentUOM  * M.ChildUsagePerParentUOM  
 FROM   
   tblUsageStepRels USRE INNER JOIN   
   UsageStepAmts_CTE AS M ON USRE.UsageStepId = M.UsageStepId AND USRE.ParentQUOMId = ISNULL(M.ChildQUOMId,0)  
    
)  
INSERT INTO #UsageProfileAmts(UsageProfileId, UsageStepId, UsageQUOMId, StartDate, UsagePerCalYear, Usage)  
SELECT  
 CTE.UsageProfileId,  
 CTE.UsageStepId,  
 CTE.ChildQUOMId ,  
 US.StartDate,  
 CTE.ChildUsagePerParentUOM,   
 DATEDIFF(DAY, Us.StartDate ,US.EndDate )* CTE.ChildUsagePerParentUOM/365.25   
FROM   
 UsageStepAmts_CTE CTE  
 INNER JOIN tblUsageSteps AS US ON US.UsageStepId = CTE.UsageStepId  
 INNER JOIN (  
    SELECT UsageProfileId, MIN(StartDate) AS MinStartDate FROM tblUsageSteps GROUP BY UsageProfileId  
    ) minstdt ON minstdt.UsageProfileId = US.UsageProfileId  
ORDER BY CTE.ChildQUOMId ,US.StartDate  
OPTION (MAXRECURSION 0);  
  

UPDATE main  
SET   
CumEndUsage=( SELECT SUM(Usage)  
FROM #UsageProfileAmts total WHERE total.UsageProfileId=main.UsageProfileId/*VV CR8833*/ and   
total.UsageQUOMId = main.UsageQUOMId AND total.StartDate <= main.StartDate )  
FROM #UsageProfileAmts main   
  
UPDATE main  
SET   
CumStartUsage= CumEndUsage - Usage  
FROM #UsageProfileAmts main   
 
--GD 11/05/12 4172 delete rows which already exists
DELETE FROM #UsageProfileAmts
WHERE EXISTS
 (SELECT * FROM #UsageProfileAmts 
 INNER JOIN tblUsageStepAmts ON #UsageProfileAmts.UsageStepId = tblUsageStepAmts.UsageStepId
 AND #UsageProfileAmts.UsageQUOMId = tblUsageStepAmts.UsageQUOMId)
 
INSERT INTO tblUsageStepAmts (UsageStepId, UsageQUOMId, UsagePerCalYear, CumStartUsage, CumEndUsage)    
SELECT Distinct UsageStepId, UsageQUOMId, UsagePerCalYear, CumStartUsage, CumEndUsage FROM #UsageProfileAmts  
  
--Update Equipment details  
DECLARE @Message VARCHAR(MAX)  
DECLARE @EqpPlanId INT    
DECLARE @EquipmentId INT    
DECLARE @StartDate DATETIME    
DECLARE @QUOMId INT    
DECLARE @Msg VARCHAR(max)    
DECLARE @EqpPlan varchar(100)    
DECLARE @LineNo INT  
SET @Msg = ''   
   
DECLARE Cur CURSOR FAST_FORWARD FOR    
SELECT    
 EP.EqpPlanId,EP.EquipmentId, EP.StartDate, UP.ChildQUOMId,EP.EqpPlan, UP.Line_Num  
FROM     
(    
 SELECT DISTINCT    
 UP.UsageProfileId, USR.ChildQUOMId ,Line_Num   
 FROM             
  #z_Import_UOM AS UP     
  INNER JOIN tblUsageSteps AS US ON UP.UsageProfileId = US.UsageProfileId    
  INNER JOIN tblUsageStepRels AS USR ON USR.UsageStepId = US.UsageStepId    
) UP INNER JOIN     
(    
SELECT        
 DISTINCT tblEqpPlans.EqpPlanId, tblEqpPlans.EquipmentId, tblEqpPlans.StartDate, tblEqpProjs.ProjUsageProfileId,    
 tblEqpPlans.EqpPlan    
FROM   tblEqpPlans     
INNER JOIN tblEqpProjs ON tblEqpPlans.EqpPlanId = tblEqpProjs.EqpPlanId    
) EP     
ON UP.UsageProfileId = EP.ProjUsageProfileId    
WHERE NOT EXISTS (SELECT StartUsageQUOMId from tblEqpPlanStartUsages WHERE StartUsageQUOMId = UP.ChildQUOMId AND EqpPlanId = EP.EqpPlanId)    
    
OPEN Cur    
FETCH NEXT FROM Cur INTO @EqpPlanId,@EquipmentId, @StartDate, @QUOMId,@EqpPlan,@LineNo  
WHILE @@FETCH_STATUS = 0    
BEGIN    
 EXEC EQUIP_PLAN_START_USAGE_ADD_P @EquipmentId =@EquipmentId,    
       @StartDate =@StartDate,     
       @StartUsageQuomId =@QUOMId,    
       @StartUsage =0,    
       @EqpPlanId =@EqpPlanId,    
       @StartUsageId=NULL,    
       @Message=@Msg OUTPUT   
       
IF(ISNULL(@Msg,'')<>'')    
BEGIN    
 SET @Message = @Message +'Equipment '+@EqpPlan+': '+ ISNULL(@Msg,'')     
 INSERT INTO #z_Message(Line_No,ErrorDescription,ErrorType,ImportRecord)   
 SELECT @LineNo, @Message, @ErrBusinessRules AS ErrorType ,CASE WHEN @InterfaceSource = 1 THEN (SELECT UsageProfile,UOM,UOMDescription,AnnualUsage FROM  #z_Import_UOM TEMPUOMIMPORT WHERE TEMPUOMIMPORT.Line_Num = @LineNo FOR XML PATH('UsageProfileUOM'),ROOT('UsageProfileUOMs')) END  AS ImportRecord   
END    
           
FETCH NEXT FROM Cur INTO @EqpPlanId,@EquipmentId, @StartDate, @QUOMId,@EqpPlan ,@LineNo   
END    
CLOSE Cur    
DEALLOCATE Cur    
    
FINISH:  
  
IF EXISTS(SELECT MessageId FROM #z_Message)  
BEGIN  
 INSERT INTO IMPORT_ERROR(ImportFileName,Line_No,ErrorDescription,ImportErrorTypeId,LastModDate,ImportRecord,ImportSourceId)  
 SELECT @ImportBatchName AS ImportFileName,CASE WHEN @InterfaceSource = 0 THEN Line_No END,ErrorDescription,  
 ISNULL(ErrorType,@ErrBusinessRules) AS ImportErrorTypeId,   
 @CurrDate AS LastModDate,CONVERT(VARCHAR(MAX),ImportRecord),@InterfaceSource AS ImportSourceId  
 FROM #z_Message  
END   
  
--Drop temporary tables  
DROP TABLE #z_Message  
DROP TABLE #z_Import_UOM  
DROP TABLE #UsageProfileAmts  
DROP TABLE #tempUOM        

GO


if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[TASK_CHECK_STRATEGY_DETAILS_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[TASK_CHECK_STRATEGY_DETAILS_P]
GO


create      PROCEDURE [dbo].[TASK_CHECK_STRATEGY_DETAILS_P]
/******************************************************************************
	File: 
	Name: TASK_CHECK_STRATEGY_DETAILS_P


	Called By: n/a
	Desc:
	If select codes (Task Type, Component Code, Modifier Code, Application Code) 
	such that these now match a strategy Task in AMT, then:
	-	If this strategy task already exists in Equipment Status then 
		disallow the save of the task and give the user a message.
	-	If the strategy task does not exist in EQS AND 
		the Occurrence Type has not been set or 
		the Occurrence type = the Occurrence type from tblProjTasks 
		THEN populate the Occurrence Type and other Strategy Task fields 
		with the data from table tblProjTasks 
		(ie call an update for the relevant Projected Task)
	-	If the strategy task does not exist in EQS AND the Occurrence Type 
		IS NOT the same as the occurrence type from tblProjTasks THEN 
		populate the Occurrence Type and other Strategy Task fields with 
		the data from table tblProjTasks, 
		
		- 12-Apr-2007 VV This was taken out. Discussed with GE

		SAVE the record, and then with the record still open give the user 
		a message to reselect the Occurrence type.  
		This will force the user to select a valid Occurrence type. 

             
	Auth: Veronika Vasylyeva
	Date: 12 NOV 2002
*******************************************************************************
		Change History
*******************************************************************************
Date:		Author:		Description:
--------	--------	----------------------------------------
03 APR 12   SD			E773 - Remove MaxPlanning WO check
26 Aug 11	V Vasylyeva	#2351 : set occurrence type to the default
18 Mar 11	V Vasylyeva	#1427: Do not include IP workorders into check if created for the consistency 
						with strategy task creating maintaining
09 Dec 09	AL			CR8556: FMG Change - can have multiple strategy tasks at the same time
13 May 09	V Vasylyeva	CR8036: If NextOccDate is null - take the earliest occurrence date for the strategy task 
								(tblProjTaskOccs). 	if there are no future occurrencies - set the end date of equipment
28 Oct 08	V Vasylyeva	CR7599: Added check for unscheduled tasks,
						Set also all strategy details to NULL if strategy task does not exist
12 Jun 08	AL			Changed Repair Description size
21 Feb 08	AL			Changed PlanDateLocked to ReviewStatusID
12 Jun 07	V Vasylyeva	Added @CheckOccType,@GetLabourHrs
11 Apr 07	V Vasylyeva	Added @FinalChange,@RiskLifeLeft,@StrategyFrequency,@LastPerformed ,
						@LastScheduled,@LastPerformedDate,@LastScheduledDate
						Took out the changing of occurrence type to the planned option
						occurrence type and warning.
13 Apr 04	V Vasylyeva	Removed Task planned
16 Sep 03	H Singh		new field added in update and insert statements - Strategy_Repair_Description
30-Jan-2003	V Vasylyeva	Added an input parameter @CheckIfCreated to 
				indicate do we need to check if the strategy task
				has already been created in EQS. This parameter
				is set to 0 - do not check if the completed task
				is checked. This parameter shall be set to 1 - check
				if the task has status YTS, InProgress or Outstanding
*******************************************************************************/
	
@Task_ID int=Null,
@Eqp_Plan_ID int,
@CheckIfCreated bit,
@Task_Type_ID int OUTPUT,
@Component_Code_ID int OUTPUT,
@Application_Code_ID int OUTPUT,
@Modifier_ID int OUTPUT,
@Occurrence_Type_Id int OUTPUT,
@Expected_Duration float=NULL OUTPUT,
@Expected_Labor_Hours float=NULL OUTPUT,
@Strategy_Usage float=NULL OUTPUT,
@Strategy_Repair_Description varchar(MAX)=null OUTPUT,
@Strategy_QUOM_ID int=NULL OUTPUT,
@Proj_Task_Opt_ID int=NULL OUTPUT,
@Strategy_Date datetime=NULL OUTPUT,
@Strategy_Locked bit=0 OUTPUT,
@Message varchar(2000)=NULL OUTPUT,
@FinalChange float =0 OUTPUT,
@RiskLifeLeft float =0 OUTPUT,
@StrategyFrequency float =0 OUTPUT,
@LastPerformed float=0 OUTPUT,
@LastScheduled float =0 OUTPUT,
@LastPerformedDate datetime=NULL OUTPUT,
@LastScheduledDate datetime=NULL OUTPUT,
@ProjTaskId int=0 OUTPUT,
@CheckOccType bit=1,
@GetLabourHrs bit=1

AS



DECLARE @Task_Status_Outstanding int
DECLARE @Task_Status_YTS int
DECLARE @Task_Status_InProgress int
DECLARE @ProjTypeCurrent int
DECLARE @LastOcc float
DECLARE @UseSchedulingSystemLastOcc bit
DECLARE @First float
DECLARE @EndUsage float
DECLARE @EndDate datetime
DECLARE @Counter int


SET @Task_Status_Outstanding =1
SET @Task_Status_YTS =6
SET @Task_Status_InProgress =2

SET @CheckIfCreated=ISNULL(@CheckIfCreated,0)
SET @ProjTypeCurrent=1

--If the validation is performing for a new task set task_id=0
SET @Task_ID=ISNULL(@Task_ID,0)

--AMT variables
SELECT @UseSchedulingSystemLastOcc=UseSchedulingSystemLastOcc FROM AMT_VARIABLE

SET @ProjTaskId=ISNULL(@ProjTaskId,0)

--Find a strategy task with the selected codes if exists
IF @ProjTaskId>0
BEGIN
	SELECT 
	@Component_Code_ID=PT.ComponentCodeId,
	@Modifier_ID=PT.ModifierId,
	@Task_Type_ID=PT.TaskTypeId,
	@Application_Code_ID=PT.ApplicationCodeId,
	@Strategy_Repair_Description=ISNULL(NOS.Repair_Description, ''),
	@Strategy_Usage =PT.NextOcc,
	@Strategy_QUOM_ID=PT.UsageQUOMId,
	@Strategy_Date =PT.NextOccDate,
	@Strategy_Locked=CASE WHEN PT.ReviewStatusID=3 THEN CONVERT(BIT,1) ELSE CONVERT(BIT,0) END,
	@LastPerformed =CASE WHEN @UseSchedulingSystemLastOcc =1 AND SchedulingTaskId>0 THEN Ext_Last_Occ ELSE AMT_WO_Last_Occ END,
	@LastScheduled =CASE WHEN @UseSchedulingSystemLastOcc =1 AND SchedulingTaskId>0 THEN Ext_Last_Sched_Occ ELSE AMT_Last_Sched_Occ END,
	@LastPerformedDate=CASE WHEN @UseSchedulingSystemLastOcc =1 AND SchedulingTaskId>0 THEN Ext_Last_Occ_Date ELSE AMT_WO_Last_Occ_Date END,
	@LastScheduledDate=CASE WHEN @UseSchedulingSystemLastOcc =1 AND SchedulingTaskId>0 THEN Ext_Last_Sched_Date ELSE AMT_Last_Sched_Date END, 
	@LastOcc=PT.LastOcc,
	@EndUsage=CASE WHEN ISNULL(EPR.EndQUOMId,0)=ISNULL(PT.UsageQUOMId,0) THEN EPR.EndUsage 
				   ELSE dbo.GET_EQP_PROJ_END_USAGE_F(EPR.EqpProjId, PT.UsageQUOMID,EPR.EndDate) END,
	@EndDate=EPR.EndDate
	FROM         
	tblProjTasks PT
		INNER JOIN
	tblEqpProjs EPR
		ON PT.EqpProjId = EPR.EqpProjId AND PT.EqpPlanId = EPR.EqpPlanId 
		LEFT OUTER JOIN
	NEXT_OCC_STRATEGY NOS 
		ON PT.ProjTaskId = NOS.Proj_Task_Id
	WHERE 
	(PT.ProjTaskId=@ProjTaskId) AND
	(EPR.Projection_Type_Id =@ProjTypeCurrent) AND
	(PT.EqpPlanId=@Eqp_Plan_ID)
	/*VV 28-Oct-08*/AND (PT.Unscheduled=0)
	
	SET @Counter=@@ROWCOUNT

	IF @Counter=0 SET @ProjTaskId=0
	

END--IF @ProjTaskId>0
ELSE
BEGIN
	SELECT 
	@ProjTaskId=PT.ProjTaskId,
	@Strategy_Repair_Description=ISNULL(NOS.Repair_Description, ''),
	@Strategy_Usage =PT.NextOcc,
	@Strategy_QUOM_ID=PT.UsageQUOMId,
	@Strategy_Date =PT.NextOccDate,
	@Strategy_Locked=CASE WHEN PT.ReviewStatusID=3 THEN CONVERT(BIT,1) ELSE CONVERT(BIT,0) END,
	@LastPerformed =CASE WHEN @UseSchedulingSystemLastOcc =1 AND SchedulingTaskId>0 THEN Ext_Last_Occ ELSE AMT_WO_Last_Occ END,
	@LastScheduled =CASE WHEN @UseSchedulingSystemLastOcc =1 AND SchedulingTaskId>0 THEN Ext_Last_Sched_Occ ELSE AMT_Last_Sched_Occ END,
	@LastPerformedDate=CASE WHEN @UseSchedulingSystemLastOcc =1 AND SchedulingTaskId>0 THEN Ext_Last_Occ_Date ELSE AMT_WO_Last_Occ_Date END,
	@LastScheduledDate=CASE WHEN @UseSchedulingSystemLastOcc =1 AND SchedulingTaskId>0 THEN Ext_Last_Sched_Date ELSE AMT_Last_Sched_Date END, 
	@LastOcc=PT.LastOcc,
	@EndUsage=CASE WHEN ISNULL(EPR.EndQUOMId,0)=ISNULL(PT.UsageQUOMId,0) THEN EPR.EndUsage 
				   ELSE dbo.GET_EQP_PROJ_END_USAGE_F(EPR.EqpProjId, PT.UsageQUOMID,EPR.EndDate) END,
	@EndDate=EPR.EndDate
	FROM         
	tblProjTasks PT
		INNER JOIN
	tblEqpProjs EPR
		ON PT.EqpProjId = EPR.EqpProjId AND PT.EqpPlanId = EPR.EqpPlanId 
		LEFT OUTER JOIN
	NEXT_OCC_STRATEGY NOS 
		ON PT.ProjTaskId = NOS.Proj_Task_Id
	WHERE 
	(EPR.Projection_Type_Id =@ProjTypeCurrent) AND
	(PT.EqpPlanId=@Eqp_Plan_ID) AND
	(PT.ComponentCodeId=@Component_Code_ID) AND
	(PT.ModifierId=@Modifier_ID) AND
	(PT.TaskTypeId=@Task_Type_ID) AND
	(PT.ApplicationCodeId=@Application_Code_ID) AND
	/*VV 28-Oct-08*/(PT.Unscheduled=0)
END

--If the strategy task does not exist return
IF ISNULL(@ProjTaskId,0)=0 
BEGIN
	/*VV 28-Oct-2008 Set also all strategy details to NULL before return*/
	SET @Proj_Task_Opt_ID=NULL
	SET @Strategy_Usage =0
	SET @Strategy_Repair_Description =''
	SET @Strategy_QUOM_ID =NULL
	SET @Strategy_Date =NULL
	SET @Strategy_Locked =0
	SET @FinalChange  =0
	SET @RiskLifeLeft  =0
	SET @StrategyFrequency  =0
	SET @LastPerformed =NULL
	SET @LastScheduled  =NULL
	SET @LastPerformedDate =NULL
	SET @LastScheduledDate =NULL

	RETURN

END

--Check if the strategy task exists in EQS

--AL: 09/12/09
DECLARE @MaxPlanningWOtoCreate int
/*E773*/ --SELECT @MaxPlanningWOtoCreate=ISNULL(Varchar_Value,1) FROM AMT_TYPED_VARIABLE WHERE Value_Name ='MaxPlanningWOtoCreate'
SET @MaxPlanningWOtoCreate = 1


IF @CheckIfCreated=1 AND ISNULL(@MaxPlanningWOtoCreate,1) = 1
BEGIN
	IF EXISTS(SELECT TASK.Task_Id
		FROM    
		TASK INNER JOIN
		tblProjTaskOpts ON TASK.Strategy_Proj_Task_Opt_ID = tblProjTaskOpts.ProjTaskOptId 
		INNER JOIN
		tblProjTasks ON tblProjTaskOpts.ProjTaskId = tblProjTasks.ProjTaskId
		WHERE (TASK.Task_ID<>@Task_ID) AND
		(TASK.Task_Status_ID = @Task_Status_Outstanding OR
		TASK.Task_Status_ID = @Task_Status_YTS /* VV #1427 OR
		TASK.Task_Status_ID = @Task_Status_InProgress*/) AND 	
		(tblProjTasks.ProjTaskId=@ProjTaskId))
	
		BEGIN		
			-- - If this strategy task already exists in Equipment Status then 
			-- disallow the save of the task and give the user a message.
			SET @Task_Type_ID =NULL
			SET @Component_Code_ID =NULL
			SET @Application_Code_ID =NULL
			SET @Modifier_ID =NULL			
			
			SET @Message='Cannot save. This strategy task has already been created.'
			RETURN
		END
END

--Check Occurence type
IF @CheckOccType=1
BEGIN
	--select the option for Occurrence_Type_Id
	--If the occurence type the user selected does not match the projected
	-- task options use the planned option 

	SELECT @Proj_Task_Opt_ID=ProjTaskOptId FROM tblProjTaskOpts 
	WHERE (ProjTaskId=@ProjTaskId) /*VV #2351 AND (OccurrenceTypeId=@Occurrence_Type_Id)*/

END

IF @Proj_Task_Opt_ID IS NULL
BEGIN
	-- 12-Apr-2007 VV Discussed with GE. The warning message to reselect occurence type 
	--was taken out. Occurrence type is not taken from the default option in this case.

	--SET @Message='The strategy task was saved with the planned option details. Please reselect the Occurence Type.'
	SELECT @Proj_Task_Opt_ID = ProjTaskOptId FROM tblProjTaskOpts 
	WHERE (ProjTaskId=@ProjTaskId) /*VV #2351 AND (PlannedOption>0 OR PlannedOption<0)*/
END

--Final change usage
SELECT @FinalChange=MAX(OccUsage) FROM tblProjTaskOccs WHERE ProjTaskId=@ProjTaskId

SELECT @StrategyFrequency =Frequency,@First=[First] FROM tblProjTaskOpts WHERE ProjTaskOptId=@Proj_Task_Opt_ID

SET @FinalChange=ISNULL(ISNULL(@FinalChange,@LastOcc),@First)

--SET @RiskLifeLeft =100.00*(@StrategyFrequency-(@EndUsage - @FinalChange ))/NULLIF(@StrategyFrequency,0)
SET @RiskLifeLeft =dbo.RISK_LIFE_LEFT_F(@StrategyFrequency,@EndUsage,@FinalChange)

IF @GetLabourHrs=1
BEGIN	
	--Select the strategy details
	SELECT  @Expected_Labor_Hours=SUM(LaborHours), @Expected_Duration=SUM(Duration) 
	FROM tblProjTaskAmts WHERE ProjTaskOptId=@Proj_Task_Opt_ID
END

--VV 13-May-2009 CR8036
IF @Strategy_Date IS NULL
BEGIN
	/*If NextOccDate is null - take the earliest occurrence date for the strategy task (tblProjTaskOccs) 
	if there are no future occurrencies - set the end date.*/
	SELECT @Strategy_Date=MIN(OccDate),@Strategy_Usage=MIN(OccUsage )
	FROM tblProjTaskOccs WHERE ProjTaskId=@ProjTaskId
END

SET @Strategy_Date=ISNULL(@Strategy_Date,@EndDate)
SET @Strategy_Usage=ISNULL(@Strategy_Usage,@EndUsage)

GO


if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[EVENT_TASKS_DELETE_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[EVENT_TASKS_DELETE_P]
GO


 
create         Procedure [dbo].[EVENT_TASKS_DELETE_P]
/******************************************************************************
	File:
	Name: EVENT_TASKS_DELETE_P

	Called By: 

	Desc: 1. Deletes TASKS from Deferred_Task table
	      2. Set task status to Outstanding and unlinks task from event
             

	Auth: Veronika Vasylyeva
	Date: 28-AUG-2002
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	03 APR 12   SD			E773 - Remove MaxPlanning WO check	
	23 Apr 11	D Smith		#1331: Fixed terminology of some error messages
	25 Jun 10	V Vasylyeva	CR8985: Discussed with RF:If workorder was abandoned in Event
							unlink it from Event and do  not change status to outstanding.
	29 Mar 10	AL			CR8865: Check if Health Safety Auditable
	09 Dec 09	AL			CR8556: FMG Change - can have multiple strategy tasks at the same time
	10-Nov-2009	V Vasylyeva	CR8411 If there are duplicate strategy backlogs exist
							give the user a message
	15-Jun-2007	V Vasylyeva	Chenges for the new planning module
	30 Jan 2006	V vasylyeva	exec TASK_WORK_ORDER_LINK_MULTI_P to relink workorders
	05-Jul-2004	V Vasylyeva	Transaction isolation level, nolock, updatelock,rowlock
	8-Jan-2003	V Vasylyeva	Set Primary_Cause flag to 0 for the
					backlog tasks.
					Removed the dynamic SQL and replaced it 
					with CHARINDEX (...)
    	19-Sep-2002	V Vasylyeva	Delete records from Deferred_Task table
					Set Task.Event_ID=Null
*******************************************************************************/
	/* Param List */
	@Event_ID int,
	@Event_Last_Mod_Date varchar(25)=NULL,
    @Tasks varchar(8000),
	@Error_Number int = 0 OUTPUT,
	@Message varchar(8000) OUTPUT,
	@UnlinkAll bit=0
     
AS
Set TRANSACTION ISOLATION LEVEL READ COMMITTED
--Check that Event was not changed


DECLARE @TaskStatusOUS int
DECLARE @tasksToRelink varchar(8000)
DECLARE @TaskStatusYTS int
/*VV CR8985*/
DECLARE @TaskStatusA int

SET @TaskStatusOUS=1
SET @Message=''
SET @TaskStatusYTS=6
/*VV CR8985*/
SET @TaskStatusA=5

DECLARE @z_TASK TABLE (TaskId int,Strategy_Proj_Task_Opt_ID int PRIMARY KEY(TaskId))

IF @UnlinkAll=1
BEGIN
	INSERT INTO @z_TASK(TaskId,Strategy_Proj_Task_Opt_ID)
	SELECT Task_ID,
	/*VV CR8985*/
	CASE Task_Status_ID WHEN @TaskStatusA THEN NULL ELSE Strategy_Proj_Task_Opt_ID END AS Strategy_Proj_Task_Opt_ID
	FROM TASK WHERE Event_ID=@Event_ID
END
ELSE
BEGIN

	INSERT INTO @z_TASK(TaskId,Strategy_Proj_Task_Opt_ID)
	SELECT LTT.list_item,
	/*VV CR8985*/
	CASE Task_Status_ID WHEN @TaskStatusA THEN NULL ELSE Strategy_Proj_Task_Opt_ID END AS Strategy_Proj_Task_Opt_ID
	FROM 
	dbo.LIST_TO_TABLE_F(@Tasks) LTT
		INNER JOIN
	TASK T
		ON LTT.list_item=T.Task_ID
	
	--Cannot delete primary cause task
	IF EXISTS(SELECT Task_Id FROM 
		@z_TASK Z 
			INNER JOIN 
		TASK T ON Z.TaskId=T.Task_Id 
		WHERE T.Event_id=@Event_Id  AND T.Primary_Cause=1)
	BEGIN
		SET @Message='The Primary Workorder cannot be deleted.'
		RETURN
	END

	IF EXISTS(SELECT Task_Id FROM 
		@z_TASK Z 
			INNER JOIN 
		DEFERRED_TASK DT ON Z.TaskId=DT.Task_Id 
		WHERE DT.Event_id=@Event_Id  AND DT.Primary_Cause=1)
	BEGIN
		SET @Message='The Primary Workorder cannot be deleted.'
		RETURN
	END

	--cannot delete the last task in the event
	IF (SELECT COUNT(Task_Id) FROM 
			TASK T LEFT OUTER JOIN
			@z_TASK Z ON T.Task_Id=Z.TaskId
			WHERE T.Event_id=@Event_Id AND Z.TaskId IS NULL)=0
	BEGIN
		SET @Message='Cannot delete the last Workorder in an Event.'
		RETURN
	END
	
	--AL: 29/03/10					
	IF EXISTS(SELECT TT.TaskId
	FROM
			@z_TASK TT INNER JOIN
			TASK T ON TT.TaskId=T.Task_ID LEFT OUTER JOIN
			HEALTH_SAFETY HS ON T.Health_Safety_Id=HS.Health_Safety_Id
	WHERE
			HS.AuditableRecord<>0)
	BEGIN
		SET @Message='Cannot delete auditable OH&S Workorder.'
		RETURN
	END

	
END

SET @Message=''

/*This is for the workorders which are deleted in Event. There can be duplicate
strategy workorders in Event*/

--AL: 09/12/09
DECLARE @MaxPlanningWOtoCreate int
/*E773*/--SELECT @MaxPlanningWOtoCreate=ISNULL(Varchar_Value,1) FROM AMT_TYPED_VARIABLE WHERE Value_Name ='MaxPlanningWOtoCreate'
SET @MaxPlanningWOtoCreate = 1


IF ISNULL(@MaxPlanningWOtoCreate,1) = 1
BEGIN
	SELECT @Message=@Message+A.TaskDesc+'
	'
	FROM
	(SELECT T.Task_ID,T.Description AS TaskDesc
	FROM 
	TASK T
		INNER JOIN
	(SELECT Strategy_Proj_Task_Opt_ID FROM @z_TASK 
	GROUP BY Strategy_Proj_Task_Opt_ID HAVING COUNT(TaskId)>1) Z
		ON T.Strategy_Proj_Task_Opt_ID=Z.Strategy_Proj_Task_Opt_ID
		INNER JOIN
	@z_TASK X
		ON T.Task_ID=X.TaskId
	) A
	ORDER BY A.TaskDesc

	IF @Message<>''
	BEGIN
		SET @Message='Deleting workorders will create duplicate strategy backlogs:
	'+@Message
		RETURN
	END

	SELECT @Message=@Message+A.TaskDesc+'
	'
	FROM
	(SELECT DISTINCT T.Task_ID,T.Description AS TaskDesc
	FROM 
	TASK T
		INNER JOIN
	@z_TASK Z
		ON T.Strategy_Proj_Task_Opt_ID=Z.Strategy_Proj_Task_Opt_ID
		AND T.Task_ID<>Z.TaskId
	WHERE T.Task_Status_ID=@TaskStatusOUS OR T.Task_Status_ID=@TaskStatusYTS
	) A
	ORDER BY A.TaskDesc

	IF @Message<>''
	BEGIN
		SET @Message='Deleting Workorders would create duplicate Strategy Backlogs:
	'+@Message
		RETURN
	END
END

--Delete From Deferred Tasks table
IF EXISTS(
SELECT Event_ID FROM 
DEFERRED_TASK DT
	INNER JOIN
@z_TASK T
	ON DT.Task_Id=T.TaskId AND DT.Event_Id=@Event_ID)
BEGIN
	DELETE DT WITH (ROWLOCK, UPDLOCK)
	FROM
	DEFERRED_TASK DT
		INNER JOIN
	@z_TASK T
		ON DT.Task_Id=T.TaskId AND DT.Event_Id=@Event_ID
END


--Check if the tasks shall be relinked
SET @tasksToRelink = ''

SELECT @tasksToRelink = @tasksToRelink + CAST(T.Task_ID AS varchar) + ','
FROM  
@z_TASK Z
	INNER JOIN		
TASK T 
	ON Z.TaskId=T.Task_Id
	LEFT OUTER JOIN
DEFERRED_TASK DT 
	ON T.Event_ID = DT.Event_ID AND T.Task_ID = DT.Task_ID
WHERE
(DT.Deferred_Task_ID IS NULL) AND	
(T.Event_ID =@Event_ID ) AND 
(T.Work_Order_ID IS NOT NULL)

-- Update Tasks table. 
--Set Event_ID=Null if the task is not assigned to any other Event
--Change Task status to Outstanding so it can go to Backlogs list
--Set Primary Cause Flag=0

UPDATE T WITH(ROWLOCK,UPDLOCK)
SET T.Event_ID=NULL, 
/*VV CR8985*/
T.Task_Status_ID=CASE T.Task_Status_ID WHEN @TaskStatusA THEN @TaskStatusA ELSE @TaskStatusOUS END,
T.Primary_Cause=0,
T.Last_Mod_Date=GETDATE()
FROM
TASK T
	INNER JOIN
@z_TASK Z
	ON T.Task_Id=Z.TaskId
WHERE
(T.Event_ID =@Event_ID )		
		
IF @tasksToRelink<>''
BEGIN
	SET @tasksToRelink=LEFT(@tasksToRelink,LEN(@tasksToRelink)-1)
	EXEC TASK_WORK_ORDER_LINK_MULTI_P @TasksID=@tasksToRelink
END


GO


if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[STRATEGY_TASK_ADD_TO_EVENT_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[STRATEGY_TASK_ADD_TO_EVENT_P]
GO


create  Procedure STRATEGY_TASK_ADD_TO_EVENT_P
/******************************************************************************
	File: 
	Name: STRATEGY_TASK_ADD_TO_EVENT_P

	Called By: EQS

	Desc: refer to DESIGN_EQS_3.doc, 1.1.2.2. Strategy Task Wizard Logic (diagramm)
	      	
	******************************************************************
	
	

	Auth: Veronika Vasylyeva
	Date: 4-Nov-2002
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	03 APR 12   SD			E773 - Remove MaxPlanning WO check	
	14 Feb 11	V Vasylyeva	AmtMobile
	09 Dec 09	AL			CR8556: FMG Change - can have multiple strategy tasks at the same time
	13 Oct 09	V Vasylyeva	CR8304: Planning changes
	10 Jun 07	V Vasylyeva	Changes for new planning module
	24 Jan 07	V Vasylyeva	Added performed by date
	15 May 05	V Vasylyeva	Left outer join to next_occ_strategy
	27 Oct 05	V Vasylyeva	Repair code changes: 
					If a proj task opt has 1 job then repair code=proj job. job code
					If a proj task opt has more than 1 job then repair code= default repair code
					Use TASK_GET_DEFAULTS_P instead of STRATEGY_EQS_TASK_DEFAULTS_P
					for the consistensy with strategy_task_creating_maintaining_p
	13 Oct 2005	V Vasylyeva	Cost Bearer
	13 Apr 2004	V Vasylyeva	Removed Task_Planned
	09 Feb 04	V Vasylyeva	New task defaults
					@Parts_Resources_Identified,
					@Labour_Resources_Identified,
					@Location_Identified,
					@Tooling_Resources_Identified
	27 Nov 03	V Vasylyeva	Fixed Bug in Task Insert
	16 Sep 03	H Singh		new field added in update and insert statements - Strategy_Repair_Description
	18-Feb-2003	V Vasylyeva	When a strategy task is created in Backlog
					Repair_Code is Job Code from PROJ_TASK_AMTS_SUM_GROUP_BY_PROJ_TASK_OPT_ID_V
    	19-Nov-2002	V Vasylyeva	Return all backlogs for the selected
					EqpPlan if @Task_ID_Exclude is not null
					Return just selected Strategy task
					if @Task_ID_Exclude is null.
*******************************************************************************/
	/* Param List */


    	@ProjTaskOptId int,-- tblProjTaskOpts.ProjTaskOptId 
    	@AddEventId int=0, -- <=0  the strategy task is to be added to a new event; 
						   -- >0 - the strategy task is to be added to an existing event    
		@Event_ID int =NULL OUTPUT,--event id assigned to a strategy task
    	@Task_ID int =NULL OUTPUT, --task_id assigned to an event which need to be updated
									--with new strategy details
		@EqpPlanID int,
		@UserId int=0,
		@Message varchar(8000) OUTPUT,
		/*AmtMobile*/
		@CopyEWTemplateFiles bit=0 OUTPUT

AS


DECLARE @TaskStatusOUS int
DECLARE @TaskStatusYTS int
DECLARE @TaskStatusIP int

DECLARE @EventStatusYTS int

DECLARE @Event_Status_ID int
DECLARE @Tasks varchar(20)
DECLARE @ProjTaskOptIdOld int
DECLARE @ProjTaskId int
DECLARE @TaskHeader varchar(1000)

SET NOCOUNT ON
--Set values from the system tables
SET @TaskStatusOUS=1
SET @TaskStatusYTS=6
SET @TaskStatusIP=2

SET @EventStatusYTS=1
SET @Message=''

SET XACT_ABORT ON

IF ISNULL(@AddEventId,0)<=0 SET @AddEventId=NULL

--Check if the task for the selected @ProjTaskOptId exists as a part of EQS event
SELECT 
@Task_ID=T.Task_ID,@Event_ID=T.Event_ID, @Event_Status_ID=E.Event_Status_ID,
@ProjTaskOptIdOld=T.Strategy_Proj_Task_Opt_ID, @ProjTaskId=PT.ProjTaskId,
@TaskHeader=TH.Description
FROM
tblProjTasks PT
	INNER JOIN
tblProjTaskOpts PTO
	ON PT.ProjTaskId=PTO.ProjTaskId
	INNER JOIN
TASK T
	ON PTO.ProjTaskOptId=T.Strategy_Proj_Task_Opt_ID
	LEFT JOIN
TASK_HEADER TH
	ON PT.Task_Header_Id=TH.Task_Header_Id
	LEFT OUTER JOIN 
EVENT E
ON T.Event_ID = E.Event_ID
WHERE 
(PTO.ProjTaskOptId=@ProjTaskOptId) AND 
(T.Task_Status_Id IN(@TaskStatusOUS,@TaskStatusYTS,@TaskStatusIP))


--AL: 09/12/09
DECLARE @MaxPlanningWOtoCreate int
/*E773*/ --SELECT @MaxPlanningWOtoCreate=ISNULL(Varchar_Value,1) FROM AMT_TYPED_VARIABLE WHERE Value_Name ='MaxPlanningWOtoCreate'
SET @MaxPlanningWOtoCreate = 1

IF ISNULL(@MaxPlanningWOtoCreate,1) = 1
BEGIN
	SET @Event_ID=ISNULL(@Event_ID,0)
	SET @Task_ID=ISNULL(@Task_ID,0)
END
ELSE
BEGIN
	SET @Event_ID=0
	SET @Task_ID=0
END


IF @Event_ID>0
--The strategy task with option @ProjTaskOptId was assigned to an event
BEGIN
	IF @AddEventId>0 				
	BEGIN
		-- the task cannot be added to an event, 
		-- it has already been assigned to the other event 
		SET @Event_ID=0
		SET @Task_ID=0
		SET @Message = 'Strategy Task '+@TaskHeader+' has already been assigned to an Event.
 You will need to either Defer or Complete the task in the Event in which it is already assigned.'
		RETURN
	END				
	ELSE
	--the user is adding a strategy task to a new event
	BEGIN
		SET @Task_ID=0
		SET @Message = 'Strategy Task '+@TaskHeader+' already exists in Event.'
		RETURN
	END
END

--Event_ID is null. Check that strategy task was created in Backlog

IF @Task_ID=0
--The strategy task was not created in the Backlog
--Create Task for Event
BEGIN
	
	EXEC TASK_DEFAULT_ADD_GET_P
			@Eqp_Plan_ID =@EqpPlanID,
			@EventId=@AddEventId, 
			@Proj_Task_Opt_Id =@ProjTaskOptId,
			@Std_Job_Id =NULL,
			@PricedJobId =NULL,
			@TaskDefaults =1, 
			@Add =1,
			@UserId =@UserId,
			@TaskId =@Task_ID OUTPUT,
			@CopyEWTemplateFiles=@CopyEWTemplateFiles OUTPUT

			SET @Tasks=CAST(@Task_Id AS varchar)

			
END
ELSE
	-- The strategy task exists in Backlog. 
	-- Update the task with with the selected option details
	-- (VV 12-Jun-2007 changes for new planning) update task with event_id if it is null
	-- to add the task to event
BEGIN

	SET @Tasks=CAST(@Task_Id AS varchar)

	--Update the backlog task
	--with the selected option details
	IF @ProjTaskOptIdOld<>@ProjTaskOptId
	BEGIN
		--This will update the strategy details and link to event
		EXEC TASK_UPDATE_STRAT_DET_P
				@ProjTaskId =@ProjTaskId,
				@ProjTaskOptId =@ProjTaskOptId,
				@EventId=@AddEventId, 
				@TaskID =@Task_ID,
				@EqpPlanID =@EqpPlanID,
				@UserId =@UserId,
				@Message=@Message OUTPUT

			IF ISNULL(@Message,'')<>'' 
			BEGIN
				SET @Task_ID=0
				RETURN
			END
	END
	ELSE IF @AddEventId>0
	--proj task opt did not change. Check if the
	--task need to be added to event
	BEGIN
		EXEC EXPRESS_ADD_BACKLOGS_TO_EVENT_P 
				@Backlogs=@Tasks,
				@Event_ID =@AddEventId,
				@Error_Number=0,
				@Message =@Message OUTPUT

		IF ISNULL(@Message,'')<>'' 
		BEGIN
			SET @Task_ID=0
			RETURN
		END
	END
	
END

/*
--Return data for tasks grid in Event form
IF @AddEventId>0
BEGIN
	EXEC EVENT_TASKS_GET_P @EventId =@AddEventId, @Tasks=@Tasks	
END
ELSE
BEGIN
	EXEC BACKLOGS_SELECTED_GET_P @Backlogs=@Tasks
END
*/





GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[EVENT_ADD_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[EVENT_ADD_P]

GO

create   Procedure [dbo].[EVENT_ADD_P]  
/******************************************************************************  
 File:   
 Name: EVENT_ADD_P  
  
 Called By:   
  
 Desc: 1. Add Event   
       2. Return id new Event  
               
  
 Auth: Veronika Vasylyeva  
 Date: 22-AUG-2002  
*******************************************************************************  
  Change History  
*******************************************************************************  
 Date:  Author:  Description:  
 -------- -------- ----------------------------------------  
 01 May 2012	JW  4001 Save 3 extra columns when add a new tasks
 18 Nov 2011	DA	#2747: workorder higher approval tick disappears when workorder saved
 20 Jul 2011	V Vasylyeva	E602: serialised Component
 27 Apr 2011	RJ	Issue 1188 - Increase field sizes
 24 Mar 2011	V Vasylyeva added default value NULL to @UniqueKey
  7 Jan 2011	V Vasylyeva AmtMobile changes
 23 Dec 2010	DS		#804: Use UserID from EVENT when creating new TASK ("Workorder")
 13 Oct 2010	V Vasylyeva	#641 added @ShutdownID int=NULL
 28 Jun 2010 V Vasylyeva CR9000: Took out seconds of actual/planned downtime  
 22 Jun 2010 V Vasylyeva CR8985: Added @PrimaryTaskId
 11 Feb 2010 V Vasylyeva CR8776: new parameters in EVENT_BUSINESS_RULES_P  
  3 Dec 2009 V Vasylyeva CR8562: Give the user a message if 2 in progress events are created  
  9 Oct 2009 V Vasylyeva CR8304: Default values for parameters which are not used any more  
 25 Jun 09 AL   CR8290: error when entering xml reserved char in description  
 04 Apr 09 AL   CR7970: workorder renaming  
 19 Mar 09 AL   CR7932: always have @UpdateWO=1 for ACW changes  
 13 Feb 09 AL   CR7874: added missing Task update fields  
 11 Feb 09 AL   CR7847: changes for express add task  
 10 Feb 09 AL   CR7845: change size of symptom, cause and repair desc and @Planning_Notes to 8,000  
 09 Feb 09 AL   CR7844: Task authorisation  
 22 Dec 08 AL   CR7798: Changed TASK.RaisedByID  
 22-May-2008 A Lass.  changed @Planning_Notes to be varchar(MAX)  
 21-Jul-2007 A Lass.  CR6255: pass @PerformUsageValidation to SMU_VALIDATION_P  
 20 Jun 2007 V Vasylyeva changes for new planning module  
 22-Nov-2006 V Vasylyeva Set QUOM_Id to Null for the date-based equipment  
 06 Oct 2006 P Joy  Added Released By  
 23 Mar 2004 V Vasylyeva Added EXEC usp_Update_RepProjBilling  
 18 Mar 2004 V Vasylyeva Added Exchange Rate  
 17 Mar 2004 V Vasylyeva Added call to TEST_TIME_MAINT_P  
 12-Mar-2004 V Vasylyeva Added TestTime  
     29-Aug-2002 V Vasylyeva Changed the SP to add event only, adding  
     default dta and task was deleted  
 3-Sep-2002 V Vasylyeva Added SMU validation  
 23-Sep-2002 V Vasylyeva Added check for Event status  
*******************************************************************************/  
 /* Param List */  
   
 @Eqp_Plan_ID int,   
 @Description varchar(500),   
 @Event_Status_ID int,   
 @Priority_ID int,   
 @Work_Location_ID int,   
 @Planned bit,   
 @Break_Down bit,   
 @Expected_Up_Time datetime,   
 @Confirmed bit,   
 @Event_Prevention_ID int,   
 @Planned_Down_Time datetime,   
 @Planned_Down_Usage float=0,   
 @Planned_Up_Time datetime,   
 @Planned_Up_Usage float=0,   
 @Actual_Down_Time datetime,   
 @Actual_Down_Usage float=0,   
 @Actual_Up_Time datetime,   
 @Actual_Up_Usage float=0,   
 @Notes varchar(2500)=NULL,   
 @Down_Delay_Notes varchar(1000)=NULL,   
 @Down_Delay_Hrs float=0,   
 @Down_Delay_ID int=NULL,   
 @Event_Mode_ID int=1,/*VV AmtMobile*/ 
 @Has_Down_Time bit=1,/*VV AmtMobile*/    
 @New_Event bit=1,/*VV AmtMobile*/    
 @Repair_Details varchar(100)=NULL,   
 @QUOM_ID int=NULL,  
 @Create_By_User_ID int=0,   
 @NewEvent_ID int OUTPUT,  
 @Error_Number int = 0 output,  
 @From_Usage float = 0 output,  
 @To_Usage float = 0 output,  
 @TestTime float=0,  
 @RelesedByID int,  
 @Message varchar(8000)='' OUTPUT,  
 @TaskXml text='',  
 @opDeleted varchar(8000)='',  
 @pDeleted varchar(8000)='',  
 @labDeleted varchar(8000)='',  
 @miscDeleted varchar(8000)='',  
 @poDeleted varchar(8000)='',  
 @libDeleted varchar(8000)='',  
 @UpdateWO bit=0,  
 @OpReplaced bit=0,  
 @opAdded text='',      
 @opModified text='',  
 @Task_ID int=0 OUTPUT,  
 /*VV CR8985*/  
 @PrimaryTaskId int=0,
 /*VV #641*/ 
 @ShutdownID int=NULL,
  /*VV AmtMobile*/ 
 @UniqueKey varchar(50)=NULL/*VV 24-Mar-2011*/,
 @CopyEWTemplateFiles bit=0 OUTPUT
    
AS  
  
--SMU Validation  
DECLARE @return_status int  
DECLARE @ERR_EVENT_SAVE_INPROGRESS_STATUS int-- look at modConstants  
Declare @Event_Status_ID_InProgress int  
Declare @Event_Status_ID_Completed int  
  
DECLARE @ExRateID int  
DECLARE @EqpProjID int  
DECLARE @Recalc_Billings bit  
DECLARE @hDoc int  
  
  
DECLARE @TaskDesc varchar(500)  
DECLARE @Task_Type_ID int  
DECLARE @Component_Code_ID int  
DECLARE @Modifier_ID int  
DECLARE @Application_Code_ID int  
DECLARE @Occurrence_Type_Id int  
DECLARE @TPriority_ID int  
DECLARE @Source_ID int  
DECLARE @Task_Status_ID int  
DECLARE @Date_Notified datetime  
DECLARE @Component_ID varchar(100)  
DECLARE @Symptom_ID int  
DECLARE @Symptom_Notes varchar(8000) --AL: 10/02/09  
DECLARE @Cause_ID int  
DECLARE @Cause_Notes varchar(8000)  --AL: 10/02/09  
DECLARE @Repair_Code_ID int  
DECLARE @Repair_Notes varchar(8000)  --AL: 10/02/09  
DECLARE @Group_No varchar(50)  
DECLARE @Part_No varchar(50)  
DECLARE @EMI_Ref varchar(50)  
DECLARE @EMIssueId int  
DECLARE @Redo bit  
DECLARE @Task_Planned_Time_ID int  
DECLARE @Customer_Ref varchar(100)  
DECLARE @Employee_ID int  
DECLARE @Expected_Duration float  
DECLARE @Expected_Labor_Hours float  
DECLARE @Planning_Notes varchar(8000) --AL: 22/05/08, 10/02/09  
DECLARE @Work_Order varchar(50)  
DECLARE @Actual_Duration float  
DECLARE @Actual_Labor_Hrs float                  
DECLARE @Primary_Cause bit  
DECLARE @TNotes varchar(1000)  
DECLARE @Task_Mode_ID int  
--DECLARE @Parts_Resources_Identified bit  
DECLARE @PartsStatusRequired bit  
DECLARE @PartsStatusOrdered bit  
DECLARE @PartsStatusReady bit  
--AL: 22/12/08  
--DECLARE @Raised_By varchar(50)  
DECLARE @RaisedByID int  
DECLARE @Work_Order_ID int  
DECLARE @Work_Group_ID int  
DECLARE @Strategy_Usage float  
DECLARE @Strategy_QUOM_ID int  
DECLARE @Strategy_Proj_Task_Opt_ID int  
DECLARE @Planned_Proj_Task_Opt_ID int  
DECLARE @Strategy_Date datetime  
DECLARE @Strategy_Locked bit  
DECLARE @Task_Last_Mod_Date varchar(25)  
--RJ: 27/04/2011
DECLARE @Part_Description  varchar(1000)  
DECLARE @Group_Description varchar(1000)  
DECLARE @SIMS_Code_Id int  
DECLARE @Sort_Order int  
DECLARE @WO_Create_Date datetime  
DECLARE @Performed_By_Date datetime  
DECLARE @Parts_Available_Date datetime  
DECLARE @WO_Counter int  
DECLARE @Work_Order_Number_External varchar(50)  
DECLARE @Cost_Bearer_ID int  
DECLARE @Task_Warranty bit  
DECLARE @Redo_Work_Order_ID int  
-- new parameters  
DECLARE @ViewWarranty bit  
DECLARE @HealthSafetyId int  
DECLARE @BreakDown bit  
DECLARE @PlannedDownTime datetime   
DECLARE @ActualDownTime datetime   
DECLARE @PlannedOffset float  
DECLARE @SiteId int  
DECLARE @WorkLocation varchar(100)  
DECLARE @CostCentreId int  
DECLARE @BranchId int  
DECLARE @CustomerId int   
DECLARE @PartEntryDistributionCodeId int  
DECLARE @DefWorkGroupId int   
DECLARE @PartsCostExpenseId int   
DECLARE @LabourCostExpenseId int   
DECLARE @MiscCostExpenseId int   
DECLARE @SpecificOperationCodes bit   
DECLARE @WorkOrderDate datetime  
DECLARE @WarrantyClaimable bit  
DECLARE @ReviewedEmployeeId int   
DECLARE @WarrantyNotes varchar(500)   
DECLARE @WarrantyDays float   
DECLARE @WarrantyUsage float   
DECLARE @WarrantyDaysArchived float   
DECLARE @WarrantyUsageAcrhived float   
DECLARE @WarrantySupplierId int   
DECLARE @ClaimRef varchar(20)  
DECLARE @SupplierRef varchar(20)   
DECLARE @SummaryDescription varchar(200)  
DECLARE @ClaimStatusId int   
DECLARE @ClaimedByEmployeeId int   
DECLARE @ClaimeDate datetime   
DECLARE @ClaimDescription varchar(1000)   
DECLARE @JobPartsCost float  
DECLARE @JobLabourCost float  
DECLARE @JobMiscCost float  
DECLARE @ClaimedPartsCost float  
DECLARE @ClaimedLabourCost float  
DECLARE @ClaimedMiscCost float   
DECLARE @RecPartsCost float  
DECLARE @RecLabourCost float   
DECLARE @RecMiscCost float   
DECLARE @LabourEntryDistributionCodeId int   
DECLARE @MiscEntryDistributionCodeId int  
DECLARE @SupplierContact varchar(100)  
DECLARE @TaskAuthorised bit   
DECLARE @ProjTaskId int  
DECLARE @ActualOffset float  
DECLARE @Strategy_Repair_Description varchar(100)  
DECLARE @AMTPlanningModeId int  
DECLARE @CreateWO bit  
DECLARE @TaskAuthorisationAmount float --AL: 09/02/09  
DECLARE @ExpressAddTaskInstruction varchar(8000) --AL: 11/02/09  
--AL: 13/02/09  
DECLARE @ChangeoutCategoryId int  
DECLARE @LifeConfirmed bit   
DECLARE @OriginalPartTypeId int  
/*VV E602*/
DECLARE @SerialNoIn int  
DECLARE @SerialNoOut int  
DECLARE @IsOverwriteLife bit   
DECLARE @OverwriteLifeAchieved float   
DECLARE @WOClosed bit  
DECLARE @LastNotified datetime  
DECLARE @AuthorisationRequestByID int --DA 2747   
  
  
  
  
DECLARE @TaskStatusD int  
SET @TaskStatusD =4  
  
SET @Event_Status_ID_InProgress=2  
SET @Event_Status_ID_Completed=3  
  
/*VV CR9000*/  
SET @Actual_Down_Time= dbo.FORMAT_DAY_MONTH_YEAR_HRS_MIN_F(@Actual_Down_Time)  
SET @Actual_Up_Time= dbo.FORMAT_DAY_MONTH_YEAR_HRS_MIN_F(@Actual_Up_Time)  
SET @Planned_Up_Time= dbo.FORMAT_DAY_MONTH_YEAR_HRS_MIN_F(@Planned_Up_Time)  
SET @Planned_Down_Time= dbo.FORMAT_DAY_MONTH_YEAR_HRS_MIN_F(@Planned_Down_Time)  
  
--22-Nov-2006 VV  
SET @QUOM_ID=NULLIF(@QUOM_ID,0)  
  
SET @ERR_EVENT_SAVE_INPROGRESS_STATUS=10-- look at modConstants  
  
--There can only be one In Progress event at a time for a piece of Equipment  
--There can only be one In Progress event at a time for a piece of Equipment  
IF @Event_Status_ID=@Event_Status_ID_InProgress  
 BEGIN  
  set @return_status=0  
  EXEC @return_status = EVENT_STATUS_CHECK_P @Eqp_Plan_ID   
        
    IF @return_status>0  
     BEGIN  
      SET @Error_Number=@ERR_EVENT_SAVE_INPROGRESS_STATUS  
      /*VV CR8562*/  
      SET @Message='There can only be one In Progress event at a time for a piece of Equipment.'  
      RETURN   
     END  
 END  
  
--Check that the primary task is supplied  
IF DATALENGTH(@TaskXml)=0 AND /*VV CR8985*/ ISNULL(@PrimaryTaskId,0)=0  
BEGIN  
 SET @Message='Event must contain at least one Workorder.'   
 RETURN  
END  


  
/*VV CR8985*/  
IF ISNULL(@PrimaryTaskId,0)>0  
BEGIN  
 SELECT   
 @Task_ID =Task_ID,  
 @TaskDesc=Description,  
 @Task_Type_ID=Task_Type_ID,   
 @Component_Code_ID=Component_Code_ID,   
 @Modifier_ID=Modifier_ID,   
 @Application_Code_ID=Application_Code_ID,   
 @Occurrence_Type_Id=Occurrence_Type_Id,   
 @TPriority_ID=Priority_ID,   
 @Source_ID=Source_ID,   
 @Task_Status_ID=dbo.TASK_STATUS_FOR_EVENT_F(@Event_Status_ID,Task_Status_ID),   
 @Date_Notified=Date_Notified,   
 @Component_ID=Component_ID,   
 @Symptom_ID=Symptom_ID,   
 @Symptom_Notes=Symptom_Notes,   
 @Cause_ID=Cause_ID,   
 @Cause_Notes=Cause_Notes,   
 @Repair_Code_ID=Repair_Code_ID,   
 @Repair_Notes=Repair_Notes,   
 @Group_No=Group_No,   
 @Part_No=Part_No,   
 @EMI_Ref=EMI_Ref,   
 @EMIssueId=EM_Issue_Id,  
 @Redo=Redo,   
 @Task_Planned_Time_ID=Task_Planned_Time_ID,   
 @Customer_Ref=Customer_Ref,   
 @Employee_ID=Employee_ID,   
 @Expected_Duration=Expected_Duration,   
 @Expected_Labor_Hours=Expected_Labor_Hours,  
 @Planning_Notes=Planning_Notes,   
 @Actual_Duration=Actual_Duration,   
 @Actual_Labor_Hrs=Actual_Labor_Hrs,  
 @Primary_Cause=Primary_Cause,   
 @TNotes=Notes,  
 @Task_Mode_ID=Task_Mode_ID,  
 @PartsStatusRequired=PartsStatusRequired,  
 @PartsStatusOrdered=PartsStatusOrdered,  
 @PartsStatusReady=PartsStatusReady,  
 @RaisedByID=RaisedByID,  
 @Work_Group_ID=Work_Group_ID,  
 @Strategy_Usage=Strategy_Usage,  
 @Strategy_Repair_Description=Strategy_Repair_Description ,  
 @Strategy_QUOM_ID=Strategy_QUOM_ID,  
 @Strategy_Proj_Task_Opt_ID=Strategy_Proj_Task_Opt_ID,  
 @Planned_Proj_Task_Opt_ID=Planned_Proj_Task_Opt_ID,  
 @Strategy_Date=Strategy_Date,  
 @Strategy_Locked=Strategy_Locked,  
 @Part_Description=Part_Description ,  
 @Group_Description=Group_Description,  
 @SIMS_Code_Id=SIMS_Code_Id,  
 @Create_By_User_ID=Create_By_User_ID,  
 @Task_Last_Mod_Date=NULL,  
 @Sort_Order=Sort_Order,  
 @WO_Create_Date=WO_Create_Date,  
 @Performed_By_Date=Performed_By_Date ,  
 @WO_Counter=WO_Counter,  
 @Work_Order_Number_External=Work_Order_Number_External,  
 @Cost_Bearer_ID=Cost_Bearer_ID,  
 @Task_Warranty=Task_Warranty,  
 @Redo_Work_Order_ID=Redo_Work_Order_ID,  
 @Redo=Redo,  
 @ViewWarranty=View_Warranty,  
 @HealthSafetyId=Health_Safety_Id,  
 @BreakDown=Break_Down,  
 @PlannedDownTime=Planned_Down_Time,  
 @ActualDownTime=Actual_Down_Time,  
 @PlannedOffset=Planned_Offset,  
 @ActualOffset=ActualOffset,  
 @SiteId=Site_Id,  
 @WorkLocation=Work_Location,  
 @CostCentreId=Cost_Centre_Id,  
 @BranchId=Branch_Id,  
 @CustomerId=Customer_Id,  
 @PartEntryDistributionCodeId=Part_Entry_Distribution_Code_Id,  
 @DefWorkGroupId=Def_Work_Group_Id,  
 @PartsCostExpenseId=Parts_Cost_Expense_Id,  
 @LabourCostExpenseId=Labour_Cost_Expense_Id,  
 @MiscCostExpenseId=Misc_Cost_Expense_Id,  
 @SpecificOperationCodes=Specific_Operation_Codes,  
 @WorkOrderDate=Work_Order_Date,  
 @WarrantyClaimable=Warranty_Claimable,  
 @ReviewedEmployeeId=Reviewed_Employee_Id,  
 @WarrantyNotes=Warranty_Notes,  
 @WarrantyDays=Warranty_Days,  
 @WarrantyUsage=Warranty_Usage,  
 @WarrantyDaysArchived=Warranty_Days_Archived,  
 @WarrantyUsageAcrhived=Warranty_Usage_Acrhived,  
 @WarrantySupplierId=Warranty_Supplier_Id,  
 @ClaimRef=Claim_Ref,  
 @SupplierRef=Supplier_Ref,  
 @SummaryDescription=Summary_Description,  
 @ClaimStatusId=Claim_Status_Id,  
 @ClaimedByEmployeeId=Claimed_By_Employee_Id,  
 @ClaimeDate=Claime_Date,  
 @ClaimDescription=Claim_Description,  
 @JobPartsCost=Job_Parts_Cost,  
 @JobLabourCost=Job_Labour_Cost,  
 @JobMiscCost=Job_Misc_Cost,  
 @ClaimedPartsCost=Claimed_Parts_Cost,  
 @ClaimedLabourCost=Claimed_Labour_Cost,  
 @ClaimedMiscCost=Claimed_Misc_Cost,  
 @RecPartsCost=Rec_Parts_Cost,  
 @RecLabourCost=Rec_Labour_Cost,  
 @RecMiscCost=Rec_Misc_Cost,  
 @LabourEntryDistributionCodeId=Labour_Entry_Distribution_Code_Id,  
 @MiscEntryDistributionCodeId=Misc_Entry_Distribution_Code_Id,  
 @SupplierContact=Supplier_Contact,  
 @TaskAuthorised=Task_Authorised ,  
 @AMTPlanningModeId=AMTPlanningModeId,  
 @ProjTaskId=0,  
 @Work_Order_Id=Work_Order_Id,  
 @CreateWO=0,  
 @TaskAuthorisationAmount=Task_Authorised_Amount,  
 @ExpressAddTaskInstruction=NULL,  
 @ChangeoutCategoryId=ChangeoutCategoryId,  
 @LifeConfirmed =LifeConfirmed,   
 @OriginalPartTypeId =OriginalPartTypeId,  
 @SerialNoIn =SerialNoInId,  
 @SerialNoOut =SerialNoOutId,  
 @IsOverwriteLife =IsOverwriteLife,   
 @OverwriteLifeAchieved =OverwriteLifeAchieved,   
 @WOClosed=0,  
 @LastNotified=LastNotified,
 @AuthorisationRequestByID = AuthorisationRequestByID  --DA 2747   
 FROM TASK WHERE Task_ID=@PrimaryTaskId  
 
END  
ELSE  
BEGIN  
 EXEC sp_xml_preparedocument @hDoc OUTPUT, @TaskXml   
  
 SELECT   
 @Task_ID =Task_ID,  
 @TaskDesc=dbo.XML_FRIENDLY_STRING_F(Description,0,0), --AL: 25/06/09  
 @Task_Type_ID=Task_Type_ID,   
 @Component_Code_ID=Component_Code_ID,   
 @Modifier_ID=Modifier_ID,   
 @Application_Code_ID=Application_Code_ID,   
 @Occurrence_Type_Id=Occurrence_Type_Id,   
 @TPriority_ID=Priority_ID,   
 @Source_ID=Source_ID,   
 @Task_Status_ID=Task_Status_ID,   
 @Date_Notified=Date_Notified,   
 @Component_ID=Component_ID,   
 @Symptom_ID=Symptom_ID,   
 @Symptom_Notes=Symptom_Notes,   
 @Cause_ID=Cause_ID,   
 @Cause_Notes=Cause_Notes,   
 @Repair_Code_ID=Repair_Code_ID,   
 @Repair_Notes=Repair_Notes,   
 @Group_No=Group_No,   
 @Part_No=Part_No,   
 @EMI_Ref=EMI_Ref,   
 @EMIssueId=EM_Issue_Id,  
 @Redo=Redo,   
 @Task_Planned_Time_ID=Task_Planned_Time_ID,   
 @Customer_Ref=Customer_Ref,   
 @Employee_ID=Employee_ID,   
 @Expected_Duration=Expected_Duration,   
 @Expected_Labor_Hours=Expected_Labor_Hours,  
 @Planning_Notes=Planning_Notes,   
 @Actual_Duration=Actual_Duration,   
 @Actual_Labor_Hrs=Actual_Labor_Hrs,  
 @Primary_Cause=Primary_Cause,   
 @TNotes=Notes,  
 @Task_Mode_ID=Task_Mode_ID,  
 --@Parts_Resources_Identified=Parts_Resources_Identified,  
 @PartsStatusRequired=PartsStatusRequired,  
 @PartsStatusOrdered=PartsStatusOrdered,  
 @PartsStatusReady=PartsStatusReady,  
 --AL: 22/12/08  
 --@Raised_By=Raised_By,  
 @RaisedByID=RaisedByID,  
 @Work_Group_ID=Work_Group_ID,  
 @Strategy_Usage=Strategy_Usage,  
 @Strategy_Repair_Description=Strategy_Repair_Description ,  
 @Strategy_QUOM_ID=Strategy_QUOM_ID,  
 @Strategy_Proj_Task_Opt_ID=Strategy_Proj_Task_Opt_ID,  
 @Planned_Proj_Task_Opt_ID=Planned_Proj_Task_Opt_ID,  
 @Strategy_Date=Strategy_Date,  
 @Strategy_Locked=Strategy_Locked,  
 @Part_Description=Part_Description ,  
 @Group_Description=Group_Description,  
 @SIMS_Code_Id=SIMS_Code_Id,  
-- @Create_By_User_ID=Create_By_User_ID,  --use the UserID from the Event
 @Task_Last_Mod_Date=Last_Mod_Date,  
 @Sort_Order=Sort_Order,  
 @WO_Create_Date=WO_Create_Date,  
 @Performed_By_Date=Performed_By_Date ,  
 @WO_Counter=WO_Counter,  
 @Work_Order_Number_External=Work_Order_Number_External,  
 @Cost_Bearer_ID=Cost_Bearer_ID,  
 @Task_Warranty=Task_Warranty,  
 @Redo_Work_Order_ID=Redo_Work_Order_ID,  
 @Redo=Redo,  
 @ViewWarranty=View_Warranty,  
 @HealthSafetyId=Health_Safety_Id,  
 @BreakDown=Break_Down,  
 @PlannedDownTime=Planned_Down_Time,  
 @ActualDownTime=Actual_Down_Time,  
 @PlannedOffset=Planned_Offset,  
 @ActualOffset=ActualOffset,  
 @SiteId=Site_Id,  
 @WorkLocation=Work_Location,  
 @CostCentreId=Cost_Centre_Id,  
 @BranchId=Branch_Id,  
 @CustomerId=Customer_Id,  
 @PartEntryDistributionCodeId=Part_Entry_Distribution_Code_Id,  
 @DefWorkGroupId=Def_Work_Group_Id,  
 @PartsCostExpenseId=Parts_Cost_Expense_Id,  
 @LabourCostExpenseId=Labour_Cost_Expense_Id,  
 @MiscCostExpenseId=Misc_Cost_Expense_Id,  
 @SpecificOperationCodes=Specific_Operation_Codes,  
 @WorkOrderDate=Work_Order_Date,  
 @WarrantyClaimable=Warranty_Claimable,  
 @ReviewedEmployeeId=Reviewed_Employee_Id,  
 @WarrantyNotes=Warranty_Notes,  
 @WarrantyDays=Warranty_Days,  
 @WarrantyUsage=Warranty_Usage,  
 @WarrantyDaysArchived=Warranty_Days_Archived,  
 @WarrantyUsageAcrhived=Warranty_Usage_Acrhived,  
 @WarrantySupplierId=Warranty_Supplier_Id,  
 @ClaimRef=Claim_Ref,  
 @SupplierRef=Supplier_Ref,  
 @SummaryDescription=Summary_Description,  
 @ClaimStatusId=Claim_Status_Id,  
 @ClaimedByEmployeeId=Claimed_By_Employee_Id,  
 @ClaimeDate=Claime_Date,  
 @ClaimDescription=Claim_Description,  
 @JobPartsCost=Job_Parts_Cost,  
 @JobLabourCost=Job_Labour_Cost,  
 @JobMiscCost=Job_Misc_Cost,  
 @ClaimedPartsCost=Claimed_Parts_Cost,  
 @ClaimedLabourCost=Claimed_Labour_Cost,  
 @ClaimedMiscCost=Claimed_Misc_Cost,  
 @RecPartsCost=Rec_Parts_Cost,  
 @RecLabourCost=Rec_Labour_Cost,  
 @RecMiscCost=Rec_Misc_Cost,  
 @LabourEntryDistributionCodeId=Labour_Entry_Distribution_Code_Id,  
 @MiscEntryDistributionCodeId=Misc_Entry_Distribution_Code_Id,  
 @SupplierContact=Supplier_Contact,  
 @TaskAuthorised=Task_Authorised ,  
 @AMTPlanningModeId=AMTPlanningModeId,  
 @ProjTaskId=ProjTaskId,  
 @Work_Order_Id=Work_Order_Id,  
 @CreateWO=CreateWO,  
 @TaskAuthorisationAmount=Task_Authorised_Amount,  --AL: 09/02/09  
 @ExpressAddTaskInstruction=ExpressAddTaskInstruction, --AL: 11/02/09  
 --AL: 13/02/09  
 @ChangeoutCategoryId=ChangeoutCategoryId,  
 @LifeConfirmed =LifeConfirmed,   
 @OriginalPartTypeId =OriginalPartTypeId, 
 /*VV E602*/ 
 @SerialNoIn =SerialNoInId,  
 @SerialNoOut =SerialNoOutId,  
 @IsOverwriteLife =IsOverwriteLife,   
 @OverwriteLifeAchieved =OverwriteLifeAchieved,   
 @WOClosed=WOClosed,  
 @LastNotified=LastNotified,
 @AuthorisationRequestByID = AuthorisationRequestByID  --DA 2747    
  
 FROM  OPENXML (@hDoc,'/EV_T/TASK',2) WITH (  
  Task_ID int,  
  Event_ID int,  
  Description varchar(500),  
  Eqp_Plan_ID int,  
  Task_Type_ID int,  
  Component_Code_ID int,  
  Modifier_ID int,  
  Application_Code_ID int,  
  Occurrence_Type_Id int,  
  Priority_ID int,  
  Source_ID int,  
  Task_Status_ID int,  
  Date_Notified datetime,  
  Component_ID varchar(100),  
  Symptom_ID int,  
  Symptom_Notes varchar(8000), --AL: 10/02/09  
  Cause_ID int,  
  Cause_Notes varchar(8000), --AL: 10/02/09  
  Repair_Notes varchar(8000), --AL: 10/02/09  
  Group_No varchar(50),  
  Part_No varchar(50),  
  EMI_Ref varchar(50),  
  Redo bit,  
  Task_Planned_Time_ID int,  
  Customer_Ref varchar(100),  
  Employee_ID int,  
  Expected_Duration float,  
  Expected_Labor_Hours float,   
  Planning_Notes varchar(8000), --AL: 22/05/08  
  Work_Order varchar(50),  
  Actual_Duration float,  
  Actual_Labor_Hrs float,  
  Primary_Cause bit,  
  Notes varchar(1000),  
  Task_Mode_ID int,  
  PartsStatusRequired bit,  
  PartsStatusOrdered bit,  
  PartsStatusReady bit,  
  RaisedByID int,  
  Work_Order_ID int,  
  Strategy_Usage real,  
  Work_Group_ID int,  
  Strategy_QUOM_ID int,  
  Strategy_Proj_Task_Opt_ID int,  
  Planned_Proj_Task_Opt_ID int,  
  Strategy_Date datetime,  
  Strategy_Locked bit,  
  Last_Mod_Date varchar(25),  
  Create_By_User_ID int,  
  Repair_Code_Id int,  
  EM_Issue_Id int,  
  --RJ
  Part_Description varchar(1000),  
  Group_Description varchar(1000),  
  SIMS_Code_Id int,  
  Rotable_Remove_Id int,  
  Rotable_Inuse_Id int,  
  Strategy_Repair_Description varchar(100),  
  Sort_Order int,  
  WO_Create_Date datetime,  
  Performed_By_Date datetime,  
  WO_Counter int,  
  Work_Order_Number_External varchar(50),  
  Cost_Bearer_ID int,  
  Task_Warranty bit,  
  Redo_Work_Order_ID int,  
  View_Warranty bit,  
  Health_Safety_Id int,  
  Break_Down bit,  
  Planned_Down_Time datetime,  
  Actual_Down_Time datetime,  
  Planned_Offset float,  
  Site_Id int,  
  Work_Location varchar(100),  
  Cost_Centre_Id int,  
  Branch_Id int,  
  Customer_Id int,  
  Part_Entry_Distribution_Code_Id int,  
  Def_Work_Group_Id int,  
  Parts_Cost_Expense_Id int,  
  Labour_Cost_Expense_Id int,  
  Misc_Cost_Expense_Id int,  
  Specific_Operation_Codes bit,  
  Work_Order_Date datetime,  
  Warranty_Claimable bit,  
  Reviewed_Employee_Id int,  
  Warranty_Notes varchar(500),  
  Warranty_Days float,  
  Warranty_Usage float,  
  Warranty_Days_Archived float,  
  Warranty_Usage_Acrhived float,  
  Warranty_Supplier_Id int,  
  Claim_Ref varchar(20),  
  Supplier_Ref varchar(20),  
  Summary_Description varchar(200),  
  Claim_Status_Id int,  
  Claimed_By_Employee_Id int,  
  Claime_Date datetime,  
  Claim_Description varchar(1000),  
  Job_Parts_Cost float,  
  Job_Labour_Cost float,  
  Job_Misc_Cost float,  
  Claimed_Parts_Cost float,  
  Claimed_Labour_Cost float,  
  Claimed_Misc_Cost float,  
  Rec_Parts_Cost float,  
  Rec_Labour_Cost float,  
  Rec_Misc_Cost float,  
  Labour_Entry_Distribution_Code_Id int,  
  Misc_Entry_Distribution_Code_Id int,  
  Supplier_Contact varchar(100),  
  Task_Authorised bit,  
  Task_Authorised_By_Id int,  
  Task_Authorised_Date datetime,  
  ActualOffset float,  
  AMTPlanningModeId int,  
  ProjTaskId int,  
  CreateWO bit,  
  Task_Authorised_Amount float, --AL: 09/02/09  
  ExpressAddTaskInstruction varchar(8000), --AL: 11/02/09  
  ChangeoutCategoryId int,  
  LifeConfirmed bit ,  
  OriginalPartTypeId int, 
  /*VV E602*/ 
  SerialNoInId int,  
  SerialNoOutId int,  
  IsOverwriteLife bit ,  
  OverwriteLifeAchieved float ,  
  WOClosed bit,  
  LastNotified datetime,
  AuthorisationRequestByID int  --DA 2747   
 )   
  
 EXEC sp_xml_removedocument @hDoc  
END  
  
--Check that the primary task is not attached to any other Event  
IF (@Task_Id>0 AND @Task_Status_Id<>@TaskStatusD)   
BEGIN  
 IF EXISTS(SELECT Task_Id FROM TASK WHERE Task_Id=@Task_Id AND Event_Id>0)  
 BEGIN  
  SET @Message='The primary workorder has already been assigned to an Event.'   
  RETURN  
 END  
END  
  

  
EXEC EVENT_BUSINESS_RULES_P @Event_ID =0,  
       @Event_Status_ID =@Event_Status_ID,   
       @Confirmed =@Confirmed,   
       @Message =@Message OUTPUT,  
       @NewEvent=1,  
       @TaskStatusId =@Task_Status_Id,  
       @ComponentCodeID=@Component_Code_ID,  
       @TaskTypeID =@Task_Type_ID,  
       @SourceID =@Source_ID,  
       @SymptomID =@Symptom_ID,  
       @CauseID =@Cause_ID,  
       @RepairCodeId =@Repair_Code_Id,  
          @EqpPlanId=@Eqp_Plan_Id,  
          @Planned_Down_Time =@Planned_Down_Time,   
       @Planned_Up_Time =@Planned_Up_Time,   
       @Actual_Down_Time =@Actual_Down_Time,   
       @Actual_Up_Time =@Actual_Up_Time,  
       @Expected_Up_Time =@Expected_Up_Time 
        
  
IF ISNULL(@Message,'')<>'' RETURN  


  
--Check if we need to archive the exchange rate  
IF @TestTime>0  
BEGIN  
 --IF EXISTS(  
 --SELECT CurrencyID FROM NON_PRIM_CURR_IN_BILLING_V WHERE EqpPlanID=@Eqp_Plan_ID)  
 --BEGIN  
  EXEC ARCHIVE_CURRENT_EX_RATE_P @ExRateID=@ExRateID OUTPUT  
 --END  
END  

  
-- ADD Event   
Insert Into EVENT (  
 Eqp_Plan_ID,    
 Description,   
 Event_Status_ID,   
 Priority_ID,   
 Work_Location_ID,   
 Planned,   
 Break_Down,   
 Expected_Up_Time,   
 Confirmed,   
 Event_Prevention_ID,   
        Planned_Down_Time,   
 Planned_Down_Usage,   
 Planned_Up_Time,   
 Planned_Up_Usage,   
 Actual_Down_Time,   
 Actual_Down_Usage,   
 Actual_Up_Time,   
 Actual_Up_Usage,   
        Notes,   
 Down_Delay_Notes,   
 Down_Delay_Hrs,   
 Down_Delay_ID,   
 Event_Mode_ID,   
 Has_Down_Time,     
 New_Event,    
 Repair_Details,    
 QUOM_ID,  
 Last_Mod_By_User_ID,        
 Last_Mod_Date,   
     Create_By_User_ID,  
 Create_Date,  
 Test_Time,  
 Ex_Rate_ID,  
 Released_By_ID,
 /*VV #641*/
 ShutdownID,
 /*VV AmtMobile*/ 
 UniqueKey)  
Values (  
 @Eqp_Plan_ID,    
 @Description,   
 @Event_Status_ID,   
 @Priority_ID,   
 @Work_Location_ID,   
 @Planned,   
 @Break_Down,   
 @Expected_Up_Time,   
 @Confirmed,   
 @Event_Prevention_ID,   
        @Planned_Down_Time,   
 @Planned_Down_Usage,   
 @Planned_Up_Time,   
 @Planned_Up_Usage,   
 @Actual_Down_Time,   
 @Actual_Down_Usage,   
 @Actual_Up_Time,   
 @Actual_Up_Usage,   
        @Notes,   
 @Down_Delay_Notes,   
 @Down_Delay_Hrs,   
 @Down_Delay_ID,   
 @Event_Mode_ID,   
 @Has_Down_Time,     
 @New_Event,    
 @Repair_Details,    
 @QUOM_ID,        
 @Create_By_User_ID,  
 getdate(),   
 @Create_By_User_ID,  
 getdate(),  
 @TestTime,  
 ISNULL(@ExRateID,0),  
 @RelesedByID,
  /*VV #641*/
 @ShutdownID,
 /*VV AmtMobile*/ 
 ISNULL(NULLIF(@UniqueKey,''),NEWID())
 )  
  
Set @NewEvent_ID=SCOPE_IDENTITY()  

  
--Add task to event  
SET @Primary_Cause=1  
SET @Sort_Order=1  
  
  
IF @Task_id>0  
BEGIN  
 EXEC TASK_UPDATE_P @Task_ID =@Task_ID,--1  
    @Event_ID =@NewEvent_ID, --2  
 @Description =@TaskDesc, --3  
 @Eqp_Plan_ID =@Eqp_Plan_ID, --4  
 @Task_Type_ID =@Task_Type_ID, --5  
 @Component_Code_ID =@Component_Code_ID, --6  
 @Modifier_ID = @Modifier_ID, --7  
 @Application_Code_ID = @Application_Code_ID, --8  
 @Occurrence_Type_Id = @Occurrence_Type_Id,--9   
 @Priority_ID = @Priority_ID, --10  
 @Source_ID = @Source_ID, --11  
 @Task_Status_ID =@Task_Status_ID , --12  
    @Date_Notified = @Date_Notified,--13   
 @Component_ID = @Component_ID, --14  
 @Symptom_ID = @Symptom_ID, --15  
 @Symptom_Notes = @Symptom_Notes, --16  
 @Cause_ID = @Cause_ID, --17  
 @Cause_Notes = @Cause_Notes, --18  
 @Repair_Code_ID = @Repair_Code_ID, --19  
 @Repair_Notes = @Repair_Notes,--20   
 @Group_No = @Group_No,--21   
 @Part_No = @Part_No, --22  
 @EMI_Ref = @EMI_Ref,--23  
 @EMIssueId = @EMIssueId, --23.5  
 @Redo = @Redo, --24  
 @Task_Planned_Time_ID = @Task_Planned_Time_ID, --25  
    @Customer_Ref = @Customer_Ref, --26  
 @Employee_ID = @Employee_ID, --27  
 @Expected_Duration = @Expected_Duration, --28  
 @Expected_Labor_Hours = @Expected_Labor_Hours, --29  
 @Planning_Notes = @Planning_Notes,--30   
 @Work_Order = @Work_Order, --32  
 @Actual_Duration = @Actual_Duration, --33  
 @Actual_Labor_Hrs = @Actual_Labor_Hrs, --34                       
 @Primary_Cause = @Primary_Cause, --35  
 @Notes = @TNotes,--36  
 @Task_Mode_ID = @Task_Mode_ID,--37  
 @PartsStatusRequired = @PartsStatusRequired,  
 @PartsStatusOrdered = @PartsStatusOrdered,  
 @PartsStatusReady = @PartsStatusReady,  
 @RaisedByID=@RaisedByID,  
 @Work_Order_ID = @Work_Order_ID,  
 @Work_Group_ID = @Work_Group_ID,  
 @Strategy_Usage =@Strategy_Usage ,  
 @Strategy_QUOM_ID = @Strategy_QUOM_ID,  
 @Strategy_Proj_Task_Opt_ID = @Strategy_Proj_Task_Opt_ID,  
 @Planned_Proj_Task_Opt_ID = @Planned_Proj_Task_Opt_ID,  
 @Strategy_Date = @Strategy_Date,  
 @Strategy_Locked =@Strategy_Locked ,  
 @Event_Last_Mod_Date = NULL,--38  
 @Task_Last_Mod_Date = @Task_Last_Mod_Date,  
 @Part_Description  = @Part_Description,     
 @Group_Description = @Group_Description,  
    @SIMS_Code_Id = @SIMS_Code_Id,  
    @Last_Mod_By_User_ID = @Create_By_User_ID, --39  
 @Error_Number =@Error_Number OUTPUT,  
 @Message =@Message OUTPUT,  
 @Sort_Order = @Sort_Order,  
 @WO_Create_Date = @WO_Create_Date,  
 @Performed_By_Date = @Performed_By_Date,  
 @Parts_Available_Date = NULL,  
 @Parts_Order_Details = NULL,  
 @WO_Counter =@WO_Counter ,  
 @Work_Order_Number_External = @Work_Order_Number_External,  
 @Cost_Bearer_ID = @Cost_Bearer_ID,  
 @Task_Warranty = @Task_Warranty,  
 @Redo_Work_Order_ID = @Redo_Work_Order_ID,  
 @ViewWarranty = @ViewWarranty,  
 @HealthSafetyId = @HealthSafetyId,  
 @BreakDown = @BreakDown,  
 @PlannedDownTime  = @PlannedDownTime,  
 @ActualDownTime  = @ActualDownTime,  
 @PlannedOffset  = @PlannedOffset,  
 @SiteId  = @SiteId,  
 @WorkLocation = @WorkLocation,  
 @CostCentreId =@CostCentreId ,  
 @BranchId = @BranchId,  
 @CustomerId  = @CustomerId,  
 @PartEntryDistributionCodeId = @PartEntryDistributionCodeId,  
 @DefWorkGroupId  = @DefWorkGroupId,  
 @PartsCostExpenseId  = @PartsCostExpenseId,  
 @LabourCostExpenseId  = @LabourCostExpenseId,  
 @MiscCostExpenseId  =@MiscCostExpenseId ,  
 @SpecificOperationCodes  = @SpecificOperationCodes,  
 @WorkOrderDate = @WorkOrderDate,  
 @WarrantyClaimable = @WarrantyClaimable,  
 @ReviewedEmployeeId  = @ReviewedEmployeeId,  
 @WarrantyNotes  = @WarrantyNotes,  
 @WarrantyDays  = @WarrantyDays,  
 @WarrantyUsage  = @WarrantyUsage,  
 @WarrantyDaysArchived  =@WarrantyDaysArchived ,  
 @WarrantyUsageAcrhived  =@WarrantyUsageAcrhived ,  
 @WarrantySupplierId  = @WarrantySupplierId,  
 @ClaimRef =@ClaimRef ,  
 @SupplierRef  = @SupplierRef,  
 @SummaryDescription = @SummaryDescription,  
 @ClaimStatusId  = @ClaimStatusId,  
 @ClaimedByEmployeeId  = @ClaimedByEmployeeId,  
 @ClaimeDate  = @ClaimeDate,  
 @ClaimDescription  = @ClaimDescription,  
 @JobPartsCost = @JobPartsCost,  
 @JobLabourCost = @JobLabourCost,  
 @JobMiscCost = @JobMiscCost,  
 @ClaimedPartsCost = @ClaimedPartsCost,  
 @ClaimedLabourCost = @ClaimedLabourCost,  
 @ClaimedMiscCost  = @ClaimedMiscCost,  
 @RecPartsCost = @RecPartsCost,  
 @RecLabourCost  = @RecLabourCost,  
 @RecMiscCost  = @RecMiscCost,  
 @LabourEntryDistributionCodeId  = @LabourEntryDistributionCodeId,  
 @MiscEntryDistributionCodeId = @MiscEntryDistributionCodeId,  
 @SupplierContact = @SupplierContact,  
 @TaskAuthorised  = @TaskAuthorised,  
 @ProjTaskId = @ProjTaskId,  
 @ActualOffset = @ActualOffset,  
 @UpdateWO = 1,   
 @OpReplaced = @OpReplaced,  
 @opDeleted = @opDeleted,  
 @pDeleted = @pDeleted,  
 @labDeleted = @labDeleted,  
 @miscDeleted = @miscDeleted,  
 @poDeleted = @poDeleted,  
 @libDeleted=@libDeleted,  
 @opAdded = @opAdded,      
    @opModified =@opModified,  
 @CreateWO=@CreateWO,  
 @TaskAuthorisationAmount=@TaskAuthorisationAmount,  
 @ChangeoutCategoryId=@ChangeoutCategoryId,  
 @LifeConfirmed =@LifeConfirmed,   
 @OriginalPartTypeId =@OriginalPartTypeId,  
 @SerialNoIn =@SerialNoIn,  
 @SerialNoOut =@SerialNoOut,  
 @IsOverwriteLife =@IsOverwriteLife,   
 @OverwriteLifeAchieved =@OverwriteLifeAchieved,   
 @WOClosed=@WOClosed,  
 @LastNotified=@LastNotified,
 @AuthorisationRequestByID = @AuthorisationRequestByID  --DA 2747  
  
END  
ELSE  
BEGIN  
   
 EXEC TASK_ADD_P   
 @Event_ID =@NewEvent_ID,   
 @Description =@TaskDesc,   
 @Eqp_Plan_ID =@Eqp_Plan_ID,   
 @Task_Type_ID =@Task_Type_ID,   
 @Component_Code_ID =@Component_Code_ID,   
 @Modifier_ID =@Modifier_ID,   
 @Application_Code_ID =@Application_Code_ID,   
 @Occurrence_Type_Id =@Occurrence_Type_Id,   
 @Priority_ID =@Priority_ID,   
 @Source_ID =@Source_ID,   
 @Task_Status_ID =@Task_Status_ID,   
    @Date_Notified =@Date_Notified,   
 @Component_ID =@Component_ID,   
 @Symptom_ID =@Symptom_ID,   
 @Symptom_Notes =@Symptom_Notes,   
 @Cause_ID =@Cause_ID,   
 @Cause_Notes =@Cause_Notes,   
 @Repair_Code_ID =@Repair_Code_ID,   
 @Repair_Notes =@Repair_Notes,   
 @Group_No =@Group_No,   
 @Part_No =@Part_No,   
 @EMI_Ref =@EMI_Ref,  
 @EMIssueId=@EMIssueId,  
 @Redo =@Redo,   
 @Task_Planned_Time_ID =@Task_Planned_Time_ID,   
    @Customer_Ref =@Customer_Ref,   
 @Employee_ID =@Employee_ID,   
 @Expected_Duration=@Expected_Duration ,   
 @Expected_Labor_Hours =@Expected_Labor_Hours,   
 @Planning_Notes =@Planning_Notes,   
 @Work_Order =@Work_Order,   
 @Actual_Duration =@Actual_Duration,   
 @Actual_Labor_Hrs =@Actual_Labor_Hrs,   
    @Primary_Cause =@Primary_Cause,   
 @Notes =@Notes,  
 @Task_Mode_ID =@Task_Mode_ID,  
 @PartsStatusRequired = @PartsStatusRequired,  
 @PartsStatusOrdered = @PartsStatusOrdered,  
 @PartsStatusReady = @PartsStatusReady,  
 @RaisedByID=@RaisedByID,  
 @Work_Order_ID =@Work_Order_ID,  
 @Work_Group_ID =@Work_Group_ID,  
 @Strategy_Usage =@Strategy_Usage,  
 @Strategy_QUOM_ID =@Strategy_QUOM_ID,  
 @Strategy_Proj_Task_Opt_ID =@Strategy_Proj_Task_Opt_ID,  
 @Planned_Proj_Task_Opt_ID =@Planned_Proj_Task_Opt_ID,  
 @Strategy_Date =@Strategy_Date,  
 @Strategy_Locked =@Strategy_Locked,  
 @Part_Description  =@Part_Description,     
 @Group_Description =@Group_Description,  
    @SIMS_Code_Id =@SIMS_Code_Id,  
 @Event_Last_Mod_Date =NULL,  
    @Create_By_User_ID =@Create_By_User_ID,  
    @NewTask_ID  =@Task_ID OUTPUT,  
 @Error_Number  = @Error_Number OUTPUT,  
 @Message = @Message OUTPUT,  
 @Sort_Order =@Sort_Order,  
 @WO_Create_Date =@WO_Create_Date,  
 @Performed_By_Date =@Performed_By_Date,  
 @Parts_Available_Date =NULL,  
 @Parts_Order_Details ='',  
 @WO_Counter =@WO_Counter,  
 @Work_Order_Number_External =@Work_Order_Number_External,   
 @Cost_Bearer_ID =@Cost_Bearer_ID,  
 @Task_Warranty =@Task_Warranty,  
 @Redo_Work_Order_ID =@Redo_Work_Order_ID,  
 @ViewWarranty =@ViewWarranty,  
 @HealthSafetyId = @HealthSafetyId,  
 @BreakDown =@BreakDown,  
 @PlannedDownTime  =@PlannedDownTime,  
 @ActualDownTime  =@ActualDownTime,  
 @PlannedOffset  =@PlannedOffset,  
 @SiteId  =@SiteId,  
 @WorkLocation =@WorkLocation ,  
 @CostCentreId = @CostCentreId,  
 @BranchId = @BranchId,  
 @CustomerId  =@CustomerId,  
 @PartEntryDistributionCodeId = @PartEntryDistributionCodeId,  
 @DefWorkGroupId  =@DefWorkGroupId,  
 @PartsCostExpenseId  =@PartsCostExpenseId,  
 @LabourCostExpenseId  =@LabourCostExpenseId,  
 @MiscCostExpenseId  =@MiscCostExpenseId,  
 @SpecificOperationCodes  =@SpecificOperationCodes,  
 @WorkOrderDate =@WorkOrderDate ,  
 @WarrantyClaimable =@WarrantyClaimable,  
 @ReviewedEmployeeId  =@ReviewedEmployeeId,  
 @WarrantyNotes  =@WarrantyNotes,  
 @WarrantyDays  =@WarrantyDays,  
 @WarrantyUsage  =@WarrantyUsage,  
 @WarrantyDaysArchived  =@WarrantyDaysArchived,  
 @WarrantyUsageAcrhived  =@WarrantyUsageAcrhived,  
 @WarrantySupplierId  =@WarrantySupplierId,  
 @ClaimRef = @ClaimRef,  
 @SupplierRef  =@SupplierRef,  
 @SummaryDescription = @SummaryDescription,  
 @ClaimStatusId  =@ClaimStatusId,  
 @ClaimedByEmployeeId  =@ClaimedByEmployeeId,  
 @ClaimeDate  =@ClaimeDate,  
 @ClaimDescription  =@ClaimDescription,  
 @JobPartsCost =@JobPartsCost,  
 @JobLabourCost =@JobLabourCost,  
 @JobMiscCost =@JobMiscCost,  
 @ClaimedPartsCost =@ClaimedPartsCost,  
 @ClaimedLabourCost =@ClaimedLabourCost,  
 @ClaimedMiscCost  =@ClaimedMiscCost,  
 @RecPartsCost =@RecPartsCost,  
 @RecLabourCost  =@RecLabourCost,  
 @RecMiscCost  =@RecMiscCost,  
 @LabourEntryDistributionCodeId  =@LabourEntryDistributionCodeId,  
 @MiscEntryDistributionCodeId =@MiscEntryDistributionCodeId ,  
 @SupplierContact = @SupplierContact,  
 @TaskAuthorised  =@TaskAuthorised,  
 @ProjTaskId =@ProjTaskId,  
 @ActualOffset =@ActualOffset,   
 @AMTPlanningModeId =@AMTPlanningModeId,  
 @opAdded =@opAdded,  
 @CreateWO=@CreateWO,  
 @TaskAuthorisationAmount=@TaskAuthorisationAmount,
 /*JW 4001*/ 
 @ChangeoutCategoryId=@ChangeoutCategoryId,  
 @LifeConfirmed =@LifeConfirmed,   
 @OriginalPartTypeId =@OriginalPartTypeId,  
 @ExpressAddTaskInstruction=@ExpressAddTaskInstruction,  
 @LastNotified=@LastNotified,
 /*VV AmtMobile*/ 
 @CopyEWTemplateFiles=@CopyEWTemplateFiles OUTPUT,
 /*VV E602*/ 
  @SerialNoIn =@SerialNoIn,  
  @SerialNoOut =@SerialNoOut,
  @AuthorisationRequestByID = @AuthorisationRequestByID  --DA 2747    

END  
  
  
--add data into TEST_TIME table  
IF @TestTime>0  
BEGIN   
 EXEC TEST_TIME_MAINT_P @EventID=@NewEvent_ID, @Recalc_Billings=@Recalc_Billings OUTPUT  
  
 --Check if we need to recalculate billings  
 IF @Recalc_Billings=1  
 BEGIN  
  --Find the current projection id  
  SELECT @EqpProjID=EPR.EqpProjId  
  FROM           
  EVENT E   
   INNER JOIN  
        tblEqpPlans EP   
   ON E.Eqp_Plan_ID = EP.EqpPlanId   
   INNER JOIN  
        tblEqpProjs EPR   
   ON EP.EqpPlanId = EPR.EqpPlanId  
  WHERE  
  E.Event_ID=@NewEvent_ID AND EPR.Projection_Header_ID=1  
  
  EXEC usp_Update_RepProjBilling @piEqpProjID=@EqpProjID, @Recalc_Test_Time=0  
 END  
   
   
END  
GO

/****** Object:  StoredProcedure [dbo].[RPT_PROJECTION_SUMMARY_AND_COST_PER_INTERVAL_P]    Script Date: 05/03/2012 10:00:50 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[RPT_PROJECTION_SUMMARY_AND_COST_PER_INTERVAL_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[RPT_PROJECTION_SUMMARY_AND_COST_PER_INTERVAL_P]
GO

/****** Object:  StoredProcedure [dbo].[RPT_PROJECTION_SUMMARY_AND_COST_PER_INTERVAL_P]    Script Date: 05/03/2012 10:00:50 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


 
CREATE PROCEDURE [dbo].[RPT_PROJECTION_SUMMARY_AND_COST_PER_INTERVAL_P]            
            
/******************************************************************************            
 File:             
 Name: RPT_PROJECTION_SUMMARY_AND_COST_PER_INTERVAL_P            
 Called By:             
            
 Desc:            
                         
            
 Auth: GURDEEP DHILLON            
 Date: 10 Feb 2011            
*******************************************************************************            
  Change History            
*******************************************************************************            
Date:  Author:  Description:            
-------- -------- ----------------------------------------            
 03 May 12  GD          Fixed 4102
 21 Feb 11	KN			#E736: Fix Report Security         
*******************************************************************************/            
 /* Param List */            
          
@ShowSellAmt BIT = 1,          
@CountIntervals BIT = 0,          
@Interval INT = 0,          
@dealerId INT = 1,          
@Parts_Labour_Misc INT=0,          
@componentCodeID VARCHAR(MAX) = '',            
@modifierID VARCHAR(MAX) = '',            
@projTaskId VARCHAR(MAX) = '',           
@systemID VARCHAR(MAX) = '',            
@subSystemID VARCHAR(MAX) = '',            
@taskTypeID VARCHAR(MAX) = '',           
@costExpenseID VARCHAR(MAX)='',          
@modelId VARCHAR(MAX) = '',           
@costResponsibilityID VARCHAR(MAX)='',          
@costCentreID VARCHAR(MAX)='',            
@costActivityID VARCHAR(MAX)='',                     
@ProjHeaderId int,          
@CostBearerID varchar(MAX)='' ,          
@branchId VARCHAR(MAX)='',            
@site_ID VARCHAR(MAX)='',            
@fleet_ID VARCHAR(MAX)='',          
@QUOMID INT = -1,          
@Escalated bit=1 /*Normal=1, No escalation=0*/,              
@IncludeLube int =0/* All=0,Include=1,Exclude=2*/,                         
@AdjustCosts bit=0 ,             
@eqp_Plan_ID VARCHAR(MAX)='' ,               
@costTypeID VARCHAR(MAX) = '',
@AlternateDisplay BIT = 0,
@UserId INT = 0
         
          
AS            

SET @UserId = ISNULL(@UserId,0)
Declare @Level int
SELECT TOP 1 @Level=User_Access_Level_Id From USER_LEVEL_PERMISSION where AMT_User_Id = @UserId
SET @Level = ISNULL(@Level,0)

IF NOT EXISTS (
	SELECT EqpPlanId FROM EQUIPMENT_HIERARCHY_V WHERE EqpPlanId = @eqp_Plan_ID AND
	 ((ISNULL(@Level,0)<>1 AND ISNULL(@Level,0)<>2) OR 
						CASE WHEN @Level=1 THEN BranchID ELSE SiteID END IN 
							(SELECT AMT_OBJECT_ID 
							 FROM USER_LEVEL_PERMISSION 
							 WHERE 
									AMT_USER_ID = @UserId AND 
									User_Access_Level_Id=@Level))
									)
	BEGIN
		RETURN
	END		
    
DECLARE @All INT    
DECLARE @Parts INT    
DECLARE @Labour INT    
DECLARE @Misc INT    
    
DECLARE @P FLOAT    
DECLARE @L FLOAT    
DECLARE @M FLOAT    
    
    
DECLARE @TermByUsage int    
    
SET @TermByUsage=1    
    
SET @All=0    
SET @Parts=1    
SET @Labour=2    
SET @Misc=3    
 --Set Parts/Labour/Misc to all if it is null    
SET @Parts_Labour_Misc=ISNULL(@Parts_Labour_Misc,@All)    
    
IF @Parts_Labour_Misc=@All    
BEGIN    
 SET @P=1    
 SET @L=1    
 SET @M=1    
END    
IF @Parts_Labour_Misc=@Parts    
BEGIN    
 SET @P=1    
 SET @L=0    
 SET @M=0    
END    
IF @Parts_Labour_Misc=@Labour    
BEGIN    
 SET @P=0    
 SET @L=1    
 SET @M=0    
END    
IF @Parts_Labour_Misc=@Misc    
BEGIN    
 SET @P=0    
 SET @L=0    
 SET @M=1    
END           
            
/* All=0,Include=1,Exclude=2*/            
DECLARE @LubeIncl int            
DECLARE @LubeExcl int            
DECLARE @EqpProjId int            
DECLARE @Days varchar(10)            
            
         
DECLARE @AdjFactor float            
DECLARE @Billing float            
DECLARE @RiskPremiumPct float            
DECLARE @TotalCost float            
DECLARE @DefCB int            
 
 
SET @branchId =REPLACE(@branchId,'''','')  
SET @site_ID =REPLACE(@site_ID,'''','')  
SET @fleet_ID =REPLACE(@fleet_ID,'''','')  
SET @eqp_Plan_ID =REPLACE(@eqp_Plan_ID,'''','')  
SET @ProjHeaderId =REPLACE(@ProjHeaderId,'''','')  
SET @CostBearerID =REPLACE(@CostBearerID,'''','')  
SET @costResponsibilityID =REPLACE(@costResponsibilityID,'''','')  
SET @costCentreID =REPLACE(@costCentreID,'''','')  
SET @costActivityID =REPLACE(@costActivityID,'''','')  
SET @costExpenseID =REPLACE(@costExpenseID,'''','')     
SET @modelId =REPLACE(@modelId,'''','')  
SET @costTypeID =REPLACE(@costTypeID,'''','')  
SET @systemID =REPLACE(@systemID,'''','')  
SET @subSystemID =REPLACE(@subSystemID,'''','')  
SET @taskTypeID =REPLACE(@taskTypeID,'''','')  
SET @componentCodeID =REPLACE(@componentCodeID,'''','')  
SET @modifierID =REPLACE(@modifierID,'''','')  
SET @projTaskId =REPLACE(@projTaskId,'''','')             
            
SET @LubeIncl=1            
SET @LubeExcl=2            
            
SET @Days='Days'            
            
SELECT @DefCB=CostBearerId FROM tblCostBearers WHERE Default_Value=1            
            
--Calculate Cost Bearer
CREATE TABLE #aa_CostBearer(CostBearerId int, Incl int,Lube int,AdjFactor float PRIMARY KEY (CostBearerId))            
            
INSERT INTO #aa_CostBearer(CostBearerId, Incl,Lube,AdjFactor)            
SELECT CB.CostBearerId,             
CASE ISNULL(@CostBearerID,'') WHEN '' THEN 1 ELSE CASE WHEN LTT.List_Item>0 THEN 1 ELSE 0 END END AS Incl,   
CASE @IncludeLube WHEN @LubeIncl THEN 1 WHEN @LubeExcl THEN 0 ELSE            
CASE ISNULL(@CostBearerID,'') WHEN '' THEN 1 ELSE CASE WHEN LTT.List_Item>0 THEN 1 ELSE 0 END END            
END AS Lube,1 AS AdjFactor            
FROM            
tblCostBearers CB            
 LEFT JOIN            
(SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@CostBearerID)) LTT            
 ON CB.CostBearerId=LTT.List_Item            
 
--Task header  
CREATE TABLE #aa_Task_Header(Task_Header_Id INT PRIMARY KEY (Task_Header_Id))  
IF @ProjTaskId<>''  
BEGIN  
 INSERT INTO #aa_Task_Header(Task_Header_Id)  
 SELECT DISTINCT PT.Task_Header_Id FROM   
 tblProjTasks PT  
  INNER JOIN  
 dbo.LIST_TO_TABLE_F(@projTaskId) LTT  
  ON PT.ProjTaskId=LTT.List_Item  
   
END                
            
--Equipment details            
CREATE TABLE #aa_EqpProj(EqpPlanId int,EqpProjId int,TotalTerm float,AnnualUtil float,            
NoYears int,StartUsage float,QUOMId int,ProjUsageProfileId int,EndUsage float,ExchangeRateId int,            
StartDate datetime,StartIntervalId int,EndIntervalId int,FleetId int,Utilisation_Method_Id int,            
OriginalCommissionDate datetime,EndDate datetime ,Default_Cost_Bearer_ID INT,Cost_Centre_ID INT,Cost_Responsibility_ID INT          
PRIMARY KEY(EqpPlanId,EqpProjId))            
            
INSERT INTO #aa_EqpProj(EqpPlanId,EqpProjId,TotalTerm,AnnualUtil,/*NoYears,*/StartUsage,QUOMId,ProjUsageProfileId,EndUsage,            
ExchangeRateId,StartDate,FleetId,Utilisation_Method_Id,OriginalCommissionDate,EndDate, Default_Cost_Bearer_ID,Cost_Centre_ID, Cost_Responsibility_ID)         
SELECT             
EP.EqpPlanId,EPR.EqpProjId,            
            
CASE             
/* VV #378            
WHEN EP.Primary_QUOM_ID=EPR.EndQUOMId THEN EPR.EndUsage - EPSU.StartUsage            
*/            
WHEN EP.Primary_QUOM_ID=EPR.EndQUOMId THEN             
            
CASE WHEN EPR.Eqp_Term_Rule_ID=@TermByUsage THEN EPR.EndUsage ELSE            
 dbo.GET_EQUIPMENT_END_USAGE_F(EP.EqpPlanId, EP.Primary_QUOM_ID,EPR.EndDate,EP.Utilisation_Method_Id,            
  EPR.Annual_Utilisation,EPR.ProjUsageProfileId) END            
- EPSU.StartUsage            
              
WHEN EP.Primary_QUOM_ID IS NULL THEN CAST(EPR.EndDate AS float)-CAST(EP.StartDate AS float)            
/* VV #378            
ELSE dbo.GET_USAGE_FROM_DATE_F(EPR.EqpProjId,EP.Primary_QUOM_ID,EPR.EndDate) -EPSU.StartUsage            
*/            
ELSE CASE WHEN EPR.Eqp_Term_Rule_ID=@TermByUsage THEN EPR.EndUsage ELSE            
 dbo.GET_EQUIPMENT_END_USAGE_F(EP.EqpPlanId, EP.Primary_QUOM_ID,EPR.EndDate,EP.Utilisation_Method_Id,            
  EPR.Annual_Utilisation,EPR.ProjUsageProfileId) END            
- EPSU.StartUsage END AS TotalTerm,            
CASE EP.Utilisation_Method_Id            
WHEN 2 THEN EPR.Annual_Utilisation            
WHEN 3 THEN 365.25            
ELSE NULL END AS  AnnualUtil,            
EPSU.StartUsage,            
EP.Primary_QUOM_ID AS QUOMId,EPR.ProjUsageProfileId,EPR.EndUsage,EPR.ExchangeRateId,EP.StartDate,            
EP.FleetId,EP.Utilisation_Method_Id,EP.OriginalCommissionDate,EPR.EndDate ,EP.Default_Cost_Bearer_ID,EP.Cost_Centre_ID,EP.Cost_Responsibility_ID          
FROM             
tblEqpPlans EP            
 INNER JOIN            
tblEqpProjs EPR            
 ON EP.EqpPlanId=EPR.EqpPlanId AND EPR.Projection_Header_id=@ProjHeaderId            
 LEFT JOIN            
tblEqpPlanStartUsages EPSU            
 ON EP.EqpPlanId=EPSU.EqpPlanId AND EP.Primary_QUOM_Id=EPSU.StartUsageQUOMId            
WHERE EP.EqpPlanId=@eqp_Plan_ID /*AND EP.Equipment_Type_Id=@EqpTypeModelling*/            
            
IF @@ROWCOUNT=0 RETURN            
            
/*VV CR8325*/            
SET @AdjFactor=1            
            
IF @AdjustCosts=1            
	BEGIN
		SELECT @Billing = SUM(RB.PrimeBillProj) FROM             
		tblRepBilling RB            
		INNER JOIN            
		#aa_EqpProj EPR            
		ON RB.EqpProjID=EPR.EqpProjID            

		SELECT @TotalCost = CASE @Escalated WHEN 1 THEN             
		SUM(PC.PrimePartsSell+PC.PrimeLabourSell+ PC.PrimeMiscSell)            
		ELSE              
		SUM(PC.PrimePartsSellNoEsc+PC.PrimeLabourSellNoEsc+ PC.PrimeMiscSellNoEsc)            
		END            
		FROM            
		tblRepProjCosts PC            
		INNER JOIN            
		#aa_EqpProj EPR         
		ON PC.EqpProjID=EPR.EqpProjID            
		WHERE PC.CostBearerID=@DefCB            
               
        IF ISNULL(@Billing,0)<>0 SET @AdjFactor=ISNULL(@Billing/NULLIF(@TotalCost,0),1)            
                
		IF EXISTS(SELECT * FROM SALES_AGREEMENT SA             
		INNER JOIN             
		#aa_EqpProj EP            
		ON SA.Agr_Eqp_Plan_ID=EP.EqpPlanId            
		INNER JOIN            
		tblEqpProjs EPR            
		ON EP.EqpProjId=EPR.EqpProjId            
		WHERE SA.Agr_Type_Id=4/*Cost Cap*/ AND EPR.Projection_Type_ID=6/*Estimate-Current*/)            
		BEGIN            
			SELECT @RiskPremiumPct=Pct_Risk_Premium            
			FROM            
			SALES_AGREEMENT SA             
			INNER JOIN             
			#aa_EqpProj EP            
			ON SA.Agr_Eqp_Plan_ID=EP.EqpPlanId            
	               
			SET @AdjFactor=ISNULL((@TotalCost+@TotalCost * (@RiskPremiumPct /100.00))/NULLIF(@TotalCost,0),1)            
		END            
             
		UPDATE #aa_CostBearer SET AdjFactor=@AdjFactor WHERE CostBearerId=@DefCB            
	END            
            
IF EXISTS(SELECT EqpPlanId FROM #aa_EqpProj WHERE ProjUsageProfileId>0)            
	BEGIN            
		UPDATE #aa_EqpProj SET AnnualUtil=(SELECT AVG(USA.UsagePerCalYear)            
		FROM              
		tblUsageProfiles UP             
		INNER JOIN            
		tblUsageSteps US             
		ON UP.UsageProfileId = US.UsageProfileId             
		INNER JOIN            
		tblUsageStepAmts USA             
		ON US.UsageStepId = USA.UsageStepId             
		INNER JOIN            
		#aa_EqpProj EPR             
		ON UP.UsageProfileId = EPR.ProjUsageProfileId AND USA.UsageQUOMId = EPR.QUOMId)            
    END            
     
          
--#region Task Details          
CREATE TABLE #aa_Tasks(           
ProjTaskID INT,EqpProjID INT,SystemID INT,ManufacturerId INT,UsageQUOMId INT,Cost_Activity_ID INT,          
Cost_Expense_ID INT,Unscheduled BIT ,ParentTaskID INT NULL        
          
PRIMARY KEY(ProjTaskID,EqpProjID))          
          
--Get all tasks          
INSERT INTO #aa_Tasks (ProjTaskID,EqpProjID,SystemID,ManufacturerId,UsageQUOMId,Cost_Activity_ID,Cost_Expense_ID,          
Unscheduled,ParentTaskID)          
SELECT PT.ProjTaskID,PT.EqpProjID,S.SystemID,PT.ManufacturerId,PT.UsageQUOMId,TT.Cost_Activity_ID,          
SS.Cost_Expense_ID,CASE PT.Unscheduled WHEN 0 THEN 0 ELSE 1 END AS Unscheduled,ParentTaskID         
FROM           
#aa_EqpProj Z            
  INNER JOIN            
 tblProjTasks PT            
  ON Z.EqpProjId=PT.EqpProjId            
 INNER JOIN          
tblTaskTypes TT          
 ON PT.TaskTypeId = TT.TaskTypeID          
 INNER JOIN          
tblComponentCodes CC           
 ON PT.ComponentCodeId = CC.ComponentCodeID          
 INNER JOIN           
tblSubSystems SS           
 ON CC.SubSystemID = SS.SubSystemID           
 INNER JOIN          
tblSystems S ON SS.SystemID = S.SystemID          
  INNER JOIN          
tblCostTypes CT           
 ON S.CostTypeID = CT.CostTypeID
 WHERE   
(@taskTypeID='' OR PT.TaskTypeID IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@taskTypeID))) AND  
(@componentCodeID='' OR PT.ComponentCodeID IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@componentCodeID))) AND  
(@modifierID='' OR PT.ModifierId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@modifierID))) AND  
(@projTaskId='' OR PT.Task_Header_Id IN (SELECT Task_Header_Id FROM #aa_Task_Header)) AND  
(@systemID='' OR S.SystemID IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@systemID))) AND  
(@subSystemID='' OR SS.SubSystemID IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@subSystemID))) AND  
(@costTypeID='' OR S.CostTypeID IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@costTypeID)))     
--#Projected task defaults  
        
          
CREATE TABLE #ProjTaskDefaults (ProjTaskId INT,CountJobs INT,Cost_Bearer_ID INT,Parts_Cost_Expense_ID INT,          
Misc_Cost_Expense_ID INT,Labour_Cost_Expense_ID INT,Cost_Centre_ID INT          
PRIMARY KEY(ProjTaskId) )          
          
CREATE TABLE #PTADefaults(ProjTaskAmtId INT,ProjTaskOptId INT,ProjTaskId INT,Cost_Centre_ID INT,Parts_Cost_Expense_ID INT,          
Labour_Cost_Expense_ID INT,Misc_Cost_Expense_ID INT,Cost_Bearer_ID INT          
PRIMARY KEY(ProjTaskAmtId,ProjTaskOptId))          
          
INSERT INTO #PTADefaults(ProjTaskAmtId,ProjTaskOptId,ProjTaskId,Cost_Centre_ID,Parts_Cost_Expense_ID,Labour_Cost_Expense_ID,          
Misc_Cost_Expense_ID,Cost_Bearer_ID)          
SELECT               
PTA.ProjTaskAmtId, PTA.ProjTaskOptId,PT.ProjTaskId,          
ISNULL(PTA.Cost_Centre_ID,CASE COUNT(CA.Cost_Allocation_Id) WHEN 1 THEN MAX(CAD.Cost_Centre_Id) ELSE PTA.Cost_Centre_ID END) AS Cost_Centre_ID,           
ISNULL(PTA.Parts_Cost_Expense_ID,CASE COUNT(CA.Cost_Allocation_Id) WHEN 1 THEN MAX(CAD.Parts_Cost_Expense_Id) ELSE PTA.Parts_Cost_Expense_ID END) AS Parts_Cost_Expense_ID,           
ISNULL(PTA.Labour_Cost_Expense_ID,CASE COUNT(CA.Cost_Allocation_Id) WHEN 1 THEN MAX(CAD.Labour_Cost_Expense_Id) ELSE PTA.Labour_Cost_Expense_ID END) AS Labour_Cost_Expense_ID,           
ISNULL(PTA.Misc_Cost_Expense_ID,CASE COUNT(CA.Cost_Allocation_Id) WHEN 1 THEN MAX(CAD.Misc_Cost_Expense_Id) ELSE PTA.Misc_Cost_Expense_ID END) AS Misc_Cost_Expense_ID,           
ISNULL(PTA.Cost_Bearer_ID,CASE COUNT(CA.Cost_Allocation_Id) WHEN 1 THEN MAX(CAD.Cost_Bearer_Id) ELSE PTA.Cost_Bearer_ID END) AS Cost_Bearer_ID          
FROM           
#aa_Tasks A          
 INNER JOIN            
tblProjTasks PT          
 ON A.ProjTaskId=PT.ProjTaskId          
 INNER JOIN               
tblProjTaskOpts PTO           
 ON PT.ProjTaskId=PTO.ProjTaskId          
 INNER JOIN          
tblProjTaskAmts PTA           
 ON PTO.ProjTaskOptId = PTA.ProjTaskOptId            
 LEFT OUTER JOIN          
COST_ALLOCATION_DETAIL CAD           
 INNER JOIN          
COST_ALLOCATION CA           
 ON CAD.Cost_Allocation_Id = CA.Cost_Allocation_Id           
 ON PTA.ProjTaskAmtId = CA.Proj_Task_Amt_Id          
GROUP BY PTA.ProjTaskAmtId, PTA.ProjTaskOptId,PT.ProjTaskId,PTA.Misc_Cost_Expense_ID, PTA.Labour_Cost_Expense_ID,           
PTA.Cost_Bearer_ID, PTA.Parts_Cost_Expense_ID, PTA.Cost_Centre_ID          
          
          
INSERT INTO #ProjTaskDefaults(ProjTaskId,CountJobs,Cost_Bearer_ID,Parts_Cost_Expense_ID,          
Misc_Cost_Expense_ID,Labour_Cost_Expense_ID,Cost_Centre_ID)          
SELECT               
PTA.ProjTaskId,           
COUNT(PTA.ProjTaskAmtId) AS CountJobs, MAX(PTA.Cost_Bearer_ID) AS Cost_Bearer_ID,           
MAX(PTA.Parts_Cost_Expense_ID) AS Parts_Cost_Expense_ID, MAX(PTA.Misc_Cost_Expense_ID) AS Misc_Cost_Expense_ID,           
MAX(PTA.Labour_Cost_Expense_ID) AS Labour_Cost_Expense_ID, MAX(PTA.Cost_Centre_ID) AS Cost_Centre_ID           
FROM            
#PTADefaults PTA            
GROUP BY PTA.ProjTaskId          
          
          
UPDATE #ProjTaskDefaults SET          
Cost_Bearer_ID=NULL,          
Parts_Cost_Expense_ID=NULL,          
Misc_Cost_Expense_ID=NULL,          
Labour_Cost_Expense_ID=NULL,          
Cost_Centre_ID=NULL          
WHERE CountJobs>1 OR CountJobs<1          
           
DROP TABLE #PTADefaults          
--#Endregion          
          
   
--Create a temporary table for costs          
CREATE TABLE #aa_CostComparison(          
		[ProjTaskId] [INT],          
		[PartsCost] [FLOAT] NULL ,          
		[LabourCost] [FLOAT] NULL ,          
		[MiscCost] [FLOAT] NULL ,          
		[USAGE] [FLOAT],
		[RRCost] [Float] NULL)          
--#region Actual Costs          
          
-- Insert into temporary table the actual costs for current and alternate projections           
INSERT INTO #aa_CostComparison (ProjTaskId,PartsCost,LabourCost,MiscCost,USAGE)          
SELECT           
A.ProjTaskId,          
SUM(woo.PartsSell*wos.PercentParts / 100.00 / wo.ExchangeRate) AS PartsCost,          
SUM(woo.LabourSell*wos.PercentLabour / 100.00 / wo.ExchangeRate) AS LabourCost,          
SUM(woo.MiscSell*wos.PercentMisc / 100.00 / wo.ExchangeRate) AS MiscCost,          
dbo.GET_USAGE_FROM_DATE_F(A.EqpProjId,@QUOMID,          
CASE WHEN PWO.AMTStartDate<=EP.StartDate THEN DATEADD(n,1,EP.StartDate) ELSE PWO.AMTStartDate END) AS USAGE
FROM           
tblWorkOrderProjs WOP          
 INNER JOIN          
#aa_Tasks A          
 ON WOP.ProjTaskId = A.ProjTaskId          
 INNER JOIN          
#ProjTaskDefaults PT          
 ON A.ProjTaskId=PT.ProjTaskId          
 INNER JOIN          
#aa_EqpProj EP          
 ON A.EqpProjId=EP.EqpProjId          
 INNER JOIN          
tblWorkOrders WO          
 ON WOP.WorkOrderId=WO.AmtParentWorkOrderId           
 INNER JOIN          
tblWorkOrderOperations WOO           
 ON WO.WorkOrderId = WOO.WorkOrderId           
 INNER JOIN          
tblWorkOrderSettlements WOS           
 ON WO.WorkOrderId = WOS.WorkOrderId          
 INNER JOIN          
tblWorkOrders PWO          
 ON WO.AmtParentWorkOrderId=PWO.WorkOrderId          
 LEFT OUTER JOIN          
TASK T          
 ON PWO.WorkOrderId=T.Work_Order_Id          
WHERE           
/*(EP.Projection_Type_Id IN(1,3)/* Current, Alternate*/) AND*/          
(@CostBearerID='' OR ISNULL(WOS.CostBearerId,ISNULL(ISNULL(T.Cost_Bearer_ID, PT.Cost_Bearer_Id), EP.Default_Cost_Bearer_ID)) IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@CostBearerID))) AND          
(@costCentreID='' OR ISNULL(ISNULL(T.Cost_Centre_ID, PT.Cost_Centre_ID),EP.Cost_Centre_ID) IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@costCentreID))) AND          
(@costActivityID='' OR ISNULL(WOS.Cost_Activity_ID,A.Cost_Activity_ID) IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@costActivityID))) AND          
(@costExpenseID='' OR           
ISNULL(WOS.Cost_Expense_ID,ISNULL(ISNULL(T.Parts_Cost_Expense_Id, PT.Parts_Cost_Expense_Id),A.Cost_Expense_ID)) IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@costExpenseID)) OR          
ISNULL(WOS.Cost_Expense_ID,ISNULL(ISNULL(T.Labour_Cost_Expense_Id, PT.Labour_Cost_Expense_Id),A.Cost_Expense_ID)) IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@costExpenseID)) OR          
ISNULL(WOS.Cost_Expense_ID,ISNULL(ISNULL(T.Misc_Cost_Expense_Id, PT.Misc_Cost_Expense_Id),A.Cost_Expense_ID)) IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@costExpenseID))) AND          
          
(@costResponsibilityID='' OR ISNULL(WOS.Cost_Responsibility_ID,EP.Cost_Responsibility_ID) IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@costResponsibilityID)))          
          
GROUP BY A.ProjTaskId,A.EqpProjId,CASE WHEN PWO.AMTStartDate<=EP.StartDate THEN DATEADD(n,1,EP.StartDate) ELSE PWO.AMTStartDate END          
          
DROP TABLE #ProjTaskDefaults          
          
--#endregion          
           
          
          
--#region Insert into temporary table the future costs for current and alternate projections and the costsfor all other projections. Do not include unassigned tasks          
           
INSERT INTO #aa_CostComparison (ProjTaskId,PartsCost,LabourCost,MiscCost,USAGE)          
SELECT           
PT.ProjTaskId,          
          
CASE WHEN @Escalated = 1 THEN          
 SUM(pta.PartsCost * pto.Probability * cpe.CumPartsEscalation / cpe1.CumPartsEscalation / 100.00 / erc.ExRate)          
ELSE           
 SUM(pta.PartsCost * pto.Probability / 100.00 / erc.ExRate)          
END  AS PartsCost,          
          
CASE WHEN @Escalated = 1 THEN          
 SUM(pta.TotalLabourCost * pto.Probability * ce.CumLaborEscalation / ce1.CumLaborEscalation / 100.00 / erc.ExRate)           
ELSE           
 SUM(pta.TotalLabourCost * pto.Probability / 100.00 / erc.ExRate)          
END  AS LabourCost,          
CASE WHEN @Escalated = 1 THEN          
 SUM(pta.TotalMiscCost * pto.Probability * ce.CumMiscEscalation / ce1.CumMiscEscalation / 100.00 / erc.ExRate)          
ELSE           
 SUM(pta.TotalMiscCost * pto.Probability / 100.00 / erc.ExRate)          
END AS MiscCost, 
CASE           
WHEN occ.OccDate<=EP.StartDate OR ISNULL(PT.UsageQUOMId,0)<>ISNULL(@QUOMId,0) THEN          
dbo.GET_USAGE_FROM_DATE_F(pt.EqpProjId,@QUOMId,          
CASE WHEN occ.OccDate<=EP.StartDate THEN DATEADD(n,1,EP.StartDate) ELSE occ.OccDate END)           
ELSE occ.OccUsage END AS USAGE           
 FROM           
#aa_EqpProj EP          
 INNER JOIN          
#aa_Tasks PT          
 ON EP.EqpProjId=PT.EqpProjId          
 INNER JOIN           
tblProjTaskOpts pto           
 ON PT.ProjTaskId = pto.ProjTaskId          
 INNER JOIN           
PROJ_TASK_AMT_COST_1_V pta           
 ON PTO.ProjTaskOptId = pta.ProjTaskOptId          
 INNER JOIN           
tblProjTaskOccs occ           
 ON PT.ProjTaskId = occ.ProjTaskId            
 INNER JOIN           
tblExRateCurrencies erc           
 ON pta.CurrencyId = erc.CurrencyID AND EP.ExchangeRateId = erc.ExRateID          
 INNER JOIN           
tblCostEscalations ce           
 ON ce.EndDate > pta.Pricing_Date AND ce.EscalationDate <= pta.Pricing_Date           
 INNER JOIN           
tblCostPartsEscalations cpe           
 ON ce.CostEscalationId = cpe.CostEscalationId AND cpe.ManufacturerId = pt.ManufacturerId          
 INNER JOIN           
tblCostEscalations ce1           
 ON occ.OccDate >= ce1.EscalationDate AND occ.OccDate < ce1.EndDate          
 INNER JOIN           
tblCostPartsEscalations cpe1           
 ON ce1.CostEscalationId = cpe1.CostEscalationId AND pt.ManufacturerId = cpe1.ManufacturerId           
WHERE (PT.Unscheduled=0) AND          
(@costResponsibilityID='' OR EP.Cost_Responsibility_ID IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@costResponsibilityID))) AND          
(@CostBearerID='' OR ISNULL(pta.Cost_Bearer_ID, ep.Default_Cost_Bearer_ID) IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@CostBearerID))) AND          
(@costCentreID='' OR ISNULL(pta.Cost_Centre_ID, ep.Cost_Centre_ID) IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@costCentreID))) AND          
(@costExpenseID='' OR           
 ISNULL(pta.Parts_Cost_Expense_ID, pt.Cost_Expense_ID) IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@costExpenseID)) OR          
 ISNULL(pta.Labour_Cost_Expense_ID, pt.Cost_Expense_ID) IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@costExpenseID)) OR          
 ISNULL(pta.Misc_Cost_Expense_ID, pt.Cost_Expense_ID) IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@costExpenseID))          
)           
GROUP BY PT.ProjTaskId,PT.EqpProjId,PT.UsageQUOMId,occ.OccDate,EP.StartDate,occ.OccUsage       


--Update Repair Reserve
UPDATE #aa_CostComparison SET RRCost = RRC.RRCost
FROM #aa_CostComparison
INNER JOIN
	(
	SELECT  
	distinct         
	PT.ProjTaskId,(PCC.Total_P+PCC.Total_L+PCC.Total_M )/OCCP.Occ AS   RRCost ,
	OCCP.Occ          
	FROM           
	#aa_EqpProj EP          
	INNER JOIN          
	#aa_Tasks PT          
	ON EP.EqpProjId=PT.EqpProjId          
	INNER JOIN           
	tblProjTaskOpts pto           
	ON PT.ProjTaskId = pto.ProjTaskId          
	INNER JOIN           
	PROJ_TASK_AMT_COST_1_V pta           
	ON PTO.ProjTaskOptId = pta.ProjTaskOptId          
	INNER JOIN           
	tblProjTaskOccs occ           
	ON PT.ProjTaskId = occ.ProjTaskId            
	INNER JOIN           
	tblExRateCurrencies erc           
	ON pta.CurrencyId = erc.CurrencyID AND EP.ExchangeRateId = erc.ExRateID          
	INNER JOIN           
	tblCostEscalations ce           
	ON ce.EndDate > pta.Pricing_Date AND ce.EscalationDate <= pta.Pricing_Date           
	INNER JOIN           
	tblCostPartsEscalations cpe           
	ON ce.CostEscalationId = cpe.CostEscalationId AND cpe.ManufacturerId = pt.ManufacturerId          
	INNER JOIN           
	tblCostEscalations ce1           
	ON occ.OccDate >= ce1.EscalationDate AND occ.OccDate < ce1.EndDate          
	INNER JOIN           
	tblCostPartsEscalations cpe1           
	ON ce1.CostEscalationId = cpe1.CostEscalationId AND pt.ManufacturerId = cpe1.ManufacturerId  
	LEFT JOIN
		(SELECT PT.ParentTaskId,            
		SUM(CB.AdjFactor*CASE WHEN PTA.Consumable=1 AND JC.Lube=1 THEN CB.Lube ELSE CB.Incl END*            
		CASE @Escalated WHEN 1 THEN PC.PrimePartsSell ELSE PC.PrimePartsSellNoEsc END) AS Total_P,            

		SUM(CB.AdjFactor*CB.Incl*CASE @Escalated WHEN 1 THEN PC.PrimeLabourSell ELSE PC.PrimeLabourSellNoEsc END) AS Total_L,            

		SUM(CB.AdjFactor*CB.Incl*CASE @Escalated WHEN 1 THEN PC.PrimeMiscSell ELSE PC.PrimeMiscSellNoEsc END) AS Total_M,            
		SUM(CB.Incl*PC.LabourHours) AS Total_LH,            
		SUM(CB.Incl*PC.Duration) AS Total_D            
		FROM            
		#aa_Tasks PT            
		INNER JOIN            
		tblRepProjCosts PC            
		ON PT.ProjTaskId=PC.ProjTaskId            
		INNER JOIN             
		PROJ_TASK_AMT_COST_1_V PTA            
		ON PC.ProjTaskAmtId=PTA.ProjTaskAmtId            
		INNER JOIN            
		#aa_CostBearer CB            
		ON PTA.Cost_Bearer_Id =CB.CostBearerId            
		LEFT JOIN            
		tblJobCodes JC            
		ON PTA.JobCodeId=JC.JobCodeId            
		WHERE PT.ParentTaskId >0            
		GROUP BY PT.ParentTaskId) PCC            
	ON PT.ProjTaskId=PCC.ParentTaskId  
	LEFT JOIN
		(SELECT PT.ProjTaskId, COUNT(OCC.ProjTaskId) AS Occ            
		FROM             
		#aa_Tasks PT            
		INNER JOIN             
		tblProjTaskOccs occ             
		ON PT.ProjTaskId = occ.ProjTaskId             
		WHERE PT.ParentTaskId IS NULL            
		GROUP BY PT.ProjTaskId) OCCP            
	ON PT.ProjTaskId=OCCP.ProjTaskId          
	WHERE (PT.Unscheduled=0) AND 
	(@costResponsibilityID='' OR EP.Cost_Responsibility_ID IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@costResponsibilityID))) AND          
	(@CostBearerID='' OR ISNULL(pta.Cost_Bearer_ID, ep.Default_Cost_Bearer_ID) IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@CostBearerID))) AND          
	(@costCentreID='' OR ISNULL(pta.Cost_Centre_ID, ep.Cost_Centre_ID) IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@costCentreID))) AND          
	(@costExpenseID='' OR           
	ISNULL(pta.Parts_Cost_Expense_ID, pt.Cost_Expense_ID) IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@costExpenseID)) OR          
	ISNULL(pta.Labour_Cost_Expense_ID, pt.Cost_Expense_ID) IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@costExpenseID)) OR          
	ISNULL(pta.Misc_Cost_Expense_ID, pt.Cost_Expense_ID) IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@costExpenseID)))) RRC 
ON #aa_CostComparison.ProjTaskId = RRC.ProjTaskID         
          
DECLARE @IntervalMin INT          
DECLARE @IntervalMax INT          
DECLARE @IntNumber INT          
          
--Set start and end interval id          
UPDATE #aa_EqpProj SET StartIntervalId=FLOOR(StartUsage/@Interval),EndIntervalId=CEILING(EndUsage/@Interval)          
          
SELECT @IntervalMin =MIN(StartIntervalId), @IntervalMax=MAX(EndIntervalId)          
FROM #aa_EqpProj          
          
CREATE TABLE #aa_Intervals(IntervalId INT,IntervalStart INT,IntervalEnd INT PRIMARY KEY (IntervalId))          
          
SET @IntNumber=@IntervalMin          
          
WHILE @IntNumber<=@IntervalMax          
BEGIN          
	INSERT INTO #aa_Intervals(IntervalId,IntervalStart,IntervalEnd)          
	VALUES(@IntNumber,@IntNumber*@Interval,(@IntNumber+1)*@Interval)
	SET @IntNumber=@IntNumber+1          
END          
          
IF EXISTS (SELECT ProjTaskId FROM #aa_Tasks WHERE Unscheduled=1)          
BEGIN          
           
 CREATE TABLE #aa_EqpPeriod(EqpProjId INT,IntervalId INT,          
 IntervalStartDate DATETIME,IntervalEndDate DATETIME,          
 StartPeriod INT,EndPeriod INT          
  PRIMARY KEY (EqpProjId,IntervalId))          
          
 INSERT INTO #aa_EqpPeriod(EqpProjId,IntervalId,IntervalStartDate,IntervalEndDate)          
 SELECT EPR.EqpProjId,I.IntervalId,          
          
 /*This will return eqpstart date if period starts before the start date*/          
 dbo.GET_DATE_FROM_USAGE_F(EPR.EqpProjId,@QUOMId,I.IntervalStart) AS IntervalStartDate,          
          
 dbo.GET_DATE_FROM_USAGE_F(EPR.EqpProjId,@QUOMId,I.IntervalEnd) AS IntervalEndDate          
 FROM          
 #aa_EqpProj EPR          
  INNER JOIN          
 #aa_Intervals I          
  ON I.IntervalId >= EPR.StartIntervalId AND I.IntervalId<=EPR.EndIntervalId          
          
 UPDATE #aa_EqpPeriod SET           
 StartPeriod=YEAR(IntervalStartDate)*100+MONTH(IntervalStartDate),           
 EndPeriod=YEAR(IntervalEndDate)*100+MONTH(IntervalEndDate)          
          
       
          
 CREATE TABLE #aa_Usages(EqpProjId INT, CalenderPeriod INT, PeriodStartUsage FLOAT,PeriodEndUsage FLOAT,          
  PeriodUsage FLOAT)          
          
 IF @QUOMId IS NULL          
 BEGIN          
          
  --Calculate usages in days. RepUsage table does not have date based records if equipment is not date based          
          
  INSERT INTO #aa_Usages(EqpProjId, CalenderPeriod, PeriodStartUsage,PeriodEndUsage,PeriodUsage)          
  SELECT DISTINCT PT.EqpProjId,RPC.Period AS CalenderPeriod,          
          
  CAST(RU.PeriodStartDate AS FLOAT)-CAST(EP.StartDate AS FLOAT) AS PeriodStartUsage,          
  CAST(RU.PeriodEndDate AS FLOAT)-CAST(EP.StartDate AS FLOAT) AS PeriodEndUsage,          
  RU.PeriodDays AS PeriodUsage          
  FROM          
  #aa_EqpProj EP          
   INNER JOIN          
  #aa_Tasks PT          
   ON EP.EqpProjId=PT.EqpProjId          
   INNER JOIN          
  tblRepProjCosts RPC          
   ON PT.ProjTaskId=RPC.ProjTaskId           
   INNER JOIN            
  tblRepUsages RU          
   ON RPC.Period=RU.CalenderPeriod AND RPC.EqpProjId=RU.EqpProjId AND ISNULL(RU.QUOMId,0)=ISNULL(EP.EndQUOMId,0)          
  WHERE PT.Unscheduled=1          
            
 END          
 ELSE --@QUOMId>0          
 BEGIN          
  INSERT INTO #aa_Usages(EqpProjId, CalenderPeriod, PeriodStartUsage,PeriodEndUsage,          
  PeriodUsage)          
  SELECT DISTINCT PT.EqpProjId,RU.CalenderPeriod, RU.PeriodStartUsage,RU.PeriodEndUsage,          
  RU.PeriodUsage          
  FROM          
  #aa_Tasks PT          
   INNER JOIN          
  tblRepProjCosts RPC          
   ON PT.ProjTaskId=RPC.ProjTaskId           
   INNER JOIN            
  tblRepUsages RU          
   ON RPC.Period=RU.CalenderPeriod AND RPC.EqpProjId=RU.EqpProjId AND RU.QUOMId=@QUOMId          
  WHERE PT.Unscheduled=1          
 END         
          


 /*(1) Add costs for the intervals which start period< end period*/          
          
 INSERT INTO #aa_CostComparison (ProjTaskId,PartsCost,LabourCost,MiscCost,USAGE)          
 SELECT           
 PT.ProjTaskId,          
          
 SUM(          
  CASE           
  /*Could happen for the last interval*/          
  WHEN RU.PeriodEndUsage<I.IntervalStart THEN 0          
  /*period usage is in the interval*/          
  WHEN RU.PeriodStartUsage >=I.IntervalStart AND RU.PeriodEndUsage<=I.IntervalEnd THEN 1.00          
  /*interval is in period usage*/          
  WHEN RU.PeriodStartUsage <=I.IntervalStart AND RU.PeriodEndUsage>=I.IntervalEnd THEN @Interval/RU.PeriodUsage          
  /*period starts before interval and ends in  the interval*/            
  WHEN RU.PeriodStartUsage<I.IntervalStart AND RU.PeriodEndUsage<=I.IntervalEnd THEN (RU.PeriodEndUsage-I.IntervalStart)/RU.PeriodUsage          
  /*period starts in the interval, ends after the interval*/          
  WHEN RU.PeriodStartUsage>I.IntervalStart AND RU.PeriodEndUsage>=I.IntervalEnd THEN (I.IntervalEnd-RU.PeriodStartUsage)/RU.PeriodUsage          
  END          
 *           
 RPC.PrimePartsSell) AS PartsCost,          
          
 SUM(          
           
 CASE           
 /*Could happen for the last interval*/          
 WHEN RU.PeriodEndUsage<I.IntervalStart THEN 0          
 /*period usage is in the interval*/          
 WHEN RU.PeriodStartUsage >=I.IntervalStart AND RU.PeriodEndUsage<=I.IntervalEnd THEN 1.00          
 /*interval is in period usage*/          
 WHEN RU.PeriodStartUsage <=I.IntervalStart AND RU.PeriodEndUsage>=I.IntervalEnd THEN @Interval/RU.PeriodUsage          
 /*period starts before interval and ends in  the interval*/            
 WHEN RU.PeriodStartUsage<I.IntervalStart AND RU.PeriodEndUsage<=I.IntervalEnd THEN (RU.PeriodEndUsage-I.IntervalStart)/RU.PeriodUsage          
 /*period starts in the interval, ends after the interval*/          
 WHEN RU.PeriodStartUsage>I.IntervalStart AND RU.PeriodEndUsage>=I.IntervalEnd THEN (I.IntervalEnd-RU.PeriodStartUsage)/RU.PeriodUsage          
 END * RPC.PrimeLabourSell) AS LabourCost,          
          
 SUM(          
 CASE           
 /*Could happen for the last interval*/          
 WHEN RU.PeriodEndUsage<I.IntervalStart THEN 0          
 /*period usage is in the interval*/          
 WHEN RU.PeriodStartUsage >=I.IntervalStart AND RU.PeriodEndUsage<=I.IntervalEnd THEN 1.00          
 /*interval is in period usage*/          
 WHEN RU.PeriodStartUsage <=I.IntervalStart AND RU.PeriodEndUsage>=I.IntervalEnd THEN @Interval/RU.PeriodUsage          
 /*period starts before interval and ends in  the interval*/            
 WHEN RU.PeriodStartUsage<I.IntervalStart AND RU.PeriodEndUsage<=I.IntervalEnd THEN (RU.PeriodEndUsage-I.IntervalStart)/RU.PeriodUsage          
 /*period starts in the interval, ends after the interval*/          
 WHEN RU.PeriodStartUsage>I.IntervalStart AND RU.PeriodEndUsage>=I.IntervalEnd THEN (I.IntervalEnd-RU.PeriodStartUsage)/RU.PeriodUsage          
 END *RPC.PrimeMiscSell) AS MiscCost,          
 CASE           
 WHEN I.IntervalStart+@Interval/2.00>E.EndUsage THEN E.EndUsage          
 ELSE I.IntervalStart+@Interval/2.00 END AS USAGE          
 FROM          
 #aa_EqpProj E          
  INNER JOIN          
 #aa_Tasks PT          
  ON E.EqpProjId=PT.EqpProjId          
  INNER JOIN          
 #aa_EqpPeriod EP          
  ON PT.EqpProjId=EP.EqpProjId          
  INNER JOIN          
 #aa_Intervals I          
  ON EP.IntervalId=I.IntervalId          
  INNER JOIN          
 tblRepProjCosts RPC          
  ON PT.ProjTaskId=RPC.ProjTaskId AND EP.EqpProjId=RPC.EqpProjId AND           
     RPC.Period >=EP.StartPeriod AND RPC.Period<=EP.EndPeriod           
  INNER JOIN          
 #aa_Usages RU          
  ON RPC.Period=RU.CalenderPeriod AND RPC.EqpProjId=RU.EqpProjId            
 WHERE PT.Unscheduled=1 AND          
 (@costResponsibilityID='' OR RPC.Cost_Responsibility_ID IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@costResponsibilityID))) AND          
 (@CostBearerID='' OR RPC.CostBearerID IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@CostBearerID))) AND          
 (@costCentreID='' OR RPC.Cost_Centre_ID IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@costCentreID))) AND          
 (@costExpenseID='' OR RPC.Cost_Expense_ID IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@costExpenseID)))          
          
 GROUP BY PT.ProjTaskId,I.IntervalStart,E.EndUsage,I.IntervalEnd          
           
 DROP TABLE #aa_EqpPeriod,#aa_Usages          
           
END         
          
         
UPDATE C SET C.Usage=ROUND(CASE WHEN C.Usage>E.EndUsage THEN E.EndUsage ELSE C.Usage END,4)          
from          
#aa_CostComparison C          
 INNER JOIN          
tblProjTasks PT          
 ON C.ProjTaskId=PT.ProjTaskId          
 INNER JOIN          
#aa_EqpProj E          
 ON PT.EqpProjId=E.EqpProjId          
          
          
--Create a temporary table          
CREATE TABLE #aa_CostInterval(          
ProjTaskId INT,          
Cost FLOAT,           
PartsCost FLOAT,          
MiscCost FLOAT,          
LabourCost FLOAT,          
IntervalId INT)          
    
          
CREATE TABLE #aa_AnalyseBy(ProjTaskId INT  PRIMARY KEY (ProjTaskId))          
           
BEGIN          
    
 INSERT INTO #aa_CostInterval(ProjTaskId, Cost,PartsCost,MiscCost,LabourCost,IntervalId)
 SELECT CC.ProjTaskId, @P*SUM(CC.PartsCost)+@L*SUM(CC.LabourCost)+@M*SUM(CC.MiscCost)+SUM(ISNULL(CC.RRCost,0)) AS Cost,          
 SUM(CC.PartsCost),          
 SUM(CC.MiscCost),          
 SUM(CC.LabourCost),          
 I.IntervalId          
 FROM          
 #aa_CostComparison CC          
  INNER JOIN          
 #aa_Intervals I          
  ON CC.USAGE >I.IntervalStart AND CC.USAGE<=I.IntervalEnd       
  LEFT JOIN        
 (SELECT PT.ParentTaskId,        
 SUM(CB.AdjFactor*CASE WHEN PTA.Consumable=1 AND JC.Lube=1 THEN CB.Lube ELSE CB.Incl END*        
 CASE @Escalated WHEN 1 THEN PC.PrimePartsSell ELSE PC.PrimePartsSellNoEsc END) +           
 SUM(CB.AdjFactor*CB.Incl*CASE @Escalated WHEN 1 THEN PC.PrimeLabourSell ELSE PC.PrimeLabourSellNoEsc END) +           
 SUM(CB.AdjFactor*CB.Incl*CASE @Escalated WHEN 1 THEN PC.PrimeMiscSell ELSE PC.PrimeMiscSellNoEsc END) AS Total        
    
 FROM        
 #aa_CostInterval CI        
  INNER JOIN        
  tblProjTasks PT    
  ON CI.ProjTaskId = PT.ProjTaskId    
  INNER JOIN    
 tblRepProjCosts PC        
  ON PT.ProjTaskId=PC.ProjTaskId        
  INNER JOIN         
 PROJ_TASK_AMT_COST_1_V PTA        
  ON PC.ProjTaskAmtId=PTA.ProjTaskAmtId        
  INNER JOIN        
 #aa_CostBearer CB        
  ON PTA.Cost_Bearer_Id =CB.CostBearerId        
  LEFT JOIN        
 tblJobCodes JC        
  ON PTA.JobCodeId=JC.JobCodeId        
 WHERE PT.ParentTaskId >0        
 GROUP BY PT.ParentTaskId) PCC        
  ON CC.ProjTaskId=PCC.ParentTaskId           
 GROUP BY CC.ProjTaskId, I.IntervalId ,Total         
          
 INSERT INTO #aa_AnalyseBy(ProjTaskId)          
 SELECT DISTINCT ProjTaskId FROM #aa_Tasks          
          
END          
          
--Add Missing intervals          
INSERT INTO #aa_CostInterval(ProjTaskId,PartsCost,MiscCost,LabourCost,Cost,IntervalId)          
SELECT A.ProjTaskId,0,0,0, 0 AS Cost,A.IntervalId          
FROM          
(SELECT ProjTaskId,IntervalId FROM #aa_AnalyseBy CROSS JOIN #aa_Intervals) A          
 LEFT JOIN          
#aa_CostInterval CI          
 ON A.ProjTaskId=CI.ProjTaskId  AND A.IntervalId=CI.IntervalId          
WHERE CI.IntervalId IS NULL          
          
DECLARE @MinUsage FLOAT          
DECLARE @MaxUsage FLOAT          
          
SELECT @MinUsage=MIN(StartUsage),@MaxUsage=MAX(EndUsage) FROM #aa_EqpProj          
          
UPDATE #aa_Intervals SET IntervalStart=@MinUsage          
WHERE IntervalStart<@MinUsage          
          
UPDATE #aa_Intervals SET IntervalEnd=@MaxUsage          
WHERE IntervalEnd>@MaxUsage          
          
DELETE #aa_Intervals           
WHERE IntervalStart>IntervalEnd OR IntervalStart=IntervalEnd          
          
          
--END NEW ONE          
          
          
 CREATE TABLE #aa_ProjSummary(ProjTaskId int,[First] float,Frequency float,Task_Header_Id int,ParentTaskId int,            
 QUOMId int,Cost float,FieldLabourHours FLOAT,FieldLabourCost FLOAT,Parts FLOAT,Labour FLOAT,Misc FLOAT,ModifierId INT,TaskType VARCHAR(100) COLLATE DATABASE_DEFAULT,  PRIMARY KEY(ProjTaskId))            
             
 INSERT INTO #aa_ProjSummary(ProjTaskId,[First],Frequency,Task_Header_Id,ParentTaskId,QUOMId, ModifierId,Cost, FieldLabourHours,FieldLabourCost,Parts,Labour,Misc ,TaskType)            
 SELECT             
PT.ProjTaskId,PT.First,PT.Frequency,PT.Task_Header_Id,PT.ParentTaskId,PT.UsageQUOMId AS QUOMId,  PT.ModifierId,              
 SUM(CB.AdjFactor*CASE CAST(PTA.Consumable AS int)*CAST(JC.Lube as int) WHEN 1 THEN CB.Lube ELSE CB.Incl END*                
 pta.PartsCost* pto.Probability  * @P *                
 CASE @Escalated WHEN 1 THEN cpe.CumPartsEscalation  ELSE 1.00 END                
 / 100.00 / erc.ExRate) +                
                
 SUM(CB.AdjFactor*CB.Incl*pta.TotalLabourCost * pto.Probability * @L *                
 CASE @Escalated WHEN 1 THEN ce.CumLaborEscalation ELSE 1.00 END                
 / 100.00 / erc.ExRate) +                
                
 SUM(CB.AdjFactor*CB.Incl*pta.TotalMiscCost * pto.Probability *  @M *               
 CASE @Escalated WHEN 1 THEN ce.CumMiscEscalation  ELSE 1.00 END                
 / 100.00 / erc.ExRate) AS Cost ,              
 SUM(CASE PTA.Labour_Hrs_Field WHEN 1 THEN LaborHours ELSE 0 END) AS FieldLabourHours,              
 SUM(CASE PTA.Labour_Hrs_Field WHEN 1 THEN LaborCost ELSE 0 END) AS   FieldLabourCost,     
          
	CASE WHEN @Escalated = 1 THEN @P * SUM(CPE.CumPartsEscalation * PTO.Probability / 100 * PTA.PartsCost / ERC.ExRate) ELSE @P * SUM(PTO.Probability / 100 * PTA.PartsCost / ERC.ExRate) END AS Parts,                
	CASE WHEN @Escalated = 1 THEN @L * SUM(CE.CumLaborEscalation * PTO.Probability / 100 * PTA.TotalLabourCost / ERC.ExRate) ELSE @L * SUM(PTO.Probability / 100 * PTA.TotalLabourCost / ERC.ExRate) END AS Labour,                   
	CASE WHEN @Escalated = 1 THEN @M * SUM(CE.CumMiscEscalation * PTO.Probability / 100 * PTA.TotalMiscCost / ERC.ExRate) ELSE @M * SUM(PTO.Probability / 100 * PTA.TotalMiscCost / ERC.ExRate) END AS Misc,    
 TT.Description AS TaskType     
 FROM             
 #aa_EqpProj Z            
  INNER JOIN            
 tblProjTasks PT            
  ON Z.EqpProjId=PT.EqpProjId            
  INNER JOIN             
 tblProjTaskOpts PTO            
  ON PTO.ProjTaskId = PT.ProjTaskId            
  INNER JOIN             
 PROJ_TASK_AMT_COST_1_V PTA            
  ON PTA.ProjTaskOptId = PTO.ProjTaskOptId            
  INNER JOIN             
 tblCostEscalations CE            
  ON PTA.Pricing_Date >= CE.EscalationDate AND PTA.Pricing_Date < CE.EndDate            
  INNER JOIN             
 tblCostPartsEscalations CPE            
  ON CE.CostEscalationId = CPE.CostEscalationId AND CPE.ManufacturerId = PT.ManufacturerId            
  INNER JOIN             
 tblEqpProjs EPR          
  ON PT.EqpProjId = EPR.EqpProjId            
  INNER JOIN             
 tblExRates ER            
  ON EPR.ExchangeRateId = ER.ExRateID            
  INNER JOIN             
 tblExRateCurrencies ERC            
  ON ERC.ExRateID = ER.ExRateID AND ERC.CurrencyID = PTA.CurrencyID            
  INNER JOIN            
 #aa_CostBearer CB            
  ON PTA.Cost_Bearer_Id =CB.CostBearerId            
  LEFT JOIN            
 tblJobCodes JC            
  ON PTA.JobCodeId=JC.JobCodeId 
 INNER JOIN tblTaskTypes TT ON TT.TaskTypeId = PT.TaskTypeId
  WHERE           
(@CostBearerID='' OR pta.Cost_Bearer_ID IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@CostBearerID))) AND            
(@costCentreID='' OR pta.Cost_Centre_ID IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@costCentreID))) AND            
(@costExpenseID='' OR             
 pta.Parts_Cost_Expense_ID IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@costExpenseID)) OR            
 pta.Labour_Cost_Expense_ID IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@costExpenseID)) OR            
 pta.Misc_Cost_Expense_ID IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@costExpenseID)))                
 GROUP BY PT.ProjTaskId,PT.First,PT.Frequency,PT.Task_Header_Id,PT.ParentTaskId,PT.UsageQUOMId,PT.ModifierId,TT.Description          
           
 SELECT              
 PIA.ProjTaskId, 
 
 CASE WHEN @AlternateDisplay = 0 THEN      
 TH.Description      
 ELSE CC.Description + ' - ' +  ISNULL(NULLIF(PCP.JobCodeDesc,''),'(None)') + ' - ' + ISNULL(NULLIF(MC.Description, ''),'(None)') END AS StrategyTask, 
 PIA.TaskType,ISNULL(Q.UOMShortDesc,@Days) AS UOM,              
 PIA.First,PIA.Frequency,              
 ISNULL(PIA.Cost+ISNULL((PCC.Total_P+PCC.Total_L+PCC.Total_M)/NULLIF(OCCP.Occ,0),0),0) AS Cost,              
 ISNULL(OCCP.Occ,0) AS Occ,              
 ISNULL(PCP.Total_P+PCP.Total_L+PCP.Total_M+ISNULL(PCC.Total_P+PCC.Total_L+PCC.Total_M,0),0) AS TotalC,               
 FieldLabourHours, FieldLabourCost,             
 CI.Cost AS TotalCost,               
 CAST(I.IntervalStart AS VARCHAR)+' - '+CAST(I.IntervalEnd AS VARCHAR) AS INTERVAL,              
 I.IntervalStart,I.IntervalEnd, 1 AS IntOrder              
FROM 
		#aa_ProjSummary PIA  
			INNER JOIN  
		TASK_HEADER TH ON PIA.Task_Header_Id=TH.Task_Header_Id  
			INNER JOIN 
		tblModifierCodes MC ON MC.Code = TH.Modifier_Code   
			INNER JOIN 
		tblComponentCodes CC ON TH.Component_Code = CC.Code 
			INNER JOIN 	
		tblProjTasks ON PIA.ProjTaskId = tblProjTasks.ProjTaskId			          
			INNER JOIN              
		#aa_CostInterval  CI ON PIA.ProjTaskId = CI.ProjTaskId
			INNER JOIN 
		#aa_Intervals  I  ON CI.IntervalId=I.IntervalId              
			LEFT JOIN              
		tblQUOMs Q ON PIA.QUOMId =Q.QUOMId             
			LEFT JOIN      
			(SELECT PT.ProjTaskId,MAX(JC.Description) as JobCodeDesc,              
			SUM(CB.AdjFactor*CASE WHEN PTA.Consumable=1 AND JC.Lube=1 THEN CB.Lube ELSE CB.Incl END*   

			 CASE @Escalated WHEN 1 THEN @P * PC.PrimePartsSell ELSE @P * PC.PrimePartsSellNoEsc END) AS Total_P,                  
    
			SUM(CB.AdjFactor*CB.Incl*CASE @Escalated WHEN 1 THEN @L * PC.PrimeLabourSell ELSE @L * PC.PrimeLabourSellNoEsc END) AS Total_L,                  
			
			SUM(CB.AdjFactor*CB.Incl*CASE @Escalated WHEN 1 THEN @M * PC.PrimeMiscSell ELSE @M *PC.PrimeMiscSellNoEsc END) AS Total_M
			FROM              
			#aa_ProjSummary PT               
				INNER JOIN            
			tblRepProjCosts PC ON PT.ProjTaskId=PC.ProjTaskId              
				INNER JOIN     
	       PROJ_TASK_AMT_COST_1_V PTA ON PC.ProjTaskAmtId=PTA.ProjTaskAmtId              
				INNER JOIN              
			#aa_CostBearer CB  ON PTA.Cost_Bearer_Id =CB.CostBearerId               
				LEFT JOIN              
			tblJobCodes JC  ON PTA.JobCodeId=JC.JobCodeId              
			WHERE PT.ParentTaskId IS NULL           
			GROUP BY PT.ProjTaskId) PCP            
        ON PIA.ProjTaskId=PCP.ProjTaskId       
	LEFT JOIN   
			(SELECT PT.ParentTaskId,              
			SUM(CB.AdjFactor*CASE WHEN PTA.Consumable=1 AND JC.Lube=1 THEN CB.Lube ELSE CB.Incl END*              
			CASE @Escalated WHEN 1 THEN PC.PrimePartsSell ELSE PC.PrimePartsSellNoEsc END) AS Total_P,
			SUM(CB.AdjFactor*CB.Incl*CASE @Escalated WHEN 1 THEN PC.PrimeLabourSell ELSE PC.PrimeLabourSellNoEsc END) AS Total_L,              
			SUM(CB.AdjFactor*CB.Incl*CASE @Escalated WHEN 1 THEN PC.PrimeMiscSell ELSE PC.PrimeMiscSellNoEsc END) AS Total_M,              
			SUM(CB.Incl*PC.LabourHours) AS Total_LH,              
			SUM(CB.Incl*PC.Duration) AS Total_D              
			FROM              
			#aa_ProjSummary PT              
			INNER JOIN              
			tblRepProjCosts PC              
			ON PT.ProjTaskId=PC.ProjTaskId              
			INNER JOIN               
			PROJ_TASK_AMT_COST_1_V PTA              
			ON PC.ProjTaskAmtId=PTA.ProjTaskAmtId              
			INNER JOIN              
			#aa_CostBearer CB              
			ON PTA.Cost_Bearer_Id =CB.CostBearerId              
			LEFT JOIN              
			tblJobCodes JC              
			ON PTA.JobCodeId=JC.JobCodeId              
			WHERE PT.ParentTaskId >0              
			GROUP BY PT.ParentTaskId)      
			PCC              
		ON PIA.ProjTaskId=PCC.ParentTaskId              
	LEFT JOIN              
			(SELECT PT.ProjTaskId, COUNT(OCC.ProjTaskId) AS Occ              
			FROM               
			#aa_ProjSummary PT              
			INNER JOIN               
			tblProjTaskOccs occ               
			ON PT.ProjTaskId = occ.ProjTaskId               
			WHERE PT.ParentTaskId IS NULL              
			GROUP BY PT.ProjTaskId) OCCP              
  ON PIA.ProjTaskId=OCCP.ProjTaskId 
  
  WHERE tblProjTasks.ParentTaskId IS NULL 
             
  ORDER BY IntOrder,I.IntervalStart   
  

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[EXPORT_WORKORDER_STATUS_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[EXPORT_WORKORDER_STATUS_P]
GO

/****** Object:  StoredProcedure [dbo].[EXPORT_WORKORDER_STATUS_P]    Script Date: 05/03/2012 15:03:46 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



  
CREATE PROCEDURE EXPORT_WORKORDER_STATUS_P  
/******************************************************************************  
   
 Name: EXPORT_WORKORDER_STATUS_P  
  
 Called By:   
  
 Desc:   
  
 Auth:  Veronika Vasylyeva  
 Date:  15-Mar-2011  
*******************************************************************************  
  Change History  
*******************************************************************************  
Date:  Author:  Description:  
-------- -------- ----------------------------------------
23 Apr 12   G Dhillon   E796 additional fields

--OLD COMMENTS
  
5  Sep 11 RJ   E625: Export CustomerRef and changes to linked WOS
28 Apr 11 VV   E518: only send WO that have a WOS linked  
11 Apr 11 GD   Added parameter External_Backlog_Id in select list  
*******************************************************************************/  
 /* Param List */  
   
AS  
  
DECLARE @ModelSerialSeparator varchar(5)  
  
SELECT @ModelSerialSeparator = ISNULL(ModelSerialSeparator,'') FROM AMT_VARIABLE  
  
IF NOT EXISTS(SELECT Task_ID FROM TASK WHERE SendWOStatus=1)  
 RETURN  
  
SELECT
EH.Model,  
CASE @ModelSerialSeparator   
WHEN '' THEN EH.SerialNumber   
ELSE REPLACE(EH.SerialNumber,EH.Model+@ModelSerialSeparator,'') END AS Serial_Number,  
EH.EquipmentNo AS Reference_Number,WO.WorkOrderNumber AS Workorder_Number,  
T.ExternalBacklogId as External_Backlog_Id,  
WO.PureWONumber AS Pure_Workorder_Number,WO.Ext_Source_ID AS External_Source_ID,  
CASE T.Task_Status_Id  
WHEN 1 THEN 'OUT'  
WHEN 2 THEN 'IP'  
WHEN 3 THEN 'COMP'  
WHEN 5 THEN 'ABAN'  
WHEN 6 THEN 'YTS'  
End AS Planning_Status,  
  
CASE T.Task_Status_Id WHEN 1/*O*/ THEN NULL  
ELSE  
LEFT(CONVERT(varchar(50),  
dbo.WO_DOWN_TIME_F(ISNULL(E.Planned_Down_Time,T.Planned_Down_Time),T.Planned_Offset),120),16)   
END AS Planned_Start_Time,  
  
CASE T.Task_Status_Id WHEN 1/*O*/ THEN NULL  
ELSE  
LEFT(CONVERT(varchar(50),  
dbo.WO_UP_TIME_F(ISNULL(E.Planned_Down_Time,T.Planned_Down_Time),T.Planned_Offset,T.Expected_Duration),120),16)   
END AS Planned_End_Time,  
  
CASE WHEN T.Task_Status_Id IN (1,5,6)/*O,A,YTS*/ THEN NULL  
ELSE  
LEFT(CONVERT(varchar(50),  
dbo.WO_DOWN_TIME_F(ISNULL(E.Actual_Down_Time,T.Actual_Down_Time),T.ActualOffset),120),16)   
END AS Actual_Start_Time,  
CASE WHEN T.Task_Status_Id IN (1,2,5,6)/*O,IP,A,YTS*/ THEN NULL  
ELSE  
LEFT(CONVERT(varchar(50),  
dbo.WO_UP_TIME_F(ISNULL(ISNULL(E.Actual_Down_Time,T.Actual_Down_Time),GETDATE()),T.ActualOffset,T.Actual_Duration),120),16)   
END AS Actual_End_Time,
T.Customer_Ref,   --E625
--GD 23 Apr 12 E796
T.Description AS Job_Description,PRIORITY.Short_Description AS Priority,CC.Code AS Component_Code,MC.Code AS Modifier_Code,
TT.Code AS Task_Type,AC.Code AS Task_Counter

FROM TASK T    
INNER JOIN EQUIPMENT_HIERARCHY_V EH ON T.Eqp_Plan_ID=EH.EqpPlanId AND EH.Projection_Type_ID=1    
LEFT JOIN tblWorkOrders WO  ON T.Work_Order_ID = WO.WorkOrderId                /*RJ E625 after VV E518 LEFT*/    
LEFT JOIN EVENT E ON T.Event_ID=E.Event_ID 
LEFT JOIN tblComponentCodes CC ON T.Component_Code_ID = CC.ComponentCodeID 
LEFT JOIN tblModifierCodes MC ON T.Modifier_ID = MC.ModifierID
LEFT JOIN tblTaskTypes TT ON T.Task_Type_ID = TT.TaskTypeID
LEFT JOIN tblApplicationCodes AC ON T.Application_Code_ID = AC.ApplicationCodeID
LEFT JOIN PRIORITY ON T.Priority_ID = PRIORITY.Priority_ID
WHERE T.SendWOStatus=1   
AND (ISNULL(ExternalBacklogId, '') <> '' OR (ISNULL(ExternalBacklogId, '') = '' AND WO.WorkOrderId > 0))    --E625  
  
 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[TASK_CHECK_STRATEGY_DETAILS_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[TASK_CHECK_STRATEGY_DETAILS_P]
GO


create      PROCEDURE [dbo].[TASK_CHECK_STRATEGY_DETAILS_P]
/******************************************************************************
	File: 
	Name: TASK_CHECK_STRATEGY_DETAILS_P


	Called By: n/a
	Desc:
	If select codes (Task Type, Component Code, Modifier Code, Application Code) 
	such that these now match a strategy Task in AMT, then:
	-	If this strategy task already exists in Equipment Status then 
		disallow the save of the task and give the user a message.
	-	If the strategy task does not exist in EQS AND 
		the Occurrence Type has not been set or 
		the Occurrence type = the Occurrence type from tblProjTasks 
		THEN populate the Occurrence Type and other Strategy Task fields 
		with the data from table tblProjTasks 
		(ie call an update for the relevant Projected Task)
	-	If the strategy task does not exist in EQS AND the Occurrence Type 
		IS NOT the same as the occurrence type from tblProjTasks THEN 
		populate the Occurrence Type and other Strategy Task fields with 
		the data from table tblProjTasks, 
		
		- 12-Apr-2007 VV This was taken out. Discussed with GE

		SAVE the record, and then with the record still open give the user 
		a message to reselect the Occurrence type.  
		This will force the user to select a valid Occurrence type. 

             
	Auth: Veronika Vasylyeva
	Date: 12 NOV 2002
*******************************************************************************
		Change History
*******************************************************************************
Date:		Author:		Description:
--------	--------	----------------------------------------
26 Aug 11	V Vasylyeva	#2351 : set occurrence type to the default
18 Mar 11	V Vasylyeva	#1427: Do not include IP workorders into check if created for the consistency 
						with strategy task creating maintaining
09 Dec 09	AL			CR8556: FMG Change - can have multiple strategy tasks at the same time
13 May 09	V Vasylyeva	CR8036: If NextOccDate is null - take the earliest occurrence date for the strategy task 
								(tblProjTaskOccs). 	if there are no future occurrencies - set the end date of equipment
28 Oct 08	V Vasylyeva	CR7599: Added check for unscheduled tasks,
						Set also all strategy details to NULL if strategy task does not exist
12 Jun 08	AL			Changed Repair Description size
21 Feb 08	AL			Changed PlanDateLocked to ReviewStatusID
12 Jun 07	V Vasylyeva	Added @CheckOccType,@GetLabourHrs
11 Apr 07	V Vasylyeva	Added @FinalChange,@RiskLifeLeft,@StrategyFrequency,@LastPerformed ,
						@LastScheduled,@LastPerformedDate,@LastScheduledDate
						Took out the changing of occurrence type to the planned option
						occurrence type and warning.
13 Apr 04	V Vasylyeva	Removed Task planned
16 Sep 03	H Singh		new field added in update and insert statements - Strategy_Repair_Description
30-Jan-2003	V Vasylyeva	Added an input parameter @CheckIfCreated to 
				indicate do we need to check if the strategy task
				has already been created in EQS. This parameter
				is set to 0 - do not check if the completed task
				is checked. This parameter shall be set to 1 - check
				if the task has status YTS, InProgress or Outstanding
*******************************************************************************/
	
@Task_ID int=Null,
@Eqp_Plan_ID int,
@CheckIfCreated bit,
@Task_Type_ID int OUTPUT,
@Component_Code_ID int OUTPUT,
@Application_Code_ID int OUTPUT,
@Modifier_ID int OUTPUT,
@Occurrence_Type_Id int OUTPUT,
@Expected_Duration float=NULL OUTPUT,
@Expected_Labor_Hours float=NULL OUTPUT,
@Strategy_Usage float=NULL OUTPUT,
@Strategy_Repair_Description varchar(MAX)=null OUTPUT,
@Strategy_QUOM_ID int=NULL OUTPUT,
@Proj_Task_Opt_ID int=NULL OUTPUT,
@Strategy_Date datetime=NULL OUTPUT,
@Strategy_Locked bit=0 OUTPUT,
@Message varchar(2000)=NULL OUTPUT,
@FinalChange float =0 OUTPUT,
@RiskLifeLeft float =0 OUTPUT,
@StrategyFrequency float =0 OUTPUT,
@LastPerformed float=0 OUTPUT,
@LastScheduled float =0 OUTPUT,
@LastPerformedDate datetime=NULL OUTPUT,
@LastScheduledDate datetime=NULL OUTPUT,
@ProjTaskId int=0 OUTPUT,
@CheckOccType bit=1,
@GetLabourHrs bit=1

AS



DECLARE @Task_Status_Outstanding int
DECLARE @Task_Status_YTS int
DECLARE @Task_Status_InProgress int
DECLARE @ProjTypeCurrent int
DECLARE @LastOcc float
DECLARE @UseSchedulingSystemLastOcc bit
DECLARE @First float
DECLARE @EndUsage float
DECLARE @EndDate datetime
DECLARE @Counter int


SET @Task_Status_Outstanding =1
SET @Task_Status_YTS =6
SET @Task_Status_InProgress =2

SET @CheckIfCreated=ISNULL(@CheckIfCreated,0)
SET @ProjTypeCurrent=1

--If the validation is performing for a new task set task_id=0
SET @Task_ID=ISNULL(@Task_ID,0)

--AMT variables
SELECT @UseSchedulingSystemLastOcc=UseSchedulingSystemLastOcc FROM AMT_VARIABLE

SET @ProjTaskId=ISNULL(@ProjTaskId,0)

--Find a strategy task with the selected codes if exists
IF @ProjTaskId>0
BEGIN
	SELECT 
	@Component_Code_ID=PT.ComponentCodeId,
	@Modifier_ID=PT.ModifierId,
	@Task_Type_ID=PT.TaskTypeId,
	@Application_Code_ID=PT.ApplicationCodeId,
	@Strategy_Repair_Description=ISNULL(NOS.Repair_Description, ''),
	@Strategy_Usage =PT.NextOcc,
	@Strategy_QUOM_ID=PT.UsageQUOMId,
	@Strategy_Date =PT.NextOccDate,
	@Strategy_Locked=CASE WHEN PT.ReviewStatusID=3 THEN CONVERT(BIT,1) ELSE CONVERT(BIT,0) END,
	@LastPerformed =CASE WHEN @UseSchedulingSystemLastOcc =1 AND SchedulingTaskId>0 THEN Ext_Last_Occ ELSE AMT_WO_Last_Occ END,
	@LastScheduled =CASE WHEN @UseSchedulingSystemLastOcc =1 AND SchedulingTaskId>0 THEN Ext_Last_Sched_Occ ELSE AMT_Last_Sched_Occ END,
	@LastPerformedDate=CASE WHEN @UseSchedulingSystemLastOcc =1 AND SchedulingTaskId>0 THEN Ext_Last_Occ_Date ELSE AMT_WO_Last_Occ_Date END,
	@LastScheduledDate=CASE WHEN @UseSchedulingSystemLastOcc =1 AND SchedulingTaskId>0 THEN Ext_Last_Sched_Date ELSE AMT_Last_Sched_Date END, 
	@LastOcc=PT.LastOcc,
	@EndUsage=CASE WHEN ISNULL(EPR.EndQUOMId,0)=ISNULL(PT.UsageQUOMId,0) THEN EPR.EndUsage 
				   ELSE dbo.GET_EQP_PROJ_END_USAGE_F(EPR.EqpProjId, PT.UsageQUOMID,EPR.EndDate) END,
	@EndDate=EPR.EndDate
	FROM         
	tblProjTasks PT
		INNER JOIN
	tblEqpProjs EPR
		ON PT.EqpProjId = EPR.EqpProjId AND PT.EqpPlanId = EPR.EqpPlanId 
		LEFT OUTER JOIN
	NEXT_OCC_STRATEGY NOS 
		ON PT.ProjTaskId = NOS.Proj_Task_Id
	WHERE 
	(PT.ProjTaskId=@ProjTaskId) AND
	(EPR.Projection_Type_Id =@ProjTypeCurrent) AND
	(PT.EqpPlanId=@Eqp_Plan_ID)
	/*VV 28-Oct-08*/AND (PT.Unscheduled=0)
	
	SET @Counter=@@ROWCOUNT

	IF @Counter=0 SET @ProjTaskId=0
	

END--IF @ProjTaskId>0
ELSE
BEGIN
	SELECT 
	@ProjTaskId=PT.ProjTaskId,
	@Strategy_Repair_Description=ISNULL(NOS.Repair_Description, ''),
	@Strategy_Usage =PT.NextOcc,
	@Strategy_QUOM_ID=PT.UsageQUOMId,
	@Strategy_Date =PT.NextOccDate,
	@Strategy_Locked=CASE WHEN PT.ReviewStatusID=3 THEN CONVERT(BIT,1) ELSE CONVERT(BIT,0) END,
	@LastPerformed =CASE WHEN @UseSchedulingSystemLastOcc =1 AND SchedulingTaskId>0 THEN Ext_Last_Occ ELSE AMT_WO_Last_Occ END,
	@LastScheduled =CASE WHEN @UseSchedulingSystemLastOcc =1 AND SchedulingTaskId>0 THEN Ext_Last_Sched_Occ ELSE AMT_Last_Sched_Occ END,
	@LastPerformedDate=CASE WHEN @UseSchedulingSystemLastOcc =1 AND SchedulingTaskId>0 THEN Ext_Last_Occ_Date ELSE AMT_WO_Last_Occ_Date END,
	@LastScheduledDate=CASE WHEN @UseSchedulingSystemLastOcc =1 AND SchedulingTaskId>0 THEN Ext_Last_Sched_Date ELSE AMT_Last_Sched_Date END, 
	@LastOcc=PT.LastOcc,
	@EndUsage=CASE WHEN ISNULL(EPR.EndQUOMId,0)=ISNULL(PT.UsageQUOMId,0) THEN EPR.EndUsage 
				   ELSE dbo.GET_EQP_PROJ_END_USAGE_F(EPR.EqpProjId, PT.UsageQUOMID,EPR.EndDate) END,
	@EndDate=EPR.EndDate
	FROM         
	tblProjTasks PT
		INNER JOIN
	tblEqpProjs EPR
		ON PT.EqpProjId = EPR.EqpProjId AND PT.EqpPlanId = EPR.EqpPlanId 
		LEFT OUTER JOIN
	NEXT_OCC_STRATEGY NOS 
		ON PT.ProjTaskId = NOS.Proj_Task_Id
	WHERE 
	(EPR.Projection_Type_Id =@ProjTypeCurrent) AND
	(PT.EqpPlanId=@Eqp_Plan_ID) AND
	(PT.ComponentCodeId=@Component_Code_ID) AND
	(PT.ModifierId=@Modifier_ID) AND
	(PT.TaskTypeId=@Task_Type_ID) AND
	(PT.ApplicationCodeId=@Application_Code_ID) AND
	/*VV 28-Oct-08*/(PT.Unscheduled=0)
END

--If the strategy task does not exist return
IF ISNULL(@ProjTaskId,0)=0 
BEGIN
	/*VV 28-Oct-2008 Set also all strategy details to NULL before return*/
	SET @Proj_Task_Opt_ID=NULL
	SET @Strategy_Usage =0
	SET @Strategy_Repair_Description =''
	SET @Strategy_QUOM_ID =NULL
	SET @Strategy_Date =NULL
	SET @Strategy_Locked =0
	SET @FinalChange  =0
	SET @RiskLifeLeft  =0
	SET @StrategyFrequency  =0
	SET @LastPerformed =NULL
	SET @LastScheduled  =NULL
	SET @LastPerformedDate =NULL
	SET @LastScheduledDate =NULL

	RETURN

END

--Check if the strategy task exists in EQS

--AL: 09/12/09
DECLARE @MaxPlanningWOtoCreate int
SELECT @MaxPlanningWOtoCreate=ISNULL(Varchar_Value,1) FROM AMT_TYPED_VARIABLE WHERE Value_Name ='MaxPlanningWOtoCreate'


IF @CheckIfCreated=1 AND ISNULL(@MaxPlanningWOtoCreate,1) = 1
BEGIN
	IF EXISTS(SELECT TASK.Task_Id
		FROM    
		TASK INNER JOIN
		tblProjTaskOpts ON TASK.Strategy_Proj_Task_Opt_ID = tblProjTaskOpts.ProjTaskOptId 
		INNER JOIN
		tblProjTasks ON tblProjTaskOpts.ProjTaskId = tblProjTasks.ProjTaskId
		WHERE (TASK.Task_ID<>@Task_ID) AND
		(TASK.Task_Status_ID = @Task_Status_Outstanding OR
		TASK.Task_Status_ID = @Task_Status_YTS /* VV #1427 OR
		TASK.Task_Status_ID = @Task_Status_InProgress*/) AND 	
		(tblProjTasks.ProjTaskId=@ProjTaskId))
	
		BEGIN		
			-- - If this strategy task already exists in Equipment Status then 
			-- disallow the save of the task and give the user a message.
			SET @Task_Type_ID =NULL
			SET @Component_Code_ID =NULL
			SET @Application_Code_ID =NULL
			SET @Modifier_ID =NULL			
			
			SET @Message='Cannot save. This strategy task has already been created.'
			RETURN
		END
END

--Check Occurence type
IF @CheckOccType=1
BEGIN
	--select the option for Occurrence_Type_Id
	--If the occurence type the user selected does not match the projected
	-- task options use the planned option 

	SELECT @Proj_Task_Opt_ID=ProjTaskOptId FROM tblProjTaskOpts 
	WHERE (ProjTaskId=@ProjTaskId) /*VV #2351 AND (OccurrenceTypeId=@Occurrence_Type_Id)*/

END

IF @Proj_Task_Opt_ID IS NULL
BEGIN
	-- 12-Apr-2007 VV Discussed with GE. The warning message to reselect occurence type 
	--was taken out. Occurrence type is not taken from the default option in this case.

	--SET @Message='The strategy task was saved with the planned option details. Please reselect the Occurence Type.'
	SELECT @Proj_Task_Opt_ID = ProjTaskOptId FROM tblProjTaskOpts 
	WHERE (ProjTaskId=@ProjTaskId) /*VV #2351 AND (PlannedOption>0 OR PlannedOption<0)*/
END

--Final change usage
SELECT @FinalChange=MAX(OccUsage) FROM tblProjTaskOccs WHERE ProjTaskId=@ProjTaskId

SELECT @StrategyFrequency =Frequency,@First=[First] FROM tblProjTaskOpts WHERE ProjTaskOptId=@Proj_Task_Opt_ID

SET @FinalChange=ISNULL(ISNULL(@FinalChange,@LastOcc),@First)

--SET @RiskLifeLeft =100.00*(@StrategyFrequency-(@EndUsage - @FinalChange ))/NULLIF(@StrategyFrequency,0)
SET @RiskLifeLeft =dbo.RISK_LIFE_LEFT_F(@StrategyFrequency,@EndUsage,@FinalChange)

IF @GetLabourHrs=1
BEGIN	
	--Select the strategy details
	SELECT  @Expected_Labor_Hours=SUM(LaborHours), @Expected_Duration=SUM(Duration) 
	FROM tblProjTaskAmts WHERE ProjTaskOptId=@Proj_Task_Opt_ID
END

--VV 13-May-2009 CR8036
IF @Strategy_Date IS NULL
BEGIN
	/*If NextOccDate is null - take the earliest occurrence date for the strategy task (tblProjTaskOccs) 
	if there are no future occurrencies - set the end date.*/
	SELECT @Strategy_Date=MIN(OccDate),@Strategy_Usage=MIN(OccUsage )
	FROM tblProjTaskOccs WHERE ProjTaskId=@ProjTaskId
END

SET @Strategy_Date=ISNULL(@Strategy_Date,@EndDate)
SET @Strategy_Usage=ISNULL(@Strategy_Usage,@EndUsage)

GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[EVENT_TASKS_DELETE_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[EVENT_TASKS_DELETE_P]
GO

 
 
create         Procedure [dbo].[EVENT_TASKS_DELETE_P]
/******************************************************************************
	File:
	Name: EVENT_TASKS_DELETE_P

	Called By: 

	Desc: 1. Deletes TASKS from Deferred_Task table
	      2. Set task status to Outstanding and unlinks task from event
             

	Auth: Veronika Vasylyeva
	Date: 28-AUG-2002
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	23 Apr 11	D Smith		#1331: Fixed terminology of some error messages
	25 Jun 10	V Vasylyeva	CR8985: Discussed with RF:If workorder was abandoned in Event
							unlink it from Event and do  not change status to outstanding.
	29 Mar 10	AL			CR8865: Check if Health Safety Auditable
	09 Dec 09	AL			CR8556: FMG Change - can have multiple strategy tasks at the same time
	10-Nov-2009	V Vasylyeva	CR8411 If there are duplicate strategy backlogs exist
							give the user a message
	15-Jun-2007	V Vasylyeva	Chenges for the new planning module
	30 Jan 2006	V vasylyeva	exec TASK_WORK_ORDER_LINK_MULTI_P to relink workorders
	05-Jul-2004	V Vasylyeva	Transaction isolation level, nolock, updatelock,rowlock
	8-Jan-2003	V Vasylyeva	Set Primary_Cause flag to 0 for the
					backlog tasks.
					Removed the dynamic SQL and replaced it 
					with CHARINDEX (...)
    	19-Sep-2002	V Vasylyeva	Delete records from Deferred_Task table
					Set Task.Event_ID=Null
*******************************************************************************/
	/* Param List */
	@Event_ID int,
	@Event_Last_Mod_Date varchar(25)=NULL,
    @Tasks varchar(8000),
	@Error_Number int = 0 OUTPUT,
	@Message varchar(8000) OUTPUT,
	@UnlinkAll bit=0
     
AS
Set TRANSACTION ISOLATION LEVEL READ COMMITTED
--Check that Event was not changed


DECLARE @TaskStatusOUS int
DECLARE @tasksToRelink varchar(8000)
DECLARE @TaskStatusYTS int
/*VV CR8985*/
DECLARE @TaskStatusA int

SET @TaskStatusOUS=1
SET @Message=''
SET @TaskStatusYTS=6
/*VV CR8985*/
SET @TaskStatusA=5

DECLARE @z_TASK TABLE (TaskId int,Strategy_Proj_Task_Opt_ID int PRIMARY KEY(TaskId))

IF @UnlinkAll=1
BEGIN
	INSERT INTO @z_TASK(TaskId,Strategy_Proj_Task_Opt_ID)
	SELECT Task_ID,
	/*VV CR8985*/
	CASE Task_Status_ID WHEN @TaskStatusA THEN NULL ELSE Strategy_Proj_Task_Opt_ID END AS Strategy_Proj_Task_Opt_ID
	FROM TASK WHERE Event_ID=@Event_ID
END
ELSE
BEGIN

	INSERT INTO @z_TASK(TaskId,Strategy_Proj_Task_Opt_ID)
	SELECT LTT.list_item,
	/*VV CR8985*/
	CASE Task_Status_ID WHEN @TaskStatusA THEN NULL ELSE Strategy_Proj_Task_Opt_ID END AS Strategy_Proj_Task_Opt_ID
	FROM 
	dbo.LIST_TO_TABLE_F(@Tasks) LTT
		INNER JOIN
	TASK T
		ON LTT.list_item=T.Task_ID
	
	--Cannot delete primary cause task
	IF EXISTS(SELECT Task_Id FROM 
		@z_TASK Z 
			INNER JOIN 
		TASK T ON Z.TaskId=T.Task_Id 
		WHERE T.Event_id=@Event_Id  AND T.Primary_Cause=1)
	BEGIN
		SET @Message='The Primary Workorder cannot be deleted.'
		RETURN
	END

	IF EXISTS(SELECT Task_Id FROM 
		@z_TASK Z 
			INNER JOIN 
		DEFERRED_TASK DT ON Z.TaskId=DT.Task_Id 
		WHERE DT.Event_id=@Event_Id  AND DT.Primary_Cause=1)
	BEGIN
		SET @Message='The Primary Workorder cannot be deleted.'
		RETURN
	END

	--cannot delete the last task in the event
	IF (SELECT COUNT(Task_Id) FROM 
			TASK T LEFT OUTER JOIN
			@z_TASK Z ON T.Task_Id=Z.TaskId
			WHERE T.Event_id=@Event_Id AND Z.TaskId IS NULL)=0
	BEGIN
		SET @Message='Cannot delete the last Workorder in an Event.'
		RETURN
	END
	
	--AL: 29/03/10					
	IF EXISTS(SELECT TT.TaskId
	FROM
			@z_TASK TT INNER JOIN
			TASK T ON TT.TaskId=T.Task_ID LEFT OUTER JOIN
			HEALTH_SAFETY HS ON T.Health_Safety_Id=HS.Health_Safety_Id
	WHERE
			HS.AuditableRecord<>0)
	BEGIN
		SET @Message='Cannot delete auditable OH&S Workorder.'
		RETURN
	END

	
END

SET @Message=''

/*This is for the workorders which are deleted in Event. There can be duplicate
strategy workorders in Event*/

--AL: 09/12/09
DECLARE @MaxPlanningWOtoCreate int
SELECT @MaxPlanningWOtoCreate=ISNULL(Varchar_Value,1) FROM AMT_TYPED_VARIABLE WHERE Value_Name ='MaxPlanningWOtoCreate'


IF ISNULL(@MaxPlanningWOtoCreate,1) = 1
BEGIN
	SELECT @Message=@Message+A.TaskDesc+'
	'
	FROM
	(SELECT T.Task_ID,T.Description AS TaskDesc
	FROM 
	TASK T
		INNER JOIN
	(SELECT Strategy_Proj_Task_Opt_ID FROM @z_TASK 
	GROUP BY Strategy_Proj_Task_Opt_ID HAVING COUNT(TaskId)>1) Z
		ON T.Strategy_Proj_Task_Opt_ID=Z.Strategy_Proj_Task_Opt_ID
		INNER JOIN
	@z_TASK X
		ON T.Task_ID=X.TaskId
	) A
	ORDER BY A.TaskDesc

	IF @Message<>''
	BEGIN
		SET @Message='Deleting workorders will create duplicate strategy backlogs:
	'+@Message
		RETURN
	END

	SELECT @Message=@Message+A.TaskDesc+'
	'
	FROM
	(SELECT DISTINCT T.Task_ID,T.Description AS TaskDesc
	FROM 
	TASK T
		INNER JOIN
	@z_TASK Z
		ON T.Strategy_Proj_Task_Opt_ID=Z.Strategy_Proj_Task_Opt_ID
		AND T.Task_ID<>Z.TaskId
	WHERE T.Task_Status_ID=@TaskStatusOUS OR T.Task_Status_ID=@TaskStatusYTS
	) A
	ORDER BY A.TaskDesc

	IF @Message<>''
	BEGIN
		SET @Message='Deleting Workorders would create duplicate Strategy Backlogs:
	'+@Message
		RETURN
	END
END

--Delete From Deferred Tasks table
IF EXISTS(
SELECT Event_ID FROM 
DEFERRED_TASK DT
	INNER JOIN
@z_TASK T
	ON DT.Task_Id=T.TaskId AND DT.Event_Id=@Event_ID)
BEGIN
	DELETE DT WITH (ROWLOCK, UPDLOCK)
	FROM
	DEFERRED_TASK DT
		INNER JOIN
	@z_TASK T
		ON DT.Task_Id=T.TaskId AND DT.Event_Id=@Event_ID
END


--Check if the tasks shall be relinked
SET @tasksToRelink = ''

SELECT @tasksToRelink = @tasksToRelink + CAST(T.Task_ID AS varchar) + ','
FROM  
@z_TASK Z
	INNER JOIN		
TASK T 
	ON Z.TaskId=T.Task_Id
	LEFT OUTER JOIN
DEFERRED_TASK DT 
	ON T.Event_ID = DT.Event_ID AND T.Task_ID = DT.Task_ID
WHERE
(DT.Deferred_Task_ID IS NULL) AND	
(T.Event_ID =@Event_ID ) AND 
(T.Work_Order_ID IS NOT NULL)

-- Update Tasks table. 
--Set Event_ID=Null if the task is not assigned to any other Event
--Change Task status to Outstanding so it can go to Backlogs list
--Set Primary Cause Flag=0

UPDATE T WITH(ROWLOCK,UPDLOCK)
SET T.Event_ID=NULL, 
/*VV CR8985*/
T.Task_Status_ID=CASE T.Task_Status_ID WHEN @TaskStatusA THEN @TaskStatusA ELSE @TaskStatusOUS END,
T.Primary_Cause=0,
T.Last_Mod_Date=GETDATE()
FROM
TASK T
	INNER JOIN
@z_TASK Z
	ON T.Task_Id=Z.TaskId
WHERE
(T.Event_ID =@Event_ID )		
		
IF @tasksToRelink<>''
BEGIN
	SET @tasksToRelink=LEFT(@tasksToRelink,LEN(@tasksToRelink)-1)
	EXEC TASK_WORK_ORDER_LINK_MULTI_P @TasksID=@tasksToRelink
END


GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[STRATEGY_TASK_ADD_TO_EVENT_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[STRATEGY_TASK_ADD_TO_EVENT_P]
GO


create  Procedure STRATEGY_TASK_ADD_TO_EVENT_P
/******************************************************************************
	File: 
	Name: STRATEGY_TASK_ADD_TO_EVENT_P

	Called By: EQS

	Desc: refer to DESIGN_EQS_3.doc, 1.1.2.2. Strategy Task Wizard Logic (diagramm)
	      	
	******************************************************************
	
	

	Auth: Veronika Vasylyeva
	Date: 4-Nov-2002
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	14 Feb 11	V Vasylyeva	AmtMobile
	09 Dec 09	AL			CR8556: FMG Change - can have multiple strategy tasks at the same time
	13 Oct 09	V Vasylyeva	CR8304: Planning changes
	10 Jun 07	V Vasylyeva	Changes for new planning module
	24 Jan 07	V Vasylyeva	Added performed by date
	15 May 05	V Vasylyeva	Left outer join to next_occ_strategy
	27 Oct 05	V Vasylyeva	Repair code changes: 
					If a proj task opt has 1 job then repair code=proj job. job code
					If a proj task opt has more than 1 job then repair code= default repair code
					Use TASK_GET_DEFAULTS_P instead of STRATEGY_EQS_TASK_DEFAULTS_P
					for the consistensy with strategy_task_creating_maintaining_p
	13 Oct 2005	V Vasylyeva	Cost Bearer
	13 Apr 2004	V Vasylyeva	Removed Task_Planned
	09 Feb 04	V Vasylyeva	New task defaults
					@Parts_Resources_Identified,
					@Labour_Resources_Identified,
					@Location_Identified,
					@Tooling_Resources_Identified
	27 Nov 03	V Vasylyeva	Fixed Bug in Task Insert
	16 Sep 03	H Singh		new field added in update and insert statements - Strategy_Repair_Description
	18-Feb-2003	V Vasylyeva	When a strategy task is created in Backlog
					Repair_Code is Job Code from PROJ_TASK_AMTS_SUM_GROUP_BY_PROJ_TASK_OPT_ID_V
    	19-Nov-2002	V Vasylyeva	Return all backlogs for the selected
					EqpPlan if @Task_ID_Exclude is not null
					Return just selected Strategy task
					if @Task_ID_Exclude is null.
*******************************************************************************/
	/* Param List */


    	@ProjTaskOptId int,-- tblProjTaskOpts.ProjTaskOptId 
    	@AddEventId int=0, -- <=0  the strategy task is to be added to a new event; 
						   -- >0 - the strategy task is to be added to an existing event    
		@Event_ID int =NULL OUTPUT,--event id assigned to a strategy task
    	@Task_ID int =NULL OUTPUT, --task_id assigned to an event which need to be updated
									--with new strategy details
		@EqpPlanID int,
		@UserId int=0,
		@Message varchar(8000) OUTPUT,
		/*AmtMobile*/
		@CopyEWTemplateFiles bit=0 OUTPUT

AS


DECLARE @TaskStatusOUS int
DECLARE @TaskStatusYTS int
DECLARE @TaskStatusIP int

DECLARE @EventStatusYTS int

DECLARE @Event_Status_ID int
DECLARE @Tasks varchar(20)
DECLARE @ProjTaskOptIdOld int
DECLARE @ProjTaskId int
DECLARE @TaskHeader varchar(1000)

SET NOCOUNT ON
--Set values from the system tables
SET @TaskStatusOUS=1
SET @TaskStatusYTS=6
SET @TaskStatusIP=2

SET @EventStatusYTS=1
SET @Message=''

SET XACT_ABORT ON

IF ISNULL(@AddEventId,0)<=0 SET @AddEventId=NULL

--Check if the task for the selected @ProjTaskOptId exists as a part of EQS event
SELECT 
@Task_ID=T.Task_ID,@Event_ID=T.Event_ID, @Event_Status_ID=E.Event_Status_ID,
@ProjTaskOptIdOld=T.Strategy_Proj_Task_Opt_ID, @ProjTaskId=PT.ProjTaskId,
@TaskHeader=TH.Description
FROM
tblProjTasks PT
	INNER JOIN
tblProjTaskOpts PTO
	ON PT.ProjTaskId=PTO.ProjTaskId
	INNER JOIN
TASK T
	ON PTO.ProjTaskOptId=T.Strategy_Proj_Task_Opt_ID
	LEFT JOIN
TASK_HEADER TH
	ON PT.Task_Header_Id=TH.Task_Header_Id
	LEFT OUTER JOIN 
EVENT E
ON T.Event_ID = E.Event_ID
WHERE 
(PTO.ProjTaskOptId=@ProjTaskOptId) AND 
(T.Task_Status_Id IN(@TaskStatusOUS,@TaskStatusYTS,@TaskStatusIP))


--AL: 09/12/09
DECLARE @MaxPlanningWOtoCreate int
SELECT @MaxPlanningWOtoCreate=ISNULL(Varchar_Value,1) FROM AMT_TYPED_VARIABLE WHERE Value_Name ='MaxPlanningWOtoCreate'

IF ISNULL(@MaxPlanningWOtoCreate,1) = 1
BEGIN
	SET @Event_ID=ISNULL(@Event_ID,0)
	SET @Task_ID=ISNULL(@Task_ID,0)
END
ELSE
BEGIN
	SET @Event_ID=0
	SET @Task_ID=0
END


IF @Event_ID>0
--The strategy task with option @ProjTaskOptId was assigned to an event
BEGIN
	IF @AddEventId>0 				
	BEGIN
		-- the task cannot be added to an event, 
		-- it has already been assigned to the other event 
		SET @Event_ID=0
		SET @Task_ID=0
		SET @Message = 'Strategy Task '+@TaskHeader+' has already been assigned to an Event.
 You will need to either Defer or Complete the task in the Event in which it is already assigned.'
		RETURN
	END				
	ELSE
	--the user is adding a strategy task to a new event
	BEGIN
		SET @Task_ID=0
		SET @Message = 'Strategy Task '+@TaskHeader+' already exists in Event.'
		RETURN
	END
END

--Event_ID is null. Check that strategy task was created in Backlog

IF @Task_ID=0
--The strategy task was not created in the Backlog
--Create Task for Event
BEGIN
	
	EXEC TASK_DEFAULT_ADD_GET_P
			@Eqp_Plan_ID =@EqpPlanID,
			@EventId=@AddEventId, 
			@Proj_Task_Opt_Id =@ProjTaskOptId,
			@Std_Job_Id =NULL,
			@PricedJobId =NULL,
			@TaskDefaults =1, 
			@Add =1,
			@UserId =@UserId,
			@TaskId =@Task_ID OUTPUT,
			@CopyEWTemplateFiles=@CopyEWTemplateFiles OUTPUT

			SET @Tasks=CAST(@Task_Id AS varchar)

			
END
ELSE
	-- The strategy task exists in Backlog. 
	-- Update the task with with the selected option details
	-- (VV 12-Jun-2007 changes for new planning) update task with event_id if it is null
	-- to add the task to event
BEGIN

	SET @Tasks=CAST(@Task_Id AS varchar)

	--Update the backlog task
	--with the selected option details
	IF @ProjTaskOptIdOld<>@ProjTaskOptId
	BEGIN
		--This will update the strategy details and link to event
		EXEC TASK_UPDATE_STRAT_DET_P
				@ProjTaskId =@ProjTaskId,
				@ProjTaskOptId =@ProjTaskOptId,
				@EventId=@AddEventId, 
				@TaskID =@Task_ID,
				@EqpPlanID =@EqpPlanID,
				@UserId =@UserId,
				@Message=@Message OUTPUT

			IF ISNULL(@Message,'')<>'' 
			BEGIN
				SET @Task_ID=0
				RETURN
			END
	END
	ELSE IF @AddEventId>0
	--proj task opt did not change. Check if the
	--task need to be added to event
	BEGIN
		EXEC EXPRESS_ADD_BACKLOGS_TO_EVENT_P 
				@Backlogs=@Tasks,
				@Event_ID =@AddEventId,
				@Error_Number=0,
				@Message =@Message OUTPUT

		IF ISNULL(@Message,'')<>'' 
		BEGIN
			SET @Task_ID=0
			RETURN
		END
	END
	
END

/*
--Return data for tasks grid in Event form
IF @AddEventId>0
BEGIN
	EXEC EVENT_TASKS_GET_P @EventId =@AddEventId, @Tasks=@Tasks	
END
ELSE
BEGIN
	EXEC BACKLOGS_SELECTED_GET_P @Backlogs=@Tasks
END
*/





GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[PROJ_TASK_MULTI_UPDATE_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[PROJ_TASK_MULTI_UPDATE_P]
GO


create       PROCEDURE [dbo].[PROJ_TASK_MULTI_UPDATE_P]
/******************************************************************************
	File: 
	Name: PROJ_TASK_MULTI_UPDATE_P

	Called By: Multi-Task Summary Editor

	Desc: Updates data for projected tasks
             

	Auth: Veronika Vasylyeva
	Date: 20-Apr-2005
*******************************************************************************
		Change History
*******************************************************************************
Date:		Author:		Description:
--------	--------	----------------------------------------
07-May-12   SD          E811 - Change Column Headings so that Multi-task editor can show correct grid column headings
03-May-12	SD			E811 - Add Check for planning mode and not unassigned
02-May-12	SD			E811 - Only Set AutocreateExternalWorkorders & AutocreatePlannedEvents in planning mode
02-May-12	SD			E811 - Add fields AutocreateExternalWorkorders & AutocreatePlannedEvents
12-Apr-12   SD		    E781 - Add PEX fields
 7 Oct 10	V Vasylyeva	E316: PartRating
12-Jul-10	V Vasylyeva	CR9019: CBD
11 Jan 10   KN			CR8693: Delete RR Task before updating the TASK.
 8 Dec 09	V Vasylyeva	CR8601: Duration is updated to labour hours
27 Aug 09	KN			Included Std Job/ Component Strucuture
27 May 09	AL			CR8180: Marketing fields: can save 0
15 May 09	V Vasylyeva	CR7824: Always save planning lead time
31 Mar 09	AL			CR7965: added new fields
23 Oct 08	V vasylyeva	pricing date must be less or equal current date
 8 Oct 08	V Vasylyeva CR7410 - duplicate task headers
26 Aug 08	V Vasylyeva	Changed PROJ_TASK_BUSINESS_RULES_F to include external identifier
13 Jun 08	V Vasylyeva	Added StdJobPartsMargin
11 Jun 08	V Vasylyeva	Changed to update to NULL
11 Apr 08	V Vasylyeva	Changed for bulk update and new requirements
21-Jul-07	KN			Fixed - Collation and tempDB Conflicts
27-Jun-07	K Nagarajan	Added InspectionTaskType, InspectionOffset
22 Jan 07	V Vasylyeva	Took out transactions
19 Sep 06	V Vasylyeva	Changes in spec
24 May 06	V Vasylyeva	Took out filtering by equipment type which excluded
				centrelines
24 Feb 06	K Nagarajan	Added Cost Centre
13 Feb 06	K Nagarajan	Fixed update Projected Tasks Amount
13 Feb 06	K Nagarajan	Added Entry Distribution Code Fields to update tblProjTaskAmt table
				Also Fixed the sproc to have "Labour_Hrs_Field" Parameter
20 Dec 05	V Vasylyeva	If @First, @Frequency, @Final,@LaborHours,@Duration,
			        @MiscCost,@PartsCost,@LaborCost=0 - do
				not update these fields
10 Oct 05	S Ivanov	Fixed bug with SchedulingTaskId
23 Sep 05	S Ivanov	Added @SchedulingTaskId
16-Sep-05	V Vasylyeva	Added @PartsCostExpenseID
04-Apr-11   G Wang		Added @AutoGenerateWOS
06-May-11	D Smith		Allow update of the 4 key codes (CC, MC, TT, TC) to zero

*******************************************************************************/

/* Param List */
@taskXML text='',
@UpdateHistory bit=0,
@UpdatePricingDate bit=0,
@Message varchar(8000)='' OUTPUT

AS

DECLARE @hDoc int
DECLARE @CostSourceM int
DECLARE @CostSourceC int
DECLARE @CostSourceS int
DECLARE @LabourTypeF int
DECLARE @LabourTypeS int
DECLARE @TaskModeP int
DECLARE @TaskModeNonP int
DECLARE @DefPlanLeadTime int
DECLARE @ProjTypeBud int
DECLARE @ProjTypeEstCurr int
DECLARE @ProjTypeEstDr int
DECLARE @ProjTypeCurr int
DECLARE @ProjTypeAlt int
DECLARE @PlanStatusUsage int
DECLARE @PlanStatusDate int
DECLARE @SchT_LastPerformedUOM int
DECLARE @SchT_LastScheduledUOM int
DECLARE @SchT_LastPerformedDate int
DECLARE @SchT_LastScheduledDate int
DECLARE @Counter int
DECLARE @MaxMessageLenth int
DECLARE @UpdateTask bit
DECLARE @UpdateOpt bit
DECLARE @UpdateJob bit
DECLARE @ProjTaskUpdate varchar(max)
DECLARE @NoneId int

SET @MaxMessageLenth=8000


SET @SchT_LastPerformedUOM=1
SET @SchT_LastScheduledUOM=2
SET @SchT_LastPerformedDate=3
SET @SchT_LastScheduledDate=4

SET @NoneId=-1

SET @ProjTaskUpdate=''

SET @CostSourceM= 1
SET @CostSourceC=2
SET @CostSourceS = 3
SET @LabourTypeF= 1
SET @LabourTypeS=2
SET @TaskModeP= 1
SET @TaskModeNonP=2

SET @ProjTypeCurr=1
SET @ProjTypeBud=2
SET @ProjTypeAlt=3
SET @ProjTypeEstCurr=6
SET @ProjTypeEstDr=7

SET @DefPlanLeadTime=30

SET @PlanStatusUsage=1
SET @PlanStatusDate=2


CREATE TABLE #z_MTE_TASK(
	MTEId int DEFAULT 1,
	[Component_Code] int,
	[Modifier_Code] int,
	[Task_Type] int,
	[Task_Counter] int,
	[Description] varchar(100) COLLATE DATABASE_DEFAULT,
	[Task_Mode] int,
	[Planning_Lead_Time] int,
	[Operational_Criticality] int,
	[Manufacturer] int,
	[Primary_Part_Number] int,
	[Group_Number] varchar(50) COLLATE DATABASE_DEFAULT,
	[Warranty_Days] float,
	[Warranty_Usage] float,
	[UOM] int,
	[First_Occurrence] float,
	[Frequency] float,
	[Not_After] float,
	[Date_Based] bit,
	[Task_Cost] float,
	[Job_Code] int,
	[Currency] int ,
	[Cost_Source] int,
	[Cost_Bearer] int,
	[Cost_Centre] int,
	[Work_Group] int,
	[Part_Type] int,
	[OH&S] int,
	[Pricing_Date] datetime,
	[Consumable_Qty] float ,
	[Consumable_Top_Up_%] float ,
	[Consumable_Price] float ,
	[Job_Parts_Cost] float ,
	[Job_Labour_Cost] float ,
	[Job_Misc_Cost] float ,
	[Parts_Exp_Element] int,
	[Labour_Exp_Element] int,
	[Misc_Exp_Element] int,
	[Parts_EDC] int,
	[Labour_EDC] int,
	[Misc_EDC] int,
	[Labour_Type] int,
	[Job_Labour_Hours] float ,
	[Labour_Activity] int,
	[Job_Duration] float ,
	--AL: 31/03/09
	PctPurchasePart float ,
	PctPurchaseLabour float ,
	PctPurchaseMisc float ,
	PctPurchaseNewPart float ,
	SalesResponsibility int,
	Performance_Strategy int,
	Component_Structure int,
	Standard_Job int,
	/*VV CR9019*/
	CBDTask bit,
	/*VV E316*/
	PartRating int,
	/*GW*/
	AutoGenerateWOS bit,
	/*E781*/
	DefaultLocationForRebuild int,
	PartClassification int,
	/*E811*/
	AutoCreateExternalWorkorders bit,
	[AutoCreatePlannedEvents/Workorders] bit
	PRIMARY KEY(MTEId)
) 

CREATE TABLE #z_TASK_ID(ProjTaskId int,ProjTaskAmtId int PRIMARY KEY(ProjTaskId,ProjTaskAmtId))

EXEC sp_xml_preparedocument @hDoc OUTPUT, @taskXML 


INSERT INTO #z_MTE_TASK(
[Component_Code],[Modifier_Code],[Task_Type],[Task_Counter],[Description],[Task_Mode],[Planning_Lead_Time],[Operational_Criticality],
[Manufacturer],[Primary_Part_Number],[Group_Number],[Warranty_Days],[Warranty_Usage],[UOM],[First_Occurrence],
[Frequency],[Not_After],[Date_Based],[Task_Cost],[Job_Code],[Currency],[Cost_Source],[Cost_Bearer],[Cost_Centre],
[Work_Group],[Part_Type],[OH&S],[Pricing_Date],[Consumable_Qty] ,[Consumable_Top_Up_%] ,[Consumable_Price] ,[Job_Parts_Cost] ,
[Job_Labour_Cost] ,[Job_Misc_Cost] ,[Parts_Exp_Element],[Labour_Exp_Element],[Misc_Exp_Element],[Parts_EDC],
[Labour_EDC],[Misc_EDC],[Labour_Type],[Job_Labour_Hours] ,[Labour_Activity],[Job_Duration],
--AL: 31/03/09
PctPurchasePart,PctPurchaseLabour,PctPurchaseMisc,PctPurchaseNewPart,SalesResponsibility,
Performance_Strategy,Component_Structure,Standard_Job ,/*VV CR9019*/CBDTask,/*VV E316*/PartRating,/*GW*/AutoGenerateWOS,
/*E781*/DefaultLocationForRebuild, PartClassification,
/*E811*/AutoCreateExternalWorkorders, [AutoCreatePlannedEvents/Workorders])

SELECT
[Component_Code],[Modifier_Code],[Task_Type],[Task_Counter],[Description],[Task_Mode],

CASE [Task_Mode] 
WHEN @TaskModeP THEN ISNULL([Planning_Lead_Time],@DefPlanLeadTime)
WHEN @TaskModeNonP THEN 0 
ELSE [Planning_Lead_Time] END AS [Planning_Lead_Time],

[Operational_Criticality],
[Manufacturer],[Primary_Part_Number],[Group_Number],[Warranty_Days],[Warranty_Usage],[UOM],[First_Occurrence],
[Frequency],[Not_After],[Date_Based],[Task_Cost],[Job_Code],[Currency],[Cost_Source],[Cost_Bearer],[Cost_Centre],
[Work_Group],[Part_Type],[OH&S],[Pricing_Date],[Consumable_Qty] ,[Consumable_Top_Up_%] ,[Consumable_Price] ,[Job_Parts_Cost] ,
[Job_Labour_Cost] ,[Job_Misc_Cost] ,[Parts_Exp_Element],[Labour_Exp_Element],[Misc_Exp_Element],[Parts_EDC],
[Labour_EDC],[Misc_EDC],[Labour_Type],[Job_Labour_Hours] ,[Labour_Activity],[Job_Duration] ,
--AL: 31/03/09
PctPurchasePart,PctPurchaseLabour,PctPurchaseMisc,PctPurchaseNewPart,SalesResponsibility,
Performance_Strategy,Component_Structure,Standard_Job,/*VV CR9019*/CBDTask,/*VV E316*/PartRating,/*GW*/AutoGenerateWOS,
/*E781*/DefaultLocationForRebuild, PartClassification,
/*E811*/AutoCreateExternalWorkorders, [AutoCreatePlannedEvents/Workorders] 

FROM  OPENXML (@hDoc,'/DS_MTE/TBL_VAL',2) WITH #z_MTE_TASK

INSERT INTO #z_TASK_ID(ProjTaskId,ProjTaskAmtId)
SELECT ProjTaskId,ISNULL(ProjTaskAmtId,0) AS ProjTaskAmtId
FROM  OPENXML (@hDoc,'/DS_MTE/TBL_T',2) WITH #z_TASK_ID

EXEC sp_xml_removedocument @hDoc

--drop table z_MTE_TASK,z_TASK_ID
--SELECT * into z_MTE_TASK FROM #z_MTE_TASK
--select * into z_TASK_ID from #z_TASK_ID
--return


SET @UpdateTask=0
SET @UpdateOpt=0
SET @UpdateJob=0

IF EXISTS(SELECT MTEId FROM #z_MTE_TASK WHERE
--[Component_Code] >0 OR [Modifier_Code] IS NOT NULL OR [Task_Type]>0 OR [Task_Counter]IS NOT NULL OR
[Component_Code] IS NOT NULL OR [Modifier_Code] IS NOT NULL OR [Task_Type] IS NOT NULL OR [Task_Counter] IS NOT NULL OR
[Description] IS NOT NULL OR [Task_Mode]>0 OR [Planning_Lead_Time]>=0 OR [Operational_Criticality] IS NOT NULL OR
[Manufacturer]>0 OR [Primary_Part_Number] IS NOT NULL OR [Group_Number] IS NOT NULL OR [Warranty_Days]>=0 OR
[Warranty_Usage]>=0 OR [UOM]>0 OR [Not_After]>=0 OR [Date_Based] IS NOT NULL OR [First_Occurrence]>=0 OR 
[Frequency]>0 
--AL: 31/03/09, 27/05/09
OR PctPurchasePart>=0 OR PctPurchaseLabour>=0 OR PctPurchaseMisc>=0 OR PctPurchaseNewPart>=0 OR SalesResponsibility IS NOT NULL 
OR Performance_Strategy IS NOT NULL 
OR Component_Structure IS NOT NULL 
/*VV CR9019*/ OR CBDTask IS NOT NULL
/*VV E316*/OR PartRating IS NOT NULL
/*GW*/ OR AutoGenerateWOS IS NOT NULL
/*E781*/OR DefaultLocationForRebuild IS NOT NULL OR PartClassification IS NOT NULL
/*E811*/OR AutoCreateExternalWorkorders IS NOT NULL OR [AutoCreatePlannedEvents/Workorders] IS NOT NULL
)
BEGIN
	SET @UpdateTask=1
END

IF EXISTS(SELECT MTEId FROM #z_MTE_TASK WHERE [First_Occurrence]>=0 OR [Frequency]>0)
BEGIN
	SET @UpdateOpt=1
END


IF EXISTS(SELECT MTEId FROM #z_MTE_TASK WHERE
Job_Code IS NOT NULL OR Currency>0 OR Cost_Source>0 OR Cost_Bearer>0 OR Cost_Centre IS NOT NULL OR Work_Group IS NOT NULL OR 
Part_Type IS NOT NULL OR [OH&S] IS NOT NULL OR Pricing_Date IS NOT NULL OR  Consumable_Qty IS NOT NULL OR
[Consumable_Top_Up_%] IS NOT NULL OR Consumable_Price IS NOT NULL OR Job_Parts_Cost IS NOT NULL OR 
Job_Labour_Cost IS NOT NULL OR Job_Misc_Cost IS NOT NULL OR  Parts_Exp_Element IS NOT NULL OR  Labour_Exp_Element IS NOT NULL OR  
Misc_Exp_Element IS NOT NULL OR  Parts_EDC IS NOT NULL OR  Labour_EDC IS NOT NULL OR  Misc_EDC IS NOT NULL OR  
Labour_Type>0 OR  Job_Labour_Hours IS NOT NULL OR  
Labour_Activity IS NOT NULL OR Job_Duration IS NOT NULL OR Standard_Job IS NOT NULL)
BEGIN
	SET @UpdateJob=1
END


IF @UpdateTask=0 AND @UpdateOpt=0 AND @UpdateJob=0
BEGIN
	RETURN
END

CREATE TABLE #z_ProjTaskUpdate(ProjTaskId int ,EqpProjId int,EqpPlanId int,
ComponentCodeId int, ModifierId int,TaskTypeId int,ApplicationCodeId int,Task_Description varchar(100) COLLATE DATABASE_DEFAULT,
Schedule_Type_Id int,InspectionTaskTypeId int,InspectionOffset float,Scheduling_Group_Id int,Scheduling_Group_Counter int,
ExternalIdentifier varchar(50) COLLATE DATABASE_DEFAULT,SchedulingTaskId int,Planning_Task bit,Planning_Lead_Time int,
Operational_Criticality_Id int,ManufacturerId int,Part_Id int,Group_Number varchar(50) COLLATE DATABASE_DEFAULT,
Warranty_Period_Days float,Warranty_Period_Usage float,Last_Change_Usage float,Last_Change_Date datetime,
UsageQUOMId int,[First] float,Frequency float,Final float,Last_Mod_Date datetime,
ComponentCodeIdOld int, ModifierIdOld int,TaskTypeIdOld int,ApplicationCodeIdOld int,Task_Header_Id int,
--AL: 31/03/09
PctPurchasePart float ,PctPurchaseLabour float ,PctPurchaseMisc float ,PctPurchaseNewPart float ,
SalesResponsibilityID int, Maintenance_Strategy_Id int,RCMComponentStructureId int,/*VV CR9019*/CBDTask bit,
/*VV E316*/PartRatingId int,/*GW*/AutoGenerateWOS bit,
/*E781*/DefaultLocationForRebuild int, PartClassification int,
/*E811*/AutoCreateExternalWorkorders bit, [AutoCreatePlannedEvents/Workorders] bit
PRIMARY KEY(ProjTaskId))

CREATE TABLE #z_Message(EqpProjId int,ProjTaskId int,ProjTaskAmtId int default 0, Msg varchar(1000) PRIMARY KEY(ProjTaskId,ProjTaskAmtId))

/*drop table z_MTE_TASK,z_TASK_Id
SELECT * into z_TASK_Id from #z_TASK_Id
SELECT * into z_MTE_TASK from #z_MTE_TASK
return*/

IF @UpdateJob=1 AND EXISTS(SELECT MTEId FROM #z_MTE_TASK WHERE Job_Code IS NOT NULL OR Currency>0)
BEGIN
	DECLARE @CheckCostSource bit
	SELECT @CheckCostSource=CASE WHEN Cost_Source IN(@CostSourceM,@CostSourceC) THEN 0 ELSE 1 END FROM #z_MTE_TASK

	SET @CheckCostSource=ISNULL(@CheckCostSource,0)

--select @CheckCostSource return
	
	INSERT  INTO #z_Message(EqpProjId,ProjTaskId,ProjTaskAmtId)
	SELECT PT.EqpProjId,PT.ProjTaskId,MAX(PTA.ProjTaskAmtId) AS ProjTaskAmtId
	FROM
	tblProjTasks PT
		INNER JOIN
	tblProjTaskOpts PTO
		ON PT.ProjTaskId=PTO.ProjTaskId
		INNER JOIN
	tblProjTaskAmts	PTA
		ON PTO.ProjTaskOptId=PTA.ProjTaskOptId
		LEFT JOIN
	COST_ALLOCATION CA
		ON PTA.ProjTaskAmtId=CA.Proj_Task_Amt_Id
		LEFT JOIN
	SYSTEM_SOURCE SS
		ON CA.System_Source_Id=SS.System_Source_Id
		LEFT JOIN
	( SELECT I.ProjTaskAmtId,MTE.Job_Code,MTE.Currency FROM #z_TASK_Id I CROSS JOIN #z_MTE_TASK MTE) T
		ON PTA.ProjTaskAmtId=T.ProjTaskAmtId
		CROSS JOIN
	COST_ALLOCATION_CONFIGURATION CAC
	WHERE 
	PT.ProjTaskId IN(SELECT ProjTaskId FROM #z_TASK_ID) AND
	(@CheckCostSource=0 OR (PTA.PricedJobId IS NULL AND (CA.Proj_Task_Amt_Id IS NULL OR SS.AmtSystemSource=1 OR (SS.AmtSystemSource=0 AND CAC.JobCode=1))))
	
	GROUP BY PT.EqpProjId,PT.ProjTaskId,
	NULLIF(ISNULL(T.Job_Code,PTA.JobCodeId),@NoneId),ISNULL(T.Currency,PTA.CurrencyId)
	HAVING COUNT(PTA.ProjTaskAmtId)>1

	

	IF EXISTS(SELECT EqpProjId FROM #z_Message)
	BEGIN
		SET @Message=''

		SELECT @Message=@Message+CASE WHEN LEN(@Message)<@MaxMessageLenth THEN EP.EqpPlan+': '+EPR.EqpProjName+': '+TH.Description+
': There is duplicate selection of Currency and Job Code		
' ELSE '' END
		FROM 
		tblEqpPlans EP
			INNER JOIN
		tblEqpProjs EPR
			ON EP.EqpPlanId=EPR.EqpPlanId
			INNER JOIN
		#z_Message M
			ON EPR.EqpProjId=M.EqpProjId
			INNER JOIN
		tblProjTasks PT
			ON M.ProjTaskId=PT.ProjTaskId
			INNER JOIN
		TASK_HEADER TH
			ON PT.Task_Header_Id=TH.Task_Header_Id
		ORDER BY EP.EqpPlan,EPR.EqpProjName,TH.Description
		RETURN
	END

END
 
IF @UpdateJob=1 AND EXISTS(SELECT MTEId FROM #z_MTE_TASK WHERE (Standard_Job IS NOT NULL AND ISNULL(Cost_Source,0) <> @CostSourceS) OR ( ISNULL(Cost_Source,0) =  @CostSourceS AND ISNULL(Standard_Job,0) = 0) )
BEGIN
	 SET @Message='In order to update Standard Job, the Cost Source should be set to ''Standard Job'' and a Standard job should be selected.'
	 RETURN
END
 
IF @UpdateTask=1 AND EXISTS(SELECT MTEId FROM #z_MTE_TASK WHERE (Component_Structure IS NOT NULL AND ISNULL(Performance_Strategy,0) <> 1))
BEGIN
	 SET @Message='In order to update Component Structure, the Performance Strategy should be set to ''On Condition'' and a Component Structure should be selected.'
	 RETURN
END
-- Task with Multiple jobs 
IF @UpdateJob=1 AND EXISTS(SELECT MTEId FROM #z_MTE_TASK WHERE Standard_Job IS NOT NULL)
BEGIN
 
	
	INSERT  INTO #z_Message(EqpProjId,ProjTaskId,ProjTaskAmtId)
	SELECT PT.EqpProjId,PT.ProjTaskId,MAX(PTA.ProjTaskAmtId) AS ProjTaskAmtId
	FROM
	tblProjTasks PT
		INNER JOIN
	tblProjTaskOpts PTO
		ON PT.ProjTaskId=PTO.ProjTaskId
		INNER JOIN
	tblProjTaskAmts	PTA
		ON PTO.ProjTaskOptId=PTA.ProjTaskOptId
	 
	WHERE 
	PT.ProjTaskId IN(SELECT ProjTaskId FROM #z_TASK_ID)	
	GROUP BY PT.EqpProjId,PT.ProjTaskId 
 	HAVING COUNT(PTA.ProjTaskAmtId)>1

	

	IF EXISTS(SELECT EqpProjId FROM #z_Message)
	BEGIN
		SET @Message=''

		SELECT @Message=@Message+CASE WHEN LEN(@Message)<@MaxMessageLenth THEN EP.EqpPlan+': '+EPR.EqpProjName+': '+TH.Description+
': Cannot link same standard job to all the jobs in a Task.		
' ELSE '' END
		FROM 
		tblEqpPlans EP
			INNER JOIN
		tblEqpProjs EPR
			ON EP.EqpPlanId=EPR.EqpPlanId
			INNER JOIN
		#z_Message M
			ON EPR.EqpProjId=M.EqpProjId
			INNER JOIN
		tblProjTasks PT
			ON M.ProjTaskId=PT.ProjTaskId
			INNER JOIN
		TASK_HEADER TH
			ON PT.Task_Header_Id=TH.Task_Header_Id
		ORDER BY EP.EqpPlan,EPR.EqpProjName,TH.Description
		RETURN
	END

END

-- Unassigned Task
IF @UpdateJob=1 AND EXISTS(SELECT MTEId FROM #z_MTE_TASK WHERE Standard_Job IS NOT NULL)
BEGIN
 
	
	INSERT  INTO #z_Message(EqpProjId,ProjTaskId)
	SELECT DISTINCT PT.EqpProjId,PT.ProjTaskId AS ProjTaskAmtId
	FROM
	tblProjTasks PT
		 
	WHERE 
	PT.ProjTaskId IN(SELECT ProjTaskId FROM #z_TASK_ID)	
	AND PT.Unscheduled <> 0
	 
	

	IF EXISTS(SELECT EqpProjId FROM #z_Message)
	BEGIN
		SET @Message=''

		SELECT @Message=@Message+CASE WHEN LEN(@Message)<@MaxMessageLenth THEN EP.EqpPlan+': '+EPR.EqpProjName+': '+TH.Description+
': Cannot link a standard job to unassigned Task.		
' ELSE '' END
		FROM 
		tblEqpPlans EP
			INNER JOIN
		tblEqpProjs EPR
			ON EP.EqpPlanId=EPR.EqpPlanId
			INNER JOIN
		#z_Message M
			ON EPR.EqpProjId=M.EqpProjId
			INNER JOIN
		tblProjTasks PT
			ON M.ProjTaskId=PT.ProjTaskId
			INNER JOIN
		TASK_HEADER TH
			ON PT.Task_Header_Id=TH.Task_Header_Id
		ORDER BY EP.EqpPlan,EPR.EqpProjName,TH.Description
		RETURN
	END

END

IF @UpdateJob=1 AND EXISTS(SELECT MTEId FROM #z_MTE_TASK WHERE Pricing_Date>GETDATE())
BEGIN
	DECLARE @CostSource int
	
	SELECT @CostSource=Cost_Source FROM #z_MTE_TASK

	INSERT  INTO #z_Message(EqpProjId,ProjTaskId)
	SELECT DISTINCT PT.EqpProjId,PT.ProjTaskId
	FROM
	tblProjTasks PT
		INNER JOIN
	tblEqpProjs EPR
		ON PT.EqpProjId=EPR.EqpProjId
		INNER JOIN
	tblProjTaskOpts PTO
		ON PT.ProjTaskId=PTO.ProjTaskId
		INNER JOIN
	tblProjTaskAmts	PTA
		ON PTO.ProjTaskOptId=PTA.ProjTaskOptId
	WHERE 
	PT.ProjTaskId IN(SELECT ProjTaskId FROM #z_TASK_ID) AND
	(EPR.Projection_Type_Id NOT IN(@ProjTypeBud,@ProjTypeEstCurr,@ProjTypeEstDr)) AND
	(@CostSource IN(@CostSourceM,@CostSourceC) OR PTA.PricedJobId IS NULL) AND
	(@UpdatePricingDate=0) AND (PT.AutomaticUpdate=0)

	IF EXISTS(SELECT EqpProjId FROM #z_Message)
	BEGIN
		SET @Message=''

		SELECT @Message=@Message+CASE WHEN LEN(@Message)<@MaxMessageLenth THEN EP.EqpPlan+': '+EPR.EqpProjName+': '+TH.Description+
': Pricing date must be less or equal current date.		
' ELSE '' END
		FROM 
		tblEqpPlans EP
			INNER JOIN
		tblEqpProjs EPR
			ON EP.EqpPlanId=EPR.EqpPlanId
			INNER JOIN
		#z_Message M
			ON EPR.EqpProjId=M.EqpProjId
			INNER JOIN
		tblProjTasks PT
			ON M.ProjTaskId=PT.ProjTaskId
			INNER JOIN
		TASK_HEADER TH
			ON PT.Task_Header_Id=TH.Task_Header_Id
		ORDER BY EP.EqpPlan,EPR.EqpProjName,TH.Description
		RETURN
	END

END


IF @UpdateTask=1
BEGIN

	INSERT INTO #z_ProjTaskUpdate(ProjTaskId,EqpProjId,EqpPlanId,ComponentCodeId, ModifierId,TaskTypeId,ApplicationCodeId,
	Task_Description,Schedule_Type_Id,InspectionTaskTypeId,InspectionOffset ,Scheduling_Group_Id,Scheduling_Group_Counter,ExternalIdentifier,SchedulingTaskId,
	Planning_Task ,Planning_Lead_Time,Operational_Criticality_Id,ManufacturerId,Part_Id,Group_Number,Warranty_Period_Days,
	Warranty_Period_Usage ,Last_Change_Usage ,Last_Change_Date,UsageQUOMId,[First],Frequency ,Final,Last_Mod_Date,
	ComponentCodeIdOld, ModifierIdOld,TaskTypeIdOld,ApplicationCodeIdOld,Task_Header_Id,
	--AL: 31/03/09
	PctPurchasePart,PctPurchaseLabour,PctPurchaseMisc,PctPurchaseNewPart,SalesResponsibilityID,
	Maintenance_Strategy_Id,RCMComponentStructureId ,/*VV CR9019*/CBDTask,/*VV E316*/PartRatingId,/*GW*/AutoGenerateWOS,
	/*E781*/DefaultLocationForRebuild, PartClassification,
	/*E811*/AutocreateExternalWorkorders, [AutoCreatePlannedEvents/Workorders])

	SELECT 
	PT.ProjTaskId,PT.EqpProjId,PT.EqpPlanId,
	ISNULL(MTE.Component_Code,PT.ComponentCodeId) AS ComponentCodeId,
	ISNULL(NULLIF(ISNULL(MTE.Modifier_Code, PT.ModifierId),@NoneId),0) AS ModifierId,
	ISNULL(MTE.Task_Type,PT.TaskTypeId) AS TaskTypeId, 
	ISNULL(NULLIF(ISNULL(MTE.Task_Counter,PT.ApplicationCodeId),@NoneId),0) AS ApplicationCodeId, 
	ISNULL(MTE.Description,PT.Task_Description) AS Task_Description,
	
	--If usage method or planning changes set scheduling type(date_based 1 or null)
	CASE /*1*/WHEN MTE.Task_Mode=@TaskModeNonP THEN/*For non-planning tasks always last performed*/
								CASE WHEN MTE.Date_Based=1 THEN @SchT_LastPerformedDate
								     WHEN ISNULL(MTE.UOM,PT.UsageQUOMId)>0 THEN @SchT_LastPerformedUOM
								     ELSE @SchT_LastPerformedDate END
							
		/*2*/ELSE
			CASE /*2.1*/WHEN MTE.Date_Based=1 AND PT.UsageQUOMId>0 THEN
							CASE PT.Schedule_Type_Id 
							WHEN @SchT_LastPerformedUOM THEN @SchT_LastPerformedDate
						    WHEN @SchT_LastScheduledUOM THEN @SchT_LastScheduledDate
							ELSE PT.Schedule_Type_Id END
				/*2.2*/WHEN PT.UsageQUOMId IS NULL AND MTE.UOM>0 THEN 
							CASE PT.Schedule_Type_Id 
							WHEN @SchT_LastPerformedDate THEN @SchT_LastPerformedUOM
						    WHEN @SchT_LastScheduledDate THEN @SchT_LastScheduledUOM
							ELSE PT.Schedule_Type_Id END
					   ELSE PT.Schedule_Type_Id
			END
		END AS Schedule_Type_Id,
	
	CASE MTE.Task_Mode WHEN @TaskModeNonP THEN NULL ELSE PT.InspectionTaskTypeId END AS InspectionTaskTypeId,
	CASE MTE.Task_Mode WHEN @TaskModeNonP THEN 0 ELSE PT.InspectionOffset END AS InspectionOffset,
	CASE MTE.Task_Mode WHEN @TaskModeNonP THEN NULL ELSE PT.Scheduling_Group_Id END AS Scheduling_Group_Id,
	CASE MTE.Task_Mode WHEN @TaskModeNonP THEN NULL ELSE PT.Scheduling_Group_Counter END AS Scheduling_Group_Counter,
	CASE WHEN MTE.Task_Mode = @TaskModeNonP AND PT.SchedulingTaskId>0 THEN NULL /*The scheduling task will be unlinked*/
							    WHEN ((PT.UsageQUOMId>0 AND MTE.Date_Based=1) OR ISNULL(PT.UsageQUOMId,0)<>ISNULL(ISNULL(MTE.UOM,PT.UsageQUOMId),0)) AND
								PT.SchedulingTaskId>0 THEN NULL/*The scheduling task will be unlinked*/
							    ELSE PT.ExternalIdentifier END AS ExternalIdentifier,
	CASE WHEN MTE.Task_Mode= @TaskModeNonP THEN NULL
							 WHEN ((PT.UsageQUOMId>0 AND MTE.Date_Based=1) OR ISNULL(PT.UsageQUOMId,0)<>ISNULL(ISNULL(MTE.UOM,PT.UsageQUOMId),0)) THEN NULL
							 ELSE PT.SchedulingTaskId END AS SchedulingTaskId,

	CASE WHEN PT.Unscheduled<>0 THEN PT.Planning_Task
						  WHEN PT.ParentTaskId>0 THEN PT.Planning_Task
					      WHEN MTE.Task_Mode=@TaskModeP THEN 1 
						  WHEN MTE.Task_Mode=@TaskModeNonP THEN 0 
						  ELSE PT.Planning_Task END AS Planning_Task,
	CASE WHEN PT.Unscheduled<>0 THEN PT.Planning_Lead_Time
						  WHEN PT.ParentTaskId>0 THEN PT.Planning_Lead_Time
						/*VV CR7824 
						  WHEN MTE.Task_Mode IN(@TaskModeP,@TaskModeNonP) THEN MTE.Planning_Lead_Time 
						  ELSE PT.Planning_Lead_Time END */
						  ELSE ISNULL(MTE.Planning_Lead_Time,PT.Planning_Lead_Time) END AS Planning_Lead_Time,
	NULLIF(ISNULL(MTE.Operational_Criticality,PT.Operational_Criticality_Id),@NoneId) AS Operational_Criticality_Id, 
	ISNULL(MTE.Manufacturer,PT.ManufacturerId) AS ManufacturerId, 
	CASE WHEN PT.Rotable_Part_Id>0 THEN PT.Part_Id
					WHEN PT.Unscheduled<>0 THEN PT.Part_Id
					ELSE NULLIF(ISNULL(MTE.Primary_Part_Number,PT.Part_Id),@NoneId) END  AS Part_Id,
	CASE WHEN PT.Rotable_Part_Id>0 THEN PT.Group_Number
					WHEN PT.Unscheduled<>0 THEN PT.Group_Number
					ELSE ISNULL(MTE.Group_Number,PT.Group_Number) END AS Group_Number,
	ISNULL(MTE.Warranty_Days,PT.Warranty_Period_Days) AS Warranty_Period_Days, 
	ISNULL(MTE.Warranty_Usage,PT.Warranty_Period_Usage) AS Warranty_Period_Usage, 

	CASE WHEN MTE.Date_Based=1 AND PT.UsageQUOMId>0 THEN 0
							  WHEN ISNULL(PT.UsageQUOMId,0)<>ISNULL(ISNULL(MTE.UOM,PT.UsageQUOMId),0) THEN 0
							  ELSE PT.Last_Change_Usage END AS Last_Change_Usage,

	CASE WHEN MTE.Date_Based=1 AND PT.UsageQUOMId>0 THEN EP.StartDate
							  WHEN ISNULL(PT.UsageQUOMId,0)<>ISNULL(ISNULL(MTE.UOM,PT.UsageQUOMId),0) THEN EP.StartDate
							  ELSE PT.Last_Change_Date END AS Last_Change_Date,

	CASE WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1 THEN PT.UsageQUOMId
						WHEN MTE.Date_Based=1 THEN NULL 
						ELSE ISNULL(MTE.UOM,PT.UsageQUOMId) END AS UsageQUOMId, 
	CASE WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1 THEN PT.[First]
		 WHEN PT.Unscheduled<>0 THEN PT.[First]
					ELSE ISNULL(MTE.First_Occurrence,PT.[First]) END AS [First], 
	CASE WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1 THEN PT.Frequency
					  ELSE ISNULL(MTE.Frequency,PT.Frequency) END AS Frequency,
	CASE WHEN PT.Unscheduled<>0 THEN PT.Final ELSE ISNULL(MTE.Not_After,PT.Final) END AS Final,
	PT.Last_Mod_Date,
	PT.ComponentCodeId AS ComponentCodeIdOld, PT.ModifierId AS ModifierIdOld,PT.TaskTypeId AS TaskTypeIdOld,
	PT.ApplicationCodeId AS ApplicationCodeIdOld,
	CASE WHEN ISNULL(MTE.Component_Code,PT.ComponentCodeId) <>PT.ComponentCodeId OR
			ISNULL(NULLIF(ISNULL(MTE.Modifier_Code, PT.ModifierId),@NoneId),0) <>PT.ModifierId OR
			ISNULL(MTE.Task_Type,PT.TaskTypeId) <>PT.TaskTypeId OR
			ISNULL(NULLIF(ISNULL(MTE.Task_Counter,PT.ApplicationCodeId),@NoneId),0)<>PT.ApplicationCodeId THEN NULL
		ELSE PT.Task_Header_Id END AS Task_Header_Id,

	--AL: 31/03/09, 27/05/09
	ISNULL(MTE.PctPurchasePart, PT.PctPurchasePart),
	ISNULL(MTE.PctPurchaseLabour, PT.PctPurchaseLabour),
	ISNULL(MTE.PctPurchaseMisc, PT.PctPurchaseMisc),
	ISNULL(MTE.PctPurchaseNewPart, PT.PctPurchaseNewPart),
	NULLIF(ISNULL(MTE.SalesResponsibility,PT.SalesResponsibilityID),@NoneId),
	ISNULL(MTE.Performance_Strategy, PT.Maintenance_Strategy_Id),
	CASE WHEN ISNULL(ISNULL(MTE.Performance_Strategy, PT.Maintenance_Strategy_Id),0) <> 1 THEN NULL ELSE 
		ISNULL(MTE.Component_Structure, PT.RCMComponentStructureId)
	END,
	/*VV CR9019*/
	ISNULL(MTE.CBDTask,PT.CBDTask) AS CBDTask,
	/*VV E316*/ISNULL(MTE.PartRating,PT.PartRatingId) AS PartRatingId,
	/*GW*/ISNULL(MTE.AutoGenerateWOS,PT.AutoGenerateWOS) AS AutoGenerateWOS,
	/*E781*/
	ISNULL(MTE.DefaultLocationForRebuild, PT.DefaultLocationForRebuild) AS DefaultLocationForRebuild, 
	ISNULL(MTE.PartClassification, PT.PartClassificationId) AS PartClassification,
	/*E811*/
	CASE
		WHEN (PT.Unscheduled<>0) THEN 0 /* Case for Unassigned Tasks */
		WHEN MTE.Task_Mode=@TaskModeP THEN  ISNULL(MTE.AutocreateExternalWorkorders, PT.AutocreateExternalWorkorders)
		WHEN MTE.Task_Mode=@TaskModeNonP THEN 0 
		WHEN PT.Planning_Task=1 THEN  ISNULL(MTE.AutocreateExternalWorkorders, PT.AutocreateExternalWorkorders)
		ELSE 0 
	END AS AutoCreateExternalWorkorders,
	CASE
		WHEN (PT.Unscheduled<>0) THEN 0 /* Case for Unassigned Tasks */
		WHEN MTE.Task_Mode=@TaskModeP THEN  ISNULL(MTE.[AutoCreatePlannedEvents/Workorders], PT.AutocreatePlannedEvents)
		WHEN MTE.Task_Mode=@TaskModeNonP THEN 0 
		WHEN PT.Planning_Task=1 THEN  ISNULL(MTE.[AutoCreatePlannedEvents/Workorders], PT.AutocreatePlannedEvents)
		ELSE 0 
	END AS [AutoCreatePlannedEvents/Workorders]	
	FROM
	tblEqpPlans EP
		INNER JOIN
	tblProjTasks PT
		ON EP.EqpPlanId=PT.EqpPlanId
		CROSS JOIN
	#z_MTE_TASK MTE
	WHERE PT.ProjTaskId IN (SELECT ProjTaskId FROM #z_TASK_ID)

 
--drop table z_ProjTaskUpdate
--SELECT * INTO z_ProjTaskUpdate FROM #z_ProjTaskUpdate
--
--select * from z_ProjTaskUpdate
--RETURN

	--Check business rules for duplicate component codes for the tasks which 
	-- component codes changed and update task headers
	
	IF EXISTS(SELECT ProjTaskId FROM #z_ProjTaskUpdate WHERE Task_Header_Id IS NULL)
	BEGIN
		--Check the data in the update table for the duplicate combination of codes. It could happen
		--if there are tasks for the same projection in the user selection list

		INSERT INTO #z_Message(EqpProjId,ProjTaskId,Msg)
		SELECT EqpProjId,MAX(ProjTaskId) AS ProjTaskId,CAST(COUNT(ProjTaskId) AS varchar) AS Msg
		FROM #z_ProjTaskUpdate
		GROUP BY EqpProjId,ComponentCodeId,ModifierId,TaskTypeId,ApplicationCodeId
		HAVING COUNT(ProjTaskId)>1

		--drop table z_Message
		--select * into z_Message from #z_Message return

		SET @Counter=@@ROWCOUNT
		
		IF @Counter>0
		BEGIN
			SET @Message=''

			SELECT @Message=@Message+CASE WHEN LEN(@Message)<@MaxMessageLenth THEN EP.EqpPlan+' : '+EPR.EqpProjName+': Duplicate tasks '+
			CC.Code + '.' + MC.Code + '.' + TT.Code + '.' + AC.Code + ' ' + CC.Description +'
' ELSE '' END
			FROM 
			tblEqpPlans EP
				INNER JOIN
			tblEqpProjs EPR
				ON EP.EqpPlanId=EPR.EqpPlanId
				INNER JOIN
			#z_Message M
				ON M.EqpProjId=EPR.EqpProjId
				INNER JOIN
			#z_ProjTaskUpdate U
				ON M.ProjTaskId=U.ProjTaskId
				INNER JOIN
			tblComponentCodes CC
				ON U.ComponentCodeId=CC.ComponentCodeId
				INNER JOIN
			tblModifierCodes MC
				ON U.ModifierId=MC.ModifierId
				INNER JOIN
			tblTaskTypes TT
				ON U.TaskTypeId=TT.TaskTypeId
				INNER JOIN
			tblApplicationCodes AC
				ON U.ApplicationCodeId=AC.ApplicationCodeId
			ORDER BY EP.EqpPlan,EPR.EqpProjName,CC.Code + '.' + MC.Code + '.' + TT.Code + '.' + AC.Code + ' ' + CC.Description
			RETURN
			
		END
		
		--Check duplicate codes in projection
		INSERT INTO #z_Message(EqpProjId,ProjTaskId)
		SELECT U.EqpProjId,U.ProjTaskId
		FROM
		tblProjTasks PT
			INNER JOIN
		#z_ProjTaskUpdate U
			ON PT.EqpProjId=U.EqpProjId AND
			   PT.ComponentCodeId=U.ComponentCodeId AND
			   PT.ModifierId=U.ModifierId AND
			   PT.TaskTypeId=U.TaskTypeId AND
			   PT.ApplicationCodeId=U.ApplicationCodeId 
		WHERE PT.ProjTaskId<>U.ProjTaskId

		SET @Counter=@@ROWCOUNT
		
		IF @Counter>0
		BEGIN
			SET @Message=''

			SELECT @Message=@Message+CASE WHEN LEN(@Message)<@MaxMessageLenth THEN EP.EqpPlan+' : '+EPR.EqpProjName+': Duplicate tasks '+
			CC.Code + '.' + MC.Code + '.' + TT.Code + '.' + AC.Code + ' ' + CC.Description +'
	' ELSE '' END
			FROM 
			tblEqpPlans EP
				INNER JOIN
			tblEqpProjs EPR
				ON EP.EqpPlanId=EPR.EqpPlanId
				INNER JOIN
			#z_Message M
				ON M.EqpProjId=EPR.EqpProjId
				INNER JOIN
			#z_ProjTaskUpdate U
				ON M.ProjTaskId=U.ProjTaskId
				INNER JOIN
			tblComponentCodes CC
				ON U.ComponentCodeId=CC.ComponentCodeId
				INNER JOIN
			tblModifierCodes MC
				ON U.ModifierId=MC.ModifierId
				INNER JOIN
			tblTaskTypes TT
				ON U.TaskTypeId=TT.TaskTypeId
				INNER JOIN
			tblApplicationCodes AC
				ON U.ApplicationCodeId=AC.ApplicationCodeId
			ORDER BY EP.EqpPlan,EPR.EqpProjName,CC.Code + '.' + MC.Code + '.' + TT.Code + '.' + AC.Code + ' ' + CC.Description
			RETURN
			
		END

			SET @ProjTaskUpdate=''

			SELECT @ProjTaskUpdate=@ProjTaskUpdate+CAST(ProjTaskId AS varchar)+','
			FROM (SELECT DISTINCT PT.ProjTaskId FROM 
					#z_ProjTaskUpdate PT
						INNER JOIN
					tblEqpProjs EPR
						ON PT.EqpProjId=EPR.EqpProjId
				WHERE EPR.Projection_Type_Id=@ProjTypeCurr AND Task_Header_Id IS NULL) A

			IF @ProjTaskUpdate<>'' SET @ProjTaskUpdate=LEFT(@ProjTaskUpdate,LEN(@ProjTaskUpdate)-1)
		--Task Headers

		INSERT INTO TASK_HEADER(Component_Code, Modifier_Code, Task_Type, Application_Code,Description)
		/*8 Oct 08	V Vasylyeva CR7410 - duplicate task headers*/
		SELECT DISTINCT A.Component_Code, A.Modifier_Code, A.Task_Type, A.Application_Code,
		A.Component_Code + '.' + A.Modifier_Code + '.' + A.Task_Type + '.' + A.Application_Code + ' ' + A.Description AS Description
		FROM
		(SELECT CC.Code AS Component_Code,MC.Code AS Modifier_Code,TT.Code AS Task_Type,AC.Code AS Application_Code,
		CC.Description
		FROM
		#z_ProjTaskUpdate U
			INNER JOIN
		tblComponentCodes CC
			ON U.ComponentCodeId=CC.ComponentCodeId
			INNER JOIN
		tblModifierCodes MC
			ON U.ModifierId=MC.ModifierId
			INNER JOIN
		tblTaskTypes TT
			ON U.TaskTypeId=TT.TaskTypeId
			INNER JOIN
		tblApplicationCodes AC
					ON U.ApplicationCodeId=AC.ApplicationCodeId
		WHERE U.Task_Header_Id IS NULL) A
			LEFT JOIN
		TASK_HEADER TH
			ON A.Component_Code=TH.Component_Code AND
			   A.Modifier_Code=TH.Modifier_Code AND
			   A.Task_Type=TH.Task_Type AND
			   A.Application_Code=TH.Application_Code
		WHERE TH.Task_Header_Id IS NULL

		UPDATE PT SET PT.Task_Header_Id=TH.Task_Header_Id
		FROM         
			#z_ProjTaskUpdate PT INNER JOIN
			tblComponentCodes CC ON PT.ComponentCodeId = CC.ComponentCodeID INNER JOIN
			tblApplicationCodes AC ON PT.ApplicationCodeId = AC.ApplicationCodeID INNER JOIN
			tblModifierCodes MC ON PT.ModifierId = MC.ModifierID INNER JOIN
			tblTaskTypes TT ON PT.TaskTypeId = TT.TaskTypeID INNER JOIN
			TASK_HEADER TH ON CC.Code = TH.Component_Code AND MC.Code = TH.Modifier_Code AND TT.Code = TH.Task_Type AND 
			AC.Code = TH.Application_Code
		WHERE PT.Task_Header_Id IS NULL

	END /*IF EXISTS(SELECT ProjTaskId FROM #z_ProjTaskUpdate WHERE Task_Header_Id IS NULL)*/
	
--drop table z_ProjTaskUpdate
--SELECT * INTO z_ProjTaskUpdate FROM #z_ProjTaskUpdate
--RETURN
	
	--The other business rules
	INSERT INTO #z_Message(EqpProjId,ProjTaskId,Msg)
	SELECT U.EqpProjId,U.ProjTaskId,
	dbo.PROJ_TASK_BUSINESS_RULES_F
		(U.EqpProjId,
		NULL/*ComponentCodeId*/,
		U.ModifierId,
		U.TaskTypeId,
		U.ApplicationCodeId,	
		U.Schedule_Type_Id, 
		U.Scheduling_Group_Id, 
		U.Scheduling_Group_Counter, 
		U.usageQUOMId,
		U.ProjTaskId,
		U.Last_Change_Date,
		U.Last_Change_Usage,
		U.InspectionTaskTypeId,
		U.InspectionOffset,
		U.Planning_Task,
		NULL /*ParentTaskId*/,
		U.Frequency,
		EP.StartDate,
		CASE WHEN ISNULL(A.TaskNum,0)=ISNULL(B.TaskNum,0) THEN 0 ELSE 1 END/*@CheckGroup*/,
		''/*@ExternalIdentifier do not check because it will be deleted or not updated*/)
	FROM
	tblEqpPlans EP
		INNER JOIN
	#z_ProjTaskUpdate U
		ON EP.EqpPlanId=U.EqpPlanId
		LEFT JOIN
	(SELECT 
	EqpProjId,Scheduling_Group_Id,COUNT(ProjTaskId) AS TaskNum
	FROM #z_ProjTaskUpdate
	WHERE Scheduling_Group_Id>0
	GROUP BY EqpProjId,Scheduling_Group_Id)A
		ON U.EqpProjId=A.EqpProjId AND U.Scheduling_Group_Id=A.Scheduling_Group_Id
		LEFT JOIN
	(SELECT 
	EqpProjId,Scheduling_Group_Id,COUNT(ProjTaskId) AS TaskNum
	FROM tblProjTasks
	WHERE Scheduling_Group_Id>0 AND EqpProjId IN(SELECT EqpProjId FROM #z_ProjTaskUpdate)
	
	GROUP BY EqpProjId,Scheduling_Group_Id) B
	ON U.EqpProjId=B.EqpProjId AND U.Scheduling_Group_Id=B.Scheduling_Group_Id

	IF EXISTS(SELECT * FROM #z_Message WHERE ISNULL(Msg,'')<>'')
	BEGIN
		SET @Message=''

		SELECT @Message=@Message+CASE WHEN LEN(@Message)<@MaxMessageLenth THEN EP.EqpPlan+': '+EPR.EqpProjName+': '+
		TH.Description+': '+M.Msg+'
' ELSE '' END
		FROM 
		tblEqpPlans EP
			INNER JOIN
		tblEqpProjs EPR
			ON EP.EqpPlanId=EPR.EqpPlanId
			INNER JOIN
		#z_Message M
			ON EPR.EqpProjId=M.EqpProjId
			INNER JOIN
		#z_ProjTaskUpdate PT
			ON M.ProjTaskId=PT.ProjTaskId
			INNER JOIN
		TASK_HEADER TH
			ON PT.Task_Header_Id=TH.Task_Header_Id
		WHERE ISNULL(Msg,'')<>''
		ORDER BY EP.EqpPlan,EPR.EqpProjName,TH.Description

		RETURN
	END	

END

 
 
DROP TABLE #z_Message
 
--drop table z_ProjTaskUpdate
--select * into z_ProjTaskUpdate from #z_ProjTaskUpdate
--return


IF EXISTS(SELECT ProjTaskId FROM #z_ProjTaskUpdate)
BEGIN
 
		--Delete RR tasks if Component Structure is unlinked from the parent task // KN 11-Jan 10 Delete before saving Task.
		IF EXISTS(SELECT RR.ParentTaskId FROM
					tblProjTasks RR
						INNER JOIN
					#z_ProjTaskUpdate IPT
						ON RR.ParentTaskId=IPT.ProjTaskId
						INNER JOIN
					tblProjTasks PT
						ON IPT.ProjTaskId=PT.ProjTaskId
					WHERE /*12-Jan-2009 VV*/ ISNULL(PT.Maintenance_Strategy_Id,0)<>ISNULL(IPT.Maintenance_Strategy_Id,0))
		BEGIN
			DECLARE @ProjTaskId VARCHAR(MAX)
			SET @ProjTaskId=''

			SELECT @ProjTaskId = (select CAST(RR.ParentTaskId AS varchar)+',' FROM
				tblProjTasks RR
					INNER JOIN
				#z_ProjTaskUpdate IPT
					ON RR.ParentTaskId=IPT.ProjTaskId
					INNER JOIN
				tblProjTasks PT
					ON IPT.ProjTaskId=PT.ProjTaskId
				WHERE /*12-Jan-2009 VV*/ ISNULL(PT.Maintenance_Strategy_Id,0)<>ISNULL(IPT.Maintenance_Strategy_Id,0) 
				GROUP BY RR.ParentTaskId
			 FOR XML PATH('') )

			SET @ProjTaskId=ISNULL(@ProjTaskId,'')

			EXEC TASK_DELETE_MULTI_EQP @eqpPlanID='',@EqpProjHeaderId =NULL,@ProjTaskHeaderId =NULL,@forceDelete=1,@DeleteRRTasksOnly=1,@ProjTaskId=@ProjTaskId,@CheckRules=1
		 
		END

	--Update tasks
	UPDATE PT SET
	PT.ComponentCodeId =U.ComponentCodeId,
	PT.ModifierId=U.ModifierId,
	PT.TaskTypeId=U.TaskTypeId, 
	PT.ApplicationCodeId=U.ApplicationCodeId, 
	PT.Task_Description=U.Task_Description,		
	PT.Schedule_Type_Id=U.Schedule_Type_Id,
	PT.Task_Header_Id=U.Task_Header_Id,

	--Depend on planning flag
	PT.PlanTaskOptId =CASE U.Planning_Task WHEN 0 THEN NULL ELSE PT.PlanTaskOptId END,
	PT.PlanStatus = CASE U.Planning_Task WHEN 0 THEN 0 ELSE PT.PlanStatus END, 
	PT.PlanUseCalc=CASE U.Planning_Task WHEN 0 THEN 1 ELSE PT.PlanUseCalc END,
	PT.ReviewStatusID=CASE U.Planning_Task WHEN 0 THEN 1 ELSE PT.ReviewStatusID END,
	PT.ReviewUserID=CASE U.Planning_Task WHEN 0 THEN NULL ELSE PT.ReviewUserID END,
	PT.ReviewDate=CASE U.Planning_Task WHEN 0 THEN NULL ELSE PT.ReviewDate END,

	PT.InspectionTaskTypeId=U.InspectionTaskTypeId,
	PT.InspectionOffset=U.InspectionOffset,
	PT.Scheduling_Group_Id=U.Scheduling_Group_Id,
	PT.Scheduling_Group_Counter=U.Scheduling_Group_Counter,

	PT.ExternalIdentifier=U.ExternalIdentifier,
	PT.SchedulingTaskId=U.SchedulingTaskId,

	PT.Planning_Task=U.Planning_Task,
	/* VV CR7824 
	PT.Planning_Lead_Time=U.Planning_Lead_Time,
	*/
	PT.Planning_Lead_Time=CASE WHEN U.Planning_Task=1 AND U.Planning_Lead_Time>0 THEN U.Planning_Lead_Time ELSE PT.Planning_Lead_Time END,
	PT.Operational_Criticality_Id=U.Operational_Criticality_Id, 
	PT.ManufacturerId=U.ManufacturerId, 
	PT.Part_Id=U.Part_Id,
	PT.Group_Number=U.Group_Number,
	PT.Warranty_Period_Days=U.Warranty_Period_Days, 
	PT.Warranty_Period_Usage=U.Warranty_Period_Usage, 

	PT.Last_Change_Usage=U.Last_Change_Usage,
	PT.Last_Change_Date=U.Last_Change_Date,
	PT.UsageQUOMId=U.UsageQUOMId, 
	PT.UsageMethod =CASE WHEN U.UsageQUOMId>0 THEN 'U' ELSE 'D' END,
	PT.[First]=U.[First], 
	PT.Frequency=U.Frequency, 
	PT.Final=U.Final,
	PT.Last_Mod_Date= GETDATE(),
	--AL: 31/01/09
	PT.PctPurchasePart=U.PctPurchasePart,
	PT.PctPurchaseLabour=U.PctPurchaseLabour,
	PT.PctPurchaseMisc=U.PctPurchaseMisc,
	PT.PctPurchaseNewPart=U.PctPurchaseNewPart,
	PT.SalesResponsibilityID=U.SalesResponsibilityID,
	PT.Maintenance_Strategy_Id = U.Maintenance_Strategy_Id,
	PT.RCMComponentStructureId = U.RCMComponentStructureId,
	/*VV CR9019*/	PT.CBDTask=U.CBDTask,
	/*VV E316*/PT.PartRatingId=U.PartRatingId,
	/*GW*/PT.AutoGenerateWOS=U.AutoGenerateWOS,
	/*E781*/
	DefaultLocationForRebuild = U.DefaultLocationForRebuild, 
	PartClassificationId = U.PartClassification,
	/*E811*/
	AutocreateExternalWorkorders = U.AutoCreateExternalWorkorders,
	AutocreatePlannedEvents = U.[AutoCreatePlannedEvents/Workorders]
		 
	FROM
	#z_ProjTaskUpdate U
		INNER JOIN
	tblProjTasks PT
		ON U.ProjTaskId=PT.ProjTaskId
END



IF @UpdateOpt=1
BEGIN
	UPDATE PTO SET
	PTO.[First]=CASE WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1 THEN PTO.[First]
					ELSE ISNULL(MTE.First_Occurrence,PT.[First]) END, 
	PTO.Frequency=CASE WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1 THEN PTO.Frequency
					  ELSE ISNULL(MTE.Frequency,PTO.Frequency) END
	FROM
	tblProjTasks PT
		INNER JOIN
	tblProjTaskOpts PTO
		ON PT.ProjTaskId=PTO.ProjTaskId
		CROSS JOIN
	#z_MTE_TASK MTE
	WHERE PT.ProjTaskId IN (SELECT ProjTaskId FROM #z_TASK_ID)
END

IF @UpdateJob=1
BEGIN
 
	--Delete Cost Allocations if cost source is set to update
	IF EXISTS(SELECT MTEId FROM #z_MTE_TASK WHERE Cost_Source>0)
	BEGIN
		IF EXISTS(SELECT CA.Proj_Task_Amt_Id FROM COST_ALLOCATION CA INNER JOIN #z_TASK_ID T 
				ON CA.Proj_Task_Amt_Id=T.ProjTaskAmtId)
		BEGIN
			DELETE CAD FROM
			COST_ALLOCATION_DETAIL CAD
				INNER JOIN
			COST_ALLOCATION CA
				ON CAD.Cost_Allocation_Id=CA.Cost_Allocation_Id
				INNER JOIN
			#z_TASK_ID PTA
				ON CA.Proj_Task_Amt_Id=PTA.ProjTaskAmtId
				
			DELETE CA FROM
			COST_ALLOCATION CA
				INNER JOIN
			#z_TASK_ID PTA
				ON CA.Proj_Task_Amt_Id=PTA.ProjTaskAmtId
		END
	END

	

	UPDATE PTA SET 
	PTA.JobCodeId= CASE WHEN MTE.Cost_Source IN(@CostSourceM,@CostSourceC) THEN NULLIF(ISNULL(MTE.Job_Code, PTA.JobCodeId),@NoneId)
				    WHEN PTA.PricedJobId>0 THEN PTA.JobCodeId
					/*External CA field shall be updated from AMT Proj Job if configuration is set update from AMT*/							
					WHEN SS.AMTSystemSource=0 AND CAC.JobCode=0 THEN PTA.JobCodeId
					ELSE NULLIF(ISNULL(MTE.Job_Code, PTA.JobCodeId),@NoneId) END,
	PTA.CurrencyId= CASE WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1 THEN PTA.CurrencyId
						 WHEN MTE.Cost_Source IN(@CostSourceM,@CostSourceC) THEN ISNULL(MTE.Currency, PTA.CurrencyId)
						 WHEN PTA.PricedJobId>0 THEN PTA.CurrencyId/*Discussed with RF. Do not change currency if linked to CA*/
						 WHEN CA.Proj_Task_Amt_Id>0 THEN PTA.CurrencyId/*Discussed with RF. Do not change currency if linked to CA*/
						 ELSE ISNULL(MTE.Currency, PTA.CurrencyId) END,
	PTA.Cost_Bearer_ID=/*External CA field shall be updated from AMT Proj Job if configuration is set update from AMT*/							
						CASE WHEN SS.AMTSystemSource=0 AND CAC.CostBearer=0 THEN PTA.Cost_Bearer_ID
						ELSE ISNULL(MTE.Cost_Bearer,PTA.Cost_Bearer_ID) END, 
	PTA.Cost_Centre_ID=/*External CA field shall be updated from AMT Proj Job if configuration is set update from AMT*/							
						CASE WHEN SS.AMTSystemSource=0 AND CAC.CostCentre=0 THEN PTA.Cost_Centre_ID
							 ELSE NULLIF(ISNULL(MTE.Cost_Centre, PTA.Cost_Centre_ID),@NoneId) END,
	PTA.Work_Group_Id=/*External CA field shall be updated from AMT Proj Job if configuration is set update from AMT*/							
						CASE WHEN SS.AMTSystemSource=0 AND CAC.WorkGroup=0 THEN PTA.Work_Group_Id
							 ELSE NULLIF(ISNULL(MTE.Work_Group, PTA.Work_Group_Id),@NoneId) END,
	PTA.PartTypeId=NULLIF(ISNULL(MTE.Part_Type, PTA.PartTypeId),@NoneId),
	PTA.Health_Safety_Id=NULLIF(ISNULL(MTE.[OH&S], PTA.Health_Safety_Id),@NoneId),
	PTA.Pricing_Date=CASE WHEN EPR.Projection_Type_Id IN(@ProjTypeBud,@ProjTypeEstCurr,@ProjTypeEstDr) THEN PTA.Pricing_Date
						  WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1  THEN PTA.Pricing_Date
					      WHEN MTE.Cost_Source IN(@CostSourceM,@CostSourceC) THEN ISNULL(MTE.Pricing_Date, PTA.Pricing_Date)
						  WHEN PTA.PricedJobId >0 THEN PTA.Pricing_Date
						  WHEN @UpdatePricingDate=1 AND EPR.Projection_Type_Id IN(@ProjTypeCurr,@ProjTypeAlt) THEN GETDATE()
						  ELSE ISNULL(MTE.Pricing_Date, PTA.Pricing_Date) END,

	PTA.QtyVolume=CASE 
					   WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1 THEN PTA.QtyVolume
					   WHEN MTE.Cost_Source =@CostSourceC THEN ISNULL(MTE.Consumable_Qty,PTA.QtyVolume)
					   WHEN MTE.Cost_Source =@CostSourceM THEN 0
					   WHEN PTA.Consumable=1 THEN ISNULL(MTE.Consumable_Qty,PTA.QtyVolume)
					   ELSE PTA.QtyVolume END,

	PTA.PercentTopUp=CASE 
						WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1 THEN PTA.PercentTopUp
						WHEN MTE.Cost_Source =@CostSourceC THEN ISNULL(MTE.[Consumable_Top_Up_%],PTA.PercentTopUp)
						WHEN MTE.Cost_Source =@CostSourceM THEN 0
						WHEN PTA.Consumable=1 THEN ISNULL(MTE.[Consumable_Top_Up_%],PTA.PercentTopUp)
						ELSE PTA.PercentTopUp END,

	PTA.UnitPrice=CASE WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1 THEN PTA.UnitPrice
					   WHEN MTE.Cost_Source =@CostSourceC THEN ISNULL(MTE.Consumable_Price,PTA.UnitPrice)
					   WHEN MTE.Cost_Source =@CostSourceM THEN 0
					   WHEN PTA.Consumable=1 THEN ISNULL(MTE.Consumable_Price,PTA.UnitPrice)
					   ELSE PTA.UnitPrice END,

	PTA.PartsCost=CASE  WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1 THEN PTA.PartsCost
						WHEN MTE.Cost_Source =@CostSourceC THEN dbo.CONSUMABLE_PART_PRICE_F(ISNULL(MTE.Consumable_Qty,PTA.QtyVolume)/*@QtyVolume*/,
									ISNULL(MTE.Consumable_Price,PTA.UnitPrice)/*@UnitPrice*/,
									ISNULL(MTE.[Consumable_Top_Up_%],PTA.PercentTopUp)/*@PercentTopUp*/)
						WHEN MTE.Cost_Source =@CostSourceM THEN ISNULL(MTE.Job_Parts_Cost,PTA.PartsCost)
						WHEN PTA.PricedJobId>0 OR CA.Proj_Task_Amt_Id>0 THEN PTA.PartsCost
						WHEN PTA.Consumable=1 THEN dbo.CONSUMABLE_PART_PRICE_F(ISNULL(MTE.Consumable_Qty,PTA.QtyVolume)/*@QtyVolume*/,
									ISNULL(MTE.Consumable_Price,PTA.UnitPrice)/*@UnitPrice*/,
									ISNULL(MTE.[Consumable_Top_Up_%],PTA.PercentTopUp)/*@PercentTopUp*/)
					    ELSE ISNULL(MTE.Job_Parts_Cost,PTA.PartsCost) END,

	PTA.LaborCost=CASE WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1 THEN PTA.LaborCost
					   WHEN MTE.Cost_Source IN(@CostSourceC,@CostSourceM) THEN ISNULL(MTE.Job_Labour_Cost,PTA.LaborCost)
					   WHEN PTA.PricedJobId>0 OR CA.Proj_Task_Amt_Id>0 THEN PTA.LaborCost
					   ELSE ISNULL(MTE.Job_Labour_Cost,PTA.LaborCost) END,

	PTA.MiscCost=CASE WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1 THEN PTA.MiscCost
					  WHEN MTE.Cost_Source IN(@CostSourceC,@CostSourceM) THEN ISNULL(MTE.Job_Misc_Cost,PTA.MiscCost)
					  WHEN PTA.PricedJobId>0 OR CA.Proj_Task_Amt_Id>0 THEN PTA.MiscCost
					  ELSE ISNULL(MTE.Job_Misc_Cost,PTA.MiscCost) END,
	
	PTA.LaborHours=CASE WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1 THEN PTA.LaborHours
						WHEN MTE.Cost_Source IN(@CostSourceC,@CostSourceM) THEN ISNULL(MTE.Job_Labour_Hours,PTA.LaborHours)
					   WHEN PTA.PricedJobId>0 OR CA.Proj_Task_Amt_Id>0 THEN PTA.LaborHours
					   ELSE ISNULL(MTE.Job_Labour_Hours,PTA.LaborHours) END,

	PTA.Duration=CASE WHEN PT.ParentTaskId>0 AND PT.AutomaticUpdate=1 THEN PTA.Duration
						/*VV CR8601 Replaced LaborHours to Duration*/
					   WHEN MTE.Cost_Source IN(@CostSourceC,@CostSourceM) THEN ISNULL(MTE.Job_Duration,PTA.Duration)
					   WHEN PTA.PricedJobId>0 OR CA.Proj_Task_Amt_Id>0 THEN PTA.Duration
					   ELSE ISNULL(MTE.Job_Duration,PTA.Duration) END,

	PTA.Parts_Cost_Expense_ID=/*External CA field shall be updated from AMT Proj Job if configuration is set update from AMT*/							
								CASE WHEN SS.AMTSystemSource=0 AND CAC.PartsCostExpense=0 THEN PTA.Parts_Cost_Expense_ID
									 ELSE NULLIF(ISNULL(MTE.Parts_Exp_Element, PTA.Parts_Cost_Expense_ID),@NoneId) END,

	PTA.Labour_Cost_Expense_ID=/*External CA field shall be updated from AMT Proj Job if configuration is set update from AMT*/							
								CASE WHEN SS.AMTSystemSource=0 AND CAC.LabourCostExpense=0 THEN PTA.Labour_Cost_Expense_ID
								     ELSE NULLIF(ISNULL(MTE.Labour_Exp_Element, PTA.Labour_Cost_Expense_ID),@NoneId) END,

	PTA.Misc_Cost_Expense_ID=/*External CA field shall be updated from AMT Proj Job if configuration is set update from AMT*/							
								CASE WHEN SS.AMTSystemSource=0 AND CAC.MiscCostExpense=0 THEN PTA.Misc_Cost_Expense_ID
								     ELSE NULLIF(ISNULL(MTE.Misc_Exp_Element, PTA.Misc_Cost_Expense_ID),@NoneId) END,
	PTA.Parts_EDC_ID=NULLIF(ISNULL(MTE.Parts_EDC,PTA.Parts_EDC_ID),@NoneId),
	PTA.Labour_EDC_ID=NULLIF(ISNULL(MTE.Labour_EDC,PTA.Labour_EDC_ID), @NoneId),
	PTA.Misc_EDC_ID=NULLIF(ISNULL(MTE.Misc_EDC,PTA.Misc_EDC_ID),@NoneId),

	PTA.Labour_Activity_Id=/*External CA field shall be updated from AMT Proj Job if configuration is set update from AMT*/							
								CASE WHEN SS.AMTSystemSource=0 AND CAC.LabourActivity=0 THEN PTA.Labour_Activity_Id
								     ELSE NULLIF(ISNULL(MTE.Labour_Activity, PTA.Labour_Activity_Id),@NoneId) END,

	PTA.Labour_Hrs_Field=CASE WHEN MTE.Labour_Type=@LabourTypeF THEN 1
							  WHEN MTE.Labour_Type=@LabourTypeS THEN 0
						 ELSE PTA.Labour_Hrs_Field END,
	PTA.PricedJobId= CASE WHEN MTE.Cost_Source IN(@CostSourceM,@CostSourceC,@CostSourceS) THEN NULL 
						 ELSE PTA.PricedJobId END
						 ,
	PTA.Consumable=CASE WHEN MTE.Cost_Source =@CostSourceC THEN 1
						WHEN MTE.Cost_Source =@CostSourceM THEN 0
						WHEN MTE.Cost_Source =@CostSourceS THEN 0
						ELSE PTA.Consumable END,
	PTA.StdJobPartsMargin=CASE WHEN MTE.Cost_Source IN(@CostSourceM,@CostSourceC,@CostSourceS) THEN NULL 
						 ELSE PTA.StdJobPartsMargin END,
	PTA.StdJobReference=CASE 
								WHEN MTE.Cost_Source IN(@CostSourceM,@CostSourceC) THEN NULL 
								WHEN MTE.Cost_Source = @CostSourceS THEN SJ.Std_Job_Ref
						 ELSE PTA.StdJobReference END
	
	FROM
	tblEqpProjs EPR
		INNER JOIN
	tblProjTasks PT
		ON EPR.EqpProjId=PT.EqpProjId
		INNER JOIN
	tblProjTaskOpts PTO
		ON PT.ProjTaskId=PTO.ProjTaskId
		INNER JOIN
	tblProjTaskAmts PTA
		ON PTO.ProjTaskOptId=PTA.ProjTaskOptId
		INNER JOIN
	#z_TASK_ID T
		ON PTA.ProjTaskAmtId=T.ProjTaskAmtId
		LEFT JOIN
	COST_ALLOCATION CA
		ON PTA.ProjTaskAmtId=CA.Proj_Task_Amt_Id
		LEFT JOIN
	SYSTEM_SOURCE SS
		ON CA.System_Source_Id=SS.System_Source_Id
		CROSS JOIN
	#z_MTE_TASK MTE
		CROSS JOIN
	COST_ALLOCATION_CONFIGURATION CAC
		LEFT JOIN 
	tblPricedJobs PJ ON PJ.PricedJobId = MTE.Standard_Job
	LEFT JOIN tblStdJobs SJ ON SJ.StdJobId  = PJ.StdJobId

	IF EXISTS(SELECT CA.proj_Task_Amt_Id FROM
			tblProjTaskAmts PTA
				INNER JOIN
			COST_ALLOCATION CA
				ON PTA.ProjTaskAmtId=CA.Proj_Task_Amt_Id		
				INNER JOIN
			#z_TASK_ID T
				ON PTA.ProjTaskAmtId=T.ProjTaskAmtId)
	BEGIN

		--Update cost allocations
		UPDATE CAD SET
		CAD.Job_Code_Id=CASE 	
						/*For internal cost allocations update the field only if there is a value in Proj Job*/	
						WHEN SS.AMTSystemSource=1 THEN ISNULL(PTA.JobCodeId,CAD.Job_Code_Id)	

						/*External CA field shall be updated from AMT Proj Job*/							
						WHEN SS.AMTSystemSource=0 AND CAC.JobCode=1 THEN PTA.JobCodeId
						
						/*External CA  the value for the field shall come from CA (A.AMTSystemSource=0 AND @JobCode=0)*/
						ELSE CAD.Job_Code_Id END, 

		CAD.Labour_Activity_Id=CASE 	
						/*For internal cost allocations update the field only if there is a value in Proj Job*/	
						WHEN SS.AMTSystemSource=1 THEN ISNULL(PTA.Labour_Activity_Id,CAD.Labour_Activity_Id)	

						/*External CA field shall be updated from AMT Proj Job*/							
						WHEN SS.AMTSystemSource=0 AND CAC.LabourActivity=1 THEN PTA.Labour_Activity_Id
						
						/*External CA  the value for the field shall come from CA (A.AMTSystemSource=0 AND @LabourActivity=0)*/
						ELSE CAD.Labour_Activity_Id END, 

		CAD.Labour_Cost_Expense_ID=CASE 	
						/*For internal cost allocations update the field only if there is a value in Proj Job*/	
						WHEN SS.AMTSystemSource=1 THEN ISNULL(PTA.Labour_Cost_Expense_ID,CAD.Labour_Cost_Expense_ID)	

						/*External CA field shall be updated from AMT Proj Job*/							
						WHEN SS.AMTSystemSource=0 AND CAC.LabourCostExpense=1 THEN PTA.Labour_Cost_Expense_ID
						
						/*External CA  the value for the field shall come from CA (A.AMTSystemSource=0 AND @LabourCostExpense=0)*/
						ELSE CAD.Labour_Cost_Expense_ID END, 

		CAD.Parts_Cost_Expense_ID=CASE 	
						/*For internal cost allocations update the field only if there is a value in Proj Job*/	
						WHEN SS.AMTSystemSource=1 THEN ISNULL(PTA.Parts_Cost_Expense_ID,CAD.Parts_Cost_Expense_ID)	

						/*External CA field shall be updated from AMT Proj Job*/							
						WHEN SS.AMTSystemSource=0 AND CAC.PartsCostExpense=1 THEN PTA.Parts_Cost_Expense_ID
						
						/*External CA  the value for the field shall come from CA (A.AMTSystemSource=0 AND @PartsCostExpense=0)*/
						ELSE CAD.Labour_Cost_Expense_ID END,

		CAD.Misc_Cost_Expense_ID=CASE 	
						/*For internal cost allocations update the field only if there is a value in Proj Job*/	
						WHEN SS.AMTSystemSource=1 THEN ISNULL(PTA.Misc_Cost_Expense_ID,CAD.Misc_Cost_Expense_ID)	

						/*External CA field shall be updated from AMT Proj Job*/							
						WHEN SS.AMTSystemSource=0 AND CAC.MiscCostExpense=1 THEN PTA.Misc_Cost_Expense_ID
						
						/*External CA  the value for the field shall come from CA (A.AMTSystemSource=0 AND @MiscCostExpense=0)*/
						ELSE CAD.Misc_Cost_Expense_ID END,

		CAD.Cost_Bearer_ID=CASE 	
						/*For internal cost allocations update the field only if there is a value in Proj Job*/	
						WHEN SS.AMTSystemSource=1 THEN ISNULL(PTA.Cost_Bearer_ID,CAD.Cost_Bearer_ID)	

						/*External CA field shall be updated from AMT Proj Job*/							
						WHEN SS.AMTSystemSource=0 AND CAC.CostBearer=1 THEN PTA.Cost_Bearer_ID
						
						/*External CA  the value for the field shall come from CA (A.AMTSystemSource=0 AND @CostBearer=0)*/
						ELSE CAD.Cost_Bearer_ID END,

		CAD.Cost_Centre_ID=CASE 	
						/*For internal cost allocations update the field only if there is a value in Proj Job*/	
						WHEN SS.AMTSystemSource=1 THEN ISNULL(PTA.Cost_Centre_ID,CAD.Cost_Centre_ID)	

						/*External CA field shall be updated from AMT Proj Job*/							
						WHEN SS.AMTSystemSource=0 AND CAC.CostCentre=1 THEN PTA.Cost_Centre_ID
						
						/*External CA  the value for the field shall come from CA (A.AMTSystemSource=0 AND @CostCentre=0)*/
						ELSE CAD.Cost_Centre_ID END,	

		CAD.Work_Group_Id=CASE 	
						/*For internal cost allocations update the field only if there is a value in Proj Job*/	
						WHEN SS.AMTSystemSource=1 THEN ISNULL(PTA.Work_Group_Id,CAD.Work_Group_Id)	

						/*External CA field shall be updated from AMT Proj Job*/							
						WHEN SS.AMTSystemSource=0 AND CAC.WorkGroup=1 THEN PTA.Work_Group_Id
						
						/*External CA  the value for the field shall come from CA (A.AMTSystemSource=0 AND @WorkGroup=0)*/
						ELSE CAD.Work_Group_Id END
		FROM
		tblProjTaskAmts PTA
			INNER JOIN
		COST_ALLOCATION CA
			ON PTA.ProjTaskAmtId=CA.Proj_Task_Amt_Id
			INNER JOIN
		COST_ALLOCATION_DETAIL CAD
			ON CA.Cost_Allocation_Id=CAD.Cost_Allocation_Id
			INNER JOIN
		SYSTEM_SOURCE SS
			ON CA.System_Source_Id=SS.System_Source_Id
			INNER JOIN
		#z_TASK_ID T
			ON PTA.ProjTaskAmtId=T.ProjTaskAmtId
			CROSS JOIN
		COST_ALLOCATION_CONFIGURATION CAC

	END
END


DECLARE @StdJobRef XML

	SET @StdJobRef=(SELECT DISTINCT Std_Job_Ref AS List_Item FROM tblStdJobs 
				INNER JOIN tblPricedJobs ON tblPricedJobs.StdJobId = tblStdJobs.StdJobId
			WHERE tblPricedJobs.PricedJobId IN (SELECT Standard_Job FROM #z_MTE_TASK)
			FOR XML RAW('Row'),ROOT('Rows'),ELEMENTS)

	IF @StdJobRef IS NOT NULL
	BEGIN
		EXEC STD_JOB_LINK_P @StdJobRef=@StdJobRef, @IncludeAllProjections = 1
	END
	
DROP TABLE #z_MTE_TASK,#z_TASK_ID

IF @ProjTaskUpdate<>''
BEGIN
	IF @UpdateHistory=1 
		EXEC UPDATE_STRATEGY_TASK_HISTORY_P @projTaskId=@ProjTaskUpdate
	ELSE
		EXEC TASK_UNLINK_FROM_STRATEGY_TASK_P @ProjTaskId=@ProjTaskUpdate



	--Relink EQS tasks
	EXEC STRATEGY_TASK_LINK_TO_EQS_TASK_P @ProjTaskId =NULL, 
												@EqpProjId =NULL,   
												@EqpPlanId =NULL,
												@Message =@Message OUTPUT,
												@ProjTaskIdMany =@ProjTaskUpdate

	SET @Message=ISNULL(@Message,'')

	IF @Message<>'' RETURN
		
	

END



IF EXISTS(SELECT SchedulingTaskId FROM #z_ProjTaskUpdate WHERE SchedulingTaskId>0)
BEGIN
	SET @ProjTaskUpdate=''

	SELECT @ProjTaskUpdate=@ProjTaskUpdate+CAST(ProjTaskId AS varchar)+',' FROM
	(SELECT DISTINCT ProjTaskId FROM #z_ProjTaskUpdate WHERE SchedulingTaskId>0) A

	IF @ProjTaskUpdate<>'' SET @ProjTaskUpdate=LEFT(@ProjTaskUpdate,LEN(@ProjTaskUpdate)-1)

	EXEC SCHEDULING_TASK_TO_PROJ_TASK_P @ProjTaskIdMany=@ProjTaskUpdate
					 
END







GO

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[MULTI_TASK_EDITOR_TASK_FIELDS_GET_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[MULTI_TASK_EDITOR_TASK_FIELDS_GET_P]
GO

create PROCEDURE [dbo].[MULTI_TASK_EDITOR_TASK_FIELDS_GET_P]
/******************************************************************************
	Name: MULTI_TASK_EDITOR_TASK_FIELDS_GET_P 

	Called By: 

	Desc: Returns data for multi-task editor
             

	Auth: Veronika Vasylyeva
	Date: 1-Apr=2008
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	07-May-12   SD          E811 - Change Column Headings so that Multi-task editor can show correct grid column headings	
	02/05/12	SD			E811 - Add fields AutocreateExternalWorkorders & AutocreatePlannedEvents
	12/04/12    SD		    E781 - Add PEX fields
	
OLD HISTORY
-----------

	06/04/09	AL			Fixed collation
    31/03/09	AL			CR7965: Added @IsMarketingCustomerSupport
    23/07/2009	KN			Added PerformanceStrategy and Component Structure
    12-Jul-10	V Vasylyeva	CR9019: CBD
     7 Oct 10	V Vasylyeva	E316: PartRating
    04	Apr 11	GW add AutoGenerateWOS
*******************************************************************************/
	/* Param List */

	@SearchText varchar(50)='%',
	@IsMarketingCustomerSupport bit=0

AS

--AL: 31/03/09
CREATE TABLE #MarketingCustomerSupport (Fld varchar(100) COLLATE DATABASE_DEFAULT,FldDesc varchar(100) COLLATE DATABASE_DEFAULT)

IF ISNULL(@IsMarketingCustomerSupport,0)<>0
BEGIN
	INSERT INTO #MarketingCustomerSupport(Fld,FldDesc)
	SELECT Fld,FldDesc FROM
	(
	SELECT 'PctPurchaseNewPart' AS Fld, '% of New Parts Purchase' FldDesc
	UNION ALL
	SELECT 'PctPurchasePart' AS Fld, 'Parts % of Purchase from Dealer' FldDesc
	UNION ALL
	SELECT 'PctPurchaseLabour' AS Fld, 'Labour % of Purchase from Dealer' FldDesc
	UNION ALL
	SELECT 'PctPurchaseMisc' AS Fld, 'Misc % of Purchase from Dealer' FldDesc
	UNION ALL
	SELECT 'SalesResponsibility' AS Fld, 'Sales Responsibility' FldDesc
	)A
END



SELECT Fld,FldDesc FROM
(
SELECT 'Description' AS Fld, 'Description' FldDesc
UNION ALL
SELECT 'Task_Mode' AS Fld, 'Task Mode' FldDesc
UNION ALL
SELECT 'Planning_Lead_Time' AS Fld, 'Planning Lead Time' FldDesc
UNION ALL
SELECT 'Operational_Criticality' AS Fld, 'Operational Criticality' FldDesc
UNION ALL
SELECT 'Manufacturer' AS Fld, 'Manufacturer' FldDesc
UNION ALL
SELECT 'Primary_Part_Number' AS Fld, 'Primary Part Number' FldDesc
UNION ALL
SELECT 'Group_Number' AS Fld, 'Group Number' FldDesc
UNION ALL
SELECT 'Warranty_Days' AS Fld, 'Warranty Days' FldDesc
UNION ALL
SELECT 'Warranty_Usage' AS Fld, 'Warranty Usage' FldDesc
UNION ALL
SELECT 'Date_Based' AS Fld, 'Date Based' FldDesc
UNION ALL
SELECT 'UOM' AS Fld, 'UOM' FldDesc
UNION ALL
SELECT 'First_Occurrence' AS Fld, 'First Occurrence' FldDesc
UNION ALL
SELECT 'Frequency' AS Fld, 'Frequency' FldDesc
UNION ALL
SELECT 'Not_After' AS Fld, 'Not After' FldDesc
UNION ALL
SELECT 'Performance_Strategy' AS Fld, 'Performance Strategy' FldDesc
UNION ALL
SELECT 'Component_Structure' AS Fld, 'Component Structure' FldDesc
UNION ALL
/*VV CR9019*/
SELECT 'CBDTask' AS Fld, 'CBD' FldDesc
/*VV E316*/
UNION ALL
SELECT 'PartRating' AS Fld, 'Rating' FldDesc
--AL: 31/03/09
UNION ALL
SELECT 'AutoGenerateWOS' AS Fld, 'Auto Generate WOS' FldDesc
/*SD E781 */
UNION ALL
SELECT 'DefaultLocationForRebuild' AS Fld, 'Default Location For Rebuild' FldDesc
UNION ALL
SELECT 'PartClassification' AS Fld, 'Part Classification' FldDesc
/*E811*/
UNION ALL
SELECT 'AutoCreateExternalWorkorders' AS Fld, 'Auto Create External Workorders' FldDesc
UNION ALL
SELECT '[AutoCreatePlannedEvents/Workorders]' AS Fld, 'Auto Create Planned Events/Workorders' FldDesc
--GW
UNION ALL
SELECT Fld,FldDesc FROM #MarketingCustomerSupport
) A
WHERE FldDesc LIKE @SearchText

DROP TABLE #MarketingCustomerSupport



GO

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[MULTI_TASK_EDITOR_GET_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[MULTI_TASK_EDITOR_GET_P]
GO

create PROCEDURE [dbo].[MULTI_TASK_EDITOR_GET_P]
/******************************************************************************
	Name: MULTI_TASK_EDITOR_GET

	Called By: 

	Desc: Returns data for multi-task editor
             

	Auth: Veronika Vasylyeva
	Date: 1-Apr=2008
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	07/05/12    SD          E811 - Remove AutocreateExternalWorkorders & AutocreatePlannedEvents from Datatype select (last select statement)
									since they are not required for boolean fields
	02/05/12    SD		    E811 - Add fields AutocreateExternalWorkorders & AutocreatePlannedEvents
	12/04/12    SD		    E781 - Add PEX fields
	
OLD HISTORY
-----------
	 9-Dec-09	V Vasylyeva	CR8604 Error when filtering for tasks
	31 Mar 09	A Lassaun.	CR7965: Added @ContractTypeID and @PrimaryPartNumberID
	 3 Sep 08	V Vasylyeva	Added EqpLocation
    11 Jun 08	V Vasylyeva	Changed datatypes in the last query	
	23 Jul 09	K Nagarajan	Added StdJob / Component Struc
	03 Sep 09	K Nagarajan Check Filter_Std_Job_Model
	 7 Oct 10	V vasylyeva	E316 Part Rating
	12 Oct 11   G Dhillon   E646 Add Task Counter and modifier code as filters
*******************************************************************************/
	/* Param List */
@EquipmentTypeId varchar(max)='',
@BranchId varchar(max)='',
@SiteId varchar(max)='',
@FleetId varchar(max)='',
@EqpPlanId varchar(max)='',
@ModelId varchar(max)='', 
@Regionid varchar(max)='', 
@DivisionId varchar(max)='', 
@EqpCriticalityId varchar(max)='', 
@EqpClassId varchar(max)='', 
@EqpGroupId  varchar(max)='', 
@EqpCategoryId varchar(max)='', 
@EqpCostCentreId varchar(max)='',
@ParentEquipmentId varchar(max)='', 
@ProjectionHeaderId varchar(max)='',
@CostResponsibilityId varchar(max)='',
@SystemId varchar(max)='',
@SubSystemId varchar(max)='',
@ComponentCodeId varchar(max)='',
@TaskTypeId varchar(max)='',
@TaskHeaderId varchar(max)='',
@TaskModeId varchar(max)='',
@JobCodeId varchar(max)='',
@CurrencyId varchar(max)='',
@CostSourceId varchar(max)='',
@TaskFields varchar(max)='',
@JobFields varchar(max)='',
@EditJob bit=0,
@Message varchar(8000)='' OUTPUT,
@EqpLocationId varchar(max)='',
--AL: 31/03/09
@ContractTypeID varchar(max)='',
@PrimaryPartNumberID varchar(max)='',
--GD E646 12/10/11
@ApplicationCodeId VARCHAR(MAX)='',
@ModifierId VARCHAR(MAX)=''

AS

DECLARE @Filter_Std_Job_Model bit
SELECT @Filter_Std_Job_Model = Filter_Std_Job_Model FROM AMT_VARIABLE

/*VV CR8604*/
DECLARE @GetModel bit
SET @GetModel=0

IF @Filter_Std_Job_Model = 1 AND CHARINDEX('Standard_Job', ISNULL(@JobFields,'') ) > 0
BEGIN
	IF ISNULL(@ModelId,'') = '' OR CHARINDEX(',', ISNULL(@ModelId,'') ) > 0
	BEGIN
		SELECT 'To update Standard Job, please select one Model.' As Msg
		RETURN
	END
	/*VV CR8604*/	
	SET @GetModel=1
END

DECLARE @CA varchar(10)
DECLARE @Multiple varchar(20)
DECLARE @Select varchar(8000)
DECLARE @From varchar(8000)
DECLARE @OrderBy varchar(8000)

SET @CA='CA - '
SET @Multiple='Multiple'


/*TaskModeId:
1 - Planning
2 - Non Planning
3 - Unassigned
*/

DECLARE @PlanningTask bit
DECLARE @NonPlanningTask bit
DECLARE @UnassignedTask bit

DECLARE @CSStdJob bit
DECLARE @CSCA bit
DECLARE @CSCons bit
DECLARE @CSMan bit

SET @PlanningTask =0
	SET @NonPlanningTask =0
	SET @UnassignedTask =0

IF @TaskModeId<>''
BEGIN
	SELECT @PlanningTask =CASE List_Item WHEN 1 THEN 1 ELSE @PlanningTask END,
	@NonPlanningTask=CASE List_Item WHEN 2 THEN 1 ELSE @NonPlanningTask END,
	@UnassignedTask=CASE List_Item WHEN 3 THEN 1 ELSE @UnassignedTask END
	FROM dbo.LIST_TO_TABLE_F(@TaskModeId)

END

SET @CSStdJob =0
SET @CSCA =0
SET @CSCons =0
SET @CSMan =0

IF @CostSourceId<>''
BEGIN
	SELECT 
	@CSStdJob =CASE List_Item WHEN 1 THEN 1 ELSE @CSStdJob END,
	@CSCA=CASE List_Item WHEN 2 THEN 1 ELSE @CSCA END,
	@CSCons=CASE List_Item WHEN 3 THEN 1 ELSE @CSCons END,
	@CSMan=CASE List_Item WHEN 0 THEN 1 ELSE @CSMan END
	FROM dbo.LIST_TO_TABLE_F(@CostSourceId)

END

CREATE TABLE #z_ProjTaskSel(ProjTaskId int,EqpPlan varchar(100) COLLATE DATABASE_DEFAULT,ParentTaskId int,
FleetId_NV int,Fleet_NV varchar(50) COLLATE DATABASE_DEFAULT,EqpPlanId_NV int,EqpTypeId_NV int,
ModelId_NV int,Model_NV varchar(50) COLLATE DATABASE_DEFAULT,Site_NV varchar(50) COLLATE DATABASE_DEFAULT
PRIMARY KEY(ProjTaskId))
 
INSERT INTO #z_ProjTaskSel(ProjTaskId,EqpPlan,ParentTaskId,FleetId_NV,Fleet_NV,EqpPlanId_NV,EqpTypeId_NV,
ModelId_NV,Model_NV,Site_NV)

SELECT PT.ProjTaskId,EH.EqpPlan,PT.ParentTaskId,EH.FleetId AS FleetId_NV,EH.Fleet AS Fleet_NV,EH.EqpPlanId AS EqpPlanId_NV,
EH.Equipment_Type_Id AS EqpTypeId_NV,EH.ModelId AS ModelId_NV,EH.Model AS Model_NV,EH.Site AS Site_NV
FROM 
EQUIPMENT_HIERARCHY_V EH
	INNER JOIN
tblProjTasks PT
	ON EH.EqpProjId=PT.EqpProjId
	INNER JOIN
tblComponentCodes CC
	ON PT.ComponentCodeId=CC.ComponentCodeId
	INNER JOIN
tblSubSystems SS
	ON CC.SubSystemId=SS.SubSystemId

WHERE
(@EquipmentTypeId='' OR EH.Equipment_Type_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EquipmentTypeId))) AND
(@BranchId='' OR EH.BranchId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@BranchId))) AND
(@SiteId='' OR EH.SiteId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@SiteId))) AND
(@FleetId='' OR EH.FleetId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@FleetId))) AND
(@EqpPlanId='' OR EH.EqpPlanId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EqpPlanId))) AND
(@ModelId='' OR EH.ModelId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@ModelId))) AND
(@RegionId='' OR EH.Region_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@RegionId))) AND
(@DivisionId='' OR EH.Division_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@DivisionId))) AND
(@EqpCriticalityId='' OR EH.Eqp_Criticality_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EqpCriticalityId))) AND
(@EqpClassId='' OR EH.Eqp_Class_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EqpClassId))) AND
(@EqpGroupId='' OR EH.Equipment_Group_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EqpGroupId))) AND
(@EqpCategoryId='' OR EH.Eqp_Category_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EqpCategoryId))) AND
(@EqpCostCentreId='' OR EH.CostCentreID IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EqpCostCentreId))) AND
(@CostResponsibilityId='' OR EH.Cost_Responsibility_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@CostResponsibilityId))) AND
(@ProjectionHeaderId='' OR EH.ProjHeaderId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@ProjectionHeaderId))) AND
(@ParentEquipmentId='' OR EH.EqpPlanId IN (SELECT EqpPlanId FROM dbo.EQP_SIBLINGS_F(@ParentEquipmentId))) AND
(@EqpLocationId='' OR EH.Eqp_Location_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@EqpLocationId))) AND
(@ContractTypeID='' OR EH.ContractTypeID IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@ContractTypeID))) AND	--AL: 31/03/09

--TaskFilters
(@SystemId='' OR SS.SystemId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@SystemId))) AND
(@SubSystemId='' OR SS.SubSystemId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@SubSystemId))) AND
(@ComponentCodeId='' OR CC.ComponentCodeId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@ComponentCodeId))) AND
(@TaskTypeId='' OR PT.TaskTypeId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@TaskTypeId))) AND
(@TaskHeaderId='' OR PT.Task_Header_Id IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@TaskHeaderId))) AND
(@PlanningTask=0 OR (@PlanningTask=1 AND PT.Planning_Task=1)) AND
(@NonPlanningTask=0 OR (@NonPlanningTask=1 AND PT.Planning_Task=0)) AND
(@UnassignedTask=0 OR (@UnassignedTask=1 AND PT.Unscheduled<>0)) AND
(@PrimaryPartNumberID='' OR ISNULL(PT.Part_Id,-1) IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@PrimaryPartNumberID))) AND
(@ApplicationCodeId='' OR PT.ApplicationCodeId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@ApplicationCodeId)))AND 
(@ModifierId='' OR PT.ModifierId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@ModifierId))) 


--drop table z_ProjTaskSel
--select * into z_ProjTaskSel from #z_ProjTaskSel return


IF @EditJob=1
BEGIN
	CREATE TABLE #z_Cost_Allocation(ProjTaskAmtId int,JobCodeId int,CostCentreId int,WorkGroupId int,
	PCostExpenseId int,LCostExpenseId int,MCostExpenseId int,LabourActivityId int, CostBearerId int PRIMARY KEY(ProjTaskAmtId))

	INSERT INTO #z_Cost_Allocation(ProjTaskAmtId,WorkGroupId,CostCentreId,PCostExpenseId,LCostExpenseId,
	MCostExpenseId,CostBearerId,LabourActivityId,JobCodeId)
	SELECT PTA.ProjTaskAmtId,
	CASE COUNT(DISTINCT ISNULL(CAD.Work_Group_Id,0)) WHEN 1 THEN MAX(CAD.Work_Group_Id) ELSE -1 END AS WorkGroupId, 
	CASE COUNT(DISTINCT ISNULL(CAD.Cost_Centre_Id,0)) WHEN 1 THEN MAX(CAD.Cost_Centre_Id) ELSE -1 END AS CostCentreId,
	CASE COUNT(DISTINCT ISNULL(CAD.Parts_Cost_Expense_Id,0)) WHEN 1 THEN MAX(CAD.Parts_Cost_Expense_Id) ELSE -1 END  AS PCostExpenseId,
	CASE COUNT(DISTINCT ISNULL(CAD.Labour_Cost_Expense_Id,0)) WHEN 1 THEN MAX(CAD.Labour_Cost_Expense_Id) ELSE -1 END  AS LCostExpenseId, 
	CASE COUNT(DISTINCT ISNULL(CAD.Misc_Cost_Expense_Id,0)) WHEN 1 THEN MAX(CAD.Misc_Cost_Expense_Id) ELSE -1 END  AS MCostExpenseId, 
	CASE COUNT(DISTINCT ISNULL(CAD.Cost_Bearer_Id,0)) WHEN 1 THEN MAX(CAD.Cost_Bearer_Id) ELSE -1 END  AS CostBearerId, 
	CASE COUNT(DISTINCT ISNULL(CAD.Labour_Activity_Id,0)) WHEN 1 THEN MAX(CAD.Labour_Activity_Id) ELSE -1 END  AS LabourActivityId, 
	CASE COUNT(DISTINCT ISNULL(CAD.Job_Code_Id,0)) WHEN 1 THEN MAX(CAD.Job_Code_Id) ELSE -1 END  AS JobCodeId
	FROM
	#z_ProjTaskSel PT
		INNER JOIN
	tblProjTaskOpts PTO
		ON PT.ProjTaskId=PTO.ProjTaskId
		INNER JOIN
	tblProjTaskAmts PTA
		ON PTO.ProjTaskOptId=PTA.ProjTaskOptId
		INNER JOIN
	COST_ALLOCATION CA
		ON PTA.ProjTaskAmtId=CA.Proj_Task_Amt_Id
		INNER JOIN
	COST_ALLOCATION_DETAIL CAD
		ON CA.Cost_Allocation_Id=CAD.Cost_Allocation_Id
	GROUP BY PTA.ProjTaskAmtId

	--drop table z_Cost_Allocation
	--select * into z_Cost_Allocation from #z_Cost_Allocation return

	CREATE TABLE #z_ProjJobs(ProjTaskId int,ProjTaskAmtId int,
	Job_Code varchar(100) COLLATE DATABASE_DEFAULT,
	Currency varchar(100) COLLATE DATABASE_DEFAULT,
	Cost_Source varchar(100) COLLATE DATABASE_DEFAULT,
	Cost_Bearer varchar(100) COLLATE DATABASE_DEFAULT,
	Cost_Centre varchar(100) COLLATE DATABASE_DEFAULT,
	Work_Group varchar(100) COLLATE DATABASE_DEFAULT,
	Part_Type varchar(100) COLLATE DATABASE_DEFAULT,
	[OH&S] varchar(100) COLLATE DATABASE_DEFAULT,
	Pricing_Date datetime,
	Consumable_Qty float, 
	[Consumable_Top_Up_%] float, 
	Consumable_Price float,
	Job_Parts_Cost float,
	Job_Labour_Cost float, 
	Job_Misc_Cost float,
	Parts_Exp_Element varchar(100) COLLATE DATABASE_DEFAULT,
	Labour_Exp_Element varchar(100) COLLATE DATABASE_DEFAULT,
	Misc_Exp_Element varchar(100) COLLATE DATABASE_DEFAULT,
	Parts_EDC varchar(100) COLLATE DATABASE_DEFAULT, 
	Labour_EDC varchar(100) COLLATE DATABASE_DEFAULT, 
	Misc_EDC varchar(100) COLLATE DATABASE_DEFAULT,
	Labour_Type varchar(100) COLLATE DATABASE_DEFAULT,
	Job_Labour_Hours float,
	Labour_Activity varchar(100) COLLATE DATABASE_DEFAULT,
	Job_Duration float ,
	Standard_Job varchar(500) COLLATE DATABASE_DEFAULT
	PRIMARY KEY(ProjTaskId,ProjTaskAmtId))

	INSERT INTO #z_ProjJobs(ProjTaskId,ProjTaskAmtId,Job_Code,Currency,Cost_Source,Cost_Bearer,Cost_Centre,Work_Group,Part_Type,
	[OH&S],Pricing_Date,Consumable_Qty, [Consumable_Top_Up_%],Consumable_Price,Job_Parts_Cost,Job_Labour_Cost, Job_Misc_Cost,
	Parts_Exp_Element,Labour_Exp_Element,Misc_Exp_Element,Parts_EDC, Labour_EDC, Misc_EDC,Labour_Type,Job_Labour_Hours,
	Labour_Activity,Job_Duration,Standard_Job)

	SELECT PT.ProjTaskId,PTA.ProjTaskAmtId,
	ISNULL(JC.Code+' - '+JC.Description,@CA+CASE WHEN CA.JobCodeId<0 THEN @Multiple ELSE JCA.Code+' - '+JCA.Description END) AS Job_Code,
	C.CurrencyDesc AS Currency,
	dbo.COST_SOURCE_DESC_GET_F(PTA.PricedJobId,CA.ProjTaskAmtId,PTA.Consumable,PT.ParentTaskId) AS Cost_Source,
	ISNULL(CB.CostBearer,@CA+CASE WHEN CA.CostBearerId<0 THEN @Multiple ELSE CBA.CostBearer END ) AS Cost_Bearer,
	ISNULL(CC.Cost_Centre_Code+' - '+CC.Cost_Centre_Desc,@CA+CASE WHEN CA.CostCentreId<0 THEN @Multiple ELSE CCA.Cost_Centre_Code+' - '+CCA.Cost_Centre_Desc END ) AS Cost_Centre,
	ISNULL(WG.Description,@CA+CASE WHEN CA.WorkgroupId<0 THEN @Multiple ELSE WGA.Description END) AS Work_Group,
	PTY.PartType + ' - ' + PTY.PartTypeDesc AS Part_Type,
	HS.Health_Safety AS [OH&S],
	CASE WHEN PTA.PricedJobId>0 THEN NULL ELSE PTA.Pricing_Date END AS Pricing_Date,

	CASE PTA.Consumable WHEN 1 THEN PTA.QtyVolume ELSE NULL END AS Consumable_Qty, 
	CASE PTA.Consumable WHEN 1 THEN PTA.PercentTopUp ELSE NULL END AS [Consumable_Top_Up_%], 
	CASE PTA.Consumable WHEN 1 THEN PTA.UnitPrice ELSE NULL END AS Consumable_Price,
	PTA.PartsCost AS Job_Parts_Cost,PTA.LaborCost AS Job_Labour_Cost, PTA.MiscCost AS Job_Misc_Cost,
	ISNULL(CEP.Cost_Expense_Code+' - '+CEP.Cost_Expense_Desc,@CA+CASE WHEN CA.PCostExpenseId<0 THEN @Multiple ELSE CEPA.Cost_Expense_Code+' - '+CEPA.Cost_Expense_Desc END) AS Parts_Exp_Element,
	ISNULL(CEL.Cost_Expense_Code+' - '+CEL.Cost_Expense_Desc,@CA+CASE WHEN CA.LCostExpenseId<0 THEN @Multiple ELSE CELA.Cost_Expense_Code+' - '+CELA.Cost_Expense_Desc END) AS Labour_Exp_Element,
	ISNULL(CEM.Cost_Expense_Code+' - '+CEM.Cost_Expense_Desc,@CA+CASE WHEN CA.MCostExpenseId<0 THEN @Multiple ELSE CEMA.Cost_Expense_Code+' - '+CEMA.Cost_Expense_Desc END) AS Misc_Exp_Element,
	EDCP.EDC_Id + ' - ' + EDCP.Journal_Description + ' : ' + EDCP.Debit_Account + '.' + EDCP.Debit_Account_Suffix AS Parts_EDC, 
	EDCL.EDC_Id + ' - ' + EDCL.Journal_Description + ' : ' + EDCL.Debit_Account + '.' + EDCL.Debit_Account_Suffix AS Labour_EDC, 
	EDCM.EDC_Id + ' - ' + EDCM.Journal_Description + ' : ' + EDCM.Debit_Account + '.' + EDCM.Debit_Account_Suffix AS Misc_EDC,
	CASE PTA.Labour_Hrs_Field WHEN 1 THEN 'Field' ELSE 'Shop' END AS Labour_Type,
	PTA.LaborHours AS Job_Labour_Hours,
	ISNULL(LA.ActivityCode+' - '+LA.LabourActivity,@CA+CASE WHEN CA.LabourActivityId<0 THEN @Multiple ELSE LAA.ActivityCode+' - '+LAA.LabourActivity END) AS Labour_Activity,
	PTA.Duration AS Job_Duration,
	SJ.StdJob AS Standard_Job

	FROM
	#z_ProjTaskSel PT
		INNER JOIN
	tblProjTaskOpts PTO
		ON PT.ProjTaskId=PTO.ProjTaskId
		INNER JOIN
	tblProjTaskAmts PTA
		ON PTO.ProjTaskOptId=PTA.ProjTaskOptId
	INNER JOIN 
	tblCurrencies C
		ON PTA.CurrencyId=C.CurrencyId	
		LEFT OUTER JOIN
	tblPartTypes PTY
		ON PTA.PartTypeId=PTY.PartTypeId
		LEFT OUTER JOIN 
	tblJobCodes JC
		ON PTA.JobCodeId=JC.JobCodeId
		LEFT OUTER JOIN 
	tblCostBearers CB
		ON PTA.Cost_Bearer_Id=CB.CostBearerid
		LEFT OUTER JOIN
	tblLabourActivities LA
		ON PTA.Labour_Activity_Id=LA.LabourActivityId
		LEFT OUTER JOIN
	COST_EXPENSE CEP
		ON PTA.Parts_Cost_Expense_ID=CEP.Cost_Expense_Id
		LEFT OUTER JOIN
	COST_EXPENSE CEL
		ON PTA.Labour_Cost_Expense_ID=CEL.Cost_Expense_Id
		LEFT OUTER JOIN
	COST_EXPENSE CEM
		ON PTA.Misc_Cost_Expense_ID=CEM.Cost_Expense_Id
		LEFT OUTER JOIN
	COST_CENTRE CC
		ON PTA.Cost_Centre_Id=CC.Cost_Centre_Id
		LEFT OUTER JOIN
	WORK_GROUP WG
		ON PTA.Work_Group_Id=WG.Work_Group_Id
		LEFT OUTER JOIN
	HEALTH_SAFETY HS
		ON PTA.Health_Safety_Id=HS.Health_Safety_Id
		LEFT OUTER JOIN
	ENTRY_DISTRIBUTION_CODE EDCM 
		ON PTA.Misc_EDC_ID = EDCM.Id 
		LEFT OUTER JOIN
	ENTRY_DISTRIBUTION_CODE EDCL 
		ON PTA.Labour_EDC_ID = EDCL.Id 
		LEFT OUTER JOIN
	ENTRY_DISTRIBUTION_CODE EDCP 
		ON PTA.Parts_EDC_ID = EDCP.Id

		LEFT OUTER JOIN
	#z_Cost_Allocation CA
		ON PTA.ProjTaskAmtId=CA.ProjTaskAmtId
		LEFT OUTER JOIN 
	tblJobCodes JCA
		ON CA.JobCodeId=JCA.JobCodeId
		LEFT OUTER JOIN 
	tblCostBearers CBA
		ON CA.CostBearerId=CBA.CostBearerid
		LEFT OUTER JOIN
	tblLabourActivities LAA
		ON CA.LabourActivityId=LAA.LabourActivityId
		LEFT OUTER JOIN
	COST_EXPENSE CEPA
		ON CA.PCostExpenseID=CEPA.Cost_Expense_Id
		LEFT OUTER JOIN
	COST_EXPENSE CELA
		ON CA.LCostExpenseID=CELA.Cost_Expense_Id
		LEFT OUTER JOIN
	COST_EXPENSE CEMA
		ON CA.MCostExpenseID=CEMA.Cost_Expense_Id
		LEFT OUTER JOIN
	COST_CENTRE CCA
		ON CA.CostCentreId=CCA.Cost_Centre_Id
		LEFT OUTER JOIN
	WORK_GROUP WGA
		ON CA.WorkGroupId=WGA.Work_Group_Id 
		LEFT OUTER JOIN
	tblPricedJobs PJ ON PJ.PricedJobId = PTA.PricedJobId
	LEFT OUTER JOIN tblStdJobs SJ ON SJ.StdJobId = PJ.StdJobId

	WHERE 
	--(@JobCodeId='' OR ISNULL(PTA.JobCodeId,CA.JobCodeId) IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@JobCodeId))) AND
	(@JobCodeId='' OR PTA.JobCodeId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@JobCodeId))) AND
	(@CurrencyId='' OR PTA.CurrencyId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@CurrencyId))) AND
	 (@CSStdJob=0 OR (@CSStdJob=1 AND PTA.PricedJobId>0)) AND
	 (@CSCA=0 OR (@CSCA=1 AND CA.ProjTaskAmtId>0)) AND
	 (@CSCons=0 OR (@CSCons=1 AND PTA.Consumable=1)) AND
	 (@CSMan=0 OR (@CSMan=1 AND PTA.PricedJobId IS NULL AND CA.ProjTaskAmtId IS NULL AND PTA.Consumable=0 AND PT.ParentTaskId IS NULL))

	DROP TABLE #z_Cost_Allocation
END

IF @TaskFields<>'' SET @TaskFields='TEF.'+REPLACE(@TaskFields,',',',TEF.')

SET @OrderBy='
ORDER BY PT.EqpPlan, TEF.Component_Code, TEF.Modifier_Code, TEF.Task_Type, TEF.Task_Counter'+ 
	CASE WHEN @TaskFields<>'' THEN ','+@TaskFields ELSE '' END

IF @TaskFields<>'' SET @TaskFields=@TaskFields+','

SET @Select='TEF.ProjTaskId,PT.EqpPlan, TEF.Component_Code, TEF.Modifier_Code, TEF.Task_Type, TEF.Task_Counter,'+@TaskFields+ 'TEF.Task_Cost'

SET @From=' FROM
MULTI_TASK_EDITOR_TASK_V TEF
	INNER JOIN
#z_ProjTaskSel PT
	ON TEF.ProjTaskId=PT.ProjTaskId'

IF @EditJob=1
BEGIN

	IF @JobFields<>'' SET @JobFields='J.'+REPLACE(@JobFields,',',',J.')

	SET @OrderBy=@OrderBy+',J.Job_Code,J.Currency,J.Cost_Source'+ CASE WHEN @JobFields<>'' THEN ','+@JobFields ELSE '' END

	IF @JobFields<>'' SET @JobFields=@JobFields+','

	SET @Select=@Select+',J.Job_Code,J.Currency,J.Cost_Source,'+@JobFields+'J.ProjTaskAmtId '
	SET @From=@From+'
	LEFT JOIN
#z_ProjJobs J
	ON PT.ProjTaskId=J.ProjTaskId'
	
END

--VV Added this because of the bug in SQL2005 - without this "where"
--an error pops up "The query processor could not produce a query plan." 
--SET @From=@From+'
--WHERE TEF.ProjTaskId IN (SELECT ProjTaskId FROM #z_ProjTaskSel) '

--drop table z_ProjTaskSel
--select * into z_ProjTaskSel from #z_ProjTaskSel

/*
print('SELECT TEF.SystemId_NV,TEF.System_NV,TEF.SubSystemId_NV,TEF.SubSystem_NV,PT.ModelId_NV,PT.Model_NV,PT.Site_NV,
PT.FleetId_NV,PT.Fleet_NV,PT.EqpPlanId_NV,PT.EqpTypeId_NV,TEF.ComponentCodeId_NV,TEF.ModifierId_NV,TEF.TaskTypeId_NV,
TEF.QUOMId_NV,TEF.QUOM_NV,TEF.ApplicationCodeId_NV,'+
@Select+@From+ @OrderBy)
*/

EXEC('SELECT TEF.SystemId_NV,TEF.System_NV,TEF.SubSystemId_NV,TEF.SubSystem_NV,PT.ModelId_NV,PT.Model_NV,PT.Site_NV,
PT.FleetId_NV,PT.Fleet_NV,PT.EqpPlanId_NV,PT.EqpTypeId_NV,TEF.ComponentCodeId_NV,TEF.ModifierId_NV,TEF.TaskTypeId_NV,
TEF.QUOMId_NV,TEF.QUOM_NV,TEF.ApplicationCodeId_NV,/*VV E316*/TEF.PartRatingId_NV,'+
@Select+@From+ @OrderBy)


DROP TABLE #z_ProjTaskSel

IF @EditJob=1 
BEGIN
	DROP TABLE #z_ProjJobs

	SET @Select=REPLACE(@Select,',J.ProjTaskAmtId','')
END

SET @Select=REPLACE(@Select,'TEF.ProjTaskId,','')
SET @Select=REPLACE(@Select,'PT.','')
SET @Select=REPLACE(@Select,'TEF.','')
SET @Select=REPLACE(@Select,'J.','')

--print 'SELECT '+@Select+' FROM dbo.MULTI_TASK_EDITOR_FLD_FORMAT_F()'
EXEC('SELECT '+@Select+' FROM dbo.MULTI_TASK_EDITOR_FLD_FORMAT_F()')

SET @From='
FROM
MULTI_TASK_EDITOR_TASK_FLD_ID_V TEF
	CROSS JOIN
MULTI_TASK_EDITOR_JOB_FLD_ID_V J'



SET @Select=REPLACE(@Select,'EqpPlan,','')
SET @Select=REPLACE(@Select,'Task_Cost,','')


--print ('SELECT  '+@Select+@From)
EXEC('SELECT  '+@Select+@From)

SELECT 'Component_Code' AS Component_Code, 'Modifier_Code_MTE' AS Modifier_Code, 'Task_Type' AS Task_Type, 
'Task_Counter_MTE' AS Task_Counter, 'Operational_Criticality_MTE' AS Operational_Criticality, 
'TEManufacturer' AS Manufacturer, 'Primary_Part_Number_MTE' AS Primary_Part_Number, 'QUOM_MTE' AS UOM,
'Job_Code_MTE' AS Job_Code, 'Currency' AS Currency,  'CostBearer' AS Cost_Bearer, 'CostCentre_MTE' AS Cost_Centre, 
'Work_Group_MTE' AS Work_Group, 'Part_Type_MTE' AS Part_Type,'HealthSafety_MTE' AS [OH&S],  'CostExpense_MTE' AS Parts_Exp_Element, 
'CostExpense_MTE' AS Labour_Exp_Element, 'CostExpense_MTE' AS Misc_Exp_Element, 'LabourActivity_MTE' AS Labour_Activity,
'EDC_MTE' AS Parts_EDC, 'EDC_MTE' AS Labour_EDC, 'EDC_MTE' AS Misc_EDC,
'PerformanceStrategy' AS  Performance_Strategy,
'ComponentStructure' AS Component_Structure,/*VV E316*/'PartRating' AS PartRating,
--'Task_Mode' AS Task_Mode,
/*E781*/'Site' AS DefaultLocationForRebuild, 'PartClassification' AS PartClassification
/*VV CR8604
IF @Filter_Std_Job_Model = 1 */
IF @GetModel=1
	SELECT ModelId , Model FROM tblModels WHERE ModelId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@ModelId))
--DROP TABLE z_ProjJobs
--select * into z_ProjJobs from #z_ProjJobs
--drop table z_Cost_Allocation
--select * into z_Cost_Allocation from #z_Cost_Allocation return
--drop table z_ProjTaskSel
--select * into z_ProjTaskSel from #z_ProjTaskSel return





GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[PROJ_TASK_ADD_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[PROJ_TASK_ADD_P]
GO

create   PROCEDURE [dbo].[PROJ_TASK_ADD_P]
/******************************************************************************
	File: 
	Name: PROJ_TASK_ADD_P

	Called By: Projected Task Summary Editor

	Desc: Adds a new projected task 
	
	

	Auth: Veronika Vasylyeva
	Date: 13-Apr-2005
*******************************************************************************
		Change History
*******************************************************************************
Date:		Author:		Description:
--------	--------	----------------------------------------
07 May 12   SD          E808 Set AutocreateExternalWorkorders & AutocreatePlannedEvents to 0 if non-planning
03 May 12	SD			E808: Check for 0 - AutocreateExternalWorkorders & AutocreatePlannedEvents
01 May 12	SD			E808: New Fields AutocreateExternalWorkorders & AutocreatePlannedEvents
                        4108 PROJ_TASK_ADD_P Add PEX fields (missed in E789) for Strategy Task Editor	
16-Aug-11	V Vasylyeva	E611: PEX fields
22 Jul 11	V Vasylyeva	E602: Serialised Component
01 Apr 11   GW Add AutoGenerateWOS tag
22 Feb 11	V Vasylyeva	E316: TagId, PartRatingId
28-Aug-10	K Nagarajan	#288: Allow zero counter
07-Jul-10   VS          CR9019: Added CBD Strategy Task
22-Oct-09	AL			CR8414: Added StartingSerialNo
30-Apr-09	V Vasylyeva	CR8035 Library changes
30-Mar-09	A Lassaun.	CR7965: added new fields
16-Sep-08	K Nagarajan	Added Default ReviewStatusID 1
18-Jan-08	V Vasylyeva	Changed external identifier
12-Jul-05	V Vasylyeva	Added @ManufacturerId,@RotablePartId,@GroupNumber,@PartId
23 Sep 05	S Ivanov	Added @SchedulingTaskId
13-Dec-05	S Ivanov	Added @ProjTaskId parameter for SCHEDULING_TASK_TO_PROJ_TASK_P 	
16-May-06	D Smith		Removed call to SCHEDULING_TASK_TO_PROJ_TASK_P
19 Sep 06	V Vasylyeva		Changes in spec
27 Sep 06	V Vasylyeva	Added @RaiseError
27-Jun-07	K Nagarajan	Added InspectionTaskType, InspectionOffset
06-Jul-07	K Nagarajan	Added Planning Parameter to Proj Business Rules stored Procedure
15-Jul-07	K Nagarajan	Added ExternalIdentifier
11 Dec 07	V Vasylyeva	Added @PerformanceStrategyReason,@RCMComponentStructureId, @ParentTaskId,@AutomaticUpdate
*******************************************************************************/

/* Param List */  
@EqpProjID int,  
@ComponentCodeId int,  
@ModifierId int,  
@TaskTypeId int,  
@ApplicationCodeId int,  
@UsageQUOMId int,  
@FinalOcc float,   
@LastChangeUsage float,   
@LastChangeDate datetime,  
@PlanningTask bit,  
@PlanningLeadTime int,  
@ProjTaskId int OUTPUT,  
@Message varchar(8000) OUTPUT,  
@ManufacturerId int=NULL,  
@RotablePartId int=NULL,   
@GroupNumber varchar(50)=NULL,   
@PartId int=NULL,  
@SchedulingTaskId int = NULL,  
@FinalDate datetime=NULL,    
@Schedule_Type_Id int=NULL,   
@Scheduling_Group_Id int=NULL,   
@Scheduling_Group_Counter int=NULL,   
@Operational_Criticality_Id int=NULL,   
@Warranty_Period_Usage float=0,   
@Warranty_Period_Days int=0,   
@Maintenance_Strategy_Id int=NULL,   
@Changeout_Guidelines varchar(1000)=NULL,   
@Task_Description varchar(100)=NULL,   
@Show_Strategy bit=0,  
@RaiseError bit=1,  
@InspectionTaskTypeId INT = NULL,  
@InspectionOffset float = NULL,  
@ExternalIdentifier varchar(50) = NULL,  
@PerformanceStrategyReason varchar(200)=NULL,  
@RCMComponentStructureId int =NULL,   
@ParentTaskId int =NULL,   
@AutomaticUpdate bit =NULL,  
--AL: 30/03/09  
@PctPurchasePart float = 100,  
@PctPurchaseLabour float = 100,  
@PctPurchaseMisc float = 100,  
@PctPurchaseNewPart float = 100,  
@SalesResponsibilityID int = NULL,  
@libDocXML text='',  
/*VV E602*/
@StartingSerialNo int=NULL, 
@CBDTask bit = 0, -- CR9019 VS
/*E316*/
@TagId varchar(50)=NULL,
@PartRatingId int=NULL,
@AutoGenerateWOS bit=0/*GW*/,
/*4108 (E789)*/
@PartClassificationId int = NULL,
@DefaultLocationForRebuild int = NULL,
/*E808*/
@AutocreateExternalWorkorders bit = 0,
@AutocreatePlannedEvents bit = 0
  
AS  
  
DECLARE @return_status int   
DECLARE @usageMethod char(1)  
Declare @Unscheduled smallint  
DECLARE @EqpPlanId int  
DECLARE @First float  
DECLARE @Frequency float  
DECLARE @Task_Header_Id int  
DECLARE @EPManufacturerId int  
DECLARE @UnassignedTaskType int  
  
DECLARE @SchT_LastPerformedUOM int  
DECLARE @SchT_LastScheduledUOM int  
DECLARE @SchT_LastPerformedDate int  
DECLARE @SchT_LastScheduledDate int  
DECLARE @Projection_Type_Id int  
  
DECLARE @ProjTypeCurr int  
DECLARE @ProjTypeAlt int  
  
SET @SchT_LastPerformedUOM=1  
SET @SchT_LastScheduledUOM=2  
SET @SchT_LastPerformedDate=3  
SET @SchT_LastScheduledDate=4  
  
SET @ProjTypeCurr=1  
SET @ProjTypeAlt=3  
  
SET @UnassignedTaskType=1   
SET @usageMethod='U'  
SET @Unscheduled= CASE @TaskTypeId WHEN @UnassignedTaskType THEN 1 ELSE 0 END  
SET @First =0  
SET @Frequency =0  
  
IF ISNULL(@RotablePartId,0)>0  
 SET @StartingSerialNo=NULL  

/*E808*/
IF (@PlanningTask=0)
BEGIN
	SET @AutocreateExternalWorkorders = 0
	SET @AutocreatePlannedEvents = 0
END
  
SET TRANSACTION ISOLATION LEVEL READ COMMITTED  
  
  
IF @RotablePartId = 0 SET @RotablePartId = null  
IF @GroupNumber = '' SET @GroupNumber = null  
IF @PartId = 0 SET @PartId = null  
SET @SchedulingTaskId =NULLIF(@SchedulingTaskId,0)   
SET @Scheduling_Group_Id =NULLIF(@Scheduling_Group_Id,0)  
SET @Scheduling_Group_Counter=NULLIF(@Scheduling_Group_Counter,-1)  
SET @Operational_Criticality_Id=NULLIF(@Operational_Criticality_Id,0)  
SET @Warranty_Period_Usage=ISNULL(@Warranty_Period_Usage,0)  
SET @Warranty_Period_Days=ISNULL(@Warranty_Period_Days,0)  
SET @Maintenance_Strategy_Id=NULLIF(@Maintenance_Strategy_Id,0)  
SET @Changeout_Guidelines=NULLIF(@Changeout_Guidelines,'')  
SET @Task_Description=NULLIF(@Task_Description,'')  
SET @UsageQUOMId=NULLIF(@UsageQUOMId,0)  
SET @InspectionTaskTypeId=NULLIF(@InspectionTaskTypeId,0)  
SET @InspectionOffset=ISNULL(@InspectionOffset,0)  
  
SET @PerformanceStrategyReason=NULLIF(@PerformanceStrategyReason,'')  
SET @RCMComponentStructureId=NULLIF(@RCMComponentStructureId,0)  
SET @ParentTaskId=NULLIF(@ParentTaskId,0)   
SET @AutomaticUpdate=ISNULL(@AutomaticUpdate,0)  
SET @SalesResponsibilityID=NULLIF(@SalesResponsibilityID,0)  
  
--The default values  
SELECT       
@EqpPlanId=tblEqpPlans.EqpPlanId, @EPManufacturerId=tblEquipment.ManufacturerId  
FROM   
tblEqpProjs   
 INNER JOIN   
tblEqpPlans   
 ON tblEqpProjs.EqpPlanId = tblEqpPlans.EqpPlanId   
 INNER JOIN  
tblEquipment   
 ON tblEqpPlans.EquipmentId = tblEquipment.EquipmentId  
WHERE tblEqpProjs.EqpProjId=@EqpProjId  
  
SET @ManufacturerId=ISNULL(@ManufacturerId,@EPManufacturerId)  
  
  
--Check the business rules   
EXEC PROJ_TASK_BUSINESS_RULES_P @EqpProjId =@EqpProjId,  
    @ComponentCodeId =@ComponentCodeId,  
    @ModifierId =@ModifierId,  
    @TaskTypeId =@TaskTypeId,  
    @ApplicationCodeId =@ApplicationCodeId,   
    @Message =@Message OUTPUT,  
    @Schedule_Type_Id =@Schedule_Type_Id OUTPUT,   
    @Scheduling_Group_Id =@Scheduling_Group_Id  OUTPUT,   
    @Scheduling_Group_Counter =@Scheduling_Group_Counter  OUTPUT,   
    @usageQUOMId =@usageQUOMId,  
    @ProjTaskId =@ProjTaskId,  
    @LastChangeDate=@LastChangeDate  OUTPUT,  
    @LastChangeUsage =@LastChangeUsage OUTPUT,  
    @UsageMethod =@UsageMethod OUTPUT,  
    @FinalDate=@FinalDate ,  
    @FinalOcc =@FinalOcc OUTPUT,  
    @InspectionTaskTypeId = @InspectionTaskTypeId OUTPUT,  
    @InspectionOffset = @Inspectionoffset OUTPUT,  
    @PlanningTask = @PlanningTask,  
    @ParentTaskId=@ParentTaskId,  
    @SchedulingTaskId=@SchedulingTaskId OUTPUT,  
    @ExternalIdentifier=@ExternalIdentifier OUTPUT  
  
  
IF @Message<>''  
BEGIN  
 IF @RaiseError=1 RAISERROR (@Message, 16, 1)  
 RETURN  
END  
  
    
IF @return_status<>1 RETURN  
  
  
--Task Header  
  
EXEC TASK_HEADER_MANAGER_P   @componentCodeId,  @modifierId,  @taskTypeId,  @applicationCodeId, @Task_Header_Id output  
  
  
SET XACT_ABORT ON  
  
  
--Add a record into tblProjTasks  
INSERT INTO tblProjTasks   
(  
EqpPlanID,  
EqpProjID,  
ComponentCodeId,  
ModifierId,  
TaskTypeId,  
applicationCodeId,  
ManufacturerId,  
UsageMethod,  
UsageQUOMId,  
[First],  
Frequency,  
Final,  
Unscheduled,  
LastModifiedDate,  
Last_Change_Usage,  
Last_Change_Date,  
Task_Header_Id,  
Planning_Task,  
Planning_Lead_Time,  
Rotable_Part_Id,  
Group_Number,  
Part_Id,  
SchedulingTaskId,  
Schedule_Type_Id,   
Scheduling_Group_Id,   
Scheduling_Group_Counter,   
Operational_Criticality_Id,   
Warranty_Period_Usage,   
Warranty_Period_Days,   
Maintenance_Strategy_Id,   
Changeout_Guidelines,   
Task_Description,   
FromStdJobs,  
InspectionTaskTypeId,  
InspectionOffset,  
ExternalIdentifier,  
PerformanceStrategyReason,  
RCMComponentStructureId,   
ParentTaskId,   
AutomaticUpdate,  
ReviewStatusID,  
--AL: 30/03/09  
PctPurchasePart,  
PctPurchaseLabour,  
PctPurchaseMisc,  
PctPurchaseNewPart,  
SalesResponsibilityID,
/*VV E602*/  
StartingSerialNoId,
CBDTask,  -- CR9019 VS
/*VV E316*/
TagId,
PartRatingId,
AutoGenerateWOS/*GW*/,
/*4108 (E789)*/
PartClassificationId,
DefaultLocationForRebuild,
/*E808*/
AutocreateExternalWorkorders,
AutocreatePlannedEvents
)  
  
VALUES(  
@EqpPlanID,  
@EqpProjID,  
@componentCodeId,   
@modifierId ,   
@taskTypeId ,   
@applicationCodeId ,   
@manufacturerId,   
@usageMethod ,  
@usageQUOMId,   
@First,  
@Frequency,  
@finalOcc,   
@Unscheduled,  
getdate(),  
@LastChangeUsage ,  
@LastChangeDate,  
@Task_Header_Id,  
@PlanningTask,   
@PlanningLeadTime,  
@RotablePartId ,   
@GroupNumber ,   
@PartId,  
@SchedulingTaskId,  
@Schedule_Type_Id,   
@Scheduling_Group_Id,   
@Scheduling_Group_Counter,   
@Operational_Criticality_Id,   
@Warranty_Period_Usage,   
@Warranty_Period_Days,   
@Maintenance_Strategy_Id,   
@Changeout_Guidelines,   
@Task_Description,   
0,/*FromStdJobs*/  
@InspectionTaskTypeId,  
@InspectionOffset,  
@ExternalIdentifier,  
@PerformanceStrategyReason,  
@RCMComponentStructureId,   
@ParentTaskId,   
@AutomaticUpdate,  
1,  
--AL: 30/03/09  
ISNULL(@PctPurchasePart,100),  
ISNULL(@PctPurchaseLabour,100),  
ISNULL(@PctPurchaseMisc,100),  
ISNULL(@PctPurchaseNewPart,100),  
@SalesResponsibilityID,  
/*VV E602*/
NULLIF(@StartingSerialNo,0),
@CBDTask, -- CR9019 VS
/*VV E316*/
NULLIF(@TagId,''),
NULLIF(@PartRatingId,0),
@AutoGenerateWOS/*GW*/,
/*4108 (E789)*/
NULLIF(@PartClassificationId, 0),
NULLIF(@DefaultLocationForRebuild,0),
/*E808*/
@AutocreateExternalWorkorders,
@AutocreatePlannedEvents
)  
  
--KN 15 Sep 08 Added Default Review Status Id.  
SET @ProjTaskId=SCOPE_IDENTITY()  


/*VV E611 add defaults for sales status and pex fields*/
IF @PlanningTask=1 EXEC NEXT_OCC_STRATEGY_DEFAULT_ADD_P @ProjTaskId=@ProjTaskId  
   
--Add lib documents   
  
IF DATALENGTH(@libDocXML)>0  
BEGIN  
 EXEC PROJ_TASK_DOCUMENTS_UPDATE_P @ProjTaskId=@ProjTaskId,@libDocXML=@libDocXML,@Message=@Message OUTPUT  
  
 IF @Message<>''  
 BEGIN  
  IF @RaiseError=1 RAISERROR (@Message, 16, 1)  
  RETURN  
 END 
  
END 



GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Update_Task]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Update_Task]
GO

create        Procedure [dbo].[usp_Update_Task]
/******************************************************************************
	File: usp_Update_Task.sql
	Name: usp_Update_Task

	Called By: - When save after ADD/EDIT tasks

	Desc: First checks that record is valid to update 
		Then updates, then calls re-calc plan which calls re-project

	Auth:Robbie Feyder
	Date: 07-JUNE-2002
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	07 May 12   SD          E808 Set AutocreateExternalWorkorders & AutocreatePlannedEvents to 0 if non-planning
	03 May 12   SD          E808: Change Default Parameter values to NULL - only update values if not null
	01 May 12	SD			E808: New Fields AutocreateExternalWorkorders & AutocreatePlannedEvents
	13 Apr 12   SD			E789: PEX Fields for Strategy Task Editor	
	16 Apr 12	JW			3972 If no PlanningLeadTime Provide for planning task, take the default value
	16 Aug 11	V Vasylyeva	E611: PEX fields
	21 Jul 11	VV	E602: Serialised Component
	01 Apr 11   GW Add AutoGenerateWOS tag
	22-Feb-11	V Vasylyeva	E316: added tagid, partratingid
	28-Aug-10	K Nagarajan	#288: Allow zero counter
	 8-Jul-10	V Vasylyeva	CR8964: Took out the check for las mod date
	07-Jul-10   VS          CR9019: Added CBD Strategy Task
	22-Oct-09	AL			CR8414: Added StartingSerialNo
	 1-May-09	V Vasylyeva	CR8035: Library Documents
	30 Mar 09	AL			CR7965: Added new fields
	12 Jan 09	V Vasylyeva	CR7825 Repair Reserve task is not deleted if parent task performance strategy is set 
							to blank.
	16 Sep 08	AL			Removed @UsageUOMID
	12 Jun 08	AL			Changed Repair Description size
	18 Apr 08	VV			Moved code to unlink EQS tasks into TASK_UNLINK_FROM_STRATEGY_TASK_P
	15 Apr 08	VV			Moved code to update task history into UPDATE_STRATEGY_TASK_HISTORY_P
	 1 Apr 08	VV			Removed a temporary table for projtaskopts 
	20 Mar 08	AL			Removed ReviewStatus related parameters
    21 Feb 08	AL			Changed PlanDateLocked to ReviewStatusID
	19-Sep-2006	ID		Commented the inserting records into tblUnlinkedWO table 
	07 Apr 05	V Vasylyeva	Usage method is always "U" from Amt 7.2

	03 Dec 04	V Vasylyeva	Added transactions, last_mod_date in task update, Strategy_Repair_Description=''
    15 Apr 04	H Singh		Planning task fix (moved to tblProjtasks table)
    7 June 02		R Feyder		Fix issue with FromStdJob a smallint type rather than a bit.
	9 Jun 02		R Feyder		Fix relinking of workorders so that only links to new task created and 
							does relinking of unassigned task
	10 Jun 02		R Feyder		Change flage to ForceCalc (rather than don't calc)
	12 Jun 02		D Smith		Added code to remove Mnt Plan Ids from Task Opts when @fromStdJobs=false
	13 Jun 02		R Feyder		Recalc Costs when the Manufacturer has changed
	27 Jun 02		R Feyder		CR 475 Update Last Occ in Task if QUOM changed, 
							also relink workorders for the task if QUOM changed for a current Projection
							- NOTE relinking will update the last occurence!
	10 Feb 03		D Smith		Changed to set flags for new recalc routine
	10 Jun 03		H Singh		two new parameters added @LastChangeUsage, @LastChangeDate
   	18 Jul 03	HS			call to add Task Header id
   	10 Sep 03	HS			Rotable Item changes, Pricing Date Changes
   	28 Nov 03	HS			Rotable Repair Strategy field in Amounts table is updated
   	11 Dec 03	HS			Save for action required is corrected
   	04 May 04	HS			setting strategy details to null in TASK table
	28 Apr 05	SI			We set DirtyUsage=1 instead of executing usp_Update_RepProjCosts
	23 Sep 05	SI			Added @SchedulingTaskId
	13 Dec 05	SI			Added @ProjTaskId parameter for SCHEDULING_TASK_TO_PROJ_TASK_P 		
	10 Jul 06	V Vasylyeva	Added relinking to EQS tasks
	08 Sep 06	SI			Removed usp_Plan_Run_Calc_Task call
	11 Sep 06	V Vasylyeva		Changes in spec
	23 Oct 06	D Smith			Assume scheduling type 1 (last UOM) - temporary, so SP runs for detailed mode!!!
	23 Oct 06	D Smith?		TODO: when run in detailed mode, should not "overwrite" fields saved in simple mode?
	05 Jan 06	V Vasylyeva	Added @Message, @RaiseError
					Last_Mod_Date=GETDATE()
	27-Jun-07	K Nagarajan	Added InspectionTaskType, InspectionOffset
	06-Jul-07	K Nagarajan	Added Planning Parameter and Checked Where Scheduled Task is a Planned Task
	14-Jul-7	SI & KN		Strategy + Scheduling Task Reset for non planning tasks.
	15 Jul 07	KN	Added ExternalIdentifier
	13 Dec 07	VV	Added @PerformanceStrategyReason,@RCMComponentStructureId, @ParentTaskId,@AutomaticUpdate
	18 Jan 08	VV	Modified External identifier
	16 Sep 08	KN	Set Next Occ = NULL If not a Planning Task.
*******************************************************************************/
	/* Param List */
	@projTaskId int,
	@componentCodeId int,
	@modifierId int,
	@taskTypeId int,
	@applicationCodeId int,
	@manufacturerId int,
	@usageMethod char(1),
	@usageQUOMId int,
	--@usageUOMId int,	AL: 16/09/08
	@FinalOcc float, 
	@pricingDate datetime,  -- TO REMOVE
	@fromStdJobs smallint=0,  -- TO REMOVE
	@RunPlanning bit = 0,
	@RecalcCosts bit = 0,
	@ForceCalc bit = 0,
	@LastChangeUsage float, 
	@LastChangeDate datetime,
	@RotablePartId int, 
	@GroupNumber varchar(50), 
	@PartId int,
	@PlanningTask bit,
	@PlanningLeadTime int,
	@SchedulingTaskId int=NULL,	
	@FinalDate datetime=NULL, 	
	@Schedule_Type_Id int=1, --DS: assume scheduling type 1? (last UOM)?
	@Scheduling_Group_Id int=NULL, 
	@Scheduling_Group_Counter int=NULL, 
    @Operational_Criticality_Id int=NULL, 
	@Warranty_Period_Usage float=0, 
	@Warranty_Period_Days int=0, 
	@Maintenance_Strategy_Id int=NULL, 
	@Changeout_Guidelines varchar(1000)=NULL, 
	@Task_Description varchar(100)=NULL, 
    @Show_Strategy bit=0,	
	@LastModDate varchar(25)=NULL,
	@Next_Occ_Strategy_Id int=NULL,
	@Repair_Description varchar(MAX)=NULL,	--AL: 12/06/08
	@Message varchar(8000)='' OUTPUT,
	@RaiseError bit=1,
	@InspectionTaskTypeId int = NULL,
	@InspectionOffset float = NULL,
	@ExternalIdentifier varchar(50) = NULL,
	@PerformanceStrategyReason varchar(200)=NULL,
	@RCMComponentStructureId int =NULL, 
	@ParentTaskId int =NULL, 
	@AutomaticUpdate bit =NULL,
	--AL: 21/02/08
--	@ReviewStatusID int=1,
--	@ReviewUserID int=NULL,
--	@ReviewDate datetime=NULL,
	--VV: 6 Mar 08
	@UpdateHistory bit=0,
	--AL: 30/03/09
	@PctPurchasePart float = 100,
	@PctPurchaseLabour float = 100,
	@PctPurchaseMisc float = 100,
	@PctPurchaseNewPart float = 100,
	@SalesResponsibilityID int = NULL,
	@libDocXML text='',
	/*VV E602*/
	@StartingSerialNo int, 
	@CBDTask bit = 0,  -- CR9019 VS
	/*E316*/
	@TagId varchar(50)=NULL,
	@PartRatingId int=NULL,
	@AutoGenerateWOS bit=0,/*GW*/
	/*E611*/
	@PEXRebuildLocationId int=NULL,
	@PEXPartId int=NULL,
	@NextDuePartClassificationId int=NULL, /*E789*/
	@UpdateNextOccFields bit=0,
	/*E789*/ 
	@PartClassificationId int = NULL, 
	@DefaultLocationForRebuild int = NULL,
	/*E808*/
	@AutocreateExternalWorkorders bit = NULL,
	@AutocreatePlannedEvents bit = NULL
AS

DECLARE @EqpProjID int
DECLARE @OldComponentCodeId int
DECLARE @OldModifierId int
DECLARE @OldTaskTypeId int
DECLARE @OldApplicationCodeId int
DECLARE @OldRotablePartId int
DECLARE @OldMaintenanceStrategyId int


DECLARE @UnassignedTask int
DECLARE @EqpPlanId int	
DECLARE @ProjTypeCurr int
DECLARE @ProjTypeAlt int
DECLARE @Task_Header_Id as int
DECLARE @return_status int 
DECLARE @OldSchedule_Type_Id int
DECLARE @UseSchedulingSystemLastOcc bit
DECLARE @SchT_LastPerformedUOM int
DECLARE @SchT_LastScheduledUOM int
DECLARE @SchT_LastPerformedDate int
DECLARE @SchT_LastScheduledDate int
DECLARE @Projection_Type_Id int
DECLARE @SQL1 varchar(4000)
DECLARE @SQL2 varchar(4000)
DECLARE @Where varchar(4000)
DECLARE @OldLast_Change_Usage float
DECLARE @OldLast_Change_Date datetime
DECLARE @PerfStratOnCondition int
DECLARE @RRTaskId int
DECLARE @ProjTaskUpdate varchar(50)

DECLARE @ProjTaskOptId int


SET @SchT_LastPerformedUOM=1
SET @SchT_LastScheduledUOM=2
SET @SchT_LastPerformedDate=3
SET @SchT_LastScheduledDate=4

SET @PerfStratOnCondition=1

SET @Message=''

IF ISNULL(@RotablePartId,0)>0
	SET @StartingSerialNo=NULL

/*E808*/
IF (@PlanningTask=0)
BEGIN
	SET @AutocreateExternalWorkorders = 0
	SET @AutocreatePlannedEvents = 0
END
  
/*VV CR8964
--Check that the task has not been chenged by the other user

IF (@LastModDate Is Not Null)
BEGIN
	EXEC @return_status = PROJ_TASK_CHECK_P @ProjTaskId=@ProjTaskId,	
						@LastModDate=@LastModDate,    
						@Message=@Message OUTPUT
	
	IF @return_status<>1 
	BEGIN	
		IF @RaiseError=1 RAISERROR (@Message, 16, 1)
		RETURN	
	END	
END

*/
	
SET @ProjTypeCurr=1
SET @ProjTypeAlt=3

IF @RotablePartId = 0 SET @RotablePartId = null
IF @GroupNumber = '' SET @GroupNumber = null
IF @PartId = 0 SET @PartId = null
SET @SchedulingTaskId =NULLIF(@SchedulingTaskId,0)	
SET @Scheduling_Group_Id =NULLIF(@Scheduling_Group_Id,0)
SET @Scheduling_Group_Counter=NULLIF(@Scheduling_Group_Counter,-1)
SET @Operational_Criticality_Id=NULLIF(@Operational_Criticality_Id,0)
SET @Warranty_Period_Usage=ISNULL(@Warranty_Period_Usage,0)
SET @Warranty_Period_Days=ISNULL(@Warranty_Period_Days,0)
SET @Maintenance_Strategy_Id=NULLIF(@Maintenance_Strategy_Id,0)
SET @Changeout_Guidelines=NULLIF(@Changeout_Guidelines,'')
SET @Task_Description=NULLIF(@Task_Description,'')
SET @UsageQUOMId=NULLIF(@UsageQUOMId,0)
SET @InspectionTaskTypeId=NULLIF(@InspectionTaskTypeId,0)
SET @InspectionOffset=ISNULL(@InspectionOffset,0)
SET @PerformanceStrategyReason=NULLIF(@PerformanceStrategyReason,'')
SET @RCMComponentStructureId=NULLIF(@RCMComponentStructureId,0)
SET @ParentTaskId=NULLIF(@ParentTaskId,0) 
SET @AutomaticUpdate=ISNULL(@AutomaticUpdate,0)
SET @SalesResponsibilityID=NULLIF(@SalesResponsibilityID,0)

--VV 12-Jan-2009
IF ISNULL(@Maintenance_Strategy_Id,0)<>@PerfStratOnCondition SET @RCMComponentStructureId=NULL

IF @PlanningTask = 1 AND @PlanningLeadTime = 0
	SELECT @PlanningLeadTime = Varchar_Value FROM AMT_TYPED_VARIABLE WHERE Value_Name = 'PlanningDaysDefault'
ELSE IF @PlanningTask = 0
	SET @PlanningLeadTime = 0

-- Get OLD Codes
SELECT  @EqpProjID = PT.EqpProjID,
	@Projection_Type_Id=EPR.Projection_Type_Id,
	@EqpPlanId=PT.EqpPlanId,
	@OldComponentCodeId =  PT.ComponentCodeId, 
	@OldModifierId = PT.ModifierId, 
	@OldTaskTypeId =PT.TaskTypeId,
	@OldApplicationCodeId = PT.ApplicationCodeId,
	@OldRotablePartId=PT.Rotable_Part_Id,
	@OldMaintenanceStrategyId=PT.Maintenance_Strategy_Id
	
FROM  tblProjTasks PT INNER JOIN
	tblEqpProjs EPR ON PT.EqpProjId=EPR.EqpProjId 	
WHERE ProjTaskId = @projTaskID

EXEC PROJ_TASK_BUSINESS_RULES_P @EqpProjId =@EqpProjId,
				@ComponentCodeId =@ComponentCodeId,
				@ModifierId =@ModifierId,
				@TaskTypeId =@TaskTypeId,
				@ApplicationCodeId =@ApplicationCodeId,	
				@Message =@Message OUTPUT,
				@Schedule_Type_Id =@Schedule_Type_Id OUTPUT, 
				@Scheduling_Group_Id =@Scheduling_Group_Id  OUTPUT, 
				@Scheduling_Group_Counter =@Scheduling_Group_Counter  OUTPUT, 
				@usageQUOMId =@usageQUOMId,
				@ProjTaskId =@ProjTaskId,
				@LastChangeDate=@LastChangeDate  OUTPUT,
				@LastChangeUsage =@LastChangeUsage OUTPUT,
				@UsageMethod =@UsageMethod OUTPUT,
				@FinalDate=@FinalDate ,
				@FinalOcc =@FinalOcc OUTPUT,
				@InspectionTaskTypeId = @InspectionTaskTypeId OUTPUT,
				@InspectionOffset = @Inspectionoffset OUTPUT,
				@PlanningTask = @PlanningTask,
				@ParentTaskId=@ParentTaskId,
				@SchedulingTaskId=@SchedulingTaskId OUTPUT,
				@ExternalIdentifier=@ExternalIdentifier OUTPUT


IF @Message<>''
BEGIN
	IF @RaiseError=1 RAISERROR (@Message, 16, 1)
	RETURN
END

SELECT @UseSchedulingSystemLastOcc=UseSchedulingSystemLastOcc FROM AMT_VARIABLE


EXEC TASK_HEADER_MANAGER_P   @componentCodeId,  @modifierId,  @taskTypeId,  @applicationCodeId, @Task_Header_Id output


SET XACT_ABORT ON

BEGIN TRANSACTION

UPDATE tblProjTasks SET 

PlanTaskOptId =CASE @PlanningTask WHEN 0 THEN NULL ELSE PlanTaskOptId END,
PlanStatus = CASE @PlanningTask WHEN 0 THEN 0 ELSE PlanStatus END, 
--PlanDateLocked=CASE @PlanningTask WHEN 0 THEN 0 ELSE PlanDateLocked END, AL: 21/02/08
PlanUseCalc=CASE @PlanningTask WHEN 0 THEN 1 ELSE PlanUseCalc END,
ComponentCodeId = @componentCodeId, 
ModifierId =@modifierId,
TaskTypeId = @taskTypeId, 
applicationCodeId =@applicationCodeId, 
ManufacturerId =@manufacturerId, 
UsageMethod = @usageMethod,
UsageQUOMId = @usageQUOMId, 
Final = @finalOcc, 
AddNotComplete = 0, 
Last_Change_Usage = @LastChangeUsage, 
Last_Change_Date = @LastChangeDate, 
Task_Header_Id = @Task_Header_Id,
Rotable_Part_Id = @RotablePartId,
Group_Number = @GroupNumber,
Part_Id = @PartId,
Planning_Task = @PlanningTask, 
Planning_Lead_Time = @PlanningLeadTime,	
SchedulingTaskId=@SchedulingTaskId,
Schedule_Type_Id=@Schedule_Type_Id, 
Scheduling_Group_Id=@Scheduling_Group_Id,
Scheduling_Group_Counter=@Scheduling_Group_Counter, 
Operational_Criticality_Id=@Operational_Criticality_Id, 
Warranty_Period_Usage=@Warranty_Period_Usage, 
Warranty_Period_Days=@Warranty_Period_Days, 
Maintenance_Strategy_Id=@Maintenance_Strategy_Id, 
Changeout_Guidelines=@Changeout_Guidelines, 
Task_Description=@Task_Description, 
InspectionTaskTypeId=@InspectionTaskTypeId, 
InspectionOffset=@InspectionOffset, 
ExternalIdentifier= @ExternalIdentifier,
PerformanceStrategyReason=@PerformanceStrategyReason,
RCMComponentStructureId= @RCMComponentStructureId,
ParentTaskId= @ParentTaskId,
AutomaticUpdate=@AutomaticUpdate, 
LastOcc=CASE WHEN @OldSchedule_Type_Id=@Schedule_Type_Id THEN LastOcc
		ELSE
			CASE WHEN @UseSchedulingSystemLastOcc = 1 AND @SchedulingTaskId > 0 THEN
				CASE WHEN @Schedule_Type_Id IN (@SchT_LastPerformedUOM,@SchT_LastPerformedDate) THEN Ext_Last_Occ ELSE Ext_Last_Sched_Occ END
			ELSE
				CASE WHEN @Schedule_Type_Id IN (@SchT_LastPerformedUOM,@SchT_LastPerformedDate) THEN AMT_WO_Last_Occ ELSE AMT_Last_Sched_Occ END	
			END
		END,

LastOccDate=CASE WHEN @OldSchedule_Type_Id=@Schedule_Type_Id THEN LastOccDate
			ELSE
				CASE WHEN @UseSchedulingSystemLastOcc = 1 AND @SchedulingTaskId > 0 THEN
					CASE WHEN @Schedule_Type_Id IN (@SchT_LastPerformedUOM,@SchT_LastPerformedDate) THEN Ext_Last_Occ_Date ELSE Ext_Last_Sched_Date END
				ELSE
					CASE WHEN @Schedule_Type_Id IN (@SchT_LastPerformedUOM,@SchT_LastPerformedDate) THEN AMT_WO_Last_Occ_Date ELSE AMT_Last_Sched_Date END
				END
			END,

Last_Mod_Date= GETDATE(),
ReviewStatusID=CASE @PlanningTask WHEN 0 THEN 1 ELSE ReviewStatusID END,
ReviewUserID=CASE @PlanningTask WHEN 0 THEN NULL ELSE ReviewUserID END,
ReviewDate=CASE @PlanningTask WHEN 0 THEN NULL ELSE ReviewDate END,
NextOcc = CASE @PlanningTask WHEN 0 THEN NULL ELSE NextOcc END,
NextOccDate = CASE @PlanningTask WHEN 0 THEN NULL ELSE NextOccDate END,
PctPurchasePart=ISNULL(@PctPurchasePart,100),
PctPurchaseLabour=ISNULL(@PctPurchaseLabour,100),
PctPurchaseMisc=ISNULL(@PctPurchaseMisc,100),
PctPurchaseNewPart=ISNULL(@PctPurchaseNewPart,100),
SalesResponsibilityID=@SalesResponsibilityID,
/*VV E602*/
StartingSerialNoId=NULLIF(@StartingSerialNo,0),
CBDTask = @CBDTask, -- CR9019 VS
/*VV E316*/
TagId=NULLIF(@TagId,''),
PartRatingId=NULLIF(@PartRatingId,0),
AutoGenerateWOS = @AutoGenerateWOS/*GW*/,
/*E789*/ 
PartClassificationId = NULLIF(@PartClassificationId, 0), 
DefaultLocationForRebuild = NULLIF(@DefaultLocationForRebuild, 0),
/*E808*/
AutocreateExternalWorkorders = ISNULL(@AutocreateExternalWorkorders, AutocreateExternalWorkorders),
AutocreatePlannedEvents = ISNULL(@AutocreatePlannedEvents, AutocreatePlannedEvents) 
WHERE ProjTaskId=@ProjTaskId



IF DATALENGTH(@libDocXML)>0
BEGIN
	EXEC PROJ_TASK_DOCUMENTS_UPDATE_P @ProjTaskId=@ProjTaskId,@libDocXML=@libDocXML,@Message=@Message OUTPUT

	IF @Message<>''
	BEGIN
		IF @RaiseError=1 RAISERROR (@Message, 16, 1)
		RETURN
	END
END

IF @OldRotablePartId>0 AND @RotablePartId is null
	BEGIN
		
		UPDATE pta
		SET pta.Rotable_Repair_Strategy = 0, 
			pta.Action_Required_Id = null, 
			pta.Rebuild_Location_Id = null
		FROM tblProjTaskOpts pto INNER JOIN
		     tblProjTaskAmts pta ON pto.ProjTaskOptId = pta.ProjTaskOptId
		WHERE
			pto.ProjTaskId = @projTaskId
		
	END 


--HS 28 Nov 2003 update Rotable_repair_strategy for max cost
-- VV 13 Feb 2008 Moved the code into UPDATE_ROTABLE_JOB_P
IF @RotablePartId>0
BEGIN
	EXEC UPDATE_ROTABLE_JOB_P @projTaskId=@projTaskId,@Message=@Message OUTPUT
END

--Delete Repair Reserve task
--VV 12-Jan-2009 
IF (ISNULL(@OldMaintenanceStrategyId,0)<>ISNULL(@Maintenance_Strategy_Id,0) AND 
ISNULL(@OldMaintenanceStrategyId,0)=@PerfStratOnCondition) OR
	(ISNULL(@Maintenance_Strategy_Id,0)=@PerfStratOnCondition AND ISNULL(@RCMComponentStructureId,0)=0)
BEGIN
	SELECT @RRTaskId=ProjTaskId FROM tblProjTasks WHERE ParentTaskId=@ProjTaskId
	
	IF ISNULL(@RRTaskId,0)>0
	BEGIN
		EXEC usp_Delete_Proj_Task @projTaskID =@RRTaskId,
				@forceDelete =0,
				@eqpProjId =null,
				@multiDelete =0,
				@Message =@Message OUTPUT,
				@RaiseError =@RaiseError,
				@DeleteLinkedCostAllocation = 1

		IF @Message<>'' RETURN
	END
END

--EQS tasks


if (@OldComponentCodeId <> @componentCodeId
    OR @OldModifierId <> @modifierId
    OR @OldTaskTypeId <> @taskTypeId
    OR @OldApplicationCodeId <> @applicationCodeId) AND (@Projection_Type_Id=@projTypeCurr)
BEGIN

	SET @ProjTaskUpdate=CAST(@ProjTaskId AS varchar)

	IF @UpdateHistory=1
	BEGIN
		
		SET @ProjTaskUpdate=CAST(@ProjTaskId AS varchar)

		EXEC UPDATE_STRATEGY_TASK_HISTORY_P @projTaskId=@ProjTaskUpdate

	END
	ELSE
	BEGIN
		/*Unlink EQS tasks*/

		EXEC TASK_UNLINK_FROM_STRATEGY_TASK_P @ProjTaskId=@ProjTaskUpdate

		/*SELECT @ProjTaskOptId=ProjTaskOptId FROM tblProjTaskOpts WHERE ProjTaskId = @ProjTaskId

		--Check that the proj task is for the current projection
		UPDATE
			TASK
		SET 	Planned_Proj_Task_Opt_ID = NULL,
			Strategy_Proj_Task_Opt_ID = NULL, 
			Strategy_Locked = 0,
			Strategy_QUOM_ID = NULL,
			Strategy_Usage = NULL, 
			Strategy_Date = NULL,
			Strategy_Repair_Description='',
			Last_Mod_Date=GetDate()
		WHERE 
			Strategy_Proj_Task_Opt_ID =@ProjTaskOptId
		OR	Planned_Proj_Task_Opt_ID =@ProjTaskOptId
		*/
		
	END
	

	--Relink EQS tasks
	IF EXISTS(SELECT Task_Id FROM TASK WHERE Eqp_Plan_Id=@EqpPlanId AND Task_Header_Id=@Task_Header_Id AND Strategy_Proj_Task_Opt_ID IS NULL)
	BEGIN
		EXEC STRATEGY_TASK_LINK_TO_EQS_TASK_P @ProjTaskId=@projTaskId
	END
	
END

/*VV E611*/
IF @PlanningTask=1 AND @UpdateNextOccFields=1
BEGIN
	IF ISNULL(@Next_Occ_Strategy_Id,0)=0 EXEC NEXT_OCC_STRATEGY_DEFAULT_ADD_P @ProjTaskId=@ProjTaskId  

	UPDATE NEXT_OCC_STRATEGY SET 
	Repair_Description=@Repair_Description,
	PEXRebuildLocationId=NULLIF(@PEXRebuildLocationId,0),
	PEXPartId=NULLIF(@PEXPartId,0),
	PEXPartTypeId=NULLIF(@NextDuePartClassificationId,0) /*E789*/
	WHERE Proj_Task_Id=@projTaskId
	
END

-- update the values from the linked SCHEDULING_TASK
EXEC SCHEDULING_TASK_TO_PROJ_TASK_P @ProjTaskId=@projTaskId



COMMIT TRANSACTION

RETURN

GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[PROJ_TASK_SUMMARY_GET_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[PROJ_TASK_SUMMARY_GET_P]
GO

create PROCEDURE [dbo].[PROJ_TASK_SUMMARY_GET_P]
/******************************************************************************
	File: 
	Name: PROJ_TASK_SUMMARY_GET_P

	Called By: Projected Task Editor

	Desc: Returns data for projected task editor
             

	Auth: Darryl
	Date: 27-Sep-2004
*******************************************************************************
		Change History
*******************************************************************************
Date:		Author:		Description:
--------	--------	----------------------------------------
01 May 12	SD			E808: New Fields AutocreateExternalWorkorders & AutocreatePlannedEvents
13 Apr 12   SD			E789: PEX Fields for Strategy Task Editor
 1 Sep 11	V Vasylyeva E621: Rebuild workorder
15 Aug 11	VVasylyeva	E611: new fields in next occ
21 Jul 11	V Vasylyeva	E602: Serialised Component
21 Feb 11	V Vasylyeva	E316: TagId and rating
15-Feb-11	DS			Added EWT's linked to this Strategy Task
07-Jul-10   VS          CR9019: Added CBD Strategy Task
22-Oct-09	AL			CR8414: Added StartingSerialNo
21-Jul-09	V Vasylyeva	CR8323: ExtDocUseClientCredentials
28-Apr-09	V Vasylyeva	CR8035: Library Documents
30-Mar-09	AL			CR7965: added new fields
03-Feb-2009	K Nagarajan	Added Last Performed WO
29-Jan-2009	V Vasylyeva	Changed Rotable In use to not return duplicate records
17/09/08	AL			removed links to tblqualifier and tbluoms
12 Jun 08	AL			Changed Repair Description size
20 May 08	V Vaylyeva	Changed component structure desc
15 Apr 08	V Vasylyeva	Modified query
 8 Apr 08	V Vasylyeva	Added Model
 4 Apr 08	V Vasylyeva	Added rounding to costs. The form asks for the changes to be saved if the numbers are not
						rounded. They are shown rounded in the form. 
					
31 Mar 08	V Vasylyeva	Added field names to COST_ALLOCATION_CONFIGURATION, Collation
19 Mar 08	V Vasylyeva	Added Sort order to the jobs
 6 Mar 08	V Vasylyeva	Changed cost allocation description
29 Feb 08	AL			Added ReviewStatus and ReviewUser
21 Feb 08	AL			Changed PlanDateLocked to ReviewStatusID
 7 Jan 08	V Vasylyeva	proj task enhancements
11 Dec 07	V Vasylyeva	Added new fields for component structure link
13 Aug 07	KN			Modified Life Used
27 Jun 07	KN			Added InspectionTaskType, InspectionOffset
07 Jun 07	K Nagarajan	Added SchedulingGroupSubTypeId
30 Jan 07	V Vasylyeva	Changed CostAllocationRef=ISNULL(Cost_allocation_Id,0)
15 Jan 07	SI		Fixed a bug with FinalChangeDate
27 Oct 06	V Vasylyeva	Changed for a task with 0 codes (0.0.0.0 - NONE)
23 Oct 06	A Lassauniere	Changed Date based First + Final
20 Oct 06	A Lassauniere	Changed used of FirstDate - now always eqpPlan startDate
16 Sep 06	V Vasylyeva	Changed to use PROJ_TASK_SUMMARY_1_V
12 Sep 06	V Vasylyeva	Changes in spec
24 Feb 06	K Nagarajan	Added Cost Centre
09 Feb 06	K Nagarajan	Added EDC Defaults
01 Dec 05	P Joy		Added Manufacturer
09 Nov 05	V Vasylyeva	Mod
02 Nov 05	V Vasylyeva	Deleted Labour_Hrs_Shop
31 Oct 05	V Vasylyeva	New fields Crane_Cost, Pct_Freight, 
				Avg_Daily_Work_Hrs, Avg_No_People, 
              			Avg_Travel_Hrs, Travel_Distance, 
				Travel_Recovery_Rate_L, Misc_Trip_Cost, 
				Labour_Hrs_Field, Labour_Hrs_Shop,
				CPE.CumPartsEscalation,CE.CumMiscEscalation, 
				CE.CumLaborEscalation,Travel_Recovery_Rate_V
23 Sep 05	S Ivanov	Added SchedulingTaskId and SchedulingTask fields
15 Sep 05	V Vasylyeva	Added Parts Cost expense fields
29 Mar 05	V Vasylyeva Moved SQL to PROJ_TASK_SUMMARY_V
24 Mar 05	V Vasylyeva	Removed AltModifierId from the Join
12 Nov 04	Darryl		Added JobCodeId
04 Apr 11	GW			Add AutoGenerateWOS
30 May 11   GD          Fixed #1826
11 Jan 12   GD          Fixed 3292
*******************************************************************************/

/* Param List */  
@projTaskId int=NULL,  
@ParentTaskId int=NULL,  
@EqpProjID int=NULL,  
@EqpPlanId int=NULL,  
@ProjHeaderId int=NULL  
  
AS  
  
DECLARE @UseSchedulingSystemLastOcc bit  
DECLARE @Projection_Type_Id int  
DECLARE @EndUsage float  
DECLARE @UsageQUOMId int  
DECLARE @CurrentUsage float  
DECLARE @FinalChangeUsage float  
DECLARE @EndDate datetime  
DECLARE @ProjTypeCurrent int  
DECLARE @Repair_Description varchar(MAX) --AL: 12/06/08  
DECLARE @Next_Occ_Strategy_Id int  
DECLARE @Planning_Task bit  
DECLARE @Strategy_Reschedule bit  
DECLARE @Pct_Frequency_Reschedule float  
DECLARE @CurrencyId int  
DECLARE @ProjTypeAlternate int  
DECLARE @ProjTypeCentreline int  
DECLARE @TaskTypeRR int  
DECLARE @ModelId int  
DECLARE @CostSourceId int  
DECLARE @Use_Distribution_Codes bit  
DECLARE @Currency varchar(50)  
DECLARE @SystemSourceAMT int  
DECLARE @ExternalDocumentSystem bit /*VV 28-Apr-2009*/  
DECLARE @ExtDocUseClientCredentials bit/*VV CR8323*/  

--#GD issue #1826
DECLARE @ModifierIdD int
DECLARE @TaskTypeIdD int
DECLARE @ComponentCodeIdD int
DECLARE @TaskCounterIdD int

/*VV E621*/
DECLARE @CnangeoutWorkorderId int, @RebuildSite varchar(1000)
  
  
SET @ProjTypeCurrent=1  
SET @ProjTypeAlternate=3  
SET @ProjTypeCentreline=5  
  
SET @SystemSourceAMT=1  
DECLARE @ScheduleTypeLPUOM int  
DECLARE @ScheduleTypeLPD int  
  
SET @ScheduleTypeLPUOM=1  
SET @ScheduleTypeLPD=3  
  
   
SELECT @UseSchedulingSystemLastOcc=UseSchedulingSystemLastOcc,@Strategy_Reschedule=Strategy_Reschedule,  
@Pct_Frequency_Reschedule=Pct_Frequency_Reschedule,@Use_Distribution_Codes=Use_Distribution_Codes  
FROM AMT_VARIABLE  
  
SELECT @CurrencyId=CurrencyId,@Currency=CurrencyDesc FROM tblCurrencies WHERE PrimaryCurr>0 OR PrimaryCurr<0  
  
SELECT @ModifierIdD =modifierid from tblModifierCodes where Default_Record=1
SELECT @TaskTypeIdD =tasktypeid from tblTaskTypes where Default_Record=1
SELECT @ComponentCodeIdD=componentcodeId from tblComponentCodes where Default_Record=1
SELECT @TaskCounterIdD=applicationcodeid from tblApplicationCodes where Default_Record=1
  
--AL: 30/03/09  
DECLARE @PartsDemandAnalysis bit  
  
SELECT @PartsDemandAnalysis=Feature_Enabled FROM AMT_FEATURE WHERE Feature_ID=15  
  
/*VV 27-Apr-2009*/  
EXEC AMT_TYPED_VARIABLE_GET_P @Value_Name='ExternalDocumentSystem',  @Varchar_Value=@ExternalDocumentSystem OUTPUT  
  
SET @ExternalDocumentSystem=ISNULL(@ExternalDocumentSystem,0)  
  
/*VV CR8323*/  
EXEC AMT_TYPED_VARIABLE_GET_P @Value_Name='ExtDocUseClientCredentials',  @Varchar_Value=@ExtDocUseClientCredentials OUTPUT  
SET @ExtDocUseClientCredentials=ISNULL(@ExtDocUseClientCredentials,0)  
  
CREATE TABLE #z_PROJ_TASK_SUMMARY(  
 ProjTaskId int ,  
 EqpPlanId int ,  
 EqpProjId int ,  
 ComponentCodeId int ,  
 ModifierId int ,  
 TaskTypeId int ,  
 ApplicationCodeId int ,  
 ManufacturerId int ,  
 UsageQUOMId int,  
 LastOcc float,  
 LastOccDate datetime,  
 PlanUseCalc bit ,  
 NextOcc float,  
 NextOccDate datetime,  
 PlanStatus tinyint ,  
 --PlanDateLocked bit, AL: 21/02/08  
 Unscheduled smallint ,  
 LastModifiedDate datetime,  
 Last_Change_Usage float ,  
 Last_Change_Date datetime ,  
 Task_Header_Id int ,  
 Rotable_Part_Id int,  
 Group_Number varchar(50) COLLATE DATABASE_DEFAULT,  
 Part_Id int,  
 Planning_Task bit ,  
 Planning_Lead_Time int,  
 SchedulingTaskId int,  
 Schedule_Type_Id int ,  
 Scheduling_Group_Id int,  
 Scheduling_Group_Counter int,  
 Operational_Criticality_Id int,  
 Warranty_Period_Usage float ,  
 Warranty_Period_Days float ,  
 Maintenance_Strategy_Id int,  
 Changeout_Guidelines varchar(1000) COLLATE DATABASE_DEFAULT,  
 Task_Description varchar(100) COLLATE DATABASE_DEFAULT,  
 Last_Mod_Date datetime ,  
 ExternalIdentifier varchar(100)/*3292*/ COLLATE DATABASE_DEFAULT,  
 InspectionTaskTypeId int,  
 InspectionOffset float,  
 PerformanceStrategyReason varchar(200) COLLATE DATABASE_DEFAULT,  
 RCMComponentStructureId int,  
 ParentTaskId int,  
 AutomaticUpdate bit,  
 [First] float ,  
 Frequency float ,  
 ProjTaskOptId int ,  
 Last_Perf_Occ float,  
 Last_Sched_Occ float,  
 Last_Perf_Date datetime,  
 Last_Sched_Date datetime,  
 Final float,  
 --AL: 21/02/08  
 ReviewStatusID int,  
 ReviewUserID int,  
 ReviewDate datetime,  
 LastPerformedWO varchar(100) COLLATE DATABASE_DEFAULT,  
  
 --AL: 30/03/09  
 PctPurchasePart float,  
 PctPurchaseLabour float,  
 PctPurchaseMisc float,  
 PctPurchaseNewPart float,  
 SalesResponsibilityID int,  
 /*VV E602*/
 StartingSerialNoId int,  
 CBDTask bit, -- CR9019 VS  
 /*VV E316*/
 TagId varchar(50) COLLATE DATABASE_DEFAULT,
 PartRatingId int,
 AutoGenerateWOS bit /*GW*/,
 /*VV E611*/
 PEXRebuildLocationId int,
 PEXPartId int,
 PEXPartTypeId int,
 /*E789*/
 PartClassificationId int,
 DefaultLocationForRebuild int,
 /*E808*/
 AutocreateExternalWorkorders bit,
 AutocreatePlannedEvents bit
 PRIMARY KEY(ProjTaskId,ProjTaskOptId)  
)   
  
CREATE TABLE #z_PTA(  
ProjTaskAmtId int,  
ProjTaskOptId int,  
PricedJobId int,  
JobCodeId int,  
PerformedAtSiteId int,  
LaborShare float,  
PartTypeId int,  
CurrencyId int,  
LaborCost float,  
PartsCost float,  
MiscCost float,  
Duration float,  
Rotable_Repair_Strategy bit,  
Action_Required_Id int,  
Rebuild_Location_Id int,  
Pricing_Date datetime,  
Labour_Activity_Id int,  
Misc_Cost_Expense_ID int,  
Labour_Cost_Expense_ID int,  
Cost_Bearer_ID int,  
Parts_Cost_Expense_ID int,  
Crane_Cost float,  
Pct_Freight float,  
Avg_Daily_Work_Hrs float,  
Avg_No_People float,  
Avg_Travel_Hrs float,  
Travel_Distance float,  
Travel_Recovery_Rate_L float,  
Misc_Trip_Cost float,  
LaborHours float,  
Labour_Hrs_Field bit,  
Travel_Recovery_Rate_V float,  
Parts_EDC_ID int,  
Labour_EDC_ID int,  
Misc_EDC_ID int,  
Cost_Centre_ID int,  
Work_Group_Id int,  
Health_Safety_Id int,  
QtyVolume float,  
PercentTopUp float,  
UnitPrice float,  
Consumable bit,  
CostSourceId int,  
System_Source_Id int  
PRIMARY KEY(ProjTaskAmtId,ProjTaskOptId)  
)   
  
  
--If @ParentTaskId is supplied - it is the defaults for RR task  
IF @ParentTaskId>0  
BEGIN  
  
 SELECT @TaskTypeRR=TaskTypeId FROM tblTaskTypes WHERE Code='RR'  
  
 INSERT INTO #z_PROJ_TASK_SUMMARY( ProjTaskId, EqpPlanId, EqpProjId, ComponentCodeId, ModifierId, TaskTypeId,   
 ApplicationCodeId,  
 ManufacturerId, UsageQUOMId, LastOcc, LastOccDate, PlanUseCalc, NextOcc, NextOccDate, PlanStatus,   
 --PlanDateLocked, AL: 21/02/08  
 Unscheduled,   
 LastModifiedDate, Last_Change_Usage, Last_Change_Date, Task_Header_Id, Rotable_Part_Id, Group_Number,   
 Part_Id, Planning_Task,   
 Planning_Lead_Time, SchedulingTaskId, Schedule_Type_Id, Scheduling_Group_Id, Scheduling_Group_Counter,   
 Operational_Criticality_Id, Warranty_Period_Usage, Warranty_Period_Days, Maintenance_Strategy_Id,   
 Changeout_Guidelines,   
 Task_Description, Last_Mod_Date, ExternalIdentifier, InspectionTaskTypeId, InspectionOffset,   
 PerformanceStrategyReason,   
 RCMComponentStructureId, ParentTaskId, AutomaticUpdate, First, Frequency, ProjTaskOptId, Last_Perf_Occ,   
 Last_Sched_Occ,   
 Last_Perf_Date, Last_Sched_Date,Final,  
 --AL: 21/02/08  
 ReviewStatusID,ReviewUserID,ReviewDate,  
 --AL: 30/03/09  
 PctPurchasePart,PctPurchaseLabour,PctPurchaseMisc,PctPurchaseNewPart,SalesResponsibilityID,StartingSerialNoId ,  
    CBDTask,
 --GW 31/3/11 
 AutoGenerateWOS,
  /*E789*/ PartClassificationId, DefaultLocationForRebuild,
  /*E808*/ AutocreateExternalWorkorders, AutocreatePlannedEvents
) 
-- CR9019  VS  
  
 SELECT       
 0 AS ProjTaskId,  
 PT.EqpPlanId, PT.EqpProjId, PT.ComponentCodeId, PT.ModifierId, @TaskTypeRR AS TaskTypeId, PT.ApplicationCodeId,   
 PT.ManufacturerId,   
 PT.UsageQUOMId,   
 NULL AS LastOcc, NULL LastOccDate, 1 AS PlanUseCalc, NULL AS NextOcc, NULL AS NextOccDate, 0 AS PlanStatus,   
 --0 AS PlanDateLocked, AL: 21/02/08  
 0 AS Unscheduled, GETDATE() AS LastModifiedDate, 0 AS Last_Change_Usage, NULL AS Last_Change_Date,   
 PT.Task_Header_Id,   
 NULL AS Rotable_Part_Id,   
 NULL AS Group_Number, NULL AS Part_Id, 0 AS Planning_Task, 0 AS Planning_Lead_Time,   
 NULL AS SchedulingTaskId, PT.Schedule_Type_Id,   
 NULL AS Scheduling_Group_Id, NULL AS Scheduling_Group_Counter, PT.Operational_Criticality_Id, 0 AS Warranty_Period_Usage,   
 0 AS Warranty_Period_Days, NULL AS Maintenance_Strategy_Id, NULL AS Changeout_Guidelines, NULL AS Task_Description,   
 GETDATE() AS Last_Mod_Date,   
 NULL AS ExternalIdentifier, NULL AS InspectionTaskTypeId, 0 AS InspectionOffset,   
 NULL AS PerformanceStrategyReason, NULL AS RCMComponentStructureId,   
 @ParentTaskId AS ParentTaskId, 1 AS AutomaticUpdate,   
 dbo.RR_FREQUENCY_F(PTO.Frequency) AS First,dbo.RR_FREQUENCY_F(PTO.Frequency) AS Frequency,  
 0 AS ProjTaskOptId,  
 NULL AS Last_Perf_Occ,  
 NULL AS Last_Sched_Occ,  
 NULL AS Last_Perf_Date,  
 NULL AS Last_Sched_Date,  
 0 AS Final,  
 --AL: 21/02/08  
 1 AS ReviewStatusID,  
 NULL AS ReviewUserID,  
 NULL AS ReviewDate,  
 --AL: 30/03/09  
 100 AS PctPurchasePart,  
 100 AS PctPurchaseLabour,  
 100 AS PctPurchaseMisc,  
 100 AS PctPurchaseNewPart,  
 NULL AS SalesResponsibilityID,  
 NULL AS StartingSerialNoId,  
 0 As CBDTask, -- CR9019 VS 
 PT.AutoGenerateWOS /*GW*/,
 /*E789*/ PT.PartClassificationId, PT.DefaultLocationForRebuild,
 /*E808*/ PT.AutocreateExternalWorkorders, PT.AutocreatePlannedEvents
 FROM           
 tblProjTasks PT   
  INNER JOIN  
 tblProjTaskOpts PTO   
  ON PT.ProjTaskId = PTO.ProjTaskId  
 WHERE PT.ProjTaskId=@ParentTaskId  
  
  
  
END  
ELSE IF @projTaskId>0  
BEGIN  
 --Task details @ProjtaskId is supplied  
 INSERT INTO #z_PROJ_TASK_SUMMARY( ProjTaskId, EqpPlanId, EqpProjId, ComponentCodeId, ModifierId, TaskTypeId, ApplicationCodeId,  
 ManufacturerId, UsageQUOMId, LastOcc, LastOccDate, PlanUseCalc, NextOcc, NextOccDate, PlanStatus,   
 --PlanDateLocked, --AL: 21/02/08  
 Unscheduled,   
 LastModifiedDate, Last_Change_Usage, Last_Change_Date, Task_Header_Id, Rotable_Part_Id, Group_Number, Part_Id, Planning_Task,   
 Planning_Lead_Time, SchedulingTaskId, Schedule_Type_Id, Scheduling_Group_Id, Scheduling_Group_Counter,   
 Operational_Criticality_Id, Warranty_Period_Usage, Warranty_Period_Days, Maintenance_Strategy_Id, Changeout_Guidelines,   
 Task_Description, Last_Mod_Date, ExternalIdentifier, InspectionTaskTypeId, InspectionOffset, PerformanceStrategyReason,   
 RCMComponentStructureId, ParentTaskId, AutomaticUpdate, First, Frequency, ProjTaskOptId, Last_Perf_Occ, Last_Sched_Occ,   
 Last_Perf_Date, Last_Sched_Date,Final,  
 --AL: 21/02/08  
 ReviewStatusID,ReviewUserID,ReviewDate, LastPerformedWO,  
 --AL: 30/03/09  
 PctPurchasePart,PctPurchaseLabour,PctPurchaseMisc,  
 PctPurchaseNewPart,SalesResponsibilityID,StartingSerialNoId,  
 CBDTask,/*VV E316*/TagId,PartRatingId,AutoGenerateWOS/*GW*/,
 /*VV E611*/ PEXRebuildLocationId, PEXPartId, PEXPartTypeId,
  /*E789*/ PartClassificationId, DefaultLocationForRebuild,
 /*E808*/ AutocreateExternalWorkorders, AutocreatePlannedEvents   
  )   
   
 SELECT       
 PT.ProjTaskId,  
 PT.EqpPlanId, PT.EqpProjId, PT.ComponentCodeId, PT.ModifierId, PT.TaskTypeId, PT.ApplicationCodeId,   
 PT.ManufacturerId,   
 PT.UsageQUOMId,   
 PT.LastOcc, PT.LastOccDate, PT.PlanUseCalc, PT.NextOcc, PT.NextOccDate, PT.PlanStatus,   
 --PT.PlanDateLocked, 21/02/08  
 PT.Unscheduled, PT.LastModifiedDate, PT.Last_Change_Usage, PT.Last_Change_Date, PT.Task_Header_Id,   
 PT.Rotable_Part_Id,   
 PT.Group_Number, PT.Part_Id, PT.Planning_Task, PT.Planning_Lead_Time,   
 PT.SchedulingTaskId, PT.Schedule_Type_Id,   
 PT.Scheduling_Group_Id, PT.Scheduling_Group_Counter, PT.Operational_Criticality_Id, PT.Warranty_Period_Usage,   
 PT.Warranty_Period_Days, PT.Maintenance_Strategy_Id, PT.Changeout_Guidelines, PT.Task_Description, PT.Last_Mod_Date,   
 PT.ExternalIdentifier, PT.InspectionTaskTypeId, PT.InspectionOffset, PT.PerformanceStrategyReason, PT.RCMComponentStructureId,   
 PT.ParentTaskId, PT.AutomaticUpdate, PTO.First, PTO.Frequency,  
 PTO.ProjTaskOptId,  
 CASE WHEN @UseSchedulingSystemLastOcc =1 AND SchedulingTaskId>0 THEN Ext_Last_Occ ELSE AMT_WO_Last_Occ END AS Last_Perf_Occ,  
 CASE WHEN @UseSchedulingSystemLastOcc =1 AND SchedulingTaskId>0 THEN Ext_Last_Sched_Occ ELSE AMT_Last_Sched_Occ END AS Last_Sched_Occ,  
 CASE WHEN @UseSchedulingSystemLastOcc =1 AND SchedulingTaskId>0 THEN Ext_Last_Occ_Date ELSE AMT_WO_Last_Occ_Date END AS Last_Perf_Date,  
 CASE WHEN @UseSchedulingSystemLastOcc =1 AND SchedulingTaskId>0 THEN Ext_Last_Sched_Date ELSE AMT_Last_Sched_Date END AS Last_Sched_Date,  
 PT.Final,  
 --AL: 21/02/08  
 PT.ReviewStatusID,PT.ReviewUserID,PT.ReviewDate,  
 -- KN : 02/02/09  
 WO.WorkorderNumber,  
 --AL: 30/03/09  
 PT.PctPurchasePart,PT.PctPurchaseLabour,PT.PctPurchaseMisc,PT.PctPurchaseNewPart,  
 PT.SalesResponsibilityID,PT.StartingSerialNoId,  
 PT.CBDTask/*CR9019 VS*/,/*VV E316*/PT.TagId,PT.PartRatingId,
 --GW 31/3/11
 PT.AutoGenerateWOS,
 /*VV E611*/ N.PEXRebuildLocationId, N.PEXPartId, N.PEXPartTypeId,
 /*E789*/ PartClassificationId, DefaultLocationForRebuild,
 /*E808*/ AutocreateExternalWorkorders, AutocreatePlannedEvents
 FROM           
 tblProjTasks PT   
  INNER JOIN  
 tblProjTaskOpts PTO   
  ON PT.ProjTaskId = PTO.ProjTaskId  
 LEFT JOIN PROJ_TASK_LAST_OCC_V LO ON LO.ProjTaskId = PT.ProjTaskId  
 LEFT JOIN tblWorkorders WO ON WO.WorkOrderId = LO.WorkOrderId 
 /*VV E611*/  
 LEFT JOIN NEXT_OCC_STRATEGY N ON PT.ProjTaskId=N.Proj_Task_Id
	
 WHERE PT.ProjTaskId=@projTaskId  
  
END  
ELSE  
 BEGIN  
 --Task defaults @ProjtaskId,@ParenttaskId are not supplied  
 DECLARE @Task_Header_Id as int  
  
 DECLARE @z_tblEqpProjs TABLE(EqpProjId int,   
   EqpPlanId int,  
   EndQUOMId int,  
   EqpProjName varchar(50) COLLATE DATABASE_DEFAULT,  
   Pricing_Date datetime,  
   Projection_Type_ID int  
   PRIMARY KEY(EqpProjId))  
  IF @EqpProjId>0  
  BEGIN  
   INSERT INTO @z_tblEqpProjs(EqpProjId,EqpPlanId,EndQUOMId,EqpProjName,Pricing_Date,Projection_Type_ID)  
   SELECT EqpProjId,EqpPlanId,EndQUOMId,EqpProjName,Pricing_Date,Projection_Type_ID FROM tblEqpProjs WHERE EqpProjId=@EqpProjId  
  END  
  ELSE  
  BEGIN  
   INSERT INTO @z_tblEqpProjs(EqpProjId,EqpPlanId,EndQUOMId,EqpProjName,Pricing_Date,Projection_Type_ID)  
   SELECT EqpProjId,EqpPlanId,EndQUOMId,EqpProjName,Pricing_Date,Projection_Type_ID FROM tblEqpProjs WHERE EqpPlanId=@EqpPlanId AND Projection_Header_Id=@ProjHeaderId  
  END  
  
 EXEC TASK_HEADER_MANAGER_P  @ComponentCodeIdD,  @ModifierIdD,  @TaskTypeIdD,  @TaskCounterIdD, @Task_Header_Id output  
  
 INSERT INTO #z_PROJ_TASK_SUMMARY( ProjTaskId, EqpPlanId, EqpProjId, ComponentCodeId, ModifierId, TaskTypeId,   
 ApplicationCodeId,  
 ManufacturerId, UsageQUOMId, LastOcc, LastOccDate, PlanUseCalc, NextOcc, NextOccDate, PlanStatus,   
 --PlanDateLocked, AL: 21/02/08  
 Unscheduled,   
 LastModifiedDate, Last_Change_Usage, Last_Change_Date, Task_Header_Id, Rotable_Part_Id, Group_Number,   
 Part_Id, Planning_Task,   
 Planning_Lead_Time, SchedulingTaskId, Schedule_Type_Id, Scheduling_Group_Id, Scheduling_Group_Counter,   
 Operational_Criticality_Id, Warranty_Period_Usage, Warranty_Period_Days, Maintenance_Strategy_Id,   
 Changeout_Guidelines,   
 Task_Description, Last_Mod_Date, ExternalIdentifier, InspectionTaskTypeId, InspectionOffset,   
 PerformanceStrategyReason,   
 RCMComponentStructureId, ParentTaskId, AutomaticUpdate, First, Frequency, ProjTaskOptId, Last_Perf_Occ,   
 Last_Sched_Occ,   
 Last_Perf_Date, Last_Sched_Date,Final,  
 --AL: 21/02/08  
 ReviewStatusID,ReviewUserID,ReviewDate,  
 --AL: 30/03/09  
 PctPurchasePart,PctPurchaseLabour,PctPurchaseMisc,PctPurchaseNewPart,SalesResponsibilityID,
 /*VV E602*/StartingSerialNoId,
 CBDTask,AutoGenerateWOS/*GW*/,
  /*E789*/ PartClassificationId, DefaultLocationForRebuild,
  /*E808*/ AutocreateExternalWorkorders, AutocreatePlannedEvents) -- CR9019 VS
  
 SELECT       
 0 AS ProjTaskId,  
 EPR.EqpPlanId, EPR.EqpProjId, @ComponentCodeIdD AS ComponentCodeId, @ModifierIdD AS ModifierId, @TaskTypeIdD AS TaskTypeId, @TaskCounterIdD AS ApplicationCodeId,   
 E.ManufacturerId, EPR.EndQUOMId AS UsageQUOMId,   
 NULL AS LastOcc, NULL LastOccDate, 1 AS PlanUseCalc, NULL AS NextOcc, NULL AS NextOccDate, 0 AS PlanStatus,   
 --0 AS PlanDateLocked, AL: 21/02/08  
 0 AS Unscheduled, GETDATE() AS LastModifiedDate, 0 AS Last_Change_Usage, NULL AS Last_Change_Date,   
 @Task_Header_Id AS Task_Header_Id,   
 NULL AS Rotable_Part_Id,   
 NULL AS Group_Number, NULL AS Part_Id, 0 AS Planning_Task, 0 AS Planning_Lead_Time,   
 NULL AS SchedulingTaskId,   
 CASE WHEN EPR.EndQUOMId>0 THEN @ScheduleTypeLPUOM ELSE @ScheduleTypeLPD END AS Schedule_Type_Id,   
 NULL AS Scheduling_Group_Id, NULL AS Scheduling_Group_Counter,   
 NULL AS Operational_Criticality_Id, 0 AS Warranty_Period_Usage,   
 0 AS Warranty_Period_Days, NULL AS Maintenance_Strategy_Id, NULL AS Changeout_Guidelines, NULL AS Task_Description,   
 GETDATE() AS Last_Mod_Date,   
 NULL AS ExternalIdentifier, NULL AS InspectionTaskTypeId, 0 AS InspectionOffset,   
 NULL AS PerformanceStrategyReason, NULL AS RCMComponentStructureId,   
 NULL AS ParentTaskId, 0 AS AutomaticUpdate,   
 0 AS First,0 AS Frequency,  
 0 AS ProjTaskOptId,  
 NULL AS Last_Perf_Occ,  
 NULL AS Last_Sched_Occ,  
 NULL AS Last_Perf_Date,  
 NULL AS Last_Sched_Date,  
 0 AS Final,  
 --AL: 21/02/08  
 1 AS ReviewStatusID,  
 NULL AS ReviewUserID,  
 NULL AS ReviewDate,  
 --AL: 30/03/09  
 100 AS PctPurchasePart,  
 100 AS PctPurchaseLabour,  
 100 AS PctPurchaseMisc,  
 100 AS PctPurchaseNewPart,  
 NULL AS SalesResponsibilityID, 
 /*VV E602*/ 
 NULL AS StartingSerialNoId,
 0 As CBDTask, -- CR9019 VS
 0 As AutoGenerateWOS/*GW*/,
  /*E789*/NULL AS PartClassificationId, NULL AS DefaultLocationForRebuild,
  /*E808*/ 0 AS AutocreateExternalWorkorders, 0 AS AutocreatePlannedEvents 
  
 FROM           
 @z_tblEqpProjs EPR   
  INNER JOIN  
 tblEqpPlans EP  
  ON EPR.EqpPlanId=EP.EqpPlanId  
  INNER JOIN  
 tblEquipment E   
  ON EP.EquipmentId = E.EquipmentId  
    
   
END  
  
  
IF @ParentTaskId>0  
BEGIN  
   
 SET @CostSourceId=dbo.COST_SOURCE_GET_F(0,0,0,@ParentTaskId)   
  
 INSERT INTO #z_PTA(  
 ProjTaskAmtId, ProjTaskOptId, PricedJobId, JobCodeId, PerformedAtSiteId, LaborShare, PartTypeId, CurrencyId, LaborCost,   
 PartsCost, MiscCost,   Duration, Rotable_Repair_Strategy, Action_Required_Id, Rebuild_Location_Id, Pricing_Date,   
 Labour_Activity_Id, Misc_Cost_Expense_ID, Labour_Cost_Expense_ID, Cost_Bearer_ID, Parts_Cost_Expense_ID, Crane_Cost,   
 Pct_Freight, Avg_Daily_Work_Hrs, Avg_No_People, Avg_Travel_Hrs, Travel_Distance, Travel_Recovery_Rate_L, Misc_Trip_Cost,   
 LaborHours, Labour_Hrs_Field, Travel_Recovery_Rate_V, Parts_EDC_ID, Labour_EDC_ID, Misc_EDC_ID, Cost_Centre_ID,   
 Work_Group_Id, Health_Safety_Id, QtyVolume, PercentTopUp, UnitPrice, Consumable,CostSourceId,System_Source_Id )   
 SELECT       
 -1 AS ProjTaskAmtId, 0 AS ProjTaskOptId, NULL AS PricedJobId,   
 CASE WHEN COUNT(DISTINCT(PTA.JobCodeId))>1 THEN NULL ELSE MAX(PTA.JobCodeId) END AS JobCodeId,   
 NULL AS PerformedAtSiteId, 100 AS LaborShare, NULL AS PartTypeId,   
 @CurrencyId AS CurrencyId,   
  
 /* Use escalation in current/alternate/centreline only for the tasks in current/alternate/centrelines  
 In all other cases the pricing date is at the projection level and the costs are not escalated*/  
  
 SUM(PTA.TotalLabourCost * CASE WHEN EPR.Projection_Type_ID IN (@ProjTypeCurrent,@ProjTypeAlternate,@ProjTypeCentreline)  
 THEN CE.CumLaborEscalation ELSE 1 END * PTO.Probability / 100/ ERC.ExRate  
 /NULLIF(PTO.Frequency,0)*dbo.RR_FREQUENCY_F(PTO.Frequency))*CS.LabourFactor AS LaborCost,   
  
 SUM(PTA.PartsCost * CASE WHEN EPR.Projection_Type_ID IN (@ProjTypeCurrent,@ProjTypeAlternate,@ProjTypeCentreline)   
 THEN CPE.CumPartsEscalation ELSE 1 END *   
 PTO.Probability / 100/ ERC.ExRate/NULLIF(PTO.Frequency,0)*dbo.RR_FREQUENCY_F(PTO.Frequency))*CS.PartFactor  
 AS PartsCost,   
  
 SUM(PTA.TotalMiscCost * CASE WHEN EPR.Projection_Type_ID IN (@ProjTypeCurrent,@ProjTypeAlternate,@ProjTypeCentreline)  
 THEN CE.CumMiscEscalation ELSE 1 END * PTO.Probability / 100/ ERC.ExRate  
 /NULLIF(PTO.Frequency,0)*dbo.RR_FREQUENCY_F(PTO.Frequency))*CS.PartFactor AS MiscCost,   
    
 SUM(PTA.Duration* PTO.Probability / 100/NULLIF(PTO.Frequency,0)*dbo.RR_FREQUENCY_F(PTO.Frequency))*  
 CS.DurationFactor  AS Duration,   
  
 0 AS Rotable_Repair_Strategy, NULL AS Action_Required_Id, NULL AS Rebuild_Location_Id,  
 /*If projection is current/alt/centreline set pricing date to the currenct date, in all other cases the pricing date is  
 from projection*/  
 CASE WHEN EPR.Projection_Type_ID IN (@ProjTypeCurrent,@ProjTypeAlternate,@ProjTypeCentreline) THEN GETDATE()  
 ELSE EPR.Pricing_Date END AS Pricing_Date,  
   
 CASE WHEN COUNT(DISTINCT(PTA.Labour_Activity_Id))>1 THEN NULL ELSE MAX(PTA.Labour_Activity_Id) END AS Labour_Activity_Id,    
 CASE WHEN COUNT(DISTINCT(PTA.Misc_Cost_Expense_ID))>1 THEN NULL ELSE MAX(PTA.Misc_Cost_Expense_ID) END AS Misc_Cost_Expense_ID,   
 CASE WHEN COUNT(DISTINCT(PTA.Labour_Cost_Expense_ID))>1 THEN NULL ELSE MAX(PTA.Labour_Cost_Expense_ID) END AS Labour_Cost_Expense_ID,   
 CASE WHEN COUNT(DISTINCT(PTA.Cost_Bearer_ID))>1 THEN NULL ELSE MAX(PTA.Cost_Bearer_ID) END AS Cost_Bearer_ID,   
 CASE WHEN COUNT(DISTINCT(PTA.Parts_Cost_Expense_ID))>1 THEN NULL ELSE MAX(PTA.Parts_Cost_Expense_ID) END AS Parts_Cost_Expense_ID,   
 0 AS Crane_Cost, 0 AS Pct_Freight, 0 AS Avg_Daily_Work_Hrs, 0 AS Avg_No_People, 0 AS Avg_Travel_Hrs, 0 AS Travel_Distance,   
 0 AS Travel_Recovery_Rate_L, 0 AS Misc_Trip_Cost,   
  
 SUM(PTA.LaborHours* PTO.Probability / 100/NULLIF(PTO.Frequency,0)*dbo.RR_FREQUENCY_F(PTO.Frequency))*  
 CS.LabourHrsFactor AS LaborHours,  
 1 AS Labour_Hrs_Field, 0 AS Travel_Recovery_Rate_V,   
 CASE WHEN COUNT(DISTINCT(PTA.Parts_EDC_ID))>1 THEN NULL ELSE MAX(PTA.Parts_EDC_ID) END AS Parts_EDC_ID,   
 CASE WHEN COUNT(DISTINCT(PTA.Labour_EDC_ID))>1 THEN NULL ELSE MAX(PTA.Labour_EDC_ID) END AS Labour_EDC_ID,   
 CASE WHEN COUNT(DISTINCT(PTA.Misc_EDC_ID))>1 THEN NULL ELSE MAX(PTA.Misc_EDC_ID) END AS Misc_EDC_ID,   
 CASE WHEN COUNT(DISTINCT(PTA.Cost_Centre_ID))>1 THEN NULL ELSE MAX(PTA.Cost_Centre_ID) END AS Cost_Centre_ID,   
 CASE WHEN COUNT(DISTINCT(PTA.Work_Group_Id))>1 THEN NULL ELSE MAX(PTA.Work_Group_Id) END AS Work_Group_Id,   
 CASE WHEN COUNT(DISTINCT(PTA.Health_Safety_Id))>1 THEN NULL ELSE MAX(PTA.Health_Safety_Id) END AS Health_Safety_Id,   
 0 AS QtyVolume, 0 AS PercentTopUp, 0 AS UnitPrice,0 AS Consumable,@CostSourceId AS CostSourceId,NULL AS System_Source_Id 
 --PT.CBDTask -- CR9019 VS 
   
 FROM   
 tblProjTasks PT     
  INNER JOIN  
 tblProjTaskOpts PTO   
  ON PT.ProjTaskId = PTO.ProjTaskId  
  INNER JOIN   
 PROJ_TASK_AMT_COST_1_V PTA  
  ON PTA.ProjTaskOptId = PTO.ProjTaskOptId  
  INNER JOIN   
 tblCostEscalations CE  
  ON PTA.Pricing_Date >= CE.EscalationDate AND PTA.Pricing_Date < CE.EndDate  
  INNER JOIN   
 tblCostPartsEscalations CPE  
  ON CE.CostEscalationId = CPE.CostEscalationId AND CPE.ManufacturerId = PT.ManufacturerId  
  INNER JOIN   
 tblEqpProjs EPR  
  ON PT.EqpProjId = EPR.EqpProjId  
  INNER JOIN   
 tblExRates ER  
  ON EPR.ExchangeRateId = ER.ExRateID  
  INNER JOIN   
 tblExRateCurrencies ERC  
  ON ERC.ExRateID = ER.ExRateID AND ERC.CurrencyID = PTA.CurrencyID  
  INNER JOIN  
 RCM_COMPONENT_STRUCTURE CS  
  ON PT.RCMComponentStructureId=CS.RCMComponentStructureId  
 WHERE PT.ProjTaskId=@ParentTaskId  
 GROUP BY PT.ProjTaskId,  
 CASE WHEN EPR.Projection_Type_ID IN (@ProjTypeCurrent,@ProjTypeAlternate,@ProjTypeCentreline) THEN GETDATE() ELSE EPR.Pricing_Date END,  
 CS.PartFactor,CS.LabourFactor,CS.MiscFactor,CS.LabourHrsFactor,CS.DurationFactor,  
 PT.CBDTask -- CBDTask  
  
END  
ELSE IF @projTaskId>0  
BEGIN  
 --@projTaskId is supplied  
 INSERT INTO #z_PTA(  
 ProjTaskAmtId, ProjTaskOptId, PricedJobId, JobCodeId, PerformedAtSiteId, LaborShare, PartTypeId, CurrencyId, LaborCost,   
 PartsCost, MiscCost,   Duration, Rotable_Repair_Strategy, Action_Required_Id, Rebuild_Location_Id, Pricing_Date,   
 Labour_Activity_Id, Misc_Cost_Expense_ID, Labour_Cost_Expense_ID, Cost_Bearer_ID, Parts_Cost_Expense_ID, Crane_Cost,   
 Pct_Freight, Avg_Daily_Work_Hrs, Avg_No_People, Avg_Travel_Hrs, Travel_Distance, Travel_Recovery_Rate_L, Misc_Trip_Cost,   
 LaborHours, Labour_Hrs_Field, Travel_Recovery_Rate_V, Parts_EDC_ID, Labour_EDC_ID, Misc_EDC_ID, Cost_Centre_ID,   
 Work_Group_Id, Health_Safety_Id, QtyVolume, PercentTopUp, UnitPrice, Consumable,CostSourceId,System_Source_Id)  
 SELECT       
 ProjTaskAmtId, PTA.ProjTaskOptId, PricedJobId, JobCodeId, PerformedAtSiteId, LaborShare, PartTypeId, CurrencyId, LaborCost,   
 PartsCost, MiscCost,   Duration, Rotable_Repair_Strategy, Action_Required_Id, Rebuild_Location_Id, Pricing_Date,   
 Labour_Activity_Id, Misc_Cost_Expense_ID, Labour_Cost_Expense_ID, Cost_Bearer_ID, Parts_Cost_Expense_ID, Crane_Cost,   
 Pct_Freight, Avg_Daily_Work_Hrs, Avg_No_People, Avg_Travel_Hrs, Travel_Distance, Travel_Recovery_Rate_L, Misc_Trip_Cost,   
 LaborHours, Labour_Hrs_Field, Travel_Recovery_Rate_V, Parts_EDC_ID, Labour_EDC_ID, Misc_EDC_ID, Cost_Centre_ID,   
 Work_Group_Id, Health_Safety_Id, QtyVolume, PercentTopUp, UnitPrice, Consumable,  
 dbo.COST_SOURCE_GET_F(PTA.PricedJobId,CA.Cost_Allocation_Id,PTA.Consumable,PT.ParentTaskId) AS CostSourceId,  
 CA.System_Source_Id AS System_Source_Id  
 FROM           
 tblProjTaskAmts PTA  
  INNER JOIN  
 #z_PROJ_TASK_SUMMARY PT  
  ON PTA.ProjTaskOptId=PT.ProjTaskOptId  
  LEFT OUTER JOIN  
 COST_ALLOCATION CA  
  ON PTA.ProjTaskAmtId=CA.Proj_Task_Amt_Id  
END  
ELSE   
BEGIN  
 --Task defaults  
 DECLARE @PartTypeID int  
 DECLARE @Parts_EDC_ID int  
 DECLARE @Labour_EDC_ID int  
 DECLARE @Misc_EDC_ID int  
  
 SELECT @PartTypeID=PartTypeId FROM tblPartTypes WHERE PartTypeDefault<>0  
  
 SELECT @Parts_EDC_ID = EDC.[ID]   
 FROM ENTRY_DISTRIBUTION_CODE EDC   
 WHERE EDC.Parts_Default = 1  
  
 SELECT @Labour_EDC_ID = EDC.[ID]   
 FROM ENTRY_DISTRIBUTION_CODE EDC   
 WHERE EDC.Labour_Default = 1  
  
 SELECT @Misc_EDC_ID = EDC.[ID]  
 FROM ENTRY_DISTRIBUTION_CODE EDC   
 WHERE EDC.Misc_Default = 1  
  
  
  
 INSERT INTO #z_PTA(  
 ProjTaskAmtId, ProjTaskOptId, PricedJobId, JobCodeId, PerformedAtSiteId, LaborShare, PartTypeId, CurrencyId, LaborCost,   
 PartsCost, MiscCost,   Duration, Rotable_Repair_Strategy, Action_Required_Id, Rebuild_Location_Id, Pricing_Date,   
 Labour_Activity_Id, Misc_Cost_Expense_ID, Labour_Cost_Expense_ID, Cost_Bearer_ID, Parts_Cost_Expense_ID, Crane_Cost,   
 Pct_Freight, Avg_Daily_Work_Hrs, Avg_No_People, Avg_Travel_Hrs, Travel_Distance, Travel_Recovery_Rate_L, Misc_Trip_Cost,   
 LaborHours, Labour_Hrs_Field, Travel_Recovery_Rate_V, Parts_EDC_ID, Labour_EDC_ID, Misc_EDC_ID, Cost_Centre_ID,   
 Work_Group_Id, Health_Safety_Id, QtyVolume, PercentTopUp, UnitPrice, Consumable,CostSourceId,System_Source_Id)  
 SELECT       
 -1 AS ProjTaskAmtId, 0 AS ProjTaskOptId, NULL AS PricedJobId,   
 0 AS JobCodeId, NULL AS PerformedAtSiteId, 100 AS LaborShare, @PartTypeID AS PartTypeId, @CurrencyId AS CurrencyId,   
 0 AS LaborCost, 0 AS PartsCost, 0 AS MiscCost, 0 AS Duration, 0 AS Rotable_Repair_Strategy,   
 NULL AS Action_Required_Id, NULL AS Rebuild_Location_Id,   
 /*If projection is current/alt/centreline set pricing date to the currenct date, in all other cases the pricing date is  
 from projection*/  
 CASE WHEN EPR.Projection_Type_ID IN (@ProjTypeCurrent,@ProjTypeAlternate,@ProjTypeCentreline) THEN GETDATE()  
 ELSE EPR.Pricing_Date END AS Pricing_Date,   
 NULL AS Labour_Activity_Id, NULL AS Misc_Cost_Expense_ID, NULL AS Labour_Cost_Expense_ID,   
 EP.Default_Cost_Bearer_ID AS Cost_Bearer_ID, NULL AS Parts_Cost_Expense_ID, 0 AS Crane_Cost,   
 0 AS Pct_Freight, 0 AS Avg_Daily_Work_Hrs, 0 AS Avg_No_People, 0 AS Avg_Travel_Hrs, 0 AS Travel_Distance,   
 0 AS Travel_Recovery_Rate_L, 0 AS Misc_Trip_Cost, 0 AS LaborHours, 1 AS Labour_Hrs_Field,   
 0 AS Travel_Recovery_Rate_V, @Parts_EDC_ID AS Parts_EDC_ID, @Labour_EDC_ID AS Labour_EDC_ID,   
 @Misc_EDC_ID AS Misc_EDC_ID, EP.Cost_Centre_ID AS Cost_Centre_ID,   
 NULL AS Work_Group_Id, NULL AS Health_Safety_Id, 0 AS QtyVolume, 0 AS PercentTopUp, 0 AS UnitPrice, 0 AS Consumable,  
 dbo.COST_SOURCE_GET_F(0,0,0,0) AS CostSourceId,  
 NULL AS System_Source_Id  
 FROM           
 @z_tblEqpProjs EPR   
  INNER JOIN  
 tblEqpPlans EP  
  ON EPR.EqpPlanId=EP.EqpPlanId  
END  
  
/*drop table z_PROJ_TASK_SUMMARY  
select * into z_PROJ_TASK_SUMMARY from #z_PROJ_TASK_SUMMARY   
return*/  
  
  
--Check if we need to show strategy details  
  
SELECT @Projection_Type_Id=EPR.Projection_Type_Id, @UsageQUOMId=PT.UsageQUOMId,@EqpProjId=PT.EqpProjId,   
@EndDate=EPR.EndDate,  
@EndUsage=CASE WHEN ISNULL(EPR.EndQUOMId,0)=ISNULL(PT.UsageQUOMId,0) THEN EPR.EndUsage ELSE 0 END,  
@Planning_Task=PT.Planning_Task,@ModelId=E.ModelId  
FROM   
tblEquipment E  
 INNER JOIN  
tblEqpPlans EP  
 ON E.EquipmentId=EP.EquipmentId  
 INNER JOIN  
#z_PROJ_TASK_SUMMARY PT  
 ON EP.EqpPlanId=PT.EqpPlanId  
 INNER JOIN  
tblEqpProjs EPR  
 ON PT.EqpProjId=EPR.EqpProjId  
  
IF @Projection_Type_Id=@ProjTypeCurrent AND @Planning_Task=1 
BEGIN  
	--Final change usage  
	SELECT @FinalChangeUsage=MAX(OccUsage) FROM tblProjTaskOccs WHERE ProjTaskId=@ProjTaskId  

	--End Usage  
	IF @EndUsage=0  
	BEGIN  
	SET @EndUsage=dbo.GET_EQP_PROJ_END_USAGE_F(@EqpProjId, @UsageQUOMID,@EndDate)  
	END  

	--Current Usage  
	SET @CurrentUsage=dbo.GET_USAGE_FROM_DATE_F(@EqpProjId,@UsageQUOMID,GETDATE())  

	EXEC NEXT_OCC_STRATEGY_DEFAULT_ADD_P @ProjTaskId=@projTaskId  

	SELECT @Next_Occ_Strategy_Id=Next_Occ_Strategy_Id,@Repair_Description=Repair_Description FROM NEXT_OCC_STRATEGY WHERE Proj_Task_Id=@projTaskId  
	
	/*VV E621*/	
	SELECT @CnangeoutWorkorderId=dbo.CHANGEOUT_WORKORDER_ID_GET_F(@ProjTaskId)
	
	IF(ISNULL(@CnangeoutWorkorderId,0)>0) 
	BEGIN
		SELECT @RebuildSite=S.Site
		FROM
		TASK C
			INNER JOIN
		TASK R
			ON C.RebuildTaskId=R.Task_ID
			INNER JOIN
		tblSites S
			ON R.Site_Id=S.SiteId
		WHERE C.Task_ID=@CnangeoutWorkorderId
	END
	
END  
  
--Cost allocations  
SELECT * INTO #z_COST_ALLOCATIONS FROM dbo.COST_ALLOCATIONS_F('',0,0,0,0,0,@ProjTaskId)  
  
CREATE TABLE #z_PTCost(ProjTaskId int,PartsCost float,LabourCost float,MiscCost float,Duration float,  
LaborHours float,CCost_Bearer_Id int,Cost_Bearer_Id int PRIMARY KEY (ProjTaskId))  
  
IF @ParentTaskId>0  
BEGIN  
 INSERT INTO #z_PTCost(ProjTaskId,PartsCost,LabourCost,MiscCost,Duration,LaborHours,CCost_Bearer_Id,Cost_Bearer_Id)  
 SELECT 0 AS ProjTaskId,PTA.PartsCost,PTA.LaborCost,PTA.MiscCost,PTA.Duration,PTA.LaborHours,  
 1 AS CCost_Bearer_Id,PTA.Cost_Bearer_Id  
 FROM  
 #z_PROJ_TASK_SUMMARY PT  
  INNER JOIN  
 #z_PTA PTA  
  ON PT.ProjTaskOptId=PTA.ProjTaskOptId    
  INNER JOIN   
 tblCostEscalations CE  
  ON PTA.Pricing_Date >= CE.EscalationDate AND PTA.Pricing_Date < CE.EndDate  
  INNER JOIN   
 tblCostPartsEscalations CPE  
  ON CE.CostEscalationId = CPE.CostEscalationId AND CPE.ManufacturerId = PT.ManufacturerId  
  INNER JOIN   
 tblEqpProjs EPR  
  ON PT.EqpProjId = EPR.EqpProjId  
  INNER JOIN   
 tblExRates ER  
  ON EPR.ExchangeRateId = ER.ExRateID  
  INNER JOIN   
 tblExRateCurrencies ERC  
  ON ERC.ExRateID = ER.ExRateID AND ERC.CurrencyID = PTA.CurrencyID  
   
END  
ELSE IF @ProjTaskId>0  
BEGIN  
 INSERT INTO #z_PTCost(ProjTaskId,PartsCost,LabourCost,MiscCost,Duration,LaborHours,CCost_Bearer_Id,Cost_Bearer_Id)  
 SELECT PT.ProjTaskId,  
 SUM(PTA.PartsCost * CPE.CumPartsEscalation/ ERC.ExRate/* *PTO.Probability / 100*/) AS PartsCost,  
 SUM(PTA.TotalLabourCost * CE.CumLaborEscalation/ ERC.ExRate/* *PTO.Probability / 100*/) AS LabourCost,  
 SUM(PTA.TotalMiscCost * CE.CumMiscEscalation/ ERC.ExRate/* *PTO.Probability / 100*/) AS MiscCost,  
 SUM(PTA.Duration /** PTO.Probability / 100*/)  AS Duration,   
 SUM(PTA.LaborHours /** PTO.Probability / 100*/) AS LaborHours,  
 COUNT(DISTINCT PTA.Cost_Bearer_Id) AS CCost_Bearer_Id,MAX(PTA.Cost_Bearer_Id) AS Cost_Bearer_Id  
 FROM  
 #z_PROJ_TASK_SUMMARY PT  
  INNER JOIN  
 #z_PTA A  
  ON PT.ProjTaskOptId=A.ProjTaskOptId  
  INNER JOIN  
 PROJ_TASK_AMT_COST_1_V PTA  
  ON A.ProjTaskAmtId=PTA.ProjTaskAmtId  
  INNER JOIN   
 tblCostEscalations CE  
  ON PTA.Pricing_Date >= CE.EscalationDate AND PTA.Pricing_Date < CE.EndDate  
  INNER JOIN   
 tblCostPartsEscalations CPE  
  ON CE.CostEscalationId = CPE.CostEscalationId AND CPE.ManufacturerId = PT.ManufacturerId  
  INNER JOIN   
 tblEqpProjs EPR  
  ON PT.EqpProjId = EPR.EqpProjId  
  INNER JOIN   
 tblExRates ER  
  ON EPR.ExchangeRateId = ER.ExRateID  
  INNER JOIN   
 tblExRateCurrencies ERC  
  ON ERC.ExRateID = ER.ExRateID AND ERC.CurrencyID = PTA.CurrencyID  
 GROUP BY PT.ProjTaskId  
END  
ELSE  
BEGIN  
 INSERT INTO #z_PTCost(ProjTaskId,PartsCost,LabourCost,MiscCost,Duration,LaborHours,CCost_Bearer_Id,Cost_Bearer_Id)  
 SELECT 0 AS ProjTaskId,PTA.PartsCost,PTA.LaborCost,PTA.MiscCost,PTA.Duration,PTA.LaborHours,  
 1 AS CCost_Bearer_Id,PTA.Cost_Bearer_Id  
 FROM  
 #z_PTA PTA  
END  
/*  
drop table z_PROJ_TASK_SUMMARY,z_PTA,z_COST_ALLOCATIONS,z_PTCost  
Select * into z_PROJ_TASK_SUMMARY from #z_PROJ_TASK_SUMMARY  
select * into z_PTA from  #z_PTA  
select * into z_COST_ALLOCATIONS from #z_COST_ALLOCATIONS  
select * into z_PTCost from #z_PTCost  
return  
*/  
  
SELECT     PT.ProjTaskId, CC.Code + ' - ' + CC.Description AS Component_Code, MC.Code + ' - ' + MC.Description AS Modifier_Code,   
 TT.Code + ' - ' + TT.Description AS Task_Type, AC.Code + ' - ' + AC.Description AS Task_Counter, PT.Planning_Task, PT.Planning_Lead_Time,   
 PT.UsageQUOMId, PT.First, PT.Frequency, PT.Final,   
 PT.SchedulingTaskId, ST.SchedulingTask + ', ' + CAST(ST.Interval AS varchar(10)) AS SchedulingTask,   
 PT.ProjTaskOptId,   
 PT.ComponentCodeId, PT.ModifierId, PT.TaskTypeId, PT.ApplicationCodeId,   
 CASE WHEN PT.UsageQUOMId IS NULL   
 THEN 'Days' ELSE QUOM.UOMShortDesc END AS UsageQUOM,    
 PT.LastOcc, PT.LastOccDate,   
 PT.Last_Change_Usage,   
 --VV RR task defaults have Last_Change_Date=NULL  
 ISNULL(PT.Last_Change_Date, EP.StartDate) AS Last_Change_Date,  
 PT.ManufacturerId, PT.Part_Id, PT.Group_Number, PT.Rotable_Part_Id,     
 EPR.Projection_Type_ID, EPR.EqpProjName, EP.EqpPlan, TH.Description AS ProjTaskDesc, CC.SubSystemID, PT.EqpPlanId, EPR.EqpProjId,   
 EQP.ModelId, EP.FleetId, EPR.Projection_Header_ID, PT.Task_Header_Id, EP.Equipment_Type_Id, EPR.Pricing_Date AS ProjPricingDate,   
 MA.Manufacturer, EPR.EndUsage,    
 PT.NextOcc, PT.NextOccDate,   
 PT.Schedule_Type_Id, PT.Scheduling_Group_Id, PT.Scheduling_Group_Counter, SCHT.Schedule_Type, PTSG.Scheduling_Group,   
 PTSG.Scheduling_Group_Type, PTSG.Suppression_Tolerance_Hours,    
 PT.Operational_Criticality_Id,   
 OC.Operational_Criticality, PT.Warranty_Period_Usage, PT.Warranty_Period_Days, PT.Maintenance_Strategy_Id, MS.Maintenance_Strategy,   
 PT.Changeout_Guidelines, PT.Task_Description,   
 P.Part + ' - ' + P.PartDescription AS Part, EPR.EndDate,  PT.PlanUseCalc,   
 --PT.PlanDateLocked, AL: 21/02/08  
 PT.PlanStatus,   
 EP.Utilisation_Method_Id, PT.Last_Mod_Date, EP.StartDate, PTSG.SchedulingGroupSubtypeId, PT.InspectionTaskTypeId,   
 ITT.Code + ' - ' + ITT.Description AS InspectionTaskType, PT.InspectionOffset, PT.PerformanceStrategyReason, PT.RCMComponentStructureId,   
 PT.ParentTaskId, PT.AutomaticUpdate,  
 EPR.EndDate, EPR.EndQUOMId,EPR.EndUsage,PT.Unscheduled,  
 @CurrentUsage AS CurrentUsage,ISNULL(ISNULL(@FinalChangeUsage,PT.LastOcc),PT.[First]) AS FinalChangeUsage,  
 CASE WHEN PT.UsageQUOMId IS NULL   
  THEN dbo.GET_DATE_FROM_USAGE_F(PT.EqpProjId, PT.UsageQUOMID, ISNULL(ISNULL(@FinalChangeUsage,PT.LastOcc),PT.[First]))  
  ELSE NULL  
 END AS FinalChangeDate,  
 100.00*((PT.Frequency-(@EndUsage - ISNULL(ISNULL(@FinalChangeUsage,PT.LastOcc),PT.[First])) )/NULLIF(PT.Frequency,0)) AS RiskLifeLeft,  
 @CurrentUsage-ISNULL(PT.Last_Perf_Occ,ISNULL(PT.Last_Change_Usage,0)) AS LifeUsed,   
 (@CurrentUsage-ISNULL(PT.Last_Perf_Occ,ISNULL(PT.Last_Change_Usage,0)))/NULLIF(PT.Frequency,0)*100 AS LifeUsedPct,  
 @Repair_Description AS Repair_Description,@Next_Occ_Strategy_Id AS Next_Occ_Strategy_Id,PT.Group_Number,  
 RP.Part_Number AS Rotable_Part,RP.Reman_Part_Number,  
 RP.Group_Number AS Rotable_Group_Number,  
 RI.Rotable_Item_Id,RI.Manufacturer_Serial_Number,RIU.Partial_Life_Pct,0 AS TurnsToDate,0 AS LifeToDate,  
 ISNULL(QUOM_1.UOMShortDesc,'') AS EqpQUOM,TH_1.Description AS ParentTask,  
 PT.ExternalIdentifier,  
 RRJ.Action_Required_Id,AR.Description AS Action_Required,  
 RRJ.Rebuild_Location_Id,S.Site AS Rebuild_Location,  
 RRJ.ProjTaskAmtId AS RRJobId,ISNULL(JC.Code+' - '+JC.Description,CA.Job_Code) AS RRJob,  
 PTCost.PartsCost ,PTCost.LabourCost,PTCost.MiscCost,  
 PTCost.Duration,PTCost.LaborHours,CASE WHEN PTCost.CCost_Bearer_Id=1 THEN CB.CostBearer ELSE 'Mixed' END AS CostBearer,  
 @Currency AS PrimCurrency,M.Model + ':' + CC_1.Code + ':' + MC_1.Code + ':' + TT_1.Code + ':' + AC_1.Code + ':' + ISNULL(CS.[Group], '') AS CompStruct,  
 PT.PlanUseCalc AS SysCalc,  
 --PT.PlanDateLocked AS Locked, AL: 29/02/08  
 PT.PlanStatus,EP.Utilisation_Method_Id,  
 Last_Perf_Occ, Last_Sched_Occ, Last_Perf_Date, Last_Sched_Date,  
 CASE WHEN PT.UsageQUOMId>0 THEN NULL ELSE DATEADD(day,PT.[Final],EP.StartDate) END AS FinalDate,  
 CONVERT(varchar(25), PT.Last_Mod_Date, 21) as LastModDate,EP.StartDate AS FirstDate,  
 @Strategy_Reschedule AS Strategy_Reschedule,@Pct_Frequency_Reschedule AS Pct_Frequency_Reschedule,  
 @Use_Distribution_Codes AS Use_Distribution_Codes,  
 --AL: 21/02/08  
 PT.ReviewStatusID,PT.ReviewUserID,PT.ReviewDate,  
 --AL: 29/02/08  
 RS.ReviewStatusDesc as ReviewStatus, AU.AMT_User_Name as ReviewUser,EQPM.Model,  
 PT.LastPerformedWO,  
 --AL: 30/03/09  
 ISNULL(@PartsDemandAnalysis,0) AS PartsDemandAnalysis,  
 PT.PctPurchasePart,PT.PctPurchaseLabour,PT.PctPurchaseMisc,PT.PctPurchaseNewPart,  
 PT.SalesResponsibilityID,E.Surname + ', ' + E.First_Name AS SalesResponsibility,  
 /*VV 28-Apr-2009*/@ExternalDocumentSystem AS ExternalDocumentSystem,  
 /*VV CR8323*/  
 @ExtDocUseClientCredentials AS ExtDocUseClientCredentials,  
 /*VV E602*/
 PT.StartingSerialNoId,  CSER.ComponentSerialNo AS StartingSerialNo,
 PT.CBDTask/*CR9019 VS */,
 /*VV E316*/PT.TagId,PT.PartRatingId,PRA.PartRating,
  PT.AutoGenerateWOS/*GW*/,
  /*VV E611*/N.PEXRebuildLocationId,SNO.Site AS PEXRebuildLocation,
  N.PEXPartId,PNO.Part + ' - ' + PNO.PartDescription AS PEXPart,
  /*E789*/ N.PEXPartTypeId AS NextDuePartClassificationId,PTCLASS.PartClassification AS NextDuePartClassification,
  @RebuildSite AS RebuildSite,
   /*E789*/ 
   PT.PartClassificationId, 
   PCBASEDETAIL.PartClassification AS BaseDetailPartClassification,
   PT.DefaultLocationForRebuild, 
   DEFLOCRBLDSITE.Site AS DefaultLocationForRebuildSiteDesc,
   /*E808*/ PT.AutocreateExternalWorkorders, PT.AutocreatePlannedEvents
FROM    
#z_PTCost PTCost   
 INNER JOIN    
#z_PROJ_TASK_SUMMARY PT   
 ON PTCost.ProjTaskId=PT.ProjTaskId  
 INNER JOIN  
tblComponentCodes CC   
 ON PT.ComponentCodeId = CC.ComponentCodeID   
 INNER JOIN  
tblModifierCodes MC   
 ON PT.ModifierId = MC.ModifierID   
 INNER JOIN  
tblTaskTypes TT   
 ON PT.TaskTypeId = TT.TaskTypeID   
 INNER JOIN  
tblApplicationCodes AC   
 ON PT.ApplicationCodeId = AC.ApplicationCodeID   
 INNER JOIN  
tblEqpProjs EPR   
 ON PT.EqpProjId = EPR.EqpProjId   
 INNER JOIN  
tblEqpPlans EP   
 ON EPR.EqpPlanId = EP.EqpPlanId   
 INNER JOIN  
tblEquipment EQP   
 ON EP.EquipmentId=EQP.EquipmentId   
 INNER JOIN  
tblModels EQPM  
 ON EQP.ModelId=EQPM.ModelId  
 INNER JOIN  
tblManufacturers MA   
 ON PT.ManufacturerId = MA.ManufacturerId   
 INNER JOIN  
TASK_HEADER TH ON PT.Task_Header_Id = TH.Task_Header_Id 
	/*VV E602*/ 
	LEFT JOIN
COMPONENT_SERIALISED CSER
	ON PT.StartingSerialNoId=CSER.ComponentSerialisedId
	/*VV E316*/
	LEFT JOIN
PART_RATING PRA
	ON PT.PartRatingId=PRA.PartRatingId
 LEFT OUTER JOIN  
SCHEDULING_TASK ST   
 ON PT.SchedulingTaskId = ST.SchedulingTaskId   
 LEFT OUTER JOIN  
tblTaskTypes ITT   
 ON PT.InspectionTaskTypeId = ITT.TaskTypeID   
 LEFT OUTER JOIN  
tblQUOMs QUOM  
 ON PT.UsageQUOMId = QUOM.QUOMId   
 LEFT OUTER JOIN  
tblQUOMs QUOM_1  
 ON EPR.EndQUOMId = QUOM_1.QUOMId   
 LEFT OUTER JOIN  
PROJ_TASK_SCHEDULING_GROUP PTSG   
 ON PT.Scheduling_Group_Id = PTSG.Scheduling_Group_Id   
 LEFT OUTER JOIN  
OPERATIONAL_CRITICALITY OC   
 ON PT.Operational_Criticality_Id = OC.Operational_Criticality_Id   
 LEFT OUTER JOIN  
SCHEDULE_TYPE SCHT ON PT.Schedule_Type_Id = SCHT.Schedule_Type_Id   
 LEFT OUTER JOIN  
MAINTENANCE_STRATEGY MS   
 ON PT.Maintenance_Strategy_Id = MS.Maintenance_Strategy_Id  
 LEFT OUTER JOIN  
tblParts P ON PT.Part_Id = P.PartId   
 LEFT OUTER JOIN  
tblProjTasks RRPT  
 ON PT.ParentTaskId=RRPT.ProjTaskId  
 LEFT OUTER JOIN  
TASK_HEADER TH_1  
 ON RRPT.Task_Header_Id=TH_1.Task_Header_Id  
 LEFT OUTER JOIN  
ROTABLE_PART RP  
 ON PT.Rotable_Part_Id=RP.Rotable_Part_Id  
 LEFT OUTER JOIN  
/*VV 29-Jan-2009 ROTABLE_INUSE RIU*/  
(  
 ROTABLE_INUSE riu  
 INNER JOIN   
 ROTABLE_ITEM_LATEST_STATUS_V riul   
 ON riul.Rotable_Item_Id = riu.Rotable_Item_Id AND   
 riul.StartDate = riu.Start_Date  
)   
 ON PT.ProjTaskId=RIU.Proj_Task_Id  
 LEFT OUTER JOIN  
ROTABLE_ITEM RI  
 ON PT.Rotable_Part_Id=RI.Rotable_Part_Id AND RIU.Rotable_Item_Id=RI.Rotable_Item_Id  
 LEFT OUTER JOIN  
(SELECT ProjTaskOptId,ProjTaskAmtId,JobCodeId,Action_Required_Id,Rebuild_Location_Id FROM #z_PTA  
WHERE Rotable_Repair_Strategy=1) RRJ  
 ON PT.ProjTaskOptId=RRJ.ProjTaskOptId  
 LEFT OUTER JOIN  
tblSites S  
 ON RRJ.Rebuild_Location_Id=S.SiteId  
 LEFT OUTER JOIN  
ACTION_REQUIRED AR  
 ON RRJ.Action_Required_Id=AR.Action_Required_Id  
 LEFT OUTER JOIN  
tblJobCodes JC  
 ON RRJ.JobCodeId=JC.JobCodeId  
 LEFT OUTER JOIN  
#z_COST_ALLOCATIONS CA  
 ON RRJ.ProjTaskAmtId=CA.Proj_Task_Amt_Id  
 LEFT OUTER JOIN  
RCM_COMPONENT_STRUCTURE CS  
 ON PT.RCMComponentStructureId=CS.RCMComponentStructureId  
 LEFT OUTER JOIN  
tblModels M   
 ON CS.ModelId=M.ModelId  
 LEFT OUTER JOIN  
tblComponentCodes CC_1  
 ON CS.ComponentCodeId=CC_1.ComponentCodeId  
 LEFT OUTER JOIN  
tblModifierCodes MC_1  
 ON CS.ModifierCodeId=MC_1.ModifierId  
 LEFT OUTER JOIN  
tblTaskTypes TT_1  
 ON CS.TaskTypeId=TT_1.TaskTypeId  
 LEFT OUTER JOIN  
tblApplicationCodes AC_1  
 ON CS.ApplicationCodeId=AC_1.ApplicationCodeId  
 LEFT OUTER JOIN  
tblCostBearers CB   
 ON CB.CostBearerId=PTCost.Cost_Bearer_Id     
--AL: 29/02/08  
 LEFT OUTER JOIN  
REVIEW_STATUS RS   
 ON PT.ReviewStatusID = RS.ReviewStatusID   
 LEFT OUTER JOIN  
AMT_USER AU   
 ON PT.ReviewUserID = AU.AMT_User_ID  
 LEFT OUTER JOIN  
EMPLOYEE E   
 ON E.Employee_ID=PT.SalesResponsibilityID  
	/*VV E611*/  
	LEFT JOIN 
NEXT_OCC_STRATEGY N 
	ON PT.ProjTaskId=N.Proj_Task_Id
	LEFT JOIN
tblSites SNO
	ON N.PEXRebuildLocationId=SNO.SiteId
	LEFT JOIN
tblParts PNO
	ON N.PEXPartId=PNO.PartId
	LEFT JOIN
PART_CLASSIFICATION PTCLASS
	ON N.PEXPartTypeId=PTCLASS.PartClassificationId
	/*E789*/
	LEFT JOIN PART_CLASSIFICATION PCBASEDETAIL ON PCBASEDETAIL.PartClassificationId = PT.PartClassificationId
	LEFT JOIN tblSites DEFLOCRBLDSITE ON DEFLOCRBLDSITE.SiteId = PT.DefaultLocationForRebuild
 
SELECT   
ROUND(PTA.LaborHours,1) AS LaborHours, ROUND(PTA.Duration,1) AS Duration, PTA.Pricing_Date,   
ROUND(PTA.MiscCost,2) AS MiscCost,   
ROUND(PTA.PartsCost,2) AS PartsCost, ROUND(PTA.LaborCost,2) AS LaborCost, PTA.ProjTaskOptId, PTA.ProjTaskAmtId,   
ISNULL(PTA.JobCodeId,CA.Job_Code_Id) AS JobCodeId,  
ISNULL(PTA.Cost_Bearer_Id, CA.Cost_Bearer_Id) AS CostBearerId,  
ISNULL(PTA.Labour_Activity_Id,CA.Labour_Activity_Id) AS LabourActivityId,PTA.PricedJobId,   
ISNULL(PTA.Misc_Cost_Expense_ID,CA.Misc_Cost_Expense_Id) AS Misc_Cost_Expense_Id,  
ISNULL(PTA.Labour_Cost_Expense_ID, CA.Labour_Cost_Expense_Id) AS Labour_Cost_Expense_Id,  
ISNULL(PTA.Parts_Cost_Expense_ID,CA.Parts_Cost_Expense_Id) AS Parts_Cost_Expense_Id,  
PTA.LaborShare, PTA.CurrencyId,     
PTA.Crane_Cost, PTA.Pct_Freight, PTA.Avg_Daily_Work_Hrs, PTA.Avg_No_People, PTA.Avg_Travel_Hrs, PTA.Travel_Distance,   
PTA.Travel_Recovery_Rate_L, PTA.Misc_Trip_Cost, PTA.Labour_Hrs_Field,   
PTA.Travel_Recovery_Rate_V,   
PTA.Parts_EDC_ID, PTA.Labour_EDC_ID, PTA.Misc_EDC_ID,  
ISNULL(PTA.Cost_Centre_ID, CA.Cost_Centre_Id) AS CostCentreID,  
ISNULL(PTA.Work_Group_Id,CA.Work_Group_Id) AS Work_Group_Id,    
PTA.Health_Safety_Id,   
PTA.PerformedAtSiteId, PTA.Rotable_Repair_Strategy,   
PTA.Action_Required_Id, PTA.Rebuild_Location_Id,    
CA.Cost_Allocation_Id,   
  
CA.Cost_Allocation_Ref+':'+ACC.Code+':'+AMC.Code AS Cost_Allocation_Des,  
   
ISNULL(CA.Cost_Allocation_Id,0) AS Cost_Allocation_Ref,  
PTA.PartTypeId,PT.PartType + ' - ' + PT.PartTypeDesc AS Part_Type,  
ISNULL(JC.Code+' - '+JC.Description,CA.Job_Code) AS Job_Code,  
ISNULL(CB.CostBearer,CA.CostBearer) AS CostBearer,  
ISNULL(LA.ActivityCode+' - '+LA.LabourActivity,CA.LabourActivity) AS Labour_Activity,  
ISNULL(CEP.Cost_Expense_Code+' - '+CEP.Cost_Expense_Desc,CA.P_Cost_Expense ) AS Parts_Cost_Expense,  
ISNULL(CEL.Cost_Expense_Code+' - '+CEL.Cost_Expense_Desc, CA.L_Cost_Expense) AS Labour_Cost_Expense,  
ISNULL(CEM.Cost_Expense_Code+' - '+CEM.Cost_Expense_Desc, CA.M_Cost_Expense) AS Misc_Cost_Expense,  
C.CurrencyDesc AS Currency,ISNULL(CC.Cost_Centre_Code+' - '+CC.Cost_Centre_Desc,CA.Cost_Centre) AS CostCentre,  
ISNULL(WG.Description,CA.Work_Group) AS WorkGroup,HS.Health_Safety,  
EDCP.EDC_Id + ' - ' + EDCP.Journal_Description + ' : ' + EDCP.Debit_Account + '.' + EDCP.Debit_Account_Suffix AS Parts_EDC_Description,   
EDCL.EDC_Id + ' - ' + EDCL.Journal_Description + ' : ' + EDCL.Debit_Account + '.' + EDCL.Debit_Account_Suffix AS Labour_EDC_Description,   
EDCM.EDC_Id + ' - ' + EDCM.Journal_Description + ' : ' + EDCM.Debit_Account + '.' + EDCM.Debit_Account_Suffix AS Misc_EDC_Description,  
ROUND(PTA.QtyVolume,2) AS QtyVolume, ROUND(PTA.PercentTopUp,1) AS PercentTopUp, ROUND(PTA.UnitPrice,2) AS UnitPrice,  
PTA.Consumable,  
CASE WHEN ISNULL(PTA.JobCodeId,CASE WHEN CA.Job_Code<>'CA - Multiple' THEN ABS(CA.Job_Code_Id) ELSE -1 END)  
 IN(  
 SELECT WSJ.Job_Code_Id  
 FROM  
 WORK_SCOPE_JOB WSJ  
  INNER JOIN  
 #z_PROJ_TASK_SUMMARY PT   
  ON WSJ.Component_Code_Id=PT.ComponentCodeId AND WSJ.Task_Type_Id=PT.TaskTypeId   
  /*INNER JOIN  
 #z_PTA PTA  
  ON PT.ProjTaskOptId=PTA.ProjTaskOptId  
  LEFT OUTER JOIN  
 #z_COST_ALLOCATIONS CA  
  ON PTA.ProjTaskAmtId=CA.Proj_Task_Amt_Id*/  
 WHERE WSJ.Model_Id=@ModelId)  
THEN 1 ELSE 0 END AS LibraryLink,  
PTA.CostSourceId,CS.CostSource,C.Currency AS CurrencyCode,SJ.StdJob,  
PTA.System_Source_Id,  
'CA - '+ CASE PTA.System_Source_Id WHEN @SystemSourceAMT THEN 'Manual' ELSE SS.System_Source_Code END AS System_Source,  
CASE PTA.System_Source_Id WHEN @SystemSourceAMT THEN 1 ELSE 0 END AS CAManual  
  
FROM   
#z_PTA PTA  
 INNER JOIN   
tblCurrencies C  
 ON PTA.CurrencyId=C.CurrencyId   
 INNER JOIN  
dbo.COST_SOURCE_F() CS  
 ON PTA.CostSourceId=CS.CostSourceId  
 LEFT OUTER JOIN  
#z_COST_ALLOCATIONS CA  
 ON PTA.ProjTaskAmtId=CA.Proj_Task_Amt_Id  
 LEFT OUTER JOIN  
COST_ALLOCATION A  
 ON CA.Cost_Allocation_Id=A.Cost_Allocation_Id  
 LEFT OUTER JOIN  
tblComponentCodes ACC  
 ON A.Component_Code_Id=ACC.ComponentCodeId  
 LEFT OUTER JOIN  
tblModifierCodes AMC   
 ON A.ModifierId=AMC.ModifierId  
 LEFT OUTER JOIN  
tblPricedJobs PJ  
 ON PTA.PricedJobId=PJ.PricedJobId  
 LEFT OUTER JOIN  
tblStdJobs SJ  
 ON PJ.StdJobId=SJ.StdJobId  
 LEFT OUTER JOIN  
tblPartTypes PT  
 ON PTA.PartTypeId=PT.PartTypeId  
 LEFT OUTER JOIN   
tblJobCodes JC  
 ON JC.JobCodeId=PTA.JobCodeId  
 LEFT OUTER JOIN   
tblCostBearers CB  
 ON PTA.Cost_Bearer_Id=CB.CostBearerid  
 LEFT OUTER JOIN  
tblLabourActivities LA  
 ON PTA.Labour_Activity_Id=LA.LabourActivityId  
 LEFT OUTER JOIN  
COST_EXPENSE CEP  
 ON PTA.Parts_Cost_Expense_ID=CEP.Cost_Expense_Id  
 LEFT OUTER JOIN  
COST_EXPENSE CEL  
 ON PTA.Labour_Cost_Expense_ID=CEL.Cost_Expense_Id  
 LEFT OUTER JOIN  
COST_EXPENSE CEM  
 ON PTA.Misc_Cost_Expense_ID=CEM.Cost_Expense_Id  
 LEFT OUTER JOIN  
COST_CENTRE CC  
 ON PTA.Cost_Centre_Id=CC.Cost_Centre_Id  
 LEFT OUTER JOIN  
WORK_GROUP WG  
 ON PTA.Work_Group_Id=WG.Work_Group_Id  
 LEFT OUTER JOIN  
HEALTH_SAFETY HS  
 ON PTA.Health_Safety_Id=HS.Health_Safety_Id  
 LEFT OUTER JOIN  
ENTRY_DISTRIBUTION_CODE EDCM   
 ON PTA.Misc_EDC_ID = EDCM.Id   
 LEFT OUTER JOIN  
ENTRY_DISTRIBUTION_CODE EDCL   
 ON PTA.Labour_EDC_ID = EDCL.Id   
 LEFT OUTER JOIN  
ENTRY_DISTRIBUTION_CODE EDCP   
 ON PTA.Parts_EDC_ID = EDCP.Id  
 LEFT OUTER JOIN  
SYSTEM_SOURCE SS  
 ON PTA.System_Source_Id=SS.System_Source_Id  
ORDER BY C.Currency,ISNULL(JC.Code+' - '+JC.Description,CA.Job_Code)  
   
   
SELECT CostAllocationConfigurationId, WorkGroup, CostCentre, PartsCostExpense, LabourCostExpense, MiscCostExpense,   
CostBearer, LabourActivity, JobCode  
FROM COST_ALLOCATION_CONFIGURATION  
  
--VV 28-Apr-2009  
EXEC PROJ_TASK_DOCUMENTS_GET_P @ProjTaskId=@projTaskId  
  
DROP TABLE #z_COST_ALLOCATIONS,#z_PTA,#z_PROJ_TASK_SUMMARY,#z_PTCost  
    
 
--DS 2011-02-15
EXEC EWT_STRATEGY_TASK_LIST_GET_P @ProjTaskId = @projTaskId
      
  
GO




if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[EXPRESS_ADD_BACKLOGS_TO_EVENT_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[EXPRESS_ADD_BACKLOGS_TO_EVENT_P]
GO

create       PROCEDURE [dbo].[EXPRESS_ADD_BACKLOGS_TO_EVENT_P]     
/******************************************************************************    
     
    
 Called By: EQSCP.TaskPut    
    
 Desc: 1. Adds the selected backlog to an Event    
  Backlog tasks available have Event_ID=Null,              
          Task_Status_ID=Outstanding,    
       Amt Planning Mode=advanced planning    
    
  28-Jan-2003 VV Discussed with Robbie:    
    
  If Event_Status is abandoned or deferred - do not add    
  tasks to the event. Give the user a message    
    
  If Event status is YTS - add tasks with status YTS    
  If Event status is in progress - add taskS with status in progress    
  If Event status is completed - add tasks with status completed                 
    
 Auth: Veronika Vasylyeva    
 Date: 8-Dec-2003    
*******************************************************************************    
  Change History    
*******************************************************************************    
 Date:  Author:  Description:    
 -------- -------- ----------------------------------------    
 03 Apr 2012 TW			 E769 overwrite dummy wo
 25 Jun 2010 V Srinivas  CR 8990: Modified BackLogs to be varchar(max)    
 24 Jun 2010 V Vasylyeva CR8985: Added sort order    
 12 Dec 2007 V Vasylyeva Added Task workorder link    
 12 Jun 2007 V Vasylyeva Added TASK_STATUS_FOR_EVENT_P     
 07 Jun 2007 V Vasylyeva Changes for new planning. backlogs shall be    
       in advanced planning mode    
  28-Jan-2003 V Vasylyeva Added update Last_Mod_Date in Event table,    
     check for Event_Status, error_number, message    
*******************************************************************************/    
 /* Param List */    
 @Backlogs varchar(max),    
 @Event_ID int,    
 @Error_Number int = 0 OUTPUT,    
 @Message varchar(2000)=Null OUTPUT, 
 /*E769*/   
 @ReplacePrimaryTask bit = 0     
AS    
    
DECLARE @PlanModeAdv int    
    
DECLARE @ERR_SAVE int    
DECLARE @Task_Status_ID int    
DECLARE @TaskStatusOUS int    
DECLARE @tasks varchar(8000)    
    
SET @TaskStatusOUS=1    
SET @ERR_SAVE=12 -- Comes from EQS32.modConstants    
SET @PlanModeAdv=1    
    
SET @Error_Number=ISNULL(@Error_Number,0)    
    
--12 Jun 2007 VV moved the code into TASK_STATUS_FOR_EVENT_P    
EXEC TASK_STATUS_FOR_EVENT_P     
   @EventID=@Event_ID,    
   @ErrorNumber=@Error_Number OUTPUT,    
   @Message=@Message OUTPUT,    
   @TaskStatusId =@Task_Status_ID OUTPUT    
    
IF ISNULL(@Message,'')<>'' RETURN    
    
/*VV CR8985*/    
    
DECLARE @maxSort int    
    
SELECT @maxSort=MAX(Sort_Order)    
FROM TASK WHERE Event_ID=@Event_ID    
    
SET @maxSort=ISNULL(@maxSort,0)    
    
UPDATE T SET    
T.Event_ID=@Event_ID,    
T.Task_Status_ID=@Task_Status_ID,    
T.Last_Mod_Date=GETDATE(),    
/*VV CR8985*/    
T.Sort_Order=L.Id+@maxSort    
FROM     
dbo.LIST_TO_TABLE_AND_ID_F(@Backlogs) L    
 INNER JOIN    
TASK T    
 ON L.list_item=T.Task_Id    
 LEFT OUTER JOIN    
DEFERRED_TASK DT    
 ON T.Task_ID=DT.Task_ID AND @Event_ID=DT.Event_ID    
WHERE     
(T.Event_ID IS NULL) AND     
(T.AmtPlanningModeId=@PlanModeAdv) AND    
(T.Task_Status_ID =  @TaskStatusOUS) AND    
(DT.Task_Id IS NULL)    
    
   
/* E769 Begin */  
IF @ReplacePrimaryTask = 1
BEGIN
	  
	DECLARE @TaskId int  
	DECLARE Backlog_Cur CURSOR FOR  
	SELECT list_item FROM  
	dbo.LIST_TO_TABLE_AND_ID_F(@Backlogs)  
	  
	OPEN Backlog_Cur  
	FETCH NEXT FROM Backlog_Cur INTO @TaskId  
	  
	WHILE  @@FETCH_STATUS = 0  
	BEGIN   
	 EXEC PRIMARY_TASK_REPLACE_P @Event_ID, @TaskId, @Message = @Message OUTPUT    
	 FETCH NEXT FROM Backlog_Cur INTO @TaskId  
	END  
  
END

/* E769 End */  
  
SET @tasks = ''    
    
SELECT @tasks = @tasks + CAST(T.Task_ID AS varchar) + ','    
FROM     
dbo.LIST_TO_TABLE_F(@Backlogs) L    
 INNER JOIN    
TASK T    
 ON L.list_item=T.Task_Id    
WHERE     
(T.Event_ID=@Event_ID) AND /*T.Event_ID=@Event_ID takes care of the deferred tasks*/    
(T.Work_Order_Id>0)     
    
IF @tasks<>''    
BEGIN    
 SET @tasks=LEFT(@tasks,LEN(@tasks)-1)    
 EXEC TASK_WORK_ORDER_LINK_MULTI_P @TasksID=@tasks    
END      

GO



if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[STRATEGY_TASK_ADD_TO_EVENT_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[STRATEGY_TASK_ADD_TO_EVENT_P]
GO


create  Procedure [dbo].[STRATEGY_TASK_ADD_TO_EVENT_P]    
/******************************************************************************    
 File:     
 Name: STRATEGY_TASK_ADD_TO_EVENT_P    
    
 Called By: EQS    
    
 Desc: refer to DESIGN_EQS_3.doc, 1.1.2.2. Strategy Task Wizard Logic (diagramm)    
            
 ******************************************************************    
     
     
    
 Auth: Veronika Vasylyeva    
 Date: 4-Nov-2002    
*******************************************************************************    
  Change History    
*******************************************************************************    
 Date:  Author:  Description:    
 -------- -------- ----------------------------------------    
 03 Apr 12 TW		E769 pass parameter to decide primary task get replaced or not (it could be dummay one)
 14 Feb 11 V Vasylyeva AmtMobile    
 09 Dec 09 AL   CR8556: FMG Change - can have multiple strategy tasks at the same time    
 13 Oct 09 V Vasylyeva CR8304: Planning changes    
 10 Jun 07 V Vasylyeva Changes for new planning module    
 24 Jan 07 V Vasylyeva Added performed by date    
 15 May 05 V Vasylyeva Left outer join to next_occ_strategy    
 27 Oct 05 V Vasylyeva Repair code changes:     
     If a proj task opt has 1 job then repair code=proj job. job code    
     If a proj task opt has more than 1 job then repair code= default repair code    
     Use TASK_GET_DEFAULTS_P instead of STRATEGY_EQS_TASK_DEFAULTS_P    
     for the consistensy with strategy_task_creating_maintaining_p    
 13 Oct 2005 V Vasylyeva Cost Bearer    
 13 Apr 2004 V Vasylyeva Removed Task_Planned    
 09 Feb 04 V Vasylyeva New task defaults    
     @Parts_Resources_Identified,    
     @Labour_Resources_Identified,    
     @Location_Identified,    
     @Tooling_Resources_Identified    
 27 Nov 03 V Vasylyeva Fixed Bug in Task Insert    
 16 Sep 03 H Singh  new field added in update and insert statements - Strategy_Repair_Description    
 18-Feb-2003 V Vasylyeva When a strategy task is created in Backlog    
     Repair_Code is Job Code from PROJ_TASK_AMTS_SUM_GROUP_BY_PROJ_TASK_OPT_ID_V    
     19-Nov-2002 V Vasylyeva Return all backlogs for the selected    
     EqpPlan if @Task_ID_Exclude is not null    
     Return just selected Strategy task    
     if @Task_ID_Exclude is null.    
*******************************************************************************/    
 /* Param List */    
    
    
     @ProjTaskOptId int,-- tblProjTaskOpts.ProjTaskOptId     
     @AddEventId int=0, -- <=0  the strategy task is to be added to a new event;     
         -- >0 - the strategy task is to be added to an existing event        
  @Event_ID int =NULL OUTPUT,--event id assigned to a strategy task    
     @Task_ID int =NULL OUTPUT, --task_id assigned to an event which need to be updated    
         --with new strategy details    
  @EqpPlanID int,    
  @UserId int=0,    
  @Message varchar(8000) OUTPUT,    
  /*AmtMobile*/    
  @CopyEWTemplateFiles bit=0 OUTPUT ,
  /*E769*/
  @ReplacePrimaryTask bit = 0   
    
AS    
    
    
DECLARE @TaskStatusOUS int    
DECLARE @TaskStatusYTS int    
DECLARE @TaskStatusIP int    
    
DECLARE @EventStatusYTS int    
    
DECLARE @Event_Status_ID int    
DECLARE @Tasks varchar(20)    
DECLARE @ProjTaskOptIdOld int    
DECLARE @ProjTaskId int    
DECLARE @TaskHeader varchar(1000)    
    
SET NOCOUNT ON    
--Set values from the system tables    
SET @TaskStatusOUS=1    
SET @TaskStatusYTS=6    
SET @TaskStatusIP=2    
    
SET @EventStatusYTS=1    
SET @Message=''    
    
SET XACT_ABORT ON    
    
IF ISNULL(@AddEventId,0)<=0 SET @AddEventId=NULL    
    
--Check if the task for the selected @ProjTaskOptId exists as a part of EQS event    
SELECT     
@Task_ID=T.Task_ID,@Event_ID=T.Event_ID, @Event_Status_ID=E.Event_Status_ID,    
@ProjTaskOptIdOld=T.Strategy_Proj_Task_Opt_ID, @ProjTaskId=PT.ProjTaskId,    
@TaskHeader=TH.Description    
FROM    
tblProjTasks PT    
 INNER JOIN    
tblProjTaskOpts PTO    
 ON PT.ProjTaskId=PTO.ProjTaskId    
 INNER JOIN    
TASK T    
 ON PTO.ProjTaskOptId=T.Strategy_Proj_Task_Opt_ID    
 LEFT JOIN    
TASK_HEADER TH    
 ON PT.Task_Header_Id=TH.Task_Header_Id    
 LEFT OUTER JOIN     
EVENT E    
ON T.Event_ID = E.Event_ID    
WHERE     
(PTO.ProjTaskOptId=@ProjTaskOptId) AND     
(T.Task_Status_Id IN(@TaskStatusOUS,@TaskStatusYTS,@TaskStatusIP))    
    
    
--AL: 09/12/09    
DECLARE @MaxPlanningWOtoCreate int  SELECT @MaxPlanningWOtoCreate=ISNULL(Varchar_Value,1) FROM AMT_TYPED_VARIABLE WHERE Value_Name ='MaxPlanningWOtoCreate'    
    
IF ISNULL(@MaxPlanningWOtoCreate,1) = 1    
BEGIN    
 SET @Event_ID=ISNULL(@Event_ID,0)    
 SET @Task_ID=ISNULL(@Task_ID,0)    
END    
ELSE    
BEGIN    
 SET @Event_ID=0    
 SET @Task_ID=0    
END    
    
    
IF @Event_ID>0    
--The strategy task with option @ProjTaskOptId was assigned to an event    
BEGIN    
 IF @AddEventId>0         
 BEGIN    
  -- the task cannot be added to an event,     
  -- it has already been assigned to the other event     
  SET @Event_ID=0    
  SET @Task_ID=0    
  SET @Message = 'Strategy Task '+@TaskHeader+' has already been assigned to an Event.    
 You will need to either Defer or Complete the task in the Event in which it is already assigned.'    
  RETURN    
 END        
 ELSE    
 --the user is adding a strategy task to a new event    
 BEGIN    
  SET @Task_ID=0    
  SET @Message = 'Strategy Task '+@TaskHeader+' already exists in Event.'    
  RETURN    
 END    
END    
    
--Event_ID is null. Check that strategy task was created in Backlog    
    
IF @Task_ID=0    
--The strategy task was not created in the Backlog    
--Create Task for Event    
BEGIN    
     
 EXEC TASK_DEFAULT_ADD_GET_P    
   @Eqp_Plan_ID =@EqpPlanID,    
   @EventId=@AddEventId,     
   @Proj_Task_Opt_Id =@ProjTaskOptId,    
   @Std_Job_Id =NULL,    
   @PricedJobId =NULL,    
   @TaskDefaults =1,     
   @Add =1,    
   @UserId =@UserId,    
   @TaskId =@Task_ID OUTPUT,    
   @CopyEWTemplateFiles=@CopyEWTemplateFiles OUTPUT    
    
   SET @Tasks=CAST(@Task_Id AS varchar)    
    
       
END    
ELSE    
 -- The strategy task exists in Backlog.     
 -- Update the task with with the selected option details    
 -- (VV 12-Jun-2007 changes for new planning) update task with event_id if it is null    
 -- to add the task to event    
BEGIN    
    
 SET @Tasks=CAST(@Task_Id AS varchar)    
    
 --Update the backlog task    
 --with the selected option details    
 IF @ProjTaskOptIdOld<>@ProjTaskOptId    
 BEGIN    
  --This will update the strategy details and link to event    
  EXEC TASK_UPDATE_STRAT_DET_P    
    @ProjTaskId =@ProjTaskId,    
    @ProjTaskOptId =@ProjTaskOptId,    
    @EventId=@AddEventId,     
    @TaskID =@Task_ID,    
    @EqpPlanID =@EqpPlanID,    
    @UserId =@UserId,    
    @Message=@Message OUTPUT    
    
   IF ISNULL(@Message,'')<>''     
   BEGIN    
    SET @Task_ID=0    
    RETURN    
   END
   /*E769*/
    EXEC EXPRESS_ADD_BACKLOGS_TO_EVENT_P     
    @Backlogs=@Tasks,    
    @Event_ID =@AddEventId,    
    @Error_Number=0,    
    @Message =@Message OUTPUT,
    @ReplacePrimaryTask = @ReplacePrimaryTask  
        
 END    
 ELSE IF @AddEventId>0    
 --proj task opt did not change. Check if the    
 --task need to be added to event    
 BEGIN    
  EXEC EXPRESS_ADD_BACKLOGS_TO_EVENT_P     
    @Backlogs=@Tasks,    
    @Event_ID =@AddEventId,    
    @Error_Number=0,    
    @Message =@Message OUTPUT,/*E769*/
    @ReplacePrimaryTask = @ReplacePrimaryTask    
    
  IF ISNULL(@Message,'')<>''     
  BEGIN    
   SET @Task_ID=0    
   RETURN    
  END    
 END    
     
END    
    
/*    
--Return data for tasks grid in Event form    
IF @AddEventId>0    
BEGIN    
 EXEC EVENT_TASKS_GET_P @EventId =@AddEventId, @Tasks=@Tasks     
END    
ELSE    
BEGIN    
 EXEC BACKLOGS_SELECTED_GET_P @Backlogs=@Tasks    
END    
*/ 



GO



IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TASK_DEFAULT_ADD_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[TASK_DEFAULT_ADD_P]
GO

create   Procedure [dbo].[TASK_DEFAULT_ADD_P]    
/******************************************************************************    
 File:     
 Name: [TASK_DEFAULT_ADD_P]    
    
 Called By:     
    
 Desc: Get Task defaults, Task Operation defaults, Task Operation parts, labour, misc,    
       purchase orders,    
    Add tasks with the default values.    
           
    
 Auth: Veronika Vasylyeva    
*******************************************************************************    
  Change History    
*******************************************************************************    
 Date:  Author:  Description:    
 -------- -------- ----------------------------------------    
 30 Mar 12 TW E769 override dummy wo  
 15 Feb 11 VV   AmtMobile    
    23 Mar 09 AL   CR7932: passing @Message to TASK_DEFAULT_ADD_GET_P    
*******************************************************************************/    
 /* Param List */    
@EqpPlanID int=0,    
@EventId int=0,     
@ProjTaskOptId varchar(8000)='',    
@PricedJobId varchar(8000)='',    
@UserId int=0,    
@CheckIfExists bit=0,    
@Message varchar(8000)='' OUTPUT,    
@Tasks varchar(8000)='' OUTPUT,    
/*VV AmtMobile*/    
@CopyEWTemplateFiles bit=0 OUTPUT ,
/*E769*/
@ReplacePrimaryTask bit=0   
    
AS    
DECLARE @Id int    
DECLARE @TaskId int    
DECLARE @StdJob bit    
DECLARE @ValuesList varchar(8000)    
    
SET @Tasks=''    
    
WHILE LEN(@PricedJobId)>0 OR LEN(@ProjTaskOptId)>0    
BEGIN    
 IF LEN(@PricedJobId)>0     
 BEGIN    
  SET @ValuesList=@PricedJobId    
  SET @PricedJobId=''    
  SET @StdJob=1    
 END    
 ELSE IF LEN(@ProjTaskOptId)>0    
 BEGIN    
  SET @ValuesList=@ProjTaskOptId    
  SET @ProjTaskOptId=''    
  SET @StdJob=0    
 END    
 ELSE    
 BEGIN    
  SET @ValuesList=''    
  SET @StdJob=NULL    
 END    
    
 WHILE LEN(@ValuesList)>0    
 BEGIN    
  SET @ValuesList=RTRIM(LTRIM(@ValuesList))    
    
  --select @Id as id, @ValuesList as ValuesList,LEN(@ValuesList) as lenval    
    
  SET @Id=dbo.COMA_SEP_STR_TO_INT_F(@ValuesList)    
    
  IF ISNUMERIC(@Id)=1    
  BEGIN    
   SET @TaskId=0    
   IF @StdJob=1    
   BEGIN    
    EXEC TASK_DEFAULT_ADD_GET_P @Eqp_Plan_ID=@EqpPlanID,    
           @EventId=@EventId,     
           @Proj_Task_Opt_Id=NULL,    
           @Std_Job_Id=NULL,    
           @PricedJobId=@Id,    
           @TaskDefaults =1,     
           @Add=1,    
           @UserId=@UserId,    
           @TaskId=@TaskId OUTPUT,    
           --AL: 23/03/09    
           @Message=@Message OUTPUT,    
           /*VV AmtMobile*/    
           @CopyEWTemplateFiles=@CopyEWTemplateFiles OUTPUT    
   END    
   ELSE IF @StdJob=0    
   BEGIN    
    EXEC TASK_DEFAULT_ADD_GET_P @Eqp_Plan_ID=@EqpPlanID,    
           @EventId=@EventId,     
           @Proj_Task_Opt_Id=@Id,    
           @Std_Job_Id=NULL,    
           @PricedJobId=NULL,    
           @TaskDefaults =1,     
           @Add=1,    
           @UserId=@UserId,    
           @TaskId=@TaskId OUTPUT,    
           --AL: 23/03/09    
           @Message=@Message OUTPUT,    
           /*VV AmtMobile*/    
           @CopyEWTemplateFiles=@CopyEWTemplateFiles OUTPUT    
   END    
    
   IF @TaskId>0    
    SET @Tasks=@Tasks+CAST(@TaskId AS varchar)+','    
  END    
  --E769
  IF  @ReplacePrimaryTask =1  
	EXEC PRIMARY_TASK_REPLACE_P @EventID, @TaskId, @Message=@message output  
    
  IF LEN(CAST(@Id AS varchar))>0    
  BEGIN    
   SET @ValuesList=RIGHT(@ValuesList,LEN(@ValuesList)- LEN(CAST(@Id AS varchar)))    
    
   SET @ValuesList=RTRIM(LTRIM(@ValuesList))    
    
   IF LEFT(@ValuesList,1)=','     
    SET @ValuesList=RIGHT(@ValuesList,LEN(@ValuesList)-1)    
  END    
  ELSE    
  BEGIN    
   SET @ValuesList=''    
    
   IF @StdJob=1 SET @PricedJobId=''    
   ELSE IF @StdJob=0 SET @ProjTaskOptId=''    
   ELSE    
   BEGIN    
    SET @PricedJobId=''    
    SET @ProjTaskOptId=''    
   END    
  END    
 END    
END --WHILE LEN(@ValuesList)>0 OR LEN(@ProjTaskOptId)>0    
    
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[DOWNTIME_IMPORT_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[DOWNTIME_IMPORT_P]
GO


create PROCEDURE [dbo].[DOWNTIME_IMPORT_P]
/******************************************************************************
	
	Name: DOWNTIME_IMPORT_P

	Called By: 

	Desc: 

	Auth: 	Koushik.Nagarajan
	Date: 	01-Apr-2009
*******************************************************************************
		Change History
*******************************************************************************
Date:		Author:		Description:
--------	--------	----------------------------------------
07 May 2012 JW			E804 Set CC and TT to use default collation
01 May 2012	JW			E804 Added ComponentCode and TaskType to MODULAR_EVENT
15 Feb 2010	V Vasylyeva	CR8769	Changed Up_Time from datetime to varchar 
 9-Feb-2010	V Vasylyeva	CR8769 Reject downtime records which downtime is null or
							   downtime is greater then up time
 2-Dec-2009	V Vasylyeva	CR8544 'Code' and 'Code Description' do not appear to be populating correctly.
29-Oct-2009	V Vasylyeva	CR8429 new field Plan_Type
*******************************************************************************/
	/* Param List */

	@xmlDocument XML = '<EQS_EVTs></EQS_EVTs>',
	@ImportBatchName varchar(1000) = '',
	@UserName VARCHAR(50) = '',
	@UserId int=0 	,
	@nRecInserted int = 0 OUTPUT,
	@nRecUpdated int = 0 OUTPUT,
	@nRecRejected int = 0 OUTPUT
AS

DECLARE @docHandle  int
DECLARE @CurrDate datetime
DECLARE @TotalNumberofRecords INT
DECLARE @Message varchar(max)
 
SET @CurrDate=GETDATE()

EXEC sp_xml_preparedocument @docHandle OUTPUT, @xmlDocument

CREATE TABLE #I_DOWNTIME_EVENT
(
	Event_Id VARCHAR(MAX) COLLATE DATABASE_DEFAULT NOT NULL,
	New_Event BIT NULL,
	Down_Time varchar(100) COLLATE DATABASE_DEFAULT,
	Up_Time varchar(100) COLLATE DATABASE_DEFAULT ,
	Code VARCHAR(10) COLLATE DATABASE_DEFAULT  NULL,
	Code_Desc VARCHAR(255) COLLATE DATABASE_DEFAULT  NULL,/*VV CR8544*/
	Description VARCHAR(255) COLLATE DATABASE_DEFAULT  NULL,
	Notified_Date DATETIME NOT NULL ,
	Site_Name VARCHAR(50) COLLATE DATABASE_DEFAULT NOT NULL,
	Eqp_Number VARCHAR(50) COLLATE DATABASE_DEFAULT NOT NULL,
	Plan_Type int,/*VV CR8429*/
	Component_Code VARCHAR(10) COLLATE DATABASE_DEFAULT NULL,/*JW E804*/
    Task_Type VARCHAR(50) COLLATE DATABASE_DEFAULT NULL
 )

INSERT INTO #I_DOWNTIME_EVENT(Event_Id ,New_Event,Down_Time,Up_Time,Code,Code_Desc,Description,
Notified_Date,Site_Name,Eqp_Number,Plan_Type, Component_Code, Task_Type)
SELECT 	Event_Id,New_Event,Down_Time,Up_Time,Code,Code_Desc,/*VV CR8544*/Description,Notified_Date,
Site_Name,Eqp_Number,ISNULL(Plan_Type,2)/*VV CR8429 Default breakdown*/, Component_Code, Task_Type
FROM OPENXML(@docHandle, N'//EQS_EVT', 2) WITH #I_DOWNTIME_EVENT

EXEC sp_xml_removedocument @docHandle

INSERT INTO  MODULAR_EVENT(
	Modular_Mining_Id,
	New_Event,
	Down_Time,
	Up_Time,
	Code,
	Code_Description,/*VV CR8544*/
	Description,
	Notified_Date,
	Site_Name,
	Eqp_Name ,
	PlanType,/*VV CR8429*/
	ComponentCode,/*JW E804*/
	TaskType)
SELECT
	Event_Id,
	New_Event,
	CAST(NULLIF(Down_Time,'') AS DateTime) AS Down_Time,
	CAST(NULLIF(Up_Time,'') AS DateTime) AS Up_Time,
	Code,
	Code_Desc,/*VV CR8544*/
	Description,
	Notified_Date,
	Site_Name,
	Eqp_Number,
	ISNULL(Plan_Type,2),/*VV CR8429 Default breakdown*/
	Component_Code,
	Task_Type
FROM #I_DOWNTIME_EVENT WHERE (NULLIF(Down_Time,'') IS NOT NULL) AND
(NULLIF(Up_Time,'') IS NULL OR CAST(NULLIF(Down_Time,'') AS DateTime)<=CAST(NULLIF(Up_Time,'') AS DateTime))


SET @Message=''

IF EXISTS(SELECT Event_Id FROM #I_DOWNTIME_EVENT WHERE NULLIF(Down_Time,'') IS NOT NULL AND 
CAST(NULLIF(Down_Time,'') AS DateTime)>CAST(NULLIF(Up_Time,'') AS DateTime))
BEGIN
	SELECT @Message=@Message+CHAR(13)+'Event_Id '+Event_Id+': Down_Time is greater than Up_Time.'
	FROM #I_DOWNTIME_EVENT 
	WHERE NULLIF(Down_Time,'') IS NOT NULL AND 
	CAST(NULLIF(Down_Time,'') AS DateTime)>CAST(NULLIF(Up_Time,'') AS DateTime)
	
END

IF EXISTS(SELECT Event_Id FROM #I_DOWNTIME_EVENT WHERE NULLIF(Down_Time,'') IS NULL)
BEGIN
	SELECT @Message=@Message+CHAR(13)+'Event_Id '+Event_Id+': Down_Time is not provided.'
	FROM #I_DOWNTIME_EVENT WHERE NULLIF(Down_Time,'') IS NULL
END

DROP TABLE #I_DOWNTIME_EVENT
  
EXEC HOLDING_EVENT_UPDATE_NEW_P

IF @Message<>'' RAISERROR (@Message, 16, 1)

 
 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[HOLDING_EVENT_UPDATE_NEW_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[HOLDING_EVENT_UPDATE_NEW_P]
GO

create   PROCEDURE  [dbo].[HOLDING_EVENT_UPDATE_NEW_P]   
/******************************************************************************  
 Name: HOLDING_EVENT_UPDATE_NEW_P  
  
 Called By: EQSEVTImporter.EventImporter  
  
 Desc: Updates or adds holding events from new Modular Mining events  
               
  
 Auth: Darryl Smith  
 Date: 02-Oct-2002  
*******************************************************************************  
  Change History  
*******************************************************************************  
 Date:		Author:		Description:  
 --------   --------	---------------------------------------- 
 07 May 12  JW			E813 Change cursor to feach modular event in downtime order
 04 May 12  JW			E813 Initial @PreviousEventId with 0
 02 May 12  JW			E813 Update Primary Task WHEN Linked already with CC and TT
 02 May 12  JW			E812 Add ComponentCode and TaskType columns to Holding_Event table 
 02 May 12  JW			E812 Modify Inset statement with table column name
 04 Aug 11	D Smith		#2130: Only run EVENT_UPDATE_FROM_HOLDING_EVENTS_P once for each Event_ID
 23 Feb 11	V Vasylyeva #1194: took out seconds from HE downtime
 29 Oct 2009  V Vasylyeva  CR8429: New field Plan_Type.  
         Special event merging rule where you can set the time margin for merging   
         Dispatch Downtime Records.   
 21 Oct 2008  V Vasylyeva  Increased size of Code to 50 char.   
         HOLDING_EVENT.Code was increased from 3 to 10 char in the table.  
 15 Oct 2008  V Vasylyeva  Added events merging  
 10 Oct 2008  V Vasylyeva  Added automatic event creation  
 29 OCT 03    H Singh    HACK: donot return rows if Modular Mining Id starts with 0(zero) and ends with EqpPlan  
 2003-May-28 H Singh   Modified Holding_Event Insert. and update to set Ignore flag to 1 or 0  
 2003-May-21 V Vasylyeva  Modified Holding_Event Insert. Included Ignore=0  
 2002-Oct-16 D Smith   Added call to MODULAR_MINING_EVENT_ADD_TO_EXISTING_EVENT_P  
         to update EQS event (for holding events that are linked)  
 2002-Oct-21  D Smith   Updated to include new rules agreed 2002-Oct-18  
 2002-Oct-25 D Smith   Sets Up_Time to Null instead of 0 (XML bulkloader  
         requires a default value for fields)  
 2002-Oct-25 D Smith   Fixed bug (was not resetting variables each time thru loop!)  
 2002-Nov-27 D Smith   Changed type of Modular_Mining_Id variables (Modular files were different to the spec!)  
*******************************************************************************/  
 /* Param List */  
AS  
 DECLARE @HE_Modular_Mining_Id VARCHAR(50)  
 DECLARE @EQS_Event_Id INTEGER  
 DECLARE @Modular_Mining_Id VARCHAR(50)  
 DECLARE @Code VARCHAR(50)  
 DECLARE @Code_Description VARCHAR(255)  
 DECLARE @Description VARCHAR(255)  
 DECLARE @Site_Name VARCHAR(50)  
 DECLARE @Eqp_Name VARCHAR(50)  
 DECLARE @Down_Time DATETIME  
 DECLARE @Up_Time DATETIME  
 DECLARE @Notified_Date DATETIME  
 DECLARE @HE_Id INTEGER  
 DECLARE @Err VARCHAR(1000)  
 DECLARE @Counter int  
 DECLARE @MaxCounter int  
 DECLARE @Holding_Event_Id int  
 DECLARE @EStatusC int  
 DECLARE @PlanType int  
 DECLARE @ImportEventMergeMinutes int 
 DECLARE @ComponentCode VARCHAR(10)
 DECLARE @TaskType VARCHAR(50) 
  
 DECLARE @Ignored bit  
 DECLARE @Modular_Minning_Eqp_Name varchar(50)  
  
 UPDATE MODULAR_EVENT SET Up_Time = Null WHERE Up_Time = 0  
 UPDATE MODULAR_EVENT SET Code = '' WHERE ISNULL(Code, '') = ''  
 UPDATE MODULAR_EVENT SET Code_Description = '' WHERE ISNULL(Code_Description, '') = ''  
  
 SET @EStatusC=3  
 
 DECLARE @PreviousEventId INT = 0 --DS 2011-08-04 #2130 --E813

 DECLARE HoldingEventCursor CURSOR FAST_FORWARD FOR  
  SELECT  
   Modular_Mining_Id,  
   Code,  
   Code_Description,  
   Description,  
   Site_Name,  
   Eqp_Name,  
   Down_Time,  
   Up_Time,  
   Notified_Date,  
   PlanType,
   ComponentCode,
   TaskType  
  FROM  
   MODULAR_EVENT  
  WHERE  
   Current_Batch=1  
  --Hack: HS 29 OCT 03    donot return rows if Modular Mining Id starts with 0(zero) and ends with EqpPlan  
  AND   
   NOT (Modular_Mining_Id LIKE '0' + Eqp_Name)  
  ORDER BY 
   Modular_Mining_Id,Down_Time DESC
  
 OPEN HoldingEventCursor  
  
 -- Get first record  
 FETCH NEXT FROM HoldingEventCursor  
  INTO   
   @Modular_Mining_Id,  
   @Code,  
   @Code_Description,  
   @Description,  
   @Site_Name,  
   @Eqp_Name,  
   @Down_Time,  
   @Up_Time,  
   @Notified_Date,  
   @PlanType,
   @ComponentCode,/*JW E813*/
   @TaskType  
 WHILE (@@FETCH_STATUS = 0)  
  BEGIN  
   --reset variables  
   SELECT @HE_Modular_Mining_Id = NULL  
   SELECT @EQS_Event_Id = NULL  
   SELECT @HE_Id = NULL  
  
   SELECT @Modular_Minning_Eqp_Name = Modular_Mining_Eqp_Name FROM tblEqppLans WHERE Modular_Mining_Eqp_Name = @Eqp_Name  
   IF ISNULL(@Modular_Minning_Eqp_Name,'') = '' SET @Ignored = 1 ELSE SET @Ignored = 0  
  
   SELECT  
    @HE_Modular_Mining_Id = Modular_Mining_Id,  
    @EQS_Event_Id = Event_Id,  
    @HE_Id = Holding_Event_Id  
   FROM  
    HOLDING_EVENT  
   WHERE  
    Modular_Mining_Id = @Modular_Mining_Id  
  
   if isnull(@HE_Modular_Mining_Id,'') <> ''  
   begin  
    --this Modular downtime event already exists in HOLDING_EVENT  
    UPDATE  
     HOLDING_EVENT  
    SET  
     Modular_Mining_Id = @Modular_Mining_Id,  
     Code = @Code,  
     Code_Description = @Code_Description,  
     Description = @Description,  
     Site_Name = @Site_Name,  
     Eqp_Name = @Eqp_Name,  
     Down_Time = @Down_Time,  
     Up_Time = @Up_Time,  
     Notified_Date = @Notified_Date,  
     Ignore = @Ignored,  
     PlanType=@PlanType,
     ComponentCode = @ComponentCode,
     TaskType = @TaskType  
    WHERE  
     Modular_Mining_Id = @Modular_Mining_Id  
  
	--now, if the HOLDING_EVENT record is linked to an EQS EVENT, update it!
	if isnull(@EQS_Event_Id,0) <> 0 AND (@EQS_Event_Id <> @PreviousEventId)
	begin
		--update the EQS event!
		exec EVENT_UPDATE_FROM_HOLDING_EVENTS_P @EQS_Event_Id

		SET @PreviousEventId = @EQS_Event_Id -- DS 2011-08-03 

	end
   end  
   else  
   begin  
    --this Modular downtime event doesn't exist in HOLDING_EVENT  
    INSERT INTO  
     HOLDING_EVENT  
     (
		Modular_Mining_Id,
		Code,
		Code_Description,
		Description,
		Site_Name,
		Eqp_Name,
		Down_Time,
		Up_Time,
		Event_Id,
		Notified_Date,
		Ignore,
		PlanType,
		ComponentCode, /*JW E813*/
		TaskType
     )
         
    VALUES  
     (  
     @Modular_Mining_Id,  
     @Code,  
     @Code_Description,  
     @Description,  
     @Site_Name,  
     @Eqp_Name,  
     @Down_Time,  
     @Up_Time,  
     Null,     --Event_Id  
     @Notified_Date,  
     @Ignored,  
     @PlanType,
     @ComponentCode,/*JW E813*/
     @TaskType  
     )  
   end  
  
   FETCH NEXT FROM HoldingEventCursor  
    INTO   
     @Modular_Mining_Id,  
     @Code,  
     @Code_Description,  
     @Description,  
     @Site_Name,  
     @Eqp_Name,  
     @Down_Time,  
     @Up_Time,  
     @Notified_Date,  
     @PlanType,
     @ComponentCode,
     @TaskType  
  END  
  
 CLOSE HoldingEventCursor  
 DEALLOCATE HoldingEventCursor 
 

 
 --10 Oct 2008  V Vasylyeva  Added automatic event creation  
  
 IF EXISTS(SELECT AutoCreateExtEvent FROM AMT_VARIABLE WHERE AutoCreateExtEvent=1) AND  
 EXISTS(SELECT HE.Holding_Event_Id  
  FROM  
  HOLDING_EVENT HE  
   INNER JOIN  
  MODULAR_EVENT ME  
   ON HE.Modular_Mining_Id=ME.Modular_Mining_Id  
  WHERE ME.Current_Batch=1  
  --Hack: HS 29 OCT 03    donot return rows if Modular Mining Id starts with 0(zero) and ends with EqpPlan  
  AND NOT (ME.Modular_Mining_Id LIKE '0' + ME.Eqp_Name)  
  AND HE.Event_Id IS NULL)  
 BEGIN  
  CREATE TABLE #z_HOLDING_EVENT(Holding_Event_Id int,ListId int IDENTITY(1,1) PRIMARY KEY(Holding_Event_Id,ListId))  
  
  INSERT INTO #z_HOLDING_EVENT(Holding_Event_Id)  
  SELECT HE.Holding_Event_Id  
  FROM  
  HOLDING_EVENT HE  
   INNER JOIN  
  MODULAR_EVENT ME  
   ON HE.Modular_Mining_Id=ME.Modular_Mining_Id  
  WHERE ME.Current_Batch=1  
  --Hack: HS 29 OCT 03    donot return rows if Modular Mining Id starts with 0(zero) and ends with EqpPlan  
  AND NOT (ME.Modular_Mining_Id LIKE '0' + ME.Eqp_Name)  
  AND HE.Event_Id IS NULL  
  GROUP BY HE.Holding_Event_Id,HE.Down_Time  
  ORDER BY HE.Down_Time 
  
  --select * into z_HOLDING_EVENT from #z_HOLDING_EVENT 
  
  
  SET @MaxCounter=@@ROWCOUNT  
  
  IF @MaxCounter>0   
  BEGIN  
   SET @Counter=1  
     
   EXEC AMT_TYPED_VARIABLE_GET_P @Value_Name='ImportEventMergeMinutes', @Varchar_Value=@ImportEventMergeMinutes OUTPUT  
    
   SET @ImportEventMergeMinutes=ISNULL(@ImportEventMergeMinutes,0)  
     
   WHILE @Counter<=@MaxCounter  
   BEGIN  
  
    SET @Holding_Event_Id=NULL  
    SET @Down_Time=NULL  
    SET @Eqp_Name=NULL  
  
    SELECT @Holding_Event_Id=HE.Holding_Event_Id,
    /*VV #1194 @Down_Time=HE.Down_Time, */
    @Down_Time=dbo.FORMAT_DAY_MONTH_YEAR_HRS_MIN_F(HE.Down_Time) ,
    @Eqp_Name=HE.Eqp_Name  
    FROM   
    #z_HOLDING_EVENT Z  
     INNER JOIN  
    HOLDING_EVENT HE  
     ON Z.Holding_Event_Id=HE.Holding_Event_Id  
    WHERE Z.ListId=@Counter AND HE.Event_Id IS NULL  
  
    SET @Counter=@Counter+1  
  
    IF @Holding_Event_Id>0  
    BEGIN  
     SET @EQS_Event_Id=0  
  
     --Check if the MM event shall be added to the existing events  
     SELECT @EQS_Event_Id=E.Event_Id FROM  
     EVENT E  
      INNER JOIN  
     tblEqpPlans EP  
      ON E.Eqp_Plan_Id=EP.EqpPlanId  
      INNER JOIN  
     HOLDING_EVENT HE  
      ON E.Event_Id=HE.Event_Id  
     WHERE E.Event_Status_Id=@EStatusC AND  
     EP.Modular_Mining_Eqp_Name=@Eqp_Name AND  
     @Down_Time>=E.Actual_Down_Time AND  
     @Down_Time<=DATEADD(MINUTE,@ImportEventMergeMinutes, E.Actual_Up_Time)  
  
     IF @EQS_Event_Id>0  
     BEGIN  
      EXEC MODULAR_MINING_EVENT_ADD_TO_EXISTING_EVENT_P @Holding_Event_Id=@Holding_Event_Id,  
       @Event_ID=@EQS_Event_Id,@Error_Description=''  
     END  
     ELSE  
     BEGIN  
      EXEC MODULAR_MINING_EVENT_ADD_TO_NEW_EVENT_P @Holding_Event_Id=@Holding_Event_Id,  
       @New_Event_ID=0,@Error_Description=''  
     END  
    END  
   END --WHILE @Counter>=@MaxCounter  
  END --IF @MaxCounter>0   
 END  
  
 UPDATE  
  MODULAR_EVENT  
 SET  
  Current_Batch = 0  
 WHERE  
  Current_Batch = 1
  
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[HOLDING_EVENT_GET_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[HOLDING_EVENT_GET_P]
GO

create    PROCEDURE HOLDING_EVENT_GET_P 
/******************************************************************************
	Name: HOLDING_EVENT_GET_P

	Called By: EQSCPLib.HoldingEventGet

	Desc: Gets holding events (filtered)
             

	Auth: Darryl Smith
	Date: 27-Sep-2002
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	07 May 12   JW			E812 Change the order of the columns
	02 May 12	JW			E812 Add ComponentCode and TaskType columns
	28 Jan 10	V Vasylyeva	CR8735 Duplication of the records in downtime wizard
	 2 Nov 2009	V Vasylyeva	CR8430 - downtime changes
	27 May 05	VV		Replace ";" with "," in the input parameters
	13-May-2003	V Vasylyeva	Added Ignore flag
	11-Apr-2003	V Vasylyeva	Added SiteID,BranchID for equipment level security
	4-Oct-2002	V Vasylyeva	changed to dynamically created @SQL					
*******************************************************************************/
	/* Param List */
	@Eqp_Name varchar(max)='',	
	@From_Date DATETIME=NULL,
	@To_Date DATETIME=NULL,
	@SiteID varchar(max)='',
	@Ignore int=2/*1 - Yes|0 - No|2 - All*/,
	@UserId int=0,
	@HoldingEventId int=0
AS

SET @Eqp_Name=ISNULL(@Eqp_Name,'')
SET @SiteID=ISNULL(@SiteID,'')
SET @Ignore=ISNULL(@Ignore,2)	
SET @UserId=ISNULL(@UserId,0)
DECLARE @Level int

SELECT @Level=User_Access_Level_Id From USER_LEVEL_PERMISSION where AMT_User_Id = @UserId

SET @Level=ISNULL(@Level,0) /*0 -ALL, 1-Branch,2-Site*/

SELECT DISTINCT/*VV CR8735*/ HE.Eqp_Name,EP.EqpPlan,HE.Code,HE.Code_Description,HE.Down_Time,
HE.Up_Time,HE.Description,HE.PlanType,HE.ComponentCode, HE.TaskType,HE.Ignore,HE.Holding_Event_Id,S.Modular_Mining_Site_Name /*JW E812*/
  
FROM 
HOLDING_EVENT HE
	LEFT JOIN
tblSites S
	ON HE.Site_Name=S.Modular_Mining_Site_Name
	LEFT JOIN
tblEqpPlans EP
	ON HE.Eqp_Name = EP.Modular_Mining_Eqp_Name
WHERE HE.Event_Id IS NULL AND
(@Level<>1 OR S.BranchId IS NULL OR S.BranchId IN(SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = @UserId)) AND
(@Level<>2 OR S.SiteId IS NULL OR S.SiteId IN(SELECT AMT_OBJECT_ID FROM USER_LEVEL_PERMISSION WHERE AMT_USER_ID = @UserId)) AND

(HE.Holding_Event_Id=@HoldingEventId OR @HoldingEventId=0 AND

	(
		HE.Down_Time>=@From_Date AND HE.Down_Time<=@To_Date AND
		(@Ignore=2 OR HE.Ignore=CAST(@Ignore AS bit)) AND
		(@SiteID='' OR S.SiteId IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_F(@SiteID))) AND
		(@Eqp_Name='' OR HE.Eqp_Name IN (SELECT List_Item FROM dbo.LIST_TO_TABLE_2_F(@Eqp_Name)))
	)
)
ORDER BY HE.Down_Time

 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[EVENT_UPDATE_FROM_HOLDING_EVENTS_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[EVENT_UPDATE_FROM_HOLDING_EVENTS_P]
GO


CREATE    Procedure EVENT_UPDATE_FROM_HOLDING_EVENTS_P      
/******************************************************************************      
 File:       
 Name: EVENT_UPDATE_FROM_HOLDING_EVENTS_P      
      
 Called By: HOLDING_EVENT_UPDATE_NEW_P      
      
 Desc: 1. Updates EQS Event based on an update to one      
   of its holding events      
      
 Auth: Darryl Smith      
 Date: 16-Oct-2002      
*******************************************************************************      
  Change History      
*******************************************************************************      
 Date:  Author:  Description:      
 -------- -------- ----------------------------------------
 07 May 2012 JW  E813 Take the select statement out of transaction      
 04 May 2012 JW  E813 Update Task_Header table as well    
 02 May 2012 JW  E813 Update ComponentCode and TaskType in Task table    
 29-Jun-2010 V Vasylyeva CR9000: Downtime allocations.       
       Also took out calculation of down, up usages.      
 30-Jan-2006 V Vasylyeva Update tasks which are not deferred in the event,      
     update only YTS, IP, Completed tasks - do not      
            update abandoned tasks.      
     Relink tasks to workorders      
 08-Apr-2004 D Smith  Removed updating of Planned Up and Down fields      
 04-Mar-2003 V Vasylyeva Modified the calculation of DTA hours      
 03-Mar-2003 V Vasylyeva Removed Down_Time_Allocation.Variance update      
 2002-Oct-21 D Smith  Updated to include new rules agreed 2002-Oct-18      
      
*******************************************************************************/      
 /* Param List */      
 @Event_ID INTEGER    
      
AS      
      
SET NOCOUNT ON      
      
DECLARE @Event_Status_ID_InProgress int      
DECLARE @Event_Status_ID_Completed int      
DECLARE @Task_Status_ID_InProgress int      
Declare @Task_Status_ID_Completed int      
DECLARE @Task_Status_ID_Deferred int      
DECLARE @Task_Status_ID_Abandoned int      
DECLARE @Task_Status_ID_Outstanding int      
DECLARE @Task_Status_ID_YTS int      
      
/*VV 29-Jun-2010 DECLARE @ProjectionId INT*/       
DECLARE @DTA_Hours real      
/*VV 29-Jun-2010 DECLARE @Eqp_Plan_ID int*/      
DECLARE @Actual_Down_Time datetime       
DECLARE @Actual_Up_Time datetime       
DECLARE @Actual_Down_Usage float       
DECLARE @Event_Status_ID INT      
/* VV 29-Jun-2010 DECLARE @QUOM_ID int*/      
DECLARE @Last_Mod_By_User_ID int       
DECLARE @Task_Status_ID int      
DECLARE @tasks varchar(8000)      
      
DECLARE @Holding_Event_Id int      
    
/*JW E813*/    
DECLARE @Component_Code_Id INT    
DECLARE @Task_Type_Id INT        
DECLARE @Modifier_ID INT    
DECLARE @Application_Code_ID INT    
DECLARE @Task_Header_Id INT    
      
--HACK: hard-coding the event and task statuses!      
SET @Event_Status_ID_InProgress=2      
SET @Event_Status_ID_Completed=3      
      
SET @Task_Status_ID_Outstanding=1      
SET @Task_Status_ID_InProgress=2      
SET @Task_Status_ID_Completed=3      
SET @Task_Status_ID_Deferred =4      
SET @Task_Status_ID_Abandoned=5      
SET @Task_Status_ID_YTS=6      
      
SET @Last_Mod_By_User_ID=0      
      
--set event status depending on actual up time:      
-- if actual up time is NULL then event status = in progress      
-- if actual up time is not NULL then event status = completed      
      
--the up time is the up time of the modular event for this EQS event that started most recently!      
SELECT      
 @Actual_Up_Time = Up_Time,    
 @Component_Code_Id = CC.ComponentCodeID,    
 @Task_Type_Id = TT.TaskTypeID      
FROM      
 HOLDING_EVENT HE INNER JOIN EVENT ON HE.Event_Id = EVENT.Event_Id
 LEFT JOIN dbo.tblComponentCodes CC ON CC.Code = HE.ComponentCode 
 LEFT JOIN dbo.tblTaskTypes TT ON TT.Code = HE.TaskType     
WHERE      
 EVENT.Event_Id = @Event_Id      
AND HE.Holding_Event_Id =      
 (SELECT TOP 1 Holding_Event_Id FROM HOLDING_EVENT WHERE Event_Id = @Event_Id ORDER BY Down_Time DESC)      
      
IF @Actual_Up_Time IS NULL      
 BEGIN      
  --if actual up time is NULL then event status = in progress      
  SET @Event_Status_ID=@Event_Status_ID_InProgress      
  SET @Task_Status_ID=@Task_Status_ID_InProgress      
      
  --set Actual_Up_Time to now if it is NULL      
  SET @Actual_Up_Time=GETDATE()      
 END      
ELSE      
 BEGIN      
  --if actual up time is not NULL then event status = completed      
  SET @Event_Status_ID=@Event_Status_ID_Completed       
  SET @Task_Status_ID=@Task_Status_ID_Completed       
 END      
      
--get the down date/time      
SELECT      
 @Actual_Down_Time = MIN(Down_Time)      
FROM      
 HOLDING_EVENT INNER JOIN EVENT ON HOLDING_EVENT.Event_Id = EVENT.Event_Id      
WHERE      
 EVENT.Event_Id = @Event_Id      
       
/*VV CR9000*/      
SET @Actual_Down_Time=dbo.FORMAT_DAY_MONTH_YEAR_HRS_MIN_F(@Actual_Down_Time)      
SET @Actual_Up_Time=dbo.FORMAT_DAY_MONTH_YEAR_HRS_MIN_F(@Actual_Up_Time)      
      
/*VV 29-Jun-2010      
--get the QUOM_ID      
SELECT      
 @QUOM_ID=QUOM_ID       
FROM      
 EVENT      
WHERE      
 Event_ID=@Event_ID      
*/      
      
--**********************      
--calculate the usage      
SELECT      
 @Holding_Event_Id = MIN(Holding_Event_Id) --just arbitrarily select the first holding event that's linked to the EQS event      
FROM      
 HOLDING_EVENT INNER JOIN EVENT ON HOLDING_EVENT.Event_Id = EVENT.Event_Id      
WHERE      
 EVENT.Event_Id = @Event_Id      
    
    
      
/*VV 29-Jun-2010      
SELECT      
 @Eqp_Plan_Id = EqpPlanId      
FROM      
 tblEqpPlans INNER JOIN HOLDING_EVENT ON tblEqpPlans.Modular_Mining_Eqp_Name = HOLDING_EVENT.Eqp_Name      
WHERE      
 Holding_Event_Id = @Holding_Event_Id      
       
      
SELECT      
 @ProjectionId=EqpProjId       
FROM      
 tblEqpProjs       
WHERE       
 EqpPlanId = @Eqp_Plan_Id      
AND tblEqpProjs.CurrentProj = - 1      
      
      
EXEC usp_GetUsageFromDate @ProjectionId, @Actual_Down_Time, @QUOM_ID, @Actual_Down_Usage OUTPUT */      
--**********************      
      
      
--**********************      
      
/* VV CR9000      
--downtime allocations      
--get the sum of non-primary DTA hours      
SELECT      
 @DTA_Hours = ISNULL(      
      (SELECT SUM(Actual_Hours) FROM DOWN_TIME_ALLOCATION      
      WHERE (Event_ID = @Event_ID) AND (Primary_DTA = 0))      
      , 0)      
      
--calculate the actual hours for primary DTA      
SELECT      
 @DTA_Hours = (CONVERT(float,@Actual_Up_Time)-CONVERT(float,@Actual_Down_Time)) *24 - @DTA_Hours      
*/      
--**********************      
/*JW E813*/
SELECT       
@Component_Code_Id = ISNULL(@Component_Code_Id,T.Component_Code_ID),        
@Task_Type_Id = ISNULL(@Task_Type_Id,T.Task_Type_ID),      
@Modifier_ID = T.Modifier_ID,      
@Application_Code_ID = T.Application_Code_ID 
FROM     
DEFERRED_TASK DT         
 RIGHT OUTER JOIN        
TASK T         
 ON DT.Task_ID = T.Task_ID AND DT.Event_ID = T.Event_ID        
WHERE        
(DT.Deferred_Task_ID IS NULL)  AND        
(T.Event_ID=@Event_ID) AND         
(T.Task_Status_ID = @Task_Status_ID_InProgress OR         
T.Task_Status_ID=@Task_Status_ID_Completed OR        
T.Task_Status_ID=@Task_Status_ID_YTS)      
AND T.Primary_Cause = 1 


      
--**********************      
--now, update the EQS event and its DTAs and tasks      
BEGIN TRANSACTION      
      
--update the event       
UPDATE      
 EVENT      
SET      
 Event_Status_ID=@Event_Status_ID,       
 Actual_Down_Time=@Actual_Down_Time,       
 /*VV 29-Jun-2010 Actual_Down_Usage=@Actual_Down_Usage,*/       
 Actual_Up_Time=@Actual_Up_Time,       
 /*VV 29-Jun-2010  Actual_Up_Usage=@Actual_Down_Usage, */      
 Last_Mod_By_User_ID=@Last_Mod_By_User_ID,      
 Last_Mod_Date=getdate()      
WHERE      
 Event_ID=@Event_ID      
      
/*VV CR9000*/      
EXEC DTA_HOURS_UPDATE_P @EventId=@Event_ID      
      
/* VV CR9000      
--update the primary DTA      
if @DTA_Hours < 0      
begin      
 --update the primary DTA to represent all the downtime, and set all other DTAs to 0 hours      
 SELECT @DTA_Hours = (CONVERT(float,@Actual_Up_Time)-CONVERT(float,@Actual_Down_Time))*24      
 UPDATE      
  DOWN_TIME_ALLOCATION       
 SET      
  Actual_Hours = @DTA_Hours,       
  --Variance = ISNULL(DOWN_TIME_ALLOCATION.Planned_Hours, 0) - @DTA_Hours,       
  Last_Mod_By_User_ID = @Last_Mod_By_User_ID,      
  Last_Mod_Date = getdate()      
 WHERE      
  Event_ID = @Event_ID      
 AND Primary_DTA = 1      
      
 UPDATE      
  DOWN_TIME_ALLOCATION      
 SET      
  Actual_Hours = 0,      
  --Variance = ISNULL(DOWN_TIME_ALLOCATION.Planned_Hours, 0),      
  Last_Mod_By_User_ID = @Last_Mod_By_User_ID,      
  Last_Mod_Date = getdate()      
 WHERE      
  Event_ID = @Event_ID      
end      
else      
begin      
 --just update the primary DTA      
 UPDATE      
  DOWN_TIME_ALLOCATION       
 SET      
  Actual_Hours = @DTA_Hours,       
  --Variance = ISNULL(DOWN_TIME_ALLOCATION.Planned_Hours, 0) - @DTA_Hours,       
  Last_Mod_By_User_ID = @Last_Mod_By_User_ID,      
  Last_Mod_Date = getdate()      
 WHERE      
  Event_ID = @Event_ID      
 AND Primary_DTA = 1      
end      
*/      
--Update Task_Header    
EXEC TASK_HEADER_MANAGER_P   @Component_Code_ID,  @Modifier_ID,  @Task_Type_ID,  @Application_Code_ID, @Task_Header_Id OUTPUT 

--update all tasks      
UPDATE T       
SET      
T.Task_Status_ID=@Task_Status_ID,       
T.Date_Notified=(SELECT Notified_Date FROM HOLDING_EVENT WHERE HOLDING_EVENT_ID=@HOLDING_EVENT_ID),
T.Component_Code_ID = CASE WHEN T.Primary_Cause = 1 THEN @Component_Code_Id ELSE T.Component_Code_ID END,  /*JW E813*/
T.Task_Type_ID = CASE WHEN T.Primary_Cause = 1 THEN @Task_Type_ID ELSE T.Task_Type_ID END,
T.Task_Header_Id = CASE WHEN T.Primary_Cause = 1 THEN @Task_Header_Id ELSE T.Task_Header_Id END     
FROM               
DEFERRED_TASK DT       
 RIGHT OUTER JOIN      
TASK T       
 ON DT.Task_ID = T.Task_ID AND DT.Event_ID = T.Event_ID      
WHERE      
(DT.Deferred_Task_ID IS NULL)  AND      
(T.Event_ID=@Event_ID) AND       
(T.Task_Status_ID = @Task_Status_ID_InProgress OR       
T.Task_Status_ID=@Task_Status_ID_Completed OR      
T.Task_Status_ID=@Task_Status_ID_YTS)        
          
      
IF EXISTS(SELECT T.Task_ID       
 FROM       
 TASK T       
  LEFT OUTER JOIN      
 DEFERRED_TASK DT       
  ON T.Event_ID = DT.Event_ID AND T.Task_ID = DT.Task_ID      
 WHERE      
 (DT.Deferred_Task_ID IS NULL)  AND      
 (T.Event_ID=@Event_ID) AND       
 (T.Task_Status_ID = @Task_Status_ID_InProgress OR       
 T.Task_Status_ID=@Task_Status_ID_Completed OR      
 T.Task_Status_ID=@Task_Status_ID_YTS) AND      
 (T.Work_Order_ID IS NOT NULL))      
BEGIN      
      
 SET @tasks = ''      
       
 SELECT @tasks = @tasks + CAST(T.Task_ID AS varchar) + ','      
 FROM       
 TASK T       
  LEFT OUTER JOIN      
 DEFERRED_TASK DT       
  ON T.Event_ID = DT.Event_ID AND T.Task_ID = DT.Task_ID      
 WHERE      
 (DT.Deferred_Task_ID IS NULL)  AND      
 (T.Event_ID=@Event_ID) AND       
 (T.Task_Status_ID = @Task_Status_ID_InProgress OR       
 T.Task_Status_ID=@Task_Status_ID_Completed OR      
 T.Task_Status_ID=@Task_Status_ID_YTS) AND      
 (T.Work_Order_ID IS NOT NULL)      
       
 IF @tasks<>''      
 BEGIN      
  SET @tasks=LEFT(@tasks,LEN(@tasks)-1)      
  EXEC TASK_WORK_ORDER_LINK_MULTI_P @TasksID=@tasks      
 END      
END      
      
      
      
COMMIT TRANSACTION      
--**********************      
      
SET NOCOUNT OFF  

GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[MODULAR_MINING_EVENT_ADD_TO_EXISTING_EVENT_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[MODULAR_MINING_EVENT_ADD_TO_EXISTING_EVENT_P]
GO

CREATE Procedure MODULAR_MINING_EVENT_ADD_TO_EXISTING_EVENT_P          
/******************************************************************************          
 File:           
 Name: MODULAR_MINING_EVENT_ADD_TO_EXISTING_EVENT_P          
          
 Called By:           
          
 Desc: 1. Modula Mining Event to an existing event          
       2. Return id of the new Event          
                       
          
 Auth: Veronika Vasylyeva          
 Date: 3-Oct-2002          
*******************************************************************************          
  Change History          
*******************************************************************************          
 Date:   Author:  Description:          
 --------   --------  ---------------------------------------- 
 07 May 2012  JW  E813 Take the select statement out of the transaction         
 03 May 2012  JW  E813 Update exists event with CC and TT         
 29 Jun 2010  V Vasylyeva  CR2000: Downtime allocations calculation          
 29 Oct 2009  V Vasylyeva  CR8429: Special event merging rule where you can set the time margin           
         for merging Dispatch Downtime Records.           
 15 Oct 2008 V Vasylyeva If a MM event is added to an event which has a MM event linked to it          
                 
 30-Jan-2006 V Vasylyeva Update tasks which are not deferred in the event,          
     update only YTS, IP, Completed tasks - do not          
            update abandoned tasks.          
     Relink tasks to workorders          
 30-Oct-2003 H Singh  Coomented should link MM event (Comp) to a EQS event (Inprogress, Yettostart)          
 22-May-2003 V Vasylyeva Fixed a bug which did not allow the user          
        add a new MM event to the EQS event with          
        MM events linked to it even if          
        the dates were continious          
 02-Apr-2003 V Vasylyeva If a modular mining event is added to an           
        existing EQS Event Planned Up Time,          
        Planned Down remain unchanged.          
          
 04-Mar-2003 V Vasylyeva Modified the calculation of DTA hours          
 03-Mar-2003 V Vasylyeva Removed Down_Time_Allocation.Variance update          
     18-Oct-2002 V Vasylyeva Planned_Up_Time=Actual_Down_Time.          
        Adding MM Event  to EQS Event          
        which is in progress and has another MM          
        Events linked to it.          
          
 17-Oct-2002 V Vasylyeva If the primary task of the event is deferred          
        or abandoned then the event cannot be linked          
        to a modular mining event          
        The Notification Date = Date on the Modular Event when create the task          
        DO NOT UPDATE THIS Notification Date when update tasks/events from Modular          
        Mining.          
          
*******************************************************************************/          
 /* Param List */          
 @Holding_Event_Id int,           
 @Event_ID int ,          
 @Error_Description varchar(2000) OUTPUT,          
 @Last_Mod_By_User_ID int =0          
                  
            
AS          
          
DECLARE @return_status int          
DECLARE @Event_Status_ID_InProgress int          
DECLARE @Event_Status_ID_Completed int          
DECLARE @Task_Status_ID_InProgress int          
Declare @Task_Status_ID_Completed int          
DECLARE @Task_Status_ID_Deferred int          
DECLARE @Task_Status_ID_Abandoned int          
DECLARE @Task_Status_ID_YTS int          
          
SET @Event_Status_ID_InProgress=2          
SET @Event_Status_ID_Completed=3          
SET @Task_Status_ID_InProgress=2          
SET @Task_Status_ID_Completed=3          
SET @Task_Status_ID_Deferred =4          
SET @Task_Status_ID_Abandoned =5          
SET @Task_Status_ID_YTS =6          
          
DECLARE @DTA_Hours real          
DECLARE @Eqp_Plan_ID int -- search tblEqpPlans          
DECLARE @StartDate datetime -- for equipment start date          
DECLARE @Actual_Down_Time datetime           
DECLARE @Actual_Up_Time datetime           
DECLARE @Event_Status_ID INT          
DECLARE @Task_Status_ID int          
DECLARE @EStatusId int          
DECLARE @EActualDownTime datetime          
DECLARE @EActualUpTime datetime          
DECLARE @Linked int          
DECLARE @Notified_Date datetime          
          
DECLARE @tasks varchar(max)          
DECLARE @ImportEventMergeMinutes int          
                  
DECLARE @Component_Code_ID INT  /*JW E813*/      
DECLARE @Task_Type_ID INT        
DECLARE @Modifier_ID INT        
DECLARE @Application_Code_ID INT        
DECLARE @Task_Header_Id INT         
          
          
EXEC AMT_TYPED_VARIABLE_GET_P @Value_Name='ImportEventMergeMinutes', @Varchar_Value=@ImportEventMergeMinutes OUTPUT          
          
SET @ImportEventMergeMinutes=ISNULL(@ImportEventMergeMinutes,0)          
          
IF EXISTS(SELECT Holding_Event_Id FROM HOLDING_EVENT WHERE Holding_Event_Id=@Holding_Event_Id          
 AND Event_Id>0)          
BEGIN          
 SET @Error_Description='Downtime Event has already been linked.'          
 RETURN          
END          
          
--Check the status of the primary task          
IF EXISTS(SELECT * FROM TASK WHERE (Event_ID=@Event_ID) AND (Primary_Cause=1) AND (Task_Status_ID=@Task_Status_ID_Deferred OR Task_Status_ID=@Task_Status_ID_Abandoned))          
BEGIN          
 --If the primary task of the event is deferred          
 --or abandoned then the event cannot be linked          
 --to a modular mining event          
 SET @Error_Description='Event cannot be linked if the primary task is deferred or abandoned.'          
 RETURN           
END          
          
          
-- Event details          
SELECT @Eqp_Plan_ID=E.Eqp_Plan_Id ,@StartDate=EP.StartDate,@EStatusId=Event_Status_ID,          
@EActualDownTime=E.Actual_Down_Time,@EActualUpTime=E.Actual_Up_Time,          
@Linked=CASE WHEN HE.Event_Id>0 THEN 1 ELSE 0 END          
FROM           
EVENT E          
 INNER JOIN          
tblEqpPlans EP          
 ON E.Eqp_Plan_ID=EP.EqpPlanId          
 LEFT JOIN          
(SELECT DISTINCT Event_ID FROM HOLDING_EVENT WHERE Event_ID=@Event_Id) HE          
 ON E.Event_ID=HE.Event_Id          
WHERE E.Event_Id = @Event_Id          
          
IF @Eqp_Plan_ID IS NULL           
BEGIN          
 SET @Error_Description='Event does not exist.'          
 RETURN          
END          
          
          
SELECT  @Actual_Up_Time=Up_Time ,@Actual_Down_Time=Down_Time,@Notified_Date=Notified_Date          
FROM  HOLDING_EVENT WHERE HOLDING_EVENT.Holding_Event_Id = @Holding_Event_Id AND Event_Id IS NULL          
          
/*VV CR9000*/          
SET @Actual_Down_Time=dbo.FORMAT_DAY_MONTH_YEAR_HRS_MIN_F(@Actual_Down_Time)          
SET @Actual_Up_Time=dbo.FORMAT_DAY_MONTH_YEAR_HRS_MIN_F(@Actual_Up_Time)          
          
          
--Set Event status depending on Actual up time          
-- If Actual Up time is null Event status= in progress          
-- If Actual Up time is not Null Event Status=completed          
          
IF @Actual_Up_Time IS NULL          
BEGIN          
 -- If Actual Up time is null Event status= in progress          
 --DT Event is in progress          
 SET @Event_Status_ID=@Event_Status_ID_InProgress          
 SET @Task_Status_ID=@Task_Status_ID_InProgress          
END          
ELSE          
BEGIN          
 -- If Actual Up time is not Null Event Status=completed          
 --DT Event is completed          
 SET @Event_Status_ID=@Event_Status_ID_Completed           
 SET @Task_Status_ID=@Task_Status_ID_Completed           
END          
          
/*Check the rules*/          
IF @Event_Status_ID=@Event_Status_ID_InProgress /*DT Event is in progress Up time is null*/          
BEGIN          
 --If EQS Event is in progress and has DT events linked to it          
 -- the new DT event cannot be linked if it is also in progress          
 IF @Linked=1 AND @EStatusId= @Event_Status_ID_InProgress          
 BEGIN          
  SET @Error_Description='You cannot link downtime event which is in progress to equipment status event which is also in progress and has downtime events linked to it.'          
  RETURN          
 END          
           
 --There can only be one In Progress event at a time for a piece of Equipment          
 set @return_status=0          
 EXEC @return_status = EVENT_STATUS_CHECK_P @Eqp_Plan_ID,@Event_ID           
               
 IF @return_status>0         BEGIN          
  SET @Error_Description='There can only be one In Progress event at a time for a piece of Equipment.'          
  RETURN           
 END          
END          
ELSE          
BEGIN /*DT Event is completed*/          
            
 --Check Actual Up time. If it less than Equipment start date - it is a mistake          
 IF @Actual_Up_Time<@StartDate          
 BEGIN          
  SET @Error_Description='Actual up time can''t be less than equipment start date '           
  + CONVERT(varchar(50),@StartDate,106)+'.'          
  RETURN          
 END          
           
 --If a completed DT event is added to a EQS event which is in progress          
 -- and has another DT events linked to it          
 -- check that the dates are continuous          
 IF @EStatusId=@Event_Status_ID_InProgress AND @Linked=1 AND          
 NOT (@Actual_Down_Time<=@EActualDownTime AND           
  DATEADD(MINUTE,@ImportEventMergeMinutes,@Actual_Up_Time)>=@EActualDownTime)          
 BEGIN          
  --THE DATES ARE NOT CONTINIOUS          
  SET @Error_Description='The dates are not continuous.'          
  RETURN          
 END          
           
END          
          
          
--If Equipment status event was linked to a modular mining events check that          
--the dates are continuous          
IF @EStatusId=@Event_Status_ID_Completed AND @Linked=1          
BEGIN          
 --If equipment status event has DT events linked to it          
 -- and equipment status event has status completed          
 --check that the dates are continuous          
 --Check IF DT event is in progress that DT event down date is the same as EQS Event Up date          
 IF @Event_Status_ID=@Event_Status_ID_InProgress AND          
 NOT (@Actual_Down_Time>=@EActualDownTime AND          
 @Actual_Down_Time<=DATEADD(MINUTE,@ImportEventMergeMinutes, @EActualUpTime))          
 BEGIN          
  SET @Error_Description='The dates are not continuous.'          
  RETURN          
 END           
              
 IF @Event_Status_ID=@Event_Status_ID_Completed          
 BEGIN          
  --If modular event is completed           
  -- check HOLDING_EVENT.Up_Time=EVENT.Actual_Down_Time          
  IF @Actual_Down_Time<=@EActualDownTime AND          
  DATEADD(MINUTE,@ImportEventMergeMinutes, @Actual_Up_Time)>=@EActualDownTime          
  BEGIN          
   --THE DATES ARE continuous          
   SET @Error_Description=NULL          
  END          
  ELSE          
  --check HOLDING_EVENT.DownTime=EVENT.Actual_Up_Time          
  BEGIN          
   IF @Actual_Down_Time>=@EActualDownTime AND          
   @Actual_Down_Time<=DATEADD(MINUTE,@ImportEventMergeMinutes, @EActualUpTime)          
   BEGIN          
    --THE DATES ARE continuous          
    SET @Error_Description=NULL          
   END          
   ELSE          
   BEGIN          
    --THE DATES ARE NOT CONTINIOUS          
    SET @Error_Description='The dates are not continuous.'          
    RETURN          
   END          
  END          
 END          
END          
          
IF ISNULL(@Error_Description,'')<>'' RETURN          
          
--If event has MM events linked to it select the min down time          
--The check that the dates are continious has been performed earlier          
          
SELECT @Actual_Down_Time=MIN(Down_Time),@Actual_Up_Time=MAX(Up_Time) FROM          
HOLDING_EVENT HE          
WHERE Event_Id=@Event_Id OR Holding_Event_Id=@Holding_Event_Id          
          
IF @Event_Status_ID=@Event_Status_ID_InProgress SET @Actual_Up_Time=GETDATE()          
          
/*VV CR9000*/          
SET @Actual_Down_Time=dbo.FORMAT_DAY_MONTH_YEAR_HRS_MIN_F(@Actual_Down_Time)       
SET @Actual_Up_Time=dbo.FORMAT_DAY_MONTH_YEAR_HRS_MIN_F(@Actual_Up_Time)          
          
--downtime allocations          
--Find SUM of existing DTA hours          
SELECT @DTA_Hours=SUM(Actual_Hours) FROM DOWN_TIME_ALLOCATION WHERE Event_ID = @Event_ID AND Primary_DTA = 0          
          
SET @DTA_Hours=ISNULL(@DTA_Hours,0)          
          
--Calculate the actual hours for primary dta          
SET @DTA_Hours=(CONVERT(float,@Actual_Up_Time) - CONVERT(float,@Actual_Down_Time))*24.00 - @DTA_Hours          
          
IF @DTA_Hours<0          
BEGIN          
 SET @Error_Description='The sum total of down time allocation hours is greater than total downtime of the event.'          
 RETURN          
END          
          
IF EXISTS(SELECT T.Task_ID           
 FROM           
 TASK T             
  LEFT OUTER JOIN          
 DEFERRED_TASK DT           
  ON T.Event_ID = DT.Event_ID AND T.Task_ID = DT.Task_ID          
 WHERE          
 (DT.Deferred_Task_ID IS NULL)  AND          
 (T.Event_ID=@Event_ID) AND           
 (T.Task_Status_ID = @Task_Status_ID_InProgress OR           
 T.Task_Status_ID=@Task_Status_ID_Completed OR          
 T.Task_Status_ID=@Task_Status_ID_YTS) AND          
 (T.Work_Order_ID IS NOT NULL))          
BEGIN          
          
 SET @tasks = ''          
           
 SELECT @tasks = @tasks + CAST(T.Task_ID AS varchar) + ','          
 FROM           
 TASK T             
  LEFT OUTER JOIN          
 DEFERRED_TASK DT           
  ON T.Event_ID = DT.Event_ID AND T.Task_ID = DT.Task_ID          
 WHERE          
 (DT.Deferred_Task_ID IS NULL)  AND          
 (T.Event_ID=@Event_ID) AND           
 (T.Task_Status_ID = @Task_Status_ID_InProgress OR           
 T.Task_Status_ID=@Task_Status_ID_Completed OR          
 T.Task_Status_ID=@Task_Status_ID_YTS) AND          
 (T.Work_Order_ID IS NOT NULL)          
           
 SELECT @tasks = (SELECT CAST(T.Task_ID AS varchar)+','          
 FROM           
 TASK T             
  LEFT OUTER JOIN          
 DEFERRED_TASK DT           
  ON T.Event_ID = DT.Event_ID AND T.Task_ID = DT.Task_ID          
 WHERE          
 (DT.Deferred_Task_ID IS NULL)  AND          
 (T.Event_ID=@Event_ID) AND           
 (T.Task_Status_ID = @Task_Status_ID_InProgress OR           
 T.Task_Status_ID=@Task_Status_ID_Completed OR          
 T.Task_Status_ID=@Task_Status_ID_YTS) AND          
 (T.Work_Order_ID IS NOT NULL)          
   FOR XML PATH('') )          
             
 IF @tasks<>'' SET @tasks=LEFT(@tasks,LEN(@tasks)-1)          
           
END 

/*JW E813*/
SELECT @Component_Code_ID = CC.ComponentCodeID, @Task_Type_ID = TT.TaskTypeID 
FROM HOLDING_EVENT HE 
LEFT JOIN dbo.tblComponentCodes CC ON HE.ComponentCode = CC.Code
LEFT JOIN dbo.tblTaskTypes TT ON HE.TaskType = TT.Code
WHERE Holding_Event_Id = @Holding_Event_Id

SELECT         
@Component_Code_Id = ISNULL(@Component_Code_Id,Component_Code_ID),          
@Task_Type_Id = ISNULL(@Task_Type_Id,Task_Type_ID),        
@Modifier_ID = Modifier_ID,        
@Application_Code_ID = Application_Code_ID        
FROM                     
DEFERRED_TASK DT             
 RIGHT OUTER JOIN            
TASK T             
 ON DT.Task_ID = T.Task_ID AND DT.Event_ID = T.Event_ID            
WHERE            
(DT.Deferred_Task_ID IS NULL)  AND            
(T.Event_ID=@Event_ID) AND             
(T.Task_Status_ID = @Task_Status_ID_InProgress OR             
T.Task_Status_ID=@Task_Status_ID_Completed OR            
T.Task_Status_ID=@Task_Status_ID_YTS)        
 AND T.Primary_Cause = 1
         
          
          
SET XACT_ABORT ON          
          
BEGIN TRANSACTION          
-- Update Event           
Update EVENT Set          
Event_Status_ID=@Event_Status_ID,           
Actual_Down_Time=@Actual_Down_Time,           
Actual_Up_Time=@Actual_Up_Time,           
Last_Mod_By_User_ID=@Last_Mod_By_User_ID,          
Last_Mod_Date=getdate()          
Where Event_ID=@Event_ID          
          
-- Update Down Time allocations          
          
/*VV CR9000*/          
EXEC DTA_HOURS_UPDATE_P @EventId=@Event_ID          
          
/*Update DOWN_TIME_ALLOCATION Set          
Actual_Hours=@DTA_Hours,           
Planned_Hours=0,          
Last_Mod_By_User_ID=@Last_Mod_By_User_ID,          
Last_Mod_Date=getdate()          
WHERE (Event_ID=@Event_ID) AND (Primary_DTA=1)*/          

--Update Task_Header  /*JW E813*/    
EXEC TASK_HEADER_MANAGER_P   @Component_Code_ID,  @Modifier_ID,  @Task_Type_ID,  @Application_Code_ID, @Task_Header_Id OUTPUT
          
--Update Task          
IF EXISTS(SELECT Event_ID FROM HOLDING_EVENT WHERE Event_ID=@Event_ID)          
BEGIN          
 --DO NOT UPDATE THIS Notification Date when update tasks/events from Modular Mining.          
 UPDATE T            
 SET          
 T.Task_Status_ID=@Task_Status_ID, 
 T.Component_Code_ID = CASE WHEN T.Primary_Cause = 1 THEN @Component_Code_ID ELSE T.Component_Code_ID END, /*JW E813*/
 T.Task_Type_ID = CASE WHEN T.Primary_Cause = 1 THEN @Task_Type_ID ELSE T.Task_Type_ID END,
 T.Task_Header_Id = CASE WHEN T.Primary_Cause = 1 THEN @Task_Header_Id ELSE T.Task_Header_Id END           
 FROM                   
 DEFERRED_TASK DT           
  RIGHT OUTER JOIN          
 TASK T           
  ON DT.Task_ID = T.Task_ID AND DT.Event_ID = T.Event_ID          
 WHERE          
 (DT.Deferred_Task_ID IS NULL)  AND          
 (T.Event_ID=@Event_ID) AND           
 (T.Task_Status_ID = @Task_Status_ID_InProgress OR           
 T.Task_Status_ID=@Task_Status_ID_Completed OR          
 T.Task_Status_ID=@Task_Status_ID_YTS)          
END          
ELSE          
BEGIN          
 --The Notification Date = Date on the Modular Event when create the task          
 UPDATE T            
 SET          
 Task_Status_ID=@Task_Status_ID,           
 Date_Notified=@Notified_Date,
 T.Component_Code_ID = CASE WHEN T.Primary_Cause = 1 THEN @Component_Code_ID ELSE T.Component_Code_ID END, /*JW E813*/
 T.Task_Type_ID = CASE WHEN T.Primary_Cause = 1 THEN @Task_Type_ID ELSE T.Task_Type_ID END,
 T.Task_Header_Id = CASE WHEN T.Primary_Cause = 1 THEN @Task_Header_Id ELSE T.Task_Header_Id END        
 FROM                   
 DEFERRED_TASK DT           
  RIGHT OUTER JOIN          
 TASK T           
  ON DT.Task_ID = T.Task_ID AND DT.Event_ID = T.Event_ID          
 WHERE          
 (DT.Deferred_Task_ID IS NULL)  AND          
 (T.Event_ID=@Event_ID) AND           
 (T.Task_Status_ID = @Task_Status_ID_InProgress OR           
 T.Task_Status_ID=@Task_Status_ID_Completed OR          
 T.Task_Status_ID=@Task_Status_ID_YTS)          
END           
           
IF ISNULL(@tasks,'')<>''          
BEGIN          
 EXEC TASK_WORK_ORDER_LINK_MULTI_P @TasksID=@tasks          
END          
          
UPDATE HOLDING_EVENT SET Event_ID=@Event_ID WHERE HOLDING_EVENT_ID=@HOLDING_EVENT_ID          
          
COMMIT TRANSACTION         
     
   
 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[MODULAR_MINING_EVENT_ADD_TO_NEW_EVENT_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[MODULAR_MINING_EVENT_ADD_TO_NEW_EVENT_P]
GO

create    Procedure [dbo].[MODULAR_MINING_EVENT_ADD_TO_NEW_EVENT_P]  
/******************************************************************************  
 File:   
 Name: MODULAR_MINING_EVENT_ADD_TO_NEW_EVENT_P  
  
 Called By:   
  
 Desc: 1. Add Event for Modula Mining Event  
       2. Return id of the new Event  
               
  
 Auth: Veronika Vasylyeva  
 Date: 2-Oct-2002  
*******************************************************************************  
  Change History  
*******************************************************************************  
 Date:  Author:  Description:  
 -------- -------- ----------------------------------------  
 07 May 2012 JW   E813 Take the select statement out of the transaction
 03 May 2012 JW   E813 Insert Primary DTA with holding event CC &TT  
 03 May 2012 JW   E813 Create task with holding event CC & TT  
 28-Jun-2010 V Vasylyeva CR9000: Downtime allocations calculations  
 29 Mar 10 AL   CR8865: added OH&S  
 30 Oct 2009 V Vasylyeva CR8429: Took out usages calculations  
 10 Feb 09 AL   CR7845: change size of symptom, cause and repair desc + @Planning_Notes to 8,000  
 09-Feb-09 AL   CR7845: Always have 1 operation and labour  
 22 Dec 08 AL   CR7798: Changed TASK.RaisedByID  
 15 Oct 2008 V Vasylyeva Added the defaults for event prevention. The MM events are  
       always created as breakdown events, so the prevention shall  
       be added as well because it is the required field.  
       Also added ChangeoutCategoryId to the task. It is a required field  
 10 Oct 2008 V Vasylyeva fixed parts status  
    DS   Added @PartsStatusRequired,@PartsStatusOrdered,@PartsStatusReady  
 22-May-2008 A Lass.  changed @Planning_Notes to be varchar(MAX)  
  7 Nov 2007 V Vasylyeva Added default workgroups  
 17 Jun 2007 A Lassaun added new defaults  
 14 Nov 06 SI   Changed to support date based tasks  
 18 Oct 2005 V Vasylyeva Added CostBearerID  
 19 Apr 2004 V Vasylyeva Removed Task_Planned  
 09 Feb 2004 V Vasylyeva New defaults for TASK  
     @Parts_Resources_Identified,  
     @Labour_Resources_Identified,  
     @Location_Identified,  
     @Tooling_Resources_Identified,  
 03-Mar-2003 V Vasylyeva Removed Down_Time_Allocation.Variance insert  
 18-Oct-2002 V Vasylyeva Changed Planned_Up_Time=Actual_Down_Time  
  
     17-Oct-2002 V Vasylyeva Changed the defaults for Event, Task,   
     Down_Time_Allocation tables. Now the  
     defaults are coming from stored procedures   
     18 Jul 03 HS   call to add Task Header id  
*******************************************************************************/  
 /* Param List */  
 @Holding_Event_Id int,  
 @New_Event_ID int=0 OUTPUT,  
 @Error_Description varchar(2000)='' OUTPUT,  
 @Create_By_User_ID int=0  
          
    
AS  
  
declare @return_status int  
  
Declare @Event_Status_ID_InProgress int  
Declare @Event_Status_ID_Completed int  
DECLARE @Task_Status_ID_InProgress int  
Declare @Task_Status_ID_Completed int  
  
DECLARE @Task_Mode_ID_GT int  
DECLARE @Event_Mode_ID_GE int   
  
SET @Event_Status_ID_InProgress=2  
SET @Event_Status_ID_Completed=3  
  
SET @Task_Status_ID_InProgress=2  
SET @Task_Status_ID_Completed=3  
  
  
SET @Event_Mode_ID_GE=1  
SET @Task_Mode_ID_GT =1  
  
DECLARE @StartDate datetime -- for equipment start date  
DECLARE @Event_Priority_ID int  
DECLARE @Eqp_Plan_ID int -- search tblEqpPlans  
DECLARE @Event_Status_ID int -- set depending on Actual_Up_Time   
DECLARE @Work_Location_ID int   
DECLARE @Expected_Up_Time datetime   
DECLARE @Confirmed bit   
DECLARE @Event_Prevention_ID int   
DECLARE @Actual_Down_Time datetime   
DECLARE @Actual_Up_Time datetime   
DECLARE @Event_Notes varchar (2500)  
DECLARE @Down_Delay_Notes varchar (1000)  
DECLARE @Down_Delay_Hrs float   
DECLARE @Down_Delay_ID int   
DECLARE @Has_Down_Time bit    
DECLARE @New_Event bit   
DECLARE @Repair_Details varchar(100)   
DECLARE @QUOM_ID int  
    
DECLARE @Task_Description varchar(500)  
DECLARE @Task_Type_ID int  
DECLARE @Component_Code_ID int   
DECLARE @Modifier_ID int   
DECLARE @Application_Code_ID int   
DECLARE @Occurrence_Type_Id int   
DECLARE @Source_ID int   
DECLARE @Task_Status_ID int   
DECLARE @Component_ID varchar(100)   
DECLARE @Symptom_ID int   
DECLARE @Symptom_Notes varchar(8000)  --AL: 10/02/09  
DECLARE @Cause_ID int   
DECLARE @Cause_Notes varchar(8000)  --AL: 10/02/09  
DECLARE @Repair_Code_ID int   
DECLARE @Repair_Notes varchar(8000)  --AL: 10/02/09  
DECLARE @Group_No varchar(50)   
DECLARE @Part_No varchar(50)   
DECLARE @Task_EMI_Ref varchar(50)   
DECLARE @Redo bit  
DECLARE @Task_Planned_Time_ID int   
DECLARE @Customer_Ref varchar(100)   
DECLARE @Employee_ID int   
DECLARE @Expected_Duration float   
DECLARE @Expected_Labor_Hours float   
DECLARE @Planning_Notes varchar(8000) --AL: 22/05/08, 10/02/09  
DECLARE @Work_Order varchar(50)   
DECLARE @Actual_Duration float   
DECLARE @Actual_Labor_Hrs float   
DECLARE @Primary_Cause bit   
DECLARE @Task_Notes varchar(1000)  
DECLARE @ChangeoutCategoryId int  
DECLARE @PartsStatusRequired bit  
DECLARE @PartsStatusOrdered bit  
DECLARE @PartsStatusReady bit  
DECLARE @Labour_Resources_Identified bit  
DECLARE @Location_Identified bit   
DECLARE @Tooling_Resources_Identified bit  
DECLARE @RaisedByID int  
DECLARE @Task_Priority_ID int  
DECLARE @Variance_Cause_ID int   
DECLARE @Responsibility_ID int   
DECLARE @Planned_Hours real   
DECLARE @Actual_Hours real   
DECLARE @Variance real   
DECLARE @DTA_Notes varchar(500)  
DECLARE @DTA_EMI_Ref varchar(50)  
DECLARE @Primary_DTA bit  
DECLARE @CostBearerID int  
DECLARE @SiteId int  
DECLARE @BranchId int  
DECLARE @CostCentreID int  
DECLARE @PartsEDCID int  
DECLARE @LabourEDCID int  
DECLARE @MiscEDCID int  
DECLARE @CustomerID int  
DECLARE @AMTPlanningModeId int  
DECLARE @TaskModeID int  
DECLARE @WorkGroupId int  
DECLARE @Health_Safety_ID int  
  
IF EXISTS(SELECT Holding_Event_Id FROM HOLDING_EVENT WHERE Holding_Event_Id=@Holding_Event_Id  
 AND Event_Id>0)  
BEGIN  
 SET @Error_Description='Downtime Event has already been linked.'  
 RETURN  
END  
  
-- Find EqpPlan_ID  
SET @Eqp_Plan_ID =(SELECT tblEqpPlans.EqpPlanId FROM HOLDING_EVENT INNER JOIN  
                   tblEqpPlans ON HOLDING_EVENT.Eqp_Name = tblEqpPlans.Modular_Mining_Eqp_Name  
     WHERE HOLDING_EVENT.Holding_Event_Id = @Holding_Event_Id)  
  
  
IF @Eqp_Plan_ID Is NULL  
 BEGIN  
  -- The modular mining equipment name is not found in tblEqpPlans  
  SET @Error_Description='Equipment name does not have a corresponding Equipment Plan.'  
  RETURN  
 END  
-- Find Equipment Start date  
SET @StartDate=(SELECT StartDate FROM tblEqpPlans WHERE EqpPlanID=@Eqp_Plan_ID)  
  
--Check Actual Down time. If it is less than Equipment start date - it is a mistake  
IF EXISTS (SELECT  *  FROM  HOLDING_EVENT WHERE (Down_Time<@StartDate) AND (HOLDING_EVENT.Holding_Event_Id = @Holding_Event_Id))  
 BEGIN  
  SET @Error_Description='Actual Down time can''t be less than Equipment start date '   
  + CONVERT(varchar(50),@StartDate,106)  
  RETURN  
 END  
  
--Set Event status depending on Actual up time  
-- If Actual Up time is null Event status= in progress  
-- If Actual Up time is not Null Event Status=completed  
  
SELECT @Actual_Up_Time= Up_Time,@Actual_Down_Time=Down_Time ,@Task_Description= ISNULL(Code,'') + ' - ' + ISNULL(Code_Description,'')  
FROM  HOLDING_EVENT WHERE HOLDING_EVENT.Holding_Event_Id = @Holding_Event_Id  
  
IF @Actual_Up_Time IS NULL  
 BEGIN  
  -- If Actual Up time is null Event status= in progress  
  SET @Event_Status_ID=@Event_Status_ID_InProgress  
  SET @Task_Status_ID=@Task_Status_ID_InProgress  
 END  
ELSE  
 BEGIN  
  --Check Actual Down time. If it less than Equipment start date - it is a mistake  
  IF @Actual_Up_Time<@StartDate  
   BEGIN  
    SET @Error_Description='Actual Up time can''t be less than Equipment start date '   
    + CONVERT(varchar(50),@StartDate,13)  
    RETURN  
   END  
    
  -- If Actual Up time is not Null Event Status=completed  
  SET @Event_Status_ID=@Event_Status_ID_Completed  
  SET @Task_Status_ID=@Task_Status_ID_Completed  
 END  
   
/*VV CR9000*/  
SET @Actual_Down_Time=dbo.FORMAT_DAY_MONTH_YEAR_HRS_MIN_F(@Actual_Down_Time)  
SET @Actual_Up_Time=dbo.FORMAT_DAY_MONTH_YEAR_HRS_MIN_F(@Actual_Up_Time)  
  
--There can only be one In Progress event at a time for a piece of Equipment  
IF @Event_Status_ID=@Event_Status_ID_InProgress  
 BEGIN  
  set @return_status=0  
  EXEC @return_status = EVENT_STATUS_CHECK_P @Eqp_Plan_ID   
        
  IF @return_status>0  
   BEGIN  
    SET @Error_Description='There can only be one In Progress event at a time for a piece of Equipment.'  
    RETURN   
   END  
 END  
  
EXEC EVENT_GET_DEFAULTS_P @Eqp_Plan_ID, @QUOM_Id OUTPUT , NULL , Null , Null , @Event_Priority_ID OUTPUT   
  
  
--Set Defaults for Event  
  
SET @Expected_Up_Time=DATEADD(Hour, 1, @Actual_Down_Time)  
IF (@Expected_Up_Time < DATEADD(Hour, 1, GETDATE()))   
 BEGIN   
  SET @Expected_Up_Time = DATEADD(Hour, 1, GETDATE())  
 END  
SET @Confirmed =0   
SET @Has_Down_Time =1    
SET @New_Event =1   
SELECT @Event_Prevention_ID=Event_Prevention_ID from Event_Prevention WHERE Default_Record=1  
  
--Set defaults for TASK  
SET @Redo =0  
SET @Expected_Duration =0   
SET @Expected_Labor_Hours =0   
SET @Actual_Duration =0   
SET @Actual_Labor_Hrs =0   
SET @Primary_Cause =1   
  
EXEC TASK_GET_DEFAULTS_P   
@BacklogTask=0 ,   
@Symptom_ID=@Symptom_ID OUTPUT ,  
@Cause_ID=@Cause_ID OUTPUT ,   
@Repair_Code_ID=@Repair_Code_ID OUTPUT ,   
@Priority_ID=@Task_Priority_ID OUTPUT ,   
@Task_Type_ID=@Task_Type_ID OUTPUT ,   
@Component_Code_ID=@Component_Code_ID OUTPUT ,   
@Modifier_ID=@Modifier_ID OUTPUT ,   
@Application_Code_ID=@Application_Code_ID OUTPUT ,   
@Occurrence_Type_Id=@Occurrence_Type_Id OUTPUT,  
@PartsStatusRequired=@PartsStatusRequired OUTPUT,  
@PartsStatusOrdered=@PartsStatusOrdered/*@PartsStatusRequired*/ OUTPUT,  
@PartsStatusReady=@PartsStatusReady/*@PartsStatusRequired*/ OUTPUT,  
@Labour_Resources_Identified=@Labour_Resources_Identified OUTPUT,  
@Location_Identified=@Location_Identified OUTPUT,  
@Tooling_Resources_Identified=@Tooling_Resources_Identified OUTPUT,  
@EqpPlanID=@Eqp_Plan_ID,  
@CostBearerID=@CostBearerID OUTPUT,  
--AL: 17/06/07  
@SiteId =@SiteId OUTPUT,  
@BranchId =@BranchId OUTPUT,  
@CostCentreID =@CostCentreID OUTPUT,  
@PartsEDCID =@PartsEDCID OUTPUT,  
@LabourEDCID =@LabourEDCID OUTPUT,  
@MiscEDCID =@MiscEDCID OUTPUT,  
@CustomerID =@CustomerID OUTPUT,  
@AMTPlanningModeId =@AMTPlanningModeId OUTPUT,  
@Task_Mode_ID=@TaskModeID OUTPUT,  
@Source_ID=@Source_ID OUTPUT,  
@WorkGroupId=@WorkGroupId OUTPUT  
  
SELECT @ChangeoutCategoryId=ChangeoutCategoryId from CHANGEOUT_CATEGORY WHERE DefaultRecord=1  
  
--AL: 29/03/10  
SELECT @Health_Safety_ID=Health_Safety_ID FROM HEALTH_SAFETY WHERE DefaultRecord <> 0  
  
--Set defaults for Down_Time_Allocation  
SET @Planned_Hours =0  
/*VV CR9000*/  
IF @Actual_Up_Time IS NULL SET @Actual_Up_Time=dbo.FORMAT_DAY_MONTH_YEAR_HRS_MIN_F(GETDATE())  
SET @Actual_Hours=(CONVERT(float,@Actual_Up_Time)-CONVERT(float,@Actual_Down_Time))*24.00  
  
SET @Variance = @Planned_Hours - @Actual_Hours  
SET @Primary_DTA =1  
EXEC DOWN_TIME_ALLOCATIONS_GET_DEFAULTS_P Null , Null , @Variance_Cause_ID OUTPUT , Null , @Task_Type_ID OUTPUT , Null , @Responsibility_ID OUTPUT    

/*JW E813*/
--Get ComponentCode and Tasktype by Holding_Event_id  
SELECT @Component_Code_ID =ISNULL(CC.ComponentCodeID,@Component_Code_ID),
@Task_Type_ID = ISNULL(TT.TaskTypeID, @Task_Type_ID)
FROM HOLDING_EVENT HE
LEFT JOIN dbo.tblComponentCodes CC ON HE.ComponentCode = CC.Code
LEFT JOIN dbo.tblTaskTypes TT ON HE.TaskType = TT.Code
WHERE Holding_Event_Id = @Holding_Event_Id      


  
SET XACT_ABORT ON  
  
BEGIN TRANSACTION  
  
Insert Into EVENT (  
 Eqp_Plan_ID,    
 Description,   
 Event_Status_ID,   
 Priority_ID,   
 Work_Location_ID,   
 Planned,   
 Break_Down,   
 Expected_Up_Time,   
 Confirmed,   
 Event_Prevention_ID,   
    Planned_Down_Time,   
 Planned_Up_Time,   
 Actual_Down_Time,   
 Actual_Up_Time,   
    Notes,   
 Down_Delay_Notes,   
 Down_Delay_Hrs,   
 Down_Delay_ID,   
 Event_Mode_ID,   
 Has_Down_Time,     
 New_Event,    
 Repair_Details,    
 QUOM_ID,  
 Last_Mod_By_User_ID,        
 Last_Mod_Date,   
    Create_By_User_ID,  
 Create_Date)  
SELECT   
 @Eqp_Plan_ID,    
 ISNULL(HOLDING_EVENT.Description,HOLDING_EVENT.Code_Description),   
 @Event_Status_ID,   
 @Event_Priority_ID,   
 @Work_Location_ID,  
 CASE PlanType WHEN 1 THEN 1 ELSE 0 END AS Planned,  
 CASE PlanType WHEN 2 THEN 1 ELSE 0 END AS Break_Down,   
 @Expected_Up_Time,   
 @Confirmed,   
 @Event_Prevention_ID,   
    @Actual_Down_Time,   
 @Actual_Down_Time,   
 @Actual_Down_Time,   
 @Actual_Up_Time,   
    @Event_Notes,   
 @Down_Delay_Notes,   
 @Down_Delay_Hrs,  
 @Down_Delay_ID,   
 @Event_Mode_ID_GE,   
 @Has_Down_Time,     
 @New_Event,    
 @Repair_Details,    
 @QUOM_ID,        
 @Create_By_User_ID,  
 getdate(),   
 @Create_By_User_ID,  
 getdate()  
FROM HOLDING_EVENT WHERE HOLDING_EVENT_ID=@HOLDING_EVENT_ID  
  
SET @New_Event_ID=SCOPE_IDENTITY()    
   
DECLARE  @Task_Header_Id as int  
EXEC TASK_HEADER_MANAGER_P   @Component_Code_ID,  @Modifier_ID,  @Task_Type_ID,  @Application_Code_ID, @Task_Header_Id output  
  
INSERT INTO   
TASK   
(  
Event_ID,   
Description,   
Eqp_Plan_ID,   
Task_Type_ID,   
Component_Code_ID,   
Modifier_ID,   
Application_Code_ID,   
Occurrence_Type_Id,   
Priority_ID,   
Source_ID,   
Task_Status_ID,   
Date_Notified,   
Component_ID,   
Symptom_ID,   
Symptom_Notes,   
Cause_ID,   
Cause_Notes,   
Repair_Code_ID,   
Repair_Notes,   
Group_No,   
Part_No,   
EMI_Ref,   
Redo,   
Task_Planned_Time_ID,   
Customer_Ref,   
employee_ID,   
Expected_Duration,   
Expected_Labor_Hours,   
Planning_Notes,   
Work_Order,   
Actual_Duration,   
Actual_Labor_Hrs,   
Primary_Cause,   
Notes,  
Task_Mode_ID,  
PartsStatusRequired,  
PartsStatusOrdered,  
PartsStatusReady,  
Labour_Resources_Identified,  
Location_Identified,  
Tooling_Resources_Identified,  
RaisedByID,  
Last_Mod_By_User_ID,  
Last_Mod_Date,  
Create_By_User_ID,  
Create_Date,  
Task_Header_Id,  
Cost_Bearer_ID,  
Site_Id,  
Branch_Id,  
Cost_Centre_ID,  
Part_Entry_Distribution_Code_Id,  
Labour_Entry_Distribution_Code_Id,  
Misc_Entry_Distribution_Code_Id,  
Customer_ID,  
AMTPlanningModeId,  
Work_Group_Id,  
Def_Work_Group_Id,  
ChangeoutCategoryId,  
--AL: 29/03/10  
Health_Safety_Id,  
LastNotified  
)  
  
SELECT  
  
@New_Event_ID,   
@Task_Description,   
@Eqp_Plan_ID,   
@Task_Type_ID,   
@Component_Code_ID,   
@Modifier_ID,   
@Application_Code_ID,   
@Occurrence_Type_Id,   
@Task_Priority_ID,   
@Source_ID,   
@Task_Status_ID,   
HOLDING_EVENT.Notified_Date,   
@Component_ID,   
@Symptom_ID,   
@Symptom_Notes,   
@Cause_ID,   
@Cause_Notes,   
@Repair_Code_ID,   
@Repair_Notes,   
@Group_No,   
@Part_No,   
@Task_EMI_Ref,   
@Redo,   
@Task_Planned_Time_ID,   
@Customer_Ref,   
@employee_ID,   
@Expected_Duration,   
@Expected_Labor_Hours,   
@Planning_Notes,   
@Work_Order,   
@Actual_Duration,   
@Actual_Labor_Hrs,   
@Primary_Cause,   
@Task_Notes,  
@TaskModeID,  
@PartsStatusRequired,  
@PartsStatusOrdered,  
@PartsStatusReady,  
@Labour_Resources_Identified,  
@Location_Identified,  
@Tooling_Resources_Identified,  
@RaisedByID,  
@Create_By_User_ID,  
getdate(),  
@Create_By_User_ID,  
getdate(),  
@Task_Header_Id,  
@CostBearerID,  
@SiteId,  
@BranchId,  
@CostCentreID,  
@PartsEDCID,  
@LabourEDCID,  
@MiscEDCID,  
@CustomerID,  
@AMTPlanningModeId,  
@WorkGroupId AS Work_Group_Id,  
@WorkGroupId AS Def_Work_Group_Id,  
@ChangeoutCategoryId,  
--AL: 29/03/10  
@Health_Safety_ID,  
GETDATE()  
  
FROM HOLDING_EVENT WHERE HOLDING_EVENT_ID=@HOLDING_EVENT_ID  
  
--AL: 09/02/09  
DECLARE @TaskID int  
SET @TaskID = SCOPE_IDENTITY()  
EXEC TASK_OPERATION_CHECK_ADD_P @TaskID=@TaskID,@Message=@Error_Description OUTPUT  
  
INSERT INTO   
DOWN_TIME_ALLOCATION   
(Event_ID,   
Variance_Cause_ID,   
Task_Type_ID,   
ComponentCodeId,  
Responsibility_ID,   
Planned_Hours,   
Actual_Hours,  
Notes,   
EMI_Ref,  
Primary_DTA,  
Last_Mod_By_User_ID,  
Last_Mod_Date,  
Create_By_User_ID,  
Create_Date)  
VALUES  
(  
@New_Event_ID,   
@Variance_Cause_ID,   
@Task_Type_ID,   
@Component_Code_ID,  
@Responsibility_ID,   
@Planned_Hours,   
@Actual_Hours,   
@DTA_Notes,   
@DTA_EMI_Ref,  
@Primary_DTA,  
@Create_By_User_ID,  
getdate(),  
@Create_By_User_ID,  
getdate()  
)  
  
UPDATE HOLDING_EVENT SET Event_ID=@New_Event_ID WHERE HOLDING_EVENT_ID=@HOLDING_EVENT_ID  
  
COMMIT TRANSACTION  



GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[RPT_PARTS_DEMAND_ANALYSIS_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[RPT_PARTS_DEMAND_ANALYSIS_P]
GO



CREATE Procedure [dbo].[RPT_PARTS_DEMAND_ANALYSIS_P]
/******************************************************************************
	File: RPT_PARTS_DEMAND_ANALYSIS_P.sql
	Name: RPT_PARTS_DEMAND_ANALYSIS_P

	Called By: 

	Desc: 

	Auth: Alex Lassauniere
	Date: 01 Apr 2009
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------
	08 May 12   JW			4114 Change @groupby != NULL to IS NOT NULL
	16 Apr 12   GD          E792 additional analyse by
	
	--OLD COMMENTS
	02/06/09	AL			CR8218: fixed @ProjHeaderID
	14/04/11	GD			Fixed Issue 1459
	17/06/11	GD			Fixed isue 1657
	19/08/11    GD          Fixed issue #2305
*******************************************************************************/
	/* Param List */
	@StartDate int = 200904,
	@EndDate int = 201003,

	@GroupBy varchar(MAX)='',
	@AnalyseBy varchar(MAX)='',
	@CalculationOption int=0,	--0: Eqp, 1: Dealer, 2: Factory

	@BranchId varchar(MAX)='',
	@SiteID varchar(MAX)='',
	@FleetID varchar(MAX)='',
	@EqpClassId varchar(MAX)='',
	@EqpGroupId varchar(MAX)='',
	@ManufacturerId varchar(MAX)='',
	@ModelID varchar(MAX)='',
	@EqpPlanID varchar(MAX)='',
	@RegionId varchar(MAX)='',
	@DivisionId varchar(MAX)='',
	@EqpCriticalityId varchar(MAX)='',
	@EqpLocationId varchar(MAX)='',
	@EqpCategoryId varchar(MAX)='',
	@EqpCostCentreID varchar(MAX)='',
	@CostResponsibilityID varchar(MAX)='',
	@ContractID varchar(MAX)='',
	@ContractTypeID varchar(MAX)='',
	@ProjHeaderID varchar(MAX)='',
	@ParentEquipmentID varchar(MAX)='',

	@CostTypeID varchar(MAX)='',
	@SystemID varchar(MAX)='',
	@SubSystemID varchar(MAX)='',
	@TaskHeaderId varchar(MAX)='',
	@TaskTypeID varchar(MAX)='',
	@ComponentCodeID varchar(MAX)='',
	@modifierID varchar(MAX)='',
	@CostBearerID varchar(MAX)='',
	@PartTypeID varchar(MAX)='',
	@PartManufacturerID varchar(MAX)='',
	@PrimaryPartNoID varchar(MAX)='',
    @SalesResponsibilityID varchar(MAX)='',
    
    --GD #1657
    @IsCrossTab BIT=0,
    @PartClassificationId Varchar(MAX) = ''  ,
	@PartRatingId Varchar(MAX) = ''  ,
	@PrimaryPartNumberId Varchar(MAX) = ''  ,
	@RebuildLocationId Varchar(MAX) = ''  ,
	@ReviewStatusId Varchar(MAX) = ''  ,
	@SalesStatusId Varchar(MAX) = '' 
AS  
  
--1: get tasks and group bys  
DECLARE @GroupBy1 varchar(10),@GroupBy2 varchar(10),@GroupBy3 varchar(10),@GroupBy4 varchar(10),@Pos int,@Temp varchar(10)  
  
--GD  added to fix fixed issue #1657  
DECLARE @SelectQueryForCrossTab VARCHAR(Max)  
DECLARE @OrderByCrossTab VARCHAR(Max)  
  
SET @SelectQueryForCrossTab=''  
SET @OrderByCrossTab =''  
  
  
WHILE @GroupBy<>''  
BEGIN  
 SET @Pos=CHARINDEX(',',@GroupBy)  
 IF ISNULL(@Pos,0)=0  
 BEGIN  
  SET @Temp=@GroupBy  
  SET @GroupBy=''  
 END  
 ELSE  
 BEGIN  
  SET @Temp=LEFT(@GroupBy,@Pos-1)  
  SET @GroupBy=RIGHT(@GroupBy,LEN(@GroupBy)-@Pos)  
 END  
   
 IF @GroupBy1 IS NULL  
  SET @GroupBy1=@Temp  
 ELSE IF @GroupBy2 IS NULL  
  SET @GroupBy2=@Temp  
 ELSE IF @GroupBy3 IS NULL  
  SET @GroupBy3=@Temp  
 ELSE   
  SET @GroupBy4=@Temp  
   
END  
  
--SELECT @GroupBy1,@GroupBy2,@GroupBy3,@GroupBy4  
  
CREATE TABLE #TASK (ProjTaskID int Primary Key,EqpPlanID int,  
 PctPurchasePart float,PctPurchaseNewPart float,  
 GroupByID1 int, GroupBy1 varchar(100) COLLATE database_default,  
 GroupByID2 int, GroupBy2 varchar(100) COLLATE database_default,  
 GroupByID3 int, GroupBy3 varchar(100) COLLATE database_default,  
 GroupByID4 int, GroupBy4 varchar(100) COLLATE database_default)  


  
 --Next Due records 
INSERT INTO #TASK(ProjTaskID,EqpPlanID,PctPurchasePart,PctPurchaseNewPart,  
    GroupByID1, GroupBy1,GroupByID2, GroupBy2,  
    GroupByID3, GroupBy3,GroupByID4, GroupBy4)  
  SELECT -PT.ProjTaskId,EH.EqpPlanID,PT.PctPurchasePart/100,PT.PctPurchaseNewPart/100,  
  CASE @GroupBy1  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id)  --Primary Part No  
   WHEN 'PPDS' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part number     
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp 
   WHEN 'PACL' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId, PT.PartClassificationId) --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,PT.DefaultLocationForRebuild) --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status
   ELSE NULL  
  END AS GroupByID1,  
  CASE @GroupBy1  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.Part WHEN ISNULL(PT.Part_Id,0)>0 THEN P.Part ELSE '[NONE]' END  --Primary Part No     
   WHEN 'PPDS' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.PartDescription WHEN ISNULL(PT.Part_Id,0)>0 THEN P.PartDescription ELSE '[NONE]' END --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp
   
   WHEN 'PACL' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId,0)>0 THEN NextDuePCL.PartClassification WHEN ISNULL(PT.PartClassificationId,0)>0 THEN PC.PartClassification ELSE '[NONE]' END  --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,0)>0 THEN NextDueRL.Site WHEN ISNULL(PT.DefaultLocationForRebuild,0)>0 THEN RL.Site ELSE '[NONE]' END -- Rebuild Location --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status  
   ELSE NULL  
  END AS GroupBy1,  
  CASE @GroupBy2  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part No  
   WHEN 'PPDS' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part Description  
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp
   WHEN 'PACL' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId, PT.PartClassificationId) --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,PT.DefaultLocationForRebuild) --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status
   ELSE NULL  
  END AS GroupByID2,  
  CASE @GroupBy2  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.Part WHEN ISNULL(PT.Part_Id,0)>0 THEN P.Part ELSE '[NONE]' END   WHEN 'PPDS' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.PartDescription WHEN ISNULL(PT.Part_Id,0)>0 THEN P.PartDescription ELSE '[NONE]' END --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp
  WHEN 'PACL' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId,0)>0 THEN NextDuePCL.PartClassification WHEN ISNULL(PT.PartClassificationId,0)>0 THEN PC.PartClassification ELSE '[NONE]' END    --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,0)>0 THEN NextDueRL.Site WHEN ISNULL(PT.DefaultLocationForRebuild,0)>0 THEN RL.Site ELSE '[NONE]' END -- Rebuild Location --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status  
   ELSE NULL  
  END AS GroupBy2,  
  CASE @GroupBy3  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part No  
   WHEN 'PPDS' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part Description  
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp
    WHEN 'PACL' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId, PT.PartClassificationId) --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,PT.DefaultLocationForRebuild) --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status
   ELSE NULL  
  END AS GroupByID3,  
  CASE @GroupBy3  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.Part WHEN ISNULL(PT.Part_Id,0)>0 THEN P.Part ELSE '[NONE]' END
   WHEN 'PPDS' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.PartDescription WHEN ISNULL(PT.Part_Id,0)>0 THEN P.PartDescription ELSE '[NONE]' END --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp
       WHEN 'PACL' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId,0)>0 THEN NextDuePCL.PartClassification WHEN ISNULL(PT.PartClassificationId,0)>0 THEN PC.PartClassification ELSE '[NONE]' END    --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,0)>0 THEN NextDueRL.Site WHEN ISNULL(PT.DefaultLocationForRebuild,0)>0 THEN RL.Site ELSE '[NONE]' END -- Rebuild Location --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status  
   ELSE NULL  
  END AS GroupBy3,  
  CASE @GroupBy4  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part No  
   WHEN 'PPDS' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part Description  
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp
    WHEN 'PACL' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId, PT.PartClassificationId) --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,PT.DefaultLocationForRebuild) --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status  
   ELSE NULL  
  END AS GroupByID4,  
  CASE @GroupBy4  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.Part WHEN ISNULL(PT.Part_Id,0)>0 THEN P.Part ELSE '[NONE]' END --Primary Part No  
   WHEN 'PPDS' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.PartDescription WHEN ISNULL(PT.Part_Id,0)>0 THEN P.PartDescription ELSE '[NONE]' END --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp  
      WHEN 'PACL' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId,0)>0 THEN NextDuePCL.PartClassification WHEN ISNULL(PT.PartClassificationId,0)>0 THEN PC.PartClassification ELSE '[NONE]' END    --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,0)>0 THEN NextDueRL.Site WHEN ISNULL(PT.DefaultLocationForRebuild,0)>0 THEN RL.Site ELSE '[NONE]' END -- Rebuild Location --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status  
   ELSE NULL  
  END AS GroupBy4  
  
FROM           
  tblProjTaskOpts AS PTO LEFT OUTER JOIN  
  tblProjTaskAmts AS PTA ON PTO.ProjTaskOptId = PTA.ProjTaskOptId RIGHT OUTER JOIN  
  EQUIPMENT_HIERARCHY_V AS EH INNER JOIN  
  tblProjTasks AS PT ON EH.EqpProjId = PT.EqpProjId INNER JOIN  
  TASK_HEADER AS TH ON PT.Task_Header_ID=TH.Task_Header_ID INNER JOIN  
  COMPONENT_HIERARCHY_V AS CH ON PT.ComponentCodeId = CH.ComponentCodeID INNER JOIN  
  tblTaskTypes AS TT ON PT.TaskTypeId = TT.TaskTypeID INNER JOIN  
  tblModifierCodes AS MC ON PT.ModifierId = MC.ModifierID ON PTO.ProjTaskId = PT.ProjTaskId LEFT OUTER JOIN  
  tblManufacturers AS M ON PT.ManufacturerId = M.ManufacturerId LEFT OUTER JOIN  
  tblPartTypes AS PTY INNER JOIN  
  tblParts AS P ON PTY.PartTypeId = P.Part_Type_ID ON PT.Part_Id = P.PartId LEFT OUTER JOIN  
  EMPLOYEE E ON E.Employee_ID=PT.SalesResponsibilityID  LEFT JOIN
  dbo.NEXT_OCC_STRATEGY ON PT.ProjTaskId = NEXT_OCC_STRATEGY.Proj_Task_Id LEFT JOIN
  PART_CLASSIFICATION PC ON PC.PartClassificationId = PT.PartClassificationId LEFT JOIN 
  dbo.PART_RATING PR ON PR.PartRatingId = PT.PartRatingId LEFT JOIN 
  dbo.REVIEW_STATUS RS ON RS.ReviewStatusID = PT.ReviewStatusID LEFT JOIN
  dbo.SALES_STATUS SS ON SS.SalesStatusId = dbo.NEXT_OCC_STRATEGY.SalesStatusId LEFT JOIN                      
  dbo.tblParts NextDueParts ON dbo.NEXT_OCC_STRATEGY.PEXPartId = NextDueParts.PartId LEFT JOIN  
  dbo.tblSites RL ON RL.SiteId = ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,PT.DefaultLocationForRebuild) LEFT JOIN
  dbo.PART_CLASSIFICATION NextDuePCL ON NEXT_OCC_STRATEGY.PEXPartTypeId = NextDuePCL.PartClassificationId LEFT JOIN
  dbo.tblSites NextDueRL ON NextDueRL.SiteId = NEXT_OCC_STRATEGY.PEXRebuildLocationId
  
WHERE       
  (EH.ProjHeaderId = @ProjHeaderID) --AL: 02/06/09  
  AND (PT.Unscheduled=0)  
  AND (EH.BranchId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@BranchId)) OR ISNULL(@BranchId,'')='')  
  AND (EH.SiteId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@SiteID)) OR ISNULL(@SiteID,'')='')  
  AND (EH.FleetId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@FleetID)) OR ISNULL(@FleetID,'')='')  
  AND (EH.Eqp_Class_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpClassId)) OR ISNULL(@EqpClassId,'')='')  
  AND (EH.Equipment_Group_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpGroupId)) OR ISNULL(@EqpGroupId,'')='')  
  AND (EH.ManufacturerId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@ManufacturerId)) OR ISNULL(@ManufacturerId,'')='')  
  AND (EH.ModelId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@ModelID)) OR ISNULL(@ModelID,'')='')  
  AND (EH.EqpPlanId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpPlanID)) OR ISNULL(@EqpPlanID,'')='')  
  AND (EH.Region_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@RegionId)) OR ISNULL(@RegionId,'')='')  
  AND (EH.Division_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@DivisionId)) OR ISNULL(@DivisionId,'')='')  
  AND (EH.Eqp_Criticality_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpCriticalityId)) OR ISNULL(@EqpCriticalityId,'')='')  
  AND (EH.Eqp_Location_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpLocationId)) OR ISNULL(@EqpLocationId,'')='')  
  AND (EH.Eqp_Category_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpCategoryId)) OR ISNULL(@EqpCategoryId,'')='')  
  AND (EH.Cost_Centre_ID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpCostCentreID)) OR ISNULL(@EqpCostCentreID,'')='')  
  AND (EH.Cost_Responsibility_ID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@CostResponsibilityID)) OR ISNULL(@CostResponsibilityID,'')='')  
  AND (EH.ContractId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@ContractID)) OR ISNULL(@ContractID,'')='')  
  AND (EH.ContractTypeID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@ContractTypeID)) OR ISNULL(@ContractTypeID,'')='')  
  
  AND (EH.EqpPlanID IN (SELECT EqpPlanID FROM dbo.EQP_SIBLINGS_F(@ParentEquipmentID)) OR ISNULL(@ParentEquipmentID,'')='')  
  
  AND (CH.CostTypeID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@CostTypeID)) OR ISNULL(@CostTypeID,'')='')  
  AND (CH.SystemID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@SystemID)) OR ISNULL(@SystemID,'')='')  
  AND (CH.SubSystemID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@SubSystemID)) OR ISNULL(@SubSystemID,'')='')  
  AND (PT.Task_Header_ID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@TaskHeaderId)) OR ISNULL(@TaskHeaderId,'')='')  
  AND (PT.TaskTypeId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@TaskTypeID)) OR ISNULL(@TaskTypeID,'')='')  
  AND (PT.ComponentCodeId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@ComponentCodeID)) OR ISNULL(@ComponentCodeID,'')='')  
  AND (PT.ModifierId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@modifierID)) OR ISNULL(@modifierID,'')='')  
  AND (PTA.Cost_Bearer_ID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@CostBearerID)) OR ISNULL(@CostBearerID,'')='')  
  AND (P.Part_Type_ID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PartTypeID)) OR ISNULL(@PartTypeID,'')='')  
  AND (PT.ManufacturerId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PartManufacturerID)) OR ISNULL(@PartManufacturerID,'')='')  
  AND (PT.Part_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PrimaryPartNoID)) OR ISNULL(@PrimaryPartNoID,'')='')  
  AND (PT.SalesResponsibilityID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@SalesResponsibilityID)) OR ISNULL(@SalesResponsibilityID,'')='')  
  AND (PR.PartRatingId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PartRatingId)) OR ISNULL(@PartRatingId,'')='')  
  AND (PT.Part_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PrimaryPartNumberId)) OR ISNULL(@PrimaryPartNumberId,'')='')
  AND (RL.SiteId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@RebuildLocationId)) OR ISNULL(@RebuildLocationId,'')='')
  AND (RS.ReviewStatusID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@ReviewStatusId)) OR ISNULL(@ReviewStatusId,'')='')
  AND (SS.SalesStatusId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@SalesStatusId)) OR ISNULL(@SalesStatusId,'')='')
  AND (PT.PartClassificationId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PartClassificationId)) OR ISNULL(@PartClassificationId,'')='')
  

GROUP BY  
  PT.ProjTaskId,EH.EqpPlanID,PT.PctPurchasePart,PT.PctPurchaseNewPart,  
  CASE @GroupBy1  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part No  
   WHEN 'PPDS' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part Description  
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp
   WHEN 'PACL' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId, PT.PartClassificationId) --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,PT.DefaultLocationForRebuild) --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status   
   ELSE NULL  
  END,  
  CASE @GroupBy1  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.Part WHEN ISNULL(PT.Part_Id,0)>0 THEN P.Part ELSE '[NONE]' END  --Primary Part No  
   WHEN 'PPDS' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.PartDescription WHEN ISNULL(PT.Part_Id,0)>0 THEN P.PartDescription ELSE '[NONE]' END --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp
   WHEN 'PACL' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId,0)>0 THEN NextDuePCL.PartClassification WHEN ISNULL(PT.PartClassificationId,0)>0 THEN PC.PartClassification ELSE '[NONE]' END    --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,0)>0 THEN NextDueRL.Site WHEN ISNULL(PT.DefaultLocationForRebuild,0)>0 THEN RL.Site ELSE '[NONE]' END -- Rebuild Location --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status   
   ELSE NULL  
  END,  
  CASE @GroupBy2  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part No  
   WHEN 'PPDS' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part Description  
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp
   WHEN 'PACL' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId, PT.PartClassificationId) --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,PT.DefaultLocationForRebuild) --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status    
   ELSE NULL  
  END,  
  CASE @GroupBy2  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.Part WHEN ISNULL(PT.Part_Id,0)>0 THEN P.Part ELSE '[NONE]' END  --Primary Part No  
   WHEN 'PPDS' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.PartDescription WHEN ISNULL(PT.Part_Id,0)>0 THEN P.PartDescription ELSE '[NONE]' END --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp
   WHEN 'PACL' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId,0)>0 THEN NextDuePCL.PartClassification WHEN ISNULL(PT.PartClassificationId,0)>0 THEN PC.PartClassification ELSE '[NONE]' END    --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,0)>0 THEN NextDueRL.Site WHEN ISNULL(PT.DefaultLocationForRebuild,0)>0 THEN RL.Site ELSE '[NONE]' END -- Rebuild Location --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status  
   ELSE NULL  
  END,  
  CASE @GroupBy3  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part No  
   WHEN 'PPDS' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part Description  
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp
   WHEN 'PACL' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId, PT.PartClassificationId) --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,PT.DefaultLocationForRebuild) --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status    
   ELSE NULL  
  END,  
  CASE @GroupBy3  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.Part WHEN ISNULL(PT.Part_Id,0)>0 THEN P.Part ELSE '[NONE]' END  --Primary Part No  
   WHEN 'PPDS' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.PartDescription WHEN ISNULL(PT.Part_Id,0)>0 THEN P.PartDescription ELSE '[NONE]' END --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp
   WHEN 'PACL' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId,0)>0 THEN NextDuePCL.PartClassification WHEN ISNULL(PT.PartClassificationId,0)>0 THEN PC.PartClassification ELSE '[NONE]' END    --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,0)>0 THEN NextDueRL.Site WHEN ISNULL(PT.DefaultLocationForRebuild,0)>0 THEN RL.Site ELSE '[NONE]' END -- Rebuild Location --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status  
   ELSE NULL  
  END,  
  CASE @GroupBy4  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part No  
   WHEN 'PPDS' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,PT.Part_Id) --Primary Part Description  
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp
   WHEN 'PACL' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId, PT.PartClassificationId) --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,PT.DefaultLocationForRebuild) --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status    
   ELSE NULL  
  END,  
  CASE @GroupBy4  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.Part WHEN ISNULL(PT.Part_Id,0)>0 THEN P.Part ELSE '[NONE]' END  --Primary Part No  
   WHEN 'PPDS' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartId,0)>0 THEN NextDueParts.PartDescription WHEN ISNULL(PT.Part_Id,0)>0 THEN P.PartDescription ELSE '[NONE]' END --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp
   WHEN 'PACL' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXPartTypeId,0)>0 THEN NextDuePCL.PartClassification WHEN ISNULL(PT.PartClassificationId,0)>0 THEN PC.PartClassification ELSE '[NONE]' END    --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN CASE WHEN ISNULL(dbo.NEXT_OCC_STRATEGY.PEXRebuildLocationId,0)>0 THEN NextDueRL.Site WHEN ISNULL(PT.DefaultLocationForRebuild,0)>0 THEN RL.Site ELSE '[NONE]' END -- Rebuild Location --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status  
    
   ELSE NULL  
  END  
  

--rest of the record  



INSERT INTO #TASK(ProjTaskID,EqpPlanID,PctPurchasePart,PctPurchaseNewPart,  
    GroupByID1, GroupBy1,GroupByID2, GroupBy2,  
    GroupByID3, GroupBy3,GroupByID4, GroupBy4)  
  SELECT PT.ProjTaskId,EH.EqpPlanID,PT.PctPurchasePart/100,PT.PctPurchaseNewPart/100,  
  CASE @GroupBy1  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN PT.Part_Id --Primary Part No  
   WHEN 'PPDS' THEN PT.Part_Id --Primary Part Description     
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp 
   WHEN 'PACL' THEN PC.PartClassificationId --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN PT.DefaultLocationForRebuild --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status
   ELSE NULL  
  END AS GroupByID1,  
  CASE @GroupBy1  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN P.Part --Primary Part No  
   WHEN 'PPDS' THEN P.PartDescription --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp
   WHEN 'PACL' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PC.PartClassification,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]')  --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RL.Site,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status  
   ELSE NULL  
  END AS GroupBy1,  
  CASE @GroupBy2  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN PT.Part_Id --Primary Part No  
   WHEN 'PPDS' THEN PT.Part_Id --Primary Part Description  
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp
   WHEN 'PACL' THEN PC.PartClassificationId --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN PT.DefaultLocationForRebuild --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status
   ELSE NULL  
  END AS GroupByID2,  
  CASE @GroupBy2  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN P.Part  --Primary Part No  
   WHEN 'PPDS' THEN P.PartDescription --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp
   WHEN 'PACL' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PC.PartClassification,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]')  --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RL.Site,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status  
   ELSE NULL  
  END AS GroupBy2,  
  CASE @GroupBy3  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN PT.Part_Id --Primary Part No  
   WHEN 'PPDS' THEN PT.Part_Id --Primary Part Description  
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp
   WHEN 'PACL' THEN PC.PartClassificationId --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN PT.DefaultLocationForRebuild --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status
   ELSE NULL  
  END AS GroupByID3,  
  CASE @GroupBy3  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN P.Part --Primary Part No  
   WHEN 'PPDS' THEN P.PartDescription --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp
    WHEN 'PACL' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PC.PartClassification,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]')  --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RL.Site,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status  
   ELSE NULL  
  END AS GroupBy3,  
  CASE @GroupBy4  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN PT.Part_Id --Primary Part No  
   WHEN 'PPDS' THEN PT.Part_Id --Primary Part Description  
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp
    WHEN 'PACL' THEN PC.PartClassificationId --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN PT.DefaultLocationForRebuild --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status  
   ELSE NULL  
  END AS GroupByID4,  
  CASE @GroupBy4  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN P.Part --Primary Part No  
   WHEN 'PPDS' THEN P.PartDescription --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp  
    WHEN 'PACL' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PC.PartClassification,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]')  --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RL.Site,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status  
   ELSE NULL  
  END AS GroupBy4  
  
FROM           
  tblProjTaskOpts AS PTO LEFT OUTER JOIN  
  tblProjTaskAmts AS PTA ON PTO.ProjTaskOptId = PTA.ProjTaskOptId RIGHT OUTER JOIN  
  EQUIPMENT_HIERARCHY_V AS EH INNER JOIN  
  tblProjTasks AS PT ON EH.EqpProjId = PT.EqpProjId INNER JOIN  
  TASK_HEADER AS TH ON PT.Task_Header_ID=TH.Task_Header_ID INNER JOIN  
  COMPONENT_HIERARCHY_V AS CH ON PT.ComponentCodeId = CH.ComponentCodeID INNER JOIN  
  tblTaskTypes AS TT ON PT.TaskTypeId = TT.TaskTypeID INNER JOIN  
  tblModifierCodes AS MC ON PT.ModifierId = MC.ModifierID ON PTO.ProjTaskId = PT.ProjTaskId LEFT OUTER JOIN  
  tblManufacturers AS M ON PT.ManufacturerId = M.ManufacturerId LEFT OUTER JOIN  
  tblPartTypes AS PTY INNER JOIN  
  tblParts AS P ON PTY.PartTypeId = P.Part_Type_ID ON PT.Part_Id = P.PartId LEFT OUTER JOIN  
  EMPLOYEE E ON E.Employee_ID=PT.SalesResponsibilityID  LEFT JOIN
  dbo.NEXT_OCC_STRATEGY ON PT.ProjTaskId = NEXT_OCC_STRATEGY.Proj_Task_Id LEFT JOIN
  PART_CLASSIFICATION PC ON PC.PartClassificationId = PT.PartClassificationId LEFT JOIN 
  dbo.PART_RATING PR ON PR.PartRatingId = PT.PartRatingId LEFT JOIN 
  dbo.REVIEW_STATUS RS ON RS.ReviewStatusID = PT.ReviewStatusID LEFT JOIN
  dbo.SALES_STATUS SS ON SS.SalesStatusId = dbo.NEXT_OCC_STRATEGY.SalesStatusId LEFT JOIN                      
  dbo.tblParts NextDueParts ON dbo.NEXT_OCC_STRATEGY.PEXPartId = NextDueParts.PartId LEFT JOIN  
  dbo.tblSites RL ON RL.SiteId = PT.DefaultLocationForRebuild
WHERE       
  (EH.ProjHeaderId = @ProjHeaderID) --AL: 02/06/09  
  AND (PT.Unscheduled=0)  
  AND (EH.BranchId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@BranchId)) OR ISNULL(@BranchId,'')='')  
  AND (EH.SiteId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@SiteID)) OR ISNULL(@SiteID,'')='')  
  AND (EH.FleetId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@FleetID)) OR ISNULL(@FleetID,'')='')  
  AND (EH.Eqp_Class_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpClassId)) OR ISNULL(@EqpClassId,'')='')  
  AND (EH.Equipment_Group_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpGroupId)) OR ISNULL(@EqpGroupId,'')='')  
  AND (EH.ManufacturerId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@ManufacturerId)) OR ISNULL(@ManufacturerId,'')='')  
  AND (EH.ModelId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@ModelID)) OR ISNULL(@ModelID,'')='')  
  AND (EH.EqpPlanId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpPlanID)) OR ISNULL(@EqpPlanID,'')='')  
  AND (EH.Region_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@RegionId)) OR ISNULL(@RegionId,'')='')  
  AND (EH.Division_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@DivisionId)) OR ISNULL(@DivisionId,'')='')  
  AND (EH.Eqp_Criticality_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpCriticalityId)) OR ISNULL(@EqpCriticalityId,'')='')  
  AND (EH.Eqp_Location_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpLocationId)) OR ISNULL(@EqpLocationId,'')='')  
  AND (EH.Eqp_Category_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpCategoryId)) OR ISNULL(@EqpCategoryId,'')='')  
  AND (EH.Cost_Centre_ID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@EqpCostCentreID)) OR ISNULL(@EqpCostCentreID,'')='')  
  AND (EH.Cost_Responsibility_ID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@CostResponsibilityID)) OR ISNULL(@CostResponsibilityID,'')='')  
  AND (EH.ContractId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@ContractID)) OR ISNULL(@ContractID,'')='')  
  AND (EH.ContractTypeID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@ContractTypeID)) OR ISNULL(@ContractTypeID,'')='')  
  
  AND (EH.EqpPlanID IN (SELECT EqpPlanID FROM dbo.EQP_SIBLINGS_F(@ParentEquipmentID)) OR ISNULL(@ParentEquipmentID,'')='')  
  
  AND (CH.CostTypeID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@CostTypeID)) OR ISNULL(@CostTypeID,'')='')  
  AND (CH.SystemID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@SystemID)) OR ISNULL(@SystemID,'')='')  
  AND (CH.SubSystemID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@SubSystemID)) OR ISNULL(@SubSystemID,'')='')  
  AND (PT.Task_Header_ID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@TaskHeaderId)) OR ISNULL(@TaskHeaderId,'')='')  
  AND (PT.TaskTypeId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@TaskTypeID)) OR ISNULL(@TaskTypeID,'')='')  
  AND (PT.ComponentCodeId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@ComponentCodeID)) OR ISNULL(@ComponentCodeID,'')='')  
  AND (PT.ModifierId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@modifierID)) OR ISNULL(@modifierID,'')='')  
  AND (PTA.Cost_Bearer_ID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@CostBearerID)) OR ISNULL(@CostBearerID,'')='')  
  AND (P.Part_Type_ID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PartTypeID)) OR ISNULL(@PartTypeID,'')='')  
  AND (PT.ManufacturerId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PartManufacturerID)) OR ISNULL(@PartManufacturerID,'')='')  
  AND (PT.Part_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PrimaryPartNoID)) OR ISNULL(@PrimaryPartNoID,'')='')  
  AND (PT.SalesResponsibilityID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@SalesResponsibilityID)) OR ISNULL(@SalesResponsibilityID,'')='')  
  AND (PR.PartRatingId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PartRatingId)) OR ISNULL(@PartRatingId,'')='')  
  AND (PT.Part_Id IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PrimaryPartNumberId)) OR ISNULL(@PrimaryPartNumberId,'')='')
  AND (RL.SiteId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@RebuildLocationId)) OR ISNULL(@RebuildLocationId,'')='')
  AND (RS.ReviewStatusID IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@ReviewStatusId)) OR ISNULL(@ReviewStatusId,'')='')
  AND (SS.SalesStatusId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@SalesStatusId)) OR ISNULL(@SalesStatusId,'')='')
  AND (PT.PartClassificationId IN (SELECT list_item FROM dbo.LIST_TO_TABLE_F(@PartClassificationId)) OR ISNULL(@PartClassificationId,'')='')
  
GROUP BY  
  PT.ProjTaskId,EH.EqpPlanID,PT.PctPurchasePart,PT.PctPurchaseNewPart,  
  CASE @GroupBy1  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN PT.Part_Id --Primary Part No  
   WHEN 'PPDS' THEN PT.Part_Id --Primary Part Description  
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp
   WHEN 'PACL' THEN PC.PartClassificationId --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN PT.DefaultLocationForRebuild --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status   
   ELSE NULL  
  END,  
  CASE @GroupBy1  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN P.Part  --Primary Part No  
   WHEN 'PPDS' THEN P.PartDescription --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp
   WHEN 'PACL' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PC.PartClassification,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]')  --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RL.Site,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status   
   ELSE NULL  
  END,  
  CASE @GroupBy2  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN PT.Part_Id --Primary Part No  
   WHEN 'PPDS' THEN PT.Part_Id --Primary Part Description  
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp
   WHEN 'PACL' THEN PC.PartClassificationId --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN PT.DefaultLocationForRebuild --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status    
   ELSE NULL  
  END,  
  CASE @GroupBy2  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN P.Part  --Primary Part No  
   WHEN 'PPDS' THEN P.PartDescription --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp
   WHEN 'PACL' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PC.PartClassification,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]')  --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RL.Site,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status  
   ELSE NULL  
  END,  
  CASE @GroupBy3  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN PT.Part_Id --Primary Part No  
   WHEN 'PPDS' THEN PT.Part_Id --Primary Part Description  
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp
   WHEN 'PACL' THEN PC.PartClassificationId --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN PT.DefaultLocationForRebuild --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status    
   ELSE NULL  
  END,  
  CASE @GroupBy3  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN P.Part  --Primary Part No  
   WHEN 'PPDS' THEN P.PartDescription --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp
   WHEN 'PACL' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PC.PartClassification,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]')  --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RL.Site,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status  
   ELSE NULL  
  END,  
  CASE @GroupBy4  
   WHEN 'BRAN' THEN EH.BranchId --Branch  
   WHEN 'SITE' THEN EH.SiteId --Site  
   WHEN 'FLEE' THEN EH.FleetId --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Id --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Id --Equipment Group  
   WHEN 'MANU' THEN EH.ManufacturerId --Manufacturer  
   WHEN 'MODL' THEN EH.ModelId --Model  
   WHEN 'EQPL' THEN EH.EqpPlanId --Equipment  
   WHEN 'REGN' THEN EH.Region_Id --Region  
   WHEN 'DEVI' THEN EH.Division_Id --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Id --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Id --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Id --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre_ID --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_ID --Responsibility  
   WHEN 'CNTT' THEN EH.ContractTypeID --Contract Type  
   WHEN 'CONT' THEN EH.ContractId --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostTypeID --Cost Type  
   WHEN 'SYST' THEN CH.SystemID --System  
   WHEN 'SUBS' THEN CH.SubSystemID --Sub System  
   WHEN 'PRTA' THEN PT.Task_Header_ID --Strategy Task  
   WHEN 'EVTT' THEN PT.TaskTypeId --Task Type  
   WHEN 'EVCC' THEN PT.ComponentCodeId --Component Code  
   WHEN 'MDCO' THEN PT.ModifierId --Modifier Code  
   WHEN 'PRTY' THEN P.Part_Type_ID --Part Type  
   WHEN 'PMAN' THEN PT.ManufacturerId --Part Manufacturer  
   WHEN 'PART' THEN PT.Part_Id --Primary Part No  
   WHEN 'PPDS' THEN PT.Part_Id --Primary Part Description  
   WHEN 'SARP' THEN PT.SalesResponsibilityID --Sales Resp
   WHEN 'PACL' THEN PC.PartClassificationId --Part Classification
   WHEN 'PARA' THEN PR.PartRatingId --Part Rating
   WHEN 'RELO' THEN PT.DefaultLocationForRebuild --Rebuild Location
   WHEN 'REST' THEN RS.ReviewStatusID --Review Status
   WHEN 'SAST' THEN SS.SalesStatusId --Sales Status    
   ELSE NULL  
  END,  
  CASE @GroupBy4  
   WHEN 'BRAN' THEN EH.Branch --Branch  
   WHEN 'SITE' THEN EH.Site --Site  
   WHEN 'FLEE' THEN EH.Fleet --Fleet  
   WHEN 'ECLS' THEN EH.Eqp_Class_Desc --Equipment Class  
   WHEN 'EGRP' THEN EH.Equipment_Group_Desc --Equipment Group  
   WHEN 'MANU' THEN EH.Manufacturer --Manufacturer  
   WHEN 'MODL' THEN EH.Model --Model  
   WHEN 'EQPL' THEN EH.EqpPlan --Equipment  
   WHEN 'REGN' THEN EH.Region_Desc --Region  
   WHEN 'DEVI' THEN EH.Division_Desc --Division          
   WHEN 'CRIT' THEN EH.Eqp_Criticality_Desc --Equipment Criticality  
   WHEN 'LCTN' THEN EH.Eqp_Location_Desc --Equipment Location  
   WHEN 'CTGR' THEN EH.Eqp_Category_Desc --Equipment Category  
   WHEN 'ECCT' THEN EH.Cost_Centre --Equipment Cost Centre  
   WHEN 'CRSP' THEN EH.Cost_Responsibility_Desc --Responsibility  
   WHEN 'CNTT' THEN EH.ContractType --Contract Type  
   WHEN 'CONT' THEN EH.Contract --Contract  
   WHEN 'PEQP' THEN NULL --Parent Equipment  
   WHEN 'CTTY' THEN CH.CostType --Cost Type  
   WHEN 'SYST' THEN CH.System --System  
   WHEN 'SUBS' THEN CH.SubSystem --Sub System  
   WHEN 'PRTA' THEN TH.Description --Strategy Task  
   WHEN 'EVTT' THEN TT.Code + ' - ' + TT.Description --Task Type  
   WHEN 'EVCC' THEN CH.Code + ' - ' + CH.Description --Component Code  
   WHEN 'MDCO' THEN MC.Code + ' - ' + MC.Description --Modifier Code  
   WHEN 'PRTY' THEN PTY.PartType + ' ' + PTY.PartTypeDesc --Part Type  
   WHEN 'PMAN' THEN M.Manufacturer --Part Manufacturer  
   WHEN 'PART' THEN P.Part  --Primary Part No  
   WHEN 'PPDS' THEN P.PartDescription --Primary Part Description  
   WHEN 'SARP' THEN E.Surname + ', ' + E.First_Name --Sales Resp
   WHEN 'PACL' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PC.PartClassification,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]')  --Part Classification
   WHEN 'PARA' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(PR.PartRating,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Part Rating
   WHEN 'RELO' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RL.Site,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Rebuild Location
   WHEN 'REST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(RS.ReviewStatusDesc,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Review Status
   WHEN 'SAST' THEN REPLACE(REPLACE(REPLACE(ISNULL(NULLIF(SS.SalesStatus,''),'[NONE]'),' - ','-'),'-',' - '),'(NONE)','[NONE]') --Sales Status  
    
   ELSE NULL  
  END  

IF @GroupBy1='PEQP' OR @GroupBy2='PEQP' OR @GroupBy3='PEQP' OR @GroupBy4='PEQP'  
BEGIN  
 --get parent Eqps for each eqp  
 --a: get IDs  
 CREATE TABLE #EQP  
 (  
  EqpPlanID int primary key,  
  ParentEqpPlanID int   
 )  
 CREATE NONCLUSTERED INDEX [IX_STRATEGY_TEMP] ON [#EQP] (EqpPlanID ASC,ParentEqpPlanID ASC)  
  
 INSERT INTO #EQP(EqpPlanID,ParentEqpPlanID)  
 SELECT EqpPlanId,NULL   
 FROM #TASK  
 GROUP BY EqpPlanId  
  
 DECLARE @selection varchar(max)  
 SET @selection= REPLACE(REPLACE((select DISTINCT EqpPlanId from #EQP for xml raw),'<row eqpplanid="',''),'"/>',',')  
  
 UPDATE #EQP   
 SET ParentEqpPlanID = dbo.GET_TOPMOST_PARENT_EQUIPMENT_F(EqpPlanId,@selection)     
  
 --b: get names and update #tasks  
 UPDATE T   
 SET  GroupByID1 = CASE @GroupBy1 WHEN 'PEQP' THEN E.ParentEqpPlanID ELSE GroupByID1 END,  
   GroupBy1 = CASE @GroupBy1 WHEN 'PEQP' THEN EP.EqpPlan ELSE GroupBy1 END,   
   GroupByID2 = CASE @GroupBy2 WHEN 'PEQP' THEN E.ParentEqpPlanID ELSE GroupByID2 END,  
   GroupBy2 = CASE @GroupBy2 WHEN 'PEQP' THEN EP.EqpPlan ELSE GroupBy2 END,   
   GroupByID3 = CASE @GroupBy3 WHEN 'PEQP' THEN E.ParentEqpPlanID ELSE GroupByID3 END,  
   GroupBy3 = CASE @GroupBy3 WHEN 'PEQP' THEN EP.EqpPlan ELSE GroupBy3 END,   
   GroupByID4 = CASE @GroupBy4 WHEN 'PEQP' THEN E.ParentEqpPlanID ELSE GroupByID4 END,  
   GroupBy4 = CASE @GroupBy4 WHEN 'PEQP' THEN EP.EqpPlan ELSE GroupBy4 END  
 FROM   
   #TASK T INNER JOIN  
   #EQP E ON T.EqpPlanID=E.EqpPlanID INNER JOIN  
   tblEqpPlans EP ON E.ParentEqpPlanID=EP.EqpPlanID  
  
 DROP TABLE #EQP  
END  
  
--Debug  
--SELECT * FROM #TASK  
  
--2: get tasks occs in period  
CREATE TABLE #OCC(ProjtaskID int,Period int,Occs int  
 PRIMARY KEY(ProjtaskID,Period) )  
  
INSERT INTO #OCC(ProjtaskID,Period,Occs)    
SELECT ProjtaskID,OccDate,SUM(Occs) AS Occs   
FROM    
 (  
 SELECT PTO.ProjtaskID  AS ProjtaskID , OccDate ,Count(*) AS Occs
 FROM    
   #TASK T INNER JOIN    
   ( 
     SELECT -PT.ProjTaskId AS ProjTaskId, YEAR(OccDate)*100+MONTH(OccDate) AS OccDate   FROM tblProjTasks PT INNER JOIN  
    (SELECT ProjTaskId, MIN(OccDate) AS OccDate  FROM tblProjTaskOccs
	GROUP BY tblProjTaskOccs.ProjTaskId) TEMP ON PT.ProjTaskId = TEMP.ProjTaskId 
	AND  PT.NextOccDate = TEMP.OccDate  
 
   )   
   PTO ON T.ProjtaskID=PTO.ProjtaskID   
 WHERE    
   (PTO.OccDate BETWEEN @StartDate AND @EndDate)  
      
 GROUP BY     
   PTO.ProjtaskID,PTO.OccDate  
    
 UNION ALL    
   
  
 --Fill in missing periods    
 SELECT T.ProjtaskID,FP.CalenderPeriod,0    
 FROM    
   #TASK T CROSS JOIN    
   tblFinancialPeriods FP    
 WHERE    
   FP.CalenderPeriod BETWEEN @StartDate AND @EndDate AND T.ProjTaskID>0  
    
  UNION ALL  
    
   SELECT  PTO.ProjtaskID,PTO.OccDate,Count(*) AS Occs  
  FROM    
   #TASK T INNER JOIN    
   (
   SELECT tblProjTaskOccs.ProjtaskID,YEAR(OccDate)*100+MONTH(OccDate) AS OccDate FROM tblProjTaskOccs  
   INNER JOIN  
   tblProjTasks PT ON PT.ProjTaskId = tblProjTaskOccs.ProjTaskId  
   WHERE PT.NextOccDate < tblProjTaskOccs.OccDate  
   ) PTO ON T.ProjtaskID=PTO.ProjtaskID    
 WHERE    
   PTO.OccDate BETWEEN @StartDate AND @EndDate    
 GROUP BY     
    PTO.ProjtaskID,PTO.OccDate   
 )A    
GROUP BY ProjtaskID,OccDate    
  
--Debug  
--SELECT * FROM #OCC  
  
  
--GD 1657 give cross tab results  
IF (@IsCrossTab = 'TRUE')  
BEGIN  
  
 --Set Column name in select query,No need to check if null as group by is mandatory so there must be at least 1 group by.  
 SELECT @SelectQueryForCrossTab = @SelectQueryForCrossTab + 'GroupBy1 AS ' +  
  CASE @GroupBy1  
   WHEN 'BRAN' THEN 'Branch'  
   WHEN 'SITE' THEN 'Site'  
   WHEN 'FLEE' THEN 'Fleet'  
   WHEN 'ECLS' THEN '''Equipment Class'''  
   WHEN 'EGRP' THEN '''Equipment Group'''  
   WHEN 'MANU' THEN 'Manufacturer'  
   WHEN 'MODL' THEN 'Model'  
   WHEN 'EQPL' THEN 'Equipment'  
   WHEN 'REGN' THEN 'Region'  
   WHEN 'DEVI' THEN 'Division'  
   WHEN 'CRIT' THEN '''Equipment Criticality'''  
   WHEN 'LCTN' THEN '''Equipment Location'''  
   WHEN 'CTGR' THEN '''Equipment Category'''  
   WHEN 'ECCT' THEN '''Equipment Cost Centre'''  
   WHEN 'CRSP' THEN 'Responsibility'  
   WHEN 'CNTT' THEN '''Contract Type'''  
   WHEN 'CONT' THEN 'Contract'  
   WHEN 'PEQP' THEN '''Parent Equipment'''  
   WHEN 'CTTY' THEN '''Cost Type'''  
   WHEN 'SYST' THEN 'System'  
   WHEN 'SUBS' THEN 'Sub System'  
   WHEN 'PRTA' THEN '''Strategy Task'''  
   WHEN 'EVTT' THEN '''Task Type'''  
   WHEN 'EVCC' THEN '''Component Code'''  
   WHEN 'MDCO' THEN '''Modifier Code'''  
   WHEN 'PRTY' THEN '''Part Type'''  
   WHEN 'PMAN' THEN '''Part Manufacturer'''  
   WHEN 'PART' THEN '''Primary Part No'''  
   WHEN 'PPDS' THEN '''Primary Part Description'''  
   WHEN 'SARP' THEN '''Sales Resp'''
   WHEN 'PACL' THEN '''Part Classification'''
   WHEN 'PARA' THEN '''Part Rating'''
   WHEN 'RELO' THEN '''Rebuild Location'''
   WHEN 'REST' THEN '''Review Status'''
   WHEN 'SAST' THEN '''Sales Status'''
  ELSE NULL  
 END   
IF( @GroupBy2 IS NOT NULL)  
 BEGIN  
  SELECT @SelectQueryForCrossTab = @SelectQueryForCrossTab + ', GroupBy2 AS ' +  
  CASE @GroupBy2  
   WHEN 'BRAN' THEN 'Branch'  
   WHEN 'SITE' THEN 'Site'  
   WHEN 'FLEE' THEN 'Fleet'  
   WHEN 'ECLS' THEN '''Equipment Class'''  
   WHEN 'EGRP' THEN '''Equipment Group'''  
   WHEN 'MANU' THEN 'Manufacturer'  
   WHEN 'MODL' THEN 'Model'  
   WHEN 'EQPL' THEN 'Equipment'  
   WHEN 'REGN' THEN 'Region'  
   WHEN 'DEVI' THEN 'Division'  
   WHEN 'CRIT' THEN '''Equipment Criticality'''  
   WHEN 'LCTN' THEN '''Equipment Location'''  
   WHEN 'CTGR' THEN '''Equipment Category'''  
   WHEN 'ECCT' THEN '''Equipment Cost Centre'''  
   WHEN 'CRSP' THEN 'Responsibility'  
   WHEN 'CNTT' THEN '''Contract Type'''  
   WHEN 'CONT' THEN 'Contract'  
   WHEN 'PEQP' THEN '''Parent Equipment'''  
   WHEN 'CTTY' THEN '''Cost Type'''  
   WHEN 'SYST' THEN 'System'  
   WHEN 'SUBS' THEN 'Sub System'  
   WHEN 'PRTA' THEN '''Strategy Task'''  
   WHEN 'EVTT' THEN '''Task Type'''  
   WHEN 'EVCC' THEN '''Component Code'''  
   WHEN 'MDCO' THEN '''Modifier Code'''  
   WHEN 'PRTY' THEN '''Part Type'''  
   WHEN 'PMAN' THEN '''Part Manufacturer'''  
   WHEN 'PART' THEN '''Primary Part No'''  
   WHEN 'PPDS' THEN '''Primary Part Description'''  
   WHEN 'SARP' THEN '''Sales Resp'''
   WHEN 'PACL' THEN '''Part Classification'''
   WHEN 'PARA' THEN '''Part Rating'''
   WHEN 'RELO' THEN '''Rebuild Location'''
   WHEN 'REST' THEN '''Review Status'''
   WHEN 'SAST' THEN '''Sales Status''' 
   ELSE NULL  
  END  
 END   
IF( @GroupBy3 IS NOT NULL )  
 BEGIN  
  SELECT @SelectQueryForCrossTab = @SelectQueryForCrossTab + ', GroupBy3 AS ' +  
  CASE @GroupBy3  
   WHEN 'BRAN' THEN 'Branch'  
   WHEN 'SITE' THEN 'Site'  
   WHEN 'FLEE' THEN 'Fleet'  
   WHEN 'ECLS' THEN '''Equipment Class'''  
   WHEN 'EGRP' THEN '''Equipment Group'''  
   WHEN 'MANU' THEN 'Manufacturer'  
   WHEN 'MODL' THEN 'Model'  
   WHEN 'EQPL' THEN 'Equipment'  
   WHEN 'REGN' THEN 'Region'  
   WHEN 'DEVI' THEN 'Division'  
   WHEN 'CRIT' THEN '''Equipment Criticality'''  
   WHEN 'LCTN' THEN '''Equipment Location'''  
   WHEN 'CTGR' THEN '''Equipment Category'''  
   WHEN 'ECCT' THEN '''Equipment Cost Centre'''  
   WHEN 'CRSP' THEN 'Responsibility'  
   WHEN 'CNTT' THEN '''Contract Type'''  
   WHEN 'CONT' THEN 'Contract'  
   WHEN 'PEQP' THEN '''Parent Equipment'''  
   WHEN 'CTTY' THEN '''Cost Type'''  
   WHEN 'SYST' THEN 'System'  
   WHEN 'SUBS' THEN 'Sub System'  
   WHEN 'PRTA' THEN '''Strategy Task'''  
   WHEN 'EVTT' THEN '''Task Type'''  
   WHEN 'EVCC' THEN '''Component Code'''  
   WHEN 'MDCO' THEN '''Modifier Code'''  
   WHEN 'PRTY' THEN '''Part Type'''  
   WHEN 'PMAN' THEN '''Part Manufacturer'''  
   WHEN 'PART' THEN '''Primary Part No'''  
   WHEN 'PPDS' THEN '''Primary Part Description'''  
   WHEN 'SARP' THEN '''Sales Resp'''
   WHEN 'PACL' THEN '''Part Classification'''
   WHEN 'PARA' THEN '''Part Rating'''
   WHEN 'RELO' THEN '''Rebuild Location'''
   WHEN 'REST' THEN '''Review Status'''
   WHEN 'SAST' THEN '''Sales Status''' 
  ELSE NULL  
  END  
END  
IF( @GroupBy4 IS NOT NULL)  
 BEGIN  
  SELECT @SelectQueryForCrossTab = @SelectQueryForCrossTab + ', GroupBy4 AS ' +  
  CASE @GroupBy4  
   WHEN 'BRAN' THEN 'Branch'  
   WHEN 'SITE' THEN 'Site'  
   WHEN 'FLEE' THEN 'Fleet'  
   WHEN 'ECLS' THEN '''Equipment Class'''  
   WHEN 'EGRP' THEN '''Equipment Group'''  
   WHEN 'MANU' THEN 'Manufacturer'  
   WHEN 'MODL' THEN 'Model'  
   WHEN 'EQPL' THEN 'Equipment'  
   WHEN 'REGN' THEN 'Region'  
   WHEN 'DEVI' THEN 'Division'  
   WHEN 'CRIT' THEN '''Equipment Criticality'''  
   WHEN 'LCTN' THEN '''Equipment Location'''  
   WHEN 'CTGR' THEN '''Equipment Category'''  
   WHEN 'ECCT' THEN '''Equipment Cost Centre'''  
   WHEN 'CRSP' THEN 'Responsibility'  
   WHEN 'CNTT' THEN '''Contract Type'''  
   WHEN 'CONT' THEN 'Contract'  
   WHEN 'PEQP' THEN '''Parent Equipment'''  
   WHEN 'CTTY' THEN '''Cost Type'''  
   WHEN 'SYST' THEN 'System'  
   WHEN 'SUBS' THEN 'Sub System'  
   WHEN 'PRTA' THEN '''Strategy Task'''  
   WHEN 'EVTT' THEN '''Task Type'''  
   WHEN 'EVCC' THEN '''Component Code'''  
   WHEN 'MDCO' THEN '''Modifier Code'''  
   WHEN 'PRTY' THEN '''Part Type'''  
   WHEN 'PMAN' THEN '''Part Manufacturer'''  
   WHEN 'PART' THEN '''Primary Part No'''  
   WHEN 'PPDS' THEN '''Primary Part Description'''  
   WHEN 'SARP' THEN '''Sales Resp'''
   WHEN 'PACL' THEN '''Part Classification'''
   WHEN 'PARA' THEN '''Part Rating'''
   WHEN 'RELO' THEN '''Rebuild Location'''
   WHEN 'REST' THEN '''Review Status'''
   WHEN 'SAST' THEN '''Sales Status'''  
  ELSE NULL  
 END  
END  
   
--Set Column name in order by query  
SELECT @OrderByCrossTab = @OrderByCrossTab +  
  CASE @GroupBy1  
   WHEN 'BRAN' THEN 'Branch'  
   WHEN 'SITE' THEN 'Site'  
   WHEN 'FLEE' THEN 'Fleet'  
   WHEN 'ECLS' THEN '''Equipment Class'''  
   WHEN 'EGRP' THEN '''Equipment Group'''  
   WHEN 'MANU' THEN 'Manufacturer'  
   WHEN 'MODL' THEN 'Model'  
   WHEN 'EQPL' THEN 'Equipment'  
   WHEN 'REGN' THEN 'Region'  
   WHEN 'DEVI' THEN 'Division'  
   WHEN 'CRIT' THEN '''Equipment Criticality'''  
   WHEN 'LCTN' THEN '''Equipment Location'''  
   WHEN 'CTGR' THEN '''Equipment Category'''  
   WHEN 'ECCT' THEN '''Equipment Cost Centre'''  
   WHEN 'CRSP' THEN 'Responsibility'  
   WHEN 'CNTT' THEN '''Contract Type'''  
   WHEN 'CONT' THEN 'Contract'  
   WHEN 'PEQP' THEN '''Parent Equipment'''  
   WHEN 'CTTY' THEN '''Cost Type'''  
   WHEN 'SYST' THEN 'System'  
   WHEN 'SUBS' THEN 'Sub System'  
   WHEN 'PRTA' THEN '''Strategy Task'''  
   WHEN 'EVTT' THEN '''Task Type'''  
   WHEN 'EVCC' THEN '''Component Code'''  
   WHEN 'MDCO' THEN '''Modifier Code'''  
   WHEN 'PRTY' THEN '''Part Type'''  
   WHEN 'PMAN' THEN '''Part Manufacturer'''  
   WHEN 'PART' THEN '''Primary Part No'''  
   WHEN 'PPDS' THEN '''Primary Part Description'''  
   WHEN 'SARP' THEN '''Sales Resp'''
   WHEN 'PACL' THEN '''Part Classification'''
   WHEN 'PARA' THEN '''Part Rating'''
   WHEN 'RELO' THEN '''Rebuild Location'''
   WHEN 'REST' THEN '''Review Status'''
   WHEN 'SAST' THEN '''Sales Status'''  
  ELSE NULL  
 END   
IF( @GroupBy2 IS NOT NULL )  
 BEGIN  
  SELECT @OrderByCrossTab = @OrderByCrossTab + ',' +  
  CASE @GroupBy2  
   WHEN 'BRAN' THEN 'Branch'  
   WHEN 'SITE' THEN 'Site'  
   WHEN 'FLEE' THEN 'Fleet'  
   WHEN 'ECLS' THEN '''Equipment Class'''  
   WHEN 'EGRP' THEN '''Equipment Group'''  
   WHEN 'MANU' THEN 'Manufacturer'  
   WHEN 'MODL' THEN 'Model'  
   WHEN 'EQPL' THEN 'Equipment'  
   WHEN 'REGN' THEN 'Region'  
   WHEN 'DEVI' THEN 'Division'  
   WHEN 'CRIT' THEN '''Equipment Criticality'''  
   WHEN 'LCTN' THEN '''Equipment Location'''  
   WHEN 'CTGR' THEN '''Equipment Category'''  
   WHEN 'ECCT' THEN '''Equipment Cost Centre'''  
   WHEN 'CRSP' THEN 'Responsibility'  
   WHEN 'CNTT' THEN '''Contract Type'''  
   WHEN 'CONT' THEN 'Contract'  
   WHEN 'PEQP' THEN '''Parent Equipment'''  
   WHEN 'CTTY' THEN '''Cost Type'''  
   WHEN 'SYST' THEN 'System'  
   WHEN 'SUBS' THEN 'Sub System'  
   WHEN 'PRTA' THEN '''Strategy Task'''  
   WHEN 'EVTT' THEN '''Task Type'''  
   WHEN 'EVCC' THEN '''Component Code'''  
   WHEN 'MDCO' THEN '''Modifier Code'''  
   WHEN 'PRTY' THEN '''Part Type'''  
   WHEN 'PMAN' THEN '''Part Manufacturer'''  
   WHEN 'PART' THEN '''Primary Part No'''  
   WHEN 'PPDS' THEN '''Primary Part Description'''  
   WHEN 'SARP' THEN '''Sales Resp'''
   WHEN 'PACL' THEN '''Part Classification'''
   WHEN 'PARA' THEN '''Part Rating'''
   WHEN 'RELO' THEN '''Rebuild Location'''
   WHEN 'REST' THEN '''Review Status'''
   WHEN 'SAST' THEN '''Sales Status''' 
  ELSE NULL  
 END  
END  
IF( @GroupBy3 IS NOT NULL)  
 BEGIN  
  SELECT @OrderByCrossTab = @OrderByCrossTab + ', ' +  
  CASE @GroupBy3  
   WHEN 'BRAN' THEN 'Branch'  
   WHEN 'SITE' THEN 'Site'  
   WHEN 'FLEE' THEN 'Fleet'  
   WHEN 'ECLS' THEN '''Equipment Class'''  
   WHEN 'EGRP' THEN '''Equipment Group'''  
   WHEN 'MANU' THEN 'Manufacturer'  
   WHEN 'MODL' THEN 'Model'  
   WHEN 'EQPL' THEN 'Equipment'  
   WHEN 'REGN' THEN 'Region'  
   WHEN 'DEVI' THEN 'Division'  
   WHEN 'CRIT' THEN '''Equipment Criticality'''  
   WHEN 'LCTN' THEN '''Equipment Location'''  
   WHEN 'CTGR' THEN '''Equipment Category'''  
   WHEN 'ECCT' THEN '''Equipment Cost Centre'''  
   WHEN 'CRSP' THEN 'Responsibility'  
   WHEN 'CNTT' THEN '''Contract Type'''  
   WHEN 'CONT' THEN 'Contract'  
   WHEN 'PEQP' THEN '''Parent Equipment'''  
   WHEN 'CTTY' THEN '''Cost Type'''  
   WHEN 'SYST' THEN 'System'  
   WHEN 'SUBS' THEN 'Sub System'  
   WHEN 'PRTA' THEN '''Strategy Task'''  
   WHEN 'EVTT' THEN '''Task Type'''  
   WHEN 'EVCC' THEN '''Component Code'''  
   WHEN 'MDCO' THEN '''Modifier Code'''  
   WHEN 'PRTY' THEN '''Part Type'''  
   WHEN 'PMAN' THEN '''Part Manufacturer'''  
   WHEN 'PART' THEN '''Primary Part No'''  
   WHEN 'PPDS' THEN '''Primary Part Description'''  
   WHEN 'SARP' THEN '''Sales Resp'''
   WHEN 'PACL' THEN '''Part Classification'''
   WHEN 'PARA' THEN '''Part Rating'''
   WHEN 'RELO' THEN '''Rebuild Location'''
   WHEN 'REST' THEN '''Review Status'''
   WHEN 'SAST' THEN '''Sales Status'''  
  ELSE NULL  
 END  
END  
IF(@GroupBy4 IS NOT NULL)  
 BEGIN  
 SELECT @OrderByCrossTab = @OrderByCrossTab + ','+  
  CASE @GroupBy4  
   WHEN 'BRAN' THEN 'Branch'  
   WHEN 'SITE' THEN 'Site'  
   WHEN 'FLEE' THEN 'Fleet'  
   WHEN 'ECLS' THEN '''Equipment Class'''  
   WHEN 'EGRP' THEN '''Equipment Group'''  
   WHEN 'MANU' THEN 'Manufacturer'  
   WHEN 'MODL' THEN 'Model'  
   WHEN 'EQPL' THEN 'Equipment'  
   WHEN 'REGN' THEN 'Region'  
   WHEN 'DEVI' THEN 'Division'  
   WHEN 'CRIT' THEN '''Equipment Criticality'''  
   WHEN 'LCTN' THEN '''Equipment Location'''  
   WHEN 'CTGR' THEN '''Equipment Category'''  
   WHEN 'ECCT' THEN '''Equipment Cost Centre'''  
   WHEN 'CRSP' THEN 'Responsibility'  
   WHEN 'CNTT' THEN '''Contract Type'''  
   WHEN 'CONT' THEN 'Contract'  
   WHEN 'PEQP' THEN '''Parent Equipment'''  
   WHEN 'CTTY' THEN '''Cost Type'''  
   WHEN 'SYST' THEN 'System'  
   WHEN 'SUBS' THEN 'Sub System'  
   WHEN 'PRTA' THEN '''Strategy Task'''  
   WHEN 'EVTT' THEN '''Task Type'''  
   WHEN 'EVCC' THEN '''Component Code'''  
   WHEN 'MDCO' THEN '''Modifier Code'''  
   WHEN 'PRTY' THEN '''Part Type'''  
   WHEN 'PMAN' THEN '''Part Manufacturer'''  
   WHEN 'PART' THEN '''Primary Part No'''  
   WHEN 'PPDS' THEN '''Primary Part Description'''  
   WHEN 'SARP' THEN '''Sales Resp'''  
   WHEN 'PACL' THEN '''Part Classification'''
   WHEN 'PARA' THEN '''Part Rating'''
   WHEN 'RELO' THEN '''Rebuild Location'''
   WHEN 'REST' THEN '''Review Status'''
   WHEN 'SAST' THEN '''Sales Status'''
  ELSE NULL  
 END   
END   
  
   CREATE TABLE [#temp](  
    [GroupByID1] [varchar](max)COLLATE DATABASE_DEFAULT  NULL,  
    [GroupBy1] [varchar](max) COLLATE DATABASE_DEFAULT NULL,  
    [GroupByID2] [varchar](max)COLLATE DATABASE_DEFAULT  NULL,  
    [GroupBy2] [varchar](max) COLLATE DATABASE_DEFAULT NULL,  
    [GroupByID3] [varchar](max) COLLATE DATABASE_DEFAULT NULL,  
    [GroupBy3] [varchar](max) COLLATE DATABASE_DEFAULT NULL,  
    [GroupByID4] [varchar](max) COLLATE DATABASE_DEFAULT NULL,  
    [GroupBy4] [varchar](max) COLLATE DATABASE_DEFAULT NULL,  
    [PeriodStr] [varchar](max) COLLATE DATABASE_DEFAULT NULL,  
    [Val] [varchar](max) COLLATE DATABASE_DEFAULT NULL,  
    [Period] [int] NULL,   
   ) ON [PRIMARY]  
  
   INSERT INTO #temp     
   SELECT GroupByID1,GroupBy1,  
     GroupByID2,GroupBy2,  
     GroupByID3,GroupBy3,  
     GroupByID4,GroupBy4,  
     CASE @AnalyseBy   
      WHEN 'YEAR' THEN CAST(Period/100 AS VARCHAR)  
      WHEN 'QRTR' THEN LEFT(Period,4) + '-Q' + CONVERT(varchar(1),((Right(Period,2)+2)/3))  
      ELSE  RIGHT(CONVERT(varchar, CONVERT(datetime, CONVERT(varchar,Period) + '01', 112), 6), 6)  
     END As PeriodStr,  
     CASE @AnalyseBy   
      WHEN 'YEAR' THEN Period/100  
      WHEN 'QRTR' THEN CAST(Left(Period,4) + CONVERT(varchar(1),((Right(Period,2)+2)/3)) AS int)  
      ELSE Period  
     END As Period,  
     NULLIF(SUM(Val),0) AS Val  
   FROM  
    (SELECT T.GroupByID1,T.GroupBy1,  
      T.GroupByID2,T.GroupBy2,  
      T.GroupByID3,T.GroupBy3,  
      T.GroupByID4,T.GroupBy4,  
      O.Period,  
      O.Occs * CASE @CalculationOption  
       WHEN 1 THEN T.PctPurchasePart  
       WHEN 2 THEN T.PctPurchasePart * T.PctPurchaseNewPart  
       ELSE 1 END AS Val  
    FROM  
     #TASK T INNER JOIN  
     #OCC O ON T.ProjtaskID=O.ProjtaskID  
    )A  
   GROUP BY  
     GroupByID1,GroupBy1,  
     GroupByID2,GroupBy2,  
     GroupByID3,GroupBy3,  
     GroupByID4,GroupBy4,  
     CASE @AnalyseBy   
      WHEN 'YEAR' THEN CAST(Period/100 AS VARCHAR)  
      WHEN 'QRTR' THEN LEFT(Period,4) + '-Q' + CONVERT(varchar(1),((Right(Period,2)+2)/3))  
      ELSE  RIGHT(CONVERT(varchar, CONVERT(datetime, CONVERT(varchar,Period) + '01', 112), 6), 6)  
     END,  
     CASE @AnalyseBy   
      WHEN 'YEAR' THEN Period/100  
      WHEN 'QRTR' THEN CAST(Left(Period,4) + CONVERT(varchar(1),((Right(Period,2)+2)/3)) AS int)  
      ELSE Period  
     END  
   ORDER BY  
     CASE @AnalyseBy   
      WHEN 'YEAR' THEN Period/100  
      WHEN 'QRTR' THEN CAST(Left(Period,4) + CONVERT(varchar(1),((Right(Period,2)+2)/3)) AS int)  
      ELSE Period  
     END  
       
  
   DECLARE @ListCol VARCHAR(MAX)  
   DECLARE @Query VARCHAR(MAX)  
  
   SELECT  @ListCol = STUFF(( SELECT DISTINCT  '],[' + Val  FROM   #temp ORDER BY '],[' + Val  FOR XML PATH('') ), 1, 2, '') + ']'  
  
   SET @Query =  'SELECT * FROM ( SELECT '+@SelectQueryForCrossTab+', Val,Period FROM #temp WHERE Period!=0 ) tmp PIVOT (SUM(Period) for Val in('+@ListCol+')) AS pvt  
       ORDER BY  '+ @OrderByCrossTab  
   EXECUTE (@Query)  
  
   DROP TABLE #temp  
  
   END  
ELSE  
   --3: Returned query  
   SELECT GroupByID1,GroupBy1,  
     GroupByID2,GroupBy2,  
     GroupByID3,GroupBy3,  
     GroupByID4,GroupBy4,  
     CASE @AnalyseBy   
      WHEN 'YEAR' THEN CAST(Period/100 AS VARCHAR)  
      WHEN 'QRTR' THEN LEFT(Period,4) + '-Q' + CONVERT(varchar(1),((Right(Period,2)+2)/3))  
      ELSE  RIGHT(CONVERT(varchar, CONVERT(datetime, CONVERT(varchar,Period) + '01', 112), 6), 6)  
     END As PeriodStr,  
     CASE @AnalyseBy   
      WHEN 'YEAR' THEN Period/100  
      WHEN 'QRTR' THEN CAST(Left(Period,4) + CONVERT(varchar(1),((Right(Period,2)+2)/3)) AS int)  
      ELSE Period  
     END As Period,  
     NULLIF(SUM(Val),0) AS Val  
   FROM  
    (SELECT T.GroupByID1,T.GroupBy1,  
      T.GroupByID2,T.GroupBy2,  
      T.GroupByID3,T.GroupBy3,  
      T.GroupByID4,T.GroupBy4,  
      O.Period,  
      O.Occs * CASE @CalculationOption  
       WHEN 1 THEN T.PctPurchasePart  
       WHEN 2 THEN T.PctPurchasePart * T.PctPurchaseNewPart  
       ELSE 1 END AS Val  
    FROM  
     #TASK T INNER JOIN  
     #OCC O ON T.ProjtaskID=O.ProjtaskID  
    )A  
   GROUP BY  
     GroupByID1,GroupBy1,  
     GroupByID2,GroupBy2,  
     GroupByID3,GroupBy3,  
     GroupByID4,GroupBy4,  
     CASE @AnalyseBy   
      WHEN 'YEAR' THEN CAST(Period/100 AS VARCHAR)  
      WHEN 'QRTR' THEN LEFT(Period,4) + '-Q' + CONVERT(varchar(1),((Right(Period,2)+2)/3))  
      ELSE  RIGHT(CONVERT(varchar, CONVERT(datetime, CONVERT(varchar,Period) + '01', 112), 6), 6)  
     END,  
     CASE @AnalyseBy   
      WHEN 'YEAR' THEN Period/100  
      WHEN 'QRTR' THEN CAST(Left(Period,4) + CONVERT(varchar(1),((Right(Period,2)+2)/3)) AS int)  
      ELSE Period  
     END  
   ORDER BY  
     CASE @AnalyseBy   
      WHEN 'YEAR' THEN Period/100  
      WHEN 'QRTR' THEN CAST(Left(Period,4) + CONVERT(varchar(1),((Right(Period,2)+2)/3)) AS int)  
      ELSE Period  
     END  
  
--4: cleanup  
DROP TABLE #TASK,#OCC  

GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TASK_AUTOCREATE_EXTERNAL_WORKORDERS_GET_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[TASK_AUTOCREATE_EXTERNAL_WORKORDERS_GET_P]
GO

CREATE PROCEDURE TASK_AUTOCREATE_EXTERNAL_WORKORDERS_GET_P
/******************************************************************************        
 File:         
 Name: TASK_AUTOCREATE_EXTERNAL_WORKORDERS_GET_P        
        
 Called By:    
		AutocreateExternalWorkorders (AMTCalcLibrary)     
        
 Desc:    
		Return Task Ids of Tasks which are to have an automated creation of their
		Workorder numbers
        
 Auth: Simon Dowdeswell        
 Date: 08-May-2012        
*******************************************************************************        
  Change History        
*******************************************************************************        
 Date:  Author:  Description:        
 -------- -------- ----------------------------------------  
        
*******************************************************************************/        
 /* Param List */ 
 
AS
	-- Exit if AMT is in Purchase Order Mode
	IF EXISTS(SELECT TOP 1 WOCreateFromPO FROM AMT_VARIABLE WHERE WOCreateFromPO = 1)
	BEGIN
		RETURN;
	END
	
	SELECT t.Task_ID
	FROM
		TASK t
		INNER JOIN tblProjTaskOpts O ON t.Strategy_Proj_Task_Opt_ID=o.ProjTaskOptId
		INNER JOIN tblProjTasks pt ON o.ProjTaskId=pt.Projtaskid
	WHERE 
		pt.AutocreateExternalWorkorders=1
	AND t.task_status_id IN (1,6)
	AND t.Work_Order_ID IS NULL
	AND t.WO_Create_Date IS NULL
	AND t.Task_Mode_ID=1

GO

/****** Object:  StoredProcedure [dbo].[PARTS_BY_GROUP_CURRENCY_GET_P]    Script Date: 05/10/2012 15:05:52 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PARTS_BY_GROUP_CURRENCY_GET_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[PARTS_BY_GROUP_CURRENCY_GET_P]
GO

/****** Object:  StoredProcedure [dbo].[PARTS_BY_GROUP_CURRENCY_GET_P]    Script Date: 05/10/2012 15:05:52 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[PARTS_BY_GROUP_CURRENCY_GET_P]
/******************************************************************************
	File: PARTS_BY_GROUP_CURRENCY_GET_P.sql
	Name: PARTS_BY_GROUP_CURRENCY_GET_P

	Called By: 

	Desc: 
             

	Auth: Gurdeep Dhillon
	Date: 10/05/12
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------

*******************************************************************************/
	/* Param List */	
	@PriceGroupId INT ='',
	@CurrencyId INT  ='',
	@MaxRecords INT = 2,
	@LastUpdateDate DATETIME = '1-Jan-1950',
	@PriceJobParts BIT = 0
AS

SET ROWCOUNT @MaxRecords
IF (@PriceJobParts = 1)
	BEGIN
		SELECT  DISTINCT P.Part AS Part_Number, dbo.SOURCE_OF_SUPPLY.Sos_Code AS SourceOfSupply
		FROM         
		dbo.tblStdJobs INNER JOIN
		dbo.tblStdJobOperations ON dbo.tblStdJobs.StdJobId = dbo.tblStdJobOperations.StdJobId 
		INNER JOIN
		dbo.tblStdJobOperationParts 
			 ON dbo.tblStdJobOperations.StdJobOperationId = dbo.tblStdJobOperationParts.StdJobOperationId 
			 INNER JOIN
		dbo.tblParts P
			 ON dbo.tblStdJobOperationParts.PartId = P.PartId 
			 INNER JOIN
		dbo.SOURCE_OF_SUPPLY 
			 ON P.Source_Of_Supply_ID = dbo.SOURCE_OF_SUPPLY.Source_Of_Supply_ID 
			 INNER JOIN
		dbo.tblPricedJobs ON dbo.tblStdJobs.StdJobId = dbo.tblPricedJobs.StdJobId
			  INNER JOIN 
		 dbo.tblPartPrices PP ON P.PartId = PP.PartId 
		 
		 WHERE (@PriceGroupId = '' OR PP.Price_Group_ID IN (@PriceGroupId))
		 AND (@CurrencyId = '' OR PP.CurrencyId IN (@CurrencyId))
		 AND PP.LastModDate < = @LastUpdateDate
	END
ELSE
	BEGIN
	SELECT  DISTINCT P.Part AS Part_Number, dbo.SOURCE_OF_SUPPLY.Sos_Code AS SourceOfSupply
		FROM         		
		dbo.tblParts P
			 INNER JOIN
		dbo.SOURCE_OF_SUPPLY 
			 ON P.Source_Of_Supply_ID = dbo.SOURCE_OF_SUPPLY.Source_Of_Supply_ID 
			 INNER JOIN 
		dbo.tblPartPrices PP ON P.PartId = PP.PartId 
		WHERE (@PriceGroupId = '' OR PP.Price_Group_ID IN (@PriceGroupId))
		 AND (@CurrencyId = '' OR PP.CurrencyId IN (@CurrencyId))
		 AND PP.LastModDate < = @LastUpdateDate
	END
SET ROWCOUNT  0
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[ACTUAL_BILLING_IMPORT_P]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[ACTUAL_BILLING_IMPORT_P]
GO

 
create Procedure ACTUAL_BILLING_IMPORT_P
/******************************************************************************
	File: ACTUAL_BILLING_IMPORT_P.sql
	Name: ACTUAL_BILLING_IMPORT_P

	Called By: 

	Desc: 1. if it is a invalid record (if @EquipmentId < 1 or @UsageTypeId < 1) 
		 then add/update in tblInvalidActualBillings table
	      2. if it is a valid record 
		1)Get EqpPlanId from EquipmentID, if Equipment has any Current Projection
              	2)add/update all the values tblInvalidActualBillings table
	      3. Delete if there is any old actual billings entry in tblActualBillingProjs
		 for all the Eqp Projs apart from Budget projection
	      4. Add new entries in tblActualBillingProjs table (EqpProjId and ActualBillingId)
		 for all the Eqp Projs apart from Budget projection

	Auth: Harpreet Singh
	Date: 15-JAN-2003
*******************************************************************************
		Change History
*******************************************************************************
Date:		Author:		Description:
--------	--------	----------------------------------------
 
02 May 12  GD           E786
 --OLD COMMENTS
 
 7 Jul 09	VV			CR8246 Contract Billings changes. Added system source. deleted tblActualBillingsEqpProjs
22 Sep 08	AL			CR7216: Reallocate to correct equipment against registration counter
 4 Oct 07	VV			Set cost bearer always to be contract
25 Oct 06	KN			Added Registration Counter and Removed UsageType, Billable usage
03 Oct 06	KN			Commented PRINT Statement
24 Jul 06	SI			Removed usage of Archived Billing
13-May-04	M Lam		When Financial Period is 0 or Null 
							get it using Billing date
22-Jan-03	G Facer		Removed error raise if equip plan id zero,
							to allow insert to invalid table.
							plus ISNULL on @EqpPlanId to -1 for invalid tbl.
24 Feb 03	RF			Major Fixes:
							1) Fix duplicating of billings
							2) Remove unneccessary cursor
							3) Delete old linking
							4) Had to fix archiving
15-Mar-04	DS			Fix for multiple serial numbers
02 Jun 04	HS			set dirty billing flag 
*******************************************************************************/
	/* Param List */

    @EquipmentId int = 0,
    @MachineSerialNo varchar(50) = '',
    @CustomerId int = 0,
    @BillingStatusID int = 0,
    @BillingDate Datetime = null ,
    @DocumentNumber varchar(50) = '',
    @CurrencyId int = 0,
    @ExchangeRate float = 0,
    @WBSID varchar(50) = '',
    @TotalAmount float = 0,
    @TaxAmount float = 0,
    @FinancialPeriod int = 0,
    @CostBearerId int = 0,
    @Model varchar(50) ='',
    @RegCounter varchar(20) ='',
	@SystemSource varchar(20)='',
	@LineNo int = 0 ,
	@InterfaceSource INT = 0,
	@ImportBatchName varchar(1000) = '' 
	



AS
    
	--function specific declarations--
	Declare @NewActualBillingID As int
	Declare @ActualBillingID As int
	Declare @InvalidActualBillingID As int
	Declare @EqpPlanId As int
	Declare @EqpProjID As int
	
	Declare @AddNewActualBillingRecord As bit
	Declare @CreateNew As bit
	Declare @CurrentBilling as bit
	Declare @ArchivedBilling as bit
	Declare @CurrentProj as bit
	Declare @AlternateProj as bit
	Declare @ArchivedProj as bit
    
    -- 14-Mar-2004
	DECLARE @oldSerialNumber VARCHAR(50)
	DECLARE @oldEqpPlanId INTEGER

	/*VV CR8246*/
	DECLARE @SystemSourceId int
	DECLARE @TypeVarchar int	
	DECLARE @TypeInt int
	DECLARE @TypeFloat int
	DECLARE @ErrBusinessRules int
	DECLARE @TypeDateTime int
	DECLARE @ErrParsing int

	SET @ErrBusinessRules = 3
	SET @ErrParsing = 1 
	SET @TypeVarchar = 1
	SET @TypeInt = 2
	SET @TypeFloat = 3
	SET @TypeDateTime = 6
    
	Set @AddNewActualBillingRecord = 0
	Set @CreateNew = 0
	Set @CurrentBilling = 0
	Set @ArchivedBilling = 0
	Set @CurrentProj = 0
	Set @AlternateProj = 0
	Set @ArchivedProj = 0
	
	DECLARE @Message VARCHAR(200)

	Set @RegCounter = NULLIF(@RegCounter,'')
	
	--Create table for error messages records	
	CREATE TABLE #z_Message(MessageId int IDENTITY(1,1),Line_No int,
	ErrorDescription varchar(5000) COLLATE DATABASE_DEFAULT,
	EqpPlanId int,ProjectId int,ErrorType int,ImportRecord VARCHAR(MAX)
	PRIMARY KEY(MessageId))
	
 	
	--Check data type
	INSERT INTO #z_Message(Line_No,ErrorDescription,ErrorType,ImportRecord)
	SELECT @LineNo, CASE  WHEN @DocumentNumber IS NULL THEN 'Missing Required Filed:Invoice_Number' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Invoice_Number',50,@DocumentNumber,0) END +
	CASE  WHEN @Model IS NULL THEN 'Missing Required Filed:Model' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Model', 20,@Model,0) END +
	CASE  WHEN @MachineSerialNo IS NULL THEN 'Missing Required Filed:Serial_Number' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Calendar_Period', 50,@MachineSerialNo,0) END +	
	CASE  WHEN @BillingDate IS NULL THEN 'Missing Required Filed:Date' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeDateTime,'Date', 0,@BillingDate,0) END+
	CASE  WHEN @ExchangeRate IS NULL THEN 'Missing Required Filed:Exchange_Rate' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Exchange_Rate', 0,@ExchangeRate,0) END +
	CASE  WHEN @BillingDate > getdate() OR @BillingDate is null THEN  'Actual Billings cannot be imported with a reading date of greater than today.' ELSE '' END +
	CASE WHEN ISNULL(@ExchangeRate,0)<=0 THEN 'An Exchange Rate is required for Actual Billing.'  ELSE '' END +	
	CASE  WHEN @WBSID IS NOT NULL THEN  dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'External_Id', 50,@WBSID,0)ELSE '' END +
	CASE  WHEN @SystemSource IS NOT NULL THEN  dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'System_Source', 50,@SystemSource,0) ELSE ''END +
	CASE  WHEN @RegCounter !='' THEN  dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Registration Counter', 20,@RegCounter,0) ELSE '' END 
    AS ErrorDescription,@ErrParsing AS ErrorType,
    CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT @DocumentNumber AS Invoice_Number, @Model AS Model,@MachineSerialNo AS Serial_Number,@RegCounter AS Registration_Counter,@BillingDate AS Date,@BillingDate ,@ExchangeRate,@WBSID FOR XML PATH('I_WORKORDER_BILLING'),ROOT('I_WORKORDER_BILLINGs')) END
  AS ImportRecord

DELETE #z_Message WHERE ISNULL(ErrorDescription,'')=''	
----Delete records having some data type errors
IF EXISTS(SELECT Line_No FROM #z_Message)
GOTO FINISH


	-- ML: 13 May 2004 - Lookup Financial Period from Billing Date 
	IF @FinancialPeriod = 0 or @FinancialPeriod IS NULL
	BEGIN
		DECLARE @CalendarPeriod INT
		SET @CalendarPeriod = DATEPART(Year,@BillingDate) * 100 + DATEPART(Month,@BillingDate)
		
		SELECT TOP 1 @FinancialPeriod = FinancialPeriod FROM tblFinancialPeriods
		WHERE CalenderPeriod = 	@CalendarPeriod
	

	END

	/*VV CR8246*/
	IF(ISNULL(@SystemSource,'')<>'')
	BEGIN
		EXEC SYSTEM_SOURCE_IMPORT_P @sysSource=@SystemSource,@userId =0,@id=@SystemSourceId OUTPUT
	END
	
	SET @SystemSourceId=NULLIF(@SystemSourceId,0)

	If @EquipmentId < 1 
	/******************write to the invalid table if USAGETYPEID = 0 or EQUIPMENTID = 0 ***********/
		BEGIN		

			-- check archive status --
			SELECT 
				@InvalidActualBillingID = InvalidActualBillingID,
				@CurrentBilling = CurrentBilling,
				@ArchivedBilling = ArchivedBilling
			FROM tblInvalidActualBillings
			WHERE SerialNo = @MachineSerialNo 
				AND BillingDocumentNo = @DocumentNumber 
				AND ISNULL(CurrentBilling,0)<>0
	
			If ISNULL(@InvalidActualBillingID,0) < 1
			
				--indicate that a new record needs to be set up--
				set @AddNewActualBillingRecord = 1
				
			
			SELECT 
				@EqpPlanId = tblEqpPlans.EqpPlanId
			FROM tblEqpPlans INNER JOIN tblEquipment
				ON tblEqpPlans.EquipmentId = tblEquipment.EquipmentId
				INNER JOIN tblEqpProjs 
				ON tblEqpPlans.EqpPlanId = tblEqpProjs.EqpPlanId
			WHERE tblEquipment.EquipmentId = @EquipmentId
				AND tblEqpProjs.BudgetProj = 0

			If @AddNewActualBillingRecord = 1
			BEGIN 
				--add a new record to the appropriate table--
				INSERT INTO tblInvalidActualBillings(EqpPlanID,CustomerID,CostBearerID,FinancialPeriod,
				BillingStatusID,CurrencyId,SerialNo,TotalAmount,TaxAmount,BillingDate,BillingDocumentNo,
				ExchangeRate,CurrentBilling,ArchivedBilling,ExtRef,Model,Reg_Counter,SystemSourceId)
				VALUES (ISNULL(@EqpPlanId, -1), @CustomerId, @CostBearerId, @FinancialPeriod, 
				@BillingStatusID, @CurrencyId, @MachineSerialNo, @TotalAmount, @TaxAmount, @BillingDate, 
				@DocumentNumber, @ExchangeRate, -1, 0, @WBSID,@Model,@RegCounter,@SystemSourceId)
			
			END
			Else
				--update the record in the appropriate table--
				UPDATE tblInvalidActualBillings 
				SET
					EqpPlanID = ISNULL(@EqpPlanId, -1),
					CustomerID=@CustomerId,
					CostBearerID=@CostBearerId,
					FinancialPeriod=@FinancialPeriod,
					BillingStatusID=@BillingStatusID,
					CurrencyId=@CurrencyId,
					SerialNo=@MachineSerialNo,
					TotalAmount=@TotalAmount,
					TaxAmount=@TaxAmount,
					BillingDate=@BillingDate,
					BillingDocumentNo=@DocumentNumber,
					ExchangeRate=@ExchangeRate,
					ExtRef=@WBSID,
					Model = @Model,
					Reg_Counter = @RegCounter,
					SystemSourceId=@SystemSourceId
				WHERE InvalidActualBillingId = @InvalidActualBillingID
					AND ISNULL(CurrentBilling,0) <> 0

		END
	/**************************************************************************************/

    	ELSE
	/***************************write to the valid table **********************************/
		BEGIN
			--check archive status--
			SELECT 
				@ActualBillingID = ActualBillingID,
				@CurrentBilling = CurrentBilling,
				@ArchivedBilling = ArchivedBilling 
			FROM tblActualBillings
			WHERE SerialNo = @MachineSerialNo 
				AND BillingDocumentNo = @DocumentNumber 
				AND ISNULL(CurrentBilling,0)<>0
	
			If ISNULL(@ActualBillingID,0) <= 0
			
				--indicate that a new record needs to be set up--
				set @AddNewActualBillingRecord = 1

		--Get the EQPPLANID
		SELECT 
			@EqpPlanId = EqpPlanId
		FROM tblEqpPlans 
		WHERE EquipmentId = @EquipmentId

INSERT INTO #z_Message(Line_No,ErrorDescription,ErrorType,ImportRecord)
SELECT @LineNo, CASE  WHEN ISNULL(@EqpPlanId,0) < 1 THEN 'Equipment does not exist.' END 	
    AS ErrorDescription,@ErrBusinessRules AS ErrorType,
    CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT @DocumentNumber AS Invoice_Number, @Model AS Model,@MachineSerialNo AS Serial_Number,@RegCounter AS Registration_Counter,@BillingDate AS Date,@BillingDate ,@ExchangeRate,@WBSID FOR XML PATH('I_WORKORDER_BILLING'),ROOT('I_WORKORDER_BILLINGs')) END
  AS ImportRecord
  
  
  
DELETE #z_Message WHERE ISNULL(ErrorDescription,'')=''	
----Delete records having some data type errors
IF EXISTS(SELECT Line_No FROM #z_Message)
GOTO FINISH
	
	

		If @AddNewActualBillingRecord = 1
			BEGIN
				--add a new record to the appropriate table--
				INSERT INTO tblActualBillings(EqpPlanID,CustomerID,CostBearerID,FinancialPeriod,
				BillingStatusID,CurrencyId,SerialNo,TotalAmount,TaxAmount,BillingDate,BillingDocumentNo,
				ExchangeRate,CurrentBilling,ArchivedBilling,ExtRef,Model,Reg_Counter,SystemSourceId)
				VALUES (@EqpPlanId, @CustomerId, @CostBearerId, @FinancialPeriod, @BillingStatusID, 
				@CurrencyId, @MachineSerialNo, @TotalAmount, @TaxAmount, @BillingDate, @DocumentNumber, 
				@ExchangeRate, -1, 0, @WBSID,@Model,@RegCounter,@SystemSourceId)
			
				--get the new id--
				SELECT @NewActualBillingID = SCOPE_IDENTITY() 
				
				EXEC ACTUAL_BILLINGS_LINK_P @ActualBillingId=@NewActualBillingID
				
			END		
	
		Else

			--AL: 22/09/08 CR7216: tested the new interface with Registration Counter and 
			--this did not REASSIGN the billing to the correct Equipment
			/*
			--************************************************************
			-- DS 18-Jul-2003, 15-Mar-2004 (fix was missing from Sourcesafe!)
			-- ...fix for 'multiple serial numbers' (CR2990)
			--
			SELECT
				@oldSerialNumber = SerialNo,
				@oldEqpPlanId = EqpPlanId
			FROM
				tblActualBillings
			WHERE
				ActualBillingId = @ActualBillingID
			
			IF (@oldSerialNumber = @MachineSerialNo) AND (@oldEqpPlanId > 0)
			BEGIN
				SET @EqpPlanId = @oldEqpPlanId
			END
			--************************************************************
			*/

			--update the record in the appropriate table--
			UPDATE tblActualBillings 
			SET
				EqpPlanID = @EqpPlanId,
				CustomerID=@CustomerId,
				CostBearerID=@CostBearerId,
				FinancialPeriod=@FinancialPeriod,
				BillingStatusID=@BillingStatusID,
				CurrencyId=@CurrencyId,
				SerialNo=@MachineSerialNo,
				TotalAmount=@TotalAmount,
				TaxAmount=@TaxAmount,
				BillingDate=@BillingDate,
				BillingDocumentNo=@DocumentNumber,
				ExchangeRate=@ExchangeRate,
				ExtRef=@WBSID,
				Model = @Model,
				Reg_Counter = @RegCounter,
				SystemSourceId=@SystemSourceId
			WHERE ActualBillingId = @ActualBillingID
				AND ISNULL(CurrentBilling,0) <> 0	

			EXEC ACTUAL_BILLINGS_LINK_P @ActualBillingId=@ActualBillingID

	END

-- VV CR8246 We have trigger on tblActualBillings table
--	UPDATE AMT_VARIABLE 
--	SET Dirty_Billing = 1
	
FINISH:
IF @InterfaceSource=0 AND EXISTS(SELECT ImportFileName FROM IMPORT_ERROR WHERE ImportFileName=@ImportBatchName)
BEGIN
	DELETE IMPORT_ERROR WHERE ImportFileName=@ImportBatchName
END
	

IF EXISTS(SELECT MessageId FROM #z_Message)
BEGIN

    INSERT INTO IMPORT_ERROR(ImportFileName,Line_No,ErrorDescription,ImportErrorTypeId,LastModDate,ImportRecord,ImportSourceId)
	SELECT @ImportBatchName AS ImportFileName,CASE WHEN @InterfaceSource = 0 THEN Line_No END,ErrorDescription,
	ISNULL(ErrorType,@ErrBusinessRules) AS ImportErrorTypeId, 
	GETDATE() AS LastModDate,CONVERT(VARCHAR(MAX),ImportRecord),@InterfaceSource
	FROM #z_Message
	RAISERROR (@Message, 16, 1)    
END	
SELECT @Message = ErrorDescription FROM #z_Message


RETURN

SET NOCOUNT OFF

GO


/****** Object:  StoredProcedure [dbo].[PARTS_BY_GROUP_CURRENCY_GET_P]    Script Date: 05/10/2012 15:05:52 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[AMT_SYSTEM_TASK_PARAM_GET_P]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[AMT_SYSTEM_TASK_PARAM_GET_P]
GO

/****** Object:  StoredProcedure [dbo].[PARTS_BY_GROUP_CURRENCY_GET_P]    Script Date: 05/10/2012 15:05:52 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[AMT_SYSTEM_TASK_PARAM_GET_P]
/******************************************************************************
	File: 
	Name: 

	Called By: Connector

	Desc: 
             
	Auth: Ted Wang
	Date: 11/05/12
*******************************************************************************
		Change History
*******************************************************************************
	Date:		Author:		Description:
	--------	--------	----------------------------------------

*******************************************************************************/

	@Task_id int  
AS  

SELECT	Param_Name ,   
		Param_Value   
FROM	AMT_SYSTEM_TASK_PARAM P 
Inner Join AMT_SYSTEM_TASK_QUEUE q On q.System_Task_Id = p.System_Task_Id   
WHERE	q.Task_Queue_Id = @Task_id   

GO --==================================================================================================================================
if exists (select * from dbo.sysobjects where id = object_id(N'KIRD_PRICE_UPDATE_P') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure KIRD_PRICE_UPDATE_P
GO

create PROCEDURE [dbo].[KIRD_PRICE_UPDATE_P]
/******************************************************************************
	
	Name: KIRD_PRICE_UPDATE_P

	Called By: 

	Desc: 

	Auth: 	Sergey Ivanov
	Date: 	30 June 2005
*******************************************************************************
		Change History
*******************************************************************************
Date:		Author:		Description:
--------	--------	----------------------------------------
04 May 12   GD          E787

--OLD COMMENTS

06-Jun-11	GW			E547: Parts-Price update program - Party Type does not udpate
16-Apr-10	DS			CR8896: Collation not specified for fields added in 8.4
11-Dec-09	V Vasylyeva	CR Part Price update can add parts
21-Jul-07	KN			Fixed - Collation and tempDB Conflicts
28-Aug-08	KN			Updated PartsSuperSeded.
02-Sep-08	KN			Updated PartSuperSeded.
*******************************************************************************/
	/* Param List */
@doc text,
@NRecords int = 0 OUTPUT,
/*VV*/
@Currency varchar(3)='',
@PriceGroup varchar(50)='',
@AddNew bit=NULL,
@Message varchar(1000)='' OUTPUT,
@RaiseError bit=0,
@UserId int=0,
@InterfaceSource INT = 0,
@ImportBatchName varchar(1000) = '' 

AS

	DECLARE @TypeVarchar int	
	DECLARE @TypeInt int
	DECLARE @TypeFloat int
	DECLARE @ErrBusinessRules int
	DECLARE @TypeDateTime int
	DECLARE @ErrParsing int
	DECLARE @TypeBit int 

	SET @ErrBusinessRules = 3
	SET @ErrParsing = 1 
	SET @TypeVarchar = 1
	SET @TypeInt = 2
	SET @TypeFloat = 3
	SET @TypeDateTime = 6
	SET @TypeBit= 4

DECLARE @NRecTitle varchar(50)

SET @NRecTitle='NRECORDS'
SET @Message=''

SET @Currency=NULLIF(@Currency,'')
SET @PriceGroup=NULLIF(@PriceGroup,'')


--Create table for error messages records	
	CREATE TABLE #z_Message(MessageId int IDENTITY(1,1),Line_No int,
	ErrorDescription varchar(5000) COLLATE DATABASE_DEFAULT,
	EqpPlanId int,ProjectId int,ErrorType int,ImportRecord VARCHAR(MAX)
	PRIMARY KEY(MessageId))
	
	

	

IF @AddNew IS NULL
BEGIN
	DECLARE @Varchar_Value varchar(max)
	EXEC AMT_TYPED_VARIABLE_GET_P @Value_Name='AddNewParts',  @Varchar_Value =@Varchar_Value OUTPUT
	SET @Varchar_Value=ISNULL(@Varchar_Value,'0')
	SET @AddNew=CAST(@Varchar_Value AS bit)
END

CREATE TABLE #I_PART_PRICE_HEADER (

	Pricing_Date VARCHAR (1000) COLLATE database_default /* VV Pricing_Date is not used*//*NOT*/ ,
	Pricing_Group VARCHAR (1000) COLLATE database_default ,
	Currency VARCHAR (1000) COLLATE database_default 
)
CREATE TABLE #I_PART_PRICE (
Line_Num int IDENTITY(1,1) ,
	SourceOfSupply VARCHAR (1000) COLLATE database_default  ,
	Part_Number VARCHAR (1000) COLLATE database_default  ,
	Part_Sell VARCHAR (1000) COLLATE database_default  ,
	Part_Cost VARCHAR (1000) COLLATE database_default ,
	Full_Credit_Sell VARCHAR (1000) COLLATE database_default ,
	Full_Credit_Cost VARCHAR (1000) COLLATE database_default ,
	Partial_Credit_Sell VARCHAR (1000) COLLATE database_default ,
	Partial_Credit_Cost VARCHAR (1000) COLLATE database_default ,
	Part_Superseded VARCHAR (1000) COLLATE database_default ,
	Part_Type VARCHAR (1000) COLLATE database_default ,
	Part_Description VARCHAR (1000) COLLATE database_default 
)

DECLARE @idoc int
DECLARE @Price_Group_ID int
DECLARE	@CurrencyID int
DECLARE @PartTypeId int

SELECT @PartTypeId=PartTypeId FROM tblPartTypes WHERE PartTypeDefault=1

EXEC sp_xml_preparedocument @idoc OUTPUT, @doc

INSERT #I_PART_PRICE_HEADER
SELECT 
NULLIF(LTRIM(RTRIM(Pricing_Date)),'') AS Pricing_Date,
NULLIF(LTRIM(RTRIM(Pricing_Group)),'') AS Pricing_Group,
NULLIF(LTRIM(RTRIM(Currency)),'') AS Currency
FROM OPENXML (@idoc, '/I_PART_PRICEs/I_PART_PRICE_HEADER',2) WITH #I_PART_PRICE_HEADER

INSERT #I_PART_PRICE
SELECT 

NULLIF(LTRIM(RTRIM(SourceOfSupply)),'') AS SourceOfSupply,
NULLIF(LTRIM(RTRIM(Part_Number)),'') AS Part_Number,
NULLIF(LTRIM(RTRIM(Part_Sell)),'') AS Part_Sell,
NULLIF(LTRIM(RTRIM(Part_Cost)),'') AS Part_Cost,
NULLIF(LTRIM(RTRIM(Full_Credit_Sell)),'') AS Full_Credit_Sell,
NULLIF(LTRIM(RTRIM(Full_Credit_Cost)),'') AS Full_Credit_Cost,
NULLIF(LTRIM(RTRIM(Partial_Credit_Sell)),'') AS Partial_Credit_Sell,
NULLIF(LTRIM(RTRIM(Partial_Credit_Cost)),'') AS Partial_Credit_Cost,
ISNULL(NULLIF(RTRIM(LTRIM(Part_Superseded)),''),0),
NULLIF(LTRIM(RTRIM(Part_Type)),'') AS Part_Type,
NULLIF(LTRIM(RTRIM(Part_Description)),'') AS Part_Description
FROM OPENXML (@idoc, '/I_PART_PRICEs/I_PART_PRICE',2) WITH #I_PART_PRICE

EXEC sp_xml_removedocument @idoc

UPDATE #I_PART_PRICE_HEADER SET Currency=ISNULL(@Currency,Currency),Pricing_Group=ISNULL(@PriceGroup,Pricing_Group)

DECLARE @RecNo int;
SELECT @RecNo=Count(Pricing_Group) FROM #I_PART_PRICE_HEADER
	IF @RecNo<>1
		BEGIN
			INSERT INTO #z_Message(Line_No,ErrorDescription,ErrorType,ImportRecord)
			SELECT NULL,'XML data should have 1 Part Price Header.',@ErrBusinessRules,(SELECT Pricing_Date, Pricing_Group, Currency FROM  #I_PART_PRICE_HEADER FOR XML PATH('I_PART_PRICE_HEADER'),ROOT('I_PART_PRICEs')) AS ImportRecod
			
			GOTO FINISH
		END	

 --Check data type
INSERT INTO #z_Message(Line_No,ErrorDescription,ErrorType,ImportRecord)
SELECT 1, CASE  WHEN Pricing_Date IS NOT NULL THEN dbo.CHECK_IMPORT_DATA_F(@TypeDateTime,'Pricing_Date',0,Pricing_Date,0) ELSE '' END +
	CASE  WHEN Pricing_Group IS NULL THEN 'Missing Required Filed:Pricing_Group' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Pricing_Group', 50,Pricing_Group,0) END +
	CASE  WHEN Currency IS NULL THEN 'Missing Required Filed:Currency' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Currency', 3,Currency,0) END 
    AS ErrorDescription,@ErrParsing AS ErrorType,
    CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT Pricing_Date, Pricing_Group, Currency FROM  #I_PART_PRICE_HEADER TEMP_PART_HEADER FOR XML PATH('I_OVERHEAD_ACTUAL_COST'),ROOT('I_OVERHEAD_ACTUAL_COSTs')) END
  AS ImportRecord
FROM
#I_PART_PRICE_HEADER

 --Check data type
INSERT INTO #z_Message(Line_No,ErrorDescription,ErrorType,ImportRecord)
SELECT Line_Num, CASE  WHEN SourceOfSupply IS NULL THEN 'Missing Required Filed:SourceOfSupply' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'SourceOfSupply',50,SourceOfSupply,0) END +
	CASE  WHEN Part_Number IS NULL THEN 'Missing Required Filed:Part_Number' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Part_Number', 50,Part_Number,0) END +
	CASE  WHEN Part_Cost IS NULL THEN 'Missing Required Filed:Part_Cost' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Part_Cost', 0,Part_Cost,0) END +
	CASE  WHEN Part_Sell IS NULL THEN 'Missing Required Filed:Part_Sell' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Part_Sell', 0,Part_Sell,0) END +
	CASE  WHEN Full_Credit_Sell IS NULL THEN 'Missing Required Filed:Full_Credit_Sell' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Full_Credit_Sell', 0,Full_Credit_Sell,0) END +
	CASE  WHEN Full_Credit_Cost IS NULL THEN 'Missing Required Filed:Full_Credit_Cost' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Full_Credit_Cost', 0,Full_Credit_Cost,0) END +	
	CASE  WHEN Partial_Credit_Sell IS NULL THEN 'Missing Required Filed:Partial_Credit_Sell' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Partial_Credit_Sell', 0,Partial_Credit_Sell,0) END +
	CASE  WHEN Partial_Credit_Cost IS NULL THEN 'Missing Required Filed:Partial_Credit_Cost' ELSE dbo.CHECK_IMPORT_DATA_F(@TypeFloat,'Partial_Credit_Cost', 0,Partial_Credit_Cost,0) END +
	CASE  WHEN Part_Superseded IS NOT NULL THEN dbo.CHECK_IMPORT_DATA_F(@TypeBit,'Part_Superseded', 50,Part_Superseded,0) ELSE '' END +
	CASE  WHEN Part_Type IS NOT NULL THEN dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Part_Type', 10,Part_Type,0)ELSE '' END +
	CASE  WHEN Part_Description IS NOT NULL THEN dbo.CHECK_IMPORT_DATA_F(@TypeVarchar,'Part_Description', 50,Part_Description,0) ELSE '' END 	
    AS ErrorDescription,@ErrParsing AS ErrorType,
   CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT SourceOfSupply, Part_Number, Part_Sell, Part_Cost, Full_Credit_Sell, Full_Credit_Cost, Partial_Credit_Sell, Partial_Credit_Cost ,Part_Superseded ,Part_Type, Part_Description FROM  #I_PART_PRICE TEMP_PART_PRICE WHERE TEMP_PART_PRICE.Line_Num = #I_PART_PRICE.Line_Num FOR XML PATH('I_PART_PRICE'),ROOT('I_PART_PRICEs')) END
  AS ImportRecord
FROM
#I_PART_PRICE


--Delete lines without any error message	
DELETE #z_Message WHERE ErrorDescription=''	
----Reject the whole file
IF EXISTS(SELECT Line_No FROM #z_Message)	
		GOTO FINISH
	
IF NOT EXISTS(SELECT Price_Group_ID FROM PRICE_GROUP WHERE Price_Group IN (SELECT Pricing_Group FROM #I_PART_PRICE_HEADER))
	BEGIN
		INSERT INTO #z_Message(Line_No,ErrorDescription,ErrorType,ImportRecord)
		SELECT NULL,'Specified Pricing Group does not exist.',@ErrBusinessRules,(SELECT Pricing_Date, Pricing_Group, Currency FROM  #I_PART_PRICE_HEADER FOR XML PATH('I_PART_PRICE_HEADER'),ROOT('I_PART_PRICEs')) AS ImportRecod
		
		GOTO FINISH
	END

IF NOT EXISTS(SELECT cur.CurrencyID FROM tblCurrencies cur	WHERE cur.Currency IN (SELECT Currency FROM #I_PART_PRICE_HEADER))
	BEGIN
		INSERT INTO #z_Message(Line_No,ErrorDescription,ErrorType,ImportRecord)
		SELECT NULL,'Specified Currency does not exist.',@ErrBusinessRules,(SELECT Pricing_Date, Pricing_Group, Currency FROM  #I_PART_PRICE_HEADER FOR XML PATH('I_PART_PRICE_HEADER'),ROOT('I_PART_PRICEs')) AS ImportRecod
	
		GOTO FINISH	
	END

IF EXISTS(SELECT Part_Type FROM #I_PART_PRICE where Part_Type NOT IN (SELECT pt.PartType FROM tblPartTypes pt))	
	BEGIN
		INSERT INTO #z_Message(Line_No,ErrorDescription,ErrorType,ImportRecord)
		SELECT 1, 'Specified Part Type does not exist.'	AS ErrorDescription,@ErrBusinessRules AS ErrorType,
		CASE WHEN @InterfaceSource = 0 THEN '' ELSE (SELECT SourceOfSupply, Part_Number, Part_Sell, Part_Cost, Full_Credit_Sell, Full_Credit_Cost, Partial_Credit_Sell
		,Partial_Credit_Cost,Part_Superseded,Part_Type,Part_Description
		FROM  #I_PART_PRICE TEMP_PART_PRICE WHERE TEMP_PART_PRICE.Line_Num = #I_PART_PRICE.Line_Num FOR XML PATH('I_OVERHEAD_ACTUAL_COST'),ROOT('I_OVERHEAD_ACTUAL_COSTs')) END
		AS ImportRecord
		FROM
		#I_PART_PRICE
		WHERE Part_Type NOT IN (SELECT pt.PartType FROM tblPartTypes pt)
			
	GOTO FINISH	
	END

SELECT @CurrencyID=C.CurrencyID, @Price_Group_ID=PG.Price_Group_ID
	FROM         
	#I_PART_PRICE_HEADER IPP 
		INNER JOIN
	tblCurrencies C 
		ON IPP.Currency = C.Currency 
		INNER JOIN
	PRICE_GROUP PG 
		ON IPP.Pricing_Group = PG.Price_Group

SET XACT_ABORT ON


UPDATE p
SET
	P.PartSuperseded = ISNULL(ipp.Part_Superseded,P.PartSuperseded),
	P.PartDescription=ISNULL(ipp.Part_Description,P.PartDescription),
	P.LastModByUserId=@UserId,
	P.LastModDate=getdate(),
	P.Part_Type_ID = ISNULL(pt.PartTypeId,P.Part_Type_ID)  
FROM #I_PART_PRICE_HEADER ipph
	LEFT JOIN #I_PART_PRICE ipp ON Part_Number<>''
	LEFT JOIN PRICE_GROUP pg ON pg.Price_Group=ipph.Pricing_Group
	LEFT JOIN tblCurrencies cur ON cur.Currency=ipph.Currency
	LEFT JOIN SOURCE_OF_SUPPLY sos ON sos.Sos_Code=ipp.SourceOfSupply
	LEFT JOIN tblParts p ON p.Part=ipp.Part_Number AND p.Source_Of_Supply_ID=sos.Source_Of_Supply_ID
	LEFT JOIN tblPartPrices pp ON pp.PartId=p.PartId AND pp.CurrencyId=cur.CurrencyID AND pp.Price_Group_ID=pg.Price_Group_ID
	Left join tblPartTypes pt on pt.PartType = ipp.Part_Type
WHERE pp.PartPriceId IS NOT NULL
	
UPDATE pp
SET
	pp.Part_Sell=ipp.Part_Sell,
	pp.Part_Cost=ipp.Part_Cost,
	pp.Full_Credit_Sell=ipp.Full_Credit_Sell,
	pp.Full_Credit_Cost=ipp.Full_Credit_Cost,
	pp.Partial_Credit_Sell=ipp.Partial_Credit_Sell,
	pp.Partial_Credit_Cost=ipp.Partial_Credit_Cost,
	pp.LastModByUserId=@UserId,
	pp.LastModDate=getdate()

FROM #I_PART_PRICE_HEADER ipph
	LEFT JOIN #I_PART_PRICE ipp ON Part_Number<>''
	LEFT JOIN PRICE_GROUP pg ON pg.Price_Group=ipph.Pricing_Group
	LEFT JOIN tblCurrencies cur ON cur.Currency=ipph.Currency
	LEFT JOIN SOURCE_OF_SUPPLY sos ON sos.Sos_Code=ipp.SourceOfSupply
	LEFT JOIN tblParts p ON p.Part=ipp.Part_Number AND p.Source_Of_Supply_ID=sos.Source_Of_Supply_ID
	LEFT JOIN tblPartPrices pp ON pp.PartId=p.PartId AND pp.CurrencyId=cur.CurrencyID AND pp.Price_Group_ID=pg.Price_Group_ID
WHERE pp.PartPriceId IS NOT NULL

SET @NRecords=@@ROWCOUNT 

SET @Message=@NRecTitle+CAST(@NRecords AS varchar(50))+' records updated.'

IF @NRecords>0
BEGIN
	

	EXEC PRICED_JOB_HRS_COST_UPDATE_P @PricedJobID =NUll,
						@StdJobID =NULL,
						@Price_Group_ID =@Price_Group_ID,
						@CurrencyID =@CurrencyID,
						@BranchID =NULL,
						@UpdateProjTaskAmts =1
 
END

IF @AddNew=1
BEGIN
	INSERT SOURCE_OF_SUPPLY
	(Sos_Code, Sos_Description, Last_Mod_By_User_ID, Last_Mod_Date, 
	Create_By_User_ID, Create_Date)
	SELECT DISTINCT SourceOfSupply, SourceOfSupply, 0, GETDATE(), 0, GETDATE()
	FROM #I_PART_PRICE
	WHERE SourceOfSupply NOT IN (SELECT Sos_Code FROM SOURCE_OF_SUPPLY) AND 
	ISNULL(SourceOfSupply,'')<>''

	INSERT INTO tblParts(Part,PartDescription,Part_Type_ID,Source_Of_Supply_ID,LastModByUserId,
	LastModDate,CreateByUserId,CreateDate,PartSuperseded)
	SELECT Z.Part_Number AS Part,ISNULL(Z.Part_Description,Z.Part_Number) AS PartDescription,
	/*GW 547*/isnull(PT.PartTypeId,@PartTypeId),SS.Source_Of_Supply_ID,@UserId AS LastModByUserId,GETDATE() AS LastModDate,
	@UserId AS CreateByUserId,GETDATE() AS CreateDate,Z.Part_Superseded AS PartSuperseded
	FROM
	#I_PART_PRICE Z
		Left JOIN/*GW 547*/
	tblPartTypes PT
		ON Z.Part_Type=PT.PartType	
		INNER JOIN
	SOURCE_OF_SUPPLY SS
		ON Z.SourceOfSupply=SS.Sos_Code
		LEFT JOIN
	tblParts P
		ON Z.Part_Number=P.Part AND SS.Source_Of_Supply_ID=P.Source_Of_Supply_ID
	WHERE P.PartId IS NULL
		
	SET @NRecords=@@ROWCOUNT
	
	IF(	@NRecords>0)
	BEGIN
		INSERT tblPartPrices
			(PartId,
			CurrencyId,
			Part_Sell,
			Part_Cost,
			Full_Credit_Sell,
			Full_Credit_Cost,
			Partial_Credit_Sell,
			Partial_Credit_Cost,
			Price_Group_ID,
			LastModByUserId,
			LastModDate,
			CreateByUserId,
			CreateDate)
		SELECT DISTINCT
			p.PartId,
			exr2.CurrencyID,
			Z.Part_Sell/exr.ExRate*exr2.ExRate,
			Z.Part_Cost/exr.ExRate*exr2.ExRate,
			Z.Full_Credit_Sell/exr.ExRate*exr2.ExRate,
			Z.Full_Credit_Cost/exr.ExRate*exr2.ExRate,
			Z.Partial_Credit_Sell/exr.ExRate*exr2.ExRate,
			Z.Partial_Credit_Cost/exr.ExRate*exr2.ExRate,
			pg.Price_Group_ID,
			@UserId,
			getdate(),
			@UserId,
			getdate()
		FROM 
		#I_PART_PRICE Z
			INNER JOIN
		SOURCE_OF_SUPPLY SS
			ON Z.SourceOfSupply=SS.Sos_Code
			INNER JOIN
		tblParts P
			ON Z.Part_Number=P.Part AND SS.Source_Of_Supply_ID=P.Source_Of_Supply_ID
			LEFT JOIN 
		tblCurrencies cur 
			ON cur.CurrencyID=@CurrencyID
			LEFT JOIN 
		tblExRateCurrencies exr 
			ON exr.CurrencyID=cur.CurrencyID AND exr.ExRateID=0
			LEFT JOIN 
		tblExRateCurrencies exr2 
			ON exr2.ExRateID=0
			LEFT JOIN 
		PRICE_GROUP pg 
			ON pg.Price_Group_ID<>0
			LEFT JOIN 
		tblPartPrices ppr 
			ON ppr.PartId=p.PartId AND ppr.Price_Group_ID=pg.Price_Group_ID AND ppr.CurrencyID=exr2.CurrencyID
		WHERE ppr.PartId IS NULL
	END	
	
	SET @Message=@Message+'
'+CAST(@NRecords AS varchar(50))+' records inserted.'

END

FINISH:
IF @InterfaceSource=0 AND EXISTS(SELECT ImportFileName FROM IMPORT_ERROR WHERE ImportFileName=@ImportBatchName)
BEGIN
	DELETE IMPORT_ERROR WHERE ImportFileName=@ImportBatchName
END
	

IF EXISTS(SELECT MessageId FROM #z_Message)
BEGIN
	INSERT INTO IMPORT_ERROR(ImportFileName,Line_No,ErrorDescription,ImportErrorTypeId,LastModDate,ImportRecord,ImportSourceId)
	SELECT @ImportBatchName AS ImportFileName,CASE WHEN @InterfaceSource = 0 THEN Line_No END,ErrorDescription,
	ISNULL(ErrorType,@ErrBusinessRules) AS ImportErrorTypeId, 
	GETDATE() AS LastModDate,CONVERT(VARCHAR(MAX),ImportRecord),@InterfaceSource
	FROM #z_Message
	
	SET @Message=@NRecTitle + ' There was a problem processing Parts Prices - please check the Generic Interface Log for more details.'	
	
	--GD E787 moved the revert back logic to c# code
	--IF @RaiseError=1 
	--BEGIN
	--	RAISERROR (@Message, 16, 1)
	--END
END	
DROP TABLE #I_PART_PRICE_HEADER,#I_PART_PRICE
DROP TABLE #z_Message

GO